<!doctype html><html lang=en>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1"><title>Session Factored_Transition_System_Bounding - Archive of Formal Proofs</title><meta name=description content="A collection of proof libraries, examples, and larger scientific developments, mechanically checked in the theorem prover Isabelle."><meta property="og:title" content="Session Factored_Transition_System_Bounding">
<meta property="og:description" content>
<meta property="og:type" content="article">
<meta property="og:url" content="/entries/factored_transition_system_bounding/theories/"><meta property="og:image" content="/images/afp.png"><meta property="article:section" content="theories">
<meta property="og:site_name" content="Archive of Formal Proofs">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="/images/afp.png">
<meta name=twitter:title content="Session Factored_Transition_System_Bounding">
<meta name=twitter:description content>
<link rel=stylesheet type=text/css href=/css/front.min.css><link rel=stylesheet type=text/css href=/css/isabelle.css>
<link rel=icon href=/images/favicon.ico type=image/icon><script src=/js/flexsearch.min.js></script>
<script src=/js/banner.js></script><script src=/js/header-search.js></script></head>
<body class=mathjax_ignore>
<aside>
<div>
<div>
<a href=/>
<img src=/images/afp.png alt="Logo of the Archive of Formal Proofs" class=logo>
</a>
<ul>
<li><a href=/entries/factored_transition_system_bounding>Return to entry</a></li>
</ul>
<hr>
<ul><li><a href=#FactoredSystemLib>FactoredSystemLib</a>
</li><li><a href=#ListUtils>ListUtils</a>
<ul>
<li><a href=#ListUtils-len_ge_0>len_ge_0</a></li>
<li><a href=#ListUtils-len_gt_pref_is_pref>len_gt_pref_is_pref</a></li>
<li><a href=#ListUtils-nempty_list_append_length_add>nempty_list_append_length_add</a></li>
<li><a href=#ListUtils-append_filter>append_filter</a></li>
<li><a href=#ListUtils-append_eq_as_proj_1>append_eq_as_proj_1</a></li>
<li><a href=#ListUtils-filter_empty_every_not>filter_empty_every_not</a></li>
<li><a href=#ListUtils-MEM_SPLIT>MEM_SPLIT</a></li>
<li><a href=#ListUtils-APPEND_EQ_APPEND_MID>APPEND_EQ_APPEND_MID</a></li>
<li><a href=#ListUtils-LIST_FRAG_DICHOTOMY>LIST_FRAG_DICHOTOMY</a></li>
<li><a href=#ListUtils-LIST_FRAG_DICHOTOMY_2>LIST_FRAG_DICHOTOMY_2</a></li>
<li><a href=#ListUtils-frag_len_filter_le>frag_len_filter_le</a></li>
</ul>
</li><li><a href=#FSSublist>FSSublist</a>
<ul>
<li><a href=#FSSublist-sublist_HOL4_equiv_subseq>sublist_HOL4_equiv_subseq</a></li>
<li><a href=#FSSublist-list_frag_HOL4_equiv_sublist>list_frag_HOL4_equiv_sublist</a></li>
<li><a href=#FSSublist-sublist_EQNS>sublist_EQNS</a></li>
<li><a href=#FSSublist-sublist_refl>sublist_refl</a></li>
<li><a href=#FSSublist-sublist_cons>sublist_cons</a></li>
<li><a href=#FSSublist-sublist_NIL>sublist_NIL</a></li>
<li><a href=#FSSublist-sublist_trans>sublist_trans</a></li>
<li><a href=#FSSublist-sublist_length>sublist_length</a></li>
<li><a href=#FSSublist-sublist_CONS1_E>sublist_CONS1_E</a></li>
<li><a href=#FSSublist-sublist_equal_lengths>sublist_equal_lengths</a></li>
<li><a href=#FSSublist-sublist_antisym>sublist_antisym</a></li>
<li><a href=#FSSublist-sublist_append_back>sublist_append_back</a></li>
<li><a href=#FSSublist-sublist_snoc>sublist_snoc</a></li>
<li><a href=#FSSublist-sublist_append_front>sublist_append_front</a></li>
<li><a href=#FSSublist-append_sublist_1>append_sublist_1</a></li>
<li><a href=#FSSublist-sublist_prefix>sublist_prefix</a></li>
<li><a href=#FSSublist-sublist_skip>sublist_skip</a></li>
<li><a href=#FSSublist-sublist_split_trans>sublist_split_trans</a></li>
<li><a href=#FSSublist-sublist_cons_exists>sublist_cons_exists</a></li>
<li><a href=#FSSublist-sublist_append_exists>sublist_append_exists</a></li>
<li><a href=#FSSublist-sublist_append_both_I>sublist_append_both_I</a></li>
<li><a href=#FSSublist-sublist_append>sublist_append</a></li>
<li><a href=#FSSublist-sublist_append2>sublist_append2</a></li>
<li><a href=#FSSublist-append_sublist>append_sublist</a></li>
<li><a href=#FSSublist-sublist_subset>sublist_subset</a></li>
<li><a href=#FSSublist-sublist_filter>sublist_filter</a></li>
<li><a href=#FSSublist-sublist_cons_2>sublist_cons_2</a></li>
<li><a href=#FSSublist-sublist_every>sublist_every</a></li>
<li><a href=#FSSublist-sublist_SING_MEM>sublist_SING_MEM</a></li>
<li><a href=#FSSublist-sublist_append_exists_2>sublist_append_exists_2</a></li>
<li><a href=#FSSublist-sublist_append_4>sublist_append_4</a></li>
<li><a href=#FSSublist-sublist_append_5>sublist_append_5</a></li>
<li><a href=#FSSublist-sublist_append_6>sublist_append_6</a></li>
<li><a href=#FSSublist-sublist_MEM>sublist_MEM</a></li>
<li><a href=#FSSublist-sublist_cons_4>sublist_cons_4</a></li>
<li><a href=#FSSublist-isPREFIX_sublist>isPREFIX_sublist</a></li>
</ul>
</li><li><a href=#HoArithUtils>HoArithUtils</a>
<ul>
<li><a href=#HoArithUtils-general_theorem>general_theorem</a></li>
</ul>
</li><li><a href=#FmapUtils>FmapUtils</a>
<ul>
<li><a href=#FmapUtils-IN_FDOM_DRESTRICT_DIFF>IN_FDOM_DRESTRICT_DIFF</a></li>
<li><a href=#FmapUtils-disj_dom_drest_fupdate_eq>disj_dom_drest_fupdate_eq</a></li>
<li><a href=#FmapUtils-graph_plan_card_state_set>graph_plan_card_state_set</a></li>
<li><a href=#FmapUtils-exec_drest_5>exec_drest_5</a></li>
<li><a href=#FmapUtils-graph_plan_lemma_5>graph_plan_lemma_5</a></li>
<li><a href=#FmapUtils-drest_smap_drest_smap_drest>drest_smap_drest_smap_drest</a></li>
<li><a href=#FmapUtils-sat_precond_as_proj_1>sat_precond_as_proj_1</a></li>
<li><a href=#FmapUtils-sat_precond_as_proj_4>sat_precond_as_proj_4</a></li>
<li><a href=#FmapUtils-sublist_as_proj_eq_as_1>sublist_as_proj_eq_as_1</a></li>
<li><a href=#FmapUtils-limited_dom_neq_restricted_neq>limited_dom_neq_restricted_neq</a></li>
<li><a href=#FmapUtils-fmlookup_fmrestrict_set_dom>fmlookup_fmrestrict_set_dom</a></li>
</ul>
</li><li><a href=#FactoredSystem>FactoredSystem</a>
<ul>
<li><a href=#FactoredSystem-state_succ_pair>state_succ_pair</a></li>
<li><a href=#FactoredSystem-exec_plan_Append>exec_plan_Append</a></li>
<li><a href=#FactoredSystem-cycle_removal_lemma>cycle_removal_lemma</a></li>
<li><a href=#FactoredSystem-empty_domain_fmap_set>empty_domain_fmap_set</a></li>
<li><a href=#FactoredSystem-possible_states_set_ii_a>possible_states_set_ii_a</a></li>
<li><a href=#FactoredSystem-possible_states_set_ii_b>possible_states_set_ii_b</a></li>
<li><a href=#FactoredSystem-fmap_neq>fmap_neq</a></li>
<li><a href=#FactoredSystem-fmdom%27_fmsubset_restrict_set>fmdom'_fmsubset_restrict_set</a></li>
<li><a href=#FactoredSystem-fmsubset_restrict_set>fmsubset_restrict_set</a></li>
<li><a href=#FactoredSystem-fmupd_fmsubset_restrict_set>fmupd_fmsubset_restrict_set</a></li>
<li><a href=#FactoredSystem-construction_of_all_possible_states_lemma>construction_of_all_possible_states_lemma</a></li>
<li><a href=#FactoredSystem-FINITE_states>FINITE_states</a></li>
<li><a href=#FactoredSystem-bool_update_effect>bool_update_effect</a></li>
<li><a href=#FactoredSystem-bool_update_inj>bool_update_inj</a></li>
<li><a href=#FactoredSystem-card_update>card_update</a></li>
<li><a href=#FactoredSystem-updates_disjoint>updates_disjoint</a></li>
<li><a href=#FactoredSystem-card_of_set_of_all_possible_states>card_of_set_of_all_possible_states</a></li>
<li><a href=#FactoredSystem-empty_state_list_lemma>empty_state_list_lemma</a></li>
<li><a href=#FactoredSystem-state_list_length_non_zero>state_list_length_non_zero</a></li>
<li><a href=#FactoredSystem-state_list_length_lemma>state_list_length_lemma</a></li>
<li><a href=#FactoredSystem-state_list_length_lemma_2>state_list_length_lemma_2</a></li>
<li><a href=#FactoredSystem-state_set_thm>state_set_thm</a></li>
<li><a href=#FactoredSystem-state_set_finite>state_set_finite</a></li>
<li><a href=#FactoredSystem-LENGTH_state_set>LENGTH_state_set</a></li>
<li><a href=#FactoredSystem-lemma_temp>lemma_temp</a></li>
<li><a href=#FactoredSystem-NIL_NOTIN_stateset>NIL_NOTIN_stateset</a></li>
<li><a href=#FactoredSystem-state_set_card_i>state_set_card_i</a></li>
<li><a href=#FactoredSystem-state_set_card_ii>state_set_card_ii</a></li>
<li><a href=#FactoredSystem-state_set_card_iii>state_set_card_iii</a></li>
<li><a href=#FactoredSystem-state_set_card>state_set_card</a></li>
<li><a href=#FactoredSystem-FDOM_state_succ>FDOM_state_succ</a></li>
<li><a href=#FactoredSystem-FDOM_state_succ_subset>FDOM_state_succ_subset</a></li>
<li><a href=#FactoredSystem-FDOM_eff_subset_FDOM_valid_states>FDOM_eff_subset_FDOM_valid_states</a></li>
<li><a href=#FactoredSystem-FDOM_eff_subset_FDOM_valid_states_pair>FDOM_eff_subset_FDOM_valid_states_pair</a></li>
<li><a href=#FactoredSystem-FDOM_pre_subset_FDOM_valid_states>FDOM_pre_subset_FDOM_valid_states</a></li>
<li><a href=#FactoredSystem-FDOM_pre_subset_FDOM_valid_states_pair>FDOM_pre_subset_FDOM_valid_states_pair</a></li>
<li><a href=#FactoredSystem-action_dom_subset_valid_states_FDOM>action_dom_subset_valid_states_FDOM</a></li>
<li><a href=#FactoredSystem-FDOM_eff_subset_prob_dom>FDOM_eff_subset_prob_dom</a></li>
<li><a href=#FactoredSystem-FDOM_eff_subset_prob_dom_pair>FDOM_eff_subset_prob_dom_pair</a></li>
<li><a href=#FactoredSystem-FDOM_pre_subset_prob_dom>FDOM_pre_subset_prob_dom</a></li>
<li><a href=#FactoredSystem-FDOM_pre_subset_prob_dom_pair>FDOM_pre_subset_prob_dom_pair</a></li>
<li><a href=#FactoredSystem-valid_plan_valid_head>valid_plan_valid_head</a></li>
<li><a href=#FactoredSystem-valid_plan_valid_tail>valid_plan_valid_tail</a></li>
<li><a href=#FactoredSystem-valid_plan_pre_subset_prob_dom_pair>valid_plan_pre_subset_prob_dom_pair</a></li>
<li><a href=#FactoredSystem-valid_append_valid_suff>valid_append_valid_suff</a></li>
<li><a href=#FactoredSystem-valid_append_valid_pref>valid_append_valid_pref</a></li>
<li><a href=#FactoredSystem-valid_pref_suff_valid_append>valid_pref_suff_valid_append</a></li>
<li><a href=#FactoredSystem-MEM_statelist_FDOM>MEM_statelist_FDOM</a></li>
<li><a href=#FactoredSystem-MEM_statelist_valid_state>MEM_statelist_valid_state</a></li>
<li><a href=#FactoredSystem-lemma_1_i>lemma_1_i</a></li>
<li><a href=#FactoredSystem-lemma_1_ii>lemma_1_ii</a></li>
<li><a href=#FactoredSystem-lemma_1>lemma_1</a></li>
<li><a href=#FactoredSystem-len_in_state_set_le_max_len>len_in_state_set_le_max_len</a></li>
<li><a href=#FactoredSystem-card_state_set_cons>card_state_set_cons</a></li>
<li><a href=#FactoredSystem-card_state_set>card_state_set</a></li>
<li><a href=#FactoredSystem-neq_mems_state_set_neq_len>neq_mems_state_set_neq_len</a></li>
<li><a href=#FactoredSystem-not_eq_last_diff_paths_i>not_eq_last_diff_paths_i</a></li>
<li><a href=#FactoredSystem-not_eq_last_diff_paths_ii>not_eq_last_diff_paths_ii</a></li>
<li><a href=#FactoredSystem-not_eq_last_diff_paths>not_eq_last_diff_paths</a></li>
<li><a href=#FactoredSystem-nempty_sl_in_state_set>nempty_sl_in_state_set</a></li>
<li><a href=#FactoredSystem-empty_list_nin_state_set>empty_list_nin_state_set</a></li>
<li><a href=#FactoredSystem-cons_in_state_set_2>cons_in_state_set_2</a></li>
<li><a href=#FactoredSystem-valid_action_valid_succ>valid_action_valid_succ</a></li>
<li><a href=#FactoredSystem-in_state_set_imp_eq_exec_prefix>in_state_set_imp_eq_exec_prefix</a></li>
<li><a href=#FactoredSystem-eq_last_state_imp_append_nempty_as>eq_last_state_imp_append_nempty_as</a></li>
<li><a href=#FactoredSystem-FINITE_prob_dom>FINITE_prob_dom</a></li>
<li><a href=#FactoredSystem-CARD_valid_states>CARD_valid_states</a></li>
<li><a href=#FactoredSystem-FINITE_valid_states>FINITE_valid_states</a></li>
<li><a href=#FactoredSystem-lemma_2>lemma_2</a></li>
<li><a href=#FactoredSystem-lemma_2_prob_dom>lemma_2_prob_dom</a></li>
<li><a href=#FactoredSystem-lemma_3>lemma_3</a></li>
<li><a href=#FactoredSystem-sublist_valid_is_valid>sublist_valid_is_valid</a></li>
<li><a href=#FactoredSystem-valid_as_valid_exec>valid_as_valid_exec</a></li>
<li><a href=#FactoredSystem-exec_plan_fdom_subset>exec_plan_fdom_subset</a></li>
<li><a href=#FactoredSystem-reachable_s_finite_thm_1_a>reachable_s_finite_thm_1_a</a></li>
<li><a href=#FactoredSystem-reachable_s_finite_thm_1>reachable_s_finite_thm_1</a></li>
<li><a href=#FactoredSystem-reachable_s_finite_thm>reachable_s_finite_thm</a></li>
<li><a href=#FactoredSystem-empty_plan_is_valid>empty_plan_is_valid</a></li>
<li><a href=#FactoredSystem-valid_head_and_tail_valid_plan>valid_head_and_tail_valid_plan</a></li>
<li><a href=#FactoredSystem-lemma_1_reachability_s_i>lemma_1_reachability_s_i</a></li>
<li><a href=#FactoredSystem-lemma_1_reachability_s>lemma_1_reachability_s</a></li>
<li><a href=#FactoredSystem-not_eq_last_diff_paths_reachability_s>not_eq_last_diff_paths_reachability_s</a></li>
<li><a href=#FactoredSystem-lemma_2_reachability_s_i>lemma_2_reachability_s_i</a></li>
<li><a href=#FactoredSystem-lemma_2_reachability_s>lemma_2_reachability_s</a></li>
<li><a href=#FactoredSystem-lemma_3_reachability_s>lemma_3_reachability_s</a></li>
<li><a href=#FactoredSystem-main_lemma_reachability_s>main_lemma_reachability_s</a></li>
<li><a href=#FactoredSystem-reachable_s_non_empty>reachable_s_non_empty</a></li>
<li><a href=#FactoredSystem-card_reachable_s_non_zero>card_reachable_s_non_zero</a></li>
<li><a href=#FactoredSystem-exec_fdom_empty_prob>exec_fdom_empty_prob</a></li>
<li><a href=#FactoredSystem-reachable_s_empty_prob>reachable_s_empty_prob</a></li>
<li><a href=#FactoredSystem-sublist_valid_plan__alt>sublist_valid_plan__alt</a></li>
<li><a href=#FactoredSystem-fmsubset_eq>fmsubset_eq</a></li>
<li><a href=#FactoredSystem-submap_imp_state_succ_submap_a>submap_imp_state_succ_submap_a</a></li>
<li><a href=#FactoredSystem-submap_imp_state_succ_submap_b>submap_imp_state_succ_submap_b</a></li>
<li><a href=#FactoredSystem-submap_imp_state_succ_submap>submap_imp_state_succ_submap</a></li>
<li><a href=#FactoredSystem-pred_dom_subset_succ_submap>pred_dom_subset_succ_submap</a></li>
<li><a href=#FactoredSystem-valid_as_submap_init_submap_exec_i>valid_as_submap_init_submap_exec_i</a></li>
<li><a href=#FactoredSystem-valid_as_submap_init_submap_exec>valid_as_submap_init_submap_exec</a></li>
<li><a href=#FactoredSystem-valid_plan_mems>valid_plan_mems</a></li>
<li><a href=#FactoredSystem-valid_states_nempty>valid_states_nempty</a></li>
<li><a href=#FactoredSystem-empty_prob_dom_single_val_state>empty_prob_dom_single_val_state</a></li>
<li><a href=#FactoredSystem-empty_prob_dom_imp_empty_plan_always_good>empty_prob_dom_imp_empty_plan_always_good</a></li>
<li><a href=#FactoredSystem-empty_prob_dom>empty_prob_dom</a></li>
<li><a href=#FactoredSystem-empty_prob_dom_finite>empty_prob_dom_finite</a></li>
<li><a href=#FactoredSystem-disj_imp_eq_proj_exec>disj_imp_eq_proj_exec</a></li>
<li><a href=#FactoredSystem-no_change_vs_eff_submap>no_change_vs_eff_submap</a></li>
<li><a href=#FactoredSystem-sat_precond_as_proj_3>sat_precond_as_proj_3</a></li>
<li><a href=#FactoredSystem-proj_eq_proj_exec_eq>proj_eq_proj_exec_eq</a></li>
<li><a href=#FactoredSystem-empty_eff_exec_eq>empty_eff_exec_eq</a></li>
<li><a href=#FactoredSystem-exec_as_proj_valid_2>exec_as_proj_valid_2</a></li>
<li><a href=#FactoredSystem-valid_filter_valid_as>valid_filter_valid_as</a></li>
<li><a href=#FactoredSystem-sublist_valid_plan>sublist_valid_plan</a></li>
<li><a href=#FactoredSystem-prob_subset_dom_subset>prob_subset_dom_subset</a></li>
<li><a href=#FactoredSystem-state_succ_valid_act_disjoint>state_succ_valid_act_disjoint</a></li>
<li><a href=#FactoredSystem-exec_valid_as_disjoint>exec_valid_as_disjoint</a></li>
<li><a href=#FactoredSystem-EQ_SS_DOM>EQ_SS_DOM</a></li>
<li><a href=#FactoredSystem-FINITE_SS>FINITE_SS</a></li>
<li><a href=#FactoredSystem-disjoint_effects_no_effects>disjoint_effects_no_effects</a></li>
<li><a href=#FactoredSystem-act_needed_asses_submap_succ_submap>act_needed_asses_submap_succ_submap</a></li>
<li><a href=#FactoredSystem-as_needed_asses_submap_exec_i>as_needed_asses_submap_exec_i</a></li>
<li><a href=#FactoredSystem-as_needed_asses_submap_exec_ii>as_needed_asses_submap_exec_ii</a></li>
<li><a href=#FactoredSystem-as_needed_asses_submap_exec_iii>as_needed_asses_submap_exec_iii</a></li>
<li><a href=#FactoredSystem-as_needed_asses_submap_exec_iv>as_needed_asses_submap_exec_iv</a></li>
<li><a href=#FactoredSystem-as_needed_asses_submap_exec_v>as_needed_asses_submap_exec_v</a></li>
<li><a href=#FactoredSystem-as_needed_asses_submap_exec_vi>as_needed_asses_submap_exec_vi</a></li>
<li><a href=#FactoredSystem-as_needed_asses_submap_exec_vii>as_needed_asses_submap_exec_vii</a></li>
<li><a href=#FactoredSystem-as_needed_asses_submap_exec_viii>as_needed_asses_submap_exec_viii</a></li>
<li><a href=#FactoredSystem-as_needed_asses_submap_exec_viii%27>as_needed_asses_submap_exec_viii'</a></li>
<li><a href=#FactoredSystem-as_needed_asses_submap_exec_ix>as_needed_asses_submap_exec_ix</a></li>
<li><a href=#FactoredSystem-as_needed_asses_submap_exec_x>as_needed_asses_submap_exec_x</a></li>
<li><a href=#FactoredSystem-as_needed_asses_submap_exec_xi>as_needed_asses_submap_exec_xi</a></li>
<li><a href=#FactoredSystem-as_needed_asses_submap_exec_xii>as_needed_asses_submap_exec_xii</a></li>
<li><a href=#FactoredSystem-as_needed_asses_submap_exec_xii%27>as_needed_asses_submap_exec_xii'</a></li>
<li><a href=#FactoredSystem-as_needed_asses_submap_exec>as_needed_asses_submap_exec</a></li>
<li><a href=#FactoredSystem-action_needed_vars_subset_sys_needed_vars_subset>action_needed_vars_subset_sys_needed_vars_subset</a></li>
<li><a href=#FactoredSystem-action_needed_asses_submap_sys_needed_asses>action_needed_asses_submap_sys_needed_asses</a></li>
<li><a href=#FactoredSystem-system_needed_asses_include_action_needed_asses_1>system_needed_asses_include_action_needed_asses_1</a></li>
<li><a href=#FactoredSystem-system_needed_asses_include_action_needed_asses_i>system_needed_asses_include_action_needed_asses_i</a></li>
<li><a href=#FactoredSystem-system_needed_asses_include_action_needed_asses>system_needed_asses_include_action_needed_asses</a></li>
<li><a href=#FactoredSystem-system_needed_asses_submap>system_needed_asses_submap</a></li>
<li><a href=#FactoredSystem-as_works_from_system_needed_asses>as_works_from_system_needed_asses</a></li>
</ul>
</li><li><a href=#ActionSeqProcess>ActionSeqProcess</a>
<ul>
<li><a href=#ActionSeqProcess-sat_precond_as_pair>sat_precond_as_pair</a></li>
<li><a href=#ActionSeqProcess-graph_plan_lemma_4>graph_plan_lemma_4</a></li>
<li><a href=#ActionSeqProcess-rem_condless_act_pair>rem_condless_act_pair</a></li>
<li><a href=#ActionSeqProcess-exec_remcondless_cons>exec_remcondless_cons</a></li>
<li><a href=#ActionSeqProcess-rem_condless_valid_1>rem_condless_valid_1</a></li>
<li><a href=#ActionSeqProcess-rem_condless_act_cons>rem_condless_act_cons</a></li>
<li><a href=#ActionSeqProcess-rem_condless_act_cons_prefix>rem_condless_act_cons_prefix</a></li>
<li><a href=#ActionSeqProcess-rem_condless_valid_2>rem_condless_valid_2</a></li>
<li><a href=#ActionSeqProcess-rem_condless_valid_3>rem_condless_valid_3</a></li>
<li><a href=#ActionSeqProcess-rem_condless_valid_4>rem_condless_valid_4</a></li>
<li><a href=#ActionSeqProcess-rem_condless_valid_6>rem_condless_valid_6</a></li>
<li><a href=#ActionSeqProcess-rem_condless_valid_7>rem_condless_valid_7</a></li>
<li><a href=#ActionSeqProcess-rem_condless_valid_8>rem_condless_valid_8</a></li>
<li><a href=#ActionSeqProcess-rem_condless_valid_10>rem_condless_valid_10</a></li>
<li><a href=#ActionSeqProcess-rem_condless_valid>rem_condless_valid</a></li>
<li><a href=#ActionSeqProcess-submap_sat_precond_submap>submap_sat_precond_submap</a></li>
<li><a href=#ActionSeqProcess-submap_init_submap_exec_i>submap_init_submap_exec_i</a></li>
<li><a href=#ActionSeqProcess-submap_init_submap_exec>submap_init_submap_exec</a></li>
<li><a href=#ActionSeqProcess-sat_precond_drest_sat_precond>sat_precond_drest_sat_precond</a></li>
<li><a href=#ActionSeqProcess-varset_action_pair>varset_action_pair</a></li>
<li><a href=#ActionSeqProcess-eq_effect_eq_vset>eq_effect_eq_vset</a></li>
<li><a href=#ActionSeqProcess-rem_effectless_works_1>rem_effectless_works_1</a></li>
<li><a href=#ActionSeqProcess-rem_effectless_works_2>rem_effectless_works_2</a></li>
<li><a href=#ActionSeqProcess-rem_effectless_works_3>rem_effectless_works_3</a></li>
<li><a href=#ActionSeqProcess-rem_effectless_works_4>rem_effectless_works_4</a></li>
<li><a href=#ActionSeqProcess-rem_effectless_works_4%27>rem_effectless_works_4'</a></li>
<li><a href=#ActionSeqProcess-rem_effectless_works_5_i>rem_effectless_works_5_i</a></li>
<li><a href=#ActionSeqProcess-rem_effectless_works_5>rem_effectless_works_5</a></li>
<li><a href=#ActionSeqProcess-rem_effectless_works_6>rem_effectless_works_6</a></li>
<li><a href=#ActionSeqProcess-rem_effectless_works_7>rem_effectless_works_7</a></li>
<li><a href=#ActionSeqProcess-rem_effectless_works_8>rem_effectless_works_8</a></li>
<li><a href=#ActionSeqProcess-rem_effectless_works_9>rem_effectless_works_9</a></li>
<li><a href=#ActionSeqProcess-rem_effectless_works_10>rem_effectless_works_10</a></li>
<li><a href=#ActionSeqProcess-rem_effectless_works_11>rem_effectless_works_11</a></li>
<li><a href=#ActionSeqProcess-rem_effectless_works_12>rem_effectless_works_12</a></li>
<li><a href=#ActionSeqProcess-rem_effectless_works_13_i>rem_effectless_works_13_i</a></li>
<li><a href=#ActionSeqProcess-rem_effectless_works_13>rem_effectless_works_13</a></li>
<li><a href=#ActionSeqProcess-rem_effectless_works_14>rem_effectless_works_14</a></li>
<li><a href=#ActionSeqProcess-rem_effectless_works>rem_effectless_works</a></li>
<li><a href=#ActionSeqProcess-rem_effectless_act_subset_rem_effectless_act_set_thm>rem_effectless_act_subset_rem_effectless_act_set_thm</a></li>
<li><a href=#ActionSeqProcess-rem_effectless_act_set_no_empty_actions_thm>rem_effectless_act_set_no_empty_actions_thm</a></li>
<li><a href=#ActionSeqProcess-rem_condless_valid_9>rem_condless_valid_9</a></li>
<li><a href=#ActionSeqProcess-graph_plan_lemma_17>graph_plan_lemma_17</a></li>
<li><a href=#ActionSeqProcess-nempty_eff_every_nempty_act>nempty_eff_every_nempty_act</a></li>
<li><a href=#ActionSeqProcess-empty_replace_proj_dual7>empty_replace_proj_dual7</a></li>
<li><a href=#ActionSeqProcess-not_vset_not_disj_eff_prod_dom_diff>not_vset_not_disj_eff_prod_dom_diff</a></li>
<li><a href=#ActionSeqProcess-vset_disj_dom_eff_diff>vset_disj_dom_eff_diff</a></li>
<li><a href=#ActionSeqProcess-vset_diff_disj_eff_vs>vset_diff_disj_eff_vs</a></li>
<li><a href=#ActionSeqProcess-vset_nempty_efff_not_disj_eff_vs>vset_nempty_efff_not_disj_eff_vs</a></li>
<li><a href=#ActionSeqProcess-vset_disj_eff_diff>vset_disj_eff_diff</a></li>
<li><a href=#ActionSeqProcess-list_all_list_mem>list_all_list_mem</a></li>
<li><a href=#ActionSeqProcess-every_vset_imp_drestrict_exec_eq>every_vset_imp_drestrict_exec_eq</a></li>
<li><a href=#ActionSeqProcess-no_effectless_act_works>no_effectless_act_works</a></li>
<li><a href=#ActionSeqProcess-varset_act_diff_un_imp_varset_diff>varset_act_diff_un_imp_varset_diff</a></li>
<li><a href=#ActionSeqProcess-vset_diff_union_vset_diff>vset_diff_union_vset_diff</a></li>
<li><a href=#ActionSeqProcess-valid_filter_vset_dom_idempot>valid_filter_vset_dom_idempot</a></li>
<li><a href=#ActionSeqProcess-n_replace_proj_le_n_as_1>n_replace_proj_le_n_as_1</a></li>
<li><a href=#ActionSeqProcess-sat_precond_as_pfx>sat_precond_as_pfx</a></li>
</ul>
</li><li><a href=#RelUtils>RelUtils</a>
<ul>
<li><a href=#RelUtils-TC_equiv_tranclp>TC_equiv_tranclp</a></li>
<li><a href=#RelUtils-TC_IMP_NOT_TC_CONJ_1>TC_IMP_NOT_TC_CONJ_1</a></li>
<li><a href=#RelUtils-TC_IMP_NOT_TC_CONJ>TC_IMP_NOT_TC_CONJ</a></li>
<li><a href=#RelUtils-TC_INDUCT>TC_INDUCT</a></li>
<li><a href=#RelUtils-REFL_IMP_3_CONJ_1>REFL_IMP_3_CONJ_1</a></li>
<li><a href=#RelUtils-REFL_IMP_3_CONJ>REFL_IMP_3_CONJ</a></li>
<li><a href=#RelUtils-REFL_TC_CONJ>REFL_TC_CONJ</a></li>
<li><a href=#RelUtils-TC_CASES1_NEQ>TC_CASES1_NEQ</a></li>
</ul>
</li><li><a href=#Dependency>Dependency</a>
<ul>
<li><a href=#Dependency-dep_var_set_self_empty>dep_var_set_self_empty</a></li>
<li><a href=#Dependency-DEP_REFL>DEP_REFL</a></li>
<li><a href=#Dependency-NEQ_DEP_IMP_IN_DOM_i>NEQ_DEP_IMP_IN_DOM_i</a></li>
<li><a href=#Dependency-NEQ_DEP_IMP_IN_DOM_ii>NEQ_DEP_IMP_IN_DOM_ii</a></li>
<li><a href=#Dependency-NEQ_DEP_IMP_IN_DOM>NEQ_DEP_IMP_IN_DOM</a></li>
<li><a href=#Dependency-dep_sos_imp_mem_dep>dep_sos_imp_mem_dep</a></li>
<li><a href=#Dependency-dep_union_imp_or_dep>dep_union_imp_or_dep</a></li>
<li><a href=#Dependency-dep_biunion_imp_or_dep>dep_biunion_imp_or_dep</a></li>
<li><a href=#Dependency-dep_tc_imp_in_dom>dep_tc_imp_in_dom</a></li>
<li><a href=#Dependency-not_dep_disj_imp_not_dep>not_dep_disj_imp_not_dep</a></li>
<li><a href=#Dependency-dep_slist_imp_mem_dep>dep_slist_imp_mem_dep</a></li>
<li><a href=#Dependency-n_bigunion_le_sum_3>n_bigunion_le_sum_3</a></li>
<li><a href=#Dependency-disj_not_dep_vset_union_imp_or>disj_not_dep_vset_union_imp_or</a></li>
</ul>
</li><li><a href=#Invariants>Invariants</a>
</li><li><a href=#SetUtils>SetUtils</a>
<ul>
<li><a href=#SetUtils-card_union%27>card_union'</a></li>
<li><a href=#SetUtils-CARD_INJ_IMAGE_2>CARD_INJ_IMAGE_2</a></li>
<li><a href=#SetUtils-scc_main_lemma_x>scc_main_lemma_x</a></li>
<li><a href=#SetUtils-neq_funs_neq_images>neq_funs_neq_images</a></li>
<li><a href=#SetUtils-mems_le_finite_i>mems_le_finite_i</a></li>
<li><a href=#SetUtils-mems_le_finite>mems_le_finite</a></li>
<li><a href=#SetUtils-mem_le_imp_MIN_le>mem_le_imp_MIN_le</a></li>
<li><a href=#SetUtils-mem_lt_imp_MIN_lt>mem_lt_imp_MIN_lt</a></li>
<li><a href=#SetUtils-bound_child_parent_neq_mems_state_set_neq_len>bound_child_parent_neq_mems_state_set_neq_len</a></li>
<li><a href=#SetUtils-bound_main_lemma_2>bound_main_lemma_2</a></li>
<li><a href=#SetUtils-bound_child_parent_not_eq_last_diff_paths>bound_child_parent_not_eq_last_diff_paths</a></li>
<li><a href=#SetUtils-FINITE_ALL_DISTINCT_LISTS_i>FINITE_ALL_DISTINCT_LISTS_i</a></li>
<li><a href=#SetUtils-FINITE_ALL_DISTINCT_LISTS>FINITE_ALL_DISTINCT_LISTS</a></li>
<li><a href=#SetUtils-subset_inter_diff_empty>subset_inter_diff_empty</a></li>
</ul>
</li><li><a href=#TopologicalProps>TopologicalProps</a>
<ul>
<li><a href=#TopologicalProps-finite_PLS>finite_PLS</a></li>
<li><a href=#TopologicalProps-expanded_problem_plan_bound_thm_1>expanded_problem_plan_bound_thm_1</a></li>
<li><a href=#TopologicalProps-expanded_problem_plan_bound_thm>expanded_problem_plan_bound_thm</a></li>
<li><a href=#TopologicalProps-valid_path_ITP2015>valid_path_ITP2015</a></li>
<li><a href=#TopologicalProps-in_PLS_leq_2_pow_n>in_PLS_leq_2_pow_n</a></li>
<li><a href=#TopologicalProps-in_MPLS_leq_2_pow_n>in_MPLS_leq_2_pow_n</a></li>
<li><a href=#TopologicalProps-FINITE_MPLS>FINITE_MPLS</a></li>
<li><a href=#TopologicalProps-LENGTH_statelist%27>LENGTH_statelist'</a></li>
<li><a href=#TopologicalProps-valid_path_statelist%27>valid_path_statelist'</a></li>
<li><a href=#TopologicalProps-statelist%27_exec_plan>statelist'_exec_plan</a></li>
<li><a href=#TopologicalProps-statelist%27_EQ_NIL>statelist'_EQ_NIL</a></li>
<li><a href=#TopologicalProps-statelist%27_TAKE_i>statelist'_TAKE_i</a></li>
<li><a href=#TopologicalProps-statelist%27_TAKE>statelist'_TAKE</a></li>
<li><a href=#TopologicalProps-MPLS_nempty>MPLS_nempty</a></li>
<li><a href=#TopologicalProps-bound_child_parent_card_state_set_cons>bound_child_parent_card_state_set_cons</a></li>
<li><a href=#TopologicalProps-bound_on_all_plans_bounds_MPLS>bound_on_all_plans_bounds_MPLS</a></li>
<li><a href=#TopologicalProps-bound_child_parent_card_state_set_cons_finite>bound_child_parent_card_state_set_cons_finite</a></li>
<li><a href=#TopologicalProps-bound_on_all_plans_bounds_MPLS_finite>bound_on_all_plans_bounds_MPLS_finite</a></li>
<li><a href=#TopologicalProps-bound_on_all_plans_bounds_problem_plan_bound>bound_on_all_plans_bounds_problem_plan_bound</a></li>
<li><a href=#TopologicalProps-bound_child_parent_card_state_set_cons_thesis>bound_child_parent_card_state_set_cons_thesis</a></li>
<li><a href=#TopologicalProps-x_in_MPLS_if>x_in_MPLS_if</a></li>
<li><a href=#TopologicalProps-bound_on_all_plans_bounds_MPLS_thesis>bound_on_all_plans_bounds_MPLS_thesis</a></li>
<li><a href=#TopologicalProps-bounded_MPLS_contains_supremum>bounded_MPLS_contains_supremum</a></li>
<li><a href=#TopologicalProps-bound_on_all_plans_bounds_problem_plan_bound_thesis%27>bound_on_all_plans_bounds_problem_plan_bound_thesis'</a></li>
<li><a href=#TopologicalProps-bound_on_all_plans_bounds_problem_plan_bound_thesis>bound_on_all_plans_bounds_problem_plan_bound_thesis</a></li>
<li><a href=#TopologicalProps-bound_on_all_plans_bounds_problem_plan_bound_>bound_on_all_plans_bounds_problem_plan_bound_</a></li>
<li><a href=#TopologicalProps-S_VALID_AS_VALID_IMP_MIN_IN_PLS>S_VALID_AS_VALID_IMP_MIN_IN_PLS</a></li>
<li><a href=#TopologicalProps-problem_plan_bound_ge_min_pls>problem_plan_bound_ge_min_pls</a></li>
<li><a href=#TopologicalProps-PLS_NEMPTY>PLS_NEMPTY</a></li>
<li><a href=#TopologicalProps-PLS_nempty_and_has_min>PLS_nempty_and_has_min</a></li>
<li><a href=#TopologicalProps-PLS_works>PLS_works</a></li>
<li><a href=#TopologicalProps-problem_plan_bound_works>problem_plan_bound_works</a></li>
<li><a href=#TopologicalProps-bound_main_lemma_s_3>bound_main_lemma_s_3</a></li>
<li><a href=#TopologicalProps-bound_on_all_plans_bounds_PLS_s>bound_on_all_plans_bounds_PLS_s</a></li>
<li><a href=#TopologicalProps-bound_on_all_plans_bounds_MPLS_s_i>bound_on_all_plans_bounds_MPLS_s_i</a></li>
<li><a href=#TopologicalProps-bound_on_all_plans_bounds_MPLS_s>bound_on_all_plans_bounds_MPLS_s</a></li>
<li><a href=#TopologicalProps-Sup_MPLS_s_lt_if>Sup_MPLS_s_lt_if</a></li>
<li><a href=#TopologicalProps-bound_child_parent_lemma_s_2>bound_child_parent_lemma_s_2</a></li>
<li><a href=#TopologicalProps-problem_plan_bound_s_LESS_EQ_problem_plan_bound_thm>problem_plan_bound_s_LESS_EQ_problem_plan_bound_thm</a></li>
<li><a href=#TopologicalProps-AS_VALID_MPLS_VALID>AS_VALID_MPLS_VALID</a></li>
<li><a href=#TopologicalProps-bound_main_lemma_s_1>bound_main_lemma_s_1</a></li>
<li><a href=#TopologicalProps-problem_plan_bound_s_ge_min_pls>problem_plan_bound_s_ge_min_pls</a></li>
<li><a href=#TopologicalProps-problem_plan_bound_s_works>problem_plan_bound_s_works</a></li>
<li><a href=#TopologicalProps-PLS_def_ITP2015>PLS_def_ITP2015</a></li>
<li><a href=#TopologicalProps-expanded_problem_plan_bound_charles_thm>expanded_problem_plan_bound_charles_thm</a></li>
<li><a href=#TopologicalProps-bound_main_lemma_charles_3>bound_main_lemma_charles_3</a></li>
<li><a href=#TopologicalProps-in_PLS_charles_leq_2_pow_n>in_PLS_charles_leq_2_pow_n</a></li>
<li><a href=#TopologicalProps-x_in_MPLS_charles_then>x_in_MPLS_charles_then</a></li>
<li><a href=#TopologicalProps-in_MPLS_charles_leq_2_pow_n>in_MPLS_charles_leq_2_pow_n</a></li>
<li><a href=#TopologicalProps-bound_main_lemma_charles>bound_main_lemma_charles</a></li>
<li><a href=#TopologicalProps-bound_on_all_plans_bounds_PLS_charles>bound_on_all_plans_bounds_PLS_charles</a></li>
<li><a href=#TopologicalProps-bound_on_all_plans_bounds_MPLS_charles_i>bound_on_all_plans_bounds_MPLS_charles_i</a></li>
<li><a href=#TopologicalProps-bound_on_all_plans_bounds_MPLS_charles>bound_on_all_plans_bounds_MPLS_charles</a></li>
<li><a href=#TopologicalProps-bound_on_all_plans_bounds_problem_plan_bound_charles_i>bound_on_all_plans_bounds_problem_plan_bound_charles_i</a></li>
<li><a href=#TopologicalProps-bound_on_all_plans_bounds_problem_plan_bound_charles>bound_on_all_plans_bounds_problem_plan_bound_charles</a></li>
<li><a href=#TopologicalProps-sublistD_bounds_D>sublistD_bounds_D</a></li>
<li><a href=#TopologicalProps-MAX_SET_ELIM%27>MAX_SET_ELIM'</a></li>
<li><a href=#TopologicalProps-MIN_SET_ELIM%27>MIN_SET_ELIM'</a></li>
<li><a href=#TopologicalProps-RD_bounds_sublistD_i_a>RD_bounds_sublistD_i_a</a></li>
<li><a href=#TopologicalProps-RD_bounds_sublistD_i_b>RD_bounds_sublistD_i_b</a></li>
<li><a href=#TopologicalProps-RD_bounds_sublistD_i_c>RD_bounds_sublistD_i_c</a></li>
<li><a href=#TopologicalProps-RD_bounds_sublistD_i>RD_bounds_sublistD_i</a></li>
<li><a href=#TopologicalProps-RD_bounds_sublistD>RD_bounds_sublistD</a></li>
<li><a href=#TopologicalProps-empty_problem_bound>empty_problem_bound</a></li>
<li><a href=#TopologicalProps-problem_plan_bound_works%27>problem_plan_bound_works'</a></li>
<li><a href=#TopologicalProps-problem_plan_bound_UBound>problem_plan_bound_UBound</a></li>
<li><a href=#TopologicalProps-finite_traversed_states>finite_traversed_states</a></li>
<li><a href=#TopologicalProps-traversed_states_nempty>traversed_states_nempty</a></li>
<li><a href=#TopologicalProps-traversed_states_geq_1>traversed_states_geq_1</a></li>
<li><a href=#TopologicalProps-init_is_traversed>init_is_traversed</a></li>
<li><a href=#TopologicalProps-traversed_states_rem_condless_act>traversed_states_rem_condless_act</a></li>
<li><a href=#TopologicalProps-td_UBound_i>td_UBound_i</a></li>
<li><a href=#TopologicalProps-td_UBound>td_UBound</a></li>
</ul>
</li><li><a href=#SystemAbstraction>SystemAbstraction</a>
<ul>
<li><a href=#SystemAbstraction-action_proj_pair>action_proj_pair</a></li>
<li><a href=#SystemAbstraction-as_proj_pair>as_proj_pair</a></li>
<li><a href=#SystemAbstraction-proj_state_succ>proj_state_succ</a></li>
<li><a href=#SystemAbstraction-graph_plan_lemma_1>graph_plan_lemma_1</a></li>
<li><a href=#SystemAbstraction-proj_action_dom_eq_inter>proj_action_dom_eq_inter</a></li>
<li><a href=#SystemAbstraction-graph_plan_neq_mems_state_set_neq_len>graph_plan_neq_mems_state_set_neq_len</a></li>
<li><a href=#SystemAbstraction-graph_plan_not_eq_last_diff_paths>graph_plan_not_eq_last_diff_paths</a></li>
<li><a href=#SystemAbstraction-dom_eff_subset_imp_dom_succ_eq_proj>dom_eff_subset_imp_dom_succ_eq_proj</a></li>
<li><a href=#SystemAbstraction-drest_proj_succ_eq_drest_succ>drest_proj_succ_eq_drest_succ</a></li>
<li><a href=#SystemAbstraction-drest_succ_proj_eq_drest_succ>drest_succ_proj_eq_drest_succ</a></li>
<li><a href=#SystemAbstraction-exec_drest_cons_proj_eq_succ>exec_drest_cons_proj_eq_succ</a></li>
<li><a href=#SystemAbstraction-exec_drest>exec_drest</a></li>
<li><a href=#SystemAbstraction-not_empty_eff_in_as_proj>not_empty_eff_in_as_proj</a></li>
<li><a href=#SystemAbstraction-empty_eff_not_in_as_proj>empty_eff_not_in_as_proj</a></li>
<li><a href=#SystemAbstraction-empty_eff_drest_no_eff>empty_eff_drest_no_eff</a></li>
<li><a href=#SystemAbstraction-sat_precond_exec_as_proj_eq_proj_exec>sat_precond_exec_as_proj_eq_proj_exec</a></li>
<li><a href=#SystemAbstraction-action_proj_in_prob_proj>action_proj_in_prob_proj</a></li>
<li><a href=#SystemAbstraction-valid_as_valid_as_proj>valid_as_valid_as_proj</a></li>
<li><a href=#SystemAbstraction-finite_imp_finite_prob_proj>finite_imp_finite_prob_proj</a></li>
<li><a href=#SystemAbstraction-as_proj_eq_filter_action_proj>as_proj_eq_filter_action_proj</a></li>
<li><a href=#SystemAbstraction-append_eq_as_proj>append_eq_as_proj</a></li>
<li><a href=#SystemAbstraction-succ_drest_eq_drest_succ>succ_drest_eq_drest_succ</a></li>
<li><a href=#SystemAbstraction-proj_exec_proj_eq_exec_proj>proj_exec_proj_eq_exec_proj</a></li>
<li><a href=#SystemAbstraction-proj_exec_proj_eq_exec_proj%27>proj_exec_proj_eq_exec_proj'</a></li>
<li><a href=#SystemAbstraction-graph_plan_lemma_9>graph_plan_lemma_9</a></li>
<li><a href=#SystemAbstraction-act_dom_proj_eff_subset_act_dom_eff>act_dom_proj_eff_subset_act_dom_eff</a></li>
<li><a href=#SystemAbstraction-exec_as_proj_valid>exec_as_proj_valid</a></li>
<li><a href=#SystemAbstraction-drest_exec_as_proj_eq_drest_exec>drest_exec_as_proj_eq_drest_exec</a></li>
<li><a href=#SystemAbstraction-action_proj_idempot>action_proj_idempot</a></li>
<li><a href=#SystemAbstraction-action_proj_idempot%27>action_proj_idempot'</a></li>
<li><a href=#SystemAbstraction-action_proj_idempot%27%27>action_proj_idempot''</a></li>
<li><a href=#SystemAbstraction-sat_precond_as_proj>sat_precond_as_proj</a></li>
<li><a href=#SystemAbstraction-sat_precond_drest_as_proj>sat_precond_drest_as_proj</a></li>
<li><a href=#SystemAbstraction-as_proj_eq_as>as_proj_eq_as</a></li>
<li><a href=#SystemAbstraction-exec_rem_effless_as_proj_eq_exec_as_proj>exec_rem_effless_as_proj_eq_exec_as_proj</a></li>
<li><a href=#SystemAbstraction-exec_as_proj_eq_exec_as>exec_as_proj_eq_exec_as</a></li>
<li><a href=#SystemAbstraction-dom_prob_proj>dom_prob_proj</a></li>
<li><a href=#SystemAbstraction-subset_proj_absorb_1_a>subset_proj_absorb_1_a</a></li>
<li><a href=#SystemAbstraction-subset_proj_absorb_1>subset_proj_absorb_1</a></li>
<li><a href=#SystemAbstraction-subset_proj_absorb>subset_proj_absorb</a></li>
<li><a href=#SystemAbstraction-union_proj_absorb>union_proj_absorb</a></li>
<li><a href=#SystemAbstraction-NOT_VS_IN_DOM_PROJ_PRE_EFF>NOT_VS_IN_DOM_PROJ_PRE_EFF</a></li>
<li><a href=#SystemAbstraction-IN_DISJ_DEP_IMP_DEP_DIFF>IN_DISJ_DEP_IMP_DEP_DIFF</a></li>
<li><a href=#SystemAbstraction-PROB_DOM_PROJ_DIFF>PROB_DOM_PROJ_DIFF</a></li>
<li><a href=#SystemAbstraction-two_children_parent_mems_le_finite>two_children_parent_mems_le_finite</a></li>
<li><a href=#SystemAbstraction-PROJ_DOM_PRE_EFF_SUBSET_DOM>PROJ_DOM_PRE_EFF_SUBSET_DOM</a></li>
<li><a href=#SystemAbstraction-NOT_IN_PRE_EFF_NOT_IN_PRE_EFF_PROJ>NOT_IN_PRE_EFF_NOT_IN_PRE_EFF_PROJ</a></li>
<li><a href=#SystemAbstraction-dep_proj_dep>dep_proj_dep</a></li>
<li><a href=#SystemAbstraction-NDEP_PROJ_NDEP>NDEP_PROJ_NDEP</a></li>
<li><a href=#SystemAbstraction-SUBSET_PROJ_DOM_DISJ>SUBSET_PROJ_DOM_DISJ</a></li>
<li><a href=#SystemAbstraction-NOT_VS_DEP_IMP_DEP_PROJ>NOT_VS_DEP_IMP_DEP_PROJ</a></li>
<li><a href=#SystemAbstraction-DISJ_PROJ_NDEP_IMP_NDEP>DISJ_PROJ_NDEP_IMP_NDEP</a></li>
<li><a href=#SystemAbstraction-PROJ_DOM_IDEMPOT>PROJ_DOM_IDEMPOT</a></li>
<li><a href=#SystemAbstraction-prob_proj_idempot>prob_proj_idempot</a></li>
<li><a href=#SystemAbstraction-prob_proj_dom_diff_eq_prob_proj_prob_proj_dom_diff>prob_proj_dom_diff_eq_prob_proj_prob_proj_dom_diff</a></li>
<li><a href=#SystemAbstraction-PROJ_DEP_IMP_DEP>PROJ_DEP_IMP_DEP</a></li>
<li><a href=#SystemAbstraction-PROJ_NDEP_TC_IMP_NDEP_TC_OR>PROJ_NDEP_TC_IMP_NDEP_TC_OR</a></li>
<li><a href=#SystemAbstraction-every_action_proj_eq_as_proj>every_action_proj_eq_as_proj</a></li>
<li><a href=#SystemAbstraction-empty_eff_not_in_as_proj_2>empty_eff_not_in_as_proj_2</a></li>
<li><a href=#SystemAbstraction-sublist_as_proj_eq_as>sublist_as_proj_eq_as</a></li>
<li><a href=#SystemAbstraction-DISJ_EFF_DISJ_PROJ_EFF>DISJ_EFF_DISJ_PROJ_EFF</a></li>
<li><a href=#SystemAbstraction-state_succ_proj_eq_state_succ>state_succ_proj_eq_state_succ</a></li>
<li><a href=#SystemAbstraction-no_effectless_proj>no_effectless_proj</a></li>
<li><a href=#SystemAbstraction-as_proj_valid_in_prob_proj>as_proj_valid_in_prob_proj</a></li>
<li><a href=#SystemAbstraction-prob_proj_comm>prob_proj_comm</a></li>
<li><a href=#SystemAbstraction-vset_proj_imp_vset>vset_proj_imp_vset</a></li>
<li><a href=#SystemAbstraction-vset_imp_vset_act_proj_diff>vset_imp_vset_act_proj_diff</a></li>
<li><a href=#SystemAbstraction-action_proj_disj_diff>action_proj_disj_diff</a></li>
<li><a href=#SystemAbstraction-disj_proj_proj_eq_proj>disj_proj_proj_eq_proj</a></li>
<li><a href=#SystemAbstraction-n_replace_proj_le_n_as_2>n_replace_proj_le_n_as_2</a></li>
<li><a href=#SystemAbstraction-empty_problem_proj_bound>empty_problem_proj_bound</a></li>
<li><a href=#SystemAbstraction-problem_plan_bound_works_proj>problem_plan_bound_works_proj</a></li>
<li><a href=#SystemAbstraction-action_proj_inter_i>action_proj_inter_i</a></li>
<li><a href=#SystemAbstraction-action_proj_inter>action_proj_inter</a></li>
<li><a href=#SystemAbstraction-prob_proj_inter>prob_proj_inter</a></li>
<li><a href=#SystemAbstraction-state_succ_fixpoint_if>state_succ_fixpoint_if</a></li>
<li><a href=#SystemAbstraction-agree_state_succ_idempot>agree_state_succ_idempot</a></li>
<li><a href=#SystemAbstraction-fmdom%27_fmrestrict_set>fmdom'_fmrestrict_set</a></li>
<li><a href=#SystemAbstraction-fmdom%27_fmrestrict_set_fmadd>fmdom'_fmrestrict_set_fmadd</a></li>
<li><a href=#SystemAbstraction-fmrestrict_agree>fmrestrict_agree</a></li>
<li><a href=#SystemAbstraction-agree_restrict_state_succ_idempot>agree_restrict_state_succ_idempot</a></li>
<li><a href=#SystemAbstraction-agree_exec_idempot>agree_exec_idempot</a></li>
<li><a href=#SystemAbstraction-agree_restrict_exec_idempot>agree_restrict_exec_idempot</a></li>
<li><a href=#SystemAbstraction-agree_restrict_exec_idempot_pair>agree_restrict_exec_idempot_pair</a></li>
<li><a href=#SystemAbstraction-agree_comm>agree_comm</a></li>
<li><a href=#SystemAbstraction-restricted_agree_imp_agree>restricted_agree_imp_agree</a></li>
<li><a href=#SystemAbstraction-agree_imp_submap>agree_imp_submap</a></li>
<li><a href=#SystemAbstraction-agree_FUNION>agree_FUNION</a></li>
<li><a href=#SystemAbstraction-agree_fm_list_union>agree_fm_list_union</a></li>
<li><a href=#SystemAbstraction-DRESTRICT_EQ_AGREE>DRESTRICT_EQ_AGREE</a></li>
<li><a href=#SystemAbstraction-SUBMAPS_AGREE>SUBMAPS_AGREE</a></li>
<li><a href=#SystemAbstraction-snapshot_pair>snapshot_pair</a></li>
<li><a href=#SystemAbstraction-action_agree_valid_in_snapshot>action_agree_valid_in_snapshot</a></li>
<li><a href=#SystemAbstraction-as_mem_agree_valid_in_snapshot>as_mem_agree_valid_in_snapshot</a></li>
<li><a href=#SystemAbstraction-fmrestrict_agree_monotonous>fmrestrict_agree_monotonous</a></li>
<li><a href=#SystemAbstraction-SUBMAP_FUNION_DRESTRICT_i>SUBMAP_FUNION_DRESTRICT_i</a></li>
<li><a href=#SystemAbstraction-SUBMAP_FUNION_DRESTRICT%27>SUBMAP_FUNION_DRESTRICT'</a></li>
<li><a href=#SystemAbstraction-UNION_FUNION_DRESTRICT_SUBMAP>UNION_FUNION_DRESTRICT_SUBMAP</a></li>
<li><a href=#SystemAbstraction-agree_DRESTRICT>agree_DRESTRICT</a></li>
<li><a href=#SystemAbstraction-agree_DRESTRICT_2>agree_DRESTRICT_2</a></li>
<li><a href=#SystemAbstraction-snapshot_eq_filter>snapshot_eq_filter</a></li>
<li><a href=#SystemAbstraction-FINITE_snapshot>FINITE_snapshot</a></li>
<li><a href=#SystemAbstraction-dom_proj_snapshot>dom_proj_snapshot</a></li>
<li><a href=#SystemAbstraction-valid_states_snapshot>valid_states_snapshot</a></li>
<li><a href=#SystemAbstraction-valid_proj_neq_succ_restricted_neq_succ>valid_proj_neq_succ_restricted_neq_succ</a></li>
<li><a href=#SystemAbstraction-proj_successors>proj_successors</a></li>
<li><a href=#SystemAbstraction-state_in_successor_proj_in_state_in_successor>state_in_successor_proj_in_state_in_successor</a></li>
<li><a href=#SystemAbstraction-proj_FDOM_eff_subset_FDOM_valid_states>proj_FDOM_eff_subset_FDOM_valid_states</a></li>
<li><a href=#SystemAbstraction-valid_proj_action_valid_succ>valid_proj_action_valid_succ</a></li>
<li><a href=#SystemAbstraction-proj_successors_of_valid_are_valid>proj_successors_of_valid_are_valid</a></li>
<li><a href=#SystemAbstraction-fmrestrict_set_inter_img>fmrestrict_set_inter_img</a></li>
<li><a href=#SystemAbstraction-invariantStateSpace_thm_9>invariantStateSpace_thm_9</a></li>
<li><a href=#SystemAbstraction-FINITE_ss_proj>FINITE_ss_proj</a></li>
<li><a href=#SystemAbstraction-nempty_stateSpace_nempty_ss_proj>nempty_stateSpace_nempty_ss_proj</a></li>
<li><a href=#SystemAbstraction-invariantStateSpace_thm_5>invariantStateSpace_thm_5</a></li>
<li><a href=#SystemAbstraction-dom_subset_ssproj_eq_ss>dom_subset_ssproj_eq_ss</a></li>
<li><a href=#SystemAbstraction-neq_vs_neq_ss_proj>neq_vs_neq_ss_proj</a></li>
<li><a href=#SystemAbstraction-subset_dom_stateSpace_ss_proj>subset_dom_stateSpace_ss_proj</a></li>
<li><a href=#SystemAbstraction-card_proj_leq>card_proj_leq</a></li>
</ul>
</li><li><a href=#Acyclicity>Acyclicity</a>
<ul>
<li><a href=#Acyclicity-top_sorted_abs_mem>top_sorted_abs_mem</a></li>
<li><a href=#Acyclicity-top_sorted_cons>top_sorted_cons</a></li>
<li><a href=#Acyclicity-individual_weight_less_eq_lp>individual_weight_less_eq_lp</a></li>
<li><a href=#Acyclicity-lp_geq_lp_from_successor>lp_geq_lp_from_successor</a></li>
<li><a href=#Acyclicity-weight_fun_leq_imp_lp_leq>weight_fun_leq_imp_lp_leq</a></li>
<li><a href=#Acyclicity-wlp_congruence_rule>wlp_congruence_rule</a></li>
<li><a href=#Acyclicity-wlp_ite_weights>wlp_ite_weights</a></li>
<li><a href=#Acyclicity-map_wlp_ite_weights>map_wlp_ite_weights</a></li>
<li><a href=#Acyclicity-wlp_weight_lamda_exp>wlp_weight_lamda_exp</a></li>
<li><a href=#Acyclicity-img_wlp_ite_weights>img_wlp_ite_weights</a></li>
</ul>
</li><li><a href=#AcycSspace>AcycSspace</a>
<ul>
<li><a href=#AcycSspace-vars_change_cat>vars_change_cat</a></li>
<li><a href=#AcycSspace-empty_change_no_change>empty_change_no_change</a></li>
<li><a href=#AcycSspace-zero_change_imp_all_effects_submap>zero_change_imp_all_effects_submap</a></li>
<li><a href=#AcycSspace-zero_change_imp_all_preconds_submap>zero_change_imp_all_preconds_submap</a></li>
<li><a href=#AcycSspace-no_vs_change_valid_in_snapshot>no_vs_change_valid_in_snapshot</a></li>
<li><a href=#AcycSspace-no_vs_change_obtain_snapshot_bound_1st_step>no_vs_change_obtain_snapshot_bound_1st_step</a></li>
<li><a href=#AcycSspace-no_vs_change_obtain_snapshot_bound_2nd_step>no_vs_change_obtain_snapshot_bound_2nd_step</a></li>
<li><a href=#AcycSspace-no_vs_change_obtain_snapshot_bound_3rd_step>no_vs_change_obtain_snapshot_bound_3rd_step</a></li>
<li><a href=#AcycSspace-no_vs_change_snapshot_s_vs_is_valid_bound_i>no_vs_change_snapshot_s_vs_is_valid_bound_i</a></li>
<li><a href=#AcycSspace-no_vs_change_snapshot_s_vs_is_valid_bound>no_vs_change_snapshot_s_vs_is_valid_bound</a></li>
<li><a href=#AcycSspace-snapshot_bound_leq_S>snapshot_bound_leq_S</a></li>
<li><a href=#AcycSspace-S_geq_S_succ_plus_ell>S_geq_S_succ_plus_ell</a></li>
<li><a href=#AcycSspace-vars_change_cons>vars_change_cons</a></li>
<li><a href=#AcycSspace-vars_change_cons_2>vars_change_cons_2</a></li>
<li><a href=#AcycSspace-problem_plan_bound_S_bound_1st_step>problem_plan_bound_S_bound_1st_step</a></li>
<li><a href=#AcycSspace-problem_plan_bound_S_bound_2nd_step>problem_plan_bound_S_bound_2nd_step</a></li>
<li><a href=#AcycSspace-S_in_MPLS_leq_2_pow_n>S_in_MPLS_leq_2_pow_n</a></li>
<li><a href=#AcycSspace-problem_plan_bound_S_bound>problem_plan_bound_S_bound</a></li>
<li><a href=#AcycSspace-problem_plan_bound_S_bound_2nd_step_thesis>problem_plan_bound_S_bound_2nd_step_thesis</a></li>
</ul>
</li>
</ul>
</div>
<ul>
<li><a href=https://www.isa-afp.org/browser_info/current/AFP/Factored_Transition_System_Bounding/outline.pdf>Proof
outline</a></li>
<li><a href=https://www.isa-afp.org/browser_info/current/AFP/Factored_Transition_System_Bounding/document.pdf>Proof
document</a></li>
<li><a href=https://www.isa-afp.org/browser_info/current/AFP/Factored_Transition_System_Bounding/session_graph.pdf>Theory dependencies</a></li>
</ul>
</div>
</aside>
<div class="content theories"><header>
<form action=/%20search>
<div class=form-container>
<input id=searchInput type=search size=31 maxlength=255 aria-label="Search the AFP" list=autocomplete><button id=searchButton type=button><img src=/images/search.svg alt=Search></button>
<datalist id=autocomplete>
</datalist>
</div>
</form>
<h1><span class=first>S</span>ession <span class=first>F</span>actored_<span class=first>T</span>ransition_<span class=first>S</span>ystem_<span class=first>B</span>ounding</h1>
<div>
</div>
</header><div id=banner data-id=0>
<p>This is an unofficial reimagining of the <a href=https://isa-afp.org target=_blank rel="noreferrer noopener">Archive of Formal Proofs</a></p><button style=display:none id=close title=close><svg viewBox="0 0 6.718 6.718" aria-hidden="true" focusable="false"><rect transform="rotate(45)" x="4" y="-4" width="1.5" height="8"/><rect transform="rotate(45)" x=".75" y="-.75" width="8" height="1.5"/></svg></button>
</div>
<div><main>
<div id=FactoredSystemLib>
<div class=head>
<h1>Theory FactoredSystemLib</h1>
</div>
<pre class=source><span class=keyword1><span class=command>theory</span></span> FactoredSystemLib
  <span class=keyword2><span class=keyword>imports</span></span> <a href=https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html>Main</a> <span class=quoted>"<a href=https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Finite_Map.html>HOL-Library.Finite_Map</a>"</span>
<span class=keyword2><span class=keyword>begin</span></span> 


<span class=keyword1><span class=command>section</span></span> <span class=quoted><span class=plain_text>‹Factored Systems Library›</span></span>

<span class=keyword1><span class=command>text</span></span> <span class=quoted><span class=plain_text>‹This section contains definitions used in the factored system theory (FactoredSystem.thy) and in 
other theories. ›</span></span>


<span class=keyword1><span class=command>subsection</span></span> <span class=quoted><span class=plain_text>‹Semantics of Map Addition›</span></span>

<span class=keyword1><span class=command>text</span></span> <span class=quoted><span class=plain_text>‹ Most importantly, we are redefining the map addition operator (`++`) to reflect HOL4 
semantics which are left to right (ltr), rather than right-to-left as in Isabelle/HOL. 

This means that given a finite map (`M = M1 ++ M2`) and a variable `v` which is in the domain of
both `M1` and `M2`, the lookup `M v` will yield `M1 v` in HOL4 but `M2 v` in Isabelle/HOL.
This behavior can be confirmed  by looking at the definition of `fmap\_add` (`++f`, 
Finite\_Map.thy:460)---which is lifted from `map\_add` (Map.thy:24)

  <span class=antiquoted><span class=antiquoted><span class=antiquote><span class=antiquote>@{</span></span><span class=operator><span class=operator>const</span></span> map_add<span class=antiquote><span class=antiquote>}</span></span></span></span>  (infixl "++" 100) where
    <span class=antiquoted><span class=antiquoted><span class=antiquote><span class=antiquote>@{</span></span><span class=operator><span class=operator>term</span></span> <span class=quoted><span class=quoted>"<span class=free><span class=free>m1</span></span> <span class=main><span class=main>++</span></span> <span class=free><span class=free>m2</span></span> <span class=main><span class=main>=</span></span> <span class=main><span class=main>(</span></span><span class=main><span class=main>λ</span></span><span class=bound><span class=bound>x</span></span><span class=main><span class=main>.</span></span> <span class=keyword1><span class=keyword1>case</span></span> <span class=free><span class=free>m2</span></span> <span class=bound><span class=bound>x</span></span> <span class=keyword1><span class=keyword1>of</span></span> None <span class=main><span class=main>⇒</span></span> <span class=free><span class=free>m1</span></span> <span class=bound><span class=bound>x</span></span> <span class=main><span class=main>|</span></span> Some <span class=bound><span class=bound>y</span></span> <span class=main><span class=main>⇒</span></span> Some <span class=bound><span class=bound>y</span></span><span class=main><span class=main>)</span></span>"</span></span><span class=antiquote><span class=antiquote>}</span></span></span></span>
  

to finite sets---and the HOL4 definition of "FUNION` (finite\_mapScript.sml:770) which recurs
on `union\_lemma` (finite\_mapScript.sml:756)

  !\^fmap g.
     ?union.
       (FDOM union = FDOM f Union (g ` FDOM)) /\
       (!x. FAPPLY union x = if x IN FDOM f then FAPPLY f x else FAPPLY g x)
  
The ltr semantics are also reflected in [Abdulaziz et al., Definition 2, p.9].
›</span></span>

<span class=comment1>― ‹NOTE hide `Map.map\_add` to free the operator symbol `++` and redefine it to reflect HOL4 map 
addition semantics.›</span>
<span class=keyword1><span class=command>hide_const</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>open</span></span><span class=main>)</span> Map.map_add
<span class=keyword1><span class=command>no_notation</span></span> Map.map_add <span class=main>(</span><span class=keyword2><span class=keyword>infixl</span></span> <span class=quoted>"<span class=keyword1>++</span>"</span> 100<span class=main>)</span>
<span class=keyword1><span class=command>definition</span></span> <span class=entity>fmap_add_ltr</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=tfree>'a</span><span class=main>,</span> <span class=tfree>'b</span><span class=main>)</span> fmap <span class=main>⇒</span> <span class=main>(</span><span class=tfree>'a</span><span class=main>,</span> <span class=tfree>'b</span><span class=main>)</span> fmap <span class=main>⇒</span> <span class=main>(</span><span class=tfree>'a</span><span class=main>,</span> <span class=tfree>'b</span><span class=main>)</span> fmap"</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>infixl</span></span> <span class=quoted>"<span class=keyword1>++</span>"</span> 100<span class=main>)</span> <span class=keyword2><span class=keyword>where</span></span> 
  <span class=quoted><span class=quoted>"<span class=free><span class=bound><span class=entity>m1</span></span></span> <span class=main><span class=free>++</span></span> <span class=free><span class=bound><span class=entity>m2</span></span></span> <span class=main>≡</span> <span class=free><span class=bound><span class=entity>m2</span></span></span> <span class=keyword1>++<span class=hidden>⇩</span><sub>f</sub></span> <span class=free><span class=bound><span class=entity>m1</span></span></span>"</span></span>  


<span class=keyword1><span class=command>subsection</span></span> <span class=quoted><span class=plain_text>‹States, Actions and Problems.›</span></span> 

<span class=keyword1><span class=command>text</span></span> <span class=quoted><span class=plain_text>‹ Planning problems are typically formalized by considering possible states and the effect
of actions upon these states. 

In this case we consider a world model in propositional logic: i.e. states are finite maps of 
variables (with arbitrary type 'a) to boolean values and actions are pairs of states where the first
component specifies preconditions and the second component specifies effects (postconditions) of 
applying the action to a given state. [Abdulaziz et al., Definition 2, p.9] ›</span></span>

<span class=keyword1><span class=command>type_synonym</span></span> <span class=main>(</span><span class=tfree>'a</span><span class=main>)</span> state <span class=main>=</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=tfree>'a</span><span class=main>,</span> bool<span class=main>)</span> fmap"</span></span> 
<span class=keyword1><span class=command>type_synonym</span></span> <span class=main>(</span><span class=tfree>'a</span><span class=main>)</span> action <span class=main>=</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=tfree>'a</span> state <span class=main>×</span> <span class=tfree>'a</span> state<span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>type_synonym</span></span> <span class=main>(</span><span class=tfree>'a</span><span class=main>)</span> problem <span class=main>=</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=tfree>'a</span> state <span class=main>×</span> <span class=tfree>'a</span> state<span class=main>)</span> set"</span></span>


<span class=keyword1><span class=command>text</span></span> <span class=quoted><span class=plain_text>‹ For a given action <span class=antiquoted><span class=antiquoted><span class=antiquote><span class=antiquote>@{</span></span><span class=operator><span class=operator>term</span></span> <span class=quoted><span class=quoted>"<span class=free><span class=free>π</span></span> <span class=main><span class=main>=</span></span> <span class=main><span class=main>(</span></span><span class=free><span class=free>p</span></span><span class=main><span class=main>,</span></span> <span class=free><span class=free>e</span></span><span class=main><span class=main>)</span></span>"</span></span><span class=antiquote><span class=antiquote>}</span></span></span></span> the action domain <span class=antiquoted><span class=antiquoted><span class=antiquote><span class=antiquote>@{</span></span><span class=operator><span class=operator>term</span></span> <span class=quoted><span class=quoted>"<span class=free><span class=free>𝒟</span></span><span class=main><span class=main>(</span></span><span class=free><span class=free>π</span></span><span class=main><span class=main>)</span></span>"</span></span><span class=antiquote><span class=antiquote>}</span></span></span></span> is the set of variables `v` where 
a value is assigned to `v` in either `p` or `e`, i.e. `p v` or `e v` are defined. [Abdulaziz et al., 
Definition 2, p.9] ›</span></span>
<span class=keyword1><span class=command>definition</span></span> <span class=entity>action_dom</span> <span class=keyword2><span class=keyword>where</span></span> 
  <span class=quoted><span class=quoted>"<span class=free>action_dom</span> <span class=free><span class=bound><span class=entity>s1</span></span></span> <span class=free><span class=bound><span class=entity>s2</span></span></span> <span class=main>≡</span> <span class=main>(</span>fmdom' <span class=free><span class=bound><span class=entity>s1</span></span></span> <span class=main>∪</span> fmdom' <span class=free><span class=bound><span class=entity>s2</span></span></span><span class=main>)</span>"</span></span>


<span class=comment1>― ‹NOTE lemma `action\_dom\_pair`

  action\_dom a = FDOM (FST a) Union ((SND a) ` FDOM)

was removed because the curried definition of `action\_dom` in the translation makes it redundant.›</span>


<span class=keyword1><span class=command>text</span></span> <span class=quoted><span class=plain_text>‹ Now, for a given problem (i.e. action set) <span class=antiquoted><span class=antiquoted><span class=antiquote><span class=antiquote>@{</span></span><span class=operator><span class=operator>term</span></span> <span class=quoted><span class=quoted>"<span class=free><span class=free>δ</span></span>"</span></span><span class=antiquote><span class=antiquote>}</span></span></span></span>, the problem domain <span class=antiquoted><span class=antiquoted><span class=antiquote><span class=antiquote>@{</span></span><span class=operator><span class=operator>term</span></span> <span class=quoted><span class=quoted>"<span class=free><span class=free>𝒟</span></span><span class=main><span class=main>(</span></span><span class=free><span class=free>δ</span></span><span class=main><span class=main>)</span></span>"</span></span><span class=antiquote><span class=antiquote>}</span></span></span></span> is given by the
union of the action domains of all actions in <span class=antiquoted><span class=antiquoted><span class=antiquote><span class=antiquote>@{</span></span><span class=operator><span class=operator>term</span></span> <span class=quoted><span class=quoted>"<span class=free><span class=free>δ</span></span>"</span></span><span class=antiquote><span class=antiquote>}</span></span></span></span>. [Abdulaziz et al., Definition 3, p.9]

Moreover, the set of valid states <span class=antiquoted><span class=antiquoted><span class=antiquote><span class=antiquote>@{</span></span><span class=operator><span class=operator>term</span></span> <span class=quoted><span class=quoted>"<span class=free><span class=free>U</span></span><span class=main><span class=main>(</span></span><span class=free><span class=free>δ</span></span><span class=main><span class=main>)</span></span>"</span></span><span class=antiquote><span class=antiquote>}</span></span></span></span> is given by the union over all states whose domain is equal 
to the problem domain and the set of valid action sequences (or, valid plans) is given by the 
Kleene closure of <span class=antiquoted><span class=antiquoted><span class=antiquote><span class=antiquote>@{</span></span><span class=operator><span class=operator>term</span></span> <span class=quoted><span class=quoted>"<span class=free><span class=free>δ</span></span>"</span></span><span class=antiquote><span class=antiquote>}</span></span></span></span>, i.e. <span class=antiquoted><span class=antiquoted><span class=antiquote><span class=antiquote>@{</span></span><span class=operator><span class=operator>term</span></span> <span class=quoted><span class=quoted>"<span class=free><span class=free>δ_star</span></span> <span class=main><span class=main>=</span></span> <span class=main><span class=main>{</span></span><span class=bound><span class=bound>π</span></span><span class=main><span class=main>.</span></span> set<span class=main><span class=main>(</span></span><span class=bound><span class=bound>π</span></span><span class=main><span class=main>)</span></span> <span class=main><span class=main>⊆</span></span> <span class=free><span class=free>δ</span></span><span class=main><span class=main>}</span></span>"</span></span><span class=antiquote><span class=antiquote>}</span></span></span></span>. [Abdulaziz et al., Definition 3, p.9] 
  
Ultimately, the effect of executing an action `a` on a state `s` is given by calculating the 
succeding state. In general, the succeding state is either the preceding state---if the action does
not apply to the state, i.e. if the preconditions are not met---; or, the union of the effects of
the action application and the state. [Abdulaziz et al., Definition 3, p.9]
›</span></span>

<span class=comment1>― ‹NOTE name shortened to 'prob\_dom'.›</span>
<span class=comment1>― ‹NOTE lambda added to convert problem pairs to arguments of 'action\_dom'.›</span>
<span class=keyword1><span class=command>definition</span></span> <span class=entity>prob_dom</span> <span class=keyword2><span class=keyword>where</span></span> 
  <span class=quoted><span class=quoted>"<span class=free>prob_dom</span> <span class=free><span class=bound><span class=entity>prob</span></span></span> <span class=main>≡</span> <span class=main>⋃</span> <span class=main>(</span><span class=main>(</span><span class=main>λ</span> <span class=main>(</span><span class=bound>s1</span><span class=main>,</span> <span class=bound>s2</span><span class=main>)</span><span class=main>.</span> action_dom <span class=bound>s1</span> <span class=bound>s2</span><span class=main>)</span> <span class=main>`</span> <span class=free><span class=bound><span class=entity>prob</span></span></span><span class=main>)</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>valid_states</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>valid_states</span> <span class=free><span class=bound><span class=entity>prob</span></span></span> <span class=main>≡</span> <span class=main>{</span><span class=bound>s</span><span class=main>.</span> fmdom' <span class=bound>s</span> <span class=main>=</span> prob_dom <span class=free><span class=bound><span class=entity>prob</span></span></span><span class=main>}</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>valid_plans</span>  <span class=keyword2><span class=keyword>where</span></span> 
  <span class=quoted><span class=quoted>"<span class=free>valid_plans</span> <span class=free><span class=bound><span class=entity>prob</span></span></span> <span class=main>≡</span> <span class=main>{</span><span class=bound>as</span><span class=main>.</span> set <span class=bound>as</span> <span class=main>⊆</span> <span class=free><span class=bound><span class=entity>prob</span></span></span><span class=main>}</span>"</span></span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>state_succ</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>state_succ</span> <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=free><span class=bound><span class=entity>a</span></span></span> <span class=main>≡</span> <span class=main>(</span><span class=keyword1>if</span> fst <span class=free><span class=bound><span class=entity>a</span></span></span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=keyword1>then</span> <span class=main>(</span>snd <span class=free><span class=bound><span class=entity>a</span></span></span> <span class=main>++</span> <span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>)</span> <span class=keyword1>else</span> <span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>)</span>"</span></span>

<span class=keyword2><span class=keyword>end</span></span></pre>
</div><div id=ListUtils>
<div class=head>
<h1>Theory ListUtils</h1>
</div>
<pre class=source><span class=keyword1><span class=command>theory</span></span> ListUtils
  <span class=keyword2><span class=keyword>imports</span></span> <a href=https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html>Main</a> <span class=quoted>"<a href=https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Sublist.html>HOL-Library.Sublist</a>"</span>
<span class=keyword2><span class=keyword>begin</span></span> 

<span class=comment1>― ‹TODO assure translations
  * 'sublist' --&gt; 'subseq'
  * list\_frag l l' --&gt; sublist l' l (switch operands!)›</span>

<span class=keyword1 id=ListUtils-len_ge_0><span class=command>lemma</span></span> len_ge_0<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>l</span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"length <span class=free>l</span> <span class=main>≥</span> <span class=main>0</span>"</span></span> 
  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=ListUtils-len_gt_pref_is_pref><span class=command>lemma</span></span> len_gt_pref_is_pref<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>l</span> <span class=free>l1</span> <span class=free>l2</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>length <span class=free>l2</span> <span class=main>&gt;</span> length <span class=free>l1</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>prefix <span class=free>l1</span> <span class=free>l</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>prefix <span class=free>l2</span> <span class=free>l</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>prefix <span class=free>l1</span> <span class=free>l2</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>l2</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>l1</span></span> <span class=quoted><span class=free>l</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> Nil
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span><span class=main>(</span>length <span class=main>[]</span> <span class=main>&gt;</span> length <span class=skolem>l1</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> 
    <span class=keyword1><span class=command>using</span></span> Nil
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>a</span> <span class=skolem>l2</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>proof</span></span><span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=skolem>l1</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=skolem>l</span></span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> Nil
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> 
      <span class=keyword1><span class=command>using</span></span> Nil_prefix
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>b</span> <span class=skolem>l1</span><span class=main>)</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>proof</span></span><span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=skolem>l</span></span><span class=main>)</span>
      <span class=keyword3><span class=command>case</span></span> Nil
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span><span class=main>(</span>prefix <span class=main>(</span><span class=skolem>a</span> <span class=main>#</span> <span class=skolem>l2</span><span class=main>)</span> <span class=skolem>l</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>4<span class=main>)</span>
        <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>next</span></span>
      <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>c</span> <span class=skolem>l</span><span class=main>)</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"length <span class=skolem>l2</span> <span class=main>&gt;</span> length <span class=skolem>l1</span>"</span></span> 
        <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>2<span class=main>)</span>
        <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> Cons <span class=keyword1><span class=command>proof</span></span><span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=skolem>l</span></span><span class=main>)</span>
        <span class=keyword3><span class=command>case</span></span> Nil
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>l1</span> <span class=main>=</span> <span class=main>[</span><span class=skolem>c</span><span class=main>]</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>l2</span> <span class=main>=</span> <span class=main>[</span><span class=skolem>c</span><span class=main>]</span>"</span></span> 
          <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>3<span class=main>,</span> 4<span class=main>)</span> local.Cons 1 
          <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span><span class=main><span class=keyword3>+</span></span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> 
          <span class=keyword1><span class=command>using</span></span> 1 
          <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword1><span class=command>next</span></span>
        <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>d</span> <span class=skolem>l'</span><span class=main>)</span>
        <span class=keyword1><span class=command>{</span></span>
          <span class=keyword1><span class=command>thm</span></span> len_ge_0
          <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"length <span class=skolem>l1</span> <span class=main>≥</span> <span class=main>0</span>"</span></span> 
            <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
          <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"length <span class=skolem>l2</span> <span class=main>&gt;</span> <span class=main>0</span>"</span></span> 
            <span class=keyword1><span class=command>using</span></span> 1 
            <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
          <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>l2</span> <span class=main>≠</span> <span class=main>[]</span>"</span></span> <span class=keyword1><span class=command>using</span></span> 1
            <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
        <span class=keyword1><span class=command>}</span></span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"length <span class=main>(</span><span class=skolem>a</span> <span class=main>#</span> <span class=skolem>l1</span><span class=main>)</span> <span class=main>≤</span> length <span class=main>(</span><span class=skolem>b</span> <span class=main>#</span> <span class=skolem>l2</span><span class=main>)</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> 1 le_eq_less_or_eq
          <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
          <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>3<span class=main>,</span> 4<span class=main>)</span> prefix_length_prefix 
          <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
      <span class=keyword1><span class=command>qed</span></span>
    <span class=keyword1><span class=command>qed</span></span> 
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=ListUtils-nempty_list_append_length_add><span class=command>lemma</span></span> nempty_list_append_length_add<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>l1</span> <span class=free>l2</span> <span class=free>l3</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>l2</span> <span class=main>≠</span> <span class=main>[]</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"length <span class=main>(</span><span class=free>l1</span> <span class=main>@</span> <span class=free>l3</span><span class=main>)</span> <span class=main>&lt;</span> length <span class=main>(</span><span class=free>l1</span> <span class=main>@</span> <span class=free>l2</span> <span class=main>@</span><span class=free>l3</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>l2</span></span><span class=main>)</span> <span class=operator>auto</span>


<span class=keyword1 id=ListUtils-append_filter><span class=command>lemma</span></span> append_filter<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>f1</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> <span class=main>⇒</span> bool"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=free>f2</span> <span class=free>as1</span> <span class=free>as2</span> <span class=keyword2><span class=keyword>and</span></span> <span class=free>p</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> list"</span></span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>as1</span> <span class=main>@</span> <span class=free>as2</span> <span class=main>=</span> filter <span class=free>f1</span> <span class=main>(</span>map <span class=free>f2</span> <span class=free>p</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>p_1</span> <span class=bound>p_2</span><span class=main>.</span> 
    <span class=main>(</span><span class=bound>p_1</span> <span class=main>@</span> <span class=bound>p_2</span> <span class=main>=</span> <span class=free>p</span><span class=main>)</span> 
    <span class=main>∧</span> <span class=main>(</span><span class=free>as1</span> <span class=main>=</span> filter <span class=free>f1</span> <span class=main>(</span>map <span class=free>f2</span> <span class=bound>p_1</span><span class=main>)</span><span class=main>)</span> 
    <span class=main>∧</span> <span class=main>(</span><span class=free>as2</span> <span class=main>=</span> filter <span class=free>f1</span> <span class=main>(</span>map <span class=free>f2</span> <span class=bound>p_2</span><span class=main>)</span><span class=main>)</span>
  <span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>p</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>f1</span></span> <span class=quoted><span class=free>f2</span></span> <span class=quoted><span class=free>as1</span></span> <span class=quoted><span class=free>as2</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> Nil
  <span class=keyword1><span class=command>from</span></span> Nil <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>as1</span> <span class=main>@</span> <span class=skolem>as2</span> <span class=main>=</span> <span class=main>[]</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> 2<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>as1</span> <span class=main>=</span> <span class=main>[]</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>as2</span> <span class=main>=</span> <span class=main>[]</span>"</span></span> 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span><span class=main><span class=keyword3>+</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?p1</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>[]</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?p2</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>[]</span>"</span></span>
  <span class=keyword1><span class=command>from</span></span> 1 2 
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?p1</span> <span class=main>@</span> <span class=var>?p2</span> <span class=main>=</span> <span class=main>[]</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>as1</span> <span class=main>=</span> <span class=main>(</span>filter <span class=skolem>f1</span> <span class=main>(</span>map <span class=skolem>f2</span> <span class=var>?p1</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>as2</span> <span class=main>=</span> <span class=main>(</span>filter <span class=skolem>f1</span> <span class=main>(</span>map <span class=skolem>f2</span> <span class=var>?p2</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command><span class=improper><span class=command>subgoal</span></span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command><span class=improper><span class=command>subgoal</span></span></span></span> <span class=keyword1><span class=command>using</span></span> 2<span class=main>(</span>1<span class=main>)</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command><span class=improper><span class=command>subgoal</span></span></span></span> <span class=keyword1><span class=command>using</span></span> 2<span class=main>(</span>2<span class=main>)</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> cons<span class=main>:</span> <span class=main>(</span>Cons <span class=skolem>a</span> <span class=skolem>p</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> 
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=skolem>as1</span>"</span></span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> Nil
    <span class=keyword1><span class=command>from</span></span> cons.prems Nil 
    <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>as2</span> <span class=main>=</span> filter <span class=skolem>f1</span> <span class=main>(</span>map <span class=skolem>f2</span> <span class=main>(</span><span class=skolem>a</span> <span class=main>#</span> <span class=skolem>p</span><span class=main>)</span><span class=main>)</span>"</span></span> 
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?p1</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>[]</span>"</span></span>
    <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?p2</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=skolem>a</span> <span class=main>#</span> <span class=skolem>p</span>"</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?p1</span> <span class=main>@</span> <span class=var>?p2</span> <span class=main>=</span> <span class=skolem>a</span> <span class=main>#</span> <span class=skolem>p</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>as1</span> <span class=main>=</span> filter <span class=skolem>f1</span> <span class=main>(</span>map <span class=skolem>f2</span> <span class=var>?p1</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>as2</span> <span class=main>=</span> filter <span class=skolem>f1</span> <span class=main>(</span>map <span class=skolem>f2</span> <span class=var>?p2</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command><span class=improper><span class=command>subgoal</span></span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span> 
      <span class=keyword1><span class=command><span class=improper><span class=command>subgoal</span></span></span></span> <span class=keyword1><span class=command>using</span></span> Nil <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
      <span class=keyword1><span class=command><span class=improper><span class=command>subgoal</span></span></span></span> <span class=keyword1><span class=command>using</span></span> 1 <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> 
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>a'</span> <span class=skolem>p'</span><span class=main>)</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> 
    <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=main>¬</span><span class=skolem>f1</span> <span class=main>(</span><span class=skolem>f2</span> <span class=skolem>a</span><span class=main>)</span>"</span></span><span class=main>)</span>
      <span class=keyword3><span class=command>case</span></span> True
      <span class=keyword1><span class=command>hence</span></span> <span class=quoted><span class=quoted>"filter <span class=skolem>f1</span> <span class=main>(</span>map <span class=skolem>f2</span> <span class=main>(</span><span class=skolem>a</span> <span class=main>#</span> <span class=skolem>p</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> filter <span class=skolem>f1</span> <span class=main>(</span>map <span class=skolem>f2</span> <span class=skolem>p</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
      <span class=keyword1><span class=command>hence</span></span> <span class=quoted><span class=quoted>"<span class=skolem>as1</span> <span class=main>@</span> <span class=skolem>as2</span> <span class=main>=</span> filter <span class=skolem>f1</span> <span class=main>(</span>map <span class=skolem>f2</span> <span class=skolem>p</span><span class=main>)</span>"</span></span> 
        <span class=keyword1><span class=command>using</span></span> cons.prems 
        <span class=keyword1><span class=command>by</span></span> <span class=operator>argo</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>p1</span></span> <span class=skolem><span class=skolem>p2</span></span> <span class=keyword2><span class=keyword>where</span></span> a<span class=main>:</span>
        <span class=quoted><span class=quoted>"<span class=skolem>p1</span> <span class=main>@</span> <span class=skolem>p2</span> <span class=main>=</span> <span class=skolem>p</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>as1</span> <span class=main>=</span> filter <span class=skolem>f1</span> <span class=main>(</span>map <span class=skolem>f2</span> <span class=skolem>p1</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>as2</span> <span class=main>=</span> filter <span class=skolem>f1</span> <span class=main>(</span>map <span class=skolem>f2</span> <span class=skolem>p2</span><span class=main>)</span>"</span></span> 
        <span class=keyword1><span class=command>using</span></span> cons.IH 
        <span class=keyword1><span class=command>by</span></span> <span class=operator>meson</span>
      <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?p1</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=skolem>a</span> <span class=main>#</span> <span class=skolem>p1</span>"</span></span>
      <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?p2</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=skolem>p2</span>"</span></span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?p1</span> <span class=main>@</span> <span class=var>?p2</span> <span class=main>=</span> <span class=skolem>a</span> <span class=main>#</span> <span class=skolem>p</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>as1</span> <span class=main>=</span> filter <span class=skolem>f1</span> <span class=main>(</span>map <span class=skolem>f2</span> <span class=var>?p1</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>as2</span> <span class=main>=</span> filter <span class=skolem>f1</span> <span class=main>(</span>map <span class=skolem>f2</span> <span class=var>?p2</span><span class=main>)</span>"</span></span> 
        <span class=keyword1><span class=command><span class=improper><span class=command>subgoal</span></span></span></span> <span class=keyword1><span class=command>using</span></span> a<span class=main>(</span>1<span class=main>)</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
        <span class=keyword1><span class=command><span class=improper><span class=command>subgoal</span></span></span></span> <span class=keyword1><span class=command>using</span></span> True a<span class=main>(</span>2<span class=main>)</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
        <span class=keyword1><span class=command><span class=improper><span class=command>subgoal</span></span></span></span> <span class=keyword1><span class=command>using</span></span> a<span class=main>(</span>3<span class=main>)</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
        <span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> 
        <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>next</span></span>
      <span class=keyword3><span class=command>case</span></span> False
      <span class=keyword1><span class=command>hence</span></span> <span class=quoted><span class=quoted>"filter <span class=skolem>f1</span> <span class=main>(</span>map <span class=skolem>f2</span> <span class=main>(</span><span class=skolem>a</span> <span class=main>#</span> <span class=skolem>p</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=skolem>f2</span> <span class=skolem>a</span> <span class=main>#</span> filter <span class=skolem>f1</span> <span class=main>(</span>map <span class=skolem>f2</span> <span class=skolem>p</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>a'</span> <span class=main>=</span> <span class=skolem>f2</span> <span class=skolem>a</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>p'</span> <span class=main>@</span> <span class=skolem>as2</span> <span class=main>=</span> filter <span class=skolem>f1</span> <span class=main>(</span>map <span class=skolem>f2</span> <span class=skolem>p</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>as1</span> <span class=main>=</span> <span class=skolem>a'</span> <span class=main>#</span> <span class=skolem>p'</span>"</span></span> 
        <span class=keyword1><span class=command>using</span></span> cons.prems Cons
        <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span><span class=main><span class=keyword3>+</span></span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>p1</span></span> <span class=skolem><span class=skolem>p2</span></span> <span class=keyword2><span class=keyword>where</span></span> 2<span class=main>:</span>
        <span class=quoted><span class=quoted>"<span class=skolem>p1</span> <span class=main>@</span> <span class=skolem>p2</span> <span class=main>=</span> <span class=skolem>p</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>p'</span> <span class=main>=</span> filter <span class=skolem>f1</span> <span class=main>(</span>map <span class=skolem>f2</span> <span class=skolem>p1</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>as2</span> <span class=main>=</span> filter <span class=skolem>f1</span> <span class=main>(</span>map <span class=skolem>f2</span> <span class=skolem>p2</span><span class=main>)</span>"</span></span> 
        <span class=keyword1><span class=command>using</span></span> cons.IH 
        <span class=keyword1><span class=command>by</span></span> <span class=operator>meson</span>
      <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?p1</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=skolem>a</span> <span class=main>#</span> <span class=skolem>p1</span>"</span></span>
      <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?p2</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=skolem>p2</span>"</span></span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?p1</span> <span class=main>@</span> <span class=var>?p2</span> <span class=main>=</span> <span class=skolem>a</span> <span class=main>#</span> <span class=skolem>p</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>as1</span> <span class=main>=</span> filter <span class=skolem>f1</span> <span class=main>(</span>map <span class=skolem>f2</span> <span class=var>?p1</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>as2</span> <span class=main>=</span> filter <span class=skolem>f1</span> <span class=main>(</span>map <span class=skolem>f2</span> <span class=var>?p2</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command><span class=improper><span class=command>subgoal</span></span></span></span> <span class=keyword1><span class=command>using</span></span> 2<span class=main>(</span>1<span class=main>)</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
        <span class=keyword1><span class=command><span class=improper><span class=command>subgoal</span></span></span></span> <span class=keyword1><span class=command>using</span></span> False 1<span class=main>(</span>1<span class=main>,</span> 3<span class=main>)</span> 2<span class=main>(</span>2<span class=main>)</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
        <span class=keyword1><span class=command><span class=improper><span class=command>subgoal</span></span></span></span> <span class=keyword1><span class=command>using</span></span> 2<span class=main>(</span>3<span class=main>)</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
        <span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>qed</span></span>    
<span class=keyword1><span class=command>qed</span></span>

<span class=comment1>― ‹NOTE types of `f1` and `p` had to be fixed for `append\_eq\_as\_proj\_1`.›</span> 
<span class=keyword1 id=ListUtils-append_eq_as_proj_1><span class=command>lemma</span></span> append_eq_as_proj_1<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>f1</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> <span class=main>⇒</span> bool"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=free>f2</span> <span class=free>as1</span> <span class=free>as2</span> <span class=free>as3</span> <span class=keyword2><span class=keyword>and</span></span> <span class=free>p</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> list"</span></span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>as1</span> <span class=main>@</span> <span class=free>as2</span> <span class=main>@</span> <span class=free>as3</span> <span class=main>=</span> filter <span class=free>f1</span> <span class=main>(</span>map <span class=free>f2</span>  <span class=free>p</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>p_1</span> <span class=bound>p_2</span> <span class=bound>p_3</span><span class=main>.</span> 
    <span class=main>(</span><span class=bound>p_1</span> <span class=main>@</span> <span class=bound>p_2</span> <span class=main>@</span> <span class=bound>p_3</span> <span class=main>=</span> <span class=free>p</span><span class=main>)</span> 
    <span class=main>∧</span> <span class=main>(</span><span class=free>as1</span> <span class=main>=</span> filter <span class=free>f1</span> <span class=main>(</span>map <span class=free>f2</span> <span class=bound>p_1</span><span class=main>)</span><span class=main>)</span> 
    <span class=main>∧</span> <span class=main>(</span><span class=free>as2</span> <span class=main>=</span> filter <span class=free>f1</span> <span class=main>(</span>map <span class=free>f2</span> <span class=bound>p_2</span><span class=main>)</span><span class=main>)</span> 
    <span class=main>∧</span> <span class=main>(</span><span class=free>as3</span> <span class=main>=</span> filter <span class=free>f1</span> <span class=main>(</span>map <span class=free>f2</span> <span class=bound>p_3</span><span class=main>)</span><span class=main>)</span>
  <span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>from</span></span> assms
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>p_1</span></span> <span class=skolem><span class=skolem>p_2</span></span> <span class=keyword2><span class=keyword>where</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>p_1</span> <span class=main>@</span> <span class=skolem>p_2</span> <span class=main>=</span> <span class=free>p</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>as1</span> <span class=main>=</span> filter <span class=free>f1</span> <span class=main>(</span>map <span class=free>f2</span> <span class=skolem>p_1</span><span class=main>)</span><span class=main>)</span>"</span></span> 
    <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>as2</span> <span class=main>@</span> <span class=free>as3</span> <span class=main>=</span> filter <span class=free>f1</span> <span class=main>(</span>map <span class=free>f2</span> <span class=skolem>p_2</span><span class=main>)</span><span class=main>)</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> append_filter<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>as1</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>as2</span> <span class=main>@</span> <span class=free>as3</span><span class=main>)</span>"</span></span><span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>meson</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> 1 
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>p_a</span></span> <span class=skolem><span class=skolem>p_b</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>p_a</span> <span class=main>@</span> <span class=skolem>p_b</span> <span class=main>=</span> <span class=skolem>p_2</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>as2</span> <span class=main>=</span> filter <span class=free>f1</span> <span class=main>(</span>map <span class=free>f2</span> <span class=skolem>p_a</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>as3</span> <span class=main>=</span> filter <span class=free>f1</span> <span class=main>(</span>map <span class=free>f2</span> <span class=skolem>p_b</span><span class=main>)</span><span class=main>)</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> append_filter<span class=main>[</span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> p<span class=main><span class=main>=</span></span><span class=quoted><span class=skolem>p_2</span></span><span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>meson</span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=ListUtils-filter_empty_every_not><span class=command>lemma</span></span> filter_empty_every_not<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>P</span> <span class=bound>l</span><span class=main>.</span> <span class=main>(</span>filter <span class=main>(</span><span class=main>λ</span><span class=bound>x</span><span class=main>.</span> <span class=bound>P</span> <span class=bound>x</span><span class=main>)</span> <span class=bound>l</span> <span class=main>=</span> <span class=main>[]</span><span class=main>)</span> <span class=main>=</span> list_all <span class=main>(</span><span class=main>λ</span><span class=bound>x</span><span class=main>.</span> <span class=main>¬</span><span class=bound>P</span> <span class=bound>x</span><span class=main>)</span> <span class=bound>l</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword3><span class=command>fix</span></span> <span class=skolem>P</span> <span class=skolem>l</span>
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>filter <span class=main>(</span><span class=main>λ</span><span class=bound>x</span><span class=main>.</span> <span class=skolem>P</span> <span class=bound>x</span><span class=main>)</span> <span class=skolem>l</span> <span class=main>=</span> <span class=main>[]</span><span class=main>)</span> <span class=main>=</span> list_all <span class=main>(</span><span class=main>λ</span><span class=bound>x</span><span class=main>.</span> <span class=main>¬</span><span class=skolem>P</span> <span class=bound>x</span><span class=main>)</span> <span class=skolem>l</span>"</span></span> 
    <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=skolem>l</span></span><span class=main>)</span>
     <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>auto</span><span class=main>)</span>
    <span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>
<span class=keyword1><span class=command>qed</span></span>

<span class=comment1>― ‹NOTE added lemma (listScript.sml:810).›</span>
<span class=keyword1 id=ListUtils-MEM_SPLIT><span class=command>lemma</span></span> MEM_SPLIT<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>x</span> <span class=free>l</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span>ListMem <span class=free>x</span> <span class=free>l</span>"</span></span> 
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>l1</span> <span class=bound>l2</span><span class=main>.</span> <span class=free>l</span> <span class=main>≠</span> <span class=bound>l1</span> <span class=main>@</span> <span class=main>[</span><span class=free>x</span><span class=main>]</span> <span class=main>@</span> <span class=bound>l2</span>"</span></span> 
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>assume</span></span> C<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>¬</span><span class=main>(</span><span class=main>∀</span><span class=bound>l1</span> <span class=bound>l2</span><span class=main>.</span> <span class=free>l</span> <span class=main>≠</span> <span class=bound>l1</span> <span class=main>@</span> <span class=main>[</span><span class=free>x</span><span class=main>]</span> <span class=main>@</span> <span class=bound>l2</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>l1</span> <span class=bound>l2</span><span class=main>.</span> <span class=free>l</span> <span class=main>=</span> <span class=bound>l1</span> <span class=main>@</span> <span class=main>[</span><span class=free>x</span><span class=main>]</span> <span class=main>@</span> <span class=bound>l2</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>l1</span></span> <span class=skolem><span class=skolem>l2</span></span> <span class=keyword2><span class=keyword>where</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>l</span> <span class=main>=</span> <span class=skolem>l1</span> <span class=main>@</span> <span class=main>[</span><span class=free>x</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>l2</span>"</span></span> 
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>from</span></span> assms
    <span class=keyword1><span class=command>have</span></span> 2<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>xs</span><span class=main>.</span> <span class=free>l</span> <span class=main>≠</span> <span class=free>x</span> <span class=main>#</span> <span class=bound>xs</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=main>∀</span><span class=bound>xs</span><span class=main>.</span> <span class=main>(</span><span class=main>∀</span><span class=bound>y</span><span class=main>.</span> <span class=free>l</span> <span class=main>≠</span> <span class=bound>y</span> <span class=main>#</span> <span class=bound>xs</span><span class=main>)</span> <span class=main>∨</span> <span class=main>¬</span> ListMem <span class=free>x</span> <span class=bound>xs</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> ListMem_iff
      <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted>False</span> 
    <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=skolem>l1</span></span><span class=main>)</span>
      <span class=keyword3><span class=command>case</span></span> Nil
      <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?xs</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=skolem>l2</span>"</span></span>
      <span class=keyword1><span class=command>from</span></span> 1 Nil <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>l</span> <span class=main>=</span> <span class=main>[</span><span class=free>x</span><span class=main>]</span> <span class=main>@</span> <span class=var>?xs</span>"</span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> 
        <span class=keyword1><span class=command>using</span></span> 2
        <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>next</span></span>
      <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>a</span> <span class=skolem>list</span><span class=main>)</span>
      <span class=keyword1><span class=command>{</span></span>
        <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?y</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=skolem>a</span>"</span></span>
        <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?xs</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=skolem>list</span> <span class=main>@</span> <span class=main>[</span><span class=free>x</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>l2</span>"</span></span>
        <span class=keyword1><span class=command>from</span></span> 1 Cons <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>l</span> <span class=main>=</span> <span class=var>?y</span> <span class=main>#</span> <span class=var>?xs</span>"</span></span>
          <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
        <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"ListMem <span class=free>x</span> <span class=var>?xs</span>"</span></span>
          <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> ListMem_iff<span class=main>)</span>
        <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>xs</span><span class=main>.</span> <span class=main>∃</span><span class=bound>y</span><span class=main>.</span> <span class=free>l</span> <span class=main>=</span> <span class=bound>y</span> <span class=main>#</span> <span class=bound>xs</span> <span class=main>∧</span> ListMem <span class=free>x</span> <span class=bound>xs</span>"</span></span>
          <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span><span class=main>(</span><span class=main>∀</span><span class=bound>xs</span><span class=main>.</span> <span class=main>(</span><span class=main>∀</span><span class=bound>y</span><span class=main>.</span> <span class=free>l</span> <span class=main>≠</span> <span class=bound>y</span> <span class=main>#</span> <span class=bound>xs</span><span class=main>)</span> <span class=main>∨</span> <span class=main>¬</span> ListMem <span class=free>x</span> <span class=bound>xs</span><span class=main>)</span>"</span></span>
          <span class=keyword1><span class=command>by</span></span> <span class=operator>presburger</span>
      <span class=keyword1><span class=command>}</span></span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> 
        <span class=keyword1><span class=command>using</span></span> 2
        <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=comment1>― ‹NOTE added lemma (listScript.sml:2784)›</span>
<span class=keyword1 id=ListUtils-APPEND_EQ_APPEND_MID><span class=command>lemma</span></span> APPEND_EQ_APPEND_MID<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>l1</span> <span class=free>l2</span> <span class=free>m1</span> <span class=free>m2</span> <span class=free>e</span>
  <span class=keyword2><span class=keyword>shows</span></span> 
    <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>l1</span> <span class=main>@</span> <span class=main>[</span><span class=free>e</span><span class=main>]</span> <span class=main>@</span> <span class=free>l2</span> <span class=main>=</span> <span class=free>m1</span> <span class=main>@</span> <span class=free>m2</span><span class=main>)</span> 
      <span class=main>⟷</span>
        <span class=main>(</span><span class=main>∃</span><span class=bound>l</span><span class=main>.</span> <span class=main>(</span><span class=free>m1</span> <span class=main>=</span> <span class=free>l1</span> <span class=main>@</span> <span class=main>[</span><span class=free>e</span><span class=main>]</span> <span class=main>@</span> <span class=bound>l</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=free>l2</span> <span class=main>=</span> <span class=bound>l</span> <span class=main>@</span> <span class=free>m2</span><span class=main>)</span><span class=main>)</span> <span class=main>∨</span>
        <span class=main>(</span><span class=main>∃</span><span class=bound>l</span><span class=main>.</span> <span class=main>(</span><span class=free>l1</span> <span class=main>=</span> <span class=free>m1</span> <span class=main>@</span> <span class=bound>l</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=free>m2</span> <span class=main>=</span> <span class=bound>l</span> <span class=main>@</span> <span class=main>[</span><span class=free>e</span><span class=main>]</span> <span class=main>@</span> <span class=free>l2</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=quoted>"<span class=free>l1</span>"</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>m1</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> Nil
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span><span class=main><span class=keyword3>;</span></span> <span class=operator>metis</span> Cons_eq_append_conv<span class=main>)</span><span class=main><span class=keyword3>+</span></span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>a</span> <span class=skolem>l1</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=skolem>m1</span></span><span class=main><span class=keyword3>;</span></span> <span class=operator>simp</span><span class=main><span class=keyword3>;</span></span> <span class=operator>blast</span><span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=comment1>― ‹NOTE variable `P` was removed (redundant).›</span>
<span class=keyword1 id=ListUtils-LIST_FRAG_DICHOTOMY><span class=command>lemma</span></span> LIST_FRAG_DICHOTOMY<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>l</span> <span class=free>la</span> <span class=free>x</span> <span class=free>lb</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"sublist <span class=free>l</span> <span class=main>(</span><span class=free>la</span> <span class=main>@</span> <span class=main>[</span><span class=free>x</span><span class=main>]</span> <span class=main>@</span> <span class=free>lb</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span>ListMem <span class=free>x</span> <span class=free>l</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"sublist <span class=free>l</span> <span class=free>la</span> <span class=main>∨</span> sublist <span class=free>l</span> <span class=free>lb</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword1><span class=command>from</span></span> assms<span class=main>(</span>1<span class=main>)</span> 
    <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>pfx</span></span> <span class=skolem><span class=skolem>sfx</span></span> <span class=keyword2><span class=keyword>where</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>pfx</span> <span class=main>@</span> <span class=free>l</span> <span class=main>@</span> <span class=skolem>sfx</span> <span class=main>=</span> <span class=free>la</span> <span class=main>@</span> <span class=main>[</span><span class=free>x</span><span class=main>]</span> <span class=main>@</span> <span class=free>lb</span>"</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> sublist_def 
      <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
    <span class=keyword1><span class=command>from</span></span> assms<span class=main>(</span>2<span class=main>)</span>
    <span class=keyword1><span class=command>have</span></span> 2<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>l1</span> <span class=bound>l2</span><span class=main>.</span> <span class=free>l</span> <span class=main>≠</span> <span class=bound>l1</span> <span class=main>@</span> <span class=main>[</span><span class=free>x</span><span class=main>]</span> <span class=main>@</span> <span class=bound>l2</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> MEM_SPLIT<span class=main>[</span><span class=operator>OF</span> assms<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span><span class=main>]</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>from</span></span> 1 
    <span class=keyword1><span class=command>consider</span></span> <span class=main>(</span>a<span class=main>)</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>lc</span><span class=main>.</span> <span class=skolem>pfx</span> <span class=main>=</span> <span class=free>la</span> <span class=main>@</span> <span class=main>[</span><span class=free>x</span><span class=main>]</span> <span class=main>@</span> <span class=bound>lc</span> <span class=main>∧</span> <span class=free>lb</span> <span class=main>=</span> <span class=bound>lc</span> <span class=main>@</span> <span class=free>l</span> <span class=main>@</span> <span class=skolem>sfx</span><span class=main>)</span>"</span></span> 
      <span class=main>|</span> <span class=main>(</span>b<span class=main>)</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>lc</span><span class=main>.</span> <span class=free>la</span> <span class=main>=</span> <span class=skolem>pfx</span> <span class=main>@</span> <span class=bound>lc</span> <span class=main>∧</span> <span class=free>l</span> <span class=main>@</span> <span class=skolem>sfx</span> <span class=main>=</span> <span class=bound>lc</span> <span class=main>@</span> <span class=main>[</span><span class=free>x</span><span class=main>]</span> <span class=main>@</span> <span class=free>lb</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> APPEND_EQ_APPEND_MID<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>la</span></span> <span class=quoted><span class=free>x</span></span> <span class=quoted><span class=free>lb</span></span> <span class=quoted><span class=skolem>pfx</span></span> <span class=quoted><span class=quoted>"<span class=free>l</span> <span class=main>@</span> <span class=skolem>sfx</span>"</span></span><span class=main>]</span> 
      <span class=keyword1><span class=command>by</span></span> <span class=operator>presburger</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>pfx'</span> <span class=bound>sfx</span><span class=main>.</span> <span class=main>(</span><span class=bound>pfx'</span> <span class=main>@</span> <span class=free>l</span> <span class=main>@</span> <span class=bound>sfx</span> <span class=main>=</span> <span class=free>la</span><span class=main>)</span> <span class=main>∨</span> <span class=main>(</span><span class=bound>pfx'</span><span class=main>@</span>  <span class=free>l</span> <span class=main>@</span> <span class=bound>sfx</span> <span class=main>=</span> <span class=free>lb</span><span class=main>)</span>"</span></span> 
    <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span><span class=main>)</span>
      <span class=keyword3><span class=command>case</span></span> a
        <span class=comment1>― ‹NOTE `lc` is `l'` in original proof.›</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>lc</span></span> <span class=keyword2><span class=keyword>where</span></span> a<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>pfx</span> <span class=main>=</span> <span class=free>la</span> <span class=main>@</span> <span class=main>[</span><span class=free>x</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>lc</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>lb</span> <span class=main>=</span> <span class=skolem>lc</span> <span class=main>@</span> <span class=free>l</span> <span class=main>@</span> <span class=skolem>sfx</span>"</span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>next</span></span>
      <span class=keyword3><span class=command>case</span></span> b
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>lc</span></span> <span class=keyword2><span class=keyword>where</span></span> i<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>la</span> <span class=main>=</span> <span class=skolem>pfx</span> <span class=main>@</span> <span class=skolem>lc</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>l</span> <span class=main>@</span> <span class=skolem>sfx</span> <span class=main>=</span> <span class=skolem>lc</span> <span class=main>@</span> <span class=main>[</span><span class=free>x</span><span class=main>]</span> <span class=main>@</span> <span class=free>lb</span>"</span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
        <span class=keyword1><span class=command>using</span></span> 2
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> APPEND_EQ_APPEND_MID<span class=main>)</span> 
    <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> 
    <span class=keyword1><span class=command>unfolding</span></span> sublist_def
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1 id=ListUtils-LIST_FRAG_DICHOTOMY_2><span class=command>lemma</span></span> LIST_FRAG_DICHOTOMY_2<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>l</span> <span class=free>la</span> <span class=free>x</span> <span class=free>lb</span> <span class=free>P</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"sublist <span class=free>l</span> <span class=main>(</span><span class=free>la</span> <span class=main>@</span> <span class=main>[</span><span class=free>x</span><span class=main>]</span> <span class=main>@</span> <span class=free>lb</span><span class=main>)</span> "</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span><span class=free>P</span> <span class=free>x</span>"</span></span> <span class=quoted><span class=quoted>"list_all <span class=free>P</span> <span class=free>l</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"sublist <span class=free>l</span> <span class=free>la</span> <span class=main>∨</span> sublist <span class=free>l</span> <span class=free>lb</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span><span class=free>P</span> <span class=free>x</span>"</span></span> <span class=quoted><span class=quoted>"list_all <span class=free>P</span> <span class=free>l</span>"</span></span> 
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span>ListMem <span class=free>x</span> <span class=free>l</span>"</span></span> 
    <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>l</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>x</span></span> <span class=quoted><span class=free>P</span></span><span class=main>)</span> 
      <span class=keyword3><span class=command>case</span></span> Nil
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> 
        <span class=keyword1><span class=command>using</span></span> ListMem_iff
        <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
    <span class=keyword1><span class=command>next</span></span>
      <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>a</span> <span class=skolem>l</span><span class=main>)</span>
      <span class=keyword1><span class=command>{</span></span>
        <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"list_all <span class=skolem>P</span> <span class=skolem>l</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>2<span class=main>)</span> 
          <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span>ListMem <span class=skolem>x</span> <span class=skolem>l</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>1<span class=main>)</span> Cons.IH
          <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>}</span></span>
      <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>{</span></span>
        <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>P</span> <span class=skolem>a</span>"</span></span> 
          <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>2<span class=main>)</span>
          <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
        <span class=keyword1><span class=command>then</span></span>  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a</span> <span class=main>≠</span> <span class=skolem>x</span>"</span></span> 
          <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>1<span class=main>)</span>
          <span class=keyword1><span class=command>by</span></span> <span class=operator>meson</span>
      <span class=keyword1><span class=command>}</span></span>
      <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
        <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>1<span class=main>,</span> 2<span class=main>)</span> ListMem_iff list.pred_set
        <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
    <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span>ListMem <span class=free>x</span> <span class=free>l</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>2<span class=main>,</span> 3<span class=main>)</span> 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> 
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>)</span> LIST_FRAG_DICHOTOMY
    <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=ListUtils-frag_len_filter_le><span class=command>lemma</span></span> frag_len_filter_le<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>P</span> <span class=free>l'</span> <span class=free>l</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"sublist <span class=free>l'</span> <span class=free>l</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"length <span class=main>(</span>filter <span class=free>P</span> <span class=free>l'</span><span class=main>)</span> <span class=main>≤</span> length <span class=main>(</span>filter <span class=free>P</span> <span class=free>l</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>ps</span></span> <span class=skolem><span class=skolem>ss</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=free>l</span> <span class=main>=</span> <span class=skolem>ps</span> <span class=main>@</span> <span class=free>l'</span> <span class=main>@</span> <span class=skolem>ss</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms sublist_def 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span>
    <span class=quoted><span class=quoted>"length <span class=main>(</span>filter <span class=free>P</span> <span class=free>l</span><span class=main>)</span> <span class=main>=</span> length <span class=main>(</span>filter <span class=free>P</span> <span class=skolem>ps</span><span class=main>)</span> <span class=main>+</span> length <span class=main>(</span>filter <span class=free>P</span> <span class=free>l'</span><span class=main>)</span> <span class=main>+</span> length <span class=main>(</span>filter <span class=free>P</span> <span class=skolem>ss</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span> 
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"length <span class=main>(</span>filter <span class=free>P</span> <span class=skolem>ps</span><span class=main>)</span> <span class=main>≥</span> <span class=main>0</span>"</span></span> <span class=quoted><span class=quoted>"length <span class=main>(</span>filter <span class=free>P</span> <span class=skolem>ss</span><span class=main>)</span> <span class=main>≥</span> <span class=main>0</span>"</span></span> 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span><span class=main><span class=keyword3>+</span></span> 
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>using</span></span> 1
    <span class=keyword1><span class=command>by</span></span> <span class=operator>linarith</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword2><span class=keyword>end</span></span></pre>
</div><div id=FSSublist>
<div class=head>
<h1>Theory FSSublist</h1>
</div>
<pre class=source><span class=comment1>(*
 * cf. planning/hol/sublistScript
 *)</span>
<span class=keyword1><span class=command>theory</span></span> FSSublist
  <span class=keyword2><span class=keyword>imports</span></span> <a href=https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html>Main</a> <span class=quoted>"<a href=https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Sublist.html>HOL-Library.Sublist</a>"</span> <a href=#ListUtils>ListUtils</a>
<span class=keyword2><span class=keyword>begin</span></span>

<span class=keyword1><span class=command>text</span></span> <span class=quoted><span class=plain_text>‹ This file is a port of the original HOL4 source file sublistScript.sml. ›</span></span>

<span class=keyword1><span class=command>section</span></span> <span class=quoted><span class=plain_text>"Factored System Sublist"</span></span>
<span class=keyword1><span class=command>subsection</span></span> <span class=quoted><span class=plain_text>"Sublist Characterization"</span></span>

<span class=keyword1><span class=command>text</span></span> <span class=quoted><span class=plain_text>‹ We take a look at the characterization of sublists. As a precursor, we are replacing the 
original definition of `sublist` in HOL4 (sublistScript.sml:10) with the semantically equivalent
`subseq` of Isabelle/HOL's to be able to use the associated theorems and automation. 

In HOL4 `sublist` is defined as
  
  (sublist [] l1 = T) /\
  (sublist (h::t) [] = F) /\
  (sublist (x::l1) (y::l2) = (x = y) /\ sublist l1 l2 \/ sublist (x::l1) l2)

[Abdulaziz et al., HOL4 Definition 10, p.19]. Whereas `subseq` (Sublist.tyh:927) is defined as an 
abbrevation of `list\_emb` with the predicate <span class=antiquoted><span class=antiquoted><span class=antiquote><span class=antiquote>@{</span></span><span class=operator><span class=operator>term</span></span> <span class=quoted><span class=quoted>"<span class=main><span class=main>λ</span></span> <span class=bound><span class=bound>x</span></span> <span class=bound><span class=bound>y</span></span><span class=main><span class=main>.</span></span> <span class=bound><span class=bound>x</span></span> <span class=main><span class=main>=</span></span> <span class=bound><span class=bound>y</span></span>"</span></span><span class=antiquote><span class=antiquote>}</span></span></span></span>, i.e. 

    <span class=antiquoted><span class=antiquoted><span class=antiquote><span class=antiquote>@{</span></span><span class=operator><span class=operator>term</span></span> <span class=quoted><span class=quoted>"subseq <span class=free><span class=free>xs</span></span> <span class=free><span class=free>ys</span></span> <span class=main><span class=main>≡</span></span> list_emb <span class=main><span class=main>(=)</span></span> <span class=free><span class=free>xs</span></span> <span class=free><span class=free>ys</span></span>"</span></span><span class=antiquote><span class=antiquote>}</span></span></span></span>

`list\_emb` itself is defined as an inductive predicate. However, an equivalent function definition
is provided in `list\_emb\_code` (Sublist.thy:784) which is very close to `sublist` in HOL4.

The correctness of the equivalence claim is shown below by the technical lemma 
`sublist\_HOL4\_equiv\_subseq` (where the HOL4 definition of `sublist` is renamed to `sublist\_HOL4`).
›</span></span>

<span class=comment1>― ‹NOTE added definition›</span>
<span class=keyword1><span class=command>fun</span></span> <span class=entity>sublist_HOL4</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>sublist_HOL4</span> <span class=main>[]</span> <span class=free><span class=bound><span class=entity>l1</span></span></span> <span class=main>=</span> True"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>sublist_HOL4</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>h</span></span></span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>t</span></span></span><span class=main>)</span> <span class=main>[]</span> <span class=main>=</span> False<span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>sublist_HOL4</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>l1</span></span></span><span class=main>)</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>y</span></span></span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>l2</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>=</span> <span class=free><span class=bound><span class=entity>y</span></span></span><span class=main>)</span> <span class=main>∧</span> <span class=free>sublist_HOL4</span> <span class=free><span class=bound><span class=entity>l1</span></span></span> <span class=free><span class=bound><span class=entity>l2</span></span></span> <span class=main>∨</span> <span class=free>sublist_HOL4</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>l1</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>l2</span></span></span><span class=main>)</span><span class=main>)</span>"</span></span>


<span class=comment1>― ‹NOTE added lemma›</span>
<span class=keyword1 id=FSSublist-sublist_HOL4_equiv_subseq><span class=command>lemma</span></span> sublist_HOL4_equiv_subseq<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>l1</span> <span class=free>l2</span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"sublist_HOL4 <span class=free>l1</span> <span class=free>l2</span> <span class=main>⟷</span> subseq <span class=free>l1</span> <span class=free>l2</span>"</span></span> 
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span> 
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"subseq <span class=free>l1</span> <span class=free>l2</span> <span class=main>=</span> list_emb <span class=main>(</span><span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=bound>x</span> <span class=main>=</span> <span class=bound>y</span><span class=main>)</span> <span class=free>l1</span> <span class=free>l2</span>"</span></span> 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>{</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"sublist_HOL4 <span class=free>l1</span> <span class=free>l2</span> <span class=main>⟷</span> list_emb <span class=main>(</span><span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=bound>x</span> <span class=main>=</span> <span class=bound>y</span><span class=main>)</span> <span class=free>l1</span> <span class=free>l2</span>"</span></span> 
    <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> sublist_HOL4.induct<span class=main>)</span>
      <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>3 <span class=skolem>x</span> <span class=skolem>l1</span> <span class=skolem>y</span> <span class=skolem>l2</span><span class=main>)</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"sublist_HOL4 <span class=main>(</span><span class=skolem>x</span> <span class=main>#</span> <span class=skolem>l1</span><span class=main>)</span> <span class=main>(</span><span class=skolem>y</span> <span class=main>#</span> <span class=skolem>l2</span><span class=main>)</span> <span class=main>⟷</span> list_emb <span class=main>(</span><span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=bound>x</span> <span class=main>=</span> <span class=bound>y</span><span class=main>)</span> <span class=main>(</span><span class=skolem>x</span> <span class=main>#</span> <span class=skolem>l1</span><span class=main>)</span> <span class=main>(</span><span class=skolem>y</span> <span class=main>#</span> <span class=skolem>l2</span><span class=main>)</span>"</span></span> 
      <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>=</span> <span class=skolem>y</span>"</span></span><span class=main>)</span>
        <span class=keyword3><span class=command>case</span></span> True
        <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
          <span class=keyword1><span class=command>using</span></span> <span class=quoted>"3.IH"</span><span class=main>(</span>1<span class=main>,</span> 2<span class=main>)</span>
          <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> sublist_HOL4.simps<span class=main><span class=main>(</span></span>3<span class=main><span class=main>)</span></span> subseq_Cons' subseq_Cons2_iff<span class=main>)</span>
      <span class=keyword1><span class=command>next</span></span>
        <span class=keyword3><span class=command>case</span></span> False
        <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
          <span class=keyword1><span class=command>using</span></span> <span class=quoted>"3.IH"</span><span class=main>(</span>2<span class=main>)</span>
          <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
      <span class=keyword1><span class=command>qed</span></span> 
    <span class=keyword1><span class=command>qed</span></span> <span class=operator>simp</span><span class=main><span class=keyword3>+</span></span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1><span class=command>text</span></span> <span class=quoted><span class=plain_text>‹ Likewise as with `sublist` and `subseq`, the HOL4 definition of `list\_frag` 
(list\_utilsScript.sml:207) has a an Isabelle/HOL counterpart in `sublist` (Sublist.thy:1124).

The equivalence claim is proven in the technical lemma `list\_frag\_HOL4\_equiv\_sublist`. Note that
`sublist` reverses the argument order of `list\_frag`. Other than that, both definitions are
syntactically identical. ›</span></span>
<span class=keyword1><span class=command>definition</span></span> <span class=entity>list_frag_HOL4</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>list_frag_HOL4</span> <span class=free><span class=bound><span class=entity>l</span></span></span> <span class=free><span class=bound><span class=entity>frag</span></span></span> <span class=main>≡</span> <span class=main>∃</span><span class=bound>pfx</span> <span class=bound>sfx</span><span class=main>.</span> <span class=bound>pfx</span> <span class=main>@</span> <span class=free><span class=bound><span class=entity>frag</span></span></span> <span class=main>@</span> <span class=bound>sfx</span> <span class=main>=</span> <span class=free><span class=bound><span class=entity>l</span></span></span>"</span></span>

<span class=keyword1 id=FSSublist-list_frag_HOL4_equiv_sublist><span class=command>lemma</span></span> list_frag_HOL4_equiv_sublist<span class=main>:</span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"list_frag_HOL4 <span class=free>l</span> <span class=free>l'</span> <span class=main>⟷</span> sublist <span class=free>l'</span> <span class=free>l</span>"</span></span> 
  <span class=keyword1><span class=command>unfolding</span></span> list_frag_HOL4_def sublist_def 
  <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>


<span class=keyword1><span class=command>text</span></span> <span class=quoted><span class=plain_text>‹ Given these equivalences, occurences of `sublist` and `list\_frag` in the original HOL4 
source are now always translated directly to `subseq` and `sublist` respectively.

The remainer of this subsection is concerned with characterizations of `sublist`/ `subseq`. ›</span></span>


<span class=keyword1 id=FSSublist-sublist_EQNS><span class=command>lemma</span></span> sublist_EQNS<span class=main>:</span> 
  <span class=quoted><span class=quoted>"subseq <span class=main>[]</span> <span class=free>l</span> <span class=main>=</span> True"</span></span> 
  <span class=quoted><span class=quoted>"subseq <span class=main>(</span><span class=free>h</span> <span class=main>#</span> <span class=free>t</span><span class=main>)</span> <span class=main>[]</span> <span class=main>=</span> False"</span></span> 
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>


<span class=keyword1 id=FSSublist-sublist_refl><span class=command>lemma</span></span> sublist_refl<span class=main>:</span> <span class=quoted><span class=quoted>"subseq <span class=free>l</span> <span class=free>l</span>"</span></span> 
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>


<span class=keyword1 id=FSSublist-sublist_cons><span class=command>lemma</span></span> sublist_cons<span class=main>:</span> 
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"subseq <span class=free>l1</span> <span class=free>l2</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"subseq <span class=free>l1</span> <span class=main>(</span><span class=free>h</span> <span class=main>#</span> <span class=free>l2</span><span class=main>)</span>"</span></span> 
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>


<span class=keyword1 id=FSSublist-sublist_NIL><span class=command>lemma</span></span> sublist_NIL<span class=main>:</span> <span class=quoted><span class=quoted>"subseq <span class=free>l1</span> <span class=main>[]</span> <span class=main>=</span> <span class=main>(</span><span class=free>l1</span> <span class=main>=</span> <span class=main>[]</span><span class=main>)</span>"</span></span> 
  <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>


<span class=keyword1 id=FSSublist-sublist_trans><span class=command>lemma</span></span> sublist_trans<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>l1</span> <span class=free>l2</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"subseq <span class=free>l1</span> <span class=free>l2</span>"</span></span> <span class=quoted><span class=quoted>"subseq <span class=free>l2</span> <span class=free>l3</span>"</span></span> 
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"subseq <span class=free>l1</span> <span class=free>l3</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms 
  <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span> 


<span class=comment1>― ‹NOTE can be solved directly with 'list\_emb\_length'.›</span>  
<span class=keyword1 id=FSSublist-sublist_length><span class=command>lemma</span></span> sublist_length<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>l</span> <span class=free>l'</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"subseq <span class=free>l</span> <span class=free>l'</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"length <span class=free>l</span> <span class=main>≤</span> length <span class=free>l'</span>"</span></span> 
  <span class=keyword1><span class=command>using</span></span> assms list_emb_length
  <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span> 


<span class=comment1>― ‹NOTE can be solved directly with subseq\_Cons'.›</span>
<span class=keyword1 id=FSSublist-sublist_CONS1_E><span class=command>lemma</span></span> sublist_CONS1_E<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>l1</span> <span class=free>l2</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"subseq <span class=main>(</span><span class=free>h</span> <span class=main>#</span> <span class=free>l1</span><span class=main>)</span> <span class=free>l2</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"subseq <span class=free>l1</span> <span class=free>l2</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms subseq_Cons'
  <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>


<span class=keyword1 id=FSSublist-sublist_equal_lengths><span class=command>lemma</span></span> sublist_equal_lengths<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>l1</span> <span class=free>l2</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"subseq <span class=free>l1</span> <span class=free>l2</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>length <span class=free>l1</span> <span class=main>=</span> length <span class=free>l2</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>l1</span> <span class=main>=</span> <span class=free>l2</span><span class=main>)</span>"</span></span> 
  <span class=keyword1><span class=command>using</span></span> assms subseq_same_length
  <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>


<span class=comment1>― ‹NOTE can be solved directly with 'subseq\_order.antisym'.›</span>
<span class=keyword1 id=FSSublist-sublist_antisym><span class=command>lemma</span></span> sublist_antisym<span class=main>:</span> 
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"subseq <span class=free>l1</span> <span class=free>l2</span>"</span></span> <span class=quoted><span class=quoted>"subseq <span class=free>l2</span> <span class=free>l1</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>l1</span> <span class=main>=</span> <span class=free>l2</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms subseq_order.antisym
  <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>


<span class=keyword1 id=FSSublist-sublist_append_back><span class=command>lemma</span></span> sublist_append_back<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>l1</span> <span class=free>l2</span> 
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"subseq <span class=free>l1</span> <span class=main>(</span><span class=free>l2</span> <span class=main>@</span> <span class=free>l1</span><span class=main>)</span>"</span></span> 
  <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>


<span class=comment1>― ‹NOTE can be solved directly with 'subseq\_rev\_drop\_many'.›</span>
<span class=keyword1 id=FSSublist-sublist_snoc><span class=command>lemma</span></span> sublist_snoc<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>l1</span> <span class=free>l2</span> 
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"subseq <span class=free>l1</span> <span class=free>l2</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"subseq <span class=free>l1</span> <span class=main>(</span><span class=free>l2</span> <span class=main>@</span> <span class=main>[</span><span class=free>h</span><span class=main>]</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms subseq_rev_drop_many 
  <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>


<span class=keyword1 id=FSSublist-sublist_append_front><span class=command>lemma</span></span> sublist_append_front<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>l1</span> <span class=free>l2</span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"subseq <span class=free>l1</span> <span class=main>(</span><span class=free>l1</span> <span class=main>@</span> <span class=free>l2</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>


<span class=keyword1 id=FSSublist-append_sublist_1><span class=command>lemma</span></span> append_sublist_1<span class=main>:</span> 
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"subseq <span class=main>(</span><span class=free>l1</span> <span class=main>@</span> <span class=free>l2</span><span class=main>)</span> <span class=free>l</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"subseq <span class=free>l1</span> <span class=free>l</span> <span class=main>∧</span> subseq <span class=free>l2</span> <span class=free>l</span>"</span></span> 
  <span class=keyword1><span class=command>using</span></span> assms sublist_append_back sublist_append_front sublist_trans 
  <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span> 


<span class=comment1>― ‹NOTE added lemma (eventually wasn't needed in the remaining proofs).›</span>
<span class=keyword1 id=FSSublist-sublist_prefix><span class=command>lemma</span></span> sublist_prefix<span class=main>:</span>  
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"subseq <span class=main>(</span><span class=free>h</span> <span class=main>#</span> <span class=free>l1</span><span class=main>)</span> <span class=free>l2</span> <span class=main>⟹</span> <span class=main>∃</span><span class=bound>l2a</span> <span class=bound>l2b</span><span class=main>.</span> <span class=free>l2</span> <span class=main>=</span> <span class=bound>l2a</span> <span class=main>@</span> <span class=main>[</span><span class=free>h</span><span class=main>]</span> <span class=main>@</span> <span class=bound>l2b</span> <span class=main>∧</span> <span class=main>¬</span>ListMem <span class=free>h</span> <span class=bound>l2a</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>l2</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>h</span></span> <span class=quoted><span class=free>l1</span></span><span class=main>)</span>
  <span class=comment1>― ‹NOTE l2 cannot be empty when <span class=antiquoted><span class=antiquote>@{</span><span class=operator>term</span> <span class=quoted>"<span class=main>(</span><span class=free>h</span> <span class=main>#</span> <span class=free>l1</span><span class=main>)</span>"</span><span class=antiquote>}</span></span> isn't.›</span>
  <span class=keyword3><span class=command>case</span></span> Nil
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span><span class=main>(</span>subseq <span class=main>(</span><span class=skolem>h</span> <span class=main>#</span> <span class=skolem>l1</span><span class=main>)</span> <span class=main>[]</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span> 
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> 
    <span class=keyword1><span class=command>using</span></span> Nil.prems
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>a</span> <span class=skolem>l2</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=skolem>a</span> <span class=main>=</span> <span class=skolem>h</span>"</span></span><span class=main>)</span>
    <span class=comment1>― ‹NOTE If a = h then a trivial solution exists in l2a = [] and l2b = l2.›</span>
    <span class=keyword3><span class=command>case</span></span> True
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span> <span class=bound>l2a</span> <span class=bound>l2b</span><span class=main>.</span> <span class=main>(</span>Cons <span class=skolem>a</span> <span class=skolem>l2</span><span class=main>)</span> <span class=main>=</span> <span class=bound>l2a</span> <span class=main>@</span> <span class=main>[</span><span class=skolem>h</span><span class=main>]</span> <span class=main>@</span> <span class=bound>l2b</span> <span class=main>∧</span> <span class=main>¬</span>ListMem <span class=skolem>h</span> <span class=bound>l2a</span>"</span></span> 
      <span class=keyword1><span class=command>using</span></span> ListMem_iff 
      <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
  <span class=keyword1><span class=command>next</span></span> 
    <span class=keyword3><span class=command>case</span></span> False
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"subseq <span class=main>(</span><span class=skolem>h</span> <span class=main>#</span> <span class=skolem>l1</span><span class=main>)</span> <span class=skolem>l2</span>"</span></span> 
      <span class=keyword1><span class=command>using</span></span> Cons.prems False subseq_Cons2_neq
      <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>l2a</span></span> <span class=skolem><span class=skolem>l2b</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>l2</span> <span class=main>=</span> <span class=skolem>l2a</span> <span class=main>@</span> <span class=main>[</span><span class=skolem>h</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>l2b</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span>ListMem <span class=skolem>h</span> <span class=skolem>l2a</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> Cons.IH Cons.prems
      <span class=keyword1><span class=command>by</span></span> <span class=operator>meson</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a</span> <span class=main>#</span> <span class=skolem>l2</span> <span class=main>=</span> <span class=main>(</span><span class=skolem>a</span> <span class=main>#</span> <span class=skolem>l2a</span><span class=main>)</span> <span class=main>@</span> <span class=main>[</span><span class=skolem>h</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>l2b</span>"</span></span> 
      <span class=keyword1><span class=command>using</span></span> calculation<span class=main>(</span>1<span class=main>)</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span><span class=main>(</span>ListMem <span class=skolem>h</span> <span class=main>(</span><span class=skolem>a</span> <span class=main>#</span> <span class=skolem>l2a</span><span class=main>)</span><span class=main>)</span>"</span></span> 
      <span class=keyword1><span class=command>using</span></span> False calculation<span class=main>(</span>2<span class=main>)</span> ListMem.simps
      <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
    <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> 
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>qed</span></span>

<span class=comment1>― ‹NOTE added lemma (eventually wasn't needed in the remaining proofs).›</span>
<span class=keyword1 id=FSSublist-sublist_skip><span class=command>lemma</span></span> sublist_skip<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>l1</span> <span class=free>l2</span> <span class=free>h</span> <span class=free>l1'</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>l1</span> <span class=main>=</span> <span class=main>(</span><span class=free>h</span> <span class=main>#</span> <span class=free>l1'</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>l2</span> <span class=main>=</span> <span class=free>l2a</span> <span class=main>@</span> <span class=main>[</span><span class=free>h</span><span class=main>]</span> <span class=main>@</span> <span class=free>l2b</span>"</span></span> <span class=quoted><span class=quoted>"subseq <span class=free>l1</span> <span class=free>l2</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span><span class=main>(</span>ListMem <span class=free>h</span> <span class=free>l2a</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"subseq <span class=free>l1</span> <span class=main>(</span><span class=free>h</span> <span class=main>#</span> <span class=free>l2b</span><span class=main>)</span>"</span></span> 
  <span class=keyword1><span class=command>using</span></span> assms
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>l2a</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>l1</span></span> <span class=quoted><span class=free>l2</span></span> <span class=quoted><span class=free>h</span></span> <span class=quoted><span class=free>l1'</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> Nil
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>l2</span> <span class=main>=</span> <span class=skolem>h</span> <span class=main>#</span> <span class=free>l2b</span>"</span></span> 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>using</span></span> Nil.prems<span class=main>(</span>3<span class=main>)</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>a</span> <span class=skolem>l2a</span><span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a</span> <span class=main>≠</span> <span class=skolem>h</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>4<span class=main>)</span> ListMem.simps 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"subseq <span class=skolem>l1</span> <span class=main>(</span><span class=skolem>l2a</span> <span class=main>@</span> <span class=main>[</span><span class=skolem>h</span><span class=main>]</span> <span class=main>@</span> <span class=free>l2b</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>1<span class=main>,</span> 2<span class=main>,</span> 3<span class=main>)</span> subseq_Cons2_neq
    <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span>ListMem <span class=skolem>h</span> <span class=skolem>l2a</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>4<span class=main>)</span> insert
    <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"subseq <span class=skolem>l1</span> <span class=main>(</span><span class=skolem>h</span> <span class=main>#</span> <span class=free>l2b</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Cons.IH Cons.prems
    <span class=keyword1><span class=command>by</span></span> <span class=operator>meson</span> 
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=comment1>― ‹NOTE added lemma (eventually wasn't needed in the remaining proofs).›</span>
<span class=keyword1 id=FSSublist-sublist_split_trans><span class=command>lemma</span></span> sublist_split_trans<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>l1</span> <span class=free>l2</span> <span class=free>h</span> <span class=free>l1'</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>l1</span> <span class=main>=</span> <span class=main>(</span><span class=free>h</span> <span class=main>#</span> <span class=free>l1'</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>l2</span> <span class=main>=</span> <span class=free>l2a</span> <span class=main>@</span> <span class=main>[</span><span class=free>h</span><span class=main>]</span> <span class=main>@</span> <span class=free>l2b</span>"</span></span> <span class=quoted><span class=quoted>"subseq <span class=free>l1</span> <span class=free>l2</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span><span class=main>(</span>ListMem <span class=free>h</span> <span class=free>l2a</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"subseq <span class=free>l1'</span> <span class=free>l2b</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"subseq <span class=main>(</span><span class=free>h</span> <span class=main>#</span> <span class=free>l1'</span><span class=main>)</span> <span class=main>(</span><span class=free>h</span> <span class=main>#</span> <span class=free>l2b</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms sublist_skip 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>using</span></span> subseq_Cons2'
    <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=FSSublist-sublist_cons_exists><span class=command>lemma</span></span> sublist_cons_exists<span class=main>:</span> 
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"
    subseq <span class=main>(</span><span class=free>h</span> <span class=main>#</span> <span class=free>l1</span><span class=main>)</span> <span class=free>l2</span> 
    <span class=main>⟷</span> <span class=main>(</span><span class=main>∃</span><span class=bound>l2a</span> <span class=bound>l2b</span><span class=main>.</span> <span class=main>(</span><span class=free>l2</span> <span class=main>=</span> <span class=bound>l2a</span> <span class=main>@</span> <span class=main>[</span><span class=free>h</span><span class=main>]</span> <span class=main>@</span> <span class=bound>l2b</span><span class=main>)</span> <span class=main>∧</span> <span class=main>¬</span>ListMem <span class=free>h</span> <span class=bound>l2a</span> <span class=main>∧</span> subseq <span class=free>l1</span> <span class=bound>l2b</span><span class=main>)</span>
  "</span></span> 
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=comment1>― ‹NOTE show both directions of the equivalence in pure proof blocks.›</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword1><span class=command>have</span></span> 
      <span class=quoted><span class=quoted>"subseq <span class=main>(</span><span class=free>h</span> <span class=main>#</span> <span class=free>l1</span><span class=main>)</span> <span class=free>l2</span> <span class=main>⟹</span> <span class=main>(</span><span class=main>∃</span><span class=bound>l2a</span> <span class=bound>l2b</span><span class=main>.</span> <span class=main>(</span><span class=free>l2</span> <span class=main>=</span> <span class=bound>l2a</span> <span class=main>@</span> <span class=main>[</span><span class=free>h</span><span class=main>]</span> <span class=main>@</span> <span class=bound>l2b</span><span class=main>)</span> <span class=main>∧</span> <span class=main>¬</span>ListMem <span class=free>h</span> <span class=bound>l2a</span> <span class=main>∧</span> subseq <span class=free>l1</span> <span class=bound>l2b</span><span class=main>)</span>"</span></span> 
    <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>l2</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>h</span></span> <span class=quoted><span class=free>l1</span></span><span class=main>)</span>
      <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>a</span> <span class=skolem>l2</span><span class=main>)</span>
      <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> 
      <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=skolem>a</span> <span class=main>=</span> <span class=skolem>h</span>"</span></span><span class=main>)</span>
        <span class=keyword3><span class=command>case</span></span> True
          <span class=comment1>― ‹NOTE This case has a trivial solution in '?l2a = []', '?l2b = l2'.›</span>
        <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?l2a</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>[]</span>"</span></span>
        <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>a</span> <span class=main>#</span> <span class=skolem>l2</span><span class=main>)</span> <span class=main>=</span> <span class=var>?l2a</span> <span class=main>@</span> <span class=main>[</span><span class=skolem>h</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>l2</span>"</span></span> 
          <span class=keyword1><span class=command>using</span></span> True
          <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
        <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span><span class=main>(</span>ListMem <span class=skolem>h</span> <span class=var>?l2a</span><span class=main>)</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> ListMem_iff
          <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
        <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"subseq <span class=skolem>l1</span> <span class=skolem>l2</span>"</span></span> 
          <span class=keyword1><span class=command>using</span></span> Cons.prems True 
          <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
        <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
          <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>next</span></span>
        <span class=keyword3><span class=command>case</span></span> False
        <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"subseq <span class=main>(</span><span class=skolem>h</span> <span class=main>#</span> <span class=skolem>l1</span><span class=main>)</span> <span class=skolem>l2</span>"</span></span> 
          <span class=keyword1><span class=command>using</span></span> Cons.prems False subseq_Cons2_neq
          <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>l2a</span></span> <span class=skolem><span class=skolem>l2b</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>l2</span> <span class=main>=</span> <span class=skolem>l2a</span> <span class=main>@</span> <span class=main>[</span><span class=skolem>h</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>l2b</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span>ListMem <span class=skolem>h</span> <span class=skolem>l2a</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> Cons.IH Cons.prems
          <span class=keyword1><span class=command>by</span></span> <span class=operator>meson</span>
        <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a</span> <span class=main>#</span> <span class=skolem>l2</span> <span class=main>=</span> <span class=main>(</span><span class=skolem>a</span> <span class=main>#</span> <span class=skolem>l2a</span><span class=main>)</span> <span class=main>@</span> <span class=main>[</span><span class=skolem>h</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>l2b</span>"</span></span> 
          <span class=keyword1><span class=command>using</span></span> calculation<span class=main>(</span>1<span class=main>)</span>
          <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
        <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span><span class=main>(</span>ListMem <span class=skolem>h</span> <span class=main>(</span><span class=skolem>a</span> <span class=main>#</span> <span class=skolem>l2a</span><span class=main>)</span><span class=main>)</span>"</span></span> 
          <span class=keyword1><span class=command>using</span></span> False calculation<span class=main>(</span>2<span class=main>)</span> ListMem.simps
          <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
        <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> 
          <span class=keyword1><span class=command>using</span></span> 1 sublist_split_trans
          <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
      <span class=keyword1><span class=command>qed</span></span>
    <span class=keyword1><span class=command>qed</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>l2a</span> <span class=bound>l2b</span><span class=main>.</span> <span class=main>(</span><span class=free>l2</span> <span class=main>=</span> <span class=bound>l2a</span> <span class=main>@</span> <span class=main>[</span><span class=free>h</span><span class=main>]</span> <span class=main>@</span> <span class=bound>l2b</span><span class=main>)</span> <span class=main>∧</span> <span class=main>¬</span>ListMem <span class=free>h</span> <span class=bound>l2a</span> <span class=main>∧</span> subseq <span class=free>l1</span> <span class=bound>l2b</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span>  <span class=quoted><span class=quoted>"subseq <span class=main>(</span><span class=free>h</span> <span class=main>#</span> <span class=free>l1</span><span class=main>)</span> <span class=free>l2</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>argo</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1 id=FSSublist-sublist_append_exists><span class=command>lemma</span></span> sublist_append_exists<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>l1</span> <span class=free>l2</span> 
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"subseq <span class=main>(</span><span class=free>l1</span> <span class=main>@</span> <span class=free>l2</span><span class=main>)</span> <span class=free>l3</span> <span class=main>⟹</span> <span class=main>∃</span><span class=bound>l3a</span> <span class=bound>l3b</span><span class=main>.</span> <span class=main>(</span><span class=free>l3</span> <span class=main>=</span> <span class=bound>l3a</span> <span class=main>@</span> <span class=bound>l3b</span><span class=main>)</span> <span class=main>∧</span> subseq <span class=free>l1</span> <span class=bound>l3a</span> <span class=main>∧</span> subseq <span class=free>l2</span> <span class=bound>l3b</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> list_emb_appendD 
  <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>


<span class=comment1>― ‹NOTE can be solved directly with 'list\_emb\_append\_mono'.›</span>
<span class=keyword1 id=FSSublist-sublist_append_both_I><span class=command>lemma</span></span> sublist_append_both_I<span class=main>:</span> 
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"subseq <span class=free>a</span> <span class=free>b</span>"</span></span> <span class=quoted><span class=quoted>"subseq <span class=free>c</span> <span class=free>d</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"subseq <span class=main>(</span><span class=free>a</span> <span class=main>@</span> <span class=free>c</span><span class=main>)</span> <span class=main>(</span><span class=free>b</span> <span class=main>@</span> <span class=free>d</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms list_emb_append_mono
  <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>


<span class=keyword1 id=FSSublist-sublist_append><span class=command>lemma</span></span> sublist_append<span class=main>:</span> 
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"subseq <span class=free>l1</span> <span class=free>l1'</span>"</span></span> <span class=quoted><span class=quoted>"subseq <span class=free>l2</span> <span class=free>l2'</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"subseq <span class=main>(</span><span class=free>l1</span> <span class=main>@</span> <span class=free>l2</span><span class=main>)</span> <span class=main>(</span><span class=free>l1'</span> <span class=main>@</span> <span class=free>l2'</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms sublist_append_both_I
  <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>


<span class=keyword1 id=FSSublist-sublist_append2><span class=command>lemma</span></span> sublist_append2<span class=main>:</span> 
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"subseq <span class=free>l1</span> <span class=free>l2</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"subseq <span class=free>l1</span> <span class=main>(</span><span class=free>l2</span> <span class=main>@</span> <span class=free>l3</span><span class=main>)</span>"</span></span> 
  <span class=keyword1><span class=command>using</span></span> assms sublist_append<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=free>l1</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>l2</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>[]</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>l3</span>"</span></span><span class=main>]</span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span> 


<span class=keyword1 id=FSSublist-append_sublist><span class=command>lemma</span></span> append_sublist<span class=main>:</span> 
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"subseq <span class=main>(</span><span class=free>l1</span> <span class=main>@</span> <span class=free>l2</span> <span class=main>@</span> <span class=free>l3</span><span class=main>)</span> <span class=free>l</span> <span class=main>⟹</span> subseq <span class=main>(</span><span class=free>l1</span> <span class=main>@</span> <span class=free>l3</span><span class=main>)</span> <span class=free>l</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>l</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> Nil
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> 
    <span class=keyword1><span class=command>using</span></span> sublist_NIL
    <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>a</span> <span class=skolem>l</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> 
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=free>l1</span></span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> Nil
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>using</span></span> Cons.prems append_sublist_1 
      <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>a</span> <span class=skolem>list</span><span class=main>)</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>using</span></span> Cons.prems subseq_append' subseq_order.dual_order.trans
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1 id=FSSublist-sublist_subset><span class=command>lemma</span></span> sublist_subset<span class=main>:</span> 
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"subseq <span class=free>l1</span> <span class=free>l2</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"set <span class=free>l1</span> <span class=main>⊆</span> set <span class=free>l2</span>"</span></span> 
  <span class=keyword1><span class=command>using</span></span> assms set_nths_subset subseq_conv_nths
  <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>


<span class=keyword1 id=FSSublist-sublist_filter><span class=command>lemma</span></span> sublist_filter<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>P</span> <span class=free>l</span> 
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"subseq <span class=main>(</span>filter <span class=free>P</span> <span class=free>l</span><span class=main>)</span> <span class=free>l</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> subseq_filter_left 
  <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>


<span class=keyword1 id=FSSublist-sublist_cons_2><span class=command>lemma</span></span> sublist_cons_2<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>l1</span> <span class=free>l2</span> <span class=free>h</span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>subseq <span class=main>(</span><span class=free>h</span> <span class=main>#</span> <span class=free>l1</span><span class=main>)</span> <span class=main>(</span><span class=free>h</span> <span class=main>#</span> <span class=free>l2</span><span class=main>)</span> <span class=main>⟷</span> <span class=main>(</span>subseq <span class=free>l1</span> <span class=free>l2</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>


<span class=keyword1 id=FSSublist-sublist_every><span class=command>lemma</span></span> sublist_every<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>l1</span> <span class=free>l2</span> <span class=free>P</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>subseq <span class=free>l1</span> <span class=free>l2</span> <span class=main>∧</span> list_all <span class=free>P</span> <span class=free>l2</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"list_all <span class=free>P</span> <span class=free>l1</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> <span class=main><span class=main>(</span></span>full_types<span class=main><span class=main>)</span></span> Ball_set assms list_emb_set<span class=main>)</span>


<span class=keyword1 id=FSSublist-sublist_SING_MEM><span class=command>lemma</span></span> sublist_SING_MEM<span class=main>:</span> <span class=quoted><span class=quoted>"subseq <span class=main>[</span><span class=free>h</span><span class=main>]</span> <span class=free>l</span> <span class=main>⟷</span> ListMem <span class=free>h</span> <span class=free>l</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> ListMem_iff subseq_singleton_left
  <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>


<span class=comment1>― ‹NOTE renamed due to previous declaration of `sublist\_append\_exists\_2.›</span>
<span class=keyword1 id=FSSublist-sublist_append_exists_2><span class=command>lemma</span></span> sublist_append_exists_2<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>l1</span> <span class=free>l2</span> <span class=free>l3</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"subseq <span class=main>(</span><span class=free>h</span> <span class=main>#</span> <span class=free>l1</span><span class=main>)</span> <span class=free>l2</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>l3</span> <span class=bound>l4</span><span class=main>.</span> <span class=main>(</span><span class=free>l2</span> <span class=main>=</span> <span class=bound>l3</span> <span class=main>@</span> <span class=main>[</span><span class=free>h</span><span class=main>]</span> <span class=main>@</span> <span class=bound>l4</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span>subseq <span class=free>l1</span> <span class=bound>l4</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms sublist_cons_exists
  <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>


<span class=keyword1 id=FSSublist-sublist_append_4><span class=command>lemma</span></span> sublist_append_4<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>l</span> <span class=free>l1</span> <span class=free>l2</span> <span class=free>h</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>subseq <span class=main>(</span><span class=free>h</span> <span class=main>#</span> <span class=free>l</span><span class=main>)</span> <span class=main>(</span><span class=free>l1</span> <span class=main>@</span> <span class=main>[</span><span class=free>h</span><span class=main>]</span> <span class=main>@</span> <span class=free>l2</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>list_all <span class=main>(</span><span class=main>λ</span><span class=bound>x</span><span class=main>.</span> <span class=main>¬</span><span class=main>(</span><span class=free>h</span> <span class=main>=</span> <span class=bound>x</span><span class=main>)</span><span class=main>)</span> <span class=free>l1</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"subseq <span class=free>l</span> <span class=free>l2</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms 
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>l1</span></span><span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span> <span class=operator>auto</span>


<span class=keyword1 id=FSSublist-sublist_append_5><span class=command>lemma</span></span> sublist_append_5<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>l</span> <span class=free>l1</span> <span class=free>l2</span> <span class=free>h</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>subseq <span class=main>(</span><span class=free>h</span> <span class=main>#</span> <span class=free>l</span><span class=main>)</span> <span class=main>(</span><span class=free>l1</span> <span class=main>@</span> <span class=free>l2</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>list_all <span class=main>(</span><span class=main>λ</span><span class=bound>x</span><span class=main>.</span> <span class=main>¬</span><span class=main>(</span><span class=free>h</span> <span class=main>=</span> <span class=bound>x</span><span class=main>)</span><span class=main>)</span> <span class=free>l1</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"subseq <span class=main>(</span><span class=free>h</span> <span class=main>#</span> <span class=free>l</span><span class=main>)</span> <span class=free>l2</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>l1</span></span><span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span> <span class=operator>auto</span>


<span class=keyword1 id=FSSublist-sublist_append_6><span class=command>lemma</span></span> sublist_append_6<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>l</span> <span class=free>l1</span> <span class=free>l2</span> <span class=free>h</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>subseq <span class=main>(</span><span class=free>h</span> <span class=main>#</span> <span class=free>l</span><span class=main>)</span> <span class=main>(</span><span class=free>l1</span> <span class=main>@</span> <span class=free>l2</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>¬</span><span class=main>(</span>ListMem <span class=free>h</span> <span class=free>l1</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"subseq <span class=main>(</span><span class=free>h</span> <span class=main>#</span> <span class=free>l</span><span class=main>)</span> <span class=free>l2</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms 
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>l1</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>a</span> <span class=skolem>l1</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> ListMem_iff<span class=main>)</span> 
<span class=keyword1><span class=command>qed</span></span> <span class=operator>simp</span>


<span class=keyword1 id=FSSublist-sublist_MEM><span class=command>lemma</span></span> sublist_MEM<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>h</span> <span class=free>l1</span> <span class=free>l2</span> 
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"subseq <span class=main>(</span><span class=free>h</span> <span class=main>#</span> <span class=free>l1</span><span class=main>)</span> <span class=free>l2</span> <span class=main>⟹</span> ListMem <span class=free>h</span> <span class=free>l2</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>l2</span></span><span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>a</span> <span class=skolem>l2</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>using</span></span> elem insert subseq_Cons2_neq 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
<span class=keyword1><span class=command>qed</span></span> <span class=operator>simp</span>


<span class=keyword1 id=FSSublist-sublist_cons_4><span class=command>lemma</span></span> sublist_cons_4<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>l</span> <span class=free>h</span> <span class=free>l'</span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"subseq <span class=free>l</span> <span class=free>l'</span> <span class=main>⟹</span> subseq <span class=free>l</span> <span class=main>(</span><span class=free>h</span> <span class=main>#</span> <span class=free>l'</span><span class=main>)</span>"</span></span> 
  <span class=keyword1><span class=command>using</span></span> sublist_cons
  <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>


<span class=keyword1><span class=command>subsection</span></span> <span class=quoted><span class=plain_text>"Main Theorems"</span></span>

<span class=keyword1><span class=command>theorem</span></span> sublist_imp_len_filter_le<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>P</span> <span class=free>l</span> <span class=free>l'</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"subseq <span class=free>l'</span> <span class=free>l</span>"</span></span> 
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"length <span class=main>(</span>filter <span class=free>P</span> <span class=free>l'</span><span class=main>)</span> <span class=main>≤</span> length <span class=main>(</span>filter <span class=free>P</span> <span class=free>l</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> sublist_length<span class=main>)</span>


<span class=comment1>― ‹TODO showcase (non-trivial proof translation/ obscurity).›</span>
<span class=keyword1><span class=command>theorem</span></span> list_with_three_types_shorten_type2<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>P1</span> <span class=free>P2</span> <span class=free>P3</span> <span class=free>k1</span> <span class=free>f</span> <span class=free>PProbs</span> <span class=free>PProbl</span> <span class=free>s</span> <span class=free>l</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>PProbs</span> <span class=free>s</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>PProbl</span> <span class=free>l</span><span class=main>)</span>"</span></span> 
    <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>l</span> <span class=bound>s</span><span class=main>.</span> 
      <span class=main>(</span><span class=free>PProbs</span> <span class=bound>s</span><span class=main>)</span>
      <span class=main>∧</span> <span class=main>(</span><span class=free>PProbl</span> <span class=bound>l</span><span class=main>)</span>
      <span class=main>∧</span> <span class=main>(</span>list_all <span class=free>P1</span> <span class=bound>l</span><span class=main>)</span> 
      <span class=main>⟶</span> <span class=main>(</span><span class=main>∃</span><span class=bound>l'</span><span class=main>.</span> 
          <span class=main>(</span><span class=free>f</span> <span class=bound>s</span> <span class=bound>l'</span> <span class=main>=</span> <span class=free>f</span> <span class=bound>s</span> <span class=bound>l</span><span class=main>)</span> 
          <span class=main>∧</span> <span class=main>(</span>length <span class=main>(</span>filter <span class=free>P2</span> <span class=bound>l'</span><span class=main>)</span> <span class=main>≤</span> <span class=free>k1</span><span class=main>)</span>
          <span class=main>∧</span> <span class=main>(</span>length <span class=main>(</span>filter <span class=free>P3</span> <span class=bound>l'</span><span class=main>)</span> <span class=main>≤</span> length <span class=main>(</span>filter <span class=free>P3</span> <span class=bound>l</span><span class=main>)</span><span class=main>)</span>
          <span class=main>∧</span> <span class=main>(</span>list_all <span class=free>P1</span> <span class=bound>l'</span><span class=main>)</span>
          <span class=main>∧</span> <span class=main>(</span>subseq <span class=bound>l'</span> <span class=bound>l</span><span class=main>)</span>
      <span class=main>)</span>
    <span class=main>)</span>"</span></span> 
    <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>s</span> <span class=bound>l1</span> <span class=bound>l2</span><span class=main>.</span> <span class=free>f</span> <span class=main>(</span><span class=free>f</span> <span class=bound>s</span> <span class=bound>l1</span><span class=main>)</span> <span class=bound>l2</span> <span class=main>=</span> <span class=free>f</span> <span class=bound>s</span> <span class=main>(</span><span class=bound>l1</span> <span class=main>@</span> <span class=bound>l2</span><span class=main>)</span><span class=main>)</span>"</span></span> 
    <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>s</span> <span class=bound>l</span><span class=main>.</span> <span class=main>(</span><span class=free>PProbs</span> <span class=bound>s</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=free>PProbl</span> <span class=bound>l</span><span class=main>)</span> <span class=main>⟶</span> <span class=main>(</span><span class=free>PProbs</span> <span class=main>(</span><span class=free>f</span> <span class=bound>s</span> <span class=bound>l</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span> 
    <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>l1</span> <span class=bound>l2</span><span class=main>.</span> <span class=main>(</span>subseq <span class=bound>l1</span> <span class=bound>l2</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=free>PProbl</span> <span class=bound>l2</span><span class=main>)</span> <span class=main>⟶</span> <span class=main>(</span><span class=free>PProbl</span> <span class=bound>l1</span><span class=main>)</span><span class=main>)</span>"</span></span> 
    <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>l1</span> <span class=bound>l2</span><span class=main>.</span> <span class=free>PProbl</span> <span class=main>(</span><span class=bound>l1</span> <span class=main>@</span> <span class=bound>l2</span><span class=main>)</span> <span class=main>⟷</span> <span class=main>(</span><span class=free>PProbl</span> <span class=bound>l1</span> <span class=main>∧</span> <span class=free>PProbl</span> <span class=bound>l2</span><span class=main>)</span><span class=main>)</span>"</span></span> 
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>l'</span><span class=main>.</span> 
    <span class=main>(</span><span class=free>f</span> <span class=free>s</span> <span class=bound>l'</span> <span class=main>=</span> <span class=free>f</span> <span class=free>s</span> <span class=free>l</span><span class=main>)</span>
    <span class=main>∧</span> <span class=main>(</span>length <span class=main>(</span>filter <span class=free>P3</span> <span class=bound>l'</span><span class=main>)</span> <span class=main>≤</span> length <span class=main>(</span>filter <span class=free>P3</span> <span class=free>l</span><span class=main>)</span><span class=main>)</span> 
    <span class=main>∧</span> <span class=main>(</span><span class=main>∀</span><span class=bound>l''</span><span class=main>.</span> 
      <span class=main>(</span>sublist <span class=bound>l''</span> <span class=bound>l'</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span>list_all <span class=free>P1</span> <span class=bound>l''</span><span class=main>)</span>
       <span class=main>⟶</span> <span class=main>(</span>length <span class=main>(</span>filter <span class=free>P2</span> <span class=bound>l''</span><span class=main>)</span> <span class=main>≤</span> <span class=free>k1</span><span class=main>)</span>
    <span class=main>)</span>
    <span class=main>∧</span> <span class=main>(</span>subseq <span class=bound>l'</span> <span class=free>l</span><span class=main>)</span>
  <span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms 
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=quoted>"filter <span class=main>(</span><span class=main>λ</span><span class=bound>x</span><span class=main>.</span> <span class=main>¬</span><span class=free>P1</span> <span class=bound>x</span><span class=main>)</span> <span class=free>l</span>"</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>P1</span></span> <span class=quoted><span class=free>P2</span></span> <span class=quoted><span class=free>P3</span></span> <span class=quoted><span class=free>k1</span></span> <span class=quoted><span class=free>f</span></span> <span class=quoted><span class=free>PProbs</span></span> <span class=quoted><span class=free>PProbl</span></span> <span class=quoted><span class=free>s</span></span> <span class=quoted><span class=free>l</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> Nil
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"list_all <span class=main>(</span><span class=main>λ</span><span class=bound>x</span><span class=main>.</span> <span class=skolem>P1</span> <span class=bound>x</span><span class=main>)</span> <span class=skolem>l</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> Nil<span class=main>(</span>1<span class=main>)</span> filter_empty_every_not<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>x</span><span class=main>.</span> <span class=main>¬</span><span class=skolem>P1</span> <span class=bound>x</span>"</span></span> <span class=quoted><span class=skolem>l</span></span><span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>presburger</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>l'</span></span> <span class=keyword2><span class=keyword>where</span></span> 1<span class=main>:</span>
    <span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>f</span> <span class=skolem>s</span> <span class=skolem>l'</span> <span class=main>=</span> <span class=skolem>f</span> <span class=skolem>s</span> <span class=skolem>l</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"length <span class=main>(</span>filter <span class=skolem>P2</span> <span class=skolem>l'</span><span class=main>)</span> <span class=main>≤</span> <span class=skolem>k1</span>"</span></span> <span class=quoted><span class=quoted>"length <span class=main>(</span>filter <span class=skolem>P3</span> <span class=skolem>l'</span><span class=main>)</span> <span class=main>≤</span> length <span class=main>(</span>filter <span class=skolem>P3</span> <span class=skolem>l</span><span class=main>)</span>"</span></span> 
    <span class=quoted><span class=quoted>"list_all <span class=skolem>P1</span> <span class=skolem>l'</span>"</span></span> <span class=quoted><span class=quoted>"subseq <span class=skolem>l'</span> <span class=skolem>l</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Nil.prems<span class=main>(</span>1<span class=main>,</span> 2<span class=main>,</span> 3<span class=main>)</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>l''</span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"sublist <span class=skolem>l''</span> <span class=skolem>l'</span>"</span></span> <span class=quoted><span class=quoted>"list_all <span class=skolem>P1</span> <span class=skolem>l''</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"subseq <span class=skolem>l''</span> <span class=skolem>l'</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
        <span class=comment1>― ‹NOTE original proof uses `frag\_len\_filter\_le` which however requires the fact
      `sublist l' ?l`. Unfortunately, this could not be derived in Isabelle/HOL.›</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"length <span class=main>(</span>filter <span class=skolem>P2</span> <span class=skolem>l''</span><span class=main>)</span> <span class=main>≤</span> length <span class=main>(</span>filter <span class=skolem>P2</span> <span class=skolem>l'</span><span class=main>)</span>"</span></span> 
      <span class=keyword1><span class=command>using</span></span> sublist_imp_len_filter_le
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"length <span class=main>(</span>filter <span class=skolem>P2</span> <span class=skolem>l''</span><span class=main>)</span> <span class=main>≤</span> <span class=skolem>k1</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> 1
      <span class=keyword1><span class=command>by</span></span> <span class=operator>linarith</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>a</span> <span class=skolem>x</span><span class=main>)</span>
    <span class=comment1>― ‹NOTE The proof of the induction step basically consists of construction a list 
    `?l'=l'' @ [a] @ l'''` where `l''` and `l'''` are lists obtained from certain specifications
    of the induction hypothesis.›</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>l1</span></span> <span class=skolem><span class=skolem>l2</span></span> <span class=keyword2><span class=keyword>where</span></span> 2<span class=main>:</span> 
    <span class=quoted><span class=quoted>"<span class=skolem>l</span> <span class=main>=</span> <span class=skolem>l1</span> <span class=main>@</span> <span class=skolem>a</span> <span class=main>#</span> <span class=skolem>l2</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>u</span><span class=main>∈</span>set <span class=skolem>l1</span><span class=main>.</span> <span class=skolem>P1</span> <span class=bound>u</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span> <span class=skolem>P1</span> <span class=skolem>a</span> <span class=main>∧</span> <span class=skolem>x</span> <span class=main>=</span> <span class=main>[</span><span class=bound>x</span><span class=main>←</span><span class=skolem>l2</span> <span class=main>.</span> <span class=main>¬</span> <span class=skolem>P1</span> <span class=bound>x</span><span class=main>]</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Cons<span class=main>(</span>2<span class=main>)</span> filter_eq_Cons_iff<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>x</span><span class=main>.</span> <span class=main>¬</span><span class=skolem>P1</span> <span class=bound>x</span>"</span></span><span class=main>]</span> 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> 3<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>PProbl</span> <span class=skolem>l2</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>2<span class=main>,</span> 6<span class=main>)</span> 2<span class=main>(</span>1<span class=main>)</span> sublist_append_back 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=comment1>― ‹NOTE Use the induction hypothesis to obtain a specific  `l'''`.›</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>=</span> filter <span class=main>(</span><span class=main>λ</span><span class=bound>x</span><span class=main>.</span> <span class=main>¬</span><span class=skolem>P1</span> <span class=bound>x</span><span class=main>)</span> <span class=skolem>l2</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> 2<span class=main>(</span>3<span class=main>)</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>PProbs</span> <span class=main>(</span><span class=skolem>f</span> <span class=main>(</span><span class=skolem>f</span> <span class=skolem>s</span> <span class=skolem>l1</span><span class=main>)</span> <span class=main>[</span><span class=skolem>a</span><span class=main>]</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>1<span class=main>,</span> 2<span class=main>,</span> 5<span class=main>,</span> 6<span class=main>,</span> 7<span class=main>)</span> 2<span class=main>(</span>1<span class=main>)</span> elem sublist_SING_MEM
      <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>l</span> <span class=bound>s</span><span class=main>.</span> <span class=skolem>PProbs</span> <span class=bound>s</span> <span class=main>∧</span> <span class=skolem>PProbl</span> <span class=bound>l</span> <span class=main>∧</span> list_all <span class=skolem>P1</span> <span class=bound>l</span> <span class=main>⟶</span> <span class=main>(</span><span class=main>∃</span><span class=bound>l'</span><span class=main>.</span> 
      <span class=skolem>f</span> <span class=bound>s</span> <span class=bound>l'</span> <span class=main>=</span> <span class=skolem>f</span> <span class=bound>s</span> <span class=bound>l</span> <span class=main>∧</span> length <span class=main>(</span>filter <span class=skolem>P2</span> <span class=bound>l'</span><span class=main>)</span> <span class=main>≤</span> <span class=skolem>k1</span> <span class=main>∧</span> length <span class=main>(</span>filter <span class=skolem>P3</span> <span class=bound>l'</span><span class=main>)</span> <span class=main>≤</span> length <span class=main>(</span>filter <span class=skolem>P3</span> <span class=bound>l</span><span class=main>)</span>
      <span class=main>∧</span> list_all <span class=skolem>P1</span> <span class=bound>l'</span> <span class=main>∧</span> subseq <span class=bound>l'</span> <span class=bound>l</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>3<span class=main>)</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>s</span> <span class=bound>l1</span> <span class=bound>l2</span><span class=main>.</span> <span class=skolem>f</span> <span class=main>(</span><span class=skolem>f</span> <span class=bound>s</span> <span class=bound>l1</span><span class=main>)</span> <span class=bound>l2</span> <span class=main>=</span> <span class=skolem>f</span> <span class=bound>s</span> <span class=main>(</span><span class=bound>l1</span> <span class=main>@</span> <span class=bound>l2</span><span class=main>)</span>"</span></span> 
      <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>s</span> <span class=bound>l</span><span class=main>.</span> <span class=skolem>PProbs</span> <span class=bound>s</span> <span class=main>∧</span> <span class=skolem>PProbl</span> <span class=bound>l</span> <span class=main>⟶</span> <span class=skolem>PProbs</span> <span class=main>(</span><span class=skolem>f</span> <span class=bound>s</span> <span class=bound>l</span><span class=main>)</span>"</span></span> 
      <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>l1</span> <span class=bound>l2</span><span class=main>.</span> subseq <span class=bound>l1</span> <span class=bound>l2</span> <span class=main>∧</span> <span class=skolem>PProbl</span> <span class=bound>l2</span> <span class=main>⟶</span> <span class=skolem>PProbl</span> <span class=bound>l1</span>"</span></span>
      <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>l1</span> <span class=bound>l2</span><span class=main>.</span> <span class=skolem>PProbl</span> <span class=main>(</span><span class=bound>l1</span> <span class=main>@</span> <span class=bound>l2</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=skolem>PProbl</span> <span class=bound>l1</span> <span class=main>∧</span> <span class=skolem>PProbl</span> <span class=bound>l2</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>4<span class=main>,</span> 5<span class=main>,</span> 6<span class=main>,</span> 7<span class=main>)</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span><span class=main><span class=keyword3>+</span></span>
    <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>l'</span><span class=main>.</span> 
      <span class=skolem>f</span> <span class=main>(</span><span class=skolem>f</span> <span class=main>(</span><span class=skolem>f</span> <span class=skolem>s</span> <span class=skolem>l1</span><span class=main>)</span> <span class=main>[</span><span class=skolem>a</span><span class=main>]</span><span class=main>)</span> <span class=bound>l'</span> <span class=main>=</span> <span class=skolem>f</span> <span class=main>(</span><span class=skolem>f</span> <span class=main>(</span><span class=skolem>f</span> <span class=skolem>s</span> <span class=skolem>l1</span><span class=main>)</span> <span class=main>[</span><span class=skolem>a</span><span class=main>]</span><span class=main>)</span> <span class=skolem>l2</span> <span class=main>∧</span> length <span class=main>(</span>filter <span class=skolem>P3</span> <span class=bound>l'</span><span class=main>)</span> <span class=main>≤</span> length <span class=main>(</span>filter <span class=skolem>P3</span> <span class=skolem>l2</span><span class=main>)</span>
      <span class=main>∧</span> <span class=main>(</span><span class=main>∀</span><span class=bound>l''</span><span class=main>.</span> sublist <span class=bound>l''</span> <span class=bound>l'</span> <span class=main>∧</span> list_all <span class=skolem>P1</span> <span class=bound>l''</span> <span class=main>⟶</span> length <span class=main>(</span>filter <span class=skolem>P2</span> <span class=bound>l''</span><span class=main>)</span> <span class=main>≤</span> <span class=skolem>k1</span><span class=main>)</span> <span class=main>∧</span> subseq <span class=bound>l'</span> <span class=skolem>l2</span>"</span></span> 
      <span class=keyword1><span class=command>using</span></span> 3 Cons<span class=main>(</span>1<span class=main>)</span><span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=skolem>P1</span></span> <span class=quoted><span class=skolem>l2</span></span><span class=main>,</span> <span class=keyword2><span class=keyword><span class=operator>where</span></span></span> s<span class=main><span class=main>=</span></span><span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>f</span> <span class=main>(</span><span class=skolem>f</span> <span class=skolem>s</span> <span class=skolem>l1</span><span class=main>)</span> <span class=main>[</span><span class=skolem>a</span><span class=main>]</span><span class=main>)</span>"</span></span><span class=main>]</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>l'''</span></span> <span class=keyword2><span class=keyword>where</span></span> 4<span class=main>:</span>
    <span class=quoted><span class=quoted>"<span class=skolem>f</span> <span class=main>(</span><span class=skolem>f</span> <span class=main>(</span><span class=skolem>f</span> <span class=skolem>s</span> <span class=skolem>l1</span><span class=main>)</span> <span class=main>[</span><span class=skolem>a</span><span class=main>]</span><span class=main>)</span> <span class=skolem>l'''</span> <span class=main>=</span> <span class=skolem>f</span> <span class=main>(</span><span class=skolem>f</span> <span class=main>(</span><span class=skolem>f</span> <span class=skolem>s</span> <span class=skolem>l1</span><span class=main>)</span> <span class=main>[</span><span class=skolem>a</span><span class=main>]</span><span class=main>)</span> <span class=skolem>l2</span>"</span></span> 
    <span class=quoted><span class=quoted>"length <span class=main>(</span>filter <span class=skolem>P3</span> <span class=skolem>l'''</span><span class=main>)</span> <span class=main>≤</span> length <span class=main>(</span>filter <span class=skolem>P3</span> <span class=skolem>l2</span><span class=main>)</span>"</span></span> 
    <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>l''</span><span class=main>.</span> sublist <span class=bound>l''</span> <span class=skolem>l'''</span> <span class=main>∧</span> list_all <span class=skolem>P1</span> <span class=bound>l''</span> <span class=main>⟶</span> length <span class=main>(</span>filter <span class=skolem>P2</span> <span class=bound>l''</span><span class=main>)</span> <span class=main>≤</span> <span class=skolem>k1</span><span class=main>)</span> <span class=main>∧</span> subseq <span class=skolem>l'''</span> <span class=skolem>l2</span>"</span></span> 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>f</span> <span class=skolem>s</span> <span class=main>(</span><span class=skolem>l1</span> <span class=main>@</span> <span class=main>[</span><span class=skolem>a</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>l'''</span><span class=main>)</span> <span class=main>=</span> <span class=skolem>f</span> <span class=skolem>s</span> <span class=main>(</span><span class=skolem>l1</span> <span class=main>@</span> <span class=main>[</span><span class=skolem>a</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>l2</span><span class=main>)</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>4<span class=main>)</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"subseq <span class=skolem>l'''</span> <span class=skolem>l2</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> 4<span class=main>(</span>3<span class=main>)</span> 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=comment1>― ‹NOTE Use the induction hypothesis to obtain a specific  `l''`.›</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>l</span> <span class=bound>s</span><span class=main>.</span> 
        <span class=skolem>PProbs</span> <span class=bound>s</span> <span class=main>∧</span> <span class=skolem>PProbl</span> <span class=skolem>l1</span> <span class=main>∧</span> list_all <span class=skolem>P1</span> <span class=skolem>l1</span> 
        <span class=main>⟶</span> <span class=main>(</span><span class=main>∃</span><span class=bound>l''</span><span class=main>.</span> 
          <span class=skolem>f</span> <span class=bound>s</span> <span class=bound>l''</span> <span class=main>=</span> <span class=skolem>f</span> <span class=bound>s</span> <span class=skolem>l1</span> <span class=main>∧</span> length <span class=main>(</span>filter <span class=skolem>P2</span> <span class=bound>l''</span><span class=main>)</span> <span class=main>≤</span> <span class=skolem>k1</span> <span class=main>∧</span> length <span class=main>(</span>filter <span class=skolem>P3</span> <span class=bound>l''</span><span class=main>)</span> <span class=main>≤</span> length <span class=main>(</span>filter <span class=skolem>P3</span> <span class=skolem>l1</span><span class=main>)</span>
          <span class=main>∧</span> list_all <span class=skolem>P1</span> <span class=bound>l''</span> <span class=main>∧</span> subseq <span class=bound>l''</span> <span class=skolem>l1</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>3<span class=main>)</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>l''</span><span class=main>.</span> 
        <span class=skolem>f</span> <span class=skolem>s</span> <span class=bound>l''</span> <span class=main>=</span> <span class=skolem>f</span> <span class=skolem>s</span> <span class=skolem>l1</span> <span class=main>∧</span> length <span class=main>(</span>filter <span class=skolem>P2</span> <span class=bound>l''</span><span class=main>)</span> <span class=main>≤</span> <span class=skolem>k1</span> <span class=main>∧</span> length <span class=main>(</span>filter <span class=skolem>P3</span> <span class=bound>l''</span><span class=main>)</span> <span class=main>≤</span> length <span class=main>(</span>filter <span class=skolem>P3</span> <span class=skolem>l1</span><span class=main>)</span>
        <span class=main>∧</span> list_all <span class=skolem>P1</span> <span class=bound>l''</span> <span class=main>∧</span> subseq <span class=bound>l''</span> <span class=skolem>l1</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>1<span class=main>,</span> 2<span class=main>,</span> 7<span class=main>)</span> 2<span class=main>(</span>1<span class=main>,</span> 2<span class=main>)</span> 
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> Ball_set<span class=main>)</span> 
  <span class=keyword1><span class=command>}</span></span>

  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>l''</span></span> <span class=keyword2><span class=keyword>where</span></span> 5<span class=main>:</span>
    <span class=quoted><span class=quoted>"<span class=skolem>f</span> <span class=skolem>s</span> <span class=skolem>l''</span> <span class=main>=</span> <span class=skolem>f</span> <span class=skolem>s</span> <span class=skolem>l1</span>"</span></span> <span class=quoted><span class=quoted>"length <span class=main>(</span>filter <span class=skolem>P2</span> <span class=skolem>l''</span><span class=main>)</span> <span class=main>≤</span> <span class=skolem>k1</span>"</span></span> 
    <span class=quoted><span class=quoted>"length <span class=main>(</span>filter <span class=skolem>P3</span> <span class=skolem>l''</span><span class=main>)</span> <span class=main>≤</span> length <span class=main>(</span>filter <span class=skolem>P3</span> <span class=skolem>l1</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"list_all <span class=skolem>P1</span> <span class=skolem>l''</span> <span class=main>∧</span> subseq <span class=skolem>l''</span> <span class=skolem>l1</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>text</span></span> <span class=quoted><span class=plain_text>‹ Proof the proposition by providing the witness <span class=antiquoted><span class=antiquoted><span class=antiquote><span class=antiquote>@{</span></span><span class=operator><span class=operator>term</span></span> <span class=quoted><span class=quoted>"<span class=free><span class=free>l'</span></span><span class=main><span class=main>=</span></span><span class=main><span class=main>(</span></span><span class=skolem><span class=skolem>l''</span></span> <span class=main><span class=main>@</span></span> <span class=main><span class=main>[</span></span><span class=skolem><span class=skolem>a</span></span><span class=main><span class=main>]</span></span> <span class=main><span class=main>@</span></span> <span class=skolem><span class=skolem>l'''</span></span><span class=main><span class=main>)</span></span>"</span></span><span class=antiquote><span class=antiquote>}</span></span></span></span>. ›</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?l'</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>l''</span> <span class=main>@</span> <span class=main>[</span><span class=skolem>a</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>l'''</span><span class=main>)</span> "</span></span> 
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>s</span> <span class=bound>l1</span> <span class=bound>l2</span><span class=main>.</span> <span class=skolem>f</span> <span class=main>(</span><span class=skolem>f</span> <span class=bound>s</span> <span class=bound>l1</span><span class=main>)</span> <span class=bound>l2</span> <span class=main>=</span> <span class=skolem>f</span> <span class=bound>s</span> <span class=main>(</span><span class=bound>l1</span> <span class=main>@</span> <span class=bound>l2</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> Cons.prems<span class=main><span class=main>(</span></span>4<span class=main><span class=main>)</span></span><span class=main>)</span>
    <span class=keyword1><span class=command>text</span></span> <span class=quoted><span class=plain_text>‹ Rewrite and show the goal.›</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>f</span> <span class=skolem>s</span> <span class=var>?l'</span> <span class=main>=</span> <span class=skolem>f</span> <span class=skolem>s</span> <span class=main>(</span><span class=skolem>l1</span> <span class=main>@</span> <span class=main>[</span><span class=skolem>a</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>l2</span><span class=main>)</span> <span class=main>⟷</span> <span class=skolem>f</span> <span class=skolem>s</span> <span class=main>(</span><span class=skolem>l''</span> <span class=main>@</span> <span class=main>(</span><span class=skolem>a</span> <span class=main>#</span> <span class=skolem>l'''</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=skolem>f</span> <span class=skolem>s</span> <span class=main>(</span><span class=skolem>l1</span> <span class=main>@</span> <span class=main>(</span><span class=skolem>a</span> <span class=main>#</span> <span class=skolem>l2</span><span class=main>)</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>also</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>…</span> <span class=main>⟷</span> <span class=skolem>f</span> <span class=main>(</span><span class=skolem>f</span> <span class=main>(</span><span class=skolem>f</span> <span class=skolem>s</span> <span class=skolem>l1</span><span class=main>)</span> <span class=main>[</span><span class=skolem>a</span><span class=main>]</span><span class=main>)</span> <span class=skolem>l'''</span> <span class=main>=</span> <span class=skolem>f</span> <span class=main>(</span><span class=skolem>f</span> <span class=main>(</span><span class=skolem>f</span> <span class=skolem>s</span> <span class=skolem>l1</span><span class=main>)</span> <span class=main>[</span><span class=skolem>a</span><span class=main>]</span><span class=main>)</span> <span class=skolem>l2</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> Cons.prems<span class=main><span class=main>(</span></span>4<span class=main><span class=main>)</span></span> <span class=quoted><span class=quoted>‹<span class=skolem>f</span> <span class=skolem>s</span> <span class=skolem>l''</span> <span class=main>=</span> <span class=skolem>f</span> <span class=skolem>s</span> <span class=skolem>l1</span>›</span></span> calculation<span class=main>)</span>
    <span class=keyword1><span class=command>finally</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>f</span> <span class=skolem>s</span> <span class=var>?l'</span> <span class=main>=</span> <span class=skolem>f</span> <span class=skolem>s</span> <span class=main>(</span><span class=skolem>l1</span> <span class=main>@</span> <span class=main>[</span><span class=skolem>a</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>l2</span><span class=main>)</span>"</span></span> 
      <span class=keyword1><span class=command>using</span></span> 4<span class=main>(</span>1<span class=main>)</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>moreover</span></span> 
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"
      length <span class=main>(</span>filter <span class=skolem>P3</span> <span class=var>?l'</span><span class=main>)</span> <span class=main>≤</span> length <span class=main>(</span>filter <span class=skolem>P3</span> <span class=main>(</span><span class=skolem>l1</span> <span class=main>@</span> <span class=main>[</span><span class=skolem>a</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>l2</span><span class=main>)</span><span class=main>)</span>
      <span class=main>⟷</span> 
        <span class=main>(</span>length <span class=main>(</span>filter <span class=skolem>P3</span> <span class=skolem>l''</span><span class=main>)</span> <span class=main>+</span> <span class=main>1</span> <span class=main>+</span> length <span class=main>(</span>filter <span class=skolem>P3</span> <span class=skolem>l'''</span><span class=main>)</span> 
        <span class=main>≤</span> length <span class=main>(</span>filter <span class=skolem>P3</span> <span class=skolem>l1</span><span class=main>)</span> <span class=main>+</span> <span class=main>1</span> <span class=main>+</span> length <span class=main>(</span>filter <span class=skolem>P3</span> <span class=skolem>l2</span><span class=main>)</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>" 
      length <span class=main>(</span>filter <span class=skolem>P3</span> <span class=var>?l'</span><span class=main>)</span> <span class=main>≤</span> length <span class=main>(</span>filter <span class=skolem>P3</span> <span class=main>(</span><span class=skolem>l1</span> <span class=main>@</span> <span class=main>[</span><span class=skolem>a</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>l2</span><span class=main>)</span><span class=main>)</span>
      <span class=main>⟷</span>
        length <span class=main>(</span>filter <span class=skolem>P3</span> <span class=skolem>l''</span><span class=main>)</span> <span class=main>+</span> length <span class=main>(</span>filter <span class=skolem>P3</span> <span class=skolem>l'''</span><span class=main>)</span> 
        <span class=main>≤</span> length <span class=main>(</span>filter <span class=skolem>P3</span> <span class=skolem>l1</span><span class=main>)</span> <span class=main>+</span> length <span class=main>(</span>filter <span class=skolem>P3</span> <span class=skolem>l2</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>linarith</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"length <span class=main>(</span>filter <span class=skolem>P3</span> <span class=var>?l'</span><span class=main>)</span> <span class=main>≤</span> length <span class=main>(</span>filter <span class=skolem>P3</span> <span class=main>(</span><span class=skolem>l1</span> <span class=main>@</span> <span class=main>[</span><span class=skolem>a</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>l2</span><span class=main>)</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> 4<span class=main>(</span>2<span class=main>)</span> <span class=quoted><span class=quoted>‹length <span class=main>(</span>filter <span class=skolem>P3</span> <span class=skolem>l''</span><span class=main>)</span> <span class=main>≤</span> length <span class=main>(</span>filter <span class=skolem>P3</span> <span class=skolem>l1</span><span class=main>)</span>›</span></span> 
        add_mono_thms_linordered_semiring<span class=main>(</span>1<span class=main>)</span> 
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>moreover</span></span> 
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>l''''</span>
    <span class=keyword3><span class=command>assume</span></span> P<span class=main>:</span> <span class=quoted><span class=quoted>"sublist <span class=skolem>l''''</span> <span class=var>?l'</span>"</span></span> <span class=quoted><span class=quoted>"list_all <span class=skolem>P1</span> <span class=skolem>l''''</span>"</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"list_all <span class=skolem>P1</span> <span class=skolem>l1</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> 2<span class=main>(</span>2<span class=main>)</span> Ball_set
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span> 
    <span class=keyword1><span class=command>consider</span></span> <span class=main>(</span>i<span class=main>)</span> <span class=quoted><span class=quoted>"sublist <span class=skolem>l''''</span> <span class=skolem>l''</span>"</span></span> <span class=main>|</span> <span class=main>(</span>ii<span class=main>)</span> <span class=quoted><span class=quoted>"sublist <span class=skolem>l''''</span> <span class=skolem>l'''</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> P<span class=main>(</span>1<span class=main>,</span> 2<span class=main>)</span> 2<span class=main>(</span>3<span class=main>)</span>  LIST_FRAG_DICHOTOMY_2
      <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"length <span class=main>(</span>filter <span class=skolem>P2</span> <span class=skolem>l''''</span><span class=main>)</span> <span class=main>≤</span> <span class=skolem>k1</span>"</span></span> 
    <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span><span class=main>)</span>
      <span class=keyword3><span class=command>case</span></span> i
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"length <span class=main>(</span>filter <span class=skolem>P2</span> <span class=skolem>l''''</span><span class=main>)</span> <span class=main>≤</span> length <span class=main>(</span>filter <span class=skolem>P2</span> <span class=skolem>l''</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> frag_len_filter_le
        <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> 
        <span class=keyword1><span class=command>using</span></span> 5<span class=main>(</span>2<span class=main>)</span> order_trans
        <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>next</span></span>
      <span class=keyword3><span class=command>case</span></span> ii
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
        <span class=keyword1><span class=command>using</span></span> 4<span class=main>(</span>3<span class=main>)</span> P<span class=main>(</span>2<span class=main>)</span>
        <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>}</span></span>
    <span class=comment1>― ‹NOTE the following two steps seem to be necessary to convince Isabelle that the split 
  <span class=antiquoted><span class=antiquote>@{</span><span class=operator>term</span> <span class=quoted>"<span class=skolem>l</span> <span class=main>=</span> <span class=skolem>l1</span> <span class=main>@</span> <span class=skolem>a</span> <span class=main>#</span> <span class=skolem>l2</span>"</span><span class=antiquote>}</span></span> matches the split `(l1 @ [a] @ l2` and the previous proof steps therefore is 
  prove the goal.›</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>{</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"subseq <span class=var>?l'</span> <span class=main>(</span><span class=skolem>l1</span> <span class=main>@</span> <span class=main>[</span><span class=skolem>a</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>l2</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> FSSublist.sublist_append <span class=quoted><span class=quoted>‹list_all <span class=skolem>P1</span> <span class=skolem>l''</span> <span class=main>∧</span> subseq <span class=skolem>l''</span> <span class=skolem>l1</span>›</span></span> <span class=quoted><span class=quoted>‹subseq <span class=skolem>l'''</span> <span class=skolem>l2</span>›</span></span><span class=main>)</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>l</span> <span class=main>=</span> <span class=skolem>l1</span> <span class=main>@</span> <span class=main>[</span><span class=skolem>a</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>l2</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> 2 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1 id=FSSublist-isPREFIX_sublist><span class=command>lemma</span></span> isPREFIX_sublist<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>x</span> <span class=free>y</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"prefix <span class=free>x</span> <span class=free>y</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"subseq <span class=free>x</span> <span class=free>y</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms prefix_order.dual_order.antisym 
  <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>

<span class=keyword2><span class=keyword>end</span></span></pre>
</div><div id=HoArithUtils>
<div class=head>
<h1>Theory HoArithUtils</h1>
</div>
<pre class=source><span class=keyword1><span class=command>theory</span></span> HoArithUtils
  <span class=keyword2><span class=keyword>imports</span></span> <a href=https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html>Main</a>
<span class=keyword2><span class=keyword>begin</span></span>

<span class=keyword1 id=HoArithUtils-general_theorem><span class=command>lemma</span></span> general_theorem<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>P</span> <span class=free>f</span> <span class=keyword2><span class=keyword>and</span></span> <span class=free>l</span> <span class=main>::</span> <span class=quoted>nat</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>p</span><span class=main>.</span> <span class=free>P</span> <span class=bound>p</span> <span class=main>∧</span> <span class=free>f</span> <span class=bound>p</span> <span class=main>&gt;</span> <span class=free>l</span> <span class=main>⟶</span> <span class=main>(</span><span class=main>∃</span><span class=bound>p'</span><span class=main>.</span> <span class=free>P</span> <span class=bound>p'</span> <span class=main>∧</span> <span class=free>f</span> <span class=bound>p'</span> <span class=main>&lt;</span> <span class=free>f</span> <span class=bound>p</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>p</span><span class=main>.</span> <span class=free>P</span> <span class=bound>p</span> <span class=main>⟶</span> <span class=main>(</span><span class=main>∃</span><span class=bound>p'</span><span class=main>.</span> <span class=free>P</span> <span class=bound>p'</span> <span class=main>∧</span> <span class=free>f</span> <span class=bound>p'</span> <span class=main>≤</span> <span class=free>l</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span><span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>p</span><span class=main>.</span> <span class=main>(</span><span class=skolem>n</span> <span class=main>=</span> <span class=free>f</span> <span class=bound>p</span><span class=main>)</span> <span class=main>∧</span> <span class=free>P</span> <span class=bound>p</span> <span class=main>⟶</span> <span class=main>(</span><span class=main>∃</span><span class=bound>p'</span><span class=main>.</span> <span class=free>P</span> <span class=bound>p'</span> <span class=main>∧</span> <span class=free>f</span> <span class=bound>p'</span> <span class=main>≤</span> <span class=free>l</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword>for</span></span> <span class=skolem>n</span>
    <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>rule</span> Nat.nat_less_induct<span class=main><span class=main>[</span></span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> <span class=var>?P</span> <span class=main><span class=main><span class=main>=</span></span></span> <span class=quoted><span class=quoted><span class=quoted>"<span class=main><span class=main>%</span></span><span class=bound><span class=bound>n</span></span><span class=main><span class=main>.</span></span> <span class=main><span class=main>∀</span></span><span class=bound><span class=bound>p</span></span><span class=main><span class=main>.</span></span> <span class=main><span class=main>(</span></span><span class=bound><span class=bound>n</span></span> <span class=main><span class=main>=</span></span> <span class=free><span class=free>f</span></span> <span class=bound><span class=bound>p</span></span><span class=main><span class=main>)</span></span> <span class=main><span class=main>∧</span></span> <span class=free><span class=free>P</span></span> <span class=bound><span class=bound>p</span></span> <span class=main><span class=main>⟶</span></span> <span class=main><span class=main>(</span></span><span class=main><span class=main>∃</span></span><span class=bound><span class=bound>p'</span></span><span class=main><span class=main>.</span></span> <span class=free><span class=free>P</span></span> <span class=bound><span class=bound>p'</span></span> <span class=main><span class=main>∧</span></span> <span class=free><span class=free>f</span></span> <span class=bound><span class=bound>p'</span></span> <span class=main><span class=main>≤</span></span> <span class=free><span class=free>l</span></span><span class=main><span class=main>)</span></span>"</span></span></span><span class=main><span class=main>]</span></span><span class=main>)</span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> assms not_less<span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword2><span class=keyword>end</span></span></pre>
</div><div id=FmapUtils>
<div class=head>
<h1>Theory FmapUtils</h1>
</div>
<pre class=source><span class=keyword1><span class=command>theory</span></span> FmapUtils
  <span class=keyword2><span class=keyword>imports</span></span> <span class=quoted>"<a href=https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Finite_Map.html>HOL-Library.Finite_Map</a>"</span> <a href=#FactoredSystemLib>FactoredSystemLib</a>
<span class=keyword2><span class=keyword>begin</span></span>

<span class=comment1>― ‹TODO
  A lemma 'fmrestrict\_set\_twice\_eq'
    'fmrestrict\_set ?vs (fmrestrict\_set ?vs ?f) = fmrestrict\_set ?vs ?f'
to replace the recurring proofs steps using 'by (simp add: fmfilter\_alt\_defs(4))' would make sense.›</span>


<span class=comment1>― ‹NOTE hide the '++' operator from 'Map' to prevent warnings.›</span>
<span class=keyword1><span class=command>hide_const</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>open</span></span><span class=main>)</span> Map.map_add
<span class=keyword1><span class=command>no_notation</span></span> Map.map_add <span class=main>(</span><span class=keyword2><span class=keyword>infixl</span></span> <span class=quoted>"<span class=keyword1>++</span>"</span> 100<span class=main>)</span>

<span class=comment1>― ‹TODO more explicit proof.›</span>
<span class=keyword1 id=FmapUtils-IN_FDOM_DRESTRICT_DIFF><span class=command>lemma</span></span> IN_FDOM_DRESTRICT_DIFF<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>vs</span> <span class=free>v</span> <span class=free>f</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span><span class=main>(</span><span class=free>v</span> <span class=main>∈</span> <span class=free>vs</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=free>f</span> <span class=main>⊆</span> <span class=free>fdom</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>v</span> <span class=main>∈</span> fmdom' <span class=free>f</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=free>v</span> <span class=main>∈</span> fmdom' <span class=main>(</span>fmrestrict_set <span class=main>(</span><span class=free>fdom</span> <span class=main>-</span> <span class=free>vs</span><span class=main>)</span> <span class=free>f</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> DiffI Int_def Int_iff Set.filter_def fmdom'_filter fmfilter_alt_defs<span class=main><span class=main>(</span></span>4<span class=main><span class=main>)</span></span> inf.order_iff<span class=main>)</span>

<span class=keyword1 id=FmapUtils-disj_dom_drest_fupdate_eq><span class=command>lemma</span></span> disj_dom_drest_fupdate_eq<span class=main>:</span> <span class=quoted><span class=quoted>"
  disjnt <span class=main>(</span>fmdom' <span class=free>x</span><span class=main>)</span> <span class=free>vs</span> <span class=main>⟹</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span> <span class=main>=</span> fmrestrict_set <span class=free>vs</span> <span class=main>(</span><span class=free>x</span> <span class=main>++</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span>
"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword3><span class=command>fix</span></span> <span class=skolem>vs</span> <span class=skolem>s</span> <span class=skolem>x</span>
  <span class=keyword3><span class=command>assume</span></span> P<span class=main>:</span> <span class=quoted><span class=quoted>"disjnt <span class=main>(</span>fmdom' <span class=skolem>x</span><span class=main>)</span> <span class=skolem>vs</span>"</span></span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>x''</span><span class=main>.</span> <span class=main>(</span><span class=bound>x''</span> <span class=main>∈</span> <span class=skolem>vs</span><span class=main>)</span> <span class=main>⟶</span> <span class=main>(</span>fmlookup <span class=main>(</span><span class=skolem>x</span> <span class=main>++</span> <span class=skolem>s</span><span class=main>)</span> <span class=bound>x''</span> <span class=main>=</span> fmlookup <span class=skolem>s</span>  <span class=bound>x''</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> calculation disjnt_iff fmap_add_ltr_def fmdom'_notD fmdom_notI fmlookup_add<span class=main>)</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>x''</span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=main>(</span>fmrestrict_set <span class=skolem>vs</span> <span class=skolem>s</span><span class=main>)</span> <span class=skolem>x''</span> <span class=main>=</span> fmlookup <span class=main>(</span>fmrestrict_set <span class=skolem>vs</span> <span class=main>(</span><span class=skolem>x</span> <span class=main>++</span> <span class=skolem>s</span><span class=main>)</span><span class=main>)</span> <span class=skolem>x''</span>"</span></span>
      <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=skolem>x''</span> <span class=main>∉</span> fmdom' <span class=skolem>x</span>"</span></span><span class=main>)</span>
       <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=skolem>x''</span> <span class=main>∉</span> <span class=skolem>vs</span>"</span></span><span class=main>)</span>
        <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> <span class=quoted>"1"</span><span class=main>)</span>
      <span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>fmrestrict_set <span class=skolem>vs</span> <span class=skolem>s</span> <span class=main>=</span> fmrestrict_set <span class=skolem>vs</span> <span class=main>(</span><span class=skolem>x</span> <span class=main>++</span> <span class=skolem>s</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> fmap_ext <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=comment1>― ‹TODO refactor into 'FmapUtils.thy'.›</span>
<span class=keyword1 id=FmapUtils-graph_plan_card_state_set><span class=command>lemma</span></span> graph_plan_card_state_set<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=free>vs</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"finite <span class=free>vs</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"card <span class=main>(</span>fmdom' <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span> <span class=main>≤</span> card <span class=free>vs</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?vs'</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?vs'</span> <span class=main>⊆</span> <span class=free>vs</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> fmdom'_restrict_set
    <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"card <span class=var>?vs'</span> <span class=main>≤</span> card <span class=free>vs</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms calculation card_mono
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=FmapUtils-exec_drest_5><span class=command>lemma</span></span> exec_drest_5<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>x</span> <span class=free>vs</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=free>x</span> <span class=main>⊆</span> <span class=free>vs</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>x</span> <span class=main>=</span> <span class=free>x</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=comment1>― ‹TODO refactor and make into ISAR proof.›</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>v</span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>x</span><span class=main>)</span> <span class=skolem>v</span> <span class=main>=</span> fmlookup <span class=free>x</span> <span class=skolem>v</span>"</span></span>
      <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span> fmdom' <span class=free>x</span>"</span></span><span class=main>)</span>
      <span class=keyword1><span class=command><span class=improper><span class=command>subgoal</span></span></span></span> <span class=keyword1><span class=command>using</span></span> assms <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword1><span class=command><span class=improper><span class=command>subgoal</span></span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> fmdom'_notD<span class=main>)</span>
      <span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>x</span><span class=main>)</span> <span class=skolem>v</span> <span class=main>=</span> fmlookup <span class=free>x</span> <span class=skolem>v</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>x</span><span class=main>)</span> <span class=main>=</span> fmlookup <span class=free>x</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> calculation fmap_ext
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>using</span></span> fmlookup_inject
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=FmapUtils-graph_plan_lemma_5><span class=command>lemma</span></span> graph_plan_lemma_5<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>s</span> <span class=free>s'</span> <span class=free>vs</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>fmrestrict_set <span class=main>(</span>fmdom' <span class=free>s</span> <span class=main>-</span> <span class=free>vs</span><span class=main>)</span> <span class=free>s</span> <span class=main>=</span> fmrestrict_set <span class=main>(</span>fmdom' <span class=free>s'</span> <span class=main>-</span> <span class=free>vs</span><span class=main>)</span> <span class=free>s'</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span> <span class=main>=</span> fmrestrict_set <span class=free>vs</span> <span class=free>s'</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>s</span> <span class=main>=</span> <span class=free>s'</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>x</span><span class=main>.</span> fmlookup <span class=free>s</span> <span class=bound>x</span> <span class=main>=</span> fmlookup <span class=free>s'</span> <span class=bound>x</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>,</span> 2<span class=main>)</span> fmdom'_notD fminusI fmlookup_restrict_set Diff_iff
    <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> fmap_ext
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=FmapUtils-drest_smap_drest_smap_drest><span class=command>lemma</span></span> drest_smap_drest_smap_drest<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>x</span> <span class=free>s</span> <span class=free>vs</span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"fmrestrict_set <span class=free>vs</span> <span class=free>x</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s</span> <span class=main>⟷</span> fmrestrict_set <span class=free>vs</span> <span class=free>x</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> fmrestrict_set <span class=free>vs</span> <span class=free>s</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=comment1>― ‹TODO this could be refactored into standalone lemma since it's very common in proofs.›</span>
  <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"fmlookup <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>m</sub></span> fmlookup <span class=free>s</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> fmdom'.rep_eq fmdom'_notI fmlookup_restrict_set map_le_def<span class=main>)</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>assume</span></span> P1<span class=main>:</span> <span class=quoted><span class=quoted>"fmrestrict_set <span class=free>vs</span> <span class=free>x</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s</span>"</span></span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> 2<span class=main>:</span> <span class=quoted><span class=quoted>"fmlookup <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>x</span><span class=main>)</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>m</sub></span> fmlookup <span class=free>s</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> P1 fmsubset.rep_eq <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>{</span></span>
      <span class=keyword3><span class=command>fix</span></span> <span class=skolem>v</span>
      <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span> fmdom' <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>x</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>x</span><span class=main>)</span> <span class=skolem>v</span> <span class=main>=</span> fmlookup <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span> <span class=skolem>v</span>"</span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> <span class=main><span class=main>(</span></span>full_types<span class=main><span class=main>)</span></span> <span class=quoted>"2"</span> domIff fmdom'_notI fmlookup_restrict_set map_le_def<span class=main>)</span>
    <span class=keyword1><span class=command>}</span></span>
    <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmrestrict_set <span class=free>vs</span> <span class=free>x</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> fmrestrict_set <span class=free>vs</span> <span class=free>s</span>"</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> fmsubset.rep_eq
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> map_le_def<span class=main>)</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>assume</span></span> P2<span class=main>:</span> <span class=quoted><span class=quoted>"fmrestrict_set <span class=free>vs</span> <span class=free>x</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> fmrestrict_set <span class=free>vs</span> <span class=free>s</span>"</span></span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmrestrict_set <span class=free>vs</span> <span class=free>s</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> 1 fmsubset.rep_eq
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmrestrict_set <span class=free>vs</span> <span class=free>x</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> fmsubset.rep_eq map_le_trans
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=FmapUtils-sat_precond_as_proj_1><span class=command>lemma</span></span> sat_precond_as_proj_1<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>s</span> <span class=free>s'</span> <span class=free>vs</span> <span class=free>x</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"fmrestrict_set <span class=free>vs</span> <span class=free>s</span> <span class=main>=</span> fmrestrict_set <span class=free>vs</span> <span class=free>s'</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"fmrestrict_set <span class=free>vs</span> <span class=free>x</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s</span> <span class=main>⟷</span> fmrestrict_set <span class=free>vs</span> <span class=free>x</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s'</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms drest_smap_drest_smap_drest
  <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>

<span class=keyword1 id=FmapUtils-sat_precond_as_proj_4><span class=command>lemma</span></span> sat_precond_as_proj_4<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>fm1</span> <span class=free>fm2</span> <span class=free>vs</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>fm2</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>fm1</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>fm2</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>fm1</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms fmpred_restrict_set fmsubset_alt_def
  <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>

<span class=keyword1 id=FmapUtils-sublist_as_proj_eq_as_1><span class=command>lemma</span></span> sublist_as_proj_eq_as_1<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>x</span> <span class=free>s</span> <span class=free>vs</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>x</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>x</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>meson</span> fmsubset.rep_eq fmsubset_alt_def fmsubset_pred drest_smap_drest_smap_drest map_le_refl<span class=main>)</span>

<span class=keyword1 id=FmapUtils-limited_dom_neq_restricted_neq><span class=command>lemma</span></span> limited_dom_neq_restricted_neq<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=free>f1</span> <span class=main>⊆</span> <span class=free>vs</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>f1</span> <span class=main>++</span> <span class=free>f2</span> <span class=main>≠</span> <span class=free>f2</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"fmrestrict_set <span class=free>vs</span> <span class=main>(</span><span class=free>f1</span> <span class=main>++</span> <span class=free>f2</span><span class=main>)</span> <span class=main>≠</span> fmrestrict_set <span class=free>vs</span> <span class=free>f2</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>assume</span></span> C<span class=main>:</span> <span class=quoted><span class=quoted>"fmrestrict_set <span class=free>vs</span> <span class=main>(</span><span class=free>f1</span> <span class=main>++</span> <span class=free>f2</span><span class=main>)</span> <span class=main>=</span> fmrestrict_set <span class=free>vs</span> <span class=free>f2</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>x</span> <span class=main>∈</span> fmdom' <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=main>(</span><span class=free>f1</span> <span class=main>++</span> <span class=free>f2</span><span class=main>)</span><span class=main>)</span><span class=main>.</span>
      fmlookup <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=main>(</span><span class=free>f1</span> <span class=main>++</span> <span class=free>f2</span><span class=main>)</span><span class=main>)</span> <span class=bound>x</span>
      <span class=main>=</span> fmlookup <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>f2</span><span class=main>)</span> <span class=bound>x</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>v</span></span> <span class=keyword2><span class=keyword>where</span></span> a<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span> fmdom' <span class=free>f1</span>"</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=main>(</span><span class=free>f1</span> <span class=main>++</span> <span class=free>f2</span><span class=main>)</span> <span class=skolem>v</span> <span class=main>≠</span> fmlookup <span class=free>f2</span> <span class=skolem>v</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>2<span class=main>)</span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> fmap_add_ltr_def fmap_ext fmdom'_notD fmdom_notI fmlookup_add<span class=main>)</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> b<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span> <span class=free>vs</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>)</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>{</span></span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=main>(</span><span class=free>f1</span> <span class=main>++</span> <span class=free>f2</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=free>vs</span> <span class=main>∩</span> fmdom' <span class=main>(</span><span class=free>f1</span> <span class=main>++</span> <span class=free>f2</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> fmdom'_alt_def fmfilter_alt_defs<span class=main><span class=main>(</span></span>4<span class=main><span class=main>)</span></span><span class=main>)</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span> fmdom' <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=main>(</span><span class=free>f1</span> <span class=main>++</span> <span class=free>f2</span><span class=main>)</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> C a b
        <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
    <span class=keyword1><span class=command>}</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted>False</span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> C a<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span> calculation fmlookup_restrict_set<span class=main>)</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=FmapUtils-fmlookup_fmrestrict_set_dom><span class=command>lemma</span></span> fmlookup_fmrestrict_set_dom<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>vs</span> <span class=bound>s</span><span class=main>.</span> dom <span class=main>(</span>fmlookup <span class=main>(</span>fmrestrict_set <span class=bound>vs</span> <span class=bound>s</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=bound>vs</span> <span class=main>∩</span> <span class=main>(</span>fmdom' <span class=bound>s</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> fmdom'_restrict_set_precise<span class=main>)</span>

<span class=keyword2><span class=keyword>end</span></span></pre>
</div><div id=FactoredSystem>
<div class=head>
<h1>Theory FactoredSystem</h1>
</div>
<pre class=source><span class=keyword1><span class=command>theory</span></span> FactoredSystem
  <span class=keyword2><span class=keyword>imports</span></span> <a href=https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html>Main</a> <span class=quoted>"<a href=https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Finite_Map.html>HOL-Library.Finite_Map</a>"</span> <span class=quoted>"<a href=https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Sublist.html>HOL-Library.Sublist</a>"</span> <a href=#FSSublist>FSSublist</a>
    <a href=#FactoredSystemLib>FactoredSystemLib</a> <a href=#ListUtils>ListUtils</a> <a href=#HoArithUtils>HoArithUtils</a> <a href=#FmapUtils>FmapUtils</a>
<span class=keyword2><span class=keyword>begin</span></span>


<span class=keyword1><span class=command>section</span></span> <span class=quoted><span class=plain_text>"Factored System"</span></span>

<span class=comment1>― ‹NOTE hide the '++' operator from 'Map' to prevent warnings.›</span>
<span class=keyword1><span class=command>hide_const</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>open</span></span><span class=main>)</span> Map.map_add
<span class=keyword1><span class=command>no_notation</span></span> Map.map_add <span class=main>(</span><span class=keyword2><span class=keyword>infixl</span></span> <span class=quoted>"<span class=keyword1>++</span>"</span> 100<span class=main>)</span>


<span class=keyword1><span class=command>subsection</span></span> <span class=quoted><span class=plain_text>"Semantics of Plan Execution"</span></span>

<span class=keyword1><span class=command>text</span></span> <span class=quoted><span class=plain_text>‹ This section aims at characterizing the semantics of executing plans---i.e. sequences
of actions---on a given initial state.

The semantics of action execution were previously introduced
via the notion of succeding state (`state\_succ`). Plan execution (`exec\_plan`) extends this notion
to sequences of actions by calculating the succeding state from the given state and action pair and
then recursively executing the remaining actions on the succeding state. [Abdulaziz et al., HOL4
Definition 3, p.9] ›</span></span>


<span class=keyword1 id=FactoredSystem-state_succ_pair><span class=command>lemma</span></span> state_succ_pair<span class=main>:</span> <span class=quoted><span class=quoted>"state_succ <span class=free>s</span> <span class=main>(</span><span class=free>p</span><span class=main>,</span> <span class=free>e</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>if</span> <span class=main>(</span><span class=free>p</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s</span><span class=main>)</span> <span class=keyword1>then</span> <span class=main>(</span><span class=free>e</span> <span class=main>++</span> <span class=free>s</span><span class=main>)</span> <span class=keyword1>else</span> <span class=free>s</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> state_succ_def<span class=main>)</span>


<span class=comment1>― ‹NOTE shortened to 'exec\_plan'›</span>
<span class=comment1>― ‹NOTE using 'fun' because of multiple definining equations.›</span>
<span class=comment1>― ‹NOTE first argument was curried.›</span>
<span class=keyword1><span class=command>fun</span></span> <span class=entity>exec_plan</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>exec_plan</span> <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=main>[]</span> <span class=main>=</span> <span class=free><span class=bound><span class=entity>s</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>exec_plan</span> <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=main>(</span><span class=free><span class=bound><span class=entity>a</span></span></span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>as</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free>exec_plan</span> <span class=main>(</span>state_succ <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=free><span class=bound><span class=entity>a</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>as</span></span></span>"</span></span>


<span class=keyword1 id=FactoredSystem-exec_plan_Append><span class=command>lemma</span></span> exec_plan_Append<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>as_a</span> <span class=free>as_b</span> <span class=free>s</span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"exec_plan <span class=free>s</span> <span class=main>(</span><span class=free>as_a</span> <span class=main>@</span> <span class=free>as_b</span><span class=main>)</span> <span class=main>=</span> exec_plan <span class=main>(</span>exec_plan <span class=free>s</span> <span class=free>as_a</span><span class=main>)</span> <span class=free>as_b</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>as_a</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>s</span></span> <span class=quoted><span class=free>as_b</span></span><span class=main>)</span> <span class=operator>auto</span>


<span class=keyword1><span class=command>text</span></span> <span class=quoted><span class=plain_text>‹ Plan execution effectively eliminates cycles: i.e., if a given plan `as` may be partitioned
into plans `as1`, `as2` and `as3`, s.t. the sequential execution of `as1` and `as2` yields the same
state, `as2` may be skipped during plan execution. ›</span></span>

<span class=keyword1 id=FactoredSystem-cycle_removal_lemma><span class=command>lemma</span></span> cycle_removal_lemma<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>as1</span> <span class=free>as2</span> <span class=free>as3</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>exec_plan <span class=free>s</span> <span class=main>(</span><span class=free>as1</span> <span class=main>@</span> <span class=free>as2</span><span class=main>)</span> <span class=main>=</span> exec_plan <span class=free>s</span> <span class=free>as1</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>exec_plan <span class=free>s</span> <span class=main>(</span><span class=free>as1</span> <span class=main>@</span> <span class=free>as2</span> <span class=main>@</span> <span class=free>as3</span><span class=main>)</span> <span class=main>=</span> exec_plan <span class=free>s</span> <span class=main>(</span><span class=free>as1</span> <span class=main>@</span> <span class=free>as3</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms exec_plan_Append
  <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>


<span class=keyword1><span class=command>subsubsection</span></span> <span class=quoted><span class=plain_text>"Characterization of the Set of Possible States"</span></span>

<span class=keyword1><span class=command>text</span></span> <span class=quoted><span class=plain_text>‹ To show the construction principle of the set of possible states---in lemma
`construction\_of\_all\_possible\_states\_lemma`---the following ancillary proves of finite map
properties are required.

Most importantly, in lemma `fmupd\_fmrestrict\_subset` we show how finite mappings `s` with domain
<span class=antiquoted><span class=antiquoted><span class=antiquote><span class=antiquote>@{</span></span><span class=operator><span class=operator>term</span></span> <span class=quoted><span class=quoted>"<span class=main><span class=main>{</span></span><span class=free><span class=free>v</span></span><span class=main><span class=main>}</span></span> <span class=main><span class=main>∪</span></span> <span class=free><span class=free>X</span></span>"</span></span><span class=antiquote><span class=antiquote>}</span></span></span></span> and `s v = (Some x)` are constructed from their restrictions to `X` via update, i.e.

  s = fmupd v x (fmrestrict\_set X s)

This is used in lemma `construction\_of\_all\_possible\_states\_lemma` to show that the set of possible
states for variables <span class=antiquoted><span class=antiquoted><span class=antiquote><span class=antiquote>@{</span></span><span class=operator><span class=operator>term</span></span> <span class=quoted><span class=quoted>"<span class=main><span class=main>{</span></span><span class=free><span class=free>v</span></span><span class=main><span class=main>}</span></span> <span class=main><span class=main>∪</span></span> <span class=free><span class=free>X</span></span>"</span></span><span class=antiquote><span class=antiquote>}</span></span></span></span> is constructed inductively from the set of all possible states for
variables `X` via update on point <span class=antiquoted><span class=antiquoted><span class=antiquote><span class=antiquote>@{</span></span><span class=operator><span class=operator>term</span></span> <span class=quoted><span class=quoted>"<span class=free><span class=free>v</span></span> <span class=main><span class=main>∉</span></span> <span class=free><span class=free>X</span></span>"</span></span><span class=antiquote><span class=antiquote>}</span></span></span></span>.
›</span></span>

<span class=comment1>― ‹NOTE added lemma.›</span>
<span class=keyword1 id=FactoredSystem-empty_domain_fmap_set><span class=command>lemma</span></span> empty_domain_fmap_set<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>{</span><span class=bound>s</span><span class=main>.</span> fmdom' <span class=bound>s</span> <span class=main>=</span> <span class=main>{}</span><span class=main>}</span> <span class=main>=</span> <span class=main>{</span>fmempty<span class=main>}</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?A</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"<span class=main>{</span><span class=bound>s</span><span class=main>.</span> fmdom' <span class=bound>s</span> <span class=main>=</span> <span class=main>{}</span><span class=main>}</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?B</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"<span class=main>{</span>fmempty<span class=main>}</span>"</span></span>
  <span class=keyword3><span class=command>fix</span></span> <span class=skolem>s</span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>proof</span></span><span class=main>(</span><span class=operator>rule</span> ccontr<span class=main>)</span>
    <span class=keyword3><span class=command>assume</span></span> C<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=var>?A</span> <span class=main>≠</span> <span class=var>?B</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted>False</span> <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
      <span class=keyword1><span class=command>{</span></span>
        <span class=keyword3><span class=command>assume</span></span> C1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=var>?A</span> <span class=main>⊂</span> <span class=var>?B</span>"</span></span>
        <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?A</span> <span class=main>=</span> <span class=main>{}</span>"</span></span> <span class=keyword1><span class=command>using</span></span> C1 <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted>False</span> <span class=keyword1><span class=command>using</span></span> fmdom'_empty <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>}</span></span>
      <span class=keyword1><span class=command>moreover</span></span>
      <span class=keyword1><span class=command>{</span></span>
        <span class=keyword3><span class=command>assume</span></span> C2<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>¬</span><span class=main>(</span><span class=var>?A</span> <span class=main>⊂</span> <span class=var>?B</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmdom' fmempty <span class=main>=</span> <span class=main>{}</span>"</span></span>
          <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
        <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmempty <span class=main>∈</span> <span class=var>?A</span>"</span></span>
          <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
        <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?A</span> <span class=main>≠</span> <span class=main>{}</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> calculation<span class=main>(</span>2<span class=main>)</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
        <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>a</span><span class=main>∈</span><span class=var>?A</span><span class=main>.</span><span class=bound>a</span><span class=main>∉</span><span class=var>?B</span>"</span></span>
          <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> <span class=main><span class=main>(</span></span>mono_tags<span class=main><span class=main>,</span></span> lifting<span class=main><span class=main>)</span></span>
              C Collect_cong calculation<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span> fmrestrict_set_dom fmrestrict_set_null singleton_conv<span class=main>)</span>
        <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmempty <span class=main>∈</span> <span class=var>?B</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
        <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>a</span><span class=main>∈</span><span class=var>?A</span><span class=main>.</span><span class=bound>a</span><span class=main>∈</span><span class=var>?B</span>"</span></span>
          <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
        <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span><span class=main>(</span><span class=main>∀</span><span class=bound>a</span><span class=main>∈</span><span class=var>?A</span><span class=main>.</span><span class=bound>a</span><span class=main>∉</span><span class=var>?B</span><span class=main>)</span>"</span></span>
          <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
        <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted>False</span>
          <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>}</span></span>
      <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted>False</span>
        <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
    <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>qed</span></span>

<span class=comment1>― ‹NOTE added lemma.›</span>
<span class=keyword1 id=FactoredSystem-possible_states_set_ii_a><span class=command>lemma</span></span> possible_states_set_ii_a<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>s</span> <span class=free>x</span> <span class=free>v</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>v</span> <span class=main>∈</span> fmdom' <span class=free>s</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>fmdom' <span class=main>(</span><span class=main>(</span><span class=main>λ</span><span class=bound>s</span><span class=main>.</span> fmupd <span class=free>v</span> <span class=free>x</span> <span class=bound>s</span><span class=main>)</span> <span class=free>s</span><span class=main>)</span> <span class=main>=</span> fmdom' <span class=free>s</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms insert_absorb
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=comment1>― ‹NOTE added lemma.›</span>
<span class=keyword1 id=FactoredSystem-possible_states_set_ii_b><span class=command>lemma</span></span> possible_states_set_ii_b<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>s</span> <span class=free>x</span> <span class=free>v</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>v</span> <span class=main>∉</span> fmdom' <span class=free>s</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>fmdom' <span class=main>(</span><span class=main>(</span><span class=main>λ</span><span class=bound>s</span><span class=main>.</span> fmupd <span class=free>v</span> <span class=free>x</span> <span class=bound>s</span><span class=main>)</span> <span class=free>s</span><span class=main>)</span> <span class=main>=</span> fmdom' <span class=free>s</span> <span class=main>∪</span> <span class=main>{</span><span class=free>v</span><span class=main>}</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=comment1>― ‹NOTE added lemma.›</span>
<span class=keyword1 id=FactoredSystem-fmap_neq><span class=command>lemma</span></span> fmap_neq<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>s</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=tfree>'a</span><span class=main>,</span> bool<span class=main>)</span> fmap"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=free>s'</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=tfree>'a</span><span class=main>,</span> bool<span class=main>)</span> fmap"</span></span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>fmdom' <span class=free>s</span> <span class=main>=</span> fmdom' <span class=free>s'</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>(</span><span class=free>s</span> <span class=main>≠</span> <span class=free>s'</span><span class=main>)</span> <span class=main>⟷</span> <span class=main>(</span><span class=main>∃</span><span class=bound>v</span><span class=main>∈</span><span class=main>(</span>fmdom' <span class=free>s</span><span class=main>)</span><span class=main>.</span> fmlookup <span class=free>s</span> <span class=bound>v</span> <span class=main>≠</span> fmlookup <span class=free>s'</span> <span class=bound>v</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms fmap_ext fmdom'_notD
  <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>

<span class=comment1>― ‹NOTE added lemma.›</span>
<span class=keyword1 id="FactoredSystem-fmdom'_fmsubset_restrict_set"><span class=command>lemma</span></span> fmdom'_fmsubset_restrict_set<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>X1</span> <span class=free>X2</span> <span class=keyword2><span class=keyword>and</span></span> <span class=free>s</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=tfree>'a</span><span class=main>,</span> bool<span class=main>)</span> fmap"</span></span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>X1</span> <span class=main>⊆</span> <span class=free>X2</span>"</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=free>s</span> <span class=main>=</span> <span class=free>X2</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>fmrestrict_set <span class=free>X1</span> <span class=free>s</span><span class=main>)</span> <span class=main>=</span> <span class=free>X1</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> <span class=main><span class=main>(</span></span>no_types<span class=main><span class=main>,</span></span> lifting<span class=main><span class=main>)</span></span>
      antisym_conv fmdom'_notD fmdom'_notI fmlookup_restrict_set rev_subsetD subsetI<span class=main>)</span>


<span class=comment1>― ‹NOTE added lemma.›</span>
<span class=keyword1 id=FactoredSystem-fmsubset_restrict_set><span class=command>lemma</span></span> fmsubset_restrict_set<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>X1</span> <span class=free>X2</span> <span class=keyword2><span class=keyword>and</span></span> <span class=free>s</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> state"</span></span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>X1</span> <span class=main>⊆</span> <span class=free>X2</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>s</span> <span class=main>∈</span> <span class=main>{</span><span class=bound>s</span><span class=main>.</span> fmdom' <span class=bound>s</span> <span class=main>=</span> <span class=free>X2</span><span class=main>}</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"fmrestrict_set <span class=free>X1</span> <span class=free>s</span> <span class=main>∈</span> <span class=main>{</span><span class=bound>s</span><span class=main>.</span> fmdom' <span class=bound>s</span> <span class=main>=</span> <span class=free>X1</span><span class=main>}</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms fmdom'_fmsubset_restrict_set
  <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>

<span class=comment1>― ‹NOTE added lemma.›</span>
<span class=keyword1 id=FactoredSystem-fmupd_fmsubset_restrict_set><span class=command>lemma</span></span> fmupd_fmsubset_restrict_set<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>X</span> <span class=free>v</span> <span class=free>x</span> <span class=keyword2><span class=keyword>and</span></span> <span class=free>s</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> state"</span></span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>s</span> <span class=main>∈</span> <span class=main>{</span><span class=bound>s</span><span class=main>.</span> fmdom' <span class=bound>s</span> <span class=main>=</span> insert <span class=free>v</span> <span class=free>X</span><span class=main>}</span>"</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=free>s</span> <span class=free>v</span> <span class=main>=</span> Some <span class=free>x</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=free>s</span> <span class=main>=</span> fmupd <span class=free>v</span> <span class=free>x</span> <span class=main>(</span>fmrestrict_set <span class=free>X</span> <span class=free>s</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=comment1>― ‹Show that domains of 's' and 'fmupd v x (fmrestrict\_set X s)' are identical.›</span>
  <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"fmdom' <span class=free>s</span> <span class=main>=</span> insert <span class=free>v</span> <span class=free>X</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>)</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>X</span> <span class=main>⊆</span> insert <span class=free>v</span> <span class=free>X</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>fmrestrict_set <span class=free>X</span> <span class=free>s</span><span class=main>)</span> <span class=main>=</span> <span class=free>X</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> 1 fmdom'_fmsubset_restrict_set
      <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>fmupd <span class=free>v</span> <span class=free>x</span> <span class=main>(</span>fmrestrict_set <span class=free>X</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> insert <span class=free>v</span> <span class=free>X</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>)</span> fmdom'_fmupd
      <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>note</span></span> 2 <span class=main>=</span> this
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>w</span>
      <span class=comment1>― ‹Show case for undefined variables (where lookup yields 'None').›</span>
    <span class=keyword1><span class=command>{</span></span>
      <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>w</span> <span class=main>∉</span> insert <span class=free>v</span> <span class=free>X</span>"</span></span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>w</span> <span class=main>∉</span> fmdom' <span class=free>s</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>w</span> <span class=main>∉</span> fmdom' <span class=main>(</span>fmupd <span class=free>v</span> <span class=free>x</span> <span class=main>(</span>fmrestrict_set <span class=free>X</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> 1 2
        <span class=keyword1><span class=command>by</span></span> <span class=operator>argo</span><span class=main><span class=keyword3>+</span></span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=free>s</span> <span class=skolem>w</span> <span class=main>=</span> fmlookup <span class=main>(</span>fmupd <span class=free>v</span> <span class=free>x</span> <span class=main>(</span>fmrestrict_set <span class=free>X</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span> <span class=skolem>w</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> fmdom'_notD
        <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
    <span class=keyword1><span class=command>}</span></span>
      <span class=comment1>― ‹Show case for defined variables (where lookup yields 'Some y').›</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>{</span></span>
      <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>w</span> <span class=main>∈</span> insert <span class=free>v</span> <span class=free>X</span>"</span></span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>w</span> <span class=main>∈</span> fmdom' <span class=free>s</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>w</span> <span class=main>∈</span> fmdom' <span class=main>(</span>fmupd <span class=free>v</span> <span class=free>x</span> <span class=main>(</span>fmrestrict_set <span class=free>X</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> 1 2
        <span class=keyword1><span class=command>by</span></span> <span class=operator>argo</span><span class=main><span class=keyword3>+</span></span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=free>s</span> <span class=skolem>w</span> <span class=main>=</span> fmlookup <span class=main>(</span>fmupd <span class=free>v</span> <span class=free>x</span> <span class=main>(</span>fmrestrict_set <span class=free>X</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span> <span class=skolem>w</span>"</span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=skolem>w</span> <span class=main>=</span> <span class=free>v</span>"</span></span><span class=main>)</span>
          <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> assms calculation<span class=main>)</span>
    <span class=keyword1><span class=command>}</span></span>
    <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=free>s</span> <span class=skolem>w</span> <span class=main>=</span> fmlookup <span class=main>(</span>fmupd <span class=free>v</span> <span class=free>x</span> <span class=main>(</span>fmrestrict_set <span class=free>X</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span> <span class=skolem>w</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>using</span></span> fmap_ext
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=FactoredSystem-construction_of_all_possible_states_lemma><span class=command>lemma</span></span> construction_of_all_possible_states_lemma<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>v</span> <span class=free>X</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>v</span> <span class=main>∉</span> <span class=free>X</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>{</span><span class=bound>s</span><span class=main>.</span> fmdom' <span class=bound>s</span> <span class=main>=</span> insert <span class=free>v</span> <span class=free>X</span><span class=main>}</span>
    <span class=main>=</span> <span class=main>(</span><span class=main>(</span><span class=main>λ</span><span class=bound>s</span><span class=main>.</span> fmupd <span class=free>v</span> True <span class=bound>s</span><span class=main>)</span> <span class=main>`</span> <span class=main>{</span><span class=bound>s</span><span class=main>.</span> fmdom' <span class=bound>s</span> <span class=main>=</span> <span class=free>X</span><span class=main>}</span><span class=main>)</span>
      <span class=main>∪</span> <span class=main>(</span><span class=main>(</span><span class=main>λ</span><span class=bound>s</span><span class=main>.</span> fmupd <span class=free>v</span> False <span class=bound>s</span><span class=main>)</span> <span class=main>`</span> <span class=main>{</span><span class=bound>s</span><span class=main>.</span> fmdom' <span class=bound>s</span> <span class=main>=</span> <span class=free>X</span><span class=main>}</span><span class=main>)</span>
  <span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword3><span class=command>fix</span></span> <span class=skolem>v</span> <span class=skolem>X</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?A</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"<span class=main>{</span><span class=bound>s</span> <span class=main>::</span> <span class=tfree>'a</span> state<span class=main>.</span> fmdom' <span class=bound>s</span> <span class=main>=</span> insert <span class=skolem>v</span> <span class=skolem>X</span><span class=main>}</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?B</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"
    <span class=main>(</span><span class=main>(</span><span class=main>λ</span><span class=bound>s</span><span class=main>.</span> fmupd <span class=skolem>v</span> True <span class=bound>s</span><span class=main>)</span> <span class=main>`</span> <span class=main>{</span><span class=bound>s</span> <span class=main>::</span> <span class=tfree>'a</span> state<span class=main>.</span> fmdom' <span class=bound>s</span> <span class=main>=</span> <span class=skolem>X</span><span class=main>}</span><span class=main>)</span>
    <span class=main>∪</span> <span class=main>(</span><span class=main>(</span><span class=main>λ</span><span class=bound>s</span><span class=main>.</span> fmupd <span class=skolem>v</span> False <span class=bound>s</span><span class=main>)</span> <span class=main>`</span> <span class=main>{</span><span class=bound>s</span> <span class=main>::</span> <span class=tfree>'a</span> state<span class=main>.</span> fmdom' <span class=bound>s</span> <span class=main>=</span> <span class=skolem>X</span><span class=main>}</span><span class=main>)</span>
  "</span></span>
  <span class=keyword1><span class=command>text</span></span> <span class=quoted><span class=plain_text>‹Show the goal by mutual inclusion. The inclusion <span class=antiquoted><span class=antiquoted><span class=antiquote><span class=antiquote>@{</span></span><span class=operator><span class=operator>term</span></span> <span class=quoted><span class=quoted>"<span class=var><span class=var>?B</span></span> <span class=main><span class=main>⊆</span></span> <span class=var><span class=var>?A</span></span>"</span></span><span class=antiquote><span class=antiquote>}</span></span></span></span> is trivial and can be solved by
    automation. For the complimentary proof <span class=antiquoted><span class=antiquoted><span class=antiquote><span class=antiquote>@{</span></span><span class=operator><span class=operator>term</span></span> <span class=quoted><span class=quoted>"<span class=var><span class=var>?A</span></span> <span class=main><span class=main>⊆</span></span> <span class=var><span class=var>?B</span></span>"</span></span><span class=antiquote><span class=antiquote>}</span></span></span></span> however we need to do more work.
    In our case we choose a proof by contradiction and show that an <span class=antiquoted><span class=antiquoted><span class=antiquote><span class=antiquote>@{</span></span><span class=operator><span class=operator>term</span></span> <span class=quoted><span class=quoted>"<span class=free><span class=free>s</span></span> <span class=main><span class=main>∈</span></span> <span class=var><span class=var>?A</span></span>"</span></span><span class=antiquote><span class=antiquote>}</span></span></span></span> which is not also in
    '?B' cannot exist.›</span></span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?A</span> <span class=main>⊆</span> <span class=var>?B</span>"</span></span> <span class=keyword1><span class=command>proof</span></span><span class=main>(</span><span class=operator>rule</span> ccontr<span class=main>)</span>
      <span class=keyword3><span class=command>assume</span></span> C<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>¬</span><span class=main>(</span><span class=var>?A</span> <span class=main>⊆</span> <span class=var>?B</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>s</span><span class=main>∈</span><span class=var>?A</span><span class=main>.</span> <span class=bound>s</span><span class=main>∉</span><span class=var>?B</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> C
        <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword1><span class=command>moreover</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>s</span></span> <span class=keyword2><span class=keyword>where</span></span> obtain_s<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>s</span><span class=main>∈</span><span class=var>?A</span> <span class=main>∧</span> <span class=skolem>s</span><span class=main>∉</span><span class=var>?B</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> calculation
        <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>s</span><span class=main>∉</span><span class=var>?B</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> obtain_s
        <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=skolem>s</span> <span class=main>=</span> <span class=skolem>X</span> <span class=main>∪</span> <span class=main>{</span><span class=skolem>v</span><span class=main>}</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> obtain_s
        <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>s'</span><span class=main>∈</span><span class=var>?B</span><span class=main>.</span> fmdom' <span class=bound>s'</span> <span class=main>=</span> <span class=skolem>X</span> <span class=main>∪</span> <span class=main>{</span><span class=skolem>v</span><span class=main>}</span>"</span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span>
        <span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>s</span> <span class=main>∉</span> <span class=main>(</span><span class=main>(</span><span class=main>λ</span><span class=bound>s</span><span class=main>.</span> fmupd <span class=skolem>v</span> True <span class=bound>s</span><span class=main>)</span> <span class=main>`</span> <span class=main>{</span><span class=bound>s</span><span class=main>.</span> fmdom' <span class=bound>s</span> <span class=main>=</span> <span class=skolem>X</span><span class=main>}</span><span class=main>)</span><span class=main>)</span>"</span></span>
        <span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>s</span> <span class=main>∉</span> <span class=main>(</span><span class=main>(</span><span class=main>λ</span><span class=bound>s</span><span class=main>.</span> fmupd <span class=skolem>v</span> False <span class=bound>s</span><span class=main>)</span> <span class=main>`</span> <span class=main>{</span><span class=bound>s</span><span class=main>.</span> fmdom' <span class=bound>s</span> <span class=main>=</span> <span class=skolem>X</span><span class=main>}</span><span class=main>)</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> obtain_s
        <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span><span class=main><span class=keyword3>+</span></span>
      <span class=keyword1><span class=command>text</span></span> <span class=quoted><span class=plain_text>‹ Show that every state <span class=antiquoted><span class=antiquoted><span class=antiquote><span class=antiquote>@{</span></span><span class=operator><span class=operator>term</span></span> <span class=quoted><span class=quoted>"<span class=skolem><span class=skolem>s</span></span> <span class=main><span class=main>∈</span></span> <span class=var><span class=var>?A</span></span>"</span></span><span class=antiquote><span class=antiquote>}</span></span></span></span> has been constructed from another state with domain
        'X'. ›</span></span>
      <span class=keyword1><span class=command>moreover</span></span>
      <span class=keyword1><span class=command>{</span></span>
        <span class=keyword3><span class=command>fix</span></span> <span class=skolem>s</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> state"</span></span>
        <span class=keyword3><span class=command>assume</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>s</span> <span class=main>∈</span> <span class=main>{</span><span class=bound>s</span> <span class=main>::</span> <span class=tfree>'a</span> state<span class=main>.</span> fmdom' <span class=bound>s</span> <span class=main>=</span> insert <span class=skolem>v</span> <span class=skolem>X</span><span class=main>}</span>"</span></span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmrestrict_set <span class=skolem>X</span> <span class=skolem>s</span> <span class=main>∈</span> <span class=main>{</span><span class=bound>s</span> <span class=main>::</span> <span class=tfree>'a</span> state<span class=main>.</span> fmdom' <span class=bound>s</span> <span class=main>=</span> <span class=skolem>X</span><span class=main>}</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> subset_insertI fmsubset_restrict_set
          <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
        <span class=keyword1><span class=command>moreover</span></span>
        <span class=keyword1><span class=command>{</span></span>
          <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=skolem>s</span> <span class=skolem>v</span> <span class=main>=</span> Some True"</span></span>
          <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>s</span> <span class=main>=</span> fmupd <span class=skolem>v</span> True <span class=main>(</span>fmrestrict_set <span class=skolem>X</span> <span class=skolem>s</span><span class=main>)</span>"</span></span>
            <span class=keyword1><span class=command>using</span></span> 1 fmupd_fmsubset_restrict_set
            <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
        <span class=keyword1><span class=command>}</span></span>
        <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>{</span></span>
          <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=skolem>s</span> <span class=skolem>v</span> <span class=main>=</span> Some False"</span></span>
          <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>s</span> <span class=main>=</span> fmupd <span class=skolem>v</span> False <span class=main>(</span>fmrestrict_set <span class=skolem>X</span> <span class=skolem>s</span><span class=main>)</span>"</span></span>
            <span class=keyword1><span class=command>using</span></span> 1 fmupd_fmsubset_restrict_set
            <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
        <span class=keyword1><span class=command>}</span></span>
        <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=skolem>s</span> <span class=skolem>v</span> <span class=main>≠</span> None"</span></span>
          <span class=keyword1><span class=command>using</span></span> 1 fmdom'_notI
          <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
        <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"
          <span class=main>(</span><span class=skolem>s</span> <span class=main>∈</span> <span class=main>(</span><span class=main>(</span><span class=main>λ</span><span class=bound>s</span><span class=main>.</span> fmupd <span class=skolem>v</span> True <span class=bound>s</span><span class=main>)</span> <span class=main>`</span> <span class=main>{</span><span class=bound>s</span><span class=main>.</span> fmdom' <span class=bound>s</span> <span class=main>=</span> <span class=skolem>X</span><span class=main>}</span><span class=main>)</span><span class=main>)</span>
          <span class=main>∨</span> <span class=main>(</span><span class=skolem>s</span> <span class=main>∈</span> <span class=main>(</span><span class=main>(</span><span class=main>λ</span><span class=bound>s</span><span class=main>.</span> fmupd <span class=skolem>v</span> False <span class=bound>s</span><span class=main>)</span> <span class=main>`</span> <span class=main>{</span><span class=bound>s</span><span class=main>.</span> fmdom' <span class=bound>s</span> <span class=main>=</span> <span class=skolem>X</span><span class=main>}</span><span class=main>)</span><span class=main>)</span>
        "</span></span>
          <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
      <span class=keyword1><span class=command>}</span></span>
      <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted>False</span>
        <span class=keyword1><span class=command>by</span></span> <span class=operator>meson</span>
    <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?B</span> <span class=main>⊆</span> <span class=var>?A</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=var>?A</span> <span class=main>=</span> <span class=var>?B</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1><span class=command>text</span></span> <span class=quoted><span class=plain_text>‹ Another important property of the state set is cardinality, i.e. the number of distinct
states which can be modelled using a given finite variable set.

As lemma `card\_of\_set\_of\_all\_possible\_states` shows, for a finite variable set `X`, the number of
possible states is `2 \^ card X`, i.e. the number of assigning two discrete values to `card X` slots
as known from combinatorics.

Again, some additional properties of finite maps had to be proven. Pivotally, in lemma
`updates\_disjoint`, it is shown that the image of updating a set of states with domain `X` on a
point <span class=antiquoted><span class=antiquoted><span class=antiquote><span class=antiquote>@{</span></span><span class=operator><span class=operator>term</span></span> <span class=quoted><span class=quoted>"<span class=free><span class=free>x</span></span> <span class=main><span class=main>∉</span></span> <span class=free><span class=free>X</span></span>"</span></span><span class=antiquote><span class=antiquote>}</span></span></span></span> with either `True` or `False` yields two distinct sets of states with domain
<span class=antiquoted><span class=antiquoted><span class=antiquote><span class=antiquote>@{</span></span><span class=operator><span class=operator>term</span></span> <span class=quoted><span class=quoted>"<span class=main><span class=main>{</span></span><span class=free><span class=free>x</span></span><span class=main><span class=main>}</span></span> <span class=main><span class=main>∪</span></span> <span class=free><span class=free>X</span></span>"</span></span><span class=antiquote><span class=antiquote>}</span></span></span></span>. ›</span></span>

<span class=comment1>― ‹NOTE goal has to stay implication otherwise induction rule won't watch.›</span>
<span class=keyword1 id=FactoredSystem-FINITE_states><span class=command>lemma</span></span> FINITE_states<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>X</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> set"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"finite <span class=free>X</span> <span class=main>⟹</span> finite <span class=main>{</span><span class=main>(</span><span class=bound>s</span> <span class=main>::</span> <span class=tfree>'a</span> state<span class=main>)</span><span class=main>.</span> fmdom' <span class=bound>s</span> <span class=main>=</span> <span class=free>X</span><span class=main>}</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span>  <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> finite.induct<span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> emptyI
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>{</span><span class=bound>s</span><span class=main>.</span> fmdom' <span class=bound>s</span>  <span class=main>=</span> <span class=main>{}</span><span class=main>}</span> <span class=main>=</span> <span class=main>{</span>fmempty<span class=main>}</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> empty_domain_fmap_set<span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=quoted>‹<span class=main>{</span><span class=bound>s</span><span class=main>.</span> fmdom' <span class=bound>s</span> <span class=main>=</span> <span class=main>{}</span><span class=main>}</span> <span class=main>=</span> <span class=main>{</span>fmempty<span class=main>}</span>›</span></span><span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>insertI <span class=skolem>A</span> <span class=skolem>a</span><span class=main>)</span>
  <span class=keyword3><span class=command>assume</span></span> P1<span class=main>:</span> <span class=quoted><span class=quoted>"finite <span class=skolem>A</span>"</span></span>
    <span class=keyword2><span class=keyword>and</span></span> P2<span class=main>:</span> <span class=quoted><span class=quoted>"finite <span class=main>{</span><span class=bound>s</span><span class=main>.</span> fmdom' <span class=bound>s</span> <span class=main>=</span> <span class=skolem>A</span><span class=main>}</span>"</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=skolem>a</span> <span class=main>∈</span> <span class=skolem>A</span>"</span></span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> True
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>using</span></span> insertI.IH insert_Diff
      <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> False
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"finite <span class=main>(</span>
          <span class=main>(</span><span class=main>(</span><span class=main>λ</span><span class=bound>s</span><span class=main>.</span> fmupd <span class=skolem>a</span> True <span class=bound>s</span><span class=main>)</span> <span class=main>`</span> <span class=main>{</span><span class=bound>s</span><span class=main>.</span> fmdom' <span class=bound>s</span> <span class=main>=</span> <span class=skolem>A</span><span class=main>}</span><span class=main>)</span>
            <span class=main>∪</span> <span class=main>(</span><span class=main>(</span><span class=main>λ</span><span class=bound>s</span><span class=main>.</span> fmupd <span class=skolem>a</span> False <span class=bound>s</span><span class=main>)</span> <span class=main>`</span> <span class=main>{</span><span class=bound>s</span><span class=main>.</span> fmdom' <span class=bound>s</span> <span class=main>=</span> <span class=skolem>A</span><span class=main>}</span><span class=main>)</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> False construction_of_all_possible_states_lemma insertI.IH
        <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
        <span class=keyword1><span class=command>using</span></span> False construction_of_all_possible_states_lemma
        <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
    <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>qed</span></span>

<span class=comment1>― ‹NOTE added lemma.›</span>
<span class=keyword1 id=FactoredSystem-bool_update_effect><span class=command>lemma</span></span> bool_update_effect<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>s</span> <span class=free>X</span> <span class=free>x</span> <span class=free>v</span> <span class=free>b</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"finite <span class=free>X</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>s</span> <span class=main>∈</span> <span class=main>{</span><span class=bound>s</span> <span class=main>::</span> <span class=tfree>'a</span> state<span class=main>.</span> fmdom' <span class=bound>s</span> <span class=main>=</span> <span class=free>X</span><span class=main>}</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>∈</span> <span class=free>X</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>≠</span> <span class=free>v</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=main>(</span><span class=main>(</span><span class=main>λ</span><span class=bound>s</span> <span class=main>::</span> <span class=tfree>'a</span> state<span class=main>.</span> fmupd <span class=free>v</span> <span class=free>b</span> <span class=bound>s</span><span class=main>)</span> <span class=free>s</span><span class=main>)</span> <span class=free>x</span> <span class=main>=</span> fmlookup <span class=free>s</span> <span class=free>x</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms fmupd_lookup
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=comment1>― ‹NOTE added lemma.›</span>
<span class=keyword1 id=FactoredSystem-bool_update_inj><span class=command>lemma</span></span> bool_update_inj<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>X</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> set"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=free>v</span> <span class=free>b</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"finite <span class=free>X</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>v</span> <span class=main>∉</span> <span class=free>X</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"inj_on <span class=main>(</span><span class=main>λ</span><span class=bound>s</span><span class=main>.</span> fmupd <span class=free>v</span> <span class=free>b</span> <span class=bound>s</span><span class=main>)</span> <span class=main>{</span><span class=bound>s</span> <span class=main>::</span> <span class=tfree>'a</span> state<span class=main>.</span> fmdom' <span class=bound>s</span> <span class=main>=</span> <span class=free>X</span><span class=main>}</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?f</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>s</span> <span class=main>::</span> <span class=tfree>'a</span> state<span class=main>.</span> fmupd <span class=free>v</span> <span class=free>b</span> <span class=bound>s</span>"</span></span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>s1</span> <span class=skolem>s2</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> state"</span></span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>s1</span> <span class=main>∈</span> <span class=main>{</span><span class=bound>s</span> <span class=main>::</span> <span class=tfree>'a</span> state<span class=main>.</span> fmdom' <span class=bound>s</span> <span class=main>=</span> <span class=free>X</span><span class=main>}</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>s2</span> <span class=main>∈</span> <span class=main>{</span><span class=bound>s</span> <span class=main>::</span> <span class=tfree>'a</span> state<span class=main>.</span> fmdom' <span class=bound>s</span> <span class=main>=</span> <span class=free>X</span><span class=main>}</span>"</span></span>
      <span class=quoted><span class=quoted>"<span class=var>?f</span> <span class=skolem>s1</span> <span class=main>=</span> <span class=var>?f</span> <span class=skolem>s2</span>"</span></span>
    <span class=keyword1><span class=command>moreover</span></span>
    <span class=keyword1><span class=command>{</span></span>
      <span class=keyword1><span class=command>have</span></span>
        <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>x</span><span class=main>∈</span><span class=free>X</span><span class=main>.</span> <span class=bound>x</span> <span class=main>≠</span> <span class=free>v</span> <span class=main>⟶</span> fmlookup <span class=main>(</span><span class=var>?f</span> <span class=skolem>s1</span><span class=main>)</span> <span class=bound>x</span> <span class=main>=</span> fmlookup <span class=skolem>s1</span> <span class=bound>x</span>"</span></span>
        <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>x</span><span class=main>∈</span><span class=free>X</span><span class=main>.</span> <span class=bound>x</span> <span class=main>≠</span> <span class=free>v</span> <span class=main>⟶</span> fmlookup <span class=main>(</span><span class=var>?f</span> <span class=skolem>s2</span><span class=main>)</span> <span class=bound>x</span> <span class=main>=</span> fmlookup <span class=skolem>s2</span> <span class=bound>x</span>"</span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span><span class=main><span class=keyword3>+</span></span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span>
        <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>x</span><span class=main>∈</span><span class=free>X</span><span class=main>.</span> <span class=bound>x</span> <span class=main>≠</span> <span class=free>v</span> <span class=main>⟶</span> fmlookup <span class=skolem>s1</span> <span class=bound>x</span> <span class=main>=</span> fmlookup <span class=skolem>s2</span> <span class=bound>x</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> calculation<span class=main>(</span>3<span class=main>)</span>
        <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>}</span></span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=skolem>s1</span> <span class=free>v</span> <span class=main>=</span> fmlookup <span class=skolem>s2</span> <span class=free>v</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> calculation <span class=quoted><span class=quoted>‹<span class=free>v</span> <span class=main>∉</span> <span class=free>X</span>›</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
    <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>s1</span> <span class=main>=</span> <span class=skolem>s2</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> fmap_neq
      <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"inj_on <span class=main>(</span><span class=main>λ</span><span class=bound>s</span><span class=main>.</span> fmupd <span class=free>v</span> <span class=free>b</span> <span class=bound>s</span><span class=main>)</span> <span class=main>{</span><span class=bound>s</span> <span class=main>::</span> <span class=tfree>'a</span> state<span class=main>.</span> fmdom' <span class=bound>s</span> <span class=main>=</span> <span class=free>X</span><span class=main>}</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> inj_onI
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=comment1>― ‹NOTE added lemma.›</span>
<span class=keyword1 id=FactoredSystem-card_update><span class=command>lemma</span></span> card_update<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>X</span> <span class=free>v</span> <span class=free>b</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"finite <span class=main>(</span><span class=free>X</span> <span class=main>::</span> <span class=tfree>'a</span> set<span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>v</span> <span class=main>∉</span> <span class=free>X</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"
    card <span class=main>(</span><span class=main>(</span><span class=main>λ</span><span class=bound>s</span><span class=main>.</span> fmupd <span class=free>v</span> <span class=free>b</span> <span class=bound>s</span><span class=main>)</span> <span class=main>`</span> <span class=main>{</span><span class=bound>s</span> <span class=main>::</span> <span class=tfree>'a</span> state<span class=main>.</span> fmdom' <span class=bound>s</span> <span class=main>=</span> <span class=free>X</span><span class=main>}</span><span class=main>)</span>
    <span class=main>=</span> card <span class=main>{</span><span class=bound>s</span> <span class=main>::</span> <span class=tfree>'a</span> state<span class=main>.</span> fmdom' <span class=bound>s</span> <span class=main>=</span> <span class=free>X</span><span class=main>}</span>
  "</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"inj_on <span class=main>(</span><span class=main>λ</span><span class=bound>s</span><span class=main>.</span> fmupd <span class=free>v</span> <span class=free>b</span> <span class=bound>s</span><span class=main>)</span> <span class=main>{</span><span class=bound>s</span> <span class=main>::</span> <span class=tfree>'a</span> state<span class=main>.</span> fmdom' <span class=bound>s</span> <span class=main>=</span> <span class=free>X</span><span class=main>}</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms bool_update_inj
    <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span>
    <span class=quoted><span class=quoted>"card <span class=main>(</span><span class=main>(</span><span class=main>λ</span><span class=bound>s</span><span class=main>.</span> fmupd <span class=free>v</span> <span class=free>b</span> <span class=bound>s</span><span class=main>)</span> <span class=main>`</span> <span class=main>{</span><span class=bound>s</span> <span class=main>::</span> <span class=tfree>'a</span> state<span class=main>.</span> fmdom' <span class=bound>s</span> <span class=main>=</span> <span class=free>X</span><span class=main>}</span><span class=main>)</span> <span class=main>=</span> card <span class=main>{</span><span class=bound>s</span> <span class=main>::</span> <span class=tfree>'a</span> state<span class=main>.</span> fmdom' <span class=bound>s</span> <span class=main>=</span> <span class=free>X</span><span class=main>}</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> card_image <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=comment1>― ‹NOTE added lemma.›</span>
<span class=keyword1 id=FactoredSystem-updates_disjoint><span class=command>lemma</span></span> updates_disjoint<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>X</span> <span class=free>x</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"finite <span class=free>X</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>∉</span> <span class=free>X</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"
    <span class=main>(</span><span class=main>(</span><span class=main>λ</span><span class=bound>s</span><span class=main>.</span> fmupd <span class=free>x</span> True <span class=bound>s</span><span class=main>)</span> <span class=main>`</span> <span class=main>{</span><span class=bound>s</span><span class=main>.</span> fmdom' <span class=bound>s</span> <span class=main>=</span> <span class=free>X</span><span class=main>}</span><span class=main>)</span>
    <span class=main>∩</span> <span class=main>(</span><span class=main>(</span><span class=main>λ</span><span class=bound>s</span><span class=main>.</span> fmupd <span class=free>x</span> False <span class=bound>s</span><span class=main>)</span> <span class=main>`</span> <span class=main>{</span><span class=bound>s</span><span class=main>.</span> fmdom' <span class=bound>s</span> <span class=main>=</span> <span class=free>X</span><span class=main>}</span><span class=main>)</span> <span class=main>=</span> <span class=main>{}</span>
  "</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?A</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>(</span><span class=main>λ</span><span class=bound>s</span><span class=main>.</span> fmupd <span class=free>x</span> True <span class=bound>s</span><span class=main>)</span> <span class=main>`</span> <span class=main>{</span><span class=bound>s</span><span class=main>.</span> fmdom' <span class=bound>s</span> <span class=main>=</span> <span class=free>X</span><span class=main>}</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?B</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>(</span><span class=main>λ</span><span class=bound>s</span><span class=main>.</span> fmupd <span class=free>x</span> False <span class=bound>s</span><span class=main>)</span> <span class=main>`</span> <span class=main>{</span><span class=bound>s</span><span class=main>.</span> fmdom' <span class=bound>s</span> <span class=main>=</span> <span class=free>X</span><span class=main>}</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>assume</span></span> C<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>¬</span><span class=main>(</span><span class=main>∀</span><span class=bound>a</span><span class=main>∈</span><span class=var>?A</span><span class=main>.</span> <span class=main>∀</span><span class=bound>b</span><span class=main>∈</span><span class=var>?B</span><span class=main>.</span> <span class=bound>a</span> <span class=main>≠</span> <span class=bound>b</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span>
      <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>a</span><span class=main>∈</span><span class=var>?A</span><span class=main>.</span> <span class=main>∀</span><span class=bound>b</span><span class=main>∈</span><span class=var>?B</span><span class=main>.</span> fmlookup <span class=bound>a</span> <span class=free>x</span> <span class=main>≠</span> fmlookup <span class=bound>b</span> <span class=free>x</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>a</span><span class=main>∈</span><span class=var>?A</span><span class=main>.</span> <span class=main>∀</span><span class=bound>b</span><span class=main>∈</span><span class=var>?B</span><span class=main>.</span> <span class=bound>a</span> <span class=main>≠</span> <span class=bound>b</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted>False</span>
      <span class=keyword1><span class=command>using</span></span> C
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=var>?A</span> <span class=main>∩</span> <span class=var>?B</span> <span class=main>=</span> <span class=main>{}</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> disjoint_iff_not_equal
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1 id=FactoredSystem-card_of_set_of_all_possible_states><span class=command>lemma</span></span> card_of_set_of_all_possible_states<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>X</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> set"</span></span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"finite <span class=free>X</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"card <span class=main>{</span><span class=main>(</span><span class=bound>s</span> <span class=main>::</span> <span class=tfree>'a</span> state<span class=main>)</span><span class=main>.</span> fmdom' <span class=bound>s</span> <span class=main>=</span> <span class=free>X</span><span class=main>}</span> <span class=main>=</span> <span class=numeral>2</span> <span class=main>^</span> <span class=main>(</span>card <span class=free>X</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>X</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> empty
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>{</span><span class=bound>s</span> <span class=main>::</span> <span class=tfree>'a</span> state<span class=main>.</span> fmdom' <span class=bound>s</span> <span class=main>=</span> <span class=main>{}</span><span class=main>}</span> <span class=main>=</span> <span class=main>{</span>fmempty<span class=main>}</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> empty_domain_fmap_set
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"card <span class=main>{</span>fmempty<span class=main>}</span> <span class=main>=</span> <span class=main>1</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> is_singleton_altdef
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=numeral>2</span><span class=main>^</span><span class=main>(</span>card <span class=main>{}</span><span class=main>)</span> <span class=main>=</span> <span class=main>1</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>using</span></span> 1
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>insert <span class=skolem>x</span> <span class=skolem>F</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=comment1>― ‹TODO refactor and simplify proof further.›</span>
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> <span class=skolem>F</span>"</span></span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> True
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>using</span></span> insert.hyps<span class=main>(</span>2<span class=main>)</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> False
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"
        <span class=main>{</span><span class=bound>s</span> <span class=main>::</span> <span class=tfree>'a</span> state<span class=main>.</span> fmdom' <span class=bound>s</span> <span class=main>=</span> insert <span class=skolem>x</span> <span class=skolem>F</span><span class=main>}</span>
        <span class=main>=</span> <span class=main>(</span><span class=main>λ</span><span class=bound>s</span><span class=main>.</span> fmupd <span class=skolem>x</span> True <span class=bound>s</span><span class=main>)</span> <span class=main>`</span> <span class=main>{</span><span class=bound>s</span><span class=main>.</span> fmdom' <span class=bound>s</span> <span class=main>=</span> <span class=skolem>F</span><span class=main>}</span> <span class=main>∪</span> <span class=main>(</span><span class=main>λ</span><span class=bound>s</span><span class=main>.</span> fmupd <span class=skolem>x</span> False <span class=bound>s</span><span class=main>)</span> <span class=main>`</span> <span class=main>{</span><span class=bound>s</span><span class=main>.</span> fmdom' <span class=bound>s</span> <span class=main>=</span> <span class=skolem>F</span><span class=main>}</span>
      "</span></span>
      <span class=keyword1><span class=command>using</span></span> False construction_of_all_possible_states_lemma
      <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> 2<span class=main>:</span> <span class=quoted><span class=quoted>"
        card <span class=main>(</span><span class=main>{</span><span class=bound>s</span> <span class=main>::</span> <span class=tfree>'a</span> state<span class=main>.</span> fmdom' <span class=bound>s</span> <span class=main>=</span> insert <span class=skolem>x</span> <span class=skolem>F</span><span class=main>}</span><span class=main>)</span>
        <span class=main>=</span> card <span class=main>(</span><span class=main>(</span><span class=main>λ</span><span class=bound>s</span><span class=main>.</span> fmupd <span class=skolem>x</span> True <span class=bound>s</span><span class=main>)</span> <span class=main>`</span> <span class=main>{</span><span class=bound>s</span><span class=main>.</span> fmdom' <span class=bound>s</span> <span class=main>=</span> <span class=skolem>F</span><span class=main>}</span> <span class=main>∪</span> <span class=main>(</span><span class=main>λ</span><span class=bound>s</span><span class=main>.</span> fmupd <span class=skolem>x</span> False <span class=bound>s</span><span class=main>)</span> <span class=main>`</span> <span class=main>{</span><span class=bound>s</span><span class=main>.</span> fmdom' <span class=bound>s</span> <span class=main>=</span> <span class=skolem>F</span><span class=main>}</span><span class=main>)</span>
      "</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>argo</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> 3<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=numeral>2</span><span class=main>^</span><span class=main>(</span>card <span class=main>(</span>insert <span class=skolem>x</span> <span class=skolem>F</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=numeral>2</span> <span class=main>*</span> <span class=numeral>2</span><span class=main>^</span><span class=main>(</span>card <span class=skolem>F</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> False insert.hyps<span class=main>(</span>1<span class=main>)</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span>
      <span class=quoted><span class=quoted>"card <span class=main>(</span><span class=main>(</span><span class=main>λ</span><span class=bound>s</span><span class=main>.</span> fmupd <span class=skolem>x</span> True <span class=bound>s</span><span class=main>)</span> <span class=main>`</span> <span class=main>{</span><span class=bound>s</span><span class=main>.</span> fmdom' <span class=bound>s</span> <span class=main>=</span> <span class=skolem>F</span><span class=main>}</span><span class=main>)</span> <span class=main>=</span> <span class=numeral>2</span><span class=main>^</span><span class=main>(</span>card <span class=skolem>F</span><span class=main>)</span>"</span></span>
      <span class=quoted><span class=quoted>"card <span class=main>(</span><span class=main>(</span><span class=main>λ</span><span class=bound>s</span><span class=main>.</span> fmupd <span class=skolem>x</span> False <span class=bound>s</span><span class=main>)</span> <span class=main>`</span> <span class=main>{</span><span class=bound>s</span><span class=main>.</span> fmdom' <span class=bound>s</span> <span class=main>=</span> <span class=skolem>F</span><span class=main>}</span><span class=main>)</span> <span class=main>=</span> <span class=numeral>2</span><span class=main>^</span><span class=main>(</span>card <span class=skolem>F</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> False card_update insert.IH insert.hyps<span class=main>(</span>1<span class=main>)</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span><span class=main><span class=keyword3>+</span></span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"
          <span class=main>(</span><span class=main>(</span><span class=main>λ</span><span class=bound>s</span><span class=main>.</span> fmupd <span class=skolem>x</span> True <span class=bound>s</span><span class=main>)</span> <span class=main>`</span> <span class=main>{</span><span class=bound>s</span><span class=main>.</span> fmdom' <span class=bound>s</span> <span class=main>=</span> <span class=skolem>F</span><span class=main>}</span><span class=main>)</span>
          <span class=main>∩</span> <span class=main>(</span><span class=main>(</span><span class=main>λ</span><span class=bound>s</span><span class=main>.</span> fmupd <span class=skolem>x</span> False <span class=bound>s</span><span class=main>)</span> <span class=main>`</span> <span class=main>{</span><span class=bound>s</span><span class=main>.</span> fmdom' <span class=bound>s</span> <span class=main>=</span> <span class=skolem>F</span><span class=main>}</span><span class=main>)</span>
        <span class=main>=</span> <span class=main>{}</span>
      "</span></span>
      <span class=keyword1><span class=command>using</span></span> False insert.hyps<span class=main>(</span>1<span class=main>)</span> updates_disjoint
      <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"card <span class=main>(</span>
          <span class=main>(</span><span class=main>(</span><span class=main>λ</span><span class=bound>s</span><span class=main>.</span> fmupd <span class=skolem>x</span> True <span class=bound>s</span><span class=main>)</span> <span class=main>`</span> <span class=main>{</span><span class=bound>s</span><span class=main>.</span> fmdom' <span class=bound>s</span> <span class=main>=</span> <span class=skolem>F</span><span class=main>}</span><span class=main>)</span>
          <span class=main>∪</span> <span class=main>(</span><span class=main>(</span><span class=main>λ</span><span class=bound>s</span><span class=main>.</span> fmupd <span class=skolem>x</span> False <span class=bound>s</span><span class=main>)</span> <span class=main>`</span> <span class=main>{</span><span class=bound>s</span><span class=main>.</span> fmdom' <span class=bound>s</span> <span class=main>=</span> <span class=skolem>F</span><span class=main>}</span><span class=main>)</span>
        <span class=main>)</span>
        <span class=main>=</span> card <span class=main>(</span><span class=main>(</span><span class=main>(</span><span class=main>λ</span><span class=bound>s</span><span class=main>.</span> fmupd <span class=skolem>x</span> True <span class=bound>s</span><span class=main>)</span> <span class=main>`</span> <span class=main>{</span><span class=bound>s</span><span class=main>.</span> fmdom' <span class=bound>s</span> <span class=main>=</span> <span class=skolem>F</span><span class=main>}</span><span class=main>)</span><span class=main>)</span>
          <span class=main>+</span> card <span class=main>(</span><span class=main>(</span><span class=main>λ</span><span class=bound>s</span><span class=main>.</span> fmupd <span class=skolem>x</span> False <span class=bound>s</span><span class=main>)</span> <span class=main>`</span> <span class=main>{</span><span class=bound>s</span><span class=main>.</span> fmdom' <span class=bound>s</span> <span class=main>=</span> <span class=skolem>F</span><span class=main>}</span><span class=main>)</span>
      "</span></span>
      <span class=keyword1><span class=command>using</span></span> calculation card_Un_disjoint card.infinite
        power_eq_0_iff rel_simps<span class=main>(</span>76<span class=main>)</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"card <span class=main>(</span>
          <span class=main>(</span><span class=main>(</span><span class=main>λ</span><span class=bound>s</span><span class=main>.</span> fmupd <span class=skolem>x</span> True <span class=bound>s</span><span class=main>)</span> <span class=main>`</span> <span class=main>{</span><span class=bound>s</span><span class=main>.</span> fmdom' <span class=bound>s</span> <span class=main>=</span> <span class=skolem>F</span><span class=main>}</span><span class=main>)</span>
          <span class=main>∪</span> <span class=main>(</span><span class=main>(</span><span class=main>λ</span><span class=bound>s</span><span class=main>.</span> fmupd <span class=skolem>x</span> False <span class=bound>s</span><span class=main>)</span> <span class=main>`</span> <span class=main>{</span><span class=bound>s</span><span class=main>.</span> fmdom' <span class=bound>s</span> <span class=main>=</span> <span class=skolem>F</span><span class=main>}</span><span class=main>)</span>
        <span class=main>)</span>
        <span class=main>=</span> <span class=numeral>2</span> <span class=main>*</span> <span class=main>(</span><span class=numeral>2</span><span class=main>^</span><span class=main>(</span>card <span class=skolem>F</span><span class=main>)</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> calculation<span class=main>(</span>1<span class=main>,</span> 2<span class=main>)</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>presburger</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"card <span class=main>(</span>
          <span class=main>(</span><span class=main>(</span><span class=main>λ</span><span class=bound>s</span><span class=main>.</span> fmupd <span class=skolem>x</span> True <span class=bound>s</span><span class=main>)</span> <span class=main>`</span> <span class=main>{</span><span class=bound>s</span><span class=main>.</span> fmdom' <span class=bound>s</span> <span class=main>=</span> <span class=skolem>F</span><span class=main>}</span><span class=main>)</span>
          <span class=main>∪</span> <span class=main>(</span><span class=main>(</span><span class=main>λ</span><span class=bound>s</span><span class=main>.</span> fmupd <span class=skolem>x</span> False <span class=bound>s</span><span class=main>)</span> <span class=main>`</span> <span class=main>{</span><span class=bound>s</span><span class=main>.</span> fmdom' <span class=bound>s</span> <span class=main>=</span> <span class=skolem>F</span><span class=main>}</span><span class=main>)</span>
        <span class=main>)</span>
        <span class=main>=</span> <span class=numeral>2</span><span class=main>^</span><span class=main>(</span>card <span class=main>(</span>insert <span class=skolem>x</span> <span class=skolem>F</span><span class=main>)</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> insert.IH 3
      <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>using</span></span> <span class=quoted>"2"</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>argo</span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1><span class=command>subsubsection</span></span> <span class=quoted><span class=plain_text>"State Lists and State Sets"</span></span>


<span class=comment1>― ‹NOTE using fun because of two defining equations.›</span>
<span class=comment1>― ‹NOTE paired argument replaced by currying.›</span>
<span class=keyword1><span class=command>fun</span></span> <span class=entity>state_list</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>state_list</span> <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=main>[]</span> <span class=main>=</span> <span class=main>[</span><span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>]</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>state_list</span> <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=main>(</span><span class=free><span class=bound><span class=entity>a</span></span></span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>as</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=main>#</span> <span class=free>state_list</span> <span class=main>(</span>state_succ <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=free><span class=bound><span class=entity>a</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>as</span></span></span>"</span></span>


<span class=keyword1 id=FactoredSystem-empty_state_list_lemma><span class=command>lemma</span></span> empty_state_list_lemma<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>as</span> <span class=free>s</span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span><span class=main>(</span><span class=main>[]</span> <span class=main>=</span> state_list <span class=free>s</span> <span class=free>as</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>as</span></span><span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span> <span class=operator>auto</span>


<span class=keyword1 id=FactoredSystem-state_list_length_non_zero><span class=command>lemma</span></span> state_list_length_non_zero<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>as</span> <span class=free>s</span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span><span class=main>(</span><span class=main>0</span> <span class=main>=</span> length <span class=main>(</span>state_list <span class=free>s</span> <span class=free>as</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>as</span></span><span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span> <span class=operator>auto</span>


<span class=keyword1 id=FactoredSystem-state_list_length_lemma><span class=command>lemma</span></span> state_list_length_lemma<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>as</span> <span class=free>s</span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"length <span class=free>as</span> <span class=main>=</span> length <span class=main>(</span>state_list <span class=free>s</span> <span class=free>as</span><span class=main>)</span> <span class=main>-</span> <span class=main>1</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>as</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>s</span></span><span class=main>)</span>
<span class=keyword1><span class=command>next</span></span> <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>a</span> <span class=skolem>as</span><span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"length <span class=main>(</span>state_list <span class=skolem>s</span> <span class=main>(</span>Cons <span class=skolem>a</span> <span class=skolem>as</span><span class=main>)</span><span class=main>)</span> <span class=main>-</span> <span class=main>1</span> <span class=main>=</span>  length <span class=main>(</span>state_list <span class=main>(</span>state_succ <span class=skolem>s</span> <span class=skolem>a</span><span class=main>)</span> <span class=skolem>as</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=comment1>― ‹TODO unwrap metis proof.›</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"length <span class=main>(</span>Cons <span class=skolem>a</span> <span class=skolem>as</span><span class=main>)</span> <span class=main>=</span> length <span class=main>(</span>state_list <span class=skolem>s</span> <span class=main>(</span>Cons <span class=skolem>a</span> <span class=skolem>as</span><span class=main>)</span><span class=main>)</span> <span class=main>-</span> <span class=main>1</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> Cons.IH Suc_diff_1 empty_state_list_lemma length_Cons length_greater_0_conv<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span> <span class=operator>simp</span>


<span class=keyword1 id=FactoredSystem-state_list_length_lemma_2><span class=command>lemma</span></span> state_list_length_lemma_2<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>as</span> <span class=free>s</span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>length <span class=main>(</span>state_list <span class=free>s</span> <span class=free>as</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span>length <span class=free>as</span> <span class=main>+</span> <span class=main>1</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>as</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>s</span></span><span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span> <span class=operator>auto</span>


<span class=comment1>― ‹NOTE using fun because of multiple defining equations.›</span>
<span class=comment1>― ‹NOTE name shortened to 'state\_def'›</span>
<span class=keyword1><span class=command>fun</span></span> <span class=entity>state_set</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>state_set</span> <span class=main>[]</span> <span class=main>=</span> <span class=main>{}</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>state_set</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>s</span></span></span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>ss</span></span></span><span class=main>)</span> <span class=main>=</span> insert <span class=main>[</span><span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>]</span> <span class=main>(</span>Cons <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=main>`</span> <span class=main>(</span><span class=free>state_set</span> <span class=free><span class=bound><span class=entity>ss</span></span></span><span class=main>)</span><span class=main>)</span>"</span></span>


<span class=keyword1 id=FactoredSystem-state_set_thm><span class=command>lemma</span></span> state_set_thm<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>s1</span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=free>s1</span> <span class=main>∈</span> state_set <span class=free>s2</span> <span class=main>⟷</span> prefix <span class=free>s1</span> <span class=free>s2</span> <span class=main>∧</span> <span class=free>s1</span> <span class=main>≠</span> <span class=main>[]</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=comment1>― ‹NOTE Show equivalence by proving both directions. Left-to-right is trivial. Right-to-Left
  primarily involves exploiting the prefix premise, induction hypothesis  and  `state\_set`
  definition.›</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>s1</span> <span class=main>∈</span> state_set <span class=free>s2</span> <span class=main>⟹</span> prefix <span class=free>s1</span> <span class=free>s2</span> <span class=main>∧</span> <span class=free>s1</span> <span class=main>≠</span> <span class=main>[]</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>s2</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>s1</span></span><span class=main>)</span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>assume</span></span> P<span class=main>:</span> <span class=quoted><span class=quoted>"prefix <span class=free>s1</span> <span class=free>s2</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>s1</span> <span class=main>≠</span> <span class=main>[]</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>s1</span> <span class=main>∈</span> state_set <span class=free>s2</span>"</span></span>
    <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>s2</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>s1</span></span><span class=main>)</span>
      <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>a</span> <span class=skolem>s2</span><span class=main>)</span>
      <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>s1'</span></span> <span class=keyword2><span class=keyword>where</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>s1</span> <span class=main>=</span> <span class=skolem>a</span> <span class=main>#</span> <span class=skolem>s1'</span>"</span></span> <span class=quoted><span class=quoted>"prefix <span class=skolem>s1'</span> <span class=skolem>s2</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>1<span class=main>,</span> 2<span class=main>)</span> prefix_Cons
        <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=skolem>s1'</span> <span class=main>=</span> <span class=main>[]</span>"</span></span><span class=main>)</span>
        <span class=keyword3><span class=command>case</span></span> True
        <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
          <span class=keyword1><span class=command>using</span></span> 1
          <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
      <span class=keyword1><span class=command>next</span></span>
        <span class=keyword3><span class=command>case</span></span> False
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>s1'</span> <span class=main>∈</span> state_set <span class=skolem>s2</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> 1 False Cons.IH
          <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
          <span class=keyword1><span class=command>using</span></span> 1
          <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
      <span class=keyword1><span class=command>qed</span></span>
    <span class=keyword1><span class=command>qed</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=free>s1</span> <span class=main>∈</span> state_set <span class=free>s2</span> <span class=main>⟷</span> prefix <span class=free>s1</span> <span class=free>s2</span> <span class=main>∧</span> <span class=free>s1</span> <span class=main>≠</span> <span class=main>[]</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1 id=FactoredSystem-state_set_finite><span class=command>lemma</span></span> state_set_finite<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>X</span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"finite <span class=main>(</span>state_set <span class=free>X</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>X</span></span><span class=main>)</span> <span class=operator>auto</span>


<span class=keyword1 id=FactoredSystem-LENGTH_state_set><span class=command>lemma</span></span> LENGTH_state_set<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>X</span> <span class=free>e</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>e</span> <span class=main>∈</span> state_set <span class=free>X</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"length <span class=free>e</span> <span class=main>≤</span> length <span class=free>X</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>X</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>e</span></span><span class=main>)</span> <span class=operator>auto</span>


<span class=keyword1 id=FactoredSystem-lemma_temp><span class=command>lemma</span></span> lemma_temp<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>x</span> <span class=free>s</span> <span class=free>as</span> <span class=free>h</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>∈</span> state_set <span class=main>(</span>state_list <span class=free>s</span> <span class=free>as</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"length <span class=main>(</span><span class=free>h</span> <span class=main>#</span> state_list <span class=free>s</span> <span class=free>as</span><span class=main>)</span> <span class=main>&gt;</span> length <span class=free>x</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms LENGTH_state_set le_imp_less_Suc
  <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>


<span class=keyword1 id=FactoredSystem-NIL_NOTIN_stateset><span class=command>lemma</span></span> NIL_NOTIN_stateset<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>X</span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>[]</span> <span class=main>∉</span> state_set <span class=free>X</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>X</span></span><span class=main>)</span> <span class=operator>auto</span>


<span class=comment1>― ‹NOTE added lemma.›</span>
<span class=keyword1 id=FactoredSystem-state_set_card_i><span class=command>lemma</span></span> state_set_card_i<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>X</span> <span class=free>a</span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>[</span><span class=free>a</span><span class=main>]</span> <span class=main>∉</span> <span class=main>(</span>Cons <span class=free>a</span> <span class=main>`</span> state_set <span class=free>X</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>X</span></span><span class=main>)</span> <span class=operator>auto</span>

<span class=comment1>― ‹NOTE added lemma.›</span>
<span class=keyword1 id=FactoredSystem-state_set_card_ii><span class=command>lemma</span></span> state_set_card_ii<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>X</span> <span class=free>a</span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"card <span class=main>(</span>Cons <span class=free>a</span> <span class=main>`</span> state_set <span class=free>X</span><span class=main>)</span> <span class=main>=</span> card <span class=main>(</span>state_set <span class=free>X</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"inj_on <span class=main>(</span>Cons <span class=free>a</span><span class=main>)</span> <span class=main>(</span>state_set <span class=free>X</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>using</span></span> card_image
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=comment1>― ‹NOTE added lemma.›</span>
<span class=keyword1 id=FactoredSystem-state_set_card_iii><span class=command>lemma</span></span> state_set_card_iii<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>X</span> <span class=free>a</span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"card <span class=main>(</span>state_set <span class=main>(</span><span class=free>a</span> <span class=main>#</span> <span class=free>X</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>1</span> <span class=main>+</span> card <span class=main>(</span>state_set <span class=free>X</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"card <span class=main>(</span>state_set <span class=main>(</span><span class=free>a</span> <span class=main>#</span> <span class=free>X</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> card <span class=main>(</span>insert <span class=main>[</span><span class=free>a</span><span class=main>]</span> <span class=main>(</span>Cons <span class=free>a</span> <span class=main>`</span> state_set <span class=free>X</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=comment1>― ‹TODO unwrap this metis step.›</span>
  <span class=keyword1><span class=command>also</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>…</span> <span class=main>=</span> <span class=main>1</span> <span class=main>+</span> card <span class=main>(</span>Cons <span class=free>a</span> <span class=main>`</span> state_set <span class=free>X</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> state_set_card_i
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> Suc_eq_plus1_left card_insert_disjoint finite_imageI state_set_finite<span class=main>)</span>
  <span class=keyword1><span class=command>also</span></span> <span class=keyword1><span class=command>have</span></span><span class=quoted><span class=quoted>"<span class=main>…</span> <span class=main>=</span> <span class=main>1</span> <span class=main>+</span> card <span class=main>(</span>state_set <span class=free>X</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> state_set_card_ii
    <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
  <span class=keyword1><span class=command>finally</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"card <span class=main>(</span>state_set <span class=main>(</span><span class=free>a</span> <span class=main>#</span> <span class=free>X</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>1</span> <span class=main>+</span> card <span class=main>(</span>state_set <span class=free>X</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=FactoredSystem-state_set_card><span class=command>lemma</span></span> state_set_card<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>X</span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"card <span class=main>(</span>state_set <span class=free>X</span><span class=main>)</span> <span class=main>=</span> length <span class=free>X</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>X</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>a</span> <span class=skolem>X</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"card <span class=main>(</span>state_set <span class=main>(</span><span class=skolem>a</span> <span class=main>#</span> <span class=skolem>X</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>1</span> <span class=main>+</span> card <span class=main>(</span>state_set <span class=skolem>X</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> state_set_card_iii
    <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>using</span></span> Cons
    <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
<span class=keyword1><span class=command>qed</span></span> <span class=operator>auto</span>


<span class=keyword1><span class=command>subsubsection</span></span> <span class=quoted><span class=plain_text>"Properties of Domain Changes During Plan Execution"</span></span>


<span class=keyword1 id=FactoredSystem-FDOM_state_succ><span class=command>lemma</span></span> FDOM_state_succ<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span> <span class=main>⊆</span> fmdom' <span class=free>s</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>fmdom' <span class=main>(</span>state_succ <span class=free>s</span> <span class=free>a</span><span class=main>)</span> <span class=main>=</span> fmdom' <span class=free>s</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> state_succ_def fmap_add_ltr_def
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>


<span class=keyword1 id=FactoredSystem-FDOM_state_succ_subset><span class=command>lemma</span></span> FDOM_state_succ_subset<span class=main>:</span>
  <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>state_succ <span class=free>s</span> <span class=free>a</span><span class=main>)</span> <span class=main>⊆</span> <span class=main>(</span>fmdom' <span class=free>s</span> <span class=main>∪</span> fmdom' <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> state_succ_def fmap_add_ltr_def
  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>


<span class=comment1>― ‹NOTE definition `qispl\_then` removed (was not being used).›</span>


<span class=keyword1 id=FactoredSystem-FDOM_eff_subset_FDOM_valid_states><span class=command>lemma</span></span> FDOM_eff_subset_FDOM_valid_states<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>p</span> <span class=free>e</span> <span class=free>s</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>p</span><span class=main>,</span> <span class=free>e</span><span class=main>)</span> <span class=main>∈</span> <span class=free>PROB</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>s</span> <span class=main>∈</span> valid_states <span class=free>PROB</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>fmdom' <span class=free>e</span> <span class=main>⊆</span> fmdom' <span class=free>s</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=free>e</span> <span class=main>⊆</span> action_dom <span class=free>p</span> <span class=free>e</span>"</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> action_dom_def
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>also</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>…</span> <span class=main>⊆</span> prob_dom <span class=free>PROB</span>"</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> action_dom_def prob_dom_def
      <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>)</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>finally</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=free>e</span> <span class=main>⊆</span> fmdom' <span class=free>s</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> assms
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> valid_states_def<span class=main>)</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=free>e</span> <span class=main>⊆</span> fmdom' <span class=free>s</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1 id=FactoredSystem-FDOM_eff_subset_FDOM_valid_states_pair><span class=command>lemma</span></span> FDOM_eff_subset_FDOM_valid_states_pair<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>a</span> <span class=free>s</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>a</span> <span class=main>∈</span> <span class=free>PROB</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>s</span> <span class=main>∈</span> valid_states <span class=free>PROB</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span> <span class=main>⊆</span> fmdom' <span class=free>s</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span> <span class=main>⊆</span> <span class=main>(</span><span class=main>λ</span><span class=main>(</span><span class=bound>s1</span><span class=main>,</span> <span class=bound>s2</span><span class=main>)</span><span class=main>.</span> action_dom <span class=bound>s1</span> <span class=bound>s2</span><span class=main>)</span> <span class=free>a</span>"</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> action_dom_def
      <span class=keyword1><span class=command>using</span></span> case_prod_beta
      <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
    <span class=keyword1><span class=command>also</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>…</span> <span class=main>⊆</span> prob_dom <span class=free>PROB</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>)</span> prob_dom_def Sup_upper
      <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
    <span class=keyword1><span class=command>finally</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span> <span class=main>⊆</span> fmdom' <span class=free>s</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>2<span class=main>)</span> valid_states_def
      <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1 id=FactoredSystem-FDOM_pre_subset_FDOM_valid_states><span class=command>lemma</span></span> FDOM_pre_subset_FDOM_valid_states<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>p</span> <span class=free>e</span> <span class=free>s</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>p</span><span class=main>,</span> <span class=free>e</span><span class=main>)</span> <span class=main>∈</span> <span class=free>PROB</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>s</span> <span class=main>∈</span> valid_states <span class=free>PROB</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=free>p</span> <span class=main>⊆</span> fmdom' <span class=free>s</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=free>p</span> <span class=main>⊆</span> <span class=main>(</span><span class=main>λ</span><span class=main>(</span><span class=bound>s1</span><span class=main>,</span> <span class=bound>s2</span><span class=main>)</span><span class=main>.</span> action_dom <span class=bound>s1</span> <span class=bound>s2</span><span class=main>)</span> <span class=main>(</span><span class=free>p</span><span class=main>,</span> <span class=free>e</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> action_dom_def
      <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
    <span class=keyword1><span class=command>also</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>…</span> <span class=main>⊆</span> prob_dom <span class=free>PROB</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>)</span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> Sup_upper pair_imageI prob_dom_def<span class=main>)</span>
    <span class=keyword1><span class=command>finally</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=free>p</span> <span class=main>⊆</span> fmdom' <span class=free>s</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>2<span class=main>)</span> valid_states_def
      <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1 id=FactoredSystem-FDOM_pre_subset_FDOM_valid_states_pair><span class=command>lemma</span></span> FDOM_pre_subset_FDOM_valid_states_pair<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>a</span> <span class=free>s</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>a</span> <span class=main>∈</span> <span class=free>PROB</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>s</span> <span class=main>∈</span> valid_states <span class=free>PROB</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>fst <span class=free>a</span><span class=main>)</span> <span class=main>⊆</span> fmdom' <span class=free>s</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>fst <span class=free>a</span><span class=main>)</span> <span class=main>⊆</span> <span class=main>(</span><span class=main>λ</span><span class=main>(</span><span class=bound>s1</span><span class=main>,</span> <span class=bound>s2</span><span class=main>)</span><span class=main>.</span> action_dom <span class=bound>s1</span> <span class=bound>s2</span><span class=main>)</span> <span class=free>a</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> action_dom_def
      <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
    <span class=keyword1><span class=command>also</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>…</span> <span class=main>⊆</span> prob_dom <span class=free>PROB</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>)</span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> Sup_upper pair_imageI prob_dom_def<span class=main>)</span>
    <span class=keyword1><span class=command>finally</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>fst <span class=free>a</span><span class=main>)</span> <span class=main>⊆</span> fmdom' <span class=free>s</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>2<span class=main>)</span> valid_states_def
      <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=comment1>― ‹TODO unwrap the simp proof.›</span>
<span class=keyword1 id=FactoredSystem-action_dom_subset_valid_states_FDOM><span class=command>lemma</span></span> action_dom_subset_valid_states_FDOM<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>p</span> <span class=free>e</span> <span class=free>s</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>p</span><span class=main>,</span> <span class=free>e</span><span class=main>)</span> <span class=main>∈</span> <span class=free>PROB</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>s</span> <span class=main>∈</span> valid_states <span class=free>PROB</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"action_dom <span class=free>p</span> <span class=free>e</span> <span class=main>⊆</span> fmdom' <span class=free>s</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> Sup_upper pair_imageI prob_dom_def valid_states_def<span class=main>)</span>


<span class=comment1>― ‹TODO unwrap the metis proof.›</span>
<span class=keyword1 id=FactoredSystem-FDOM_eff_subset_prob_dom><span class=command>lemma</span></span> FDOM_eff_subset_prob_dom<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>p</span> <span class=free>e</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>p</span><span class=main>,</span> <span class=free>e</span><span class=main>)</span> <span class=main>∈</span> <span class=free>PROB</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=free>e</span> <span class=main>⊆</span> prob_dom <span class=free>PROB</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> Sup_upper Un_subset_iff action_dom_def pair_imageI prob_dom_def<span class=main>)</span>


<span class=keyword1 id=FactoredSystem-FDOM_eff_subset_prob_dom_pair><span class=command>lemma</span></span> FDOM_eff_subset_prob_dom_pair<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>a</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>a</span> <span class=main>∈</span> <span class=free>PROB</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span> <span class=main>⊆</span> prob_dom <span class=free>PROB</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>)</span> FDOM_eff_subset_prob_dom surjective_pairing
  <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>


<span class=comment1>― ‹TODO unwrap metis proof.›</span>
<span class=keyword1 id=FactoredSystem-FDOM_pre_subset_prob_dom><span class=command>lemma</span></span> FDOM_pre_subset_prob_dom<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>p</span> <span class=free>e</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>p</span><span class=main>,</span> <span class=free>e</span><span class=main>)</span> <span class=main>∈</span> <span class=free>PROB</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=free>p</span> <span class=main>⊆</span> prob_dom <span class=free>PROB</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> <span class=main><span class=main>(</span></span>no_types<span class=main><span class=main>)</span></span> Sup_upper Un_subset_iff action_dom_def pair_imageI prob_dom_def<span class=main>)</span>


<span class=keyword1 id=FactoredSystem-FDOM_pre_subset_prob_dom_pair><span class=command>lemma</span></span> FDOM_pre_subset_prob_dom_pair<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>a</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>a</span> <span class=main>∈</span> <span class=free>PROB</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>fst <span class=free>a</span><span class=main>)</span> <span class=main>⊆</span> prob_dom <span class=free>PROB</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms FDOM_pre_subset_prob_dom surjective_pairing
  <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>


<span class=keyword1><span class=command>subsubsection</span></span> <span class=quoted><span class=plain_text>"Properties of Valid Plans"</span></span>


<span class=keyword1 id=FactoredSystem-valid_plan_valid_head><span class=command>lemma</span></span> valid_plan_valid_head<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>h</span> <span class=main>#</span> <span class=free>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>  <span class=quoted><span class=quoted>"<span class=free>h</span> <span class=main>∈</span> <span class=free>PROB</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms valid_plans_def
  <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>


<span class=keyword1 id=FactoredSystem-valid_plan_valid_tail><span class=command>lemma</span></span> valid_plan_valid_tail<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>h</span> <span class=main>#</span> <span class=free>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> valid_plans_def<span class=main>)</span>


<span class=comment1>― ‹TODO unwrap simp proof.›</span>
<span class=keyword1 id=FactoredSystem-valid_plan_pre_subset_prob_dom_pair><span class=command>lemma</span></span> valid_plan_pre_subset_prob_dom_pair<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>a</span><span class=main>.</span> ListMem <span class=bound>a</span> <span class=free>as</span> <span class=main>⟶</span> fmdom' <span class=main>(</span>fst <span class=bound>a</span><span class=main>)</span> <span class=main>⊆</span> <span class=main>(</span>prob_dom <span class=free>PROB</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> valid_plans_def
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> FDOM_pre_subset_prob_dom_pair ListMem_iff rev_subsetD valid_plans_def<span class=main>)</span>


<span class=keyword1 id=FactoredSystem-valid_append_valid_suff><span class=command>lemma</span></span> valid_append_valid_suff<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>as1</span> <span class=main>@</span> <span class=free>as2</span> <span class=main>∈</span> <span class=main>(</span>valid_plans <span class=free>PROB</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=free>as2</span> <span class=main>∈</span> <span class=main>(</span>valid_plans <span class=free>PROB</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> valid_plans_def<span class=main>)</span>


<span class=keyword1 id=FactoredSystem-valid_append_valid_pref><span class=command>lemma</span></span> valid_append_valid_pref<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>as1</span> <span class=main>@</span> <span class=free>as2</span> <span class=main>∈</span> <span class=main>(</span>valid_plans <span class=free>PROB</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=free>as1</span> <span class=main>∈</span> <span class=main>(</span>valid_plans <span class=free>PROB</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> valid_plans_def<span class=main>)</span>


<span class=keyword1 id=FactoredSystem-valid_pref_suff_valid_append><span class=command>lemma</span></span> valid_pref_suff_valid_append<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>as1</span> <span class=main>∈</span> <span class=main>(</span>valid_plans <span class=free>PROB</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>as2</span> <span class=main>∈</span> <span class=main>(</span>valid_plans <span class=free>PROB</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>as1</span> <span class=main>@</span> <span class=free>as2</span><span class=main>)</span> <span class=main>∈</span> <span class=main>(</span>valid_plans <span class=free>PROB</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> valid_plans_def<span class=main>)</span>


<span class=comment1>― ‹NOTE showcase (case split seems necessary for MP of IH but the original proof does not need it).›</span>
<span class=keyword1 id=FactoredSystem-MEM_statelist_FDOM><span class=command>lemma</span></span> MEM_statelist_FDOM<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=free>h</span> <span class=free>as</span> <span class=free>s0</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>s0</span> <span class=main>∈</span> <span class=main>(</span>valid_states <span class=free>PROB</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>as</span> <span class=main>∈</span> <span class=main>(</span>valid_plans <span class=free>PROB</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"ListMem <span class=free>h</span> <span class=main>(</span>state_list <span class=free>s0</span> <span class=free>as</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>fmdom' <span class=free>h</span> <span class=main>=</span> fmdom' <span class=free>s0</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>as</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>PROB</span></span> <span class=quoted><span class=free>h</span></span> <span class=quoted><span class=free>s0</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> Nil
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>h</span> <span class=main>=</span> <span class=skolem>s0</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Nil.prems<span class=main>(</span>3<span class=main>)</span> ListMem_iff
    <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>a</span> <span class=skolem>as</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=comment1>― ‹NOTE This case split seems necessary to be able to infer

          'ListMem h (state\_list (state\_succ s0 a) as)'

        which is required in order to apply MP to the induction hypothesis.›</span>
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=skolem>h</span> <span class=main>=</span> <span class=skolem>s0</span>"</span></span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> False
      <span class=comment1>― ‹TODO proof steps could be refactored into auxillary lemmas.›</span>
    <span class=keyword1><span class=command>{</span></span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a</span> <span class=main>∈</span> <span class=skolem>PROB</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>2<span class=main>)</span> valid_plan_valid_head
        <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>snd <span class=skolem>a</span><span class=main>)</span> <span class=main>⊆</span> fmdom' <span class=skolem>s0</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>1<span class=main>)</span> FDOM_eff_subset_FDOM_valid_states_pair
        <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>state_succ <span class=skolem>s0</span> <span class=skolem>a</span><span class=main>)</span> <span class=main>=</span> fmdom' <span class=skolem>s0</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> FDOM_state_succ<span class=main>[</span><span class=operator>of</span> <span class=main>_</span> <span class=quoted><span class=skolem>s0</span></span><span class=main>]</span> Cons.prems<span class=main>(</span>1<span class=main>)</span> valid_states_def
        <span class=keyword1><span class=command>by</span></span> <span class=operator>presburger</span>
    <span class=keyword1><span class=command>}</span></span>
    <span class=keyword1><span class=command>note</span></span> 1 <span class=main>=</span> this
    <span class=keyword1><span class=command>{</span></span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=skolem>s0</span> <span class=main>=</span> prob_dom <span class=skolem>PROB</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>1<span class=main>)</span> valid_states_def
        <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"state_succ <span class=skolem>s0</span> <span class=skolem>a</span> <span class=main>∈</span> valid_states <span class=skolem>PROB</span>"</span></span>
        <span class=keyword1><span class=command>unfolding</span></span> valid_states_def
        <span class=keyword1><span class=command>using</span></span> 1
        <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
    <span class=keyword1><span class=command>}</span></span>
    <span class=keyword1><span class=command>note</span></span> 2 <span class=main>=</span> this
    <span class=keyword1><span class=command>{</span></span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"ListMem <span class=skolem>h</span> <span class=main>(</span>state_list <span class=main>(</span>state_succ <span class=skolem>s0</span> <span class=skolem>a</span><span class=main>)</span> <span class=skolem>as</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>3<span class=main>)</span> False
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> ListMem_iff<span class=main>)</span>
    <span class=keyword1><span class=command>}</span></span>
    <span class=keyword1><span class=command>note</span></span> 3 <span class=main>=</span> this
    <span class=keyword1><span class=command>{</span></span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>as</span> <span class=main>∈</span> valid_plans <span class=skolem>PROB</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>2<span class=main>)</span> valid_plan_valid_tail
        <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=skolem>h</span> <span class=main>=</span> fmdom' <span class=main>(</span>state_succ <span class=skolem>s0</span> <span class=skolem>a</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> 1 2 3 Cons.IH<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"state_succ <span class=skolem>s0</span> <span class=skolem>a</span>"</span></span><span class=main>]</span>
        <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>}</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>using</span></span> 1
      <span class=keyword1><span class=command>by</span></span> <span class=operator>argo</span>
  <span class=keyword1><span class=command>qed</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=comment1>― ‹TODO unwrap metis proof.›</span>
<span class=keyword1 id=FactoredSystem-MEM_statelist_valid_state><span class=command>lemma</span></span> MEM_statelist_valid_state<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=free>h</span> <span class=free>as</span> <span class=free>s0</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>s0</span> <span class=main>∈</span> valid_states <span class=free>PROB</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span>"</span></span> <span class=quoted><span class=quoted>"ListMem <span class=free>h</span> <span class=main>(</span>state_list <span class=free>s0</span> <span class=free>as</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>h</span> <span class=main>∈</span> valid_states <span class=free>PROB</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> MEM_statelist_FDOM mem_Collect_eq valid_states_def<span class=main>)</span>


<span class=comment1>― ‹TODO refactor (characterization lemma for 'state\_succ').›</span>
<span class=comment1>― ‹TODO unwrap metis proof.›</span>
<span class=comment1>― ‹NOTE added lemma.›</span>
<span class=keyword1 id=FactoredSystem-lemma_1_i><span class=command>lemma</span></span> lemma_1_i<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>s</span> <span class=free>a</span> <span class=free>PROB</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>s</span> <span class=main>∈</span> valid_states <span class=free>PROB</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>a</span> <span class=main>∈</span> <span class=free>PROB</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"state_succ <span class=free>s</span> <span class=free>a</span> <span class=main>∈</span> valid_states <span class=free>PROB</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> FDOM_eff_subset_FDOM_valid_states_pair FDOM_state_succ mem_Collect_eq  valid_states_def<span class=main>)</span>

<span class=comment1>― ‹TODO unwrap smt proof.›</span>
<span class=comment1>― ‹NOTE added lemma.›</span>
<span class=keyword1 id=FactoredSystem-lemma_1_ii><span class=command>lemma</span></span> lemma_1_ii<span class=main>:</span>
  <span class=quoted><span class=quoted>"last <span class=main>`</span> <span class=main>(</span><span class=main>(#)</span> <span class=free>s</span> <span class=main>`</span> state_set <span class=main>(</span>state_list <span class=main>(</span>state_succ <span class=free>s</span> <span class=free>a</span><span class=main>)</span> <span class=free>as</span><span class=main>)</span><span class=main>)</span>
  <span class=main>=</span> last <span class=main>`</span> state_set <span class=main>(</span>state_list <span class=main>(</span>state_succ <span class=free>s</span> <span class=free>a</span><span class=main>)</span> <span class=free>as</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>smt</span> NIL_NOTIN_stateset image_cong image_image last_ConsR<span class=main>)</span>

<span class=keyword1 id=FactoredSystem-lemma_1><span class=command>lemma</span></span> lemma_1<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>as</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>(</span><span class=tfree>'a</span><span class=main>,</span> <span class=tfree>'b</span><span class=main>)</span> fmap <span class=main>×</span> <span class=main>(</span><span class=tfree>'a</span><span class=main>,</span> <span class=tfree>'b</span><span class=main>)</span> fmap<span class=main>)</span> list"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=free>PPROB</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>s</span> <span class=main>∈</span> valid_states <span class=free>PROB</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>(</span>last <span class=main>`</span> <span class=main>(</span>state_set <span class=main>(</span>state_list <span class=free>s</span> <span class=free>as</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>⊆</span> valid_states <span class=free>PROB</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>as</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>s</span></span> <span class=quoted><span class=free>PROB</span></span><span class=main>)</span>
  <span class=comment1>― ‹NOTE Base case simplifies to <span class=antiquoted><span class=antiquote>@{</span><span class=operator>term</span> <span class=quoted>"<span class=main>{</span><span class=free>s</span><span class=main>}</span> <span class=main>⊆</span> valid_states <span class=free>PROB</span>"</span><span class=antiquote>}</span></span> which itself follows directly from
    1st assumption.›</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>a</span> <span class=skolem>as</span><span class=main>)</span>
  <span class=keyword1><span class=command>text</span></span> <span class=quoted><span class=plain_text>‹ Split the 'insert' term produced by <span class=antiquoted><span class=antiquoted><span class=antiquote><span class=antiquote>@{</span></span><span class=operator><span class=operator>term</span></span> <span class=quoted><span class=quoted>"state_set <span class=main><span class=main>(</span></span>state_list <span class=skolem><span class=skolem>s</span></span> <span class=main><span class=main>(</span></span><span class=skolem><span class=skolem>a</span></span> <span class=main><span class=main>#</span></span> <span class=skolem><span class=skolem>as</span></span><span class=main><span class=main>)</span></span><span class=main><span class=main>)</span></span>"</span></span><span class=antiquote><span class=antiquote>}</span></span></span></span> and proof
      inclusion in 'valid\_states PROB' for both parts. ›</span></span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=comment1>― ‹NOTE Inclusion of the first subset follows from the induction premise by simplification.
      The inclusion of the second subset is shown by applying the induction hypothesis to
      `state\_succ s a` and some elementary set simplifications.›</span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"last <span class=main>[</span><span class=skolem>s</span><span class=main>]</span> <span class=main>∈</span> valid_states <span class=skolem>PROB</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>1<span class=main>)</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>{</span></span>
      <span class=keyword1><span class=command>{</span></span>
        <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a</span> <span class=main>∈</span> <span class=skolem>PROB</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>2<span class=main>)</span> valid_plan_valid_head
          <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"state_succ <span class=skolem>s</span> <span class=skolem>a</span> <span class=main>∈</span> valid_states <span class=skolem>PROB</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>1<span class=main>)</span> lemma_1_i
          <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>}</span></span>
      <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>as</span> <span class=main>∈</span> valid_plans <span class=skolem>PROB</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>2<span class=main>)</span> valid_plan_valid_tail
        <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>last <span class=main>`</span> state_set <span class=main>(</span>state_list <span class=main>(</span>state_succ <span class=skolem>s</span> <span class=skolem>a</span><span class=main>)</span> <span class=skolem>as</span><span class=main>)</span><span class=main>)</span> <span class=main>⊆</span> valid_states <span class=skolem>PROB</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span>  calculation Cons.IH<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"state_succ <span class=skolem>s</span> <span class=skolem>a</span>"</span></span><span class=main>]</span>
        <span class=keyword1><span class=command>by</span></span> <span class=operator>presburger</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>last <span class=main>`</span> <span class=main>(</span><span class=main>(#)</span> <span class=skolem>s</span> <span class=main>`</span> state_set <span class=main>(</span>state_list <span class=main>(</span>state_succ <span class=skolem>s</span> <span class=skolem>a</span><span class=main>)</span> <span class=skolem>as</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>⊆</span> valid_states <span class=skolem>PROB</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> lemma_1_ii
        <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
    <span class=keyword1><span class=command>}</span></span>
    <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span>
      <span class=quoted><span class=quoted>"<span class=main>(</span>last <span class=main>`</span> insert <span class=main>[</span><span class=skolem>s</span><span class=main>]</span> <span class=main>(</span><span class=main>(#)</span> <span class=skolem>s</span> <span class=main>`</span> state_set <span class=main>(</span>state_list <span class=main>(</span>state_succ <span class=skolem>s</span> <span class=skolem>a</span><span class=main>)</span> <span class=skolem>as</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>⊆</span> valid_states <span class=skolem>PROB</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
<span class=keyword1><span class=command>qed</span></span> <span class=operator>auto</span>


<span class=comment1>― ‹TODO unwrap metis proof.›</span>
<span class=keyword1 id=FactoredSystem-len_in_state_set_le_max_len><span class=command>lemma</span></span> len_in_state_set_le_max_len<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>as</span> <span class=free>x</span> <span class=free>PROB</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>s</span> <span class=main>∈</span> valid_states <span class=free>PROB</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span><span class=main>(</span><span class=free>as</span> <span class=main>=</span> <span class=main>[]</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>x</span> <span class=main>∈</span> state_set <span class=main>(</span>state_list <span class=free>s</span> <span class=free>as</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>length <span class=free>x</span> <span class=main>≤</span> <span class=main>(</span>Suc <span class=main>(</span>length <span class=free>as</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> LENGTH_state_set Suc_eq_plus1_left add.commute state_list_length_lemma_2<span class=main>)</span>


<span class=keyword1 id=FactoredSystem-card_state_set_cons><span class=command>lemma</span></span> card_state_set_cons<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>as</span> <span class=free>s</span> <span class=free>h</span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"
    <span class=main>(</span>card <span class=main>(</span>state_set <span class=main>(</span>state_list <span class=free>s</span> <span class=main>(</span><span class=free>h</span> <span class=main>#</span> <span class=free>as</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>
    <span class=main>=</span> Suc <span class=main>(</span>card <span class=main>(</span>state_set <span class=main>(</span>state_list <span class=main>(</span>state_succ <span class=free>s</span> <span class=free>h</span><span class=main>)</span> <span class=free>as</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>
  "</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> length_Cons state_list.simps<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span> state_set_card<span class=main>)</span>


<span class=keyword1 id=FactoredSystem-card_state_set><span class=command>lemma</span></span> card_state_set<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>as</span> <span class=free>s</span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>Suc <span class=main>(</span>length <span class=free>as</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> card <span class=main>(</span>state_set <span class=main>(</span>state_list <span class=free>s</span> <span class=free>as</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> state_list_length_lemma_2 state_set_card<span class=main>)</span>


<span class=keyword1 id=FactoredSystem-neq_mems_state_set_neq_len><span class=command>lemma</span></span> neq_mems_state_set_neq_len<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>as</span> <span class=free>x</span> <span class=free>y</span> <span class=free>s</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>∈</span> state_set <span class=main>(</span>state_list <span class=free>s</span> <span class=free>as</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>y</span> <span class=main>∈</span> state_set <span class=main>(</span>state_list <span class=free>s</span> <span class=free>as</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span><span class=main>(</span><span class=free>x</span> <span class=main>=</span> <span class=free>y</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span><span class=main>(</span>length <span class=free>x</span> <span class=main>=</span> length <span class=free>y</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>≠</span> <span class=main>[]</span>"</span></span> <span class=quoted><span class=quoted>"prefix <span class=free>x</span> <span class=main>(</span>state_list <span class=free>s</span> <span class=free>as</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>)</span> state_set_thm
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span><span class=main><span class=keyword3>+</span></span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>y</span> <span class=main>≠</span> <span class=main>[]</span>"</span></span> <span class=quoted><span class=quoted>"prefix <span class=free>y</span> <span class=main>(</span>state_list <span class=free>s</span> <span class=free>as</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>2<span class=main>)</span> state_set_thm
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span><span class=main><span class=keyword3>+</span></span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>3<span class=main>)</span> append_eq_append_conv prefixE
    <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=comment1>― ‹NOTE added definition (imported from pred\_setScript.sml:1562).›</span>
<span class=keyword1><span class=command>definition</span></span> <span class=entity>inj</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=tfree>'a</span> <span class=main>⇒</span> <span class=tfree>'b</span><span class=main>)</span> <span class=main>⇒</span> <span class=tfree>'a</span> set <span class=main>⇒</span> <span class=tfree>'b</span> set <span class=main>⇒</span> bool"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>inj</span> <span class=free><span class=bound><span class=entity>f</span></span></span> <span class=free><span class=bound><span class=entity>A</span></span></span> <span class=free><span class=bound><span class=entity>B</span></span></span> <span class=main>≡</span> <span class=main>(</span><span class=main>∀</span><span class=bound>x</span> <span class=main>∈</span> <span class=free><span class=bound><span class=entity>A</span></span></span><span class=main>.</span> <span class=free><span class=bound><span class=entity>f</span></span></span> <span class=bound>x</span> <span class=main>∈</span> <span class=free><span class=bound><span class=entity>B</span></span></span><span class=main>)</span> <span class=main>∧</span> inj_on <span class=free><span class=bound><span class=entity>f</span></span></span> <span class=free><span class=bound><span class=entity>A</span></span></span>"</span></span>


<span class=comment1>― ‹NOTE added lemma; refactored from `not\_eq\_last\_diff\_paths`.›</span>
<span class=keyword1 id=FactoredSystem-not_eq_last_diff_paths_i><span class=command>lemma</span></span> not_eq_last_diff_paths_i<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>s</span> <span class=free>as</span> <span class=free>PROB</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>s</span> <span class=main>∈</span> valid_states <span class=free>PROB</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>∈</span> state_set <span class=main>(</span>state_list <span class=free>s</span> <span class=free>as</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"last <span class=free>x</span> <span class=main>∈</span> valid_states <span class=free>PROB</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"last <span class=free>x</span> <span class=main>∈</span> last <span class=main>`</span> <span class=main>(</span>state_set <span class=main>(</span>state_list <span class=free>s</span> <span class=free>as</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>3<span class=main>)</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>,</span> 2<span class=main>)</span> lemma_1
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=FactoredSystem-not_eq_last_diff_paths_ii><span class=command>lemma</span></span> not_eq_last_diff_paths_ii<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>s</span> <span class=main>∈</span> valid_states <span class=free>PROB</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>¬</span><span class=main>(</span>inj <span class=main>(</span>last<span class=main>)</span> <span class=main>(</span>state_set <span class=main>(</span>state_list <span class=free>s</span> <span class=free>as</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>valid_states <span class=free>PROB</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>l1</span><span class=main>.</span> <span class=main>∃</span><span class=bound>l2</span><span class=main>.</span>
    <span class=bound>l1</span> <span class=main>∈</span> state_set <span class=main>(</span>state_list <span class=free>s</span> <span class=free>as</span><span class=main>)</span>
    <span class=main>∧</span> <span class=bound>l2</span> <span class=main>∈</span> state_set <span class=main>(</span>state_list <span class=free>s</span> <span class=free>as</span><span class=main>)</span>
    <span class=main>∧</span> last <span class=bound>l1</span> <span class=main>=</span> last <span class=bound>l2</span>
    <span class=main>∧</span> <span class=bound>l1</span> <span class=main>≠</span> <span class=bound>l2</span>
  "</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?S</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"state_set <span class=main>(</span>state_list <span class=free>s</span> <span class=free>as</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>¬</span><span class=main>(</span><span class=main>∀</span><span class=bound>x</span><span class=main>∈</span><span class=var>?S</span><span class=main>.</span> last <span class=bound>x</span> <span class=main>∈</span> valid_states <span class=free>PROB</span><span class=main>)</span> <span class=main>=</span> False"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>,</span> 2<span class=main>)</span> not_eq_last_diff_paths_i
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword1><span class=command>have</span></span>
      <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>¬</span><span class=main>(</span>inj <span class=main>(</span>last<span class=main>)</span> <span class=var>?S</span> <span class=main>(</span>valid_states <span class=free>PROB</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=main>¬</span><span class=main>(</span><span class=main>(</span><span class=main>∀</span><span class=bound>x</span><span class=main>∈</span><span class=var>?S</span><span class=main>.</span> <span class=main>∀</span><span class=bound>y</span><span class=main>∈</span><span class=var>?S</span><span class=main>.</span> last <span class=bound>x</span> <span class=main>=</span> last <span class=bound>y</span> <span class=main>⟶</span> <span class=bound>x</span> <span class=main>=</span> <span class=bound>y</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> inj_def inj_on_def
      <span class=keyword1><span class=command>using</span></span> 1
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"
        <span class=main>(</span><span class=main>¬</span><span class=main>(</span>inj <span class=main>(</span>last<span class=main>)</span> <span class=var>?S</span> <span class=main>(</span>valid_states <span class=free>PROB</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>
        <span class=main>=</span> <span class=main>(</span><span class=main>∃</span><span class=bound>x</span><span class=main>.</span> <span class=main>∃</span><span class=bound>y</span><span class=main>.</span> <span class=bound>x</span><span class=main>∈</span><span class=var>?S</span> <span class=main>∧</span> <span class=bound>y</span><span class=main>∈</span><span class=var>?S</span> <span class=main>∧</span> last <span class=bound>x</span> <span class=main>=</span> last <span class=bound>y</span> <span class=main>∧</span> <span class=bound>x</span> <span class=main>≠</span> <span class=bound>y</span><span class=main>)</span>
      "</span></span>
      <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>3<span class=main>)</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>3<span class=main>)</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=FactoredSystem-not_eq_last_diff_paths><span class=command>lemma</span></span> not_eq_last_diff_paths<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>as</span> <span class=free>PROB</span> <span class=free>s</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>s</span> <span class=main>∈</span> valid_states <span class=free>PROB</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>¬</span><span class=main>(</span>inj <span class=main>(</span>last<span class=main>)</span> <span class=main>(</span>state_set <span class=main>(</span>state_list <span class=free>s</span> <span class=free>as</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>valid_states <span class=free>PROB</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>slist_1</span> <span class=bound>slist_2</span><span class=main>.</span>
    <span class=main>(</span><span class=bound>slist_1</span> <span class=main>∈</span> state_set <span class=main>(</span>state_list <span class=free>s</span> <span class=free>as</span><span class=main>)</span><span class=main>)</span>
    <span class=main>∧</span> <span class=main>(</span><span class=bound>slist_2</span> <span class=main>∈</span> state_set <span class=main>(</span>state_list <span class=free>s</span> <span class=free>as</span><span class=main>)</span><span class=main>)</span>
    <span class=main>∧</span> <span class=main>(</span><span class=main>(</span>last <span class=bound>slist_1</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span>last <span class=bound>slist_2</span><span class=main>)</span><span class=main>)</span>
    <span class=main>∧</span> <span class=main>¬</span><span class=main>(</span>length <span class=bound>slist_1</span> <span class=main>=</span> length <span class=bound>slist_2</span><span class=main>)</span><span class=main>)</span>
  "</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>l1</span></span> <span class=skolem><span class=skolem>l2</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"
      <span class=skolem>l1</span> <span class=main>∈</span> state_set <span class=main>(</span>state_list <span class=free>s</span> <span class=free>as</span><span class=main>)</span>
      <span class=main>∧</span> <span class=skolem>l2</span> <span class=main>∈</span> state_set <span class=main>(</span>state_list <span class=free>s</span> <span class=free>as</span><span class=main>)</span>
      <span class=main>∧</span> last <span class=skolem>l1</span> <span class=main>=</span> last <span class=skolem>l2</span>
      <span class=main>∧</span> <span class=skolem>l1</span> <span class=main>≠</span> <span class=skolem>l2</span>
    "</span></span>
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>,</span> 2<span class=main>,</span> 3<span class=main>)</span> not_eq_last_diff_paths_ii
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>using</span></span> neq_mems_state_set_neq_len
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=comment1>― ‹NOTE this lemma was removed due to being redundant and being shadowed later on:

  lemma empty\_list\_nin\_state\_set›</span>


<span class=keyword1 id=FactoredSystem-nempty_sl_in_state_set><span class=command>lemma</span></span> nempty_sl_in_state_set<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>sl</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>sl</span> <span class=main>≠</span> <span class=main>[]</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=free>sl</span> <span class=main>∈</span> state_set <span class=free>sl</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms state_set_thm
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>


<span class=keyword1 id=FactoredSystem-empty_list_nin_state_set><span class=command>lemma</span></span> empty_list_nin_state_set<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>h</span> <span class=free>slist</span> <span class=free>as</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>h</span> <span class=main>#</span> <span class=free>slist</span><span class=main>)</span> <span class=main>∈</span> state_set <span class=main>(</span>state_list <span class=free>s</span> <span class=free>as</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>h</span> <span class=main>=</span> <span class=free>s</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>as</span></span><span class=main>)</span> <span class=operator>auto</span>


<span class=keyword1 id=FactoredSystem-cons_in_state_set_2><span class=command>lemma</span></span> cons_in_state_set_2<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>s</span> <span class=free>slist</span> <span class=free>h</span> <span class=free>t</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>slist</span> <span class=main>≠</span> <span class=main>[]</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>(</span><span class=free>s</span> <span class=main>#</span> <span class=free>slist</span><span class=main>)</span> <span class=main>∈</span> state_set <span class=main>(</span>state_list <span class=free>s</span> <span class=main>(</span><span class=free>h</span> <span class=main>#</span> <span class=free>t</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>slist</span> <span class=main>∈</span> state_set <span class=main>(</span>state_list <span class=main>(</span>state_succ <span class=free>s</span> <span class=free>h</span><span class=main>)</span> <span class=free>t</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>slist</span></span><span class=main>)</span> <span class=operator>auto</span>


<span class=comment1>― ‹TODO move up and replace 'FactoredSystem.lemma\_1\_i'?›</span>
<span class=keyword1 id=FactoredSystem-valid_action_valid_succ><span class=command>lemma</span></span> valid_action_valid_succ<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>h</span> <span class=main>∈</span> <span class=free>PROB</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>s</span> <span class=main>∈</span> valid_states <span class=free>PROB</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>state_succ <span class=free>s</span> <span class=free>h</span><span class=main>)</span> <span class=main>∈</span> valid_states <span class=free>PROB</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms lemma_1_i
  <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>


<span class=keyword1 id=FactoredSystem-in_state_set_imp_eq_exec_prefix><span class=command>lemma</span></span> in_state_set_imp_eq_exec_prefix<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>slist</span> <span class=free>as</span> <span class=free>PROB</span> <span class=free>s</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>as</span> <span class=main>≠</span> <span class=main>[]</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>slist</span> <span class=main>≠</span> <span class=main>[]</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>s</span> <span class=main>∈</span> valid_states <span class=free>PROB</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>slist</span> <span class=main>∈</span> state_set <span class=main>(</span>state_list <span class=free>s</span> <span class=free>as</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>as'</span><span class=main>.</span> <span class=main>(</span>prefix <span class=bound>as'</span> <span class=free>as</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span>exec_plan <span class=free>s</span> <span class=bound>as'</span> <span class=main>=</span> last <span class=free>slist</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span>length <span class=free>slist</span> <span class=main>=</span> Suc <span class=main>(</span>length <span class=bound>as'</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>slist</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>as</span></span> <span class=quoted><span class=free>s</span></span> <span class=quoted><span class=free>PROB</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> cons_1<span class=main>:</span> <span class=main>(</span>Cons <span class=skolem>a</span> <span class=skolem>slist</span><span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>s</span> <span class=main>#</span> <span class=skolem>slist</span> <span class=main>∈</span> state_set <span class=main>(</span>state_list <span class=skolem>s</span> <span class=skolem>as</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> cons_1.prems<span class=main>(</span>5<span class=main>)</span> empty_list_nin_state_set
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>using</span></span> cons_1
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=skolem>as</span></span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> cons_2<span class=main>:</span> <span class=main>(</span>Cons <span class=skolem>a'</span> <span class=skolem>R<span class=hidden>⇩</span><sub>a</sub><span class=hidden>⇩</span><sub>s</sub></span><span class=main>)</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> a<span class=main>:</span> <span class=quoted><span class=quoted>"state_succ <span class=skolem>s</span> <span class=skolem>a'</span> <span class=main>∈</span> valid_states <span class=skolem>PROB</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> cons_1.prems<span class=main>(</span>3<span class=main>,</span> 4<span class=main>)</span> valid_action_valid_succ valid_plan_valid_head
      <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> b<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>R<span class=hidden>⇩</span><sub>a</sub><span class=hidden>⇩</span><sub>s</sub></span> <span class=main>∈</span> valid_plans <span class=skolem>PROB</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> cons_1.prems<span class=main>(</span>4<span class=main>)</span> cons_2 valid_plan_valid_tail
      <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=skolem>slist</span></span><span class=main>)</span>
      <span class=keyword3><span class=command>case</span></span> Nil
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
        <span class=keyword1><span class=command>using</span></span> cons_1.prems<span class=main>(</span>5<span class=main>)</span> empty_list_nin_state_set
        <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>next</span></span>
      <span class=keyword3><span class=command>case</span></span> cons_3<span class=main>:</span> <span class=main>(</span>Cons <span class=skolem>a''</span> <span class=skolem>R<span class=hidden>⇩</span><sub>s</sub><span class=hidden>⇩</span><sub>l</sub><span class=hidden>⇩</span><sub>i</sub><span class=hidden>⇩</span><sub>s</sub><span class=hidden>⇩</span><sub>t</sub></span><span class=main>)</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> i<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>a''</span> <span class=main>#</span> <span class=skolem>R<span class=hidden>⇩</span><sub>s</sub><span class=hidden>⇩</span><sub>l</sub><span class=hidden>⇩</span><sub>i</sub><span class=hidden>⇩</span><sub>s</sub><span class=hidden>⇩</span><sub>t</sub></span> <span class=main>∈</span> state_set <span class=main>(</span>state_list <span class=main>(</span>state_succ <span class=skolem>s</span> <span class=skolem>a'</span><span class=main>)</span> <span class=skolem>R<span class=hidden>⇩</span><sub>a</sub><span class=hidden>⇩</span><sub>s</sub></span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> 1 cons_2 cons_in_state_set_2
        <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=skolem>R<span class=hidden>⇩</span><sub>a</sub><span class=hidden>⇩</span><sub>s</sub></span></span><span class=main>)</span>
        <span class=keyword3><span class=command>case</span></span> Nil
        <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
          <span class=keyword1><span class=command>using</span></span> i cons_2 cons_3
          <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword1><span class=command>next</span></span>
        <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>a'''</span> <span class=skolem>R<span class=hidden>⇩</span><sub>a</sub><span class=hidden>⇩</span><sub>s</sub>'</span><span class=main>)</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>as'</span></span> <span class=keyword2><span class=keyword>where</span></span>
          <span class=quoted><span class=quoted>"prefix <span class=skolem>as'</span> <span class=main>(</span><span class=skolem>a'''</span> <span class=main>#</span> <span class=skolem>R<span class=hidden>⇩</span><sub>a</sub><span class=hidden>⇩</span><sub>s</sub>'</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"exec_plan <span class=main>(</span>state_succ <span class=skolem>s</span> <span class=skolem>a'</span><span class=main>)</span> <span class=skolem>as'</span> <span class=main>=</span> last <span class=skolem>slist</span>"</span></span>
          <span class=quoted><span class=quoted>"length <span class=skolem>slist</span> <span class=main>=</span> Suc <span class=main>(</span>length <span class=skolem>as'</span><span class=main>)</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> cons_1.IH<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=skolem>a'''</span> <span class=main>#</span> <span class=skolem>R<span class=hidden>⇩</span><sub>a</sub><span class=hidden>⇩</span><sub>s</sub>'</span>"</span></span> <span class=quoted><span class=quoted>"state_succ <span class=skolem>s</span> <span class=skolem>a'</span>"</span></span> <span class=quoted><span class=skolem>PROB</span></span><span class=main>]</span>
          <span class=keyword1><span class=command>using</span></span> i a b cons_3
          <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
          <span class=keyword1><span class=command>using</span></span> Cons_prefix_Cons cons_2 cons_3 exec_plan.simps<span class=main>(</span>2<span class=main>)</span> last.simps length_Cons
            list.distinct<span class=main>(</span>1<span class=main>)</span> local.Cons
          <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
      <span class=keyword1><span class=command>qed</span></span>
    <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>qed</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>qed</span></span> <span class=operator>auto</span>


<span class=keyword1 id=FactoredSystem-eq_last_state_imp_append_nempty_as><span class=command>lemma</span></span> eq_last_state_imp_append_nempty_as<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>as</span> <span class=free>PROB</span> <span class=free>slist_1</span> <span class=free>slist_2</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>as</span> <span class=main>≠</span> <span class=main>[]</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>s</span> <span class=main>∈</span> valid_states <span class=free>PROB</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>slist_1</span> <span class=main>≠</span> <span class=main>[]</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>slist_2</span> <span class=main>≠</span> <span class=main>[]</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>slist_1</span> <span class=main>∈</span> state_set <span class=main>(</span>state_list <span class=free>s</span> <span class=free>as</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>slist_2</span> <span class=main>∈</span> state_set <span class=main>(</span>state_list <span class=free>s</span> <span class=free>as</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span><span class=main>(</span>length <span class=free>slist_1</span> <span class=main>=</span> length <span class=free>slist_2</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span>last <span class=free>slist_1</span> <span class=main>=</span> last <span class=free>slist_2</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>as1</span> <span class=bound>as2</span> <span class=bound>as3</span><span class=main>.</span>
    <span class=main>(</span><span class=bound>as1</span> <span class=main>@</span> <span class=bound>as2</span> <span class=main>@</span> <span class=bound>as3</span> <span class=main>=</span> <span class=free>as</span><span class=main>)</span>
    <span class=main>∧</span> <span class=main>(</span>exec_plan <span class=free>s</span> <span class=main>(</span><span class=bound>as1</span> <span class=main>@</span> <span class=bound>as2</span><span class=main>)</span> <span class=main>=</span> exec_plan <span class=free>s</span> <span class=bound>as1</span><span class=main>)</span>
    <span class=main>∧</span>  <span class=main>¬</span><span class=main>(</span><span class=bound>as2</span> <span class=main>=</span> <span class=main>[]</span><span class=main>)</span>
  <span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>as_1</span></span> <span class=keyword2><span class=keyword>where</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span>prefix <span class=skolem>as_1</span> <span class=free>as</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>exec_plan <span class=free>s</span> <span class=skolem>as_1</span> <span class=main>=</span> last <span class=free>slist_1</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"length <span class=free>slist_1</span> <span class=main>=</span> Suc <span class=main>(</span>length <span class=skolem>as_1</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>,</span> 2<span class=main>,</span> 3<span class=main>,</span> 4<span class=main>,</span> 6<span class=main>)</span> in_state_set_imp_eq_exec_prefix
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>as_2</span></span> <span class=keyword2><span class=keyword>where</span></span> 2<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span>prefix <span class=skolem>as_2</span> <span class=free>as</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>exec_plan <span class=free>s</span> <span class=skolem>as_2</span> <span class=main>=</span> last <span class=free>slist_2</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span>length <span class=free>slist_2</span><span class=main>)</span> <span class=main>=</span> Suc <span class=main>(</span>length <span class=skolem>as_2</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>,</span> 2<span class=main>,</span> 3<span class=main>,</span> 5<span class=main>,</span> 7<span class=main>)</span> in_state_set_imp_eq_exec_prefix
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"length <span class=skolem>as_1</span> <span class=main>≠</span> length <span class=skolem>as_2</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>8<span class=main>)</span> 1<span class=main>(</span>3<span class=main>)</span> 2<span class=main>(</span>3<span class=main>)</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>consider</span></span> <span class=main>(</span>i<span class=main>)</span> <span class=quoted><span class=quoted>"length <span class=skolem>as_1</span> <span class=main>&lt;</span> length <span class=skolem>as_2</span>"</span></span> <span class=main>|</span> <span class=main>(</span>ii<span class=main>)</span> <span class=quoted><span class=quoted>"length <span class=skolem>as_1</span> <span class=main>&gt;</span> length <span class=skolem>as_2</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> i
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"prefix <span class=skolem>as_1</span> <span class=skolem>as_2</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> 1<span class=main>(</span>1<span class=main>)</span> 2<span class=main>(</span>1<span class=main>)</span> len_gt_pref_is_pref
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>a</span></span> <span class=keyword2><span class=keyword>where</span></span> a1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>as_2</span> <span class=main>=</span> <span class=skolem>as_1</span> <span class=main>@</span> <span class=skolem>a</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> prefixE
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>b</span></span> <span class=keyword2><span class=keyword>where</span></span> b1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>as</span> <span class=main>=</span> <span class=skolem>as_2</span> <span class=main>@</span> <span class=skolem>b</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> prefixE 2<span class=main>(</span>1<span class=main>)</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?as1</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=skolem>as_1</span>"</span></span>
    <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?as2</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=skolem>a</span>"</span></span>
    <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?as3</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=skolem>b</span>"</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>as</span> <span class=main>=</span> <span class=var>?as1</span> <span class=main>@</span> <span class=var>?as2</span> <span class=main>@</span> <span class=var>?as3</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> a1 b1
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"exec_plan <span class=free>s</span> <span class=main>(</span><span class=var>?as1</span> <span class=main>@</span> <span class=var>?as2</span><span class=main>)</span> <span class=main>=</span> exec_plan <span class=free>s</span> <span class=var>?as1</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> 1<span class=main>(</span>2<span class=main>)</span> 2<span class=main>(</span>2<span class=main>)</span> a1 assms<span class=main>(</span>9<span class=main>)</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?as2</span> <span class=main>≠</span> <span class=main>[]</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> i a1
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> ii
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"prefix <span class=skolem>as_2</span> <span class=skolem>as_1</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> 1<span class=main>(</span>1<span class=main>)</span> 2<span class=main>(</span>1<span class=main>)</span> len_gt_pref_is_pref
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>a</span></span> <span class=keyword2><span class=keyword>where</span></span> a2<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>as_1</span> <span class=main>=</span> <span class=skolem>as_2</span> <span class=main>@</span> <span class=skolem>a</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> prefixE
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>b</span></span> <span class=keyword2><span class=keyword>where</span></span> b2<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>as</span> <span class=main>=</span> <span class=skolem>as_1</span> <span class=main>@</span> <span class=skolem>b</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> prefixE 1<span class=main>(</span>1<span class=main>)</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?as1</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=skolem>as_2</span>"</span></span>
    <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?as2</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=skolem>a</span>"</span></span>
    <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?as3</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=skolem>b</span>"</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>as</span> <span class=main>=</span> <span class=var>?as1</span> <span class=main>@</span> <span class=var>?as2</span> <span class=main>@</span> <span class=var>?as3</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> a2 b2
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"exec_plan <span class=free>s</span> <span class=main>(</span><span class=var>?as1</span> <span class=main>@</span> <span class=var>?as2</span><span class=main>)</span> <span class=main>=</span> exec_plan <span class=free>s</span> <span class=var>?as1</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> 1<span class=main>(</span>2<span class=main>)</span> 2<span class=main>(</span>2<span class=main>)</span> a2 assms<span class=main>(</span>9<span class=main>)</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?as2</span> <span class=main>≠</span> <span class=main>[]</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> ii a2
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1 id=FactoredSystem-FINITE_prob_dom><span class=command>lemma</span></span> FINITE_prob_dom<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"finite <span class=free>PROB</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>  <span class=quoted><span class=quoted>"finite <span class=main>(</span>prob_dom <span class=free>PROB</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>x</span>
    <span class=keyword3><span class=command>assume</span></span> P2<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> <span class=free>PROB</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>λ</span><span class=main>(</span><span class=bound>s1</span><span class=main>,</span> <span class=bound>s2</span><span class=main>)</span><span class=main>.</span> action_dom <span class=bound>s1</span> <span class=bound>s2</span><span class=main>)</span> <span class=skolem>x</span> <span class=main>=</span> fmdom' <span class=main>(</span>fst <span class=skolem>x</span><span class=main>)</span> <span class=main>∪</span> fmdom' <span class=main>(</span>snd <span class=skolem>x</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> action_dom_def case_prod_beta'<span class=main>)</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> 2<span class=main>:</span> <span class=quoted><span class=quoted>"finite <span class=main>(</span>fset <span class=main>(</span>fmdom <span class=main>(</span>fst <span class=skolem>x</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"finite <span class=main>(</span>fset <span class=main>(</span>fmdom <span class=main>(</span>snd <span class=skolem>x</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> 3<span class=main>:</span> <span class=quoted><span class=quoted>"fset <span class=main>(</span>fmdom <span class=main>(</span>fst <span class=skolem>x</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> fmdom' <span class=main>(</span>fst <span class=skolem>x</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"fset <span class=main>(</span>fmdom <span class=main>(</span>snd <span class=skolem>x</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> fmdom' <span class=main>(</span>snd <span class=skolem>x</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> fmdom'_alt_def<span class=main>)</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"finite <span class=main>(</span>fmdom' <span class=main>(</span>fst <span class=skolem>x</span><span class=main>)</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> 2 <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"finite <span class=main>(</span>fmdom' <span class=main>(</span>snd <span class=skolem>x</span><span class=main>)</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> 2 3 <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"finite <span class=main>(</span><span class=main>(</span><span class=main>λ</span><span class=main>(</span><span class=bound>s1</span><span class=main>,</span> <span class=bound>s2</span><span class=main>)</span><span class=main>.</span> action_dom <span class=bound>s1</span> <span class=bound>s2</span><span class=main>)</span> <span class=skolem>x</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> 1 2 3
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"finite <span class=main>(</span>prob_dom <span class=free>PROB</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> prob_dom_def
    <span class=keyword1><span class=command>using</span></span> assms
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1 id=FactoredSystem-CARD_valid_states><span class=command>lemma</span></span> CARD_valid_states<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"finite <span class=main>(</span><span class=free>PROB</span> <span class=main>::</span> <span class=tfree>'a</span> problem<span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>card <span class=main>(</span>valid_states <span class=free>PROB</span> <span class=main>::</span> <span class=tfree>'a</span> state set<span class=main>)</span> <span class=main>=</span> <span class=numeral>2</span> <span class=main>^</span> card <span class=main>(</span>prob_dom <span class=free>PROB</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"finite <span class=main>(</span>prob_dom <span class=free>PROB</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms FINITE_prob_dom
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>have</span></span><span class=quoted><span class=quoted>"<span class=main>(</span>card <span class=main>(</span>valid_states <span class=free>PROB</span> <span class=main>::</span> <span class=tfree>'a</span> state set<span class=main>)</span><span class=main>)</span> <span class=main>=</span> card <span class=main>{</span><span class=bound>s</span> <span class=main>::</span> <span class=tfree>'a</span> state<span class=main>.</span> fmdom' <span class=bound>s</span> <span class=main>=</span> prob_dom <span class=free>PROB</span><span class=main>}</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> valid_states_def
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>also</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>...</span>  <span class=main>=</span> <span class=numeral>2</span> <span class=main>^</span> <span class=main>(</span>card <span class=main>(</span>prob_dom <span class=free>PROB</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> 1 card_of_set_of_all_possible_states
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>finally</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=comment1>― ‹NOTE type of 'valid\_states PROB' has to be asserted to match 'FINITE\_states' in the proof.›</span>
<span class=keyword1 id=FactoredSystem-FINITE_valid_states><span class=command>lemma</span></span> FINITE_valid_states<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> problem"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"finite <span class=free>PROB</span> <span class=main>⟹</span> finite <span class=main>(</span><span class=main>(</span>valid_states <span class=free>PROB</span><span class=main>)</span> <span class=main>::</span> <span class=tfree>'a</span> state set<span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>PROB</span></span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> finite.induct<span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> emptyI
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"valid_states <span class=main>{}</span> <span class=main>=</span> <span class=main>{</span>fmempty<span class=main>}</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> valid_states_def prob_dom_def
    <span class=keyword1><span class=command>using</span></span> empty_domain_fmap_set
    <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>subst</span> <span class=quoted><span class=quoted>‹valid_states <span class=main>{}</span> <span class=main>=</span> <span class=main>{</span>fmempty<span class=main>}</span>›</span></span><span class=main>)</span> <span class=operator>auto</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>insertI <span class=skolem>A</span> <span class=skolem>a</span><span class=main>)</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"finite <span class=main>(</span>insert <span class=skolem>a</span> <span class=skolem>A</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"finite <span class=main>(</span>prob_dom <span class=main>(</span>insert <span class=skolem>a</span> <span class=skolem>A</span><span class=main>)</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> FINITE_prob_dom
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"finite <span class=main>{</span><span class=bound>s</span> <span class=main>::</span> <span class=tfree>'a</span> state<span class=main>.</span> fmdom' <span class=bound>s</span> <span class=main>=</span> prob_dom <span class=main>(</span>insert <span class=skolem>a</span> <span class=skolem>A</span><span class=main>)</span><span class=main>}</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> FINITE_states
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>unfolding</span></span> valid_states_def
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=comment1>― ‹NOTE type of 'PROB' had to be fixed for use of 'FINITE\_valid\_states'.›</span>
<span class=keyword1 id=FactoredSystem-lemma_2><span class=command>lemma</span></span> lemma_2<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> problem"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=free>as</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=tfree>'a</span> action<span class=main>)</span> list"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=free>s</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> state"</span></span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"finite <span class=free>PROB</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>s</span> <span class=main>∈</span> <span class=main>(</span>valid_states <span class=free>PROB</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>(</span>length <span class=free>as</span><span class=main>)</span> <span class=main>&gt;</span> <span class=main>(</span><span class=numeral>2</span> <span class=main>^</span> <span class=main>(</span>card <span class=main>(</span>fmdom' <span class=free>s</span><span class=main>)</span><span class=main>)</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>as1</span> <span class=bound>as2</span> <span class=bound>as3</span><span class=main>.</span>
    <span class=main>(</span><span class=bound>as1</span> <span class=main>@</span> <span class=bound>as2</span> <span class=main>@</span> <span class=bound>as3</span> <span class=main>=</span> <span class=free>as</span><span class=main>)</span>
    <span class=main>∧</span> <span class=main>(</span>exec_plan <span class=free>s</span> <span class=main>(</span><span class=bound>as1</span> <span class=main>@</span> <span class=bound>as2</span><span class=main>)</span> <span class=main>=</span> exec_plan <span class=free>s</span> <span class=bound>as1</span><span class=main>)</span>
    <span class=main>∧</span> <span class=main>¬</span><span class=main>(</span><span class=bound>as2</span> <span class=main>=</span> <span class=main>[]</span><span class=main>)</span>
  <span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Suc <span class=main>(</span>length <span class=free>as</span><span class=main>)</span> <span class=main>&gt;</span> <span class=numeral>2</span><span class=main>^</span><span class=main>(</span>card <span class=main>(</span>fmdom' <span class=free>s</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>4<span class=main>)</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>linarith</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"card <span class=main>(</span>state_set <span class=main>(</span>state_list <span class=free>s</span> <span class=free>as</span><span class=main>)</span><span class=main>)</span> <span class=main>&gt;</span> <span class=numeral>2</span><span class=main>^</span>card <span class=main>(</span>fmdom' <span class=free>s</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> card_state_set<span class=main>[</span><span class=operator>symmetric</span><span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=comment1>― ‹NOTE type of 'valid\_states PROB' had to be asserted to match 'FINITE\_valid\_states'.›</span>
    <span class=keyword1><span class=command>have</span></span> 2<span class=main>:</span> <span class=quoted><span class=quoted>"finite <span class=main>(</span>prob_dom <span class=free>PROB</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"finite <span class=main>(</span><span class=main>(</span>valid_states <span class=free>PROB</span><span class=main>)</span>  <span class=main>::</span> <span class=tfree>'a</span> state set<span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>)</span> FINITE_prob_dom FINITE_valid_states
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span><span class=main><span class=keyword3>+</span></span>
    <span class=keyword1><span class=command>have</span></span> 3<span class=main>:</span> <span class=quoted><span class=quoted>"fmdom' <span class=free>s</span> <span class=main>=</span> prob_dom <span class=free>PROB</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>2<span class=main>)</span> valid_states_def
      <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"card <span class=main>(</span><span class=main>(</span>valid_states <span class=free>PROB</span><span class=main>)</span> <span class=main>::</span> <span class=tfree>'a</span> state set<span class=main>)</span> <span class=main>=</span> <span class=numeral>2</span><span class=main>^</span>card <span class=main>(</span>fmdom' <span class=free>s</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>)</span> CARD_valid_states
      <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> 4<span class=main>:</span> <span class=quoted><span class=quoted>"card <span class=main>(</span>state_set <span class=main>(</span>state_list <span class=main>(</span><span class=free>s</span> <span class=main>::</span> <span class=tfree>'a</span> state<span class=main>)</span> <span class=free>as</span><span class=main>)</span><span class=main>)</span> <span class=main>&gt;</span> card <span class=main>(</span><span class=main>(</span>valid_states <span class=free>PROB</span><span class=main>)</span> <span class=main>::</span> <span class=tfree>'a</span> state set<span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> valid_states_def
      <span class=keyword1><span class=command>using</span></span> 1 2<span class=main>(</span>1<span class=main>)</span> 3 card_of_set_of_all_possible_states<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"prob_dom <span class=free>PROB</span>"</span></span><span class=main>]</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>argo</span>
        <span class=comment1>― ‹TODO refactor into lemma.›</span>
    <span class=keyword1><span class=command>{</span></span>
      <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?S</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"state_set <span class=main>(</span>state_list <span class=main>(</span><span class=free>s</span> <span class=main>::</span> <span class=tfree>'a</span> state<span class=main>)</span> <span class=free>as</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?T</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"valid_states <span class=free>PROB</span> <span class=main>::</span> <span class=tfree>'a</span> state set"</span></span>
      <span class=keyword3><span class=command>assume</span></span> C2<span class=main>:</span> <span class=quoted><span class=quoted>"inj_on last <span class=var>?S</span>"</span></span>
        <span class=comment1>― ‹TODO unwrap the metis step or refactor into lemma.›</span>
      <span class=keyword1><span class=command>have</span></span> a<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=var>?T</span> <span class=main>⊆</span> last <span class=main>`</span> <span class=var>?S</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> C2
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> <span class=quoted>"2"</span><span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span> <span class=quoted>"4"</span> assms<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span> assms<span class=main><span class=main>(</span></span>3<span class=main><span class=main>)</span></span> card_image card_mono lemma_1 not_less<span class=main>)</span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"finite <span class=main>(</span>state_set <span class=main>(</span>state_list <span class=free>s</span> <span class=free>as</span><span class=main>)</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> state_set_finite
        <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"card <span class=main>(</span>last <span class=main>`</span> <span class=var>?S</span><span class=main>)</span> <span class=main>=</span> card <span class=var>?S</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> C2 inj_on_iff_eq_card
        <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>also</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>…</span> <span class=main>&gt;</span> card <span class=var>?T</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> 4
        <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>x</span><span class=main>.</span> <span class=bound>x</span> <span class=main>∈</span> <span class=main>(</span>last <span class=main>`</span> <span class=var>?S</span><span class=main>)</span> <span class=main>∧</span> <span class=bound>x</span> <span class=main>∉</span> <span class=var>?T</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> C2 a assms<span class=main>(</span>2<span class=main>)</span> assms<span class=main>(</span>3<span class=main>)</span> calculation lemma_1
        <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
    <span class=keyword1><span class=command>}</span></span>
    <span class=keyword1><span class=command>note</span></span> 5 <span class=main>=</span> this
    <span class=keyword1><span class=command>moreover</span></span>
    <span class=keyword1><span class=command>{</span></span>
      <span class=keyword3><span class=command>assume</span></span> C<span class=main>:</span> <span class=quoted><span class=quoted>"inj last <span class=main>(</span>state_set <span class=main>(</span>state_list <span class=main>(</span><span class=free>s</span> <span class=main>::</span> <span class=tfree>'a</span> state<span class=main>)</span> <span class=free>as</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>valid_states <span class=free>PROB</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"inj_on last <span class=main>(</span>state_set <span class=main>(</span>state_list <span class=main>(</span><span class=free>s</span> <span class=main>::</span> <span class=tfree>'a</span> state<span class=main>)</span> <span class=free>as</span><span class=main>)</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> C inj_def
        <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>x</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> last <span class=main>`</span> <span class=main>(</span>state_set <span class=main>(</span>state_list <span class=free>s</span> <span class=free>as</span><span class=main>)</span><span class=main>)</span> <span class=main>∧</span> <span class=skolem>x</span> <span class=main>∉</span> valid_states <span class=free>PROB</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> 5
        <span class=keyword1><span class=command>by</span></span> <span class=operator>presburger</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span><span class=main>(</span><span class=main>∀</span><span class=bound>x</span><span class=main>∈</span>state_set <span class=main>(</span>state_list <span class=free>s</span> <span class=free>as</span><span class=main>)</span><span class=main>.</span> last <span class=bound>x</span> <span class=main>∈</span> valid_states <span class=free>PROB</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span>inj last <span class=main>(</span>state_set <span class=main>(</span>state_list <span class=main>(</span><span class=free>s</span> <span class=main>::</span> <span class=tfree>'a</span> state<span class=main>)</span> <span class=free>as</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>valid_states <span class=free>PROB</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> inj_def
        <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted>False</span>
        <span class=keyword1><span class=command>using</span></span> C
        <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>}</span></span>
    <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span>inj last <span class=main>(</span>state_set <span class=main>(</span>state_list <span class=main>(</span><span class=free>s</span> <span class=main>::</span> <span class=tfree>'a</span> state<span class=main>)</span> <span class=free>as</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>valid_states <span class=free>PROB</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> inj_def
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>slist_1</span></span> <span class=skolem><span class=skolem>slist_2</span></span> <span class=keyword2><span class=keyword>where</span></span> 6<span class=main>:</span>
    <span class=quoted><span class=quoted>"<span class=skolem>slist_1</span> <span class=main>∈</span> state_set <span class=main>(</span>state_list <span class=free>s</span> <span class=free>as</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=skolem>slist_2</span> <span class=main>∈</span> state_set <span class=main>(</span>state_list <span class=free>s</span> <span class=free>as</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span>last <span class=skolem>slist_1</span> <span class=main>=</span> last <span class=skolem>slist_2</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"length <span class=skolem>slist_1</span> <span class=main>≠</span> length <span class=skolem>slist_2</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>2<span class=main>,</span> 3<span class=main>)</span> not_eq_last_diff_paths
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=free>as</span></span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> Nil
    <span class=keyword1><span class=command>text</span></span> <span class=quoted><span class=plain_text>‹ 4th assumption is violated in the 'Nil' case. ›</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span><span class=main>(</span><span class=numeral>2</span> <span class=main>^</span> card <span class=main>(</span>fmdom' <span class=free>s</span><span class=main>)</span> <span class=main>-</span> <span class=main>1</span> <span class=main>&lt;</span> length <span class=free>as</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> Nil
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>4<span class=main>)</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>a</span> <span class=skolem>list</span><span class=main>)</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>as</span> <span class=main>≠</span> <span class=main>[]</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>slist_1</span> <span class=main>≠</span> <span class=main>[]</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>slist_2</span> <span class=main>≠</span> <span class=main>[]</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> 6<span class=main>(</span>1<span class=main>,</span> 2<span class=main>)</span> NIL_NOTIN_stateset
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span><span class=main><span class=keyword3>+</span></span>
    <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>2<span class=main>,</span> 3<span class=main>)</span> 6<span class=main>(</span>1<span class=main>,</span> 2<span class=main>,</span> 3<span class=main>,</span> 4<span class=main>)</span> eq_last_state_imp_append_nempty_as
      <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1 id=FactoredSystem-lemma_2_prob_dom><span class=command>lemma</span></span> lemma_2_prob_dom<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=keyword2><span class=keyword>and</span></span> <span class=free>as</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=tfree>'a</span> action<span class=main>)</span> list"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=free>s</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> state"</span></span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"finite <span class=free>PROB</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>s</span> <span class=main>∈</span> valid_states <span class=free>PROB</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span>length <span class=free>as</span> <span class=main>&gt;</span> <span class=main>(</span><span class=numeral>2</span> <span class=main>^</span> <span class=main>(</span>card <span class=main>(</span>prob_dom <span class=free>PROB</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>as1</span> <span class=bound>as2</span> <span class=bound>as3</span><span class=main>.</span>
    <span class=main>(</span><span class=bound>as1</span> <span class=main>@</span> <span class=bound>as2</span> <span class=main>@</span> <span class=bound>as3</span> <span class=main>=</span> <span class=free>as</span><span class=main>)</span>
    <span class=main>∧</span> <span class=main>(</span>exec_plan <span class=free>s</span> <span class=main>(</span><span class=bound>as1</span> <span class=main>@</span> <span class=bound>as2</span><span class=main>)</span> <span class=main>=</span> exec_plan <span class=free>s</span> <span class=bound>as1</span><span class=main>)</span>
    <span class=main>∧</span> <span class=main>¬</span><span class=main>(</span><span class=bound>as2</span> <span class=main>=</span> <span class=main>[]</span><span class=main>)</span>
  <span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"prob_dom <span class=free>PROB</span> <span class=main>=</span> fmdom' <span class=free>s</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>2<span class=main>)</span> valid_states_def
    <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=numeral>2</span> <span class=main>^</span> card <span class=main>(</span>fmdom' <span class=free>s</span><span class=main>)</span> <span class=main>-</span> <span class=main>1</span> <span class=main>&lt;</span> length <span class=free>as</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>4<span class=main>)</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>argo</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>,</span> 2<span class=main>,</span> 3<span class=main>)</span> lemma_2
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=comment1>― ‹NOTE type for `s` had to be fixed (type mismatch in obtain statement).›</span>
<span class=comment1>― ‹NOTE type for `as1`, `as2` and `as3` had to be fixed (due type mismatch on `as1` in
`cycle\_removal\_lemma`)›</span>
<span class=keyword1 id=FactoredSystem-lemma_3><span class=command>lemma</span></span> lemma_3<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> problem"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=free>s</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> state"</span></span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"finite <span class=free>PROB</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>s</span> <span class=main>∈</span> valid_states <span class=free>PROB</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span>length <span class=free>as</span> <span class=main>&gt;</span> <span class=main>(</span><span class=numeral>2</span> <span class=main>^</span> <span class=main>(</span>card <span class=main>(</span>prob_dom <span class=free>PROB</span><span class=main>)</span><span class=main>)</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>as'</span><span class=main>.</span>
    <span class=main>(</span>exec_plan <span class=free>s</span> <span class=free>as</span> <span class=main>=</span> exec_plan <span class=free>s</span> <span class=bound>as'</span><span class=main>)</span>
    <span class=main>∧</span> <span class=main>(</span>length <span class=bound>as'</span> <span class=main>&lt;</span> length <span class=free>as</span><span class=main>)</span>
    <span class=main>∧</span> <span class=main>(</span>subseq <span class=bound>as'</span> <span class=free>as</span><span class=main>)</span>
  <span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"prob_dom <span class=free>PROB</span> <span class=main>=</span> fmdom' <span class=free>s</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>2<span class=main>)</span> valid_states_def
    <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=numeral>2</span> <span class=main>^</span> card <span class=main>(</span>fmdom' <span class=free>s</span><span class=main>)</span> <span class=main>-</span> <span class=main>1</span> <span class=main>&lt;</span> length <span class=free>as</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>4<span class=main>)</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>argo</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>as1</span></span> <span class=skolem><span class=skolem>as2</span></span> <span class=skolem><span class=skolem>as3</span></span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> action list"</span></span> <span class=keyword2><span class=keyword>where</span></span> 1<span class=main>:</span>
    <span class=quoted><span class=quoted>"<span class=skolem>as1</span> <span class=main>@</span> <span class=skolem>as2</span> <span class=main>@</span> <span class=skolem>as3</span> <span class=main>=</span> <span class=free>as</span>"</span></span> <span class=quoted><span class=quoted>"exec_plan <span class=free>s</span> <span class=main>(</span><span class=skolem>as1</span> <span class=main>@</span> <span class=skolem>as2</span><span class=main>)</span> <span class=main>=</span> exec_plan <span class=free>s</span> <span class=skolem>as1</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>as2</span> <span class=main>≠</span> <span class=main>[]</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>,</span> 2<span class=main>,</span> 3<span class=main>)</span> lemma_2
    <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
  <span class=keyword1><span class=command>have</span></span> 2<span class=main>:</span> <span class=quoted><span class=quoted>"exec_plan <span class=free>s</span> <span class=main>(</span><span class=skolem>as1</span> <span class=main>@</span> <span class=skolem>as3</span><span class=main>)</span> <span class=main>=</span> exec_plan <span class=free>s</span> <span class=main>(</span><span class=skolem>as1</span> <span class=main>@</span> <span class=skolem>as2</span> <span class=main>@</span> <span class=skolem>as3</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> 1 cycle_removal_lemma
    <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?as'</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"<span class=skolem>as1</span> <span class=main>@</span> <span class=skolem>as3</span>"</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"exec_plan <span class=free>s</span> <span class=free>as</span> <span class=main>=</span> exec_plan <span class=free>s</span> <span class=var>?as'</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> 1 2
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"length <span class=var>?as'</span> <span class=main>&lt;</span> length <span class=free>as</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> 1 nempty_list_append_length_add
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"subseq <span class=var>?as'</span> <span class=free>as</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> 1 subseq_append'
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>as'</span><span class=main>.</span>
      <span class=main>(</span>exec_plan <span class=free>s</span> <span class=free>as</span> <span class=main>=</span> exec_plan <span class=free>s</span> <span class=bound>as'</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span>length <span class=bound>as'</span> <span class=main>&lt;</span> length <span class=free>as</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span>subseq <span class=bound>as'</span> <span class=free>as</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=comment1>― ‹TODO unwrap meson step.›</span>
<span class=keyword1 id=FactoredSystem-sublist_valid_is_valid><span class=command>lemma</span></span> sublist_valid_is_valid<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>as'</span> <span class=free>as</span> <span class=free>PROB</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>subseq <span class=free>as'</span> <span class=free>as</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=free>as'</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> valid_plans_def<span class=main>)</span> <span class=main>(</span><span class=operator>meson</span> dual_order.trans fset_of_list_subset sublist_subset<span class=main>)</span>


<span class=comment1>― ‹NOTE type of 's' had to be fixed (type mismatch in goal).›</span>
<span class=keyword1><span class=command>theorem</span></span> main_lemma<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> problem"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=free>as</span> <span class=free>s</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"finite <span class=free>PROB</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>s</span> <span class=main>∈</span> valid_states <span class=free>PROB</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>as'</span><span class=main>.</span>
    <span class=main>(</span>exec_plan <span class=free>s</span> <span class=free>as</span> <span class=main>=</span> exec_plan <span class=free>s</span> <span class=bound>as'</span><span class=main>)</span>
    <span class=main>∧</span> <span class=main>(</span>subseq <span class=bound>as'</span> <span class=free>as</span><span class=main>)</span>
    <span class=main>∧</span> <span class=main>(</span>length  <span class=bound>as'</span> <span class=main>≤</span> <span class=main>(</span><span class=numeral>2</span> <span class=main>^</span> <span class=main>(</span>card <span class=main>(</span>prob_dom <span class=free>PROB</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span>
  <span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"length <span class=free>as</span> <span class=main>≤</span> <span class=main>(</span><span class=numeral>2</span> <span class=main>^</span> <span class=main>(</span>card <span class=main>(</span>prob_dom <span class=free>PROB</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>-</span> <span class=main>1</span>"</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> True
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"exec_plan <span class=free>s</span> <span class=free>as</span> <span class=main>=</span> exec_plan <span class=free>s</span> <span class=free>as</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"subseq <span class=free>as</span> <span class=free>as</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"length <span class=free>as</span> <span class=main>≤</span> <span class=main>(</span><span class=numeral>2</span><span class=main>^</span><span class=main>(</span>card <span class=main>(</span>prob_dom <span class=free>PROB</span><span class=main>)</span><span class=main>)</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> True
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> False
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"length <span class=free>as</span> <span class=main>&gt;</span> <span class=main>(</span><span class=numeral>2</span> <span class=main>^</span> <span class=main>(</span>card <span class=main>(</span>prob_dom <span class=free>PROB</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>-</span> <span class=main>1</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> False
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>as'</span></span> <span class=keyword2><span class=keyword>where</span></span> 1<span class=main>:</span>
    <span class=quoted><span class=quoted>"exec_plan <span class=free>s</span> <span class=free>as</span> <span class=main>=</span> exec_plan <span class=free>s</span> <span class=skolem>as'</span>"</span></span> <span class=quoted><span class=quoted>"length <span class=skolem>as'</span> <span class=main>&lt;</span> length <span class=free>as</span>"</span></span> <span class=quoted><span class=quoted>"subseq <span class=skolem>as'</span> <span class=free>as</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms lemma_3
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>p</span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"exec_plan <span class=free>s</span> <span class=free>as</span> <span class=main>=</span> exec_plan <span class=free>s</span> <span class=skolem>p</span>"</span></span> <span class=quoted><span class=quoted>"subseq <span class=skolem>p</span> <span class=free>as</span>"</span></span>
      <span class=quoted><span class=quoted>"<span class=numeral>2</span> <span class=main>^</span> card <span class=main>(</span>prob_dom <span class=free>PROB</span><span class=main>)</span> <span class=main>-</span> <span class=main>1</span> <span class=main>&lt;</span> length <span class=skolem>p</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>p'</span><span class=main>.</span> <span class=main>(</span>exec_plan <span class=free>s</span> <span class=free>as</span> <span class=main>=</span> exec_plan <span class=free>s</span> <span class=bound>p'</span> <span class=main>∧</span> subseq <span class=bound>p'</span> <span class=free>as</span><span class=main>)</span> <span class=main>∧</span> length <span class=bound>p'</span> <span class=main>&lt;</span> length <span class=skolem>p</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>,</span> 2<span class=main>,</span> 3<span class=main>)</span> lemma_3 sublist_valid_is_valid
      <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>p</span><span class=main>.</span> exec_plan <span class=free>s</span> <span class=free>as</span> <span class=main>=</span> exec_plan <span class=free>s</span> <span class=bound>p</span> <span class=main>∧</span> subseq <span class=bound>p</span> <span class=free>as</span> <span class=main>⟶</span>
      <span class=main>(</span><span class=main>∃</span><span class=bound>p'</span><span class=main>.</span> <span class=main>(</span>exec_plan <span class=free>s</span> <span class=free>as</span> <span class=main>=</span> exec_plan <span class=free>s</span> <span class=bound>p'</span> <span class=main>∧</span> subseq <span class=bound>p'</span> <span class=free>as</span><span class=main>)</span>
      <span class=main>∧</span> length <span class=bound>p'</span> <span class=main>≤</span> <span class=numeral>2</span> <span class=main>^</span> card <span class=main>(</span>prob_dom <span class=free>PROB</span><span class=main>)</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> general_theorem<span class=main>[</span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span>
        P <span class=main><span class=main>=</span></span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=main>(</span><span class=bound>as''</span> <span class=main>::</span> <span class=tfree>'a</span> action list<span class=main>)</span><span class=main>.</span> <span class=main>(</span>exec_plan <span class=free>s</span> <span class=free>as</span> <span class=main>=</span> exec_plan <span class=free>s</span> <span class=bound>as''</span><span class=main>)</span> <span class=main>∧</span> subseq <span class=bound>as''</span> <span class=free>as</span>"</span></span>
        <span class=keyword2><span class=keyword><span class=quasi_keyword>and</span></span></span> l <span class=main><span class=main>=</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=numeral>2</span> <span class=main>^</span> <span class=main>(</span>card <span class=main>(</span>prob_dom <span class=main>(</span><span class=free>PROB</span> <span class=main>::</span><span class=tfree>'a</span> problem<span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>-</span> <span class=main>1</span>"</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>and</span></span></span> f <span class=main><span class=main>=</span></span> <span class=quoted>length</span><span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>p'</span></span> <span class=keyword2><span class=keyword>where</span></span>
    <span class=quoted><span class=quoted>"exec_plan <span class=free>s</span> <span class=free>as</span> <span class=main>=</span> exec_plan <span class=free>s</span> <span class=skolem>p'</span>"</span></span> <span class=quoted><span class=quoted>"subseq <span class=skolem>p'</span> <span class=free>as</span>"</span></span> <span class=quoted><span class=quoted>"length <span class=skolem>p'</span> <span class=main>≤</span> <span class=numeral>2</span> <span class=main>^</span> card <span class=main>(</span>prob_dom <span class=free>PROB</span><span class=main>)</span> <span class=main>-</span> <span class=main>1</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>using</span></span> sublist_refl
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1><span class=command>subsection</span></span> <span class=quoted><span class=plain_text>"Reachable States"</span></span>


<span class=comment1>― ‹NOTE shortened to 'reachable\_s'›</span>
<span class=keyword1><span class=command>definition</span></span> <span class=entity>reachable_s</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>reachable_s</span> <span class=free><span class=bound><span class=entity>PROB</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=main>≡</span> <span class=main>{</span>exec_plan <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=bound>as</span> <span class=main>|</span> <span class=bound>as</span><span class=main>.</span> <span class=bound>as</span> <span class=main>∈</span> valid_plans <span class=free><span class=bound><span class=entity>PROB</span></span></span><span class=main>}</span>"</span></span>


<span class=comment1>― ‹NOTE types for `s` and `PROB` had to be fixed (type mismatch in goal).›</span>
<span class=keyword1 id=FactoredSystem-valid_as_valid_exec><span class=command>lemma</span></span> valid_as_valid_exec<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>as</span> <span class=keyword2><span class=keyword>and</span></span> <span class=free>s</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> state"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=free>PROB</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> problem"</span></span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>s</span> <span class=main>∈</span> valid_states <span class=free>PROB</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>exec_plan <span class=free>s</span> <span class=free>as</span> <span class=main>∈</span> valid_states <span class=free>PROB</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>as</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>s</span></span> <span class=quoted><span class=free>PROB</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>a</span> <span class=skolem>as</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a</span> <span class=main>∈</span> <span class=skolem>PROB</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> valid_plan_valid_head
    <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"state_succ <span class=skolem>s</span> <span class=skolem>a</span> <span class=main>∈</span> valid_states <span class=skolem>PROB</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>2<span class=main>)</span> valid_action_valid_succ
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>as</span> <span class=main>∈</span> valid_plans <span class=skolem>PROB</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>1<span class=main>)</span> valid_plan_valid_tail
    <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>using</span></span> Cons.IH
    <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
<span class=keyword1><span class=command>qed</span></span> <span class=operator>simp</span>


<span class=keyword1 id=FactoredSystem-exec_plan_fdom_subset><span class=command>lemma</span></span> exec_plan_fdom_subset<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>as</span> <span class=free>s</span> <span class=free>PROB</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>fmdom' <span class=main>(</span>exec_plan <span class=free>s</span> <span class=free>as</span><span class=main>)</span> <span class=main>⊆</span> <span class=main>(</span>fmdom' <span class=free>s</span> <span class=main>∪</span> prob_dom <span class=free>PROB</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>as</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>s</span></span> <span class=quoted><span class=free>PROB</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>a</span> <span class=skolem>as</span><span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>as</span> <span class=main>∈</span> valid_plans <span class=skolem>PROB</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Cons.prems valid_plan_valid_tail
    <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>exec_plan <span class=main>(</span>state_succ <span class=skolem>s</span> <span class=skolem>a</span><span class=main>)</span> <span class=skolem>as</span><span class=main>)</span> <span class=main>⊆</span> fmdom' <span class=main>(</span>state_succ <span class=skolem>s</span> <span class=skolem>a</span><span class=main>)</span> <span class=main>∪</span> prob_dom <span class=skolem>PROB</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Cons.IH<span class=main>[</span><span class=operator>of</span> <span class=main>_</span> <span class=quoted><span class=quoted>"state_succ <span class=skolem>s</span> <span class=skolem>a</span>"</span></span><span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
      <span class=comment1>― ‹TODO unwrap metis proofs.›</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=skolem>s</span> <span class=main>∪</span> fmdom' <span class=main>(</span>snd <span class=skolem>a</span><span class=main>)</span> <span class=main>∪</span> prob_dom <span class=skolem>PROB</span> <span class=main>=</span> fmdom' <span class=skolem>s</span> <span class=main>∪</span> prob_dom <span class=skolem>PROB</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span>
        Cons.prems FDOM_eff_subset_prob_dom_pair sup_absorb2 sup_assoc valid_plan_valid_head<span class=main>)</span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> <span class=main><span class=main>(</span></span>no_types<span class=main><span class=main>,</span></span> lifting<span class=main><span class=main>)</span></span>
        FDOM_state_succ_subset exec_plan.simps<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span> order_refl subset_trans sup.mono<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span> <span class=operator>simp</span>


<span class=comment1>― ‹NOTE added lemma.›</span>
<span class=keyword1 id=FactoredSystem-reachable_s_finite_thm_1_a><span class=command>lemma</span></span> reachable_s_finite_thm_1_a<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>s</span> <span class=keyword2><span class=keyword>and</span></span> <span class=free>PROB</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> problem"</span></span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>s</span> <span class=main>::</span> <span class=tfree>'a</span> state<span class=main>)</span> <span class=main>∈</span> valid_states <span class=free>PROB</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>l</span><span class=main>∈</span>reachable_s <span class=free>PROB</span> <span class=free>s</span><span class=main>.</span> <span class=bound>l</span><span class=main>∈</span>valid_states <span class=free>PROB</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>l</span><span class=main>∈</span>reachable_s <span class=free>PROB</span> <span class=free>s</span><span class=main>.</span> <span class=main>∃</span><span class=bound>as</span><span class=main>.</span> <span class=bound>l</span> <span class=main>=</span> exec_plan <span class=free>s</span> <span class=bound>as</span> <span class=main>∧</span> <span class=bound>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> reachable_s_def
    <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>l</span>
    <span class=keyword3><span class=command>assume</span></span> P1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>l</span> <span class=main>∈</span> reachable_s <span class=free>PROB</span> <span class=free>s</span>"</span></span>
      <span class=comment1>― ‹NOTE type for 's' and 'as' had to be fixed due to type mismatch in obtain statement.›</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>as</span></span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> action list"</span></span> <span class=keyword2><span class=keyword>where</span></span> a<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>l</span> <span class=main>=</span> exec_plan <span class=free>s</span> <span class=skolem>as</span> <span class=main>∧</span> <span class=skolem>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> 1
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"exec_plan <span class=free>s</span> <span class=skolem>as</span> <span class=main>∈</span> valid_states <span class=free>PROB</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> assms a valid_as_valid_exec
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>l</span> <span class=main>∈</span> valid_states <span class=free>PROB</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> a
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>l</span> <span class=main>∈</span> reachable_s <span class=free>PROB</span> <span class=free>s</span><span class=main>.</span> <span class=bound>l</span> <span class=main>∈</span> valid_states <span class=free>PROB</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=FactoredSystem-reachable_s_finite_thm_1><span class=command>lemma</span></span> reachable_s_finite_thm_1<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>(</span><span class=free>s</span> <span class=main>::</span> <span class=tfree>'a</span> state<span class=main>)</span> <span class=main>∈</span> valid_states <span class=free>PROB</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>reachable_s <span class=free>PROB</span> <span class=free>s</span> <span class=main>⊆</span> valid_states <span class=free>PROB</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms reachable_s_finite_thm_1_a
  <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>


<span class=comment1>― ‹NOTE second declaration skipped (this is declared twice in the source; see above)›</span>
<span class=comment1>― ‹NOTE type for `s` had to be fixed (type mismatch in goal).›</span>
<span class=keyword1 id=FactoredSystem-reachable_s_finite_thm><span class=command>lemma</span></span> reachable_s_finite_thm<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>s</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> state"</span></span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"finite <span class=main>(</span><span class=free>PROB</span> <span class=main>::</span> <span class=tfree>'a</span> problem<span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>s</span> <span class=main>∈</span> valid_states <span class=free>PROB</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"finite <span class=main>(</span>reachable_s <span class=free>PROB</span> <span class=free>s</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>meson</span> FINITE_valid_states reachable_s_finite_thm_1 rev_finite_subset<span class=main>)</span>


<span class=keyword1 id=FactoredSystem-empty_plan_is_valid><span class=command>lemma</span></span> empty_plan_is_valid<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>[]</span> <span class=main>∈</span> <span class=main>(</span>valid_plans <span class=free>PROB</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> valid_plans_def<span class=main>)</span>


<span class=keyword1 id=FactoredSystem-valid_head_and_tail_valid_plan><span class=command>lemma</span></span> valid_head_and_tail_valid_plan<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>h</span> <span class=main>∈</span> <span class=free>PROB</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>(</span><span class=free>h</span> <span class=main>#</span> <span class=free>as</span><span class=main>)</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> valid_plans_def<span class=main>)</span>


<span class=comment1>― ‹TODO refactor›</span>
<span class=comment1>― ‹NOTE added lemma›</span>
<span class=keyword1 id=FactoredSystem-lemma_1_reachability_s_i><span class=command>lemma</span></span> lemma_1_reachability_s_i<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=free>s</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>s</span> <span class=main>∈</span> valid_states <span class=free>PROB</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=free>s</span> <span class=main>∈</span> reachable_s <span class=free>PROB</span> <span class=free>s</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>[]</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> empty_plan_is_valid
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>unfolding</span></span> reachable_s_def
    <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=comment1>― ‹NOTE types for 'PROB' and 's' had to be fixed (type mismatch in goal).›</span>
<span class=keyword1 id=FactoredSystem-lemma_1_reachability_s><span class=command>lemma</span></span> lemma_1_reachability_s<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> problem"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=free>s</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> state"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=free>as</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>s</span> <span class=main>∈</span> valid_states <span class=free>PROB</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>(</span>last <span class=main>`</span> state_set <span class=main>(</span>state_list <span class=free>s</span> <span class=free>as</span><span class=main>)</span><span class=main>)</span> <span class=main>⊆</span> <span class=main>(</span>reachable_s <span class=free>PROB</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
<span class=keyword1><span class=command>proof</span></span><span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>as</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>PROB</span></span> <span class=quoted><span class=free>s</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> Nil
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>last <span class=main>`</span> state_set <span class=main>(</span>state_list <span class=skolem>s</span> <span class=main>[]</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>{</span><span class=skolem>s</span><span class=main>}</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>unfolding</span></span> reachable_s_def
    <span class=keyword1><span class=command>using</span></span> empty_plan_is_valid
    <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> cons<span class=main>:</span> <span class=main>(</span>Cons <span class=skolem>a</span> <span class=skolem>as</span><span class=main>)</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?S</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"last <span class=main>`</span> state_set <span class=main>(</span>state_list <span class=skolem>s</span> <span class=main>(</span><span class=skolem>a</span> <span class=main>#</span> <span class=skolem>as</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?as</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>[]</span>"</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"last <span class=main>[</span><span class=skolem>s</span><span class=main>]</span> <span class=main>=</span> exec_plan <span class=skolem>s</span> <span class=var>?as</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?as</span> <span class=main>∈</span> valid_plans <span class=skolem>PROB</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> empty_plan_is_valid
      <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>as</span><span class=main>.</span> <span class=main>(</span>last <span class=main>[</span><span class=skolem>s</span><span class=main>]</span> <span class=main>=</span> exec_plan <span class=skolem>s</span> <span class=bound>as</span><span class=main>)</span> <span class=main>∧</span> <span class=bound>as</span> <span class=main>∈</span> valid_plans <span class=skolem>PROB</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>note</span></span> 1 <span class=main>=</span> this
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>x</span>
    <span class=keyword3><span class=command>assume</span></span> P<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> <span class=var>?S</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>consider</span></span>
      <span class=main>(</span>a<span class=main>)</span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>=</span> last <span class=main>[</span><span class=skolem>s</span><span class=main>]</span>"</span></span>
      <span class=main>|</span> <span class=main>(</span>b<span class=main>)</span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> last <span class=main>`</span> <span class=main>(</span><span class=main>(#)</span> <span class=skolem>s</span> <span class=main>`</span> state_set <span class=main>(</span>state_list <span class=main>(</span>state_succ <span class=skolem>s</span> <span class=skolem>a</span><span class=main>)</span> <span class=skolem>as</span><span class=main>)</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> reachable_s <span class=skolem>PROB</span> <span class=skolem>s</span>"</span></span>
    <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span><span class=main>)</span>
      <span class=keyword3><span class=command>case</span></span> a
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>=</span> <span class=skolem>s</span>"</span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
        <span class=keyword1><span class=command>using</span></span> cons.prems<span class=main>(</span>1<span class=main>)</span> P lemma_1_reachability_s_i
        <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>next</span></span>
      <span class=keyword3><span class=command>case</span></span> b
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>x''</span></span> <span class=keyword2><span class=keyword>where</span></span> i<span class=main>:</span>
        <span class=quoted><span class=quoted>"<span class=skolem>x''</span> <span class=main>∈</span> state_set <span class=main>(</span>state_list <span class=main>(</span>state_succ <span class=skolem>s</span> <span class=skolem>a</span><span class=main>)</span> <span class=skolem>as</span><span class=main>)</span>"</span></span>
        <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>=</span> last <span class=main>(</span><span class=skolem>s</span> <span class=main>#</span> <span class=skolem>x''</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=skolem>x''</span>"</span></span><span class=main>)</span>
        <span class=keyword3><span class=command>case</span></span> Nil
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>=</span> <span class=skolem>s</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> i
          <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
          <span class=keyword1><span class=command>using</span></span> cons.prems<span class=main>(</span>1<span class=main>)</span> lemma_1_reachability_s_i
          <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>next</span></span>
        <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>a'</span> <span class=skolem>list</span><span class=main>)</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>x'</span></span> <span class=keyword2><span class=keyword>where</span></span> a<span class=main>:</span>
          <span class=quoted><span class=quoted>"last <span class=main>(</span><span class=skolem>a'</span> <span class=main>#</span> <span class=skolem>list</span><span class=main>)</span> <span class=main>=</span> last <span class=skolem>x'</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x'</span> <span class=main>∈</span> state_set <span class=main>(</span>state_list <span class=main>(</span>state_succ <span class=skolem>s</span> <span class=skolem>a</span><span class=main>)</span> <span class=skolem>as</span><span class=main>)</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> i<span class=main>(</span>1<span class=main>)</span>
          <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
        <span class=keyword1><span class=command>{</span></span>
          <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"state_succ <span class=skolem>s</span> <span class=skolem>a</span> <span class=main>∈</span> valid_states <span class=skolem>PROB</span>"</span></span>
            <span class=keyword1><span class=command>using</span></span> cons.prems<span class=main>(</span>1<span class=main>,</span> 2<span class=main>)</span> valid_action_valid_succ valid_plan_valid_head
            <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
          <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>as</span> <span class=main>∈</span> valid_plans <span class=skolem>PROB</span>"</span></span>
            <span class=keyword1><span class=command>using</span></span> cons.prems<span class=main>(</span>2<span class=main>)</span> valid_plan_valid_tail
            <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
          <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span>
            <span class=quoted><span class=quoted>"last <span class=main>`</span> state_set <span class=main>(</span>state_list <span class=main>(</span>state_succ <span class=skolem>s</span> <span class=skolem>a</span><span class=main>)</span> <span class=skolem>as</span><span class=main>)</span> <span class=main>⊆</span> reachable_s <span class=skolem>PROB</span> <span class=main>(</span>state_succ <span class=skolem>s</span> <span class=skolem>a</span><span class=main>)</span>"</span></span>
            <span class=keyword1><span class=command>using</span></span> cons.IH<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"state_succ <span class=skolem>s</span> <span class=skolem>a</span>"</span></span><span class=main>]</span>
            <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
          <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>as'</span><span class=main>.</span>
                  last <span class=main>(</span><span class=skolem>a'</span> <span class=main>#</span> <span class=skolem>list</span><span class=main>)</span> <span class=main>=</span> exec_plan <span class=main>(</span>state_succ <span class=skolem>s</span> <span class=skolem>a</span><span class=main>)</span> <span class=bound>as'</span> <span class=main>∧</span> <span class=main>(</span><span class=bound>as'</span> <span class=main>∈</span> <span class=main>(</span>valid_plans <span class=skolem>PROB</span><span class=main>)</span><span class=main>)</span>"</span></span>
            <span class=keyword1><span class=command>unfolding</span></span> state_set.simps state_list.simps reachable_s_def
            <span class=keyword1><span class=command>using</span></span> i<span class=main>(</span>1<span class=main>)</span> Cons
            <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
        <span class=keyword1><span class=command>}</span></span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>as'</span></span> <span class=keyword2><span class=keyword>where</span></span> b<span class=main>:</span>
          <span class=quoted><span class=quoted>"last <span class=main>(</span><span class=skolem>a'</span> <span class=main>#</span> <span class=skolem>list</span><span class=main>)</span> <span class=main>=</span> exec_plan <span class=main>(</span>state_succ <span class=skolem>s</span> <span class=skolem>a</span><span class=main>)</span> <span class=skolem>as'</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>as'</span> <span class=main>∈</span> <span class=main>(</span>valid_plans <span class=skolem>PROB</span><span class=main>)</span><span class=main>)</span>"</span></span>
          <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>=</span> exec_plan <span class=main>(</span>state_succ <span class=skolem>s</span> <span class=skolem>a</span><span class=main>)</span> <span class=skolem>as'</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> i<span class=main>(</span>2<span class=main>)</span> Cons a<span class=main>(</span>1<span class=main>)</span>
          <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>unfolding</span></span> reachable_s_def
          <span class=keyword1><span class=command>using</span></span> cons.prems<span class=main>(</span>2<span class=main>)</span> b<span class=main>(</span>2<span class=main>)</span>
          <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> <span class=main><span class=main>(</span></span>mono_tags<span class=main><span class=main>,</span></span> lifting<span class=main><span class=main>)</span></span>  exec_plan.simps<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span> mem_Collect_eq
              valid_head_and_tail_valid_plan valid_plan_valid_head<span class=main>)</span>
      <span class=keyword1><span class=command>qed</span></span>
    <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=comment1>― ‹NOTE types for `PROB` and `s` had to be fixed for use of `lemma\_1\_reachability\_s`.›</span>
<span class=keyword1 id=FactoredSystem-not_eq_last_diff_paths_reachability_s><span class=command>lemma</span></span> not_eq_last_diff_paths_reachability_s<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> problem"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=free>s</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> state"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=free>as</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>s</span> <span class=main>∈</span> valid_states <span class=free>PROB</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>¬</span><span class=main>(</span>inj last <span class=main>(</span>state_set <span class=main>(</span>state_list <span class=free>s</span> <span class=free>as</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>reachable_s <span class=free>PROB</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>slist_1</span> <span class=bound>slist_2</span><span class=main>.</span>
    <span class=bound>slist_1</span> <span class=main>∈</span> state_set <span class=main>(</span>state_list <span class=free>s</span> <span class=free>as</span><span class=main>)</span>
    <span class=main>∧</span> <span class=bound>slist_2</span> <span class=main>∈</span> state_set <span class=main>(</span>state_list <span class=free>s</span> <span class=free>as</span><span class=main>)</span>
    <span class=main>∧</span> <span class=main>(</span>last <span class=bound>slist_1</span> <span class=main>=</span> last <span class=bound>slist_2</span><span class=main>)</span>
    <span class=main>∧</span> <span class=main>¬</span><span class=main>(</span>length <span class=bound>slist_1</span> <span class=main>=</span> length <span class=bound>slist_2</span><span class=main>)</span>
  <span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>x</span>
    <span class=keyword3><span class=command>assume</span></span> P1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> state_set <span class=main>(</span>state_list <span class=free>s</span> <span class=free>as</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>have</span></span> a<span class=main>:</span> <span class=quoted><span class=quoted>"last <span class=main>`</span> state_set <span class=main>(</span>state_list <span class=free>s</span> <span class=free>as</span><span class=main>)</span> <span class=main>⊆</span> reachable_s <span class=free>PROB</span> <span class=free>s</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>,</span> 2<span class=main>)</span> lemma_1_reachability_s
      <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>as</span> <span class=bound>PROB</span><span class=main>.</span> <span class=free>s</span> <span class=main>∈</span> <span class=main>(</span>valid_states <span class=bound>PROB</span><span class=main>)</span> <span class=main>∧</span> <span class=bound>as</span> <span class=main>∈</span> <span class=main>(</span>valid_plans <span class=bound>PROB</span><span class=main>)</span> <span class=main>⟶</span> <span class=main>(</span>last <span class=main>`</span> <span class=main>(</span>state_set <span class=main>(</span>state_list <span class=free>s</span> <span class=bound>as</span><span class=main>)</span><span class=main>)</span> <span class=main>⊆</span> reachable_s <span class=bound>PROB</span> <span class=free>s</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> lemma_1_reachability_s
      <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"last <span class=skolem>x</span> <span class=main>∈</span> valid_states <span class=free>PROB</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>,</span> 2<span class=main>)</span> P1 lemma_1
      <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"last <span class=skolem>x</span> <span class=main>∈</span> reachable_s <span class=free>PROB</span> <span class=free>s</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> P1 a
      <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>note</span></span> 1 <span class=main>=</span> this
  <span class=keyword1><span class=command>text</span></span> <span class=quoted><span class=plain_text>‹ Show the goal by disproving the contradiction. ›</span></span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>assume</span></span> C<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>slist_1</span> <span class=bound>slist_2</span><span class=main>.</span> <span class=main>(</span><span class=bound>slist_1</span> <span class=main>∈</span> state_set <span class=main>(</span>state_list <span class=free>s</span> <span class=free>as</span><span class=main>)</span>
      <span class=main>∧</span> <span class=bound>slist_2</span> <span class=main>∈</span> state_set <span class=main>(</span>state_list <span class=free>s</span> <span class=free>as</span><span class=main>)</span>
      <span class=main>∧</span> <span class=main>(</span>last <span class=bound>slist_1</span> <span class=main>=</span> last <span class=bound>slist_2</span><span class=main>)</span><span class=main>)</span> <span class=main>⟶</span> <span class=main>(</span>length <span class=bound>slist_1</span> <span class=main>=</span> length <span class=bound>slist_2</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>{</span></span>
      <span class=keyword3><span class=command>fix</span></span> <span class=skolem>slist_1</span> <span class=skolem>slist_2</span>
      <span class=keyword3><span class=command>assume</span></span> C1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>slist_1</span> <span class=main>∈</span> state_set <span class=main>(</span>state_list <span class=free>s</span> <span class=free>as</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>slist_2</span> <span class=main>∈</span> state_set <span class=main>(</span>state_list <span class=free>s</span> <span class=free>as</span><span class=main>)</span>"</span></span>
        <span class=quoted><span class=quoted>"<span class=main>(</span>last <span class=skolem>slist_1</span> <span class=main>=</span> last <span class=skolem>slist_2</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> i<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span>length <span class=skolem>slist_1</span> <span class=main>=</span> length <span class=skolem>slist_2</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> C1 C
        <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>slist_1</span> <span class=main>=</span> <span class=skolem>slist_2</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> C1<span class=main>(</span>1<span class=main>,</span> 2<span class=main>)</span> i neq_mems_state_set_neq_len
        <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"inj_on last <span class=main>(</span>state_set <span class=main>(</span>state_list <span class=free>s</span> <span class=free>as</span><span class=main>)</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>unfolding</span></span> inj_on_def
        <span class=keyword1><span class=command>using</span></span> C neq_mems_state_set_neq_len
        <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted>False</span>
        <span class=keyword1><span class=command>using</span></span> 1 inj_def assms<span class=main>(</span>3<span class=main>)</span>
        <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>}</span></span>
    <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted>False</span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> empty_state_list_lemma nempty_sl_in_state_set<span class=main>)</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=comment1>― ‹NOTE added lemma ( translation of `PHP` in pred\_setScript.sml:3155).›</span>
<span class=keyword1 id=FactoredSystem-lemma_2_reachability_s_i><span class=command>lemma</span></span> lemma_2_reachability_s_i<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>f</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> <span class=main>⇒</span> <span class=tfree>'b</span>"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=free>s</span> <span class=free>t</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"finite <span class=free>t</span>"</span></span> <span class=quoted><span class=quoted>"card <span class=free>t</span> <span class=main>&lt;</span> card <span class=free>s</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span><span class=main>(</span>inj <span class=free>f</span> <span class=free>s</span> <span class=free>t</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>assume</span></span> C<span class=main>:</span> <span class=quoted><span class=quoted>"inj <span class=free>f</span> <span class=free>s</span> <span class=free>t</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>x</span><span class=main>∈</span><span class=free>s</span><span class=main>.</span> <span class=free>f</span> <span class=bound>x</span> <span class=main>∈</span> <span class=free>t</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"inj_on <span class=free>f</span> <span class=free>s</span>"</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> inj_def
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span><span class=main><span class=keyword3>+</span></span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>{</span></span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>f</span> <span class=main>`</span> <span class=free>s</span> <span class=main>⊆</span> <span class=free>t</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> 1
        <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"card <span class=main>(</span><span class=free>f</span> <span class=main>`</span> <span class=free>s</span><span class=main>)</span> <span class=main>≤</span> card <span class=free>t</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>)</span> card_mono
        <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>}</span></span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"card <span class=main>(</span><span class=free>f</span> <span class=main>`</span> <span class=free>s</span><span class=main>)</span> <span class=main>=</span> card <span class=free>s</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> 1 card_image
      <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
    <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted>False</span>
      <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>2<span class=main>)</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>linarith</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=FactoredSystem-lemma_2_reachability_s><span class=command>lemma</span></span> lemma_2_reachability_s<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> problem"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=free>as</span> <span class=free>s</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"finite <span class=free>PROB</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>s</span> <span class=main>∈</span> valid_states <span class=free>PROB</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span>length <span class=free>as</span> <span class=main>&gt;</span> card <span class=main>(</span>reachable_s <span class=free>PROB</span> <span class=free>s</span><span class=main>)</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>as1</span> <span class=bound>as2</span> <span class=bound>as3</span><span class=main>.</span>
    <span class=main>(</span><span class=bound>as1</span> <span class=main>@</span> <span class=bound>as2</span> <span class=main>@</span> <span class=bound>as3</span> <span class=main>=</span> <span class=free>as</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span>exec_plan <span class=free>s</span> <span class=main>(</span><span class=bound>as1</span> <span class=main>@</span> <span class=bound>as2</span><span class=main>)</span> <span class=main>=</span> exec_plan <span class=free>s</span> <span class=bound>as1</span><span class=main>)</span> <span class=main>∧</span> <span class=main>¬</span><span class=main>(</span><span class=bound>as2</span> <span class=main>=</span> <span class=main>[]</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Suc <span class=main>(</span>length <span class=free>as</span><span class=main>)</span> <span class=main>&gt;</span> card <span class=main>(</span>reachable_s <span class=free>PROB</span> <span class=free>s</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>4<span class=main>)</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"card <span class=main>(</span>state_set <span class=main>(</span>state_list <span class=free>s</span> <span class=free>as</span><span class=main>)</span><span class=main>)</span> <span class=main>&gt;</span> card <span class=main>(</span>reachable_s <span class=free>PROB</span> <span class=free>s</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> card_state_set
      <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>note</span></span> 1 <span class=main>=</span> this
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"finite <span class=main>(</span>reachable_s <span class=free>PROB</span> <span class=free>s</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>,</span> 2<span class=main>)</span> reachable_s_finite_thm
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span><span class=main>(</span>inj last <span class=main>(</span>state_set <span class=main>(</span>state_list <span class=free>s</span> <span class=free>as</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>reachable_s <span class=free>PROB</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>4<span class=main>)</span> 1 lemma_2_reachability_s_i
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>note</span></span> 2 <span class=main>=</span> this
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>slist_1</span></span> <span class=skolem><span class=skolem>slist_2</span></span> <span class=keyword2><span class=keyword>where</span></span> 3<span class=main>:</span>
    <span class=quoted><span class=quoted>"<span class=skolem>slist_1</span> <span class=main>∈</span> state_set <span class=main>(</span>state_list <span class=free>s</span> <span class=free>as</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>slist_2</span> <span class=main>∈</span> state_set <span class=main>(</span>state_list <span class=free>s</span> <span class=free>as</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span>last <span class=skolem>slist_1</span> <span class=main>=</span> last <span class=skolem>slist_2</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"length <span class=skolem>slist_1</span> <span class=main>≠</span> length <span class=skolem>slist_2</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>2<span class=main>,</span> 3<span class=main>)</span> 2 not_eq_last_diff_paths_reachability_s
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>proof</span></span><span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=free>as</span></span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>a</span> <span class=skolem>list</span><span class=main>)</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>2<span class=main>,</span> 3<span class=main>)</span> 3 eq_last_state_imp_append_nempty_as state_set_thm list.distinct<span class=main>(</span>1<span class=main>)</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
  <span class=keyword1><span class=command>qed</span></span> <span class=operator>force</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1 id=FactoredSystem-lemma_3_reachability_s><span class=command>lemma</span></span> lemma_3_reachability_s<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>as</span> <span class=keyword2><span class=keyword>and</span></span> <span class=free>PROB</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> problem"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=free>s</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"finite <span class=free>PROB</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>s</span> <span class=main>∈</span> valid_states <span class=free>PROB</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span>length <span class=free>as</span> <span class=main>&gt;</span> <span class=main>(</span>card <span class=main>(</span>reachable_s <span class=free>PROB</span> <span class=free>s</span><span class=main>)</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>as'</span><span class=main>.</span>
    <span class=main>(</span>exec_plan <span class=free>s</span> <span class=free>as</span> <span class=main>=</span> exec_plan <span class=free>s</span> <span class=bound>as'</span><span class=main>)</span>
    <span class=main>∧</span> <span class=main>(</span>length <span class=bound>as'</span> <span class=main>&lt;</span> length <span class=free>as</span><span class=main>)</span>
    <span class=main>∧</span> <span class=main>(</span>subseq <span class=bound>as'</span> <span class=free>as</span><span class=main>)</span>
  <span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>as1</span></span> <span class=skolem><span class=skolem>as2</span></span> <span class=skolem><span class=skolem>as3</span></span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> action list"</span></span> <span class=keyword2><span class=keyword>where</span></span> 1<span class=main>:</span>
    <span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>as1</span> <span class=main>@</span> <span class=skolem>as2</span> <span class=main>@</span> <span class=skolem>as3</span> <span class=main>=</span> <span class=free>as</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>exec_plan <span class=free>s</span> <span class=main>(</span><span class=skolem>as1</span> <span class=main>@</span> <span class=skolem>as2</span><span class=main>)</span> <span class=main>=</span> exec_plan <span class=free>s</span> <span class=skolem>as1</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>~</span><span class=main>(</span><span class=skolem>as2</span><span class=main>=</span><span class=main>[]</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms lemma_2_reachability_s
    <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>exec_plan <span class=free>s</span> <span class=main>(</span><span class=skolem>as1</span> <span class=main>@</span> <span class=skolem>as2</span><span class=main>)</span> <span class=main>=</span> exec_plan <span class=free>s</span> <span class=skolem>as1</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> 1
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> 2<span class=main>:</span> <span class=quoted><span class=quoted>"exec_plan <span class=free>s</span> <span class=main>(</span><span class=skolem>as1</span> <span class=main>@</span> <span class=skolem>as3</span><span class=main>)</span> <span class=main>=</span> exec_plan <span class=free>s</span> <span class=main>(</span><span class=skolem>as1</span> <span class=main>@</span> <span class=skolem>as2</span> <span class=main>@</span> <span class=skolem>as3</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> 1 cycle_removal_lemma
    <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?as'</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"<span class=skolem>as1</span> <span class=main>@</span> <span class=skolem>as3</span>"</span></span>
  <span class=keyword1><span class=command>have</span></span> 3<span class=main>:</span> <span class=quoted><span class=quoted>"exec_plan <span class=free>s</span> <span class=free>as</span> <span class=main>=</span> exec_plan <span class=free>s</span> <span class=var>?as'</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> 1 2
    <span class=keyword1><span class=command>by</span></span> <span class=operator>argo</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>as2</span> <span class=main>≠</span> <span class=main>[]</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> 1
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> 4<span class=main>:</span> <span class=quoted><span class=quoted>"length <span class=var>?as'</span> <span class=main>&lt;</span> length <span class=free>as</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> nempty_list_append_length_add 1
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"subseq <span class=var>?as'</span> <span class=free>as</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> 1 subseq_append'
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>using</span></span> 3 4
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=comment1>― ‹NOTE type for `as` had to be fixed (type mismatch in goal).›</span>
<span class=keyword1 id=FactoredSystem-main_lemma_reachability_s><span class=command>lemma</span></span> main_lemma_reachability_s<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> problem"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=free>as</span> <span class=keyword2><span class=keyword>and</span></span> <span class=free>s</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> state"</span></span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"finite <span class=free>PROB</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>s</span> <span class=main>∈</span> valid_states <span class=free>PROB</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>as'</span><span class=main>.</span>
      <span class=main>(</span>exec_plan <span class=free>s</span> <span class=free>as</span> <span class=main>=</span> exec_plan <span class=free>s</span> <span class=bound>as'</span><span class=main>)</span> <span class=main>∧</span> subseq <span class=bound>as'</span> <span class=free>as</span>
      <span class=main>∧</span> <span class=main>(</span>length <span class=bound>as'</span> <span class=main>≤</span> <span class=main>(</span>card <span class=main>(</span>reachable_s <span class=free>PROB</span> <span class=free>s</span><span class=main>)</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"length <span class=free>as</span> <span class=main>≤</span> card <span class=main>(</span>reachable_s <span class=free>PROB</span> <span class=free>s</span><span class=main>)</span> <span class=main>-</span> <span class=main>1</span>"</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> False
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?as'</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"<span class=free>as</span>"</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"length <span class=free>as</span> <span class=main>&gt;</span> card <span class=main>(</span>reachable_s <span class=free>PROB</span> <span class=free>s</span><span class=main>)</span> <span class=main>-</span> <span class=main>1</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> False
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>p</span>
    <span class=keyword3><span class=command>assume</span></span> P<span class=main>:</span> <span class=quoted><span class=quoted>"exec_plan <span class=free>s</span> <span class=free>as</span> <span class=main>=</span> exec_plan <span class=free>s</span> <span class=skolem>p</span>"</span></span> <span class=quoted><span class=quoted>"subseq <span class=skolem>p</span> <span class=free>as</span>"</span></span>
      <span class=quoted><span class=quoted>"card <span class=main>(</span>reachable_s <span class=free>PROB</span> <span class=free>s</span><span class=main>)</span> <span class=main>-</span> <span class=main>1</span> <span class=main>&lt;</span> length <span class=skolem>p</span>"</span></span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>p</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>3<span class=main>)</span> P<span class=main>(</span>2<span class=main>)</span> sublist_valid_is_valid
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>as'</span></span> <span class=keyword2><span class=keyword>where</span></span> 1<span class=main>:</span>
      <span class=quoted><span class=quoted>"exec_plan <span class=free>s</span> <span class=skolem>p</span> <span class=main>=</span> exec_plan <span class=free>s</span> <span class=skolem>as'</span>"</span></span> <span class=quoted><span class=quoted>"length <span class=skolem>as'</span> <span class=main>&lt;</span> length <span class=skolem>p</span>"</span></span> <span class=quoted><span class=quoted>"subseq <span class=skolem>as'</span> <span class=skolem>p</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> assms lemma_3_reachability_s
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"exec_plan <span class=free>s</span> <span class=free>as</span> <span class=main>=</span> exec_plan <span class=free>s</span> <span class=skolem>as'</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> P
      <span class=keyword1><span class=command>by</span></span> <span class=operator>presburger</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"subseq <span class=skolem>as'</span> <span class=free>as</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> P 1 sublist_trans
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>p'</span><span class=main>.</span> <span class=main>(</span>exec_plan <span class=free>s</span> <span class=free>as</span> <span class=main>=</span> exec_plan <span class=free>s</span> <span class=bound>p'</span> <span class=main>∧</span> subseq <span class=bound>p'</span> <span class=free>as</span><span class=main>)</span> <span class=main>∧</span> length <span class=bound>p'</span> <span class=main>&lt;</span> length <span class=skolem>p</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> 1
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>p</span><span class=main>.</span>
      exec_plan <span class=free>s</span> <span class=free>as</span> <span class=main>=</span> exec_plan <span class=free>s</span> <span class=bound>p</span> <span class=main>∧</span> subseq <span class=bound>p</span> <span class=free>as</span>
      <span class=main>⟶</span> <span class=main>(</span><span class=main>∃</span><span class=bound>p'</span><span class=main>.</span>
        <span class=main>(</span>exec_plan <span class=free>s</span> <span class=free>as</span> <span class=main>=</span> exec_plan <span class=free>s</span> <span class=bound>p'</span> <span class=main>∧</span> subseq <span class=bound>p'</span> <span class=free>as</span><span class=main>)</span>
        <span class=main>∧</span> length <span class=bound>p'</span> <span class=main>≤</span> card <span class=main>(</span>reachable_s <span class=free>PROB</span> <span class=free>s</span><span class=main>)</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> general_theorem<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>as''</span><span class=main>.</span> <span class=main>(</span>exec_plan <span class=free>s</span> <span class=free>as</span> <span class=main>=</span> exec_plan <span class=free>s</span> <span class=bound>as''</span><span class=main>)</span> <span class=main>∧</span> subseq <span class=bound>as''</span> <span class=free>as</span>"</span></span>
        <span class=quoted><span class=quoted>"<span class=main>(</span>card <span class=main>(</span>reachable_s <span class=main>(</span><span class=free>PROB</span> <span class=main>::</span> <span class=tfree>'a</span> problem<span class=main>)</span> <span class=main>(</span><span class=free>s</span> <span class=main>::</span> <span class=tfree>'a</span> state<span class=main>)</span><span class=main>)</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span>"</span></span> <span class=quoted>length</span><span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span> <span class=operator>blast</span>


<span class=keyword1 id=FactoredSystem-reachable_s_non_empty><span class=command>lemma</span></span> reachable_s_non_empty<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>¬</span><span class=main>(</span>reachable_s <span class=free>PROB</span> <span class=free>s</span> <span class=main>=</span> <span class=main>{}</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> empty_plan_is_valid reachable_s_def
  <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>


<span class=keyword1 id=FactoredSystem-card_reachable_s_non_zero><span class=command>lemma</span></span> card_reachable_s_non_zero<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>s</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"finite <span class=main>(</span><span class=free>PROB</span> <span class=main>::</span> <span class=tfree>'a</span> problem<span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>s</span> <span class=main>∈</span> valid_states <span class=free>PROB</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>0</span> <span class=main>&lt;</span> card <span class=main>(</span>reachable_s <span class=free>PROB</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> card_gt_0_iff reachable_s_finite_thm reachable_s_non_empty<span class=main>)</span>


<span class=keyword1 id=FactoredSystem-exec_fdom_empty_prob><span class=command>lemma</span></span> exec_fdom_empty_prob<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>s</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>prob_dom <span class=free>PROB</span> <span class=main>=</span> <span class=main>{}</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>s</span> <span class=main>∈</span> valid_states <span class=free>PROB</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>exec_plan <span class=free>s</span> <span class=free>as</span> <span class=main>=</span> fmempty<span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=free>s</span> <span class=main>=</span> <span class=main>{}</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>,</span> 2<span class=main>)</span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> valid_states_def<span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"exec_plan <span class=free>s</span> <span class=free>as</span> <span class=main>=</span> fmempty"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>,</span> 3<span class=main>)</span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span>
        exec_plan_fdom_subset fmrestrict_set_dom fmrestrict_set_null subset_empty
        sup_bot.left_neutral<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=comment1>― ‹NOTE types for `PROB` and `s` had to be fixed (type mismatch in goal).›</span>
<span class=keyword1 id=FactoredSystem-reachable_s_empty_prob><span class=command>lemma</span></span> reachable_s_empty_prob<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> problem"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=free>s</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> state"</span></span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>prob_dom <span class=free>PROB</span> <span class=main>=</span> <span class=main>{}</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>s</span> <span class=main>∈</span> valid_states <span class=free>PROB</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>(</span>reachable_s <span class=free>PROB</span> <span class=free>s</span><span class=main>)</span> <span class=main>⊆</span> <span class=main>{</span>fmempty<span class=main>}</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>x</span>
    <span class=keyword3><span class=command>assume</span></span> P1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> reachable_s <span class=free>PROB</span> <span class=free>s</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>as</span></span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> action list"</span></span> <span class=keyword2><span class=keyword>where</span></span> a<span class=main>:</span>
      <span class=quoted><span class=quoted>"<span class=skolem>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>=</span> exec_plan <span class=free>s</span> <span class=skolem>as</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> reachable_s_def
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>=</span> exec_plan <span class=free>s</span> <span class=skolem>as</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> a
      <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>=</span> fmempty"</span></span> <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>,</span> 2<span class=main>)</span> exec_fdom_empty_prob
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>(</span>reachable_s <span class=free>PROB</span> <span class=free>s</span><span class=main>)</span> <span class=main>⊆</span> <span class=main>{</span>fmempty<span class=main>}</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=comment1>― ‹NOTE this is semantically equivalent to `sublist\_valid\_is\_valid`.›</span>
<span class=comment1>― ‹NOTE Renamed to 'sublist\_valid\_plan\_alt' because another lemma by the same name is declared
later.›</span>
<span class=keyword1 id=FactoredSystem-sublist_valid_plan__alt><span class=command>lemma</span></span> sublist_valid_plan__alt<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>as1</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>subseq <span class=free>as2</span> <span class=free>as1</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>as2</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> sublist_valid_is_valid<span class=main>)</span>


<span class=keyword1 id=FactoredSystem-fmsubset_eq><span class=command>lemma</span></span> fmsubset_eq<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>s1</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s2</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>a</span><span class=main>.</span> <span class=bound>a</span> <span class=main>|∈|</span> fmdom <span class=free>s1</span> <span class=main>⟶</span> fmlookup <span class=free>s1</span> <span class=bound>a</span> <span class=main>=</span> fmlookup <span class=free>s2</span> <span class=bound>a</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> <span class=main><span class=main>(</span></span>mono_tags<span class=main><span class=main>,</span></span> lifting<span class=main><span class=main>)</span></span> domIff fmdom_notI fmsubset.rep_eq map_le_def<span class=main>)</span>


<span class=comment1>― ‹NOTE added lemma.›</span>
<span class=comment1>― ‹TODO refactor/move into 'FmapUtils.thy'.›</span>
<span class=keyword1 id=FactoredSystem-submap_imp_state_succ_submap_a><span class=command>lemma</span></span> submap_imp_state_succ_submap_a<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>s1</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s2</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>s2</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s3</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=free>s1</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s3</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms fmsubset.rep_eq map_le_trans
  <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>


<span class=comment1>― ‹NOTE added lemma.›</span>
<span class=comment1>― ‹TODO refactor into FmapUtils?›</span>
<span class=keyword1 id=FactoredSystem-submap_imp_state_succ_submap_b><span class=command>lemma</span></span> submap_imp_state_succ_submap_b<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>s1</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s2</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>s0</span> <span class=main>++</span> <span class=free>s1</span><span class=main>)</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=main>(</span><span class=free>s0</span> <span class=main>++</span> <span class=free>s2</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>assume</span></span> C<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>¬</span><span class=main>(</span><span class=main>(</span><span class=free>s0</span> <span class=main>++</span> <span class=free>s1</span><span class=main>)</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=main>(</span><span class=free>s0</span> <span class=main>++</span> <span class=free>s2</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>s0</span> <span class=main>++</span> <span class=free>s1</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=free>s1</span> <span class=keyword1>++<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s0</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> fmap_add_ltr_def
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> 2<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>s0</span> <span class=main>++</span> <span class=free>s2</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=free>s2</span> <span class=keyword1>++<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s0</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> fmap_add_ltr_def
      <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>a</span></span> <span class=keyword2><span class=keyword>where</span></span> 3<span class=main>:</span>
      <span class=quoted><span class=quoted>"<span class=skolem>a</span> <span class=main>|∈|</span> fmdom <span class=main>(</span><span class=free>s1</span> <span class=keyword1>++<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s0</span><span class=main>)</span> <span class=main>∧</span> fmlookup <span class=main>(</span><span class=free>s1</span> <span class=keyword1>++<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s0</span><span class=main>)</span> <span class=main>≠</span> fmlookup <span class=main>(</span><span class=free>s2</span> <span class=keyword1>++<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s0</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> C 1 2 fmsubset.rep_eq domIff fmdom_notD map_le_def
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> <span class=main><span class=main>(</span></span>no_types<span class=main><span class=main>,</span></span> lifting<span class=main><span class=main>)</span></span><span class=main>)</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted>False</span>
      <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>)</span> C <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=skolem>a</span> <span class=main>|∈|</span> fmdom <span class=free>s1</span>"</span></span><span class=main>)</span>
      <span class=keyword3><span class=command>case</span></span> True
      <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=free>s1</span> <span class=skolem>a</span> <span class=main>=</span> fmlookup <span class=free>s2</span> <span class=skolem>a</span>"</span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>meson</span> assms<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span> calculation fmsubset_eq<span class=main>)</span>
      <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=main>(</span><span class=free>s0</span> <span class=keyword1>++<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s1</span><span class=main>)</span> <span class=skolem>a</span> <span class=main>=</span> fmlookup <span class=free>s1</span> <span class=skolem>a</span>"</span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> True<span class=main>)</span>
      <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a</span> <span class=main>|∈|</span> fmdom <span class=free>s2</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> True calculation<span class=main>(</span>2<span class=main>)</span> fmdom_notD <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
      <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=main>(</span><span class=free>s0</span> <span class=keyword1>++<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s2</span><span class=main>)</span> <span class=skolem>a</span> <span class=main>=</span> fmlookup <span class=free>s2</span> <span class=skolem>a</span>"</span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> calculation<span class=main><span class=main>(</span></span>4<span class=main><span class=main>)</span></span><span class=main>)</span>
      <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=main>(</span><span class=free>s0</span> <span class=keyword1>++<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s1</span><span class=main>)</span> <span class=skolem>a</span> <span class=main>=</span> fmlookup <span class=main>(</span><span class=free>s0</span> <span class=keyword1>++<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s2</span><span class=main>)</span> <span class=skolem>a</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> calculation<span class=main>(</span>2<span class=main>,</span> 3<span class=main>,</span> 5<span class=main>)</span>
        <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>smt</span> <span class=quoted>"1"</span> <span class=quoted>"2"</span> C assms domIff fmlookup_add fmsubset.rep_eq map_le_def<span class=main>)</span>
    <span class=keyword1><span class=command>next</span></span>
      <span class=keyword3><span class=command>case</span></span> False
      <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=main>(</span><span class=free>s0</span> <span class=keyword1>++<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s1</span><span class=main>)</span> <span class=skolem>a</span> <span class=main>=</span> fmlookup <span class=free>s0</span> <span class=skolem>a</span>"</span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> False<span class=main>)</span>
      <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=skolem>a</span> <span class=main>|∈|</span> fmdom <span class=free>s0</span>"</span></span><span class=main>)</span>
        <span class=keyword3><span class=command>case</span></span> True
        <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a</span> <span class=main>|∉|</span> fmdom <span class=main>(</span><span class=free>s1</span> <span class=keyword1>++<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s0</span><span class=main>)</span>"</span></span>
          <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>smt</span> <span class=quoted>"1"</span> <span class=quoted>"2"</span> C UnE assms dom_map_add fmadd.rep_eq fmsubset.rep_eq map_add_def
              map_add_dom_app_simps<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span> map_le_def<span class=main>)</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
          <span class=keyword1><span class=command>using</span></span> 3 <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>next</span></span>
        <span class=keyword3><span class=command>case</span></span> False
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a</span> <span class=main>|∉|</span> fmdom <span class=main>(</span><span class=free>s1</span> <span class=keyword1>++<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s0</span><span class=main>)</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹fmlookup <span class=main>(</span><span class=free>s0</span> <span class=keyword1>++<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s1</span><span class=main>)</span> <span class=skolem>a</span> <span class=main>=</span> fmlookup <span class=free>s0</span> <span class=skolem>a</span>›</span></span>
          <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
          <span class=keyword1><span class=command>using</span></span> 3
          <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>qed</span></span>
    <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=comment1>― ‹NOTE type for `a` had to be fixed (type mismatch in goal).›</span>
<span class=keyword1 id=FactoredSystem-submap_imp_state_succ_submap><span class=command>lemma</span></span> submap_imp_state_succ_submap<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>a</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> action"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=free>s1</span> <span class=free>s2</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>fst <span class=free>a</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s1</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>s1</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s2</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>state_succ <span class=free>s1</span> <span class=free>a</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> state_succ <span class=free>s2</span> <span class=free>a</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"state_succ <span class=free>s1</span> <span class=free>a</span> <span class=main>=</span> <span class=main>(</span>snd <span class=free>a</span> <span class=main>++</span> <span class=free>s1</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>)</span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> state_succ_def<span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fst <span class=free>a</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s2</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>,</span> 2<span class=main>)</span> submap_imp_state_succ_submap_a
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> 2<span class=main>:</span> <span class=quoted><span class=quoted>"state_succ <span class=free>s2</span> <span class=free>a</span> <span class=main>=</span> <span class=main>(</span>snd <span class=free>a</span> <span class=main>++</span> <span class=free>s2</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> 1 state_succ_def
    <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"snd <span class=free>a</span> <span class=main>++</span> <span class=free>s1</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> snd <span class=free>a</span> <span class=main>++</span> <span class=free>s2</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>2<span class=main>)</span> submap_imp_state_succ_submap_b
    <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>using</span></span> 1 2
    <span class=keyword1><span class=command>by</span></span> <span class=operator>argo</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=comment1>― ‹NOTE types for `a`, `s1` and `s2` had to be fixed (type mismatch in goal).›</span>
<span class=keyword1 id=FactoredSystem-pred_dom_subset_succ_submap><span class=command>lemma</span></span> pred_dom_subset_succ_submap<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>a</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> action"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=free>s1</span> <span class=free>s2</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> state"</span></span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>fmdom' <span class=main>(</span>fst <span class=free>a</span><span class=main>)</span> <span class=main>⊆</span> fmdom' <span class=free>s1</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>s1</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s2</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>state_succ <span class=free>s1</span> <span class=free>a</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> state_succ <span class=free>s2</span> <span class=free>a</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>unfolding</span></span> state_succ_def
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>auto</span><span class=main>)</span>
  <span class=keyword3><span class=command>assume</span></span> P1<span class=main>:</span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>fst <span class=free>a</span><span class=main>)</span> <span class=main>⊆</span> fmdom' <span class=free>s1</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>s1</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s2</span>"</span></span> <span class=quoted><span class=quoted>"fst <span class=free>a</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s1</span>"</span></span> <span class=quoted><span class=quoted>"fst <span class=free>a</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s2</span>"</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"snd <span class=free>a</span> <span class=main>++</span> <span class=free>s1</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> snd <span class=free>a</span> <span class=main>++</span> <span class=free>s2</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> submap_imp_state_succ_submap_b
    <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>assume</span></span> P2<span class=main>:</span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>fst <span class=free>a</span><span class=main>)</span> <span class=main>⊆</span> fmdom' <span class=free>s1</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>s1</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s2</span>"</span></span> <span class=quoted><span class=quoted>"fst <span class=free>a</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s1</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span> fst <span class=free>a</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s2</span>"</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"snd <span class=free>a</span> <span class=main>++</span> <span class=free>s1</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s2</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> submap_imp_state_succ_submap_a
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>assume</span></span> P3<span class=main>:</span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>fst <span class=free>a</span><span class=main>)</span> <span class=main>⊆</span> fmdom' <span class=free>s1</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>s1</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s2</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span> fst <span class=free>a</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s1</span>"</span></span> <span class=quoted><span class=quoted>"fst <span class=free>a</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s2</span>"</span></span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword1><span class=command>have</span></span> a<span class=main>:</span> <span class=quoted><span class=quoted>"fmlookup <span class=free>s1</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>m</sub></span> fmlookup <span class=free>s2</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> P3<span class=main>(</span>2<span class=main>)</span> fmsubset.rep_eq
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>{</span></span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span><span class=main>(</span>fmlookup <span class=main>(</span>fst <span class=free>a</span><span class=main>)</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>m</sub></span> fmlookup <span class=free>s1</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> P3<span class=main>(</span>3<span class=main>)</span> fmsubset.rep_eq
        <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>v</span> <span class=main>∈</span> dom <span class=main>(</span>fmlookup <span class=main>(</span>fst <span class=free>a</span><span class=main>)</span><span class=main>)</span><span class=main>.</span> fmlookup <span class=main>(</span>fst <span class=free>a</span><span class=main>)</span> <span class=bound>v</span> <span class=main>≠</span> fmlookup <span class=free>s1</span> <span class=bound>v</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> map_le_def
        <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
    <span class=keyword1><span class=command>}</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>v</span></span> <span class=keyword2><span class=keyword>where</span></span> b<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span> dom <span class=main>(</span>fmlookup <span class=main>(</span>fst <span class=free>a</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=main>(</span>fst <span class=free>a</span><span class=main>)</span> <span class=skolem>v</span> <span class=main>≠</span> fmlookup <span class=free>s1</span> <span class=skolem>v</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=main>(</span>fst <span class=free>a</span><span class=main>)</span> <span class=skolem>v</span> <span class=main>≠</span> fmlookup <span class=free>s2</span> <span class=skolem>v</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>)</span> a  contra_subsetD fmdom'.rep_eq map_le_def
      <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span><span class=main>(</span>fst <span class=free>a</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s2</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> b fmsubset.rep_eq map_le_def
      <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=free>s1</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> snd <span class=free>a</span> <span class=main>++</span> <span class=free>s2</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> P3<span class=main>(</span>4<span class=main>)</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=comment1>― ‹NOTE added lemma.›</span>
<span class=comment1>― ‹TODO refactor.›</span>
<span class=keyword1 id=FactoredSystem-valid_as_submap_init_submap_exec_i><span class=command>lemma</span></span> valid_as_submap_init_submap_exec_i<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>s</span> <span class=free>a</span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=free>s</span> <span class=main>⊆</span> fmdom' <span class=main>(</span>state_succ <span class=free>s</span> <span class=free>a</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"fst <span class=free>a</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s</span>"</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> True
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"state_succ <span class=free>s</span> <span class=free>a</span> <span class=main>=</span> <span class=free>s</span> <span class=keyword1>++<span class=hidden>⇩</span><sub>f</sub></span> <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> state_succ_def
    <span class=keyword1><span class=command>using</span></span> fmap_add_ltr_def
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>state_succ <span class=free>s</span> <span class=free>a</span><span class=main>)</span> <span class=main>=</span> fmdom' <span class=free>s</span> <span class=main>∪</span> fmdom' <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> fmdom'_add
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> False
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>unfolding</span></span> state_succ_def
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=comment1>― ‹NOTE types for `s1` and `s2` had to be fixed in order to apply `pred\_dom\_subset\_succ\_submap`.›</span>
<span class=keyword1 id=FactoredSystem-valid_as_submap_init_submap_exec><span class=command>lemma</span></span> valid_as_submap_init_submap_exec<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>s1</span> <span class=free>s2</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> state"</span></span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>s1</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s2</span><span class=main>)</span> "</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>a</span><span class=main>.</span> ListMem <span class=bound>a</span> <span class=free>as</span> <span class=main>⟶</span> <span class=main>(</span>fmdom' <span class=main>(</span>fst <span class=bound>a</span><span class=main>)</span> <span class=main>⊆</span> fmdom' <span class=free>s1</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>exec_plan <span class=free>s1</span> <span class=free>as</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> exec_plan <span class=free>s2</span> <span class=free>as</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>as</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>s1</span></span> <span class=quoted><span class=free>s2</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>a</span> <span class=skolem>as</span><span class=main>)</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"ListMem <span class=skolem>a</span> <span class=main>(</span><span class=skolem>a</span> <span class=main>#</span> <span class=skolem>as</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> elem
      <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>fst <span class=skolem>a</span><span class=main>)</span> <span class=main>⊆</span> fmdom' <span class=skolem>s1</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>2<span class=main>)</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"state_succ <span class=skolem>s1</span> <span class=skolem>a</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> state_succ <span class=skolem>s2</span> <span class=skolem>a</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>1<span class=main>)</span> pred_dom_subset_succ_submap
      <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>note</span></span> 1 <span class=main>=</span> this
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>b</span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"ListMem <span class=skolem>b</span> <span class=skolem>as</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"ListMem <span class=skolem>b</span> <span class=main>(</span><span class=skolem>a</span> <span class=main>#</span> <span class=skolem>as</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> insert
      <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> a<span class=main>:</span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>fst <span class=skolem>b</span><span class=main>)</span> <span class=main>⊆</span> fmdom' <span class=skolem>s1</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>2<span class=main>)</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=skolem>s1</span> <span class=main>⊆</span> fmdom' <span class=main>(</span>state_succ <span class=skolem>s1</span> <span class=skolem>a</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> valid_as_submap_init_submap_exec_i
      <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>fst <span class=skolem>b</span><span class=main>)</span> <span class=main>⊆</span> fmdom' <span class=main>(</span>state_succ <span class=skolem>s1</span> <span class=skolem>a</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> a
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>using</span></span> 1 Cons.IH<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=main>(</span>state_succ <span class=skolem>s1</span> <span class=skolem>a</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>state_succ <span class=skolem>s2</span> <span class=skolem>a</span><span class=main>)</span>"</span></span><span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
<span class=keyword1><span class=command>qed</span></span> <span class=operator>auto</span>


<span class=keyword1 id=FactoredSystem-valid_plan_mems><span class=command>lemma</span></span> valid_plan_mems<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>ListMem <span class=free>a</span> <span class=free>as</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=free>a</span> <span class=main>∈</span> <span class=free>PROB</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms ListMem_iff in_set_conv_decomp valid_append_valid_suff valid_plan_valid_head
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span><span class=main>)</span>


<span class=comment1>― ‹NOTE typing moved into 'fixes' due to type mismatches when using lemma.›</span>
<span class=comment1>― ‹NOTE showcase (this can't be used due to type problems when the type is specified within
proposition.›</span>
<span class=keyword1 id=FactoredSystem-valid_states_nempty><span class=command>lemma</span></span> valid_states_nempty<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>(</span><span class=tfree>'a</span><span class=main>,</span> <span class=tfree>'b</span><span class=main>)</span> fmap <span class=main>×</span> <span class=main>(</span><span class=tfree>'a</span><span class=main>,</span> <span class=tfree>'b</span><span class=main>)</span> fmap<span class=main>)</span> set"</span></span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"finite <span class=free>PROB</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>s</span><span class=main>.</span> <span class=bound>s</span> <span class=main>∈</span> <span class=main>(</span>valid_states <span class=free>PROB</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> valid_states_def
  <span class=keyword1><span class=command>using</span></span> fmchoice'<span class=main>[</span><span class=operator>OF</span> FINITE_prob_dom<span class=main><span class=main>[</span></span><span class=operator>OF</span> assms<span class=main><span class=main>]</span></span><span class=main>,</span> <span class=keyword2><span class=keyword><span class=operator>where</span></span></span> Q <span class=main><span class=main>=</span></span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=main><span class=bound>_</span></span> <span class=main><span class=bound>_</span></span><span class=main>.</span> True"</span></span><span class=main>]</span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>


<span class=keyword1 id=FactoredSystem-empty_prob_dom_single_val_state><span class=command>lemma</span></span> empty_prob_dom_single_val_state<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>prob_dom <span class=free>PROB</span> <span class=main>=</span> <span class=main>{}</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>s</span><span class=main>.</span> valid_states <span class=free>PROB</span> <span class=main>=</span> <span class=main>{</span><span class=bound>s</span><span class=main>}</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>assume</span></span> C<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>¬</span><span class=main>(</span><span class=main>∃</span><span class=bound>s</span><span class=main>.</span> valid_states <span class=free>PROB</span> <span class=main>=</span> <span class=main>{</span><span class=bound>s</span><span class=main>}</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"valid_states <span class=free>PROB</span> <span class=main>=</span> <span class=main>{</span><span class=bound>s</span><span class=main>.</span> fmdom' <span class=bound>s</span> <span class=main>=</span> <span class=main>{}</span><span class=main>}</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> assms
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> valid_states_def<span class=main>)</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>s</span><span class=main>.</span> valid_states <span class=free>PROB</span> <span class=main>=</span> <span class=main>{</span><span class=bound>s</span><span class=main>}</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> empty_domain_fmap_set
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted>False</span>
      <span class=keyword1><span class=command>using</span></span> C
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1 id=FactoredSystem-empty_prob_dom_imp_empty_plan_always_good><span class=command>lemma</span></span> empty_prob_dom_imp_empty_plan_always_good<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=free>s</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>prob_dom <span class=free>PROB</span> <span class=main>=</span> <span class=main>{}</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>s</span> <span class=main>∈</span> valid_states <span class=free>PROB</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>exec_plan <span class=free>s</span> <span class=main>[]</span> <span class=main>=</span> exec_plan <span class=free>s</span> <span class=free>as</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms empty_plan_is_valid exec_fdom_empty_prob
  <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>


<span class=keyword1 id=FactoredSystem-empty_prob_dom><span class=command>lemma</span></span> empty_prob_dom<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>prob_dom <span class=free>PROB</span> <span class=main>=</span> <span class=main>{}</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>PROB</span> <span class=main>=</span> <span class=main>{</span><span class=main>(</span>fmempty<span class=main>,</span> fmempty<span class=main>)</span><span class=main>}</span> <span class=main>∨</span> <span class=free>PROB</span> <span class=main>=</span> <span class=main>{}</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=free>PROB</span> <span class=main>=</span> <span class=main>{}</span>"</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> False
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>⋃</span><span class=main>(</span><span class=main>(</span><span class=main>λ</span><span class=main>(</span><span class=bound>s1</span><span class=main>,</span> <span class=bound>s2</span><span class=main>)</span><span class=main>.</span> fmdom' <span class=bound>s1</span> <span class=main>∪</span> fmdom' <span class=bound>s2</span><span class=main>)</span> <span class=main>`</span> <span class=free>PROB</span><span class=main>)</span> <span class=main>=</span> <span class=main>{}</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> prob_dom_def action_dom_def<span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span><span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>a</span><span class=main>∈</span><span class=free>PROB</span><span class=main>.</span> <span class=main>(</span><span class=main>λ</span><span class=main>(</span><span class=bound>s1</span><span class=main>,</span> <span class=bound>s2</span><span class=main>)</span><span class=main>.</span> fmdom' <span class=bound>s1</span> <span class=main>∪</span> fmdom' <span class=bound>s2</span><span class=main>)</span> <span class=bound>a</span> <span class=main>=</span> <span class=main>{}</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span>  Union_empty_conv
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>a</span>
    <span class=keyword3><span class=command>assume</span></span> P1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>a</span><span class=main>∈</span><span class=free>PROB</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>λ</span><span class=main>(</span><span class=bound>s1</span><span class=main>,</span> <span class=bound>s2</span><span class=main>)</span><span class=main>.</span> fmdom' <span class=bound>s1</span> <span class=main>∪</span> fmdom' <span class=bound>s2</span><span class=main>)</span> <span class=skolem>a</span> <span class=main>=</span> <span class=main>{}</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> 1
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> a<span class=main>:</span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>fst <span class=skolem>a</span><span class=main>)</span> <span class=main>=</span> <span class=main>{}</span>"</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>snd <span class=skolem>a</span><span class=main>)</span> <span class=main>=</span> <span class=main>{}</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span><span class=main><span class=keyword3>+</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> b<span class=main>:</span> <span class=quoted><span class=quoted>"fst <span class=skolem>a</span> <span class=main>=</span> fmempty"</span></span>
      <span class=keyword1><span class=command>using</span></span> fmrestrict_set_dom fmrestrict_set_null
      <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"snd <span class=skolem>a</span> <span class=main>=</span> fmempty"</span></span>
      <span class=keyword1><span class=command>using</span></span> a<span class=main>(</span>2<span class=main>)</span> fmrestrict_set_dom fmrestrict_set_null
      <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a</span> <span class=main>=</span> <span class=main>(</span>fmempty<span class=main>,</span> fmempty<span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> b surjective_pairing
      <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>PROB</span> <span class=main>=</span> <span class=main>{</span><span class=main>(</span>fmempty<span class=main>,</span> fmempty<span class=main>)</span><span class=main>}</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> False
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span> <span class=operator>simp</span>


<span class=keyword1 id=FactoredSystem-empty_prob_dom_finite><span class=command>lemma</span></span> empty_prob_dom_finite<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> problem"</span></span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"prob_dom <span class=free>PROB</span> <span class=main>=</span> <span class=main>{}</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"finite <span class=free>PROB</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>consider</span></span> <span class=main>(</span>i<span class=main>)</span> <span class=quoted><span class=quoted>"<span class=free>PROB</span> <span class=main>=</span> <span class=main>{</span><span class=main>(</span>fmempty<span class=main>,</span> fmempty<span class=main>)</span><span class=main>}</span>"</span></span> <span class=main>|</span> <span class=main>(</span>ii<span class=main>)</span> <span class=quoted><span class=quoted>"<span class=free>PROB</span> <span class=main>=</span> <span class=main>{}</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms empty_prob_dom
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span><span class=main>)</span> <span class=operator>auto</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=comment1>― ‹NOTE type for `a` had to be fixed (type mismatch in goal).›</span>
<span class=keyword1 id=FactoredSystem-disj_imp_eq_proj_exec><span class=command>lemma</span></span> disj_imp_eq_proj_exec<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>a</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=tfree>'a</span><span class=main>,</span> <span class=tfree>'b</span><span class=main>)</span> fmap <span class=main>×</span> <span class=main>(</span><span class=tfree>'a</span><span class=main>,</span> <span class=tfree>'b</span><span class=main>)</span> fmap"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=free>vs</span> <span class=free>s</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>fmdom' <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span> <span class=main>∩</span> <span class=free>vs</span><span class=main>)</span> <span class=main>=</span> <span class=main>{}</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span> <span class=main>=</span> fmrestrict_set <span class=free>vs</span> <span class=main>(</span>state_succ <span class=free>s</span> <span class=free>a</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"disjnt <span class=main>(</span>fmdom' <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span><span class=main>)</span> <span class=free>vs</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms disjnt_def
    <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>using</span></span> disj_dom_drest_fupdate_eq state_succ_pair surjective_pairing
    <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1 id=FactoredSystem-no_change_vs_eff_submap><span class=command>lemma</span></span> no_change_vs_eff_submap<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>a</span> <span class=free>vs</span> <span class=free>s</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span> <span class=main>=</span> fmrestrict_set <span class=free>vs</span> <span class=main>(</span>state_succ <span class=free>s</span> <span class=free>a</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>fst <span class=free>a</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>x</span>
    <span class=keyword3><span class=command>assume</span></span> P3<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> dom <span class=main>(</span>fmlookup <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>fmlookup <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=skolem>x</span> <span class=main>=</span> <span class=main>(</span>fmlookup <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span> <span class=skolem>x</span>"</span></span>
    <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"fmlookup <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span><span class=main>)</span> <span class=skolem>x</span>"</span></span><span class=main>)</span>
      <span class=keyword3><span class=command>case</span></span> None
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> P3 <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>next</span></span>
      <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Some <span class=skolem>y</span><span class=main>)</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmrestrict_set <span class=free>vs</span> <span class=free>s</span> <span class=main>=</span> fmrestrict_set <span class=free>vs</span> <span class=main>(</span><span class=free>s</span> <span class=keyword1>++<span class=hidden>⇩</span><sub>f</sub></span> snd <span class=free>a</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> assms
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> state_succ_def fmap_add_ltr_def<span class=main>)</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span> <span class=main>=</span> fmlookup <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=main>(</span><span class=free>s</span> <span class=keyword1>++<span class=hidden>⇩</span><sub>f</sub></span> snd <span class=free>a</span><span class=main>)</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"
            fmlookup <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span> <span class=skolem>x</span>
            <span class=main>=</span> <span class=main>(</span><span class=keyword1>if</span> <span class=skolem>x</span> <span class=main>∈</span> <span class=free>vs</span> <span class=keyword1>then</span> fmlookup <span class=main>(</span><span class=free>s</span> <span class=keyword1>++<span class=hidden>⇩</span><sub>f</sub></span> snd <span class=free>a</span><span class=main>)</span> <span class=skolem>x</span> <span class=keyword1>else</span> None<span class=main>)</span>
          "</span></span>
        <span class=keyword1><span class=command>using</span></span> fmlookup_restrict_set
        <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> <span class=free>vs</span>"</span></span><span class=main>)</span>
        <span class=keyword3><span class=command>case</span></span> True
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span> <span class=skolem>x</span> <span class=main>=</span> fmlookup <span class=main>(</span><span class=free>s</span> <span class=keyword1>++<span class=hidden>⇩</span><sub>f</sub></span> snd <span class=free>a</span><span class=main>)</span> <span class=skolem>x</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> True 1
          <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
          <span class=keyword1><span class=command>using</span></span> Some fmadd.rep_eq fmlookup_restrict_set map_add_Some_iff
          <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> <span class=main><span class=main>(</span></span>mono_tags<span class=main><span class=main>,</span></span> lifting<span class=main><span class=main>)</span></span><span class=main>)</span>
      <span class=keyword1><span class=command>next</span></span>
        <span class=keyword3><span class=command>case</span></span> False
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"fmlookup <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span> <span class=skolem>x</span> <span class=main>=</span> None"</span></span>
          <span class=keyword1><span class=command>using</span></span> False <span class=quoted>"1"</span>
          <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
          <span class=keyword1><span class=command>using</span></span> 1 False
          <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword1><span class=command>qed</span></span>
    <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>fmlookup <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span><span class=main>)</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>m</sub></span> fmlookup <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> map_le_def
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>using</span></span> fmsubset.rep_eq
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=comment1>― ‹NOTE type of `a` had to be fixed.›</span>
<span class=keyword1 id=FactoredSystem-sat_precond_as_proj_3><span class=command>lemma</span></span> sat_precond_as_proj_3<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>s</span> <span class=keyword2><span class=keyword>and</span></span> <span class=free>a</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=tfree>'a</span><span class=main>,</span> <span class=tfree>'b</span><span class=main>)</span> fmap <span class=main>×</span> <span class=main>(</span><span class=tfree>'a</span><span class=main>,</span> <span class=tfree>'b</span><span class=main>)</span> fmap"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=free>vs</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>fmdom' <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>{}</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=main>(</span>state_succ <span class=free>s</span> <span class=free>a</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>{}</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms fmrestrict_set_dom fmrestrict_set_empty fmrestrict_set_null
    <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>x</span>
    <span class=keyword3><span class=command>assume</span></span> C<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> fmdom' <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span> <span class=main>∧</span> <span class=skolem>x</span> <span class=main>∈</span> <span class=free>vs</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> a<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> fmdom' <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> <span class=free>vs</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> C
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span><span class=main><span class=keyword3>+</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span> <span class=skolem>x</span> <span class=main>≠</span> None"</span></span>
      <span class=keyword1><span class=command>using</span></span> fmdom'_notI
      <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span><span class=main>)</span> <span class=skolem>x</span> <span class=main>≠</span> None"</span></span>
      <span class=keyword1><span class=command>using</span></span> a<span class=main>(</span>2<span class=main>)</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> fmdom' <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> fmdom'_notD
      <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span><span class=main>)</span> <span class=main>≠</span> <span class=main>{}</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted>False</span>
      <span class=keyword1><span class=command>using</span></span> assms
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>x</span><span class=main>.</span> <span class=main>¬</span><span class=main>(</span><span class=bound>x</span> <span class=main>∈</span> fmdom' <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span> <span class=main>∧</span> <span class=bound>x</span> <span class=main>∈</span> <span class=free>vs</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span> <span class=main>∩</span> <span class=free>vs</span> <span class=main>=</span> <span class=main>{}</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"disjnt <span class=main>(</span>fmdom' <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span><span class=main>)</span> <span class=free>vs</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> 1 disjnt_def
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>using</span></span> 1 disj_imp_eq_proj_exec
    <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=comment1>― ‹NOTE type for `a` had to be fixed (type mismatch in goal).›</span>
<span class=comment1>― ‹TODO showcase (quick win with simp).›</span>
<span class=keyword1 id=FactoredSystem-proj_eq_proj_exec_eq><span class=command>lemma</span></span> proj_eq_proj_exec_eq<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>s</span> <span class=free>s'</span> <span class=free>vs</span> <span class=keyword2><span class=keyword>and</span></span> <span class=free>a</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=tfree>'a</span><span class=main>,</span> <span class=tfree>'b</span><span class=main>)</span> fmap <span class=main>×</span> <span class=main>(</span><span class=tfree>'a</span><span class=main>,</span> <span class=tfree>'b</span><span class=main>)</span> fmap"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=free>a'</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s'</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>(</span>fst <span class=free>a</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span>fst <span class=free>a'</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s'</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span> <span class=main>=</span> fmrestrict_set <span class=free>vs</span> <span class=main>(</span>snd <span class=free>a'</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=main>(</span>state_succ <span class=free>s</span> <span class=free>a</span><span class=main>)</span> <span class=main>=</span> fmrestrict_set <span class=free>vs</span> <span class=main>(</span>state_succ <span class=free>s'</span> <span class=free>a'</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> fmap_add_ltr_def state_succ_def<span class=main>)</span>


<span class=keyword1 id=FactoredSystem-empty_eff_exec_eq><span class=command>lemma</span></span> empty_eff_exec_eq<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>s</span> <span class=free>a</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>fmdom' <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span> <span class=main>=</span> <span class=main>{}</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>state_succ <span class=free>s</span> <span class=free>a</span> <span class=main>=</span> <span class=free>s</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>unfolding</span></span> state_succ_def fmap_add_ltr_def
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> fmadd_empty<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span> fmrestrict_set_dom fmrestrict_set_null<span class=main>)</span>


<span class=keyword1 id=FactoredSystem-exec_as_proj_valid_2><span class=command>lemma</span></span> exec_as_proj_valid_2<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>a</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>a</span> <span class=main>∈</span> <span class=free>PROB</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>action_dom <span class=main>(</span>fst <span class=free>a</span><span class=main>)</span> <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span> <span class=main>⊆</span> prob_dom <span class=free>PROB</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> FDOM_eff_subset_prob_dom_pair FDOM_pre_subset_prob_dom_pair action_dom_def<span class=main>)</span>


<span class=keyword1 id=FactoredSystem-valid_filter_valid_as><span class=command>lemma</span></span> valid_filter_valid_as<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>filter <span class=free>P</span> <span class=free>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> valid_plans_def<span class=main>)</span>


<span class=keyword1 id=FactoredSystem-sublist_valid_plan><span class=command>lemma</span></span> sublist_valid_plan<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>subseq <span class=free>as'</span> <span class=free>as</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>as'</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> valid_plans_def<span class=main>)</span> <span class=main>(</span><span class=operator>meson</span> fset_mp fset_of_list_elem sublist_subset subsetCE<span class=main>)</span>


<span class=keyword1 id=FactoredSystem-prob_subset_dom_subset><span class=command>lemma</span></span> prob_subset_dom_subset<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>PROB1</span> <span class=main>⊆</span> <span class=free>PROB2</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>prob_dom <span class=free>PROB1</span> <span class=main>⊆</span> prob_dom <span class=free>PROB2</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> prob_dom_def<span class=main>)</span>


<span class=keyword1 id=FactoredSystem-state_succ_valid_act_disjoint><span class=command>lemma</span></span> state_succ_valid_act_disjoint<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>a</span> <span class=main>∈</span> <span class=free>PROB</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>vs</span> <span class=main>∩</span> <span class=main>(</span>prob_dom <span class=free>PROB</span><span class=main>)</span> <span class=main>=</span> <span class=main>{}</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=main>(</span>state_succ <span class=free>s</span> <span class=free>a</span><span class=main>)</span> <span class=main>=</span> fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>smt</span>
      FDOM_eff_subset_prob_dom_pair disj_imp_eq_proj_exec inf.absorb1
      inf_bot_right inf_commute inf_left_commute
      <span class=main>)</span>


<span class=keyword1 id=FactoredSystem-exec_valid_as_disjoint><span class=command>lemma</span></span> exec_valid_as_disjoint<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>s</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>vs</span> <span class=main>∩</span> <span class=main>(</span>prob_dom <span class=free>PROB</span><span class=main>)</span> <span class=main>=</span> <span class=main>{}</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=main>(</span>exec_plan <span class=free>s</span> <span class=free>as</span><span class=main>)</span> <span class=main>=</span> fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>as</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>s</span></span> <span class=quoted><span class=free>vs</span></span> <span class=quoted><span class=free>PROB</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>a</span> <span class=skolem>as</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> exec_plan.simps<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span> state_succ_valid_act_disjoint valid_plan_valid_head
        valid_plan_valid_tail<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span> <span class=operator>simp</span>


<span class=keyword1><span class=command>definition</span></span> <span class=entity>state_successors</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>state_successors</span> <span class=free><span class=bound><span class=entity>PROB</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=main>≡</span> <span class=main>(</span><span class=main>(</span>state_succ <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=main>`</span> <span class=free><span class=bound><span class=entity>PROB</span></span></span><span class=main>)</span> <span class=main>-</span> <span class=main>{</span><span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>}</span><span class=main>)</span>"</span></span>


<span class=keyword1><span class=command>subsection</span></span> <span class=quoted><span class=plain_text>"State Spaces"</span></span>


<span class=keyword1><span class=command>definition</span></span> <span class=entity>stateSpace</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>stateSpace</span> <span class=free><span class=bound><span class=entity>ss</span></span></span> <span class=free><span class=bound><span class=entity>vs</span></span></span> <span class=main>≡</span> <span class=main>(</span><span class=main>∀</span><span class=bound>s</span><span class=main>.</span> <span class=bound>s</span> <span class=main>∈</span> <span class=free><span class=bound><span class=entity>ss</span></span></span> <span class=main>⟶</span> <span class=main>(</span>fmdom' <span class=bound>s</span> <span class=main>=</span> <span class=free><span class=bound><span class=entity>vs</span></span></span><span class=main>)</span><span class=main>)</span>"</span></span>


<span class=keyword1 id=FactoredSystem-EQ_SS_DOM><span class=command>lemma</span></span> EQ_SS_DOM<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span><span class=main>(</span><span class=free>ss</span> <span class=main>=</span> <span class=main>{}</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>stateSpace <span class=free>ss</span> <span class=free>vs1</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>stateSpace <span class=free>ss</span> <span class=free>vs2</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>vs1</span> <span class=main>=</span> <span class=free>vs2</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> stateSpace_def<span class=main>)</span>


<span class=comment1>― ‹NOTE Name 'dom' changed to 'domain' because of name clash with 'Map.dom'.›</span>
<span class=keyword1 id=FactoredSystem-FINITE_SS><span class=command>lemma</span></span> FINITE_SS<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>ss</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=tfree>'a</span><span class=main>,</span> bool<span class=main>)</span> fmap set"</span></span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span><span class=main>(</span><span class=free>ss</span> <span class=main>=</span> <span class=main>{}</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>stateSpace <span class=free>ss</span> <span class=free>domain</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"finite <span class=free>ss</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"stateSpace <span class=free>ss</span> <span class=free>domain</span> <span class=main>=</span> <span class=main>(</span><span class=main>∀</span><span class=bound>s</span><span class=main>.</span> <span class=bound>s</span> <span class=main>∈</span> <span class=free>ss</span> <span class=main>⟶</span> <span class=main>(</span>fmdom' <span class=bound>s</span> <span class=main>=</span> <span class=free>domain</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> stateSpace_def<span class=main>)</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>s</span>
    <span class=keyword3><span class=command>assume</span></span> P1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>s</span> <span class=main>∈</span> <span class=free>ss</span>"</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=skolem>s</span> <span class=main>=</span> <span class=free>domain</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> assms 1 P1
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>s</span> <span class=main>∈</span> <span class=main>{</span><span class=bound>s</span><span class=main>.</span> fmdom' <span class=bound>s</span> <span class=main>=</span> <span class=free>domain</span><span class=main>}</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> 2<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>ss</span> <span class=main>⊆</span> <span class=main>{</span><span class=bound>s</span><span class=main>.</span> fmdom' <span class=bound>s</span> <span class=main>=</span> <span class=free>domain</span><span class=main>}</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=comment1>― ‹TODO add lemma (finite (fmdom' s))›</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"finite <span class=free>domain</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> 1 assms
    <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"finite <span class=main>{</span><span class=bound>s</span> <span class=main>::</span> <span class=tfree>'a</span> state<span class=main>.</span> fmdom' <span class=bound>s</span> <span class=main>=</span> <span class=free>domain</span><span class=main>}</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> FINITE_states
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>using</span></span> 2 finite_subset
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1 id=FactoredSystem-disjoint_effects_no_effects><span class=command>lemma</span></span> disjoint_effects_no_effects<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>s</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>a</span><span class=main>.</span> ListMem <span class=bound>a</span> <span class=free>as</span> <span class=main>⟶</span> <span class=main>(</span>fmdom' <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=main>(</span>snd <span class=bound>a</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>{}</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=main>(</span>exec_plan <span class=free>s</span> <span class=free>as</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>as</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>s</span></span> <span class=quoted><span class=free>vs</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>a</span> <span class=skolem>as</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"ListMem <span class=skolem>a</span> <span class=main>(</span><span class=skolem>a</span> <span class=main>#</span> <span class=skolem>as</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> elem
    <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>fmrestrict_set <span class=skolem>vs</span> <span class=main>(</span>snd <span class=skolem>a</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>{}</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>1<span class=main>)</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmrestrict_set <span class=skolem>vs</span> <span class=main>(</span>state_succ <span class=skolem>s</span> <span class=skolem>a</span><span class=main>)</span> <span class=main>=</span> fmrestrict_set <span class=skolem>vs</span> <span class=skolem>s</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> sat_precond_as_proj_3
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> Cons.IH Cons.prems insert<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span> <span class=operator>auto</span>


<span class=keyword1><span class=command>subsection</span></span> <span class=quoted><span class=plain_text>"Needed Asses"</span></span>


<span class=comment1>― ‹NOTE name shortened.›</span>
<span class=keyword1><span class=command>definition</span></span> <span class=entity>action_needed_vars</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>action_needed_vars</span> <span class=free><span class=bound><span class=entity>a</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=main>≡</span> <span class=main>{</span><span class=bound>v</span><span class=main>.</span> <span class=main>(</span><span class=bound>v</span> <span class=main>∈</span> fmdom' <span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=bound>v</span> <span class=main>∈</span> fmdom' <span class=main>(</span>fst <span class=free><span class=bound><span class=entity>a</span></span></span><span class=main>)</span><span class=main>)</span>
    <span class=main>∧</span> <span class=main>(</span>fmlookup <span class=main>(</span>fst <span class=free><span class=bound><span class=entity>a</span></span></span><span class=main>)</span> <span class=bound>v</span> <span class=main>=</span> fmlookup <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=bound>v</span><span class=main>)</span><span class=main>}</span>"</span></span>
  <span class=comment1>― ‹NOTE name shortened to 'action\_needed\_asses'.›</span>
<span class=keyword1><span class=command>definition</span></span> <span class=entity>action_needed_asses</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>action_needed_asses</span> <span class=free><span class=bound><span class=entity>a</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=main>≡</span> fmrestrict_set <span class=main>(</span>action_needed_vars <span class=free><span class=bound><span class=entity>a</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>s</span></span></span>"</span></span>


<span class=comment1>― ‹NOTE type for 'a' had to be fixed (type mismatch in goal).›</span>
<span class=keyword1 id=FactoredSystem-act_needed_asses_submap_succ_submap><span class=command>lemma</span></span> act_needed_asses_submap_succ_submap<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>a</span> <span class=free>s1</span> <span class=free>s2</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>action_needed_asses <span class=free>a</span> <span class=free>s2</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> action_needed_asses <span class=free>a</span> <span class=free>s1</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>s1</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s2</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>state_succ <span class=free>s1</span> <span class=free>a</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> state_succ <span class=free>s2</span> <span class=free>a</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>unfolding</span></span> state_succ_def
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>auto</span><span class=main>)</span>
  <span class=keyword3><span class=command>assume</span></span> P1<span class=main>:</span> <span class=quoted><span class=quoted>"action_needed_asses <span class=free>a</span> <span class=free>s2</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> action_needed_asses <span class=free>a</span> <span class=free>s1</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>s1</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s2</span>"</span></span> <span class=quoted><span class=quoted>"fst <span class=free>a</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s1</span>"</span></span>
    <span class=quoted><span class=quoted>"fst <span class=free>a</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s2</span>"</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"snd <span class=free>a</span> <span class=main>++</span> <span class=free>s1</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> snd <span class=free>a</span> <span class=main>++</span> <span class=free>s2</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> submap_imp_state_succ_submap_b
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>assume</span></span> P2<span class=main>:</span> <span class=quoted><span class=quoted>"action_needed_asses <span class=free>a</span> <span class=free>s2</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> action_needed_asses <span class=free>a</span> <span class=free>s1</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>s1</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s2</span>"</span></span> <span class=quoted><span class=quoted>"fst <span class=free>a</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s1</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>¬</span> fst <span class=free>a</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s2</span>"</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"snd <span class=free>a</span> <span class=main>++</span> <span class=free>s1</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s2</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> submap_imp_state_succ_submap_a
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>assume</span></span> P3<span class=main>:</span> <span class=quoted><span class=quoted>"action_needed_asses <span class=free>a</span> <span class=free>s2</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> action_needed_asses <span class=free>a</span> <span class=free>s1</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>s1</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s2</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span> fst <span class=free>a</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s1</span>"</span></span>
    <span class=quoted><span class=quoted>"fst <span class=free>a</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s2</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?vs1</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>{</span><span class=bound><span class=bound>v</span></span> <span class=main>∈</span> fmdom' <span class=free>s1</span><span class=main>.</span> <span class=bound>v</span> <span class=main>∈</span> fmdom' <span class=main>(</span>fst <span class=free>a</span><span class=main>)</span> <span class=main>∧</span> fmlookup <span class=main>(</span>fst <span class=free>a</span><span class=main>)</span> <span class=bound>v</span> <span class=main>=</span> fmlookup <span class=free>s1</span> <span class=bound>v</span><span class=main>}</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?vs2</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>{</span><span class=bound><span class=bound>v</span></span> <span class=main>∈</span> fmdom' <span class=free>s2</span><span class=main>.</span> <span class=bound>v</span> <span class=main>∈</span> fmdom' <span class=main>(</span>fst <span class=free>a</span><span class=main>)</span> <span class=main>∧</span> fmlookup <span class=main>(</span>fst <span class=free>a</span><span class=main>)</span> <span class=bound>v</span> <span class=main>=</span> fmlookup <span class=free>s2</span> <span class=bound>v</span><span class=main>}</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?f</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"fmrestrict_set <span class=var>?vs1</span> <span class=free>s1</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?g</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"fmrestrict_set <span class=var>?vs2</span> <span class=free>s2</span>"</span></span>
  <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"fmdom' <span class=var>?f</span> <span class=main>=</span> <span class=var>?vs1</span>"</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=var>?g</span> <span class=main>=</span> <span class=var>?vs2</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> action_needed_asses_def action_needed_vars_def fmdom'_restrict_set_precise
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span><span class=main><span class=keyword3>+</span></span>
  <span class=keyword1><span class=command>have</span></span> 2<span class=main>:</span> <span class=quoted><span class=quoted>"fmlookup <span class=var>?g</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>m</sub></span> fmlookup <span class=var>?f</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> P3<span class=main>(</span>1<span class=main>)</span>
    <span class=keyword1><span class=command>unfolding</span></span> action_needed_asses_def action_needed_vars_def
    <span class=keyword1><span class=command>using</span></span> fmsubset.rep_eq
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword1><span class=command>{</span></span>
      <span class=keyword3><span class=command>fix</span></span> <span class=skolem>v</span>
      <span class=keyword3><span class=command>assume</span></span> P3_1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span> fmdom' <span class=var>?g</span>"</span></span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span> fmdom' <span class=free>s2</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span> fmdom' <span class=main>(</span>fst <span class=free>a</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=main>(</span>fst <span class=free>a</span><span class=main>)</span> <span class=skolem>v</span> <span class=main>=</span> fmlookup <span class=free>s2</span> <span class=skolem>v</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> 1
        <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span><span class=main><span class=keyword3>+</span></span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=main>(</span>fst <span class=free>a</span><span class=main>)</span> <span class=skolem>v</span> <span class=main>=</span> fmlookup <span class=var>?g</span> <span class=skolem>v</span>"</span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=main>(</span>fst <span class=free>a</span><span class=main>)</span> <span class=skolem>v</span> <span class=main>=</span> fmlookup <span class=var>?f</span> <span class=skolem>v</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> 2
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> <span class=main><span class=main>(</span></span>mono_tags<span class=main><span class=main>,</span></span> lifting<span class=main><span class=main>)</span></span> P3_1 domIff fmdom'_notI map_le_def<span class=main>)</span>
    <span class=keyword1><span class=command>}</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> i<span class=main>:</span> <span class=quoted><span class=quoted>"fmlookup <span class=main>(</span>fst <span class=free>a</span><span class=main>)</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>m</sub></span> fmlookup <span class=var>?f</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> P3<span class=main>(</span>4<span class=main>)</span> 1<span class=main>(</span>2<span class=main>)</span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>smt</span> domIff fmdom'_notD fmsubset.rep_eq map_le_def mem_Collect_eq<span class=main>)</span>
    <span class=keyword1><span class=command>{</span></span>
      <span class=keyword3><span class=command>fix</span></span> <span class=skolem>v</span>
      <span class=keyword3><span class=command>assume</span></span> P3_2<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span> dom <span class=main>(</span>fmlookup <span class=main>(</span>fst <span class=free>a</span><span class=main>)</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=main>(</span>fst <span class=free>a</span><span class=main>)</span> <span class=skolem>v</span> <span class=main>=</span> fmlookup <span class=var>?f</span> <span class=skolem>v</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> i
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>meson</span> domIff fmdom'_notI map_le_def<span class=main>)</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span> <span class=var>?vs1</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> P3_2 1<span class=main>(</span>1<span class=main>)</span>
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> <span class=main><span class=main>(</span></span>no_types<span class=main><span class=main>,</span></span> lifting<span class=main><span class=main>)</span></span> domIff fmdom'_notD<span class=main>)</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=main>(</span>fst <span class=free>a</span><span class=main>)</span> <span class=skolem>v</span> <span class=main>=</span> fmlookup <span class=free>s1</span> <span class=skolem>v</span>"</span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>}</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fst <span class=free>a</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s1</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> map_le_def fmsubset.rep_eq<span class=main>)</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=free>s1</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> snd <span class=free>a</span> <span class=main>++</span> <span class=free>s2</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> P3<span class=main>(</span>3<span class=main>)</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=comment1>― ‹NOTE added lemma.›</span>
<span class=comment1>― ‹TODO refactor.›</span>
<span class=keyword1 id=FactoredSystem-as_needed_asses_submap_exec_i><span class=command>lemma</span></span> as_needed_asses_submap_exec_i<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>a</span> <span class=free>s</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>v</span> <span class=main>∈</span> fmdom' <span class=main>(</span>action_needed_asses <span class=free>a</span> <span class=free>s</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"
    fmlookup <span class=main>(</span>action_needed_asses <span class=free>a</span> <span class=free>s</span><span class=main>)</span> <span class=free>v</span> <span class=main>=</span> fmlookup <span class=free>s</span> <span class=free>v</span>
    <span class=main>∧</span> fmlookup <span class=main>(</span>action_needed_asses <span class=free>a</span> <span class=free>s</span><span class=main>)</span> <span class=free>v</span> <span class=main>=</span> fmlookup <span class=main>(</span>fst <span class=free>a</span><span class=main>)</span> <span class=free>v</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>unfolding</span></span> action_needed_asses_def action_needed_vars_def
  <span class=keyword1><span class=command>using</span></span> fmdom'_notI fmlookup_restrict_set
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>smt</span> mem_Collect_eq<span class=main>)</span>

<span class=comment1>― ‹NOTE added lemma.›</span>
<span class=comment1>― ‹TODO refactor.›</span>
<span class=keyword1 id=FactoredSystem-as_needed_asses_submap_exec_ii><span class=command>lemma</span></span> as_needed_asses_submap_exec_ii<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>f</span> <span class=free>g</span> <span class=free>v</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>v</span> <span class=main>∈</span> fmdom' <span class=free>f</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>f</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>g</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=free>f</span> <span class=free>v</span> <span class=main>=</span> fmlookup <span class=free>g</span> <span class=free>v</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>meson</span> fmdom'_notI fmdom_notD fmsubset_eq<span class=main>)</span>

<span class=comment1>― ‹NOTE added lemma.›</span>
<span class=comment1>― ‹TODO refactor.›</span>
<span class=keyword1 id=FactoredSystem-as_needed_asses_submap_exec_iii><span class=command>lemma</span></span> as_needed_asses_submap_exec_iii<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>f</span> <span class=free>g</span> <span class=free>v</span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"
    fmdom' <span class=main>(</span>action_needed_asses <span class=free>a</span> <span class=free>s</span><span class=main>)</span>
    <span class=main>=</span> <span class=main>{</span><span class=bound><span class=bound>v</span></span> <span class=main>∈</span> fmdom' <span class=free>s</span><span class=main>.</span> <span class=bound>v</span> <span class=main>∈</span> fmdom' <span class=main>(</span>fst <span class=free>a</span><span class=main>)</span> <span class=main>∧</span> fmlookup <span class=main>(</span>fst <span class=free>a</span><span class=main>)</span> <span class=bound>v</span> <span class=main>=</span> fmlookup <span class=free>s</span> <span class=bound>v</span><span class=main>}</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> action_needed_asses_def action_needed_vars_def
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> Set.filter_def fmfilter_alt_defs<span class=main><span class=main>(</span></span>4<span class=main><span class=main>)</span></span><span class=main>)</span>

<span class=comment1>― ‹NOTE added lemma.›</span>
<span class=keyword1 id=FactoredSystem-as_needed_asses_submap_exec_iv><span class=command>lemma</span></span> as_needed_asses_submap_exec_iv<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>f</span> <span class=free>a</span> <span class=free>v</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>v</span> <span class=main>∈</span> fmdom' <span class=main>(</span>action_needed_asses <span class=free>a</span> <span class=free>s</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"
    fmlookup <span class=main>(</span>action_needed_asses <span class=free>a</span> <span class=free>s</span><span class=main>)</span> <span class=free>v</span> <span class=main>=</span> fmlookup <span class=free>s</span> <span class=free>v</span>
    <span class=main>∧</span> fmlookup <span class=main>(</span>action_needed_asses <span class=free>a</span> <span class=free>s</span><span class=main>)</span> <span class=free>v</span> <span class=main>=</span> fmlookup <span class=main>(</span>fst <span class=free>a</span><span class=main>)</span> <span class=free>v</span>
    <span class=main>∧</span> fmlookup <span class=main>(</span>fst <span class=free>a</span><span class=main>)</span> <span class=free>v</span> <span class=main>=</span> fmlookup <span class=free>s</span> <span class=free>v</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>v</span> <span class=main>∈</span> <span class=main>{</span><span class=bound><span class=bound>v</span></span> <span class=main>∈</span> fmdom' <span class=free>s</span><span class=main>.</span> <span class=bound>v</span> <span class=main>∈</span> fmdom' <span class=main>(</span>fst <span class=free>a</span><span class=main>)</span> <span class=main>∧</span> fmlookup <span class=main>(</span>fst <span class=free>a</span><span class=main>)</span> <span class=bound>v</span> <span class=main>=</span> fmlookup <span class=free>s</span> <span class=bound>v</span><span class=main>}</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms as_needed_asses_submap_exec_iii
    <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> 2<span class=main>:</span> <span class=quoted><span class=quoted>"fmlookup <span class=main>(</span>action_needed_asses <span class=free>a</span> <span class=free>s</span><span class=main>)</span> <span class=free>v</span> <span class=main>=</span> fmlookup <span class=free>s</span> <span class=free>v</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> action_needed_asses_def action_needed_vars_def
    <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> 3<span class=main>:</span> <span class=quoted><span class=quoted>"fmlookup <span class=main>(</span>action_needed_asses <span class=free>a</span> <span class=free>s</span><span class=main>)</span> <span class=free>v</span> <span class=main>=</span> fmlookup <span class=main>(</span>fst <span class=free>a</span><span class=main>)</span> <span class=free>v</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> 1 2
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=main>(</span>fst <span class=free>a</span><span class=main>)</span> <span class=free>v</span> <span class=main>=</span> fmlookup <span class=free>s</span> <span class=free>v</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> 2 3
    <span class=keyword1><span class=command>by</span></span> <span class=operator>argo</span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=comment1>― ‹NOTE added lemma.›</span>
<span class=comment1>― ‹TODO refactor (into Fmap\_Utils.thy).›</span>
<span class=keyword1 id=FactoredSystem-as_needed_asses_submap_exec_v><span class=command>lemma</span></span> as_needed_asses_submap_exec_v<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>f</span> <span class=free>g</span> <span class=free>v</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>v</span> <span class=main>∈</span> fmdom' <span class=free>f</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>f</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>g</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=free>v</span> <span class=main>∈</span> fmdom' <span class=free>g</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>b</span></span> <span class=keyword2><span class=keyword>where</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"fmlookup <span class=free>f</span> <span class=free>v</span> <span class=main>=</span> <span class=skolem>b</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>b</span> <span class=main>≠</span> None"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>)</span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>meson</span> fmdom'_notI<span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=free>g</span> <span class=free>v</span> <span class=main>=</span> <span class=skolem>b</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> as_needed_asses_submap_exec_ii<span class=main>[</span><span class=operator>OF</span> assms<span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>argo</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>using</span></span> 1 fmdom'_notD
    <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=comment1>― ‹NOTE added lemma.›</span>
<span class=comment1>― ‹TODO refactor.›</span>
<span class=keyword1 id=FactoredSystem-as_needed_asses_submap_exec_vi><span class=command>lemma</span></span> as_needed_asses_submap_exec_vi<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>a</span> <span class=free>s1</span> <span class=free>s2</span> <span class=free>v</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>v</span> <span class=main>∈</span> fmdom' <span class=main>(</span>action_needed_asses <span class=free>a</span> <span class=free>s1</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span>action_needed_asses <span class=free>a</span> <span class=free>s1</span><span class=main>)</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=main>(</span>action_needed_asses <span class=free>a</span> <span class=free>s2</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span>fmlookup <span class=main>(</span>action_needed_asses <span class=free>a</span> <span class=free>s1</span><span class=main>)</span> <span class=free>v</span><span class=main>)</span> <span class=main>=</span> fmlookup <span class=main>(</span>fst <span class=free>a</span><span class=main>)</span> <span class=free>v</span>
    <span class=main>∧</span> <span class=main>(</span>fmlookup <span class=main>(</span>action_needed_asses <span class=free>a</span> <span class=free>s2</span><span class=main>)</span> <span class=free>v</span><span class=main>)</span> <span class=main>=</span> fmlookup <span class=main>(</span>fst <span class=free>a</span><span class=main>)</span> <span class=free>v</span> <span class=main>∧</span>
    fmlookup <span class=free>s1</span> <span class=free>v</span> <span class=main>=</span> fmlookup <span class=main>(</span>fst <span class=free>a</span><span class=main>)</span> <span class=free>v</span> <span class=main>∧</span> fmlookup <span class=free>s2</span> <span class=free>v</span> <span class=main>=</span> fmlookup <span class=main>(</span>fst <span class=free>a</span><span class=main>)</span> <span class=free>v</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span>
    <span class=quoted><span class=quoted>"fmlookup <span class=main>(</span>action_needed_asses <span class=free>a</span> <span class=free>s1</span><span class=main>)</span> <span class=free>v</span> <span class=main>=</span> fmlookup <span class=free>s1</span> <span class=free>v</span>"</span></span>
    <span class=quoted><span class=quoted>"fmlookup <span class=main>(</span>action_needed_asses <span class=free>a</span> <span class=free>s1</span><span class=main>)</span> <span class=free>v</span> <span class=main>=</span> fmlookup <span class=main>(</span>fst <span class=free>a</span><span class=main>)</span> <span class=free>v</span>"</span></span>
    <span class=quoted><span class=quoted>"fmlookup <span class=main>(</span>fst <span class=free>a</span><span class=main>)</span> <span class=free>v</span> <span class=main>=</span> fmlookup <span class=free>s1</span> <span class=free>v</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> as_needed_asses_submap_exec_iv<span class=main>[</span><span class=operator>OF</span> assms<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span><span class=main><span class=keyword3>+</span></span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>{</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=main>(</span>action_needed_asses <span class=free>a</span> <span class=free>s1</span><span class=main>)</span> <span class=free>v</span> <span class=main>=</span> fmlookup <span class=main>(</span>action_needed_asses <span class=free>a</span> <span class=free>s2</span><span class=main>)</span> <span class=free>v</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> as_needed_asses_submap_exec_ii<span class=main>[</span><span class=operator>OF</span> assms<span class=main>]</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=main>(</span>action_needed_asses <span class=free>a</span> <span class=free>s2</span><span class=main>)</span> <span class=free>v</span> <span class=main>=</span> fmlookup <span class=main>(</span>fst <span class=free>a</span><span class=main>)</span> <span class=free>v</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> 1<span class=main>(</span>2<span class=main>)</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>argo</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>note</span></span> 2 <span class=main>=</span> this
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>{</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>v</span> <span class=main>∈</span> fmdom' <span class=main>(</span>action_needed_asses <span class=free>a</span> <span class=free>s2</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> as_needed_asses_submap_exec_v<span class=main>[</span><span class=operator>OF</span> assms<span class=main>]</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=free>s2</span> <span class=free>v</span> <span class=main>=</span> fmlookup <span class=main>(</span>action_needed_asses <span class=free>a</span> <span class=free>s2</span><span class=main>)</span> <span class=free>v</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> as_needed_asses_submap_exec_i
      <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
    <span class=keyword1><span class=command>also</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>…</span> <span class=main>=</span> fmlookup <span class=main>(</span>fst <span class=free>a</span><span class=main>)</span> <span class=free>v</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> 2
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>finally</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=free>s2</span> <span class=free>v</span> <span class=main>=</span> fmlookup <span class=main>(</span>fst <span class=free>a</span><span class=main>)</span> <span class=free>v</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>argo</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=comment1>― ‹TODO refactor.›</span>
<span class=comment1>― ‹NOTE added lemma.›</span>
<span class=keyword1 id=FactoredSystem-as_needed_asses_submap_exec_vii><span class=command>lemma</span></span> as_needed_asses_submap_exec_vii<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>f</span> <span class=free>g</span> <span class=free>v</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>v</span> <span class=main>∈</span> fmdom' <span class=free>f</span><span class=main>.</span> fmlookup <span class=free>f</span> <span class=bound>v</span> <span class=main>=</span> fmlookup <span class=free>g</span> <span class=bound>v</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=free>f</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>g</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>v</span>
    <span class=keyword3><span class=command>assume</span></span> a<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span> fmdom' <span class=free>f</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span> dom <span class=main>(</span>fmlookup <span class=free>f</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=free>f</span> <span class=skolem>v</span> <span class=main>=</span> fmlookup <span class=free>g</span> <span class=skolem>v</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> assms a
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span> dom <span class=main>(</span>fmlookup <span class=free>f</span><span class=main>)</span> <span class=main>⟶</span> fmlookup <span class=free>f</span> <span class=skolem>v</span> <span class=main>=</span> fmlookup <span class=free>g</span> <span class=skolem>v</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=free>f</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>m</sub></span> fmlookup <span class=free>g</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> map_le_def<span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> fmsubset.rep_eq<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=comment1>― ‹TODO refactor.›</span>
<span class=comment1>― ‹NOTE added lemma.›</span>
<span class=keyword1 id=FactoredSystem-as_needed_asses_submap_exec_viii><span class=command>lemma</span></span> as_needed_asses_submap_exec_viii<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>f</span> <span class=free>g</span> <span class=free>v</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>f</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>g</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>v</span> <span class=main>∈</span> fmdom' <span class=free>f</span><span class=main>.</span> fmlookup <span class=free>f</span> <span class=bound>v</span> <span class=main>=</span> fmlookup <span class=free>g</span> <span class=bound>v</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"fmlookup <span class=free>f</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>m</sub></span> fmlookup <span class=free>g</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> fmsubset.rep_eq<span class=main>)</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>v</span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span> fmdom' <span class=free>f</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span> dom <span class=main>(</span>fmlookup <span class=free>f</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=free>f</span> <span class=skolem>v</span> <span class=main>=</span> fmlookup <span class=free>g</span> <span class=skolem>v</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> 1 map_le_def
      <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=comment1>― ‹NOTE added lemma.›</span>
<span class=keyword1 id="FactoredSystem-as_needed_asses_submap_exec_viii'"><span class=command>lemma</span></span> as_needed_asses_submap_exec_viii'<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>f</span> <span class=free>g</span> <span class=free>v</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>f</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>g</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=free>f</span> <span class=main>⊆</span> fmdom' <span class=free>g</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms as_needed_asses_submap_exec_v subsetI
  <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>

<span class=comment1>― ‹NOTE added lemma.›</span>
<span class=comment1>― ‹TODO refactor.›</span>
<span class=keyword1 id=FactoredSystem-as_needed_asses_submap_exec_ix><span class=command>lemma</span></span> as_needed_asses_submap_exec_ix<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>f</span> <span class=free>g</span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=free>f</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>g</span> <span class=main>=</span> <span class=main>(</span><span class=main>∀</span><span class=bound>v</span> <span class=main>∈</span> fmdom' <span class=free>f</span><span class=main>.</span> fmlookup <span class=free>f</span> <span class=bound>v</span> <span class=main>=</span> fmlookup <span class=free>g</span> <span class=bound>v</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> as_needed_asses_submap_exec_vii  as_needed_asses_submap_exec_viii
  <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>

<span class=comment1>― ‹NOTE added lemma.›</span>
<span class=keyword1 id=FactoredSystem-as_needed_asses_submap_exec_x><span class=command>lemma</span></span> as_needed_asses_submap_exec_x<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>f</span> <span class=free>a</span> <span class=free>v</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>v</span> <span class=main>∈</span> fmdom' <span class=main>(</span>action_needed_asses <span class=free>a</span> <span class=free>f</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=free>v</span> <span class=main>∈</span> fmdom' <span class=main>(</span>fst <span class=free>a</span><span class=main>)</span> <span class=main>∧</span> <span class=free>v</span> <span class=main>∈</span> fmdom' <span class=free>f</span> <span class=main>∧</span> fmlookup <span class=main>(</span>fst <span class=free>a</span><span class=main>)</span> <span class=free>v</span> <span class=main>=</span> fmlookup <span class=free>f</span> <span class=free>v</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>unfolding</span></span> action_needed_asses_def action_needed_vars_def
  <span class=keyword1><span class=command>using</span></span> as_needed_asses_submap_exec_i assms
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> fmdom'_notD fmdom'_notI<span class=main>)</span>

<span class=comment1>― ‹NOTE added lemma.›</span>
<span class=comment1>― ‹TODO refactor.›</span>
<span class=keyword1 id=FactoredSystem-as_needed_asses_submap_exec_xi><span class=command>lemma</span></span> as_needed_asses_submap_exec_xi<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>v</span> <span class=free>a</span> <span class=free>f</span> <span class=free>g</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>v</span> <span class=main>∈</span> fmdom' <span class=main>(</span>action_needed_asses <span class=free>a</span> <span class=main>(</span><span class=free>f</span> <span class=main>++</span> <span class=free>g</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>v</span> <span class=main>∈</span> fmdom' <span class=free>f</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"
    fmlookup <span class=main>(</span>action_needed_asses <span class=free>a</span> <span class=main>(</span><span class=free>f</span> <span class=main>++</span> <span class=free>g</span><span class=main>)</span><span class=main>)</span> <span class=free>v</span> <span class=main>=</span> fmlookup <span class=free>f</span> <span class=free>v</span>
    <span class=main>∧</span> fmlookup <span class=main>(</span>action_needed_asses <span class=free>a</span> <span class=main>(</span><span class=free>f</span> <span class=main>++</span> <span class=free>g</span><span class=main>)</span><span class=main>)</span> <span class=free>v</span> <span class=main>=</span> fmlookup <span class=main>(</span>fst <span class=free>a</span><span class=main>)</span> <span class=free>v</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>v</span> <span class=main>∈</span> <span class=main>{</span><span class=bound><span class=bound>v</span></span> <span class=main>∈</span> fmdom' <span class=main>(</span><span class=free>f</span> <span class=main>++</span> <span class=free>g</span><span class=main>)</span><span class=main>.</span> <span class=bound>v</span> <span class=main>∈</span> fmdom' <span class=main>(</span>fst <span class=free>a</span><span class=main>)</span> <span class=main>∧</span> fmlookup <span class=main>(</span>fst <span class=free>a</span><span class=main>)</span> <span class=bound>v</span> <span class=main>=</span> fmlookup <span class=main>(</span><span class=free>f</span> <span class=main>++</span> <span class=free>g</span><span class=main>)</span> <span class=bound>v</span><span class=main>}</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> as_needed_asses_submap_exec_x<span class=main>[</span><span class=operator>OF</span> assms<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>v</span> <span class=main>|∈|</span> fmdom <span class=free>f</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>2<span class=main>)</span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>meson</span> fmdom'_notI fmdom_notD<span class=main>)</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=main>(</span><span class=free>f</span> <span class=main>++</span> <span class=free>g</span><span class=main>)</span> <span class=free>v</span> <span class=main>=</span> fmlookup <span class=free>f</span> <span class=free>v</span>"</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> fmap_add_ltr_def fmlookup_add
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>note</span></span> 2 <span class=main>=</span> this
  <span class=keyword1><span class=command>{</span></span>

    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=main>(</span>action_needed_asses <span class=free>a</span> <span class=main>(</span><span class=free>f</span> <span class=main>++</span> <span class=free>g</span><span class=main>)</span><span class=main>)</span> <span class=free>v</span> <span class=main>=</span> fmlookup <span class=main>(</span><span class=free>f</span> <span class=main>++</span> <span class=free>g</span><span class=main>)</span> <span class=free>v</span>"</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> action_needed_asses_def action_needed_vars_def
      <span class=keyword1><span class=command>using</span></span> 1
      <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=main>(</span>action_needed_asses <span class=free>a</span> <span class=main>(</span><span class=free>f</span> <span class=main>++</span> <span class=free>g</span><span class=main>)</span><span class=main>)</span> <span class=free>v</span> <span class=main>=</span> fmlookup <span class=free>f</span> <span class=free>v</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> 2
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>note</span></span> 3 <span class=main>=</span> this
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>{</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=main>(</span>fst <span class=free>a</span><span class=main>)</span> <span class=free>v</span> <span class=main>=</span> fmlookup <span class=main>(</span><span class=free>f</span> <span class=main>++</span> <span class=free>g</span><span class=main>)</span> <span class=free>v</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> 1
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>also</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>…</span> <span class=main>=</span> fmlookup <span class=free>f</span> <span class=free>v</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> 2
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>also</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>…</span> <span class=main>=</span> fmlookup <span class=main>(</span>action_needed_asses <span class=free>a</span> <span class=main>(</span><span class=free>f</span> <span class=main>++</span> <span class=free>g</span><span class=main>)</span><span class=main>)</span> <span class=free>v</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> 3
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>finally</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=main>(</span>action_needed_asses <span class=free>a</span> <span class=main>(</span><span class=free>f</span> <span class=main>++</span> <span class=free>g</span><span class=main>)</span><span class=main>)</span> <span class=free>v</span> <span class=main>=</span> fmlookup <span class=main>(</span>fst <span class=free>a</span><span class=main>)</span> <span class=free>v</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=comment1>― ‹NOTE added lemma.›</span>
<span class=comment1>― ‹TODO refactor (into Fmap\_Utils.thy).›</span>
<span class=keyword1 id=FactoredSystem-as_needed_asses_submap_exec_xii><span class=command>lemma</span></span> as_needed_asses_submap_exec_xii<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>f</span> <span class=free>g</span> <span class=free>v</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>v</span> <span class=main>∈</span> fmdom' <span class=free>f</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=main>(</span><span class=free>f</span> <span class=main>++</span> <span class=free>g</span><span class=main>)</span> <span class=free>v</span> <span class=main>=</span> fmlookup <span class=free>f</span> <span class=free>v</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>v</span> <span class=main>|∈|</span> fmdom <span class=free>f</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>)</span> fmdom'_notI fmdom_notD
    <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>unfolding</span></span> fmap_add_ltr_def
    <span class=keyword1><span class=command>using</span></span> fmlookup_add
    <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=comment1>― ‹NOTE added lemma.›</span>
<span class=keyword1 id="FactoredSystem-as_needed_asses_submap_exec_xii'"><span class=command>lemma</span></span> as_needed_asses_submap_exec_xii'<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>f</span> <span class=free>g</span> <span class=free>v</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>v</span> <span class=main>∉</span> fmdom' <span class=free>f</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>v</span> <span class=main>∈</span> fmdom' <span class=free>g</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=main>(</span><span class=free>f</span> <span class=main>++</span> <span class=free>g</span><span class=main>)</span> <span class=free>v</span> <span class=main>=</span> fmlookup <span class=free>g</span> <span class=free>v</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span><span class=main>(</span><span class=free>v</span> <span class=main>|∈|</span> fmdom <span class=free>f</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>)</span> fmdom'_notI fmdom_notD
    <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>v</span> <span class=main>|∈|</span> fmdom <span class=free>g</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>2<span class=main>)</span> fmdom'_notI fmdom_notD
    <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>unfolding</span></span> fmap_add_ltr_def
    <span class=keyword1><span class=command>using</span></span> fmlookup_add
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=comment1>― ‹NOTE showcase.›</span>
<span class=keyword1 id=FactoredSystem-as_needed_asses_submap_exec><span class=command>lemma</span></span> as_needed_asses_submap_exec<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>s1</span> <span class=free>s2</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>s1</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s2</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>a</span><span class=main>.</span> ListMem <span class=bound>a</span> <span class=free>as</span> <span class=main>⟶</span> <span class=main>(</span>action_needed_asses <span class=bound>a</span> <span class=free>s2</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> action_needed_asses <span class=bound>a</span> <span class=free>s1</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>exec_plan <span class=free>s1</span> <span class=free>as</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> exec_plan <span class=free>s2</span> <span class=free>as</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>as</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>s1</span></span> <span class=quoted><span class=free>s2</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>a</span> <span class=skolem>as</span><span class=main>)</span>
    <span class=comment1>― ‹Proof the premises of the induction hypothesis for 'state\_succ s1 a' and 'state\_succ s2 a'.›</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"action_needed_asses <span class=skolem>a</span> <span class=skolem>s2</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> action_needed_asses <span class=skolem>a</span> <span class=skolem>s1</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>2<span class=main>)</span> elem
      <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"state_succ <span class=skolem>s1</span> <span class=skolem>a</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> state_succ <span class=skolem>s2</span> <span class=skolem>a</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>1<span class=main>)</span> act_needed_asses_submap_succ_submap
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>note</span></span> 1 <span class=main>=</span> this
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>a'</span>
    <span class=keyword3><span class=command>assume</span></span> P<span class=main>:</span> <span class=quoted><span class=quoted>"ListMem <span class=skolem>a'</span> <span class=skolem>as</span>"</span></span>
      <span class=comment1>― ‹Show the goal by rule 'as\_needed\_asses\_submap\_exec\_ix'.›</span>
    <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?f</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"action_needed_asses <span class=skolem>a'</span> <span class=main>(</span>state_succ <span class=skolem>s2</span> <span class=skolem>a</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?g</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"action_needed_asses <span class=skolem>a'</span> <span class=main>(</span>state_succ <span class=skolem>s1</span> <span class=skolem>a</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>{</span></span>
      <span class=keyword3><span class=command>fix</span></span> <span class=skolem>v</span>
      <span class=keyword3><span class=command>assume</span></span> P_1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span> fmdom' <span class=var>?f</span>"</span></span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=var>?f</span> <span class=skolem>v</span> <span class=main>=</span> fmlookup <span class=var>?g</span> <span class=skolem>v</span>"</span></span>
        <span class=keyword1><span class=command>unfolding</span></span> state_succ_def
        <span class=keyword1><span class=command>text</span></span> <span class=quoted><span class=plain_text>‹ Split cases on the if-then branches introduced by the definition of 'state\_succ'.›</span></span>
      <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>auto</span><span class=main>)</span>
        <span class=keyword3><span class=command>assume</span></span> P_1_1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span> fmdom' <span class=main>(</span>action_needed_asses <span class=skolem>a'</span> <span class=main>(</span>snd <span class=skolem>a</span> <span class=main>++</span> <span class=skolem>s2</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"fst <span class=skolem>a</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=skolem>s2</span>"</span></span>
          <span class=quoted><span class=quoted>"fst <span class=skolem>a</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=skolem>s1</span>"</span></span>
        <span class=keyword1><span class=command>have</span></span> i<span class=main>:</span> <span class=quoted><span class=quoted>"action_needed_asses <span class=skolem>a'</span> <span class=skolem>s2</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> action_needed_asses <span class=skolem>a'</span> <span class=skolem>s1</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>2<span class=main>)</span> P insert
          <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"
            fmlookup <span class=main>(</span>action_needed_asses <span class=skolem>a'</span> <span class=main>(</span>snd <span class=skolem>a</span> <span class=main>++</span> <span class=skolem>s2</span><span class=main>)</span><span class=main>)</span> <span class=skolem>v</span>
            <span class=main>=</span> fmlookup <span class=main>(</span>action_needed_asses <span class=skolem>a'</span> <span class=main>(</span>snd <span class=skolem>a</span> <span class=main>++</span> <span class=skolem>s1</span><span class=main>)</span><span class=main>)</span> <span class=skolem>v</span>"</span></span>
        <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span> fmdom' <span class=var>?g</span>"</span></span><span class=main>)</span>
          <span class=keyword3><span class=command>case</span></span> true<span class=main>:</span> True
          <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> A<span class=main>:</span>
            <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span> fmdom' <span class=main>(</span>fst <span class=skolem>a'</span><span class=main>)</span> <span class=main>∧</span> <span class=skolem>v</span> <span class=main>∈</span> fmdom' <span class=main>(</span>snd <span class=skolem>a</span> <span class=main>++</span> <span class=skolem>s1</span><span class=main>)</span>
                <span class=main>∧</span> fmlookup <span class=main>(</span>fst <span class=skolem>a'</span><span class=main>)</span> <span class=skolem>v</span> <span class=main>=</span> fmlookup <span class=main>(</span>snd <span class=skolem>a</span> <span class=main>++</span> <span class=skolem>s1</span><span class=main>)</span> <span class=skolem>v</span>"</span></span>
            <span class=keyword1><span class=command>using</span></span> as_needed_asses_submap_exec_x<span class=main>[</span><span class=operator>OF</span> true<span class=main>]</span>
            <span class=keyword1><span class=command>unfolding</span></span> state_succ_def
            <span class=keyword1><span class=command>using</span></span> P_1_1<span class=main>(</span>3<span class=main>)</span>
            <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
          <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> B<span class=main>:</span>
            <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span> fmdom' <span class=main>(</span>fst <span class=skolem>a'</span><span class=main>)</span> <span class=main>∧</span> <span class=skolem>v</span> <span class=main>∈</span> fmdom' <span class=main>(</span>snd <span class=skolem>a</span> <span class=main>++</span> <span class=skolem>s2</span><span class=main>)</span>
                <span class=main>∧</span> fmlookup <span class=main>(</span>fst <span class=skolem>a'</span><span class=main>)</span> <span class=skolem>v</span> <span class=main>=</span> fmlookup <span class=main>(</span>snd <span class=skolem>a</span> <span class=main>++</span> <span class=skolem>s2</span><span class=main>)</span> <span class=skolem>v</span>"</span></span>
            <span class=keyword1><span class=command>using</span></span> as_needed_asses_submap_exec_x<span class=main>[</span><span class=operator>OF</span> P_1<span class=main>]</span>
            <span class=keyword1><span class=command>unfolding</span></span> state_succ_def
            <span class=keyword1><span class=command>using</span></span> P_1_1<span class=main>(</span>2<span class=main>)</span>
            <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
          <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
          <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span> fmdom' <span class=main>(</span>snd <span class=skolem>a</span><span class=main>)</span>"</span></span><span class=main>)</span>
            <span class=keyword3><span class=command>case</span></span> True
            <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> I<span class=main>:</span>
              <span class=quoted><span class=quoted>"fmlookup <span class=main>(</span>snd <span class=skolem>a</span> <span class=main>++</span> <span class=skolem>s2</span><span class=main>)</span> <span class=skolem>v</span> <span class=main>=</span> fmlookup <span class=main>(</span>snd <span class=skolem>a</span><span class=main>)</span> <span class=skolem>v</span>"</span></span>
              <span class=quoted><span class=quoted>"fmlookup <span class=main>(</span>snd <span class=skolem>a</span> <span class=main>++</span> <span class=skolem>s1</span><span class=main>)</span> <span class=skolem>v</span> <span class=main>=</span> fmlookup <span class=main>(</span>snd <span class=skolem>a</span><span class=main>)</span> <span class=skolem>v</span>"</span></span>
              <span class=keyword1><span class=command>using</span></span> as_needed_asses_submap_exec_xii
              <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span><span class=main><span class=keyword3>+</span></span>
            <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>{</span></span>
              <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=var>?f</span> <span class=skolem>v</span> <span class=main>=</span> fmlookup <span class=main>(</span>snd <span class=skolem>a</span> <span class=main>++</span> <span class=skolem>s2</span><span class=main>)</span> <span class=skolem>v</span>"</span></span>
                <span class=keyword1><span class=command>using</span></span> as_needed_asses_submap_exec_iv<span class=main>[</span><span class=operator>OF</span> P_1<span class=main>]</span>
                <span class=keyword1><span class=command>unfolding</span></span> state_succ_def
                <span class=keyword1><span class=command>using</span></span> P_1_1<span class=main>(</span>2<span class=main>)</span>
                <span class=keyword1><span class=command>by</span></span> <span class=operator>presburger</span>
              <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=var>?f</span> <span class=skolem>v</span> <span class=main>=</span> fmlookup <span class=main>(</span>snd <span class=skolem>a</span><span class=main>)</span> <span class=skolem>v</span>"</span></span>
                <span class=keyword1><span class=command>using</span></span> I<span class=main>(</span>1<span class=main>)</span>
                <span class=keyword1><span class=command>by</span></span> <span class=operator>argo</span>
            <span class=keyword1><span class=command>}</span></span>
            <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>{</span></span>
              <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=var>?g</span> <span class=skolem>v</span> <span class=main>=</span> fmlookup <span class=main>(</span>snd <span class=skolem>a</span> <span class=main>++</span> <span class=skolem>s1</span><span class=main>)</span> <span class=skolem>v</span>"</span></span>
                <span class=keyword1><span class=command>using</span></span> as_needed_asses_submap_exec_iv<span class=main>[</span><span class=operator>OF</span> true<span class=main>]</span>
                <span class=keyword1><span class=command>unfolding</span></span> state_succ_def
                <span class=keyword1><span class=command>using</span></span> P_1_1<span class=main>(</span>3<span class=main>)</span>
                <span class=keyword1><span class=command>by</span></span> <span class=operator>presburger</span>
              <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=var>?g</span> <span class=skolem>v</span> <span class=main>=</span> fmlookup <span class=main>(</span>snd <span class=skolem>a</span><span class=main>)</span> <span class=skolem>v</span>"</span></span>
                <span class=keyword1><span class=command>using</span></span> I<span class=main>(</span>2<span class=main>)</span>
                <span class=keyword1><span class=command>by</span></span> <span class=operator>argo</span>
            <span class=keyword1><span class=command>}</span></span>
            <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
              <span class=keyword1><span class=command>unfolding</span></span> state_succ_def
              <span class=keyword1><span class=command>using</span></span> P_1_1<span class=main>(</span>2<span class=main>,</span> 3<span class=main>)</span>
              <span class=keyword1><span class=command>by</span></span> <span class=operator>presburger</span>
          <span class=keyword1><span class=command>next</span></span>
            <span class=keyword3><span class=command>case</span></span> False
            <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> I<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span> fmdom' <span class=skolem>s1</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span> fmdom' <span class=skolem>s2</span>"</span></span>
              <span class=keyword1><span class=command>using</span></span> A B
              <span class=keyword1><span class=command>unfolding</span></span> fmap_add_ltr_def fmdom'_add
              <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span><span class=main><span class=keyword3>+</span></span>
            <span class=keyword1><span class=command>{</span></span>
              <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=var>?g</span> <span class=skolem>v</span> <span class=main>=</span> fmlookup <span class=main>(</span>snd <span class=skolem>a</span> <span class=main>++</span> <span class=skolem>s1</span><span class=main>)</span> <span class=skolem>v</span>"</span></span>
                <span class=keyword1><span class=command>using</span></span> as_needed_asses_submap_exec_iv<span class=main>[</span><span class=operator>OF</span> true<span class=main>]</span>
                <span class=keyword1><span class=command>unfolding</span></span> state_succ_def
                <span class=keyword1><span class=command>using</span></span> P_1_1<span class=main>(</span>3<span class=main>)</span>
                <span class=keyword1><span class=command>by</span></span> <span class=operator>presburger</span>
              <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=var>?g</span> <span class=skolem>v</span> <span class=main>=</span> fmlookup <span class=skolem>s1</span> <span class=skolem>v</span>"</span></span>
                <span class=keyword1><span class=command>using</span></span> as_needed_asses_submap_exec_xii'<span class=main>[</span><span class=operator>OF</span> False I<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main>]</span>
                <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
              <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>{</span></span>
                <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=main>(</span>snd <span class=skolem>a</span> <span class=main>++</span> <span class=skolem>s1</span><span class=main>)</span> <span class=skolem>v</span> <span class=main>=</span> fmlookup <span class=skolem>s1</span> <span class=skolem>v</span>"</span></span>
                  <span class=keyword1><span class=command>using</span></span> as_needed_asses_submap_exec_xii'<span class=main>[</span><span class=operator>OF</span> False I<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main>]</span>
                  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
                <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹fmlookup <span class=main>(</span>snd <span class=skolem>a</span> <span class=main>++</span> <span class=skolem>s1</span><span class=main>)</span> <span class=skolem>v</span> <span class=main>=</span> fmlookup <span class=skolem>s1</span> <span class=skolem>v</span>›</span></span>
                <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=main>(</span>fst <span class=skolem>a'</span><span class=main>)</span> <span class=skolem>v</span> <span class=main>=</span> fmlookup <span class=skolem>s1</span> <span class=skolem>v</span>"</span></span>
                  <span class=keyword1><span class=command>using</span></span> A<span class=main>(</span>1<span class=main>)</span>
                  <span class=keyword1><span class=command>by</span></span> <span class=operator>argo</span>
                <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=main>(</span>action_needed_asses <span class=skolem>a'</span> <span class=skolem>s1</span><span class=main>)</span> <span class=skolem>v</span> <span class=main>=</span> fmlookup <span class=skolem>s1</span> <span class=skolem>v</span>"</span></span>
                  <span class=keyword1><span class=command>using</span></span> A<span class=main>(</span>1<span class=main>)</span> I<span class=main>(</span>1<span class=main>)</span>
                  <span class=keyword1><span class=command>unfolding</span></span> action_needed_asses_def action_needed_vars_def
                    fmlookup_restrict_set
                  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
              <span class=keyword1><span class=command>}</span></span>
              <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=var>?g</span> <span class=skolem>v</span> <span class=main>=</span> fmlookup <span class=main>(</span>action_needed_asses <span class=skolem>a'</span> <span class=skolem>s1</span><span class=main>)</span> <span class=skolem>v</span>"</span></span>
                <span class=keyword1><span class=command>by</span></span> <span class=operator>argo</span>
            <span class=keyword1><span class=command>}</span></span>
            <span class=keyword1><span class=command>note</span></span> II <span class=main>=</span> this
            <span class=keyword1><span class=command>{</span></span>
              <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=var>?f</span> <span class=skolem>v</span> <span class=main>=</span> fmlookup <span class=main>(</span>snd <span class=skolem>a</span> <span class=main>++</span> <span class=skolem>s2</span><span class=main>)</span> <span class=skolem>v</span>"</span></span>
                <span class=keyword1><span class=command>using</span></span> as_needed_asses_submap_exec_iv<span class=main>[</span><span class=operator>OF</span> P_1<span class=main>]</span>
                <span class=keyword1><span class=command>unfolding</span></span> state_succ_def
                <span class=keyword1><span class=command>using</span></span> P_1_1<span class=main>(</span>2<span class=main>)</span>
                <span class=keyword1><span class=command>by</span></span> <span class=operator>presburger</span>
              <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹fmlookup <span class=var>?f</span> <span class=skolem>v</span> <span class=main>=</span> fmlookup <span class=main>(</span>snd <span class=skolem>a</span> <span class=main>++</span> <span class=skolem>s2</span><span class=main>)</span> <span class=skolem>v</span>›</span></span>
              <span class=keyword1><span class=command>have</span></span> α<span class=main>:</span> <span class=quoted><span class=quoted>"fmlookup <span class=var>?f</span> <span class=skolem>v</span> <span class=main>=</span> fmlookup <span class=skolem>s2</span> <span class=skolem>v</span>"</span></span>
                <span class=keyword1><span class=command>using</span></span> as_needed_asses_submap_exec_xii'<span class=main>[</span><span class=operator>OF</span> False I<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span><span class=main>]</span>
                <span class=keyword1><span class=command>by</span></span> <span class=operator>argo</span>
              <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=main>(</span>snd <span class=skolem>a</span> <span class=main>++</span> <span class=skolem>s2</span><span class=main>)</span> <span class=skolem>v</span> <span class=main>=</span> fmlookup <span class=skolem>s2</span> <span class=skolem>v</span>"</span></span>
                <span class=keyword1><span class=command>by</span></span> <span class=operator>argo</span>
              <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>{</span></span>
                <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹fmlookup <span class=main>(</span>snd <span class=skolem>a</span> <span class=main>++</span> <span class=skolem>s2</span><span class=main>)</span> <span class=skolem>v</span> <span class=main>=</span> fmlookup <span class=skolem>s2</span> <span class=skolem>v</span>›</span></span>
                <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=main>(</span>fst <span class=skolem>a'</span><span class=main>)</span> <span class=skolem>v</span> <span class=main>=</span> fmlookup <span class=skolem>s2</span> <span class=skolem>v</span>"</span></span>
                  <span class=keyword1><span class=command>using</span></span> B<span class=main>(</span>1<span class=main>)</span>
                  <span class=keyword1><span class=command>by</span></span> <span class=operator>argo</span>
                <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=main>(</span>action_needed_asses <span class=skolem>a'</span> <span class=skolem>s2</span><span class=main>)</span> <span class=skolem>v</span> <span class=main>=</span> fmlookup <span class=skolem>s2</span> <span class=skolem>v</span>"</span></span>
                  <span class=keyword1><span class=command>using</span></span> B<span class=main>(</span>1<span class=main>)</span> I<span class=main>(</span>2<span class=main>)</span>
                  <span class=keyword1><span class=command>unfolding</span></span> action_needed_asses_def action_needed_vars_def
                    fmlookup_restrict_set
                  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
              <span class=keyword1><span class=command>}</span></span>
              <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=var>?f</span> <span class=skolem>v</span> <span class=main>=</span> fmlookup <span class=main>(</span>action_needed_asses <span class=skolem>a'</span> <span class=skolem>s2</span><span class=main>)</span> <span class=skolem>v</span>"</span></span>
                <span class=keyword1><span class=command>using</span></span> α
                <span class=keyword1><span class=command>by</span></span> <span class=operator>argo</span>
            <span class=keyword1><span class=command>}</span></span>
            <span class=keyword1><span class=command>note</span></span> III <span class=main>=</span> this
            <span class=keyword1><span class=command>{</span></span>
              <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span> fmdom' <span class=main>(</span>action_needed_asses <span class=skolem>a'</span> <span class=skolem>s2</span><span class=main>)</span>"</span></span>
              <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
                <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=main>(</span>fst <span class=skolem>a'</span><span class=main>)</span> <span class=skolem>v</span> <span class=main>=</span> fmlookup <span class=skolem>s1</span> <span class=skolem>v</span>"</span></span>
                  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> A False I<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span> as_needed_asses_submap_exec_xii'<span class=main>)</span>
                <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
                  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> A Cons.prems<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span> I<span class=main><span class=main>(</span></span>1<span class=main><span class=main>,</span></span> 2<span class=main><span class=main>)</span></span>
                      as_needed_asses_submap_exec_ii as_needed_asses_submap_exec_iii<span class=main>)</span>
              <span class=keyword1><span class=command>qed</span></span>
              <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"
                      fmlookup <span class=main>(</span>action_needed_asses <span class=skolem>a'</span> <span class=skolem>s2</span><span class=main>)</span> <span class=skolem>v</span>
                      <span class=main>=</span> fmlookup <span class=main>(</span>action_needed_asses <span class=skolem>a'</span> <span class=skolem>s1</span><span class=main>)</span> <span class=skolem>v</span>"</span></span>
                <span class=keyword1><span class=command>using</span></span> i as_needed_asses_submap_exec_ix<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"action_needed_asses <span class=skolem>a'</span> <span class=skolem>s2</span>"</span></span>
                    <span class=quoted><span class=quoted>"action_needed_asses <span class=skolem>a'</span> <span class=skolem>s1</span>"</span></span><span class=main>]</span>
                <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
            <span class=keyword1><span class=command>}</span></span>
            <span class=keyword1><span class=command>note</span></span> IV <span class=main>=</span> this
            <span class=keyword1><span class=command>{</span></span>
              <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=var>?f</span> <span class=skolem>v</span> <span class=main>=</span> fmlookup <span class=main>(</span>action_needed_asses <span class=skolem>a'</span> <span class=skolem>s2</span><span class=main>)</span> <span class=skolem>v</span>"</span></span>
                <span class=keyword1><span class=command>using</span></span> III
                <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
              <span class=keyword1><span class=command>also</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>…</span> <span class=main>=</span> fmlookup <span class=main>(</span>action_needed_asses <span class=skolem>a'</span> <span class=skolem>s1</span><span class=main>)</span> <span class=skolem>v</span>"</span></span>
                <span class=keyword1><span class=command>using</span></span> IV
                <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
              <span class=keyword1><span class=command>finally</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>…</span> <span class=main>=</span> fmlookup <span class=var>?g</span> <span class=skolem>v</span>"</span></span>
                <span class=keyword1><span class=command>using</span></span> II
                <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
            <span class=keyword1><span class=command>}</span></span>
            <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
              <span class=keyword1><span class=command>unfolding</span></span> action_needed_asses_def action_needed_vars_def state_succ_def
              <span class=keyword1><span class=command>using</span></span> P_1_1 A B
              <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
          <span class=keyword1><span class=command>qed</span></span>
        <span class=keyword1><span class=command>next</span></span>
          <span class=keyword3><span class=command>case</span></span> false<span class=main>:</span> False
          <span class=keyword1><span class=command>have</span></span> A<span class=main>:</span>
            <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span> fmdom' <span class=main>(</span>fst <span class=skolem>a'</span><span class=main>)</span> <span class=main>∧</span> <span class=skolem>v</span> <span class=main>∈</span> fmdom' <span class=main>(</span>snd <span class=skolem>a</span> <span class=main>++</span> <span class=skolem>s2</span><span class=main>)</span>
                <span class=main>∧</span> fmlookup <span class=main>(</span>fst <span class=skolem>a'</span><span class=main>)</span> <span class=skolem>v</span> <span class=main>=</span> fmlookup <span class=main>(</span>snd <span class=skolem>a</span> <span class=main>++</span> <span class=skolem>s2</span><span class=main>)</span> <span class=skolem>v</span>"</span></span>
            <span class=keyword1><span class=command>using</span></span> as_needed_asses_submap_exec_x<span class=main>[</span><span class=operator>OF</span> P_1<span class=main>]</span>
            <span class=keyword1><span class=command>unfolding</span></span> state_succ_def
            <span class=keyword1><span class=command>using</span></span> P_1_1<span class=main>(</span>2<span class=main>)</span>
            <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
          <span class=keyword1><span class=command>from</span></span> false <span class=keyword1><span class=command>have</span></span> B<span class=main>:</span>
            <span class=quoted><span class=quoted>"<span class=main>¬</span><span class=main>(</span><span class=skolem>v</span> <span class=main>∈</span> fmdom' <span class=main>(</span>snd <span class=skolem>a</span> <span class=main>++</span> <span class=skolem>s1</span><span class=main>)</span><span class=main>)</span> <span class=main>∨</span> <span class=main>¬</span><span class=main>(</span>fmlookup <span class=main>(</span>fst <span class=skolem>a'</span><span class=main>)</span> <span class=skolem>v</span> <span class=main>=</span> fmlookup <span class=main>(</span>snd <span class=skolem>a</span> <span class=main>++</span> <span class=skolem>s1</span><span class=main>)</span> <span class=skolem>v</span><span class=main>)</span>"</span></span>
            <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> A P_1_1<span class=main><span class=main>(</span></span>3<span class=main><span class=main>)</span></span> as_needed_asses_submap_exec_iii state_succ_def<span class=main>)</span>
          <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
          <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span> fmdom' <span class=main>(</span>snd <span class=skolem>a</span><span class=main>)</span>"</span></span><span class=main>)</span>
            <span class=keyword3><span class=command>case</span></span> True
            <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> I<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span> fmdom' <span class=main>(</span>snd <span class=skolem>a</span> <span class=main>++</span> <span class=skolem>s1</span><span class=main>)</span>"</span></span>
              <span class=keyword1><span class=command>unfolding</span></span> fmap_add_ltr_def fmdom'_add
              <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
            <span class=keyword1><span class=command>{</span></span>
              <span class=keyword1><span class=command>from</span></span> True <span class=keyword1><span class=command>have</span></span>
                <span class=quoted><span class=quoted>"fmlookup <span class=main>(</span>snd <span class=skolem>a</span> <span class=main>++</span> <span class=skolem>s2</span><span class=main>)</span> <span class=skolem>v</span> <span class=main>=</span> fmlookup <span class=main>(</span>snd <span class=skolem>a</span><span class=main>)</span> <span class=skolem>v</span>"</span></span>
                <span class=quoted><span class=quoted>"fmlookup <span class=main>(</span>snd <span class=skolem>a</span> <span class=main>++</span> <span class=skolem>s1</span><span class=main>)</span> <span class=skolem>v</span> <span class=main>=</span> fmlookup <span class=main>(</span>snd <span class=skolem>a</span><span class=main>)</span> <span class=skolem>v</span>"</span></span>
                <span class=keyword1><span class=command>using</span></span> as_needed_asses_submap_exec_xii
                <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span><span class=main><span class=keyword3>+</span></span>
              <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=main>(</span>snd <span class=skolem>a</span> <span class=main>++</span> <span class=skolem>s1</span><span class=main>)</span> <span class=skolem>v</span> <span class=main>=</span> fmlookup <span class=main>(</span>snd <span class=skolem>a</span> <span class=main>++</span> <span class=skolem>s2</span><span class=main>)</span> <span class=skolem>v</span>"</span></span>
                <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
              <span class=keyword1><span class=command>also</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>" <span class=main>…</span> <span class=main>=</span> fmlookup <span class=main>(</span>fst <span class=skolem>a'</span><span class=main>)</span> <span class=skolem>v</span>"</span></span>
                <span class=keyword1><span class=command>using</span></span> A
                <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
              <span class=keyword1><span class=command>finally</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=main>(</span>snd <span class=skolem>a</span> <span class=main>++</span> <span class=skolem>s1</span><span class=main>)</span> <span class=skolem>v</span> <span class=main>=</span> fmlookup <span class=main>(</span>fst <span class=skolem>a'</span><span class=main>)</span> <span class=skolem>v</span>"</span></span>
                <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
            <span class=keyword1><span class=command>}</span></span>
            <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> B I
              <span class=keyword1><span class=command>by</span></span> <span class=operator>presburger</span>
          <span class=keyword1><span class=command>next</span></span>
            <span class=keyword3><span class=command>case</span></span> False
            <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> I<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span> fmdom' <span class=skolem>s2</span>"</span></span>
              <span class=keyword1><span class=command>using</span></span> A <span class=keyword1><span class=command>unfolding</span></span> fmap_add_ltr_def fmdom'_add
              <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
            <span class=keyword1><span class=command>{</span></span>
              <span class=keyword1><span class=command>from</span></span> P_1 <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=var>?f</span> <span class=skolem>v</span> <span class=main>≠</span> None"</span></span>
                <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>meson</span> fmdom'_notI<span class=main>)</span>
              <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> false
              <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=var>?g</span> <span class=skolem>v</span> <span class=main>=</span> None"</span></span>
                <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> fmdom'_notD<span class=main>)</span>
              <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=var>?f</span> <span class=skolem>v</span> <span class=main>≠</span> fmlookup <span class=var>?g</span> <span class=skolem>v</span>"</span></span>
                <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
            <span class=keyword1><span class=command>}</span></span>
            <span class=keyword1><span class=command>moreover</span></span>
            <span class=keyword1><span class=command>{</span></span>
              <span class=keyword1><span class=command>{</span></span>
                <span class=keyword1><span class=command>from</span></span> P_1_1<span class=main>(</span>2<span class=main>)</span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"state_succ <span class=skolem>s2</span> <span class=skolem>a</span> <span class=main>=</span> snd <span class=skolem>a</span> <span class=main>++</span> <span class=skolem>s2</span>"</span></span>
                  <span class=keyword1><span class=command>unfolding</span></span> state_succ_def
                  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
                <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹state_succ <span class=skolem>s2</span> <span class=skolem>a</span> <span class=main>=</span> snd <span class=skolem>a</span> <span class=main>++</span> <span class=skolem>s2</span>›</span></span> <span class=keyword1><span class=command>have</span></span>
                  <span class=quoted><span class=quoted>"fmlookup <span class=main>(</span>state_succ <span class=skolem>s2</span> <span class=skolem>a</span><span class=main>)</span> <span class=skolem>v</span> <span class=main>=</span> fmlookup <span class=skolem>s2</span> <span class=skolem>v</span>"</span></span>
                  <span class=keyword1><span class=command>using</span></span> as_needed_asses_submap_exec_xii'<span class=main>[</span><span class=operator>OF</span> False I<span class=main>]</span>
                  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
                <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=var>?f</span> <span class=skolem>v</span> <span class=main>=</span> fmlookup <span class=main>(</span>action_needed_asses <span class=skolem>a'</span> <span class=skolem>s2</span><span class=main>)</span> <span class=skolem>v</span>"</span></span>
                  <span class=keyword1><span class=command>unfolding</span></span> action_needed_asses_def action_needed_vars_def
                  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> A I<span class=main>)</span>
              <span class=keyword1><span class=command>}</span></span>
              <span class=keyword1><span class=command>note</span></span> I <span class=main>=</span> this
              <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>{</span></span>
                <span class=keyword1><span class=command>from</span></span> P_1_1<span class=main>(</span>3<span class=main>)</span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"state_succ <span class=skolem>s1</span> <span class=skolem>a</span> <span class=main>=</span> snd <span class=skolem>a</span> <span class=main>++</span> <span class=skolem>s1</span>"</span></span>
                  <span class=keyword1><span class=command>unfolding</span></span> state_succ_def
                  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
                <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> <span class=quoted><span class=quoted>‹state_succ <span class=skolem>s1</span> <span class=skolem>a</span> <span class=main>=</span> snd <span class=skolem>a</span> <span class=main>++</span> <span class=skolem>s1</span>›</span></span> False
                <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=main>(</span>state_succ <span class=skolem>s1</span> <span class=skolem>a</span><span class=main>)</span> <span class=skolem>v</span> <span class=main>=</span> fmlookup <span class=skolem>s1</span> <span class=skolem>v</span>"</span></span>
                  <span class=keyword1><span class=command>unfolding</span></span> fmap_add_ltr_def
                  <span class=keyword1><span class=command>using</span></span> fmlookup_add
                  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> fmdom'_alt_def fmember.rep_eq<span class=main>)</span>
                <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=var>?g</span> <span class=skolem>v</span> <span class=main>=</span> fmlookup <span class=main>(</span>action_needed_asses <span class=skolem>a'</span> <span class=skolem>s1</span><span class=main>)</span> <span class=skolem>v</span>"</span></span>
                  <span class=keyword1><span class=command>unfolding</span></span> action_needed_asses_def action_needed_vars_def
                  <span class=keyword1><span class=command>using</span></span> FDOM_state_succ_subset
                  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
              <span class=keyword1><span class=command>}</span></span>
              <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>{</span></span>
                <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span> fmdom' <span class=main>(</span>action_needed_asses <span class=skolem>a'</span> <span class=skolem>s2</span><span class=main>)</span>"</span></span>
                <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
                  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span> fmdom' <span class=skolem>s2</span> <span class=main>∪</span> fmdom' <span class=main>(</span>snd <span class=skolem>a</span><span class=main>)</span>"</span></span>
                    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> <span class=main><span class=main>(</span></span>no_types<span class=main><span class=main>)</span></span> A FDOM_state_succ_subset P_1_1<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span> state_succ_def subsetCE<span class=main>)</span>
                  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
                    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> A False as_needed_asses_submap_exec_iii as_needed_asses_submap_exec_xii'<span class=main>)</span>
                <span class=keyword1><span class=command>qed</span></span>
                <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"
                      fmlookup <span class=main>(</span>action_needed_asses <span class=skolem>a'</span> <span class=skolem>s2</span><span class=main>)</span> <span class=skolem>v</span>
                      <span class=main>=</span> fmlookup <span class=main>(</span>action_needed_asses <span class=skolem>a'</span> <span class=skolem>s1</span><span class=main>)</span> <span class=skolem>v</span>"</span></span>
                  <span class=keyword1><span class=command>using</span></span> i as_needed_asses_submap_exec_ix<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"action_needed_asses <span class=skolem>a'</span> <span class=skolem>s2</span>"</span></span>
                      <span class=quoted><span class=quoted>"action_needed_asses <span class=skolem>a'</span> <span class=skolem>s1</span>"</span></span><span class=main>]</span>
                  <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
              <span class=keyword1><span class=command>}</span></span>
              <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=var>?f</span> <span class=skolem>v</span> <span class=main>=</span> fmlookup <span class=var>?g</span> <span class=skolem>v</span>"</span></span>
                <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
            <span class=keyword1><span class=command>}</span></span>
            <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
              <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
          <span class=keyword1><span class=command>qed</span></span>
        <span class=keyword1><span class=command>qed</span></span>
      <span class=keyword1><span class=command>next</span></span>
        <span class=keyword3><span class=command>assume</span></span> P2<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span> fmdom' <span class=main>(</span>action_needed_asses <span class=skolem>a'</span> <span class=main>(</span>snd <span class=skolem>a</span> <span class=main>++</span> <span class=skolem>s2</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"fst <span class=skolem>a</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=skolem>s2</span>"</span></span>
          <span class=quoted><span class=quoted>"<span class=main>¬</span> fst <span class=skolem>a</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=skolem>s1</span>"</span></span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"
            fmlookup <span class=main>(</span>action_needed_asses <span class=skolem>a'</span> <span class=main>(</span>snd <span class=skolem>a</span> <span class=main>++</span> <span class=skolem>s2</span><span class=main>)</span><span class=main>)</span> <span class=skolem>v</span>
            <span class=main>=</span> fmlookup <span class=main>(</span>action_needed_asses <span class=skolem>a'</span> <span class=skolem>s1</span><span class=main>)</span> <span class=skolem>v</span>"</span></span>
        <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
          <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>aa</span></span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=tfree>'a</span><span class=main>,</span> <span class=tfree>'b</span><span class=main>)</span> fmap <span class=main>⇒</span> <span class=main>(</span><span class=tfree>'a</span><span class=main>,</span> <span class=tfree>'b</span><span class=main>)</span> fmap <span class=main>⇒</span> <span class=tfree>'a</span>"</span></span> <span class=keyword2><span class=keyword>where</span></span>
            <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>x0</span> <span class=bound>x1</span><span class=main>.</span> <span class=main>(</span><span class=main>∃</span><span class=bound>v2</span><span class=main>.</span> <span class=bound>v2</span> <span class=main>∈</span> fmdom' <span class=bound>x1</span>
                <span class=main>∧</span> fmlookup <span class=bound>x1</span> <span class=bound>v2</span> <span class=main>≠</span> fmlookup <span class=bound>x0</span> <span class=bound>v2</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=skolem>aa</span> <span class=bound>x0</span> <span class=bound>x1</span> <span class=main>∈</span> fmdom' <span class=bound>x1</span>
                <span class=main>∧</span> fmlookup <span class=bound>x1</span> <span class=main>(</span><span class=skolem>aa</span> <span class=bound>x0</span> <span class=bound>x1</span><span class=main>)</span> <span class=main>≠</span> fmlookup <span class=bound>x0</span> <span class=main>(</span><span class=skolem>aa</span> <span class=bound>x0</span> <span class=bound>x1</span><span class=main>)</span><span class=main>)</span>"</span></span>
            <span class=keyword1><span class=command>by</span></span> <span class=operator>moura</span>
          <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> f1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>f</span> <span class=bound>fa</span><span class=main>.</span> <span class=skolem>aa</span> <span class=bound>fa</span> <span class=bound>f</span> <span class=main>∈</span> fmdom' <span class=bound>f</span>
              <span class=main>∧</span> fmlookup <span class=bound>f</span> <span class=main>(</span><span class=skolem>aa</span> <span class=bound>fa</span> <span class=bound>f</span><span class=main>)</span> <span class=main>≠</span> fmlookup <span class=bound>fa</span> <span class=main>(</span><span class=skolem>aa</span> <span class=bound>fa</span> <span class=bound>f</span><span class=main>)</span> <span class=main>∨</span> <span class=bound>f</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=bound>fa</span>"</span></span>
            <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>meson</span> as_needed_asses_submap_exec_vii<span class=main>)</span>
          <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> f2<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>aa</span> <span class=skolem>s1</span> <span class=main>(</span>fst <span class=skolem>a</span><span class=main>)</span> <span class=main>∈</span> fmdom' <span class=main>(</span>fst <span class=skolem>a</span><span class=main>)</span>
              <span class=main>∧</span> fmlookup <span class=main>(</span>fst <span class=skolem>a</span><span class=main>)</span> <span class=main>(</span><span class=skolem>aa</span> <span class=skolem>s1</span> <span class=main>(</span>fst <span class=skolem>a</span><span class=main>)</span><span class=main>)</span> <span class=main>≠</span> fmlookup <span class=skolem>s1</span> <span class=main>(</span><span class=skolem>aa</span> <span class=skolem>s1</span> <span class=main>(</span>fst <span class=skolem>a</span><span class=main>)</span><span class=main>)</span>"</span></span>
            <span class=keyword1><span class=command>using</span></span> P2<span class=main>(</span>3<span class=main>)</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
          <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>aa</span> <span class=skolem>s1</span> <span class=main>(</span>fst <span class=skolem>a</span><span class=main>)</span> <span class=main>∈</span> fmdom' <span class=skolem>s2</span>"</span></span>
            <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> <span class=main><span class=main>(</span></span>full_types<span class=main><span class=main>)</span></span> P2<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span> as_needed_asses_submap_exec_v<span class=main>)</span>
          <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>aa</span> <span class=skolem>s1</span> <span class=main>(</span>fst <span class=skolem>a</span><span class=main>)</span> <span class=main>∈</span> fmdom' <span class=main>(</span>action_needed_asses <span class=skolem>a</span> <span class=skolem>s2</span><span class=main>)</span>"</span></span>
            <span class=keyword1><span class=command>using</span></span> f2 <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> P2<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span> as_needed_asses_submap_exec_iii
                as_needed_asses_submap_exec_viii<span class=main>)</span>
          <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
            <span class=keyword1><span class=command>using</span></span> f1 <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> <span class=main><span class=main>(</span></span>no_types<span class=main><span class=main>)</span></span> Cons.prems<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span> P2<span class=main><span class=main>(</span></span>3<span class=main><span class=main>)</span></span> as_needed_asses_submap_exec_vi elem<span class=main>)</span>
        <span class=keyword1><span class=command>qed</span></span>
      <span class=keyword1><span class=command>next</span></span>
        <span class=keyword3><span class=command>assume</span></span> P3<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span> fmdom' <span class=main>(</span>action_needed_asses <span class=skolem>a'</span> <span class=skolem>s2</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span> fst <span class=skolem>a</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=skolem>s2</span>"</span></span> <span class=quoted><span class=quoted>"fst <span class=skolem>a</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=skolem>s1</span>"</span></span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"
            fmlookup <span class=main>(</span>action_needed_asses <span class=skolem>a'</span> <span class=skolem>s2</span><span class=main>)</span> <span class=skolem>v</span>
            <span class=main>=</span> fmlookup <span class=main>(</span>action_needed_asses <span class=skolem>a'</span> <span class=main>(</span>snd <span class=skolem>a</span> <span class=main>++</span> <span class=skolem>s1</span><span class=main>)</span><span class=main>)</span> <span class=skolem>v</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>1<span class=main>)</span> submap_imp_state_succ_submap_a
          <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>next</span></span>
        <span class=keyword3><span class=command>assume</span></span> P4<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span> fmdom' <span class=main>(</span>action_needed_asses <span class=skolem>a'</span> <span class=skolem>s2</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span> fst <span class=skolem>a</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=skolem>s2</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span> fst <span class=skolem>a</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=skolem>s1</span>"</span></span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"
            fmlookup <span class=main>(</span>action_needed_asses <span class=skolem>a'</span> <span class=skolem>s2</span><span class=main>)</span> <span class=skolem>v</span>
            <span class=main>=</span> fmlookup <span class=main>(</span>action_needed_asses <span class=skolem>a'</span> <span class=skolem>s1</span><span class=main>)</span> <span class=skolem>v</span>"</span></span>
          <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> Cons.prems<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span> P as_needed_asses_submap_exec_ii insert<span class=main>)</span>
      <span class=keyword1><span class=command>qed</span></span>
    <span class=keyword1><span class=command>}</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> a<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=var>?f</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=var>?g</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> as_needed_asses_submap_exec_ix
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>note</span></span> 2 <span class=main>=</span> this
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>unfolding</span></span> exec_plan.simps
    <span class=keyword1><span class=command>using</span></span> Cons.IH<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"state_succ <span class=skolem>s1</span> <span class=skolem>a</span>"</span></span> <span class=quoted><span class=quoted>"state_succ <span class=skolem>s2</span> <span class=skolem>a</span>"</span></span><span class=main>,</span> <span class=operator>OF</span> 1<span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span> <span class=operator>simp</span>


<span class=comment1>― ‹NOTE name shortened.›</span>
<span class=keyword1><span class=command>definition</span></span> <span class=entity>system_needed_vars</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>system_needed_vars</span> <span class=free><span class=bound><span class=entity>PROB</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=main>≡</span> <span class=main>(</span><span class=main>⋃</span><span class=main>{</span>action_needed_vars <span class=bound>a</span> <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=main>|</span> <span class=bound>a</span><span class=main>.</span> <span class=bound>a</span> <span class=main>∈</span> <span class=free><span class=bound><span class=entity>PROB</span></span></span><span class=main>}</span><span class=main>)</span>"</span></span>

<span class=comment1>― ‹NOTE name shortened.›</span>
<span class=keyword1><span class=command>definition</span></span> <span class=entity>system_needed_asses</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>system_needed_asses</span> <span class=free><span class=bound><span class=entity>PROB</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=main>≡</span> <span class=main>(</span>fmrestrict_set <span class=main>(</span>system_needed_vars <span class=free><span class=bound><span class=entity>PROB</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>)</span>"</span></span>


<span class=keyword1 id=FactoredSystem-action_needed_vars_subset_sys_needed_vars_subset><span class=command>lemma</span></span> action_needed_vars_subset_sys_needed_vars_subset<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>a</span> <span class=main>∈</span> <span class=free>PROB</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>action_needed_vars <span class=free>a</span> <span class=free>s</span> <span class=main>⊆</span> system_needed_vars <span class=free>PROB</span> <span class=free>s</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> system_needed_vars_def<span class=main>)</span> <span class=main>(</span><span class=operator>metis</span> surjective_pairing<span class=main>)</span>


<span class=keyword1 id=FactoredSystem-action_needed_asses_submap_sys_needed_asses><span class=command>lemma</span></span> action_needed_asses_submap_sys_needed_asses<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>a</span> <span class=main>∈</span> <span class=free>PROB</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>action_needed_asses <span class=free>a</span> <span class=free>s</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> system_needed_asses <span class=free>PROB</span> <span class=free>s</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"action_needed_asses <span class=free>a</span> <span class=free>s</span> <span class=main>=</span> fmrestrict_set <span class=main>(</span>action_needed_vars <span class=free>a</span> <span class=free>s</span><span class=main>)</span> <span class=free>s</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> action_needed_asses_def
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"system_needed_asses <span class=free>PROB</span> <span class=free>s</span> <span class=main>=</span> <span class=main>(</span>fmrestrict_set <span class=main>(</span>system_needed_vars <span class=free>PROB</span> <span class=free>s</span><span class=main>)</span> <span class=free>s</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> system_needed_asses_def
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"action_needed_vars <span class=free>a</span> <span class=free>s</span> <span class=main>⊆</span> system_needed_vars <span class=free>PROB</span> <span class=free>s</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> action_needed_vars_subset_sys_needed_vars_subset
    <span class=keyword1><span class=command>using</span></span> assms action_needed_vars_subset_sys_needed_vars_subset
    <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>x</span>
    <span class=keyword3><span class=command>assume</span></span> P1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> dom <span class=main>(</span>fmlookup <span class=main>(</span>fmrestrict_set <span class=main>(</span>action_needed_vars <span class=free>a</span> <span class=free>s</span><span class=main>)</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> a<span class=main>:</span> <span class=quoted><span class=quoted>"fmlookup <span class=main>(</span>fmrestrict_set <span class=main>(</span>action_needed_vars <span class=free>a</span> <span class=free>s</span><span class=main>)</span> <span class=free>s</span><span class=main>)</span> <span class=skolem>x</span> <span class=main>=</span> fmlookup <span class=free>s</span> <span class=skolem>x</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> fmdom'_restrict_set_precise<span class=main>)</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=main>(</span>fmrestrict_set <span class=main>(</span>system_needed_vars <span class=free>PROB</span> <span class=free>s</span><span class=main>)</span> <span class=free>s</span><span class=main>)</span> <span class=skolem>x</span> <span class=main>=</span> fmlookup <span class=free>s</span> <span class=skolem>x</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> 1 contra_subsetD
      <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"
      fmlookup <span class=main>(</span>fmrestrict_set <span class=main>(</span>action_needed_vars <span class=free>a</span> <span class=free>s</span><span class=main>)</span> <span class=free>s</span><span class=main>)</span> <span class=skolem>x</span>
      <span class=main>=</span> fmlookup <span class=main>(</span>fmrestrict_set <span class=main>(</span>system_needed_vars <span class=free>PROB</span> <span class=free>s</span><span class=main>)</span> <span class=free>s</span><span class=main>)</span> <span class=skolem>x</span>
    "</span></span>
      <span class=keyword1><span class=command>using</span></span> a
      <span class=keyword1><span class=command>by</span></span> <span class=operator>argo</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"
      fmlookup <span class=main>(</span>fmrestrict_set <span class=main>(</span>action_needed_vars <span class=free>a</span> <span class=free>s</span><span class=main>)</span> <span class=free>s</span><span class=main>)</span>
      <span class=keyword1>⊆<span class=hidden>⇩</span><sub>m</sub></span> fmlookup <span class=main>(</span>fmrestrict_set <span class=main>(</span>system_needed_vars <span class=free>PROB</span> <span class=free>s</span><span class=main>)</span> <span class=free>s</span><span class=main>)</span>
    "</span></span>
    <span class=keyword1><span class=command>using</span></span> map_le_def
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>action_needed_asses <span class=free>a</span> <span class=free>s</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> system_needed_asses <span class=free>PROB</span> <span class=free>s</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> fmsubset.rep_eq action_needed_asses_def system_needed_asses_def<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1 id=FactoredSystem-system_needed_asses_include_action_needed_asses_1><span class=command>lemma</span></span> system_needed_asses_include_action_needed_asses_1<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>a</span> <span class=main>∈</span> <span class=free>PROB</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>action_needed_vars <span class=free>a</span> <span class=main>(</span>fmrestrict_set <span class=main>(</span>system_needed_vars <span class=free>PROB</span> <span class=free>s</span><span class=main>)</span> <span class=free>s</span><span class=main>)</span> <span class=main>=</span> action_needed_vars <span class=free>a</span> <span class=free>s</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?A</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>{</span><span class=bound><span class=bound>v</span></span> <span class=main>∈</span> fmdom' <span class=main>(</span>fmrestrict_set <span class=main>(</span>system_needed_vars <span class=free>PROB</span> <span class=free>s</span><span class=main>)</span> <span class=free>s</span><span class=main>)</span><span class=main>.</span>
      <span class=bound>v</span> <span class=main>∈</span> fmdom' <span class=main>(</span>fst <span class=free>a</span><span class=main>)</span>
      <span class=main>∧</span> fmlookup <span class=main>(</span>fst <span class=free>a</span><span class=main>)</span> <span class=bound>v</span> <span class=main>=</span> fmlookup <span class=main>(</span>fmrestrict_set <span class=main>(</span>system_needed_vars <span class=free>PROB</span> <span class=free>s</span><span class=main>)</span> <span class=free>s</span><span class=main>)</span> <span class=bound>v</span><span class=main>}</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?B</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>{</span><span class=bound><span class=bound>v</span></span> <span class=main>∈</span> fmdom' <span class=free>s</span><span class=main>.</span> <span class=bound>v</span> <span class=main>∈</span> fmdom' <span class=main>(</span>fst <span class=free>a</span><span class=main>)</span> <span class=main>∧</span> fmlookup <span class=main>(</span>fst <span class=free>a</span><span class=main>)</span> <span class=bound>v</span> <span class=main>=</span> fmlookup <span class=free>s</span> <span class=bound>v</span><span class=main>}</span>"</span></span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>v</span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span> <span class=var>?A</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> i<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span> fmdom' <span class=main>(</span>fmrestrict_set <span class=main>(</span>system_needed_vars <span class=free>PROB</span> <span class=free>s</span><span class=main>)</span> <span class=free>s</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span> fmdom' <span class=main>(</span>fst <span class=free>a</span><span class=main>)</span>"</span></span>
      <span class=quoted><span class=quoted>"fmlookup <span class=main>(</span>fst <span class=free>a</span><span class=main>)</span> <span class=skolem>v</span> <span class=main>=</span> fmlookup <span class=main>(</span>fmrestrict_set <span class=main>(</span>system_needed_vars <span class=free>PROB</span> <span class=free>s</span><span class=main>)</span> <span class=free>s</span><span class=main>)</span> <span class=skolem>v</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span><span class=main><span class=keyword3>+</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span> fmdom' <span class=free>s</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> fmdom'_restrict_set_precise<span class=main>)</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=main>(</span>fst <span class=free>a</span><span class=main>)</span> <span class=skolem>v</span> <span class=main>=</span> fmlookup <span class=free>s</span> <span class=skolem>v</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> i<span class=main>(</span>2<span class=main>,</span> 3<span class=main>)</span> fmdom'_notI
      <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
    <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span> <span class=var>?B</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> i
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=var>?A</span> <span class=main>⊆</span> <span class=var>?B</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>v</span>
    <span class=keyword3><span class=command>assume</span></span> P<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span> <span class=var>?B</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> ii<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span> fmdom' <span class=free>s</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span> fmdom' <span class=main>(</span>fst <span class=free>a</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=main>(</span>fst <span class=free>a</span><span class=main>)</span> <span class=skolem>v</span> <span class=main>=</span> fmlookup <span class=free>s</span> <span class=skolem>v</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span><span class=main><span class=keyword3>+</span></span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>{</span></span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>s'</span><span class=main>.</span> <span class=skolem>v</span> <span class=main>∈</span> <span class=bound>s'</span> <span class=main>∧</span> <span class=main>(</span><span class=main>∃</span><span class=bound>a</span><span class=main>.</span> <span class=main>(</span><span class=bound>s'</span> <span class=main>=</span> action_needed_vars <span class=bound>a</span> <span class=free>s</span><span class=main>)</span> <span class=main>∧</span> <span class=bound>a</span> <span class=main>∈</span> <span class=free>PROB</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>unfolding</span></span> action_needed_vars_def
        <span class=keyword1><span class=command>using</span></span> assms P action_needed_vars_def
        <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>s'</span></span> <span class=keyword2><span class=keyword>where</span></span> α<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span> <span class=skolem>s'</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>a</span><span class=main>.</span> <span class=main>(</span><span class=skolem>s'</span> <span class=main>=</span> action_needed_vars <span class=bound>a</span> <span class=free>s</span><span class=main>)</span> <span class=main>∧</span> <span class=bound>a</span> <span class=main>∈</span> <span class=free>PROB</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>moreover</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>a'</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>s'</span> <span class=main>=</span> action_needed_vars <span class=skolem>a'</span> <span class=free>s</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a'</span> <span class=main>∈</span> <span class=free>PROB</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> α
        <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span> fmdom' <span class=main>(</span>fmrestrict_set <span class=main>(</span>system_needed_vars <span class=free>PROB</span> <span class=free>s</span><span class=main>)</span> <span class=free>s</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>unfolding</span></span> fmdom'_restrict_set_precise
        <span class=keyword1><span class=command>using</span></span> action_needed_vars_subset_sys_needed_vars_subset ii<span class=main>(</span>1<span class=main>)</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>}</span></span>
    <span class=keyword1><span class=command>note</span></span> iii <span class=main>=</span> this
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=main>(</span>fst <span class=free>a</span><span class=main>)</span> <span class=skolem>v</span> <span class=main>=</span> fmlookup <span class=main>(</span>fmrestrict_set <span class=main>(</span>system_needed_vars <span class=free>PROB</span> <span class=free>s</span><span class=main>)</span> <span class=free>s</span><span class=main>)</span> <span class=skolem>v</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> ii<span class=main>(</span>3<span class=main>)</span> iii fmdom'_notI
      <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
    <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span> <span class=var>?A</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?B</span> <span class=main>⊆</span> <span class=var>?A</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>unfolding</span></span> action_needed_vars_def
    <span class=keyword1><span class=command>using</span></span> 1
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=comment1>― ‹NOTE added lemma.›</span>
<span class=comment1>― ‹TODO refactor (proven elsewhere?).›</span>
<span class=keyword1 id=FactoredSystem-system_needed_asses_include_action_needed_asses_i><span class=command>lemma</span></span> system_needed_asses_include_action_needed_asses_i<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>A</span> <span class=free>B</span> <span class=free>f</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>A</span> <span class=main>⊆</span> <span class=free>B</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"fmrestrict_set <span class=free>A</span> <span class=main>(</span>fmrestrict_set <span class=free>B</span> <span class=free>f</span><span class=main>)</span> <span class=main>=</span> fmrestrict_set <span class=free>A</span> <span class=free>f</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?f'</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"fmrestrict_set <span class=free>A</span> <span class=free>f</span>"</span></span>
    <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?f''</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"fmrestrict_set <span class=free>A</span> <span class=main>(</span>fmrestrict_set <span class=free>B</span> <span class=free>f</span><span class=main>)</span>"</span></span>
    <span class=keyword3><span class=command>assume</span></span> C<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=var>?f''</span> <span class=main>≠</span> <span class=var>?f'</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>v</span></span> <span class=keyword2><span class=keyword>where</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"fmlookup <span class=var>?f''</span> <span class=skolem>v</span> <span class=main>≠</span> fmlookup <span class=var>?f'</span> <span class=skolem>v</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>meson</span> fmap_ext<span class=main>)</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted>False</span>
    <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span> <span class=free>A</span>"</span></span><span class=main>)</span>
      <span class=keyword3><span class=command>case</span></span> True
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=var>?f''</span> <span class=skolem>v</span> <span class=main>=</span> fmlookup <span class=main>(</span>fmrestrict_set <span class=free>B</span> <span class=free>f</span><span class=main>)</span> <span class=skolem>v</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> True fmlookup_restrict_set
        <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
      <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=main>(</span>fmrestrict_set <span class=free>B</span> <span class=free>f</span><span class=main>)</span> <span class=skolem>v</span> <span class=main>=</span> fmlookup <span class=var>?f'</span> <span class=skolem>v</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> True assms<span class=main>(</span>1<span class=main>)</span>
        <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
        <span class=keyword1><span class=command>using</span></span> 1
        <span class=keyword1><span class=command>by</span></span> <span class=operator>argo</span>
    <span class=keyword1><span class=command>next</span></span>
      <span class=keyword3><span class=command>case</span></span> False
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=var>?f'</span> <span class=skolem>v</span> <span class=main>=</span> None"</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=var>?f''</span> <span class=skolem>v</span> <span class=main>=</span> None"</span></span>
        <span class=keyword1><span class=command>using</span></span> fmlookup_restrict_set
        <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span><span class=main><span class=keyword3>+</span></span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
        <span class=keyword1><span class=command>using</span></span> 1
        <span class=keyword1><span class=command>by</span></span> <span class=operator>argo</span>
    <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1 id=FactoredSystem-system_needed_asses_include_action_needed_asses><span class=command>lemma</span></span> system_needed_asses_include_action_needed_asses<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>a</span> <span class=main>∈</span> <span class=free>PROB</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>action_needed_asses <span class=free>a</span> <span class=main>(</span>system_needed_asses <span class=free>PROB</span> <span class=free>s</span><span class=main>)</span> <span class=main>=</span> action_needed_asses <span class=free>a</span> <span class=free>s</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>" action_needed_vars <span class=free>a</span> <span class=free>s</span> <span class=main>⊆</span> system_needed_vars <span class=free>PROB</span> <span class=free>s</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> action_needed_vars_subset_sys_needed_vars_subset<span class=main>[</span><span class=operator>OF</span> assms<span class=main>]</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"
        fmrestrict_set <span class=main>(</span>action_needed_vars <span class=free>a</span> <span class=free>s</span><span class=main>)</span> <span class=main>(</span>fmrestrict_set <span class=main>(</span>system_needed_vars <span class=free>PROB</span> <span class=free>s</span><span class=main>)</span> <span class=free>s</span><span class=main>)</span> <span class=main>=</span>
        fmrestrict_set <span class=main>(</span>action_needed_vars <span class=free>a</span> <span class=free>s</span><span class=main>)</span> <span class=free>s</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> system_needed_asses_include_action_needed_asses_i
      <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword1><span class=command>have</span></span>
      <span class=quoted><span class=quoted>"action_needed_vars <span class=free>a</span> <span class=main>(</span>fmrestrict_set <span class=main>(</span>system_needed_vars <span class=free>PROB</span> <span class=free>s</span><span class=main>)</span> <span class=free>s</span><span class=main>)</span> <span class=main>=</span> action_needed_vars <span class=free>a</span> <span class=free>s</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> system_needed_asses_include_action_needed_asses_1<span class=main>[</span><span class=operator>OF</span> assms<span class=main>]</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmrestrict_set <span class=main>(</span>action_needed_vars <span class=free>a</span> <span class=main>(</span>fmrestrict_set <span class=main>(</span>system_needed_vars <span class=free>PROB</span> <span class=free>s</span><span class=main>)</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span>
        <span class=main>(</span>fmrestrict_set <span class=main>(</span>system_needed_vars <span class=free>PROB</span> <span class=free>s</span><span class=main>)</span> <span class=free>s</span><span class=main>)</span> <span class=main>=</span>
        fmrestrict_set <span class=main>(</span>action_needed_vars <span class=free>a</span> <span class=free>s</span><span class=main>)</span> <span class=free>s</span>
        <span class=main>⟷</span> fmrestrict_set <span class=main>(</span>action_needed_vars <span class=free>a</span> <span class=free>s</span><span class=main>)</span> <span class=main>(</span>fmrestrict_set <span class=main>(</span>system_needed_vars <span class=free>PROB</span> <span class=free>s</span><span class=main>)</span> <span class=free>s</span><span class=main>)</span> <span class=main>=</span>
            fmrestrict_set <span class=main>(</span>action_needed_vars <span class=free>a</span> <span class=free>s</span><span class=main>)</span> <span class=free>s</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>unfolding</span></span>  action_needed_asses_def system_needed_asses_def
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1 id=FactoredSystem-system_needed_asses_submap><span class=command>lemma</span></span> system_needed_asses_submap<span class=main>:</span>
  <span class=quoted><span class=quoted>"system_needed_asses <span class=free>PROB</span> <span class=free>s</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>x</span>
    <span class=keyword3><span class=command>assume</span></span> P<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>x</span><span class=main>∈</span> dom <span class=main>(</span>fmlookup <span class=main>(</span>system_needed_asses <span class=free>PROB</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"system_needed_asses <span class=free>PROB</span> <span class=free>s</span> <span class=main>=</span> <span class=main>(</span>fmrestrict_set <span class=main>(</span>system_needed_vars <span class=free>PROB</span> <span class=free>s</span><span class=main>)</span> <span class=free>s</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> system_needed_asses_def<span class=main>)</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=main>(</span>system_needed_asses <span class=free>PROB</span> <span class=free>s</span><span class=main>)</span> <span class=skolem>x</span> <span class=main>=</span> fmlookup <span class=free>s</span> <span class=skolem>x</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> P
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> fmdom'_restrict_set_precise<span class=main>)</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=main>(</span>system_needed_asses <span class=free>PROB</span> <span class=free>s</span><span class=main>)</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>m</sub></span> fmlookup <span class=free>s</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> map_le_def
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>using</span></span> fmsubset.rep_eq
    <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1 id=FactoredSystem-as_works_from_system_needed_asses><span class=command>lemma</span></span> as_works_from_system_needed_asses<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>exec_plan <span class=main>(</span>system_needed_asses <span class=free>PROB</span> <span class=free>s</span><span class=main>)</span> <span class=free>as</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> exec_plan <span class=free>s</span> <span class=free>as</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span>
      action_needed_asses_def
      as_needed_asses_submap_exec
      fmsubset_restrict_set_mono system_needed_asses_def
      system_needed_asses_include_action_needed_asses
      system_needed_asses_include_action_needed_asses_1
      system_needed_asses_submap
      valid_plan_mems
      <span class=main>)</span>


<span class=keyword2><span class=keyword>end</span></span></pre>
</div><div id=ActionSeqProcess>
<div class=head>
<h1>Theory ActionSeqProcess</h1>
</div>
<pre class=source><span class=keyword1><span class=command>theory</span></span> ActionSeqProcess
  <span class=keyword2><span class=keyword>imports</span></span> <a href=https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html>Main</a> <span class=quoted>"<a href=https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Sublist.html>HOL-Library.Sublist</a>"</span> <a href=#FactoredSystemLib>FactoredSystemLib</a> <a href=#FactoredSystem>FactoredSystem</a> <a href=#FSSublist>FSSublist</a>
<span class=keyword2><span class=keyword>begin</span></span>

<span class=keyword1><span class=command>section</span></span> <span class=quoted><span class=plain_text>"Action Sequence Process"</span></span>

<span class=keyword1><span class=command>text</span></span> <span class=quoted><span class=plain_text>‹ This section defines the preconditions satisfied predicate for action sequences and shows
relations between the execution of action sequnences and their projections some. The preconditions
satisfied predicate (`sat\_precond\_as`) states that in each recursion step, the given state and the
next action are compatible, i.e. the actions preconditions are met by the state. This is used as
premise to propositions on projections of action sequences to avoid that an invalid unprojected
sequence is suddenly valid after projection. [Abdulaziz et al., p.13] ›</span></span>

<span class=comment1>― ‹NOTE curried.›</span>
<span class=comment1>― ‹NOTE 'fun' because of multiple defining equations.›</span>
<span class=keyword1><span class=command>fun</span></span> <span class=entity>sat_precond_as</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>sat_precond_as</span> <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=main>[]</span> <span class=main>=</span> True"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>sat_precond_as</span> <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=main>(</span><span class=free><span class=bound><span class=entity>a</span></span></span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>as</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span>fst <span class=free><span class=bound><span class=entity>a</span></span></span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=main>∧</span> <span class=free>sat_precond_as</span> <span class=main>(</span>state_succ <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=free><span class=bound><span class=entity>a</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>as</span></span></span><span class=main>)</span>"</span></span>


<span class=comment1>― ‹NOTE added lemma.›</span>
<span class=keyword1 id=ActionSeqProcess-sat_precond_as_pair><span class=command>lemma</span></span> sat_precond_as_pair<span class=main>:</span>
  <span class=quoted><span class=quoted>"sat_precond_as <span class=free>s</span> <span class=main>(</span><span class=main>(</span><span class=free>p</span><span class=main>,</span> <span class=free>e</span><span class=main>)</span> <span class=main>#</span> <span class=free>as</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=free>p</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s</span> <span class=main>∧</span> sat_precond_as <span class=main>(</span>state_succ <span class=free>s</span> <span class=main>(</span><span class=free>p</span><span class=main>,</span> <span class=free>e</span><span class=main>)</span><span class=main>)</span> <span class=free>as</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>


<span class=comment1>― ‹NOTE 'fun' because of multiple defining equations.›</span>
<span class=keyword1><span class=command>fun</span></span> <span class=entity>rem_effectless_act</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>rem_effectless_act</span> <span class=main>[]</span> <span class=main>=</span> <span class=main>[]</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>rem_effectless_act</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>a</span></span></span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>as</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>if</span> fmdom' <span class=main>(</span>snd <span class=free><span class=bound><span class=entity>a</span></span></span><span class=main>)</span> <span class=main>≠</span> <span class=main>{}</span>
  <span class=keyword1>then</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>a</span></span></span> <span class=main>#</span> <span class=free>rem_effectless_act</span> <span class=free><span class=bound><span class=entity>as</span></span></span><span class=main>)</span>
  <span class=keyword1>else</span> <span class=free>rem_effectless_act</span> <span class=free><span class=bound><span class=entity>as</span></span></span>
<span class=main>)</span>"</span></span>


<span class=comment1>― ‹NOTE 'fun' because of multiple defining equations.›</span>
<span class=keyword1><span class=command>fun</span></span> <span class=entity>no_effectless_act</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>no_effectless_act</span> <span class=main>[]</span> <span class=main>=</span> True"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>no_effectless_act</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>a</span></span></span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>as</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=main>(</span>fmdom' <span class=main>(</span>snd <span class=free><span class=bound><span class=entity>a</span></span></span><span class=main>)</span> <span class=main>≠</span> <span class=main>{}</span><span class=main>)</span> <span class=main>∧</span> <span class=free>no_effectless_act</span> <span class=free><span class=bound><span class=entity>as</span></span></span><span class=main>)</span>"</span></span>


<span class=keyword1 id=ActionSeqProcess-graph_plan_lemma_4><span class=command>lemma</span></span> graph_plan_lemma_4<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>s</span> <span class=free>s'</span> <span class=free>as</span> <span class=free>vs</span> <span class=free>P</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>a</span><span class=main>.</span> <span class=main>(</span>ListMem <span class=bound>a</span> <span class=free>as</span> <span class=main>∧</span> <span class=free>P</span> <span class=bound>a</span><span class=main>)</span> <span class=main>⟶</span> <span class=main>(</span><span class=main>(</span>fmdom' <span class=main>(</span>snd <span class=bound>a</span><span class=main>)</span> <span class=main>∩</span> <span class=free>vs</span><span class=main>)</span> <span class=main>=</span> <span class=main>{}</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"sat_precond_as <span class=free>s</span> <span class=free>as</span>"</span></span>
    <span class=quoted><span class=quoted>"sat_precond_as <span class=free>s'</span> <span class=main>(</span>filter <span class=main>(</span><span class=main>λ</span><span class=bound>a</span><span class=main>.</span> <span class=main>¬</span><span class=main>(</span><span class=free>P</span> <span class=bound>a</span><span class=main>)</span><span class=main>)</span> <span class=free>as</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span> <span class=main>=</span> fmrestrict_set <span class=free>vs</span> <span class=free>s'</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"
    <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=main>(</span>exec_plan <span class=free>s</span> <span class=free>as</span><span class=main>)</span>
    <span class=main>=</span> fmrestrict_set <span class=free>vs</span> <span class=main>(</span>exec_plan <span class=free>s'</span> <span class=main>(</span>filter <span class=main>(</span><span class=main>λ</span> <span class=bound>a</span><span class=main>.</span> <span class=main>¬</span><span class=main>(</span><span class=free>P</span> <span class=bound>a</span><span class=main>)</span><span class=main>)</span> <span class=free>as</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>
  "</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>unfolding</span></span> exec_plan.simps
<span class=keyword1><span class=command>proof</span></span><span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>as</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>s</span></span> <span class=quoted><span class=free>s'</span></span> <span class=quoted><span class=free>vs</span></span> <span class=quoted><span class=free>P</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>a</span> <span class=skolem>as</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"fst <span class=skolem>a</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=skolem>s</span>"</span></span> <span class=quoted><span class=quoted>"sat_precond_as <span class=main>(</span>state_succ <span class=skolem>s</span> <span class=skolem>a</span><span class=main>)</span> <span class=skolem>as</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> 2<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>a'</span><span class=main>.</span> ListMem <span class=bound>a'</span> <span class=skolem>as</span> <span class=main>∧</span> <span class=skolem>P</span> <span class=bound>a'</span> <span class=main>⟶</span> fmdom' <span class=main>(</span>snd <span class=bound>a'</span><span class=main>)</span> <span class=main>∩</span> <span class=skolem>vs</span> <span class=main>=</span> <span class=main>{}</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> Cons.prems<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span> insert<span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=skolem>P</span> <span class=skolem>a</span>"</span></span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> True
    <span class=keyword1><span class=command>{</span></span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"filter <span class=main>(</span><span class=main>λ</span><span class=bound>a</span><span class=main>.</span> <span class=main>¬</span><span class=main>(</span><span class=skolem>P</span> <span class=bound>a</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span><span class=skolem>a</span> <span class=main>#</span> <span class=skolem>as</span><span class=main>)</span> <span class=main>=</span> filter <span class=main>(</span><span class=main>λ</span><span class=bound>a</span><span class=main>.</span> <span class=main>¬</span><span class=main>(</span><span class=skolem>P</span> <span class=bound>a</span><span class=main>)</span><span class=main>)</span> <span class=skolem>as</span>"</span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"sat_precond_as <span class=skolem>s'</span> <span class=main>(</span>filter <span class=main>(</span><span class=main>λ</span><span class=bound>a</span><span class=main>.</span> <span class=main>¬</span><span class=main>(</span><span class=skolem>P</span> <span class=bound>a</span><span class=main>)</span><span class=main>)</span> <span class=skolem>as</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>3<span class=main>)</span> True
        <span class=keyword1><span class=command>by</span></span> <span class=operator>argo</span>
    <span class=keyword1><span class=command>}</span></span>
    <span class=keyword1><span class=command>note</span></span> a <span class=main>=</span> this
    <span class=keyword1><span class=command>{</span></span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"ListMem <span class=skolem>a</span> <span class=main>(</span><span class=skolem>a</span> <span class=main>#</span> <span class=skolem>as</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> elem
        <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>fmdom' <span class=main>(</span>snd <span class=skolem>a</span><span class=main>)</span> <span class=main>∩</span> <span class=skolem>vs</span><span class=main>)</span> <span class=main>=</span> <span class=main>{}</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>1<span class=main>)</span> True
        <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmrestrict_set <span class=skolem>vs</span> <span class=main>(</span>state_succ <span class=skolem>s</span> <span class=skolem>a</span><span class=main>)</span> <span class=main>=</span> fmrestrict_set <span class=skolem>vs</span> <span class=skolem>s</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> disj_imp_eq_proj_exec<span class=main>[</span><span class=operator>symmetric</span><span class=main>]</span>
        <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
    <span class=keyword1><span class=command>}</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>unfolding</span></span> exec_plan.simps
      <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>4<span class=main>)</span> 1<span class=main>(</span>2<span class=main>)</span> 2 True a Cons.IH<span class=main>[</span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> s<span class=main><span class=main>=</span></span><span class=quoted><span class=quoted>"state_succ <span class=skolem>s</span> <span class=skolem>a</span>"</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>and</span></span></span> s'<span class=main><span class=main>=</span></span><span class=quoted><span class=skolem>s'</span></span><span class=main>]</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> False
    <span class=keyword1><span class=command>{</span></span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"filter <span class=main>(</span><span class=main>λ</span><span class=bound>a</span><span class=main>.</span> <span class=main>¬</span><span class=main>(</span><span class=skolem>P</span> <span class=bound>a</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span><span class=skolem>a</span> <span class=main>#</span> <span class=skolem>as</span><span class=main>)</span> <span class=main>=</span> <span class=skolem>a</span> <span class=main>#</span> filter <span class=main>(</span><span class=main>λ</span><span class=bound>a</span><span class=main>.</span> <span class=main>¬</span><span class=main>(</span><span class=skolem>P</span> <span class=bound>a</span><span class=main>)</span><span class=main>)</span> <span class=skolem>as</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> False
        <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fst <span class=skolem>a</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=skolem>s'</span>"</span></span> <span class=quoted><span class=quoted>"sat_precond_as <span class=main>(</span>state_succ <span class=skolem>s'</span> <span class=skolem>a</span><span class=main>)</span> <span class=main>(</span>filter <span class=main>(</span><span class=main>λ</span><span class=bound>a</span><span class=main>.</span> <span class=main>¬</span><span class=main>(</span><span class=skolem>P</span> <span class=bound>a</span><span class=main>)</span><span class=main>)</span> <span class=skolem>as</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>3<span class=main>)</span> False
        <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span><span class=main><span class=keyword3>+</span></span>
    <span class=keyword1><span class=command>}</span></span>
    <span class=keyword1><span class=command>note</span></span> b <span class=main>=</span> this
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmrestrict_set <span class=skolem>vs</span> <span class=main>(</span>state_succ <span class=skolem>s</span> <span class=skolem>a</span><span class=main>)</span> <span class=main>=</span> fmrestrict_set <span class=skolem>vs</span> <span class=main>(</span>state_succ <span class=skolem>s'</span> <span class=skolem>a</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> proj_eq_proj_exec_eq
      <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>4<span class=main>)</span> 1<span class=main>(</span>1<span class=main>)</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>unfolding</span></span> exec_plan.simps
      <span class=keyword1><span class=command>using</span></span> 1<span class=main>(</span>2<span class=main>)</span> 2 False b Cons.IH<span class=main>[</span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> s<span class=main><span class=main>=</span></span><span class=quoted><span class=quoted>"state_succ <span class=skolem>s</span> <span class=skolem>a</span>"</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>and</span></span></span> s'<span class=main><span class=main>=</span></span><span class=quoted><span class=quoted>"state_succ <span class=skolem>s'</span> <span class=skolem>a</span>"</span></span><span class=main>]</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>qed</span></span> <span class=operator>simp</span>


<span class=comment1>― ‹NOTE curried instead of triples.›</span>
<span class=comment1>― ‹NOTE 'fun' because of multiple defining equations.›</span>
<span class=keyword1><span class=command>fun</span></span> <span class=entity>rem_condless_act</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>rem_condless_act</span> <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=free><span class=bound><span class=entity>pfx_a</span></span></span> <span class=main>[]</span> <span class=main>=</span> <span class=free><span class=bound><span class=entity>pfx_a</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>rem_condless_act</span> <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=free><span class=bound><span class=entity>pfx_a</span></span></span> <span class=main>(</span><span class=free><span class=bound><span class=entity>a</span></span></span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>as</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>if</span> fst <span class=free><span class=bound><span class=entity>a</span></span></span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> exec_plan <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=free><span class=bound><span class=entity>pfx_a</span></span></span>
    <span class=keyword1>then</span> <span class=free>rem_condless_act</span> <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=main>(</span><span class=free><span class=bound><span class=entity>pfx_a</span></span></span> <span class=main>@</span> <span class=main>[</span><span class=free><span class=bound><span class=entity>a</span></span></span><span class=main>]</span><span class=main>)</span> <span class=free><span class=bound><span class=entity>as</span></span></span>
    <span class=keyword1>else</span> <span class=free>rem_condless_act</span> <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=free><span class=bound><span class=entity>pfx_a</span></span></span> <span class=free><span class=bound><span class=entity>as</span></span></span>
  <span class=main>)</span>"</span></span>


<span class=keyword1 id=ActionSeqProcess-rem_condless_act_pair><span class=command>lemma</span></span> rem_condless_act_pair<span class=main>:</span> <span class=quoted><span class=quoted>"
    rem_condless_act <span class=free>s</span> <span class=free>pfx_a</span> <span class=main>(</span><span class=main>(</span><span class=free>p</span><span class=main>,</span> <span class=free>e</span><span class=main>)</span> <span class=main>#</span> <span class=free>as</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>if</span> <span class=free>p</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> exec_plan <span class=free>s</span> <span class=free>pfx_a</span>
      <span class=keyword1>then</span> rem_condless_act <span class=free>s</span> <span class=main>(</span><span class=free>pfx_a</span> <span class=main>@</span> <span class=main>[</span><span class=main>(</span><span class=free>p</span><span class=main>,</span><span class=free>e</span><span class=main>)</span><span class=main>]</span><span class=main>)</span> <span class=free>as</span>
      <span class=keyword1>else</span> rem_condless_act <span class=free>s</span> <span class=free>pfx_a</span> <span class=free>as</span>
    <span class=main>)</span>
  "</span></span>
  <span class=quoted><span class=quoted>"<span class=main>(</span>rem_condless_act <span class=free>s</span> <span class=free>pfx_a</span> <span class=main>[]</span> <span class=main>=</span> <span class=free>pfx_a</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span><span class=main><span class=keyword3>+</span></span>


<span class=keyword1 id=ActionSeqProcess-exec_remcondless_cons><span class=command>lemma</span></span> exec_remcondless_cons<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>s</span> <span class=free>h</span> <span class=free>as</span> <span class=free>pfx</span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"
    exec_plan <span class=free>s</span> <span class=main>(</span>rem_condless_act <span class=free>s</span> <span class=main>(</span><span class=free>h</span> <span class=main>#</span> <span class=free>pfx</span><span class=main>)</span> <span class=free>as</span><span class=main>)</span>
    <span class=main>=</span> exec_plan <span class=main>(</span>state_succ <span class=free>s</span> <span class=free>h</span><span class=main>)</span> <span class=main>(</span>rem_condless_act <span class=main>(</span>state_succ <span class=free>s</span> <span class=free>h</span><span class=main>)</span> <span class=free>pfx</span> <span class=free>as</span><span class=main>)</span>
  "</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>as</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>s</span></span> <span class=quoted><span class=free>h</span></span> <span class=quoted><span class=free>pfx</span></span><span class=main>)</span> <span class=operator>auto</span>


<span class=keyword1 id=ActionSeqProcess-rem_condless_valid_1><span class=command>lemma</span></span> rem_condless_valid_1<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>as</span> <span class=free>s</span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>exec_plan <span class=free>s</span> <span class=free>as</span> <span class=main>=</span> exec_plan <span class=free>s</span> <span class=main>(</span>rem_condless_act <span class=free>s</span> <span class=main>[]</span> <span class=free>as</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>as</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>s</span></span><span class=main>)</span>
    <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> exec_remcondless_cons FDOM_state_succ state_succ_def<span class=main>)</span>


<span class=keyword1 id=ActionSeqProcess-rem_condless_act_cons><span class=command>lemma</span></span> rem_condless_act_cons<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>h'</span> <span class=free>pfx</span> <span class=free>as</span> <span class=free>s</span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>rem_condless_act <span class=free>s</span> <span class=main>(</span><span class=free>h'</span> <span class=main>#</span> <span class=free>pfx</span><span class=main>)</span> <span class=free>as</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=free>h'</span> <span class=main>#</span> rem_condless_act <span class=main>(</span>state_succ <span class=free>s</span> <span class=free>h'</span><span class=main>)</span> <span class=free>pfx</span> <span class=free>as</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>as</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>h'</span></span> <span class=quoted><span class=free>pfx</span></span> <span class=quoted><span class=free>s</span></span><span class=main>)</span> <span class=operator>auto</span>


<span class=keyword1 id=ActionSeqProcess-rem_condless_act_cons_prefix><span class=command>lemma</span></span> rem_condless_act_cons_prefix<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>h</span> <span class=free>h'</span> <span class=free>as</span> <span class=free>as'</span> <span class=free>s</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"prefix <span class=main>(</span><span class=free>h'</span> <span class=main>#</span> <span class=free>as'</span><span class=main>)</span> <span class=main>(</span>rem_condless_act <span class=free>s</span> <span class=main>[</span><span class=free>h</span><span class=main>]</span> <span class=free>as</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>
    <span class=main>(</span>prefix <span class=free>as'</span> <span class=main>(</span>rem_condless_act <span class=main>(</span>state_succ <span class=free>s</span> <span class=free>h</span><span class=main>)</span> <span class=main>[]</span> <span class=free>as</span><span class=main>)</span><span class=main>)</span>
    <span class=main>∧</span> <span class=free>h'</span> <span class=main>=</span> <span class=free>h</span>
  <span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>as</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>h</span></span> <span class=quoted><span class=free>h'</span></span> <span class=quoted><span class=free>as'</span></span> <span class=quoted><span class=free>s</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> Nil
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"rem_condless_act <span class=skolem>s</span> <span class=main>[</span><span class=skolem>h</span><span class=main>]</span> <span class=main>[]</span> <span class=main>=</span> <span class=main>[</span><span class=skolem>h</span><span class=main>]</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>as'</span> <span class=main>=</span> <span class=main>[]</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Nil.prems
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"rem_condless_act <span class=main>(</span>state_succ <span class=skolem>s</span> <span class=skolem>h</span><span class=main>)</span> <span class=main>[]</span> <span class=main>[]</span> <span class=main>=</span> <span class=main>[]</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> 2<span class=main>:</span> <span class=quoted><span class=quoted>"prefix <span class=skolem>as'</span> <span class=main>(</span>rem_condless_act <span class=main>(</span>state_succ <span class=skolem>s</span> <span class=skolem>h</span><span class=main>)</span> <span class=main>[]</span> <span class=main>[]</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> 1
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>h</span> <span class=main>=</span> <span class=skolem>h'</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Nil.prems
    <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>using</span></span> 2
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>a</span> <span class=skolem>as</span><span class=main>)</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"rem_condless_act <span class=skolem>s</span> <span class=main>[</span><span class=skolem>h</span><span class=main>]</span> <span class=main>(</span><span class=skolem>a</span> <span class=main>#</span> <span class=skolem>as</span><span class=main>)</span> <span class=main>=</span> <span class=skolem>h</span> <span class=main>#</span> rem_condless_act <span class=main>(</span>state_succ <span class=skolem>s</span> <span class=skolem>h</span><span class=main>)</span> <span class=main>[]</span> <span class=main>(</span><span class=skolem>a</span> <span class=main>#</span> <span class=skolem>as</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> rem_condless_act_cons
      <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>h</span> <span class=main>=</span> <span class=skolem>h'</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> Cons.prems
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>l</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>h'</span> <span class=main>#</span> <span class=skolem>as'</span><span class=main>)</span> <span class=main>@</span> <span class=skolem>l</span> <span class=main>=</span> <span class=main>(</span><span class=skolem>h</span> <span class=main>#</span> rem_condless_act <span class=main>(</span>state_succ <span class=skolem>s</span> <span class=skolem>h</span><span class=main>)</span> <span class=main>[]</span> <span class=main>(</span><span class=skolem>a</span> <span class=main>#</span> <span class=skolem>as</span><span class=main>)</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> Cons.prems rem_condless_act_cons prefixE
      <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"prefix <span class=main>(</span><span class=skolem>as'</span> <span class=main>@</span> <span class=skolem>l</span><span class=main>)</span> <span class=main>(</span>rem_condless_act <span class=main>(</span>state_succ <span class=skolem>s</span> <span class=skolem>h</span><span class=main>)</span> <span class=main>[]</span> <span class=main>(</span><span class=skolem>a</span> <span class=main>#</span> <span class=skolem>as</span><span class=main>)</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"prefix <span class=skolem>as'</span> <span class=main>(</span>rem_condless_act <span class=main>(</span>state_succ <span class=skolem>s</span> <span class=skolem>h</span><span class=main>)</span> <span class=main>[]</span> <span class=main>(</span><span class=skolem>a</span> <span class=main>#</span> <span class=skolem>as</span><span class=main>)</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> append_prefixD
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1 id=ActionSeqProcess-rem_condless_valid_2><span class=command>lemma</span></span> rem_condless_valid_2<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>as</span> <span class=free>s</span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"sat_precond_as <span class=free>s</span> <span class=main>(</span>rem_condless_act <span class=free>s</span> <span class=main>[]</span> <span class=free>as</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>as</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>s</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> rem_condless_act_cons<span class=main>)</span>


<span class=keyword1 id=ActionSeqProcess-rem_condless_valid_3><span class=command>lemma</span></span> rem_condless_valid_3<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>as</span> <span class=free>s</span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"length <span class=main>(</span>rem_condless_act <span class=free>s</span> <span class=main>[]</span> <span class=free>as</span><span class=main>)</span> <span class=main>≤</span> length <span class=free>as</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>as</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>s</span></span><span class=main>)</span>
    <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> rem_condless_act_cons le_SucI<span class=main>)</span>


<span class=keyword1 id=ActionSeqProcess-rem_condless_valid_4><span class=command>lemma</span></span> rem_condless_valid_4<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>as</span> <span class=free>A</span> <span class=free>s</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>set <span class=free>as</span> <span class=main>⊆</span> <span class=free>A</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>set <span class=main>(</span>rem_condless_act <span class=free>s</span> <span class=main>[]</span> <span class=free>as</span><span class=main>)</span> <span class=main>⊆</span> <span class=free>A</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>as</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>A</span></span> <span class=quoted><span class=free>s</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> rem_condless_act_cons<span class=main>)</span>


<span class=keyword1 id=ActionSeqProcess-rem_condless_valid_6><span class=command>lemma</span></span> rem_condless_valid_6<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>as</span> <span class=free>s</span> <span class=free>P</span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"length <span class=main>(</span>filter <span class=free>P</span> <span class=main>(</span>rem_condless_act <span class=free>s</span> <span class=main>[]</span> <span class=free>as</span><span class=main>)</span><span class=main>)</span> <span class=main>≤</span> length <span class=main>(</span>filter <span class=free>P</span> <span class=free>as</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>as</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>P</span></span> <span class=quoted><span class=free>s</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>a</span> <span class=skolem>as</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> rem_condless_act_cons le_SucI<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span> <span class=operator>simp</span>


<span class=keyword1 id=ActionSeqProcess-rem_condless_valid_7><span class=command>lemma</span></span> rem_condless_valid_7<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>s</span> <span class=free>P</span> <span class=free>as</span> <span class=free>as2</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>list_all <span class=free>P</span> <span class=free>as</span> <span class=main>∧</span> list_all <span class=free>P</span> <span class=free>as2</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"list_all <span class=free>P</span> <span class=main>(</span>rem_condless_act <span class=free>s</span> <span class=free>as2</span> <span class=free>as</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>as</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>P</span></span> <span class=quoted><span class=free>s</span></span> <span class=quoted><span class=free>as2</span></span><span class=main>)</span> <span class=operator>auto</span>


<span class=keyword1 id=ActionSeqProcess-rem_condless_valid_8><span class=command>lemma</span></span> rem_condless_valid_8<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>s</span> <span class=free>as</span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"subseq <span class=main>(</span>rem_condless_act <span class=free>s</span> <span class=main>[]</span> <span class=free>as</span><span class=main>)</span> <span class=free>as</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>as</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>s</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> sublist_cons_4 rem_condless_act_cons<span class=main>)</span>


<span class=keyword1 id=ActionSeqProcess-rem_condless_valid_10><span class=command>lemma</span></span> rem_condless_valid_10<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=free>as</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>as</span> <span class=main>∈</span> <span class=main>(</span>valid_plans <span class=free>PROB</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>rem_condless_act <span class=free>s</span> <span class=main>[]</span> <span class=free>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms valid_plans_def rem_condless_valid_1 rem_condless_valid_4
  <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>


<span class=keyword1 id=ActionSeqProcess-rem_condless_valid><span class=command>lemma</span></span> rem_condless_valid<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>as</span> <span class=free>A</span> <span class=free>s</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>exec_plan <span class=free>s</span> <span class=free>as</span> <span class=main>=</span> exec_plan <span class=free>s</span> <span class=main>(</span>rem_condless_act <span class=free>s</span> <span class=main>[]</span> <span class=free>as</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span>sat_precond_as <span class=free>s</span> <span class=main>(</span>rem_condless_act <span class=free>s</span> <span class=main>[]</span> <span class=free>as</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span>length <span class=main>(</span>rem_condless_act <span class=free>s</span> <span class=main>[]</span> <span class=free>as</span><span class=main>)</span> <span class=main>≤</span> length <span class=free>as</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>(</span>set <span class=free>as</span> <span class=main>⊆</span> <span class=free>A</span><span class=main>)</span> <span class=main>⟶</span> <span class=main>(</span>set <span class=main>(</span>rem_condless_act <span class=free>s</span> <span class=main>[]</span> <span class=free>as</span><span class=main>)</span> <span class=main>⊆</span> <span class=free>A</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>P</span><span class=main>.</span> <span class=main>(</span>length <span class=main>(</span>filter <span class=bound>P</span> <span class=main>(</span>rem_condless_act <span class=free>s</span> <span class=main>[]</span> <span class=free>as</span><span class=main>)</span><span class=main>)</span> <span class=main>≤</span> length <span class=main>(</span>filter <span class=bound>P</span> <span class=free>as</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> rem_condless_valid_1  rem_condless_valid_2 rem_condless_valid_3 rem_condless_valid_6
    rem_condless_valid_4
  <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>


<span class=comment1>― ‹NOTE type of `as` had to be fixed for lemma submap\_imp\_state\_succ\_submap.›</span>
<span class=keyword1 id=ActionSeqProcess-submap_sat_precond_submap><span class=command>lemma</span></span> submap_sat_precond_submap<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>as</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> action list"</span></span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>s1</span>  <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s2</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>sat_precond_as <span class=free>s1</span> <span class=free>as</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>sat_precond_as <span class=free>s2</span> <span class=free>as</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>as</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>s1</span></span> <span class=quoted><span class=free>s2</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>a</span> <span class=skolem>as</span><span class=main>)</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fst <span class=skolem>a</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=skolem>s1</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>2<span class=main>)</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fst <span class=skolem>a</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=skolem>s2</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>1<span class=main>)</span> submap_imp_state_succ_submap_a
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>note</span></span> 1 <span class=main>=</span> this
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword1><span class=command>have</span></span> 2<span class=main>:</span> <span class=quoted><span class=quoted>"fst <span class=skolem>a</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=skolem>s1</span>"</span></span> <span class=quoted><span class=quoted>"sat_precond_as <span class=main>(</span>state_succ <span class=skolem>s1</span> <span class=skolem>a</span><span class=main>)</span> <span class=skolem>as</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>2<span class=main>)</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span><span class=main><span class=keyword3>+</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"state_succ <span class=skolem>s1</span> <span class=skolem>a</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> state_succ <span class=skolem>s2</span> <span class=skolem>a</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>1<span class=main>)</span> submap_imp_state_succ_submap
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> 3<span class=main>:</span> <span class=quoted><span class=quoted>"sat_precond_as <span class=main>(</span>state_succ <span class=skolem>s2</span> <span class=skolem>a</span><span class=main>)</span> <span class=skolem>as</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> 2<span class=main>(</span>2<span class=main>)</span> Cons.IH
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>using</span></span> 1
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>qed</span></span> <span class=operator>auto</span>


<span class=comment1>― ‹NOTE added lemma.›</span>
<span class=keyword1 id=ActionSeqProcess-submap_init_submap_exec_i><span class=command>lemma</span></span> submap_init_submap_exec_i<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>s1</span> <span class=free>s2</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>s1</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s2</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>sat_precond_as <span class=free>s1</span> <span class=main>(</span><span class=free>a</span> <span class=main>#</span> <span class=free>as</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"state_succ <span class=free>s1</span> <span class=free>a</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> state_succ <span class=free>s2</span> <span class=free>a</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"fst <span class=free>a</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s1</span>"</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> true<span class=main>:</span> True
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"fst <span class=free>a</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s2</span>"</span></span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> True
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>unfolding</span></span> state_succ_def
      <span class=keyword1><span class=command>using</span></span> assms submap_imp_state_succ_submap_b state_succ_def true
      <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> False
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>using</span></span> assms submap_imp_state_succ_submap_a true
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> false<span class=main>:</span> False
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"fst <span class=free>a</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s2</span>"</span></span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> True
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>using</span></span> assms false
      <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> False
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>unfolding</span></span> state_succ_def
      <span class=keyword1><span class=command>using</span></span> false assms
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=ActionSeqProcess-submap_init_submap_exec><span class=command>lemma</span></span> submap_init_submap_exec<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>s1</span> <span class=free>s2</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>s1</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s2</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>sat_precond_as <span class=free>s1</span> <span class=free>as</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>exec_plan <span class=free>s1</span> <span class=free>as</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> exec_plan <span class=free>s2</span> <span class=free>as</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>as</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>s1</span></span> <span class=quoted><span class=free>s2</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>a</span> <span class=skolem>as</span><span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"state_succ <span class=skolem>s1</span> <span class=skolem>a</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> state_succ <span class=skolem>s2</span> <span class=skolem>a</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Cons.prems submap_init_submap_exec_i
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"sat_precond_as <span class=main>(</span>state_succ <span class=skolem>s1</span> <span class=skolem>a</span><span class=main>)</span> <span class=skolem>as</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>2<span class=main>)</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"exec_plan <span class=main>(</span>state_succ <span class=skolem>s1</span> <span class=skolem>a</span><span class=main>)</span> <span class=skolem>as</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> exec_plan <span class=main>(</span>state_succ <span class=skolem>s2</span> <span class=skolem>a</span><span class=main>)</span> <span class=skolem>as</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Cons.IH
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span> <span class=operator>simp</span>


<span class=comment1>― ‹NOTE type of `as` had to be fixed for `submap\_sat\_precond\_submap`.›</span>
<span class=keyword1 id=ActionSeqProcess-sat_precond_drest_sat_precond><span class=command>lemma</span></span> sat_precond_drest_sat_precond<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>vs</span> <span class=free>s</span> <span class=keyword2><span class=keyword>and</span></span> <span class=free>as</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> action list"</span></span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"sat_precond_as <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span> <span class=free>as</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>sat_precond_as <span class=free>s</span> <span class=free>as</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmrestrict_set <span class=free>vs</span> <span class=free>s</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>sat_precond_as <span class=free>s</span> <span class=free>as</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms submap_sat_precond_submap
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=comment1>― ‹NOTE name shortened to 'varset\_action'.›</span>
<span class=keyword1><span class=command>definition</span></span> <span class=entity>varset_action</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>varset_action</span> <span class=free><span class=bound><span class=entity>a</span></span></span> <span class=free><span class=bound><span class=entity>varset</span></span></span> <span class=main>≡</span> <span class=main>(</span>fmdom' <span class=main>(</span>snd <span class=free><span class=bound><span class=entity>a</span></span></span><span class=main>)</span> <span class=main>⊆</span> <span class=free><span class=bound><span class=entity>varset</span></span></span><span class=main>)</span>"</span></span>
<span class=keyword2><span class=keyword>for</span></span> <span class=free>a</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> action"</span></span>


<span class=keyword1 id=ActionSeqProcess-varset_action_pair><span class=command>lemma</span></span> varset_action_pair<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span>varset_action <span class=main>(</span><span class=free>p</span><span class=main>,</span> <span class=free>e</span><span class=main>)</span> <span class=free>vs</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span>fmdom' <span class=free>e</span> <span class=main>⊆</span> <span class=free>vs</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> varset_action_def
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>


<span class=keyword1 id=ActionSeqProcess-eq_effect_eq_vset><span class=command>lemma</span></span> eq_effect_eq_vset<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>x</span> <span class=free>y</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>snd <span class=free>x</span> <span class=main>=</span> snd <span class=free>y</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>(</span><span class=main>λ</span><span class=bound>a</span><span class=main>.</span> varset_action <span class=bound>a</span> <span class=free>vs</span><span class=main>)</span> <span class=free>x</span> <span class=main>=</span> <span class=main>(</span><span class=main>λ</span><span class=bound>a</span><span class=main>.</span> varset_action <span class=bound>a</span> <span class=free>vs</span><span class=main>)</span> <span class=free>y</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> varset_action_def
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>by</span></span> <span class=operator>presburger</span>


<span class=keyword1 id=ActionSeqProcess-rem_effectless_works_1><span class=command>lemma</span></span> rem_effectless_works_1<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>s</span> <span class=free>as</span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>exec_plan <span class=free>s</span> <span class=free>as</span> <span class=main>=</span> exec_plan <span class=free>s</span> <span class=main>(</span>rem_effectless_act <span class=free>as</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>as</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>s</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> empty_eff_exec_eq<span class=main>)</span>


<span class=keyword1 id=ActionSeqProcess-rem_effectless_works_2><span class=command>lemma</span></span> rem_effectless_works_2<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>as</span> <span class=free>s</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>sat_precond_as <span class=free>s</span> <span class=free>as</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>sat_precond_as <span class=free>s</span> <span class=main>(</span>rem_effectless_act <span class=free>as</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>as</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>s</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> empty_eff_exec_eq<span class=main>)</span>


<span class=keyword1 id=ActionSeqProcess-rem_effectless_works_3><span class=command>lemma</span></span> rem_effectless_works_3<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>as</span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"length <span class=main>(</span>rem_effectless_act <span class=free>as</span><span class=main>)</span> <span class=main>≤</span> length <span class=free>as</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>as</span></span><span class=main>)</span> <span class=operator>auto</span>


<span class=keyword1 id=ActionSeqProcess-rem_effectless_works_4><span class=command>lemma</span></span> rem_effectless_works_4<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>A</span> <span class=free>as</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>set <span class=free>as</span> <span class=main>⊆</span> <span class=free>A</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>set <span class=main>(</span>rem_effectless_act <span class=free>as</span><span class=main>)</span> <span class=main>⊆</span> <span class=free>A</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>as</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>A</span></span><span class=main>)</span>  <span class=operator>auto</span>


<span class=keyword1 id="ActionSeqProcess-rem_effectless_works_4'"><span class=command>lemma</span></span> rem_effectless_works_4'<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>A</span> <span class=free>as</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>as</span> <span class=main>∈</span> valid_plans <span class=free>A</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>rem_effectless_act <span class=free>as</span> <span class=main>∈</span> valid_plans <span class=free>A</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>as</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>A</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> valid_plans_def<span class=main>)</span>


<span class=comment1>― ‹NOTE added lemma.›</span>
<span class=keyword1 id=ActionSeqProcess-rem_effectless_works_5_i><span class=command>lemma</span></span> rem_effectless_works_5_i<span class=main>:</span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"subseq <span class=main>(</span>rem_effectless_act <span class=free>as</span><span class=main>)</span> <span class=free>as</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>as</span></span><span class=main>)</span> <span class=operator>auto</span>

<span class=keyword1 id=ActionSeqProcess-rem_effectless_works_5><span class=command>lemma</span></span> rem_effectless_works_5<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>P</span> <span class=free>as</span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"length <span class=main>(</span>filter <span class=free>P</span> <span class=main>(</span>rem_effectless_act <span class=free>as</span><span class=main>)</span><span class=main>)</span> <span class=main>≤</span> length <span class=main>(</span>filter <span class=free>P</span> <span class=free>as</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> rem_effectless_works_5_i sublist_imp_len_filter_le
  <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>


<span class=keyword1 id=ActionSeqProcess-rem_effectless_works_6><span class=command>lemma</span></span> rem_effectless_works_6<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>as</span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"no_effectless_act <span class=main>(</span>rem_effectless_act <span class=free>as</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>as</span></span><span class=main>)</span> <span class=operator>auto</span>


<span class=keyword1 id=ActionSeqProcess-rem_effectless_works_7><span class=command>lemma</span></span> rem_effectless_works_7<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>as</span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"no_effectless_act <span class=free>as</span> <span class=main>=</span>  list_all <span class=main>(</span><span class=main>λ</span><span class=bound>a</span><span class=main>.</span> fmdom' <span class=main>(</span>snd <span class=bound>a</span><span class=main>)</span> <span class=main>≠</span> <span class=main>{}</span><span class=main>)</span> <span class=free>as</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>as</span></span><span class=main>)</span> <span class=operator>auto</span>


<span class=keyword1 id=ActionSeqProcess-rem_effectless_works_8><span class=command>lemma</span></span> rem_effectless_works_8<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>P</span> <span class=free>as</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>list_all <span class=free>P</span> <span class=free>as</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"list_all <span class=free>P</span> <span class=main>(</span>rem_effectless_act <span class=free>as</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>as</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>P</span></span><span class=main>)</span> <span class=operator>auto</span>


<span class=comment1>― ‹TODO move and replace `rem\_effectless\_works\_5\_i`.›</span>
<span class=keyword1 id=ActionSeqProcess-rem_effectless_works_9><span class=command>lemma</span></span> rem_effectless_works_9<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>as</span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"subseq <span class=main>(</span>rem_effectless_act <span class=free>as</span><span class=main>)</span> <span class=free>as</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>as</span></span><span class=main>)</span> <span class=operator>auto</span>


<span class=keyword1 id=ActionSeqProcess-rem_effectless_works_10><span class=command>lemma</span></span> rem_effectless_works_10<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>as</span> <span class=free>P</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>no_effectless_act <span class=free>as</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>no_effectless_act <span class=main>(</span>filter <span class=free>P</span> <span class=free>as</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> rem_effectless_works_7<span class=main>)</span> <span class=main>(</span><span class=operator>metis</span> Ball_set filter_set member_filter<span class=main>)</span>


<span class=keyword1 id=ActionSeqProcess-rem_effectless_works_11><span class=command>lemma</span></span> rem_effectless_works_11<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>as1</span> <span class=free>as2</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"subseq <span class=free>as1</span> <span class=main>(</span>rem_effectless_act <span class=free>as2</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>subseq <span class=free>as1</span> <span class=free>as2</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms rem_effectless_works_9 sublist_trans
  <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>


<span class=keyword1 id=ActionSeqProcess-rem_effectless_works_12><span class=command>lemma</span></span> rem_effectless_works_12<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>as1</span> <span class=free>as2</span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>no_effectless_act <span class=main>(</span><span class=free>as1</span> <span class=main>@</span> <span class=free>as2</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span>no_effectless_act <span class=free>as1</span> <span class=main>∧</span> no_effectless_act<span class=main>(</span><span class=free>as2</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>as1</span></span><span class=main>)</span> <span class=operator>auto</span>


<span class=comment1>― ‹TODO refactor into 'List\_Utils.thy'.›</span>
<span class=keyword1 id=ActionSeqProcess-rem_effectless_works_13_i><span class=command>lemma</span></span> rem_effectless_works_13_i<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>x</span> <span class=free>l</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"ListMem <span class=free>x</span> <span class=free>l</span>"</span></span> <span class=quoted><span class=quoted>"list_all <span class=free>P</span> <span class=free>l</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=free>P</span> <span class=free>x</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>l</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>insert <span class=skolem>x</span> <span class=skolem>xs</span> <span class=skolem>y</span><span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>P</span> <span class=skolem>y</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> insert.prems list.pred_inject
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> 2<span class=main>:</span> <span class=quoted><span class=quoted>"list_all <span class=free>P</span> <span class=free>l</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>2<span class=main>)</span> list.pred_inject
    <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>using</span></span> 1
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=skolem>y</span> <span class=main>=</span> <span class=skolem>x</span>"</span></span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> False
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>using</span></span> insert 2
      <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
  <span class=keyword1><span class=command>qed</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span> <span class=operator>simp</span>

<span class=keyword1 id=ActionSeqProcess-rem_effectless_works_13><span class=command>lemma</span></span> rem_effectless_works_13<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>as1</span> <span class=free>as2</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>subseq <span class=free>as1</span> <span class=free>as2</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>no_effectless_act <span class=free>as2</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>no_effectless_act <span class=free>as1</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>as1</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>as2</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>a</span> <span class=skolem>as1</span><span class=main>)</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"subseq <span class=skolem>as1</span> <span class=skolem>as2</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>1<span class=main>)</span> sublist_CONS1_E
      <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"no_effectless_act <span class=skolem>as1</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>2<span class=main>)</span> Cons.IH
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"list_all <span class=main>(</span><span class=main>λ</span><span class=bound>a</span><span class=main>.</span> fmdom' <span class=main>(</span>snd <span class=bound>a</span><span class=main>)</span> <span class=main>≠</span> <span class=main>{}</span><span class=main>)</span> <span class=skolem>as2</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>2<span class=main>)</span> rem_effectless_works_7
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"ListMem <span class=skolem>a</span> <span class=skolem>as2</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>1<span class=main>)</span> sublist_MEM
      <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
    <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>snd <span class=skolem>a</span><span class=main>)</span> <span class=main>≠</span> <span class=main>{}</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> rem_effectless_works_13_i
      <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span> <span class=operator>simp</span>


<span class=keyword1 id=ActionSeqProcess-rem_effectless_works_14><span class=command>lemma</span></span> rem_effectless_works_14<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=free>as</span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"exec_plan <span class=free>s</span> <span class=free>as</span> <span class=main>=</span> exec_plan <span class=free>s</span> <span class=main>(</span>rem_effectless_act <span class=free>as</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> rem_effectless_works_1
  <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>


<span class=keyword1 id=ActionSeqProcess-rem_effectless_works><span class=command>lemma</span></span> rem_effectless_works<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>s</span> <span class=free>A</span> <span class=free>as</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>exec_plan <span class=free>s</span> <span class=free>as</span> <span class=main>=</span> exec_plan <span class=free>s</span> <span class=main>(</span>rem_effectless_act <span class=free>as</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span>sat_precond_as <span class=free>s</span> <span class=free>as</span> <span class=main>⟶</span> sat_precond_as <span class=free>s</span> <span class=main>(</span>rem_effectless_act <span class=free>as</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span>length <span class=main>(</span>rem_effectless_act <span class=free>as</span><span class=main>)</span> <span class=main>≤</span> length <span class=free>as</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>(</span>set <span class=free>as</span> <span class=main>⊆</span> <span class=free>A</span><span class=main>)</span> <span class=main>⟶</span> <span class=main>(</span>set <span class=main>(</span>rem_effectless_act <span class=free>as</span><span class=main>)</span> <span class=main>⊆</span> <span class=free>A</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span>no_effectless_act <span class=main>(</span>rem_effectless_act <span class=free>as</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>P</span><span class=main>.</span> length <span class=main>(</span>filter <span class=bound>P</span> <span class=main>(</span>rem_effectless_act <span class=free>as</span><span class=main>)</span><span class=main>)</span> <span class=main>≤</span> length <span class=main>(</span>filter <span class=bound>P</span> <span class=free>as</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms rem_effectless_works_5
  <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>


<span class=comment1>― ‹NOTE name shortened.›</span>
<span class=keyword1><span class=command>definition</span></span> <span class=entity>rem_effectless_act_set</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>rem_effectless_act_set</span> <span class=free><span class=bound><span class=entity>A</span></span></span> <span class=main>≡</span> <span class=main>{</span><span class=bound><span class=bound>a</span></span> <span class=main>∈</span> <span class=free><span class=bound><span class=entity>A</span></span></span><span class=main>.</span> fmdom' <span class=main>(</span>snd <span class=bound>a</span><span class=main>)</span> <span class=main>≠</span> <span class=main>{}</span><span class=main>}</span>"</span></span>


<span class=keyword1 id=ActionSeqProcess-rem_effectless_act_subset_rem_effectless_act_set_thm><span class=command>lemma</span></span> rem_effectless_act_subset_rem_effectless_act_set_thm<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>as</span> <span class=free>A</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>set <span class=free>as</span> <span class=main>⊆</span> <span class=free>A</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>set <span class=main>(</span>rem_effectless_act <span class=free>as</span><span class=main>)</span> <span class=main>⊆</span> rem_effectless_act_set <span class=free>A</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> rem_effectless_act_set_def
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>as</span></span><span class=main>)</span> <span class=operator>auto</span>


<span class=keyword1 id=ActionSeqProcess-rem_effectless_act_set_no_empty_actions_thm><span class=command>lemma</span></span> rem_effectless_act_set_no_empty_actions_thm<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>A</span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"rem_effectless_act_set <span class=free>A</span> <span class=main>⊆</span> <span class=main>{</span><span class=bound>a</span><span class=main>.</span> fmdom' <span class=main>(</span>snd <span class=bound>a</span><span class=main>)</span> <span class=main>≠</span> <span class=main>{}</span><span class=main>}</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> rem_effectless_act_set_def
  <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>


<span class=comment1>― ‹NOTE proof required additional lemmas 'rem\_effectless\_works\_7' and 'rem\_condless\_valid\_7'.›</span>
<span class=keyword1 id=ActionSeqProcess-rem_condless_valid_9><span class=command>lemma</span></span> rem_condless_valid_9<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>s</span> <span class=free>as</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"no_effectless_act <span class=free>as</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"no_effectless_act <span class=main>(</span>rem_condless_act <span class=free>s</span> <span class=main>[]</span> <span class=free>as</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>as</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>s</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>a</span> <span class=skolem>as</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>using</span></span> Cons
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>" fst <span class=skolem>a</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> exec_plan <span class=skolem>s</span> <span class=main>[]</span>"</span></span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> True
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"rem_condless_act <span class=skolem>s</span> <span class=main>[]</span> <span class=main>(</span><span class=skolem>a</span> <span class=main>#</span> <span class=skolem>as</span><span class=main>)</span> <span class=main>=</span> <span class=skolem>a</span> <span class=main>#</span> rem_condless_act <span class=main>(</span>state_succ <span class=skolem>s</span> <span class=skolem>a</span><span class=main>)</span> <span class=main>[]</span> <span class=skolem>as</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> rem_condless_act_cons
      <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
    <span class=keyword1><span class=command>moreover</span></span>
    <span class=keyword1><span class=command>{</span></span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>snd <span class=skolem>a</span><span class=main>)</span> <span class=main>≠</span> <span class=main>{}</span>"</span></span>  <span class=quoted><span class=quoted>"no_effectless_act <span class=skolem>as</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> Cons.prems
        <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span><span class=main><span class=keyword3>+</span></span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"no_effectless_act <span class=main>(</span>rem_condless_act <span class=main>(</span>state_succ <span class=skolem>s</span> <span class=skolem>a</span><span class=main>)</span> <span class=main>[]</span> <span class=skolem>as</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> Cons.IH
        <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>}</span></span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"no_effectless_act <span class=main>[</span><span class=skolem>a</span><span class=main>]</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> Cons.prems
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>using</span></span> rem_effectless_works_12
      <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
  <span class=keyword1><span class=command>qed</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span> <span class=operator>simp</span>


<span class=keyword1 id=ActionSeqProcess-graph_plan_lemma_17><span class=command>lemma</span></span> graph_plan_lemma_17<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>as_1</span> <span class=free>as_2</span> <span class=free>as</span> <span class=free>s</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>as_1</span> <span class=main>@</span> <span class=free>as_2</span> <span class=main>=</span> <span class=free>as</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>sat_precond_as <span class=free>s</span> <span class=free>as</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>(</span>sat_precond_as <span class=free>s</span> <span class=free>as_1</span><span class=main>)</span> <span class=main>∧</span> sat_precond_as <span class=main>(</span>exec_plan <span class=free>s</span> <span class=free>as_1</span><span class=main>)</span> <span class=free>as_2</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>as</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>as_1</span></span> <span class=quoted><span class=free>as_2</span></span> <span class=quoted><span class=free>s</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>a</span> <span class=skolem>as</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>proof</span></span><span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=skolem>as_1</span>"</span></span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> Nil
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>1<span class=main>,</span> 2<span class=main>)</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>a</span> <span class=skolem>list</span><span class=main>)</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>1<span class=main>,</span> 2<span class=main>)</span> Cons.IH hd_append2  list.distinct<span class=main>(</span>1<span class=main>)</span> list.sel<span class=main>(</span>1<span class=main>,</span> 3<span class=main>)</span> tl_append2
      <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>qed</span></span> <span class=operator>auto</span>


<span class=keyword1 id=ActionSeqProcess-nempty_eff_every_nempty_act><span class=command>lemma</span></span> nempty_eff_every_nempty_act<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>as</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>no_effectless_act <span class=free>as</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>x</span><span class=main>.</span> <span class=main>¬</span><span class=main>(</span>fmdom' <span class=main>(</span>snd <span class=main>(</span><span class=free>f</span> <span class=bound>x</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>{}</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>list_all <span class=main>(</span><span class=main>λ</span><span class=bound>a</span><span class=main>.</span> <span class=main>¬</span><span class=main>(</span><span class=free>f</span> <span class=bound>a</span> <span class=main>=</span> <span class=main>(</span>fmempty<span class=main>,</span> fmempty<span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=free>as</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>as</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>f</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>a</span> <span class=skolem>as</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>using</span></span> fmdom'_empty snd_conv
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> <span class=main><span class=main>(</span></span>mono_tags<span class=main><span class=main>,</span></span> lifting<span class=main><span class=main>)</span></span> Ball_set<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span> <span class=operator>simp</span>


<span class=keyword1 id=ActionSeqProcess-empty_replace_proj_dual7><span class=command>lemma</span></span> empty_replace_proj_dual7<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>s</span> <span class=free>as</span> <span class=free>as'</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"sat_precond_as <span class=free>s</span> <span class=main>(</span><span class=free>as</span> <span class=main>@</span> <span class=free>as'</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"sat_precond_as <span class=main>(</span>exec_plan <span class=free>s</span> <span class=free>as</span><span class=main>)</span> <span class=free>as'</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>as</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>as'</span></span> <span class=quoted><span class=free>s</span></span><span class=main>)</span> <span class=operator>auto</span>


<span class=keyword1 id=ActionSeqProcess-not_vset_not_disj_eff_prod_dom_diff><span class=command>lemma</span></span> not_vset_not_disj_eff_prod_dom_diff<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=free>a</span> <span class=free>vs</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>a</span> <span class=main>∈</span> <span class=free>PROB</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>¬</span>varset_action <span class=free>a</span> <span class=free>vs</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span><span class=main>(</span><span class=main>(</span>fmdom' <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span> <span class=main>∩</span> <span class=main>(</span><span class=main>(</span>prob_dom <span class=free>PROB</span><span class=main>)</span> <span class=main>-</span> <span class=free>vs</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>{}</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span> <span class=main>≠</span> <span class=main>{}</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>2<span class=main>)</span> varset_action_def
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span> <span class=main>⊆</span> prob_dom <span class=free>PROB</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>)</span> FDOM_eff_subset_prob_dom_pair
      <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"
      fmdom' <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span> <span class=main>∩</span> <span class=main>(</span>prob_dom <span class=free>PROB</span> <span class=main>-</span> <span class=free>vs</span><span class=main>)</span>
      <span class=main>=</span> <span class=main>(</span>fmdom' <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span><span class=main>)</span> <span class=main>-</span> <span class=main>(</span>fmdom' <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span> <span class=main>∩</span> <span class=free>vs</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> Diff_Int_distrib
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>note</span></span> 2 <span class=main>=</span> this
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>using</span></span> 1 2
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span> <span class=main>∩</span> <span class=free>vs</span> <span class=main>=</span> <span class=main>{}</span>"</span></span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> False
    <span class=keyword1><span class=command>{</span></span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span><span class=main>(</span>fmdom' <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span> <span class=main>⊆</span> <span class=free>vs</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>2<span class=main>)</span> varset_action_def
        <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>fmdom' <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span> <span class=main>∩</span> <span class=free>vs</span> <span class=main>≠</span> fmdom' <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>fmdom' <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span> <span class=main>∩</span> <span class=free>vs</span><span class=main>)</span> <span class=main>⊂</span> fmdom' <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>}</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> 2
      <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>qed</span></span> <span class=operator>force</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1 id=ActionSeqProcess-vset_disj_dom_eff_diff><span class=command>lemma</span></span> vset_disj_dom_eff_diff<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=free>a</span> <span class=free>vs</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>varset_action <span class=free>a</span> <span class=free>vs</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>(</span><span class=main>(</span>fmdom' <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span><span class=main>)</span> <span class=main>∩</span> <span class=main>(</span>prob_dom <span class=free>PROB</span> <span class=main>-</span> <span class=free>vs</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>{}</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>unfolding</span></span> varset_action_def
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>


<span class=keyword1 id=ActionSeqProcess-vset_diff_disj_eff_vs><span class=command>lemma</span></span> vset_diff_disj_eff_vs<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=free>a</span> <span class=free>vs</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>varset_action <span class=free>a</span> <span class=main>(</span>prob_dom <span class=free>PROB</span> <span class=main>-</span> <span class=free>vs</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>(</span><span class=main>(</span>fmdom' <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span><span class=main>)</span> <span class=main>∩</span> <span class=free>vs</span><span class=main>)</span> <span class=main>=</span> <span class=main>{}</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>unfolding</span></span> varset_action_def
  <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>


<span class=keyword1 id=ActionSeqProcess-vset_nempty_efff_not_disj_eff_vs><span class=command>lemma</span></span> vset_nempty_efff_not_disj_eff_vs<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=free>a</span> <span class=free>vs</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>varset_action <span class=free>a</span> <span class=free>vs</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>fmdom' <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span> <span class=main>≠</span> <span class=main>{}</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span><span class=main>(</span><span class=main>(</span>fmdom' <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span> <span class=main>∩</span> <span class=free>vs</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>{}</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>unfolding</span></span> varset_action_def
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>


<span class=keyword1 id=ActionSeqProcess-vset_disj_eff_diff><span class=command>lemma</span></span> vset_disj_eff_diff<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>s</span> <span class=free>a</span> <span class=free>vs</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>varset_action <span class=free>a</span> <span class=free>vs</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>(</span>fmdom' <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span> <span class=main>∩</span> <span class=main>(</span><span class=free>s</span> <span class=main>-</span> <span class=free>vs</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>{}</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span> <span class=main>⊆</span> <span class=free>vs</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> varset_action_def<span class=main>)</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>{</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span> <span class=main>∩</span> <span class=main>(</span><span class=free>s</span> <span class=main>-</span> <span class=free>vs</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span>fmdom' <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span> <span class=main>∩</span> <span class=free>s</span><span class=main>)</span> <span class=main>-</span> <span class=main>(</span>fmdom' <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span> <span class=main>∩</span> <span class=free>vs</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> Diff_Int_distrib
      <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
    <span class=keyword1><span class=command>also</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>" <span class=main>…</span> <span class=main>=</span> <span class=main>(</span>fmdom' <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span> <span class=main>∩</span> <span class=free>s</span><span class=main>)</span> <span class=main>-</span> <span class=main>(</span>fmdom' <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> 1
      <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>finally</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span> <span class=main>∩</span> <span class=main>(</span><span class=free>s</span> <span class=main>-</span> <span class=free>vs</span><span class=main>)</span> <span class=main>=</span> <span class=main>{}</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=comment1>― ‹NOTE added lemma.›</span>
<span class=keyword1 id=ActionSeqProcess-list_all_list_mem><span class=command>lemma</span></span> list_all_list_mem<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>P</span> <span class=keyword2><span class=keyword>and</span></span> <span class=free>l</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> list"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"list_all <span class=free>P</span> <span class=free>l</span> <span class=main>⟷</span> <span class=main>(</span><span class=main>∀</span><span class=bound>e</span><span class=main>.</span> ListMem <span class=bound>e</span> <span class=free>l</span> <span class=main>⟶</span> <span class=free>P</span> <span class=bound>e</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>assume</span></span> P1<span class=main>:</span> <span class=quoted><span class=quoted>"list_all <span class=free>P</span> <span class=free>l</span>"</span></span>
    <span class=keyword1><span class=command>{</span></span>
      <span class=keyword3><span class=command>fix</span></span> <span class=skolem>e</span>
      <span class=keyword3><span class=command>assume</span></span> P11<span class=main>:</span> <span class=quoted><span class=quoted>"ListMem <span class=skolem>e</span> <span class=free>l</span>"</span></span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>P</span> <span class=skolem>e</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> P1 P11
      <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>l</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>P</span></span><span class=main>)</span>
        <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>insert <span class=skolem>x</span> <span class=skolem>xs</span> <span class=skolem>y</span><span class=main>)</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=skolem>y</span> <span class=main>=</span> <span class=skolem>x</span>"</span></span><span class=main>)</span>
          <span class=keyword3><span class=command>case</span></span> False
          <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"list_all <span class=skolem>P</span> <span class=skolem>xs</span>"</span></span> <span class=quoted><span class=quoted>"ListMem <span class=skolem>x</span> <span class=skolem>xs</span>"</span></span>
            <span class=keyword1><span class=command>using</span></span> insert.prems<span class=main>(</span>1<span class=main>)</span> insert.hyps
            <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span><span class=main><span class=keyword3>+</span></span>
          <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
            <span class=keyword1><span class=command>using</span></span> insert.IH
            <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
        <span class=keyword1><span class=command>qed</span></span> <span class=operator>simp</span>
      <span class=keyword1><span class=command>qed</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>assume</span></span> P2<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>e</span><span class=main>.</span> ListMem <span class=bound>e</span> <span class=free>l</span> <span class=main>⟶</span> <span class=free>P</span> <span class=bound>e</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"list_all <span class=free>P</span> <span class=free>l</span>"</span></span>
    <span class=keyword1><span class=command>proof</span></span><span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>l</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>P</span></span><span class=main>)</span>
      <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>a</span> <span class=skolem>l</span><span class=main>)</span>
      <span class=keyword1><span class=command>{</span></span>
        <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>e</span><span class=main>.</span> ListMem <span class=bound>e</span> <span class=skolem>l</span> <span class=main>⟶</span> <span class=skolem>P</span> <span class=bound>e</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> Cons.prems insert
          <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"list_all <span class=skolem>P</span> <span class=skolem>l</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> Cons.IH
          <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>}</span></span>
      <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>P</span> <span class=skolem>a</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> Cons.prems elem
        <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
      <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>qed</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1 id=ActionSeqProcess-every_vset_imp_drestrict_exec_eq><span class=command>lemma</span></span> every_vset_imp_drestrict_exec_eq<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=free>vs</span> <span class=free>as</span> <span class=free>s</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>list_all <span class=main>(</span><span class=main>λ</span><span class=bound>a</span><span class=main>.</span> varset_action <span class=bound>a</span> <span class=main>(</span><span class=main>(</span>prob_dom <span class=free>PROB</span><span class=main>)</span> <span class=main>-</span> <span class=free>vs</span><span class=main>)</span><span class=main>)</span> <span class=free>as</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span> <span class=main>=</span> fmrestrict_set <span class=free>vs</span> <span class=main>(</span>exec_plan <span class=free>s</span> <span class=free>as</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>e</span><span class=main>.</span> ListMem <span class=bound>e</span> <span class=free>as</span> <span class=main>⟶</span> varset_action <span class=bound>e</span> <span class=main>(</span><span class=main>(</span>prob_dom <span class=free>PROB</span><span class=main>)</span> <span class=main>-</span> <span class=free>vs</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms list_all_list_mem
    <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>a</span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"ListMem <span class=skolem>a</span> <span class=free>as</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"varset_action <span class=skolem>a</span> <span class=main>(</span>prob_dom <span class=free>PROB</span> <span class=main>-</span> <span class=free>vs</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> 1
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"disjnt <span class=main>(</span>fmdom' <span class=main>(</span>snd <span class=skolem>a</span><span class=main>)</span><span class=main>)</span> <span class=free>vs</span>"</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> disjnt_def
      <span class=keyword1><span class=command>using</span></span> vset_diff_disj_eff_vs
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"list_all <span class=main>(</span><span class=main>λ</span><span class=bound>a</span><span class=main>.</span> disjnt <span class=main>(</span>fmdom' <span class=main>(</span>snd <span class=bound>a</span><span class=main>)</span><span class=main>)</span> <span class=free>vs</span><span class=main>)</span> <span class=free>as</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> list_all_list_mem
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"list_all <span class=main>(</span><span class=main>λ</span><span class=bound>a</span><span class=main>.</span> disjnt <span class=main>(</span>fmdom' <span class=main>(</span>snd <span class=bound>a</span><span class=main>)</span><span class=main>)</span> <span class=free>vs</span><span class=main>)</span> <span class=main>(</span>rem_condless_act <span class=free>s</span> <span class=main>[]</span> <span class=free>as</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> rem_condless_valid_7<span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"exec_plan <span class=free>s</span> <span class=free>as</span> <span class=main>=</span> exec_plan <span class=free>s</span> <span class=main>(</span>rem_condless_act <span class=free>s</span> <span class=main>[]</span> <span class=free>as</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> rem_condless_valid_1
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span><span class=quoted><span class=quoted>"sat_precond_as <span class=free>s</span> <span class=main>(</span>rem_condless_act <span class=free>s</span> <span class=main>[]</span> <span class=free>as</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> rem_condless_valid_2
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"sat_precond_as <span class=free>s</span> <span class=main>[</span><span class=bound>a</span><span class=main>←</span><span class=free>as</span> <span class=main>.</span> <span class=main>¬</span> varset_action <span class=bound>a</span> <span class=main>(</span>prob_dom <span class=free>PROB</span> <span class=main>-</span> <span class=free>vs</span><span class=main>)</span><span class=main>]</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> 1 ListMem_iff<span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmrestrict_set <span class=free>vs</span> <span class=free>s</span> <span class=main>=</span> fmrestrict_set <span class=free>vs</span> <span class=free>s</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"
    fmrestrict_set <span class=free>vs</span> <span class=main>(</span>exec_plan <span class=free>s</span> <span class=free>as</span><span class=main>)</span> <span class=main>=</span>
    fmrestrict_set <span class=free>vs</span> <span class=main>(</span>exec_plan <span class=free>s</span> <span class=main>[</span><span class=bound>a</span><span class=main>←</span><span class=free>as</span> <span class=main>.</span> <span class=main>¬</span> varset_action <span class=bound>a</span> <span class=main>(</span>prob_dom <span class=free>PROB</span> <span class=main>-</span> <span class=free>vs</span><span class=main>)</span><span class=main>]</span><span class=main>)</span>
  "</span></span>
    <span class=keyword1><span class=command>using</span></span> 1 graph_plan_lemma_4<span class=main>[</span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span>
        s <span class=main><span class=main>=</span></span> <span class=quoted><span class=free>s</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>and</span></span></span> s' <span class=main><span class=main>=</span></span> <span class=quoted><span class=free>s</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>and</span></span></span> as <span class=main><span class=main>=</span></span> <span class=quoted><span class=quoted>"rem_condless_act <span class=free>s</span> <span class=main>[]</span> <span class=free>as</span>"</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>and</span></span></span> vs <span class=main><span class=main>=</span></span> <span class=quoted><span class=free>vs</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>and</span></span></span>
        P <span class=main><span class=main>=</span></span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>a</span><span class=main>.</span> varset_action <span class=bound>a</span> <span class=main>(</span>prob_dom <span class=free>PROB</span> <span class=main>-</span> <span class=free>vs</span><span class=main>)</span>"</span></span>
        <span class=main>]</span> filter_empty_every_not vset_diff_disj_eff_vs 1disjoint_effects_no_effects
      exec_plan.simps<span class=main>(</span>1<span class=main>)</span> fmdom'_restrict_set_precise list_all_list_mem
    <span class=keyword1><span class=command>by</span></span> <span class=operator>smt</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"list_all <span class=main>(</span><span class=main>λ</span><span class=bound>a</span><span class=main>.</span> varset_action <span class=bound>a</span> <span class=main>(</span>prob_dom <span class=free>PROB</span> <span class=main>-</span> <span class=free>vs</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>rem_condless_act <span class=free>s</span> <span class=main>[]</span> <span class=free>as</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>)</span> rem_condless_valid_7 list.pred_inject<span class=main>(</span>1<span class=main>)</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"filter <span class=main>(</span><span class=main>λ</span><span class=bound>a</span><span class=main>.</span> <span class=main>¬</span><span class=main>(</span>varset_action <span class=bound>a</span> <span class=main>(</span>prob_dom <span class=free>PROB</span> <span class=main>-</span> <span class=free>vs</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>rem_condless_act <span class=free>s</span> <span class=main>[]</span> <span class=free>as</span><span class=main>)</span> <span class=main>=</span> <span class=main>[]</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> filter_empty_every_not
    <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"
    sat_precond_as <span class=free>s</span> <span class=main>(</span>filter <span class=main>(</span><span class=main>λ</span><span class=bound>a</span><span class=main>.</span> <span class=main>¬</span><span class=main>(</span>varset_action <span class=bound>a</span> <span class=main>(</span>prob_dom <span class=free>PROB</span> <span class=main>-</span> <span class=free>vs</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>
    <span class=main>(</span>rem_condless_act <span class=free>s</span> <span class=main>[]</span><span class=free>as</span><span class=main>)</span><span class=main>)</span>
  "</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>using</span></span> 1 vset_diff_disj_eff_vs disjoint_effects_no_effects fmdom'_restrict_set_precise
    <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1 id=ActionSeqProcess-no_effectless_act_works><span class=command>lemma</span></span> no_effectless_act_works<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>as</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>no_effectless_act <span class=free>as</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>filter <span class=main>(</span><span class=main>λ</span><span class=bound>a</span><span class=main>.</span> <span class=main>¬</span><span class=main>(</span>fmdom' <span class=main>(</span>snd <span class=bound>a</span><span class=main>)</span> <span class=main>=</span> <span class=main>{}</span><span class=main>)</span><span class=main>)</span> <span class=free>as</span> <span class=main>=</span> <span class=free>as</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> Ball_set rem_effectless_works_7<span class=main>)</span>


<span class=keyword1 id=ActionSeqProcess-varset_act_diff_un_imp_varset_diff><span class=command>lemma</span></span> varset_act_diff_un_imp_varset_diff<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>a</span> <span class=free>vs</span> <span class=free>vs'</span> <span class=free>vs''</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>varset_action <span class=free>a</span> <span class=main>(</span><span class=free>vs''</span> <span class=main>-</span>  <span class=main>(</span><span class=free>vs'</span> <span class=main>∪</span> <span class=free>vs</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>varset_action <span class=free>a</span> <span class=main>(</span><span class=free>vs''</span> <span class=main>-</span> <span class=free>vs</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>unfolding</span></span> varset_action_def
  <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>


<span class=keyword1 id=ActionSeqProcess-vset_diff_union_vset_diff><span class=command>lemma</span></span> vset_diff_union_vset_diff<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>s</span> <span class=free>vs</span> <span class=free>vs'</span> <span class=free>a</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>varset_action <span class=free>a</span> <span class=main>(</span><span class=free>s</span> <span class=main>-</span> <span class=main>(</span><span class=free>vs</span> <span class=main>∪</span> <span class=free>vs'</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>varset_action <span class=free>a</span> <span class=main>(</span><span class=free>s</span> <span class=main>-</span> <span class=free>vs'</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>unfolding</span></span> varset_action_def
  <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>


<span class=keyword1 id=ActionSeqProcess-valid_filter_vset_dom_idempot><span class=command>lemma</span></span> valid_filter_vset_dom_idempot<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=free>as</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>filter <span class=main>(</span><span class=main>λ</span><span class=bound>a</span><span class=main>.</span> varset_action <span class=bound>a</span> <span class=main>(</span>prob_dom <span class=free>PROB</span><span class=main>)</span><span class=main>)</span> <span class=free>as</span> <span class=main>=</span> <span class=free>as</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>as</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>a</span> <span class=skolem>as</span><span class=main>)</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> Cons.prems valid_plan_valid_tail
      <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>filter <span class=main>(</span><span class=main>λ</span><span class=bound>a</span><span class=main>.</span> varset_action <span class=bound>a</span> <span class=main>(</span>prob_dom <span class=free>PROB</span><span class=main>)</span><span class=main>)</span> <span class=skolem>as</span> <span class=main>=</span> <span class=skolem>as</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> Cons.IH
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>{</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a</span> <span class=main>∈</span> <span class=free>PROB</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> Cons.prems valid_plan_valid_head
      <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"varset_action <span class=skolem>a</span> <span class=main>(</span>prob_dom <span class=free>PROB</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> varset_action_def
      <span class=keyword1><span class=command>using</span></span> FDOM_eff_subset_prob_dom_pair
      <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span> <span class=operator>fastforce</span>


<span class=keyword1 id=ActionSeqProcess-n_replace_proj_le_n_as_1><span class=command>lemma</span></span> n_replace_proj_le_n_as_1<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>a</span> <span class=free>vs</span> <span class=free>vs'</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>vs</span> <span class=main>⊆</span> <span class=free>vs'</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>varset_action <span class=free>a</span> <span class=free>vs</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>varset_action <span class=free>a</span> <span class=free>vs'</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>unfolding</span></span> varset_action_def
  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>


<span class=keyword1 id=ActionSeqProcess-sat_precond_as_pfx><span class=command>lemma</span></span> sat_precond_as_pfx<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>s</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>sat_precond_as <span class=free>s</span> <span class=main>(</span><span class=free>as</span> <span class=main>@</span> <span class=free>as'</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>sat_precond_as <span class=free>s</span> <span class=free>as</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>as</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>s</span></span> <span class=quoted><span class=free>as'</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>a</span> <span class=skolem>as</span><span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fst <span class=skolem>a</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=skolem>s</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Cons.prems
    <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"sat_precond_as <span class=main>(</span>state_succ <span class=skolem>s</span> <span class=skolem>a</span><span class=main>)</span> <span class=main>(</span><span class=skolem>as</span> <span class=main>@</span> <span class=skolem>as'</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Cons.prems
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>using</span></span> Cons.IH sat_precond_as.simps<span class=main>(</span>2<span class=main>)</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span> <span class=operator>simp</span>


<span class=keyword2><span class=keyword>end</span></span></pre>
</div><div id=RelUtils>
<div class=head>
<h1>Theory RelUtils</h1>
</div>
<pre class=source><span class=keyword1><span class=command>theory</span></span> RelUtils
  <span class=keyword2><span class=keyword>imports</span></span> <a href=https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html>Main</a> <span class=quoted>"<a href=https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Transitive_Closure.html>HOL.Transitive_Closure</a>"</span>
<span class=keyword2><span class=keyword>begin</span></span>

<span class=comment1>― ‹NOTE added definition.›</span>
<span class=keyword1><span class=command>definition</span></span> <span class=entity>reflexive</span> <span class=keyword2><span class=keyword>where</span></span> 
  <span class=quoted><span class=quoted>"<span class=free>reflexive</span> <span class=free><span class=bound><span class=entity>R</span></span></span> <span class=main>≡</span> <span class=main>∀</span><span class=bound>x</span><span class=main>.</span> <span class=free><span class=bound><span class=entity>R</span></span></span> <span class=bound>x</span> <span class=bound>x</span>"</span></span>

<span class=comment1>― ‹NOTE translation of 'TC' in relationScript.sml:69.›</span>
<span class=comment1>― ‹TODO can we replace this with something from 'HOL.Transitive\_Closure'?›</span>
<span class=keyword1><span class=command>definition</span></span> <span class=entity>TC</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>TC</span> <span class=free><span class=bound><span class=entity>R</span></span></span> <span class=free><span class=bound><span class=entity>a</span></span></span> <span class=free><span class=bound><span class=entity>b</span></span></span> <span class=main>≡</span> <span class=main>(</span><span class=main>∀</span><span class=bound>P</span><span class=main>.</span> <span class=main>(</span><span class=main>∀</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=free><span class=bound><span class=entity>R</span></span></span> <span class=bound>x</span> <span class=bound>y</span> <span class=main>⟶</span> <span class=bound>P</span> <span class=bound>x</span> <span class=bound>y</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=main>∀</span><span class=bound>x</span> <span class=bound>y</span> <span class=bound>z</span><span class=main>.</span> <span class=bound>P</span> <span class=bound>x</span> <span class=bound>y</span> <span class=main>∧</span> <span class=bound>P</span> <span class=bound>y</span> <span class=bound>z</span> <span class=main>⟶</span> <span class=bound>P</span> <span class=bound>x</span> <span class=bound>z</span><span class=main>)</span> <span class=main>⟶</span> <span class=bound>P</span> <span class=free><span class=bound><span class=entity>a</span></span></span> <span class=free><span class=bound><span class=entity>b</span></span></span><span class=main>)</span>"</span></span>

<span class=comment1>― ‹NOTE adapts transitive closure definitions of Isabelle and HOL4.›</span>
<span class=keyword1 id=RelUtils-TC_equiv_tranclp><span class=command>lemma</span></span> TC_equiv_tranclp<span class=main>:</span> <span class=quoted><span class=quoted>"TC <span class=free>R</span> <span class=free>a</span> <span class=free>b</span> <span class=main>⟷</span> <span class=main>(</span><span class=free>R</span><span class=main><span class=hidden>⇧</span><sup>+</sup><span class=hidden>⇧</span><sup>+</sup></span> <span class=free>a</span> <span class=free>b</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"TC <span class=free>R</span> <span class=free>a</span> <span class=free>b</span> <span class=main>⟹</span> <span class=main>(</span><span class=free>R</span><span class=main><span class=hidden>⇧</span><sup>+</sup><span class=hidden>⇧</span><sup>+</sup></span> <span class=free>a</span> <span class=free>b</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> TC_def 
      <span class=keyword1><span class=command>using</span></span> tranclp.r_into_trancl tranclp_trans
      <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>moreover</span></span> 
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>R</span><span class=main><span class=hidden>⇧</span><sup>+</sup><span class=hidden>⇧</span><sup>+</sup></span> <span class=free>a</span> <span class=free>b</span><span class=main>)</span> <span class=main>⟹</span> TC <span class=free>R</span> <span class=free>a</span> <span class=free>b</span>"</span></span> <span class=keyword1><span class=command>proof</span></span><span class=main>(</span><span class=operator>induction</span> <span class=quasi_keyword>rule</span><span class=main><span class=main>:</span></span> tranclp.induct<span class=main>)</span>
      <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>r_into_trancl <span class=skolem>a</span> <span class=skolem>b</span><span class=main>)</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>subst</span> TC_def<span class=main><span class=keyword3>;</span></span> <span class=operator>auto</span><span class=main>)</span>
    <span class=keyword1><span class=command>next</span></span>
      <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>trancl_into_trancl <span class=skolem>a</span> <span class=skolem>b</span> <span class=skolem>c</span><span class=main>)</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>unfolding</span></span> TC_def <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>qed</span></span> 
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=RelUtils-TC_IMP_NOT_TC_CONJ_1><span class=command>lemma</span></span> TC_IMP_NOT_TC_CONJ_1<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>R</span> <span class=free>P</span>  <span class=keyword2><span class=keyword>and</span></span>  <span class=free>x</span> <span class=free>y</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span><span class=main>(</span><span class=free>R</span><span class=main><span class=hidden>⇧</span><sup>+</sup><span class=hidden>⇧</span><sup>+</sup></span> <span class=free>x</span> <span class=free>y</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span><span class=main>(</span><span class=main>(</span><span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=free>R</span> <span class=bound>x</span> <span class=bound>y</span> <span class=main>∧</span> <span class=free>P</span> <span class=bound>x</span> <span class=bound>y</span><span class=main>)</span><span class=main><span class=hidden>⇧</span><sup>+</sup><span class=hidden>⇧</span><sup>+</sup></span> <span class=free>x</span> <span class=free>y</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>from</span></span> assms<span class=main>(</span>1<span class=main>)</span> <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>¬</span>TC <span class=free>R</span> <span class=free>x</span> <span class=free>y</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> TC_equiv_tranclp
    <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>assume</span></span> P<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>¬</span>TC <span class=free>R</span> <span class=free>x</span> <span class=free>y</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>P</span></span> <span class=keyword2><span class=keyword>where</span></span> a<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=free>R</span> <span class=bound>x</span> <span class=bound>y</span> <span class=main>⟶</span> <span class=skolem>P</span> <span class=bound>x</span> <span class=bound>y</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=main>∀</span><span class=bound>x</span> <span class=bound>y</span> <span class=bound>z</span><span class=main>.</span> <span class=skolem>P</span> <span class=bound>x</span> <span class=bound>y</span> <span class=main>∧</span> <span class=skolem>P</span> <span class=bound>y</span> <span class=bound>z</span> <span class=main>⟶</span> <span class=skolem>P</span> <span class=bound>x</span> <span class=bound>z</span><span class=main>)</span> <span class=main>⟶</span> <span class=main>¬</span><span class=skolem>P</span> <span class=free>x</span> <span class=free>y</span>"</span></span> 
      <span class=keyword1><span class=command>unfolding</span></span> TC_def
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>{</span></span>
      <span class=keyword3><span class=command>assume</span></span> P_1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=free>R</span> <span class=bound>x</span> <span class=bound>y</span> <span class=main>⟶</span> <span class=skolem>P</span> <span class=bound>x</span> <span class=bound>y</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>x</span> <span class=bound>y</span> <span class=bound>z</span><span class=main>.</span> <span class=skolem>P</span> <span class=bound>x</span> <span class=bound>y</span> <span class=main>∧</span> <span class=skolem>P</span> <span class=bound>y</span> <span class=bound>z</span> <span class=main>⟶</span> <span class=skolem>P</span> <span class=bound>x</span> <span class=bound>z</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=free>R</span> <span class=bound>x</span> <span class=bound>y</span> <span class=main>∧</span> <span class=skolem>P</span> <span class=bound>x</span> <span class=bound>y</span> <span class=main>⟶</span> <span class=skolem>P</span> <span class=bound>x</span> <span class=bound>y</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>x</span> <span class=bound>y</span> <span class=bound>z</span><span class=main>.</span> <span class=skolem>P</span> <span class=bound>x</span> <span class=bound>y</span> <span class=main>∧</span> <span class=skolem>P</span> <span class=bound>y</span> <span class=bound>z</span> <span class=main>⟶</span> <span class=skolem>P</span> <span class=bound>x</span> <span class=bound>z</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span><span class=main><span class=keyword3>+</span></span>
      <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> a <span class=keyword2><span class=keyword>and</span></span> P_1 <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span><span class=skolem>P</span> <span class=free>x</span> <span class=free>y</span>"</span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>P</span><span class=main>.</span> <span class=main>(</span><span class=main>∀</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=free>R</span> <span class=bound>x</span> <span class=bound>y</span> <span class=main>∧</span> <span class=bound>P</span> <span class=bound>x</span> <span class=bound>y</span> <span class=main>⟶</span> <span class=bound>P</span> <span class=bound>x</span> <span class=bound>y</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=main>∀</span><span class=bound>x</span> <span class=bound>y</span> <span class=bound>z</span><span class=main>.</span> <span class=bound>P</span> <span class=bound>x</span> <span class=bound>y</span> <span class=main>∧</span> <span class=bound>P</span> <span class=bound>y</span> <span class=bound>z</span> <span class=main>⟶</span> <span class=bound>P</span> <span class=bound>x</span> <span class=bound>z</span><span class=main>)</span> <span class=main>⟶</span> <span class=main>¬</span><span class=bound>P</span> <span class=free>x</span> <span class=free>y</span>"</span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>}</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>P</span><span class=main>.</span> 
      <span class=main>(</span><span class=main>∀</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=free>R</span> <span class=bound>x</span> <span class=bound>y</span> <span class=main>∧</span> <span class=bound>P</span> <span class=bound>x</span> <span class=bound>y</span> <span class=main>⟶</span> <span class=bound>P</span> <span class=bound>x</span> <span class=bound>y</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=main>∀</span><span class=bound>x</span> <span class=bound>y</span> <span class=bound>z</span><span class=main>.</span> <span class=bound>P</span> <span class=bound>x</span> <span class=bound>y</span> <span class=main>∧</span> <span class=bound>P</span> <span class=bound>y</span> <span class=bound>z</span> <span class=main>⟶</span> <span class=bound>P</span> <span class=bound>x</span> <span class=bound>z</span><span class=main>)</span> <span class=main>⟶</span> <span class=main>¬</span><span class=bound>P</span> <span class=free>x</span> <span class=free>y</span>"</span></span> 
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span> 
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>note</span></span> 2 <span class=main>=</span> this
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword1><span class=command>from</span></span> 1 2 <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>P</span><span class=main>.</span> 
      <span class=main>(</span><span class=main>∀</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=free>R</span> <span class=bound>x</span> <span class=bound>y</span> <span class=main>∧</span> <span class=bound>P</span> <span class=bound>x</span> <span class=bound>y</span> <span class=main>⟶</span> <span class=bound>P</span> <span class=bound>x</span> <span class=bound>y</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=main>∀</span><span class=bound>x</span> <span class=bound>y</span> <span class=bound>z</span><span class=main>.</span> <span class=bound>P</span> <span class=bound>x</span> <span class=bound>y</span> <span class=main>∧</span> <span class=bound>P</span> <span class=bound>y</span> <span class=bound>z</span> <span class=main>⟶</span> <span class=bound>P</span> <span class=bound>x</span> <span class=bound>z</span><span class=main>)</span> <span class=main>⟶</span> <span class=main>¬</span><span class=bound>P</span> <span class=free>x</span> <span class=free>y</span>"</span></span> 
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span>TC <span class=main>(</span><span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=free>R</span> <span class=bound>x</span> <span class=bound>y</span> <span class=main>∧</span> <span class=free>P</span> <span class=bound>x</span> <span class=bound>y</span><span class=main>)</span> <span class=free>x</span> <span class=free>y</span>"</span></span> 
      <span class=keyword1><span class=command>unfolding</span></span> TC_def  
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> assms tranclp.r_into_trancl tranclp_trans<span class=main>)</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span><span class=main>(</span><span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=free>R</span> <span class=bound>x</span> <span class=bound>y</span> <span class=main>∧</span> <span class=free>P</span> <span class=bound>x</span> <span class=bound>y</span><span class=main>)</span><span class=main><span class=hidden>⇧</span><sup>+</sup><span class=hidden>⇧</span><sup>+</sup></span> <span class=free>x</span> <span class=free>y</span>"</span></span> 
      <span class=keyword1><span class=command>using</span></span> TC_equiv_tranclp
      <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=RelUtils-TC_IMP_NOT_TC_CONJ><span class=command>lemma</span></span> TC_IMP_NOT_TC_CONJ<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>R</span> <span class=free>R'</span> <span class=free>P</span> <span class=free>x</span> <span class=free>y</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=free>P</span> <span class=bound>x</span> <span class=bound>y</span> <span class=main>⟶</span> <span class=free>R'</span> <span class=bound>x</span> <span class=bound>y</span> <span class=main>⟶</span> <span class=free>R</span> <span class=bound>x</span> <span class=bound>y</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span><span class=free>R</span><span class=main><span class=hidden>⇧</span><sup>+</sup><span class=hidden>⇧</span><sup>+</sup></span> <span class=free>x</span> <span class=free>y</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span><span class=main>(</span><span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=free>R'</span> <span class=bound>x</span> <span class=bound>y</span> <span class=main>∧</span> <span class=free>P</span> <span class=bound>x</span> <span class=bound>y</span><span class=main>)</span><span class=main><span class=hidden>⇧</span><sup>+</sup><span class=hidden>⇧</span><sup>+</sup></span> <span class=free>x</span> <span class=free>y</span>"</span></span> 
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>from</span></span> assms<span class=main>(</span>2<span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>¬</span><span class=main>(</span><span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=free>R</span> <span class=bound>x</span> <span class=bound>y</span> <span class=main>∧</span> <span class=free>P</span> <span class=bound>x</span>  <span class=bound>y</span><span class=main>)</span><span class=main><span class=hidden>⇧</span><sup>+</sup><span class=hidden>⇧</span><sup>+</sup></span> <span class=free>x</span> <span class=free>y</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> TC_IMP_NOT_TC_CONJ_1<span class=main>[</span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> P<span class=main><span class=main>=</span></span><span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=free>P</span> <span class=bound>x</span> <span class=bound>y</span>"</span></span><span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword1><span class=command>{</span></span>
      <span class=keyword1><span class=command>from</span></span> 1 <span class=keyword1><span class=command>have</span></span>  <span class=quoted><span class=quoted>"<span class=main>¬</span>TC <span class=main>(</span><span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=free>R</span> <span class=bound>x</span> <span class=bound>y</span> <span class=main>∧</span> <span class=free>P</span> <span class=bound>x</span>  <span class=bound>y</span><span class=main>)</span> <span class=free>x</span> <span class=free>y</span>"</span></span> 
        <span class=keyword1><span class=command>using</span></span> TC_equiv_tranclp 
        <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>Pa</span><span class=main>.</span>
      <span class=main>(</span><span class=main>∀</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=free>R</span> <span class=bound>x</span> <span class=bound>y</span> <span class=main>∧</span> <span class=free>P</span> <span class=bound>x</span> <span class=bound>y</span> <span class=main>⟶</span> <span class=bound>Pa</span> <span class=bound>x</span> <span class=bound>y</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=main>∀</span><span class=bound>x</span> <span class=bound>y</span> <span class=bound>z</span><span class=main>.</span> <span class=bound>Pa</span> <span class=bound>x</span> <span class=bound>y</span> <span class=main>∧</span> <span class=bound>Pa</span> <span class=bound>y</span> <span class=bound>z</span> <span class=main>⟶</span> <span class=bound>Pa</span> <span class=bound>x</span> <span class=bound>z</span><span class=main>)</span> 
      <span class=main>⟶</span> <span class=main>¬</span><span class=bound>Pa</span> <span class=free>x</span> <span class=free>y</span>"</span></span>
        <span class=keyword1><span class=command>unfolding</span></span> TC_def
        <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>}</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>Pa</span></span> <span class=keyword2><span class=keyword>where</span></span> a<span class=main>:</span> 
      <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=free>R</span> <span class=bound>x</span> <span class=bound>y</span> <span class=main>∧</span> <span class=free>P</span> <span class=bound>x</span> <span class=bound>y</span> <span class=main>⟶</span> <span class=skolem>Pa</span> <span class=bound>x</span> <span class=bound>y</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=main>∀</span><span class=bound>x</span> <span class=bound>y</span> <span class=bound>z</span><span class=main>.</span> <span class=skolem>Pa</span> <span class=bound>x</span> <span class=bound>y</span> <span class=main>∧</span> <span class=skolem>Pa</span> <span class=bound>y</span> <span class=bound>z</span> <span class=main>⟶</span> <span class=skolem>Pa</span> <span class=bound>x</span> <span class=bound>z</span><span class=main>)</span> <span class=main>⟶</span> <span class=main>¬</span><span class=skolem>Pa</span> <span class=free>x</span> <span class=free>y</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span><span class=main>(</span><span class=main>∀</span><span class=bound>Pa</span><span class=main>.</span> <span class=main>(</span><span class=main>∀</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=free>R'</span> <span class=bound>x</span> <span class=bound>y</span> <span class=main>∧</span> <span class=free>P</span> <span class=bound>x</span> <span class=bound>y</span> <span class=main>⟶</span> <span class=bound>Pa</span> <span class=bound>x</span> <span class=bound>y</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=main>∀</span><span class=bound>x</span> <span class=bound>y</span> <span class=bound>z</span><span class=main>.</span> <span class=bound>Pa</span> <span class=bound>x</span> <span class=bound>y</span> <span class=main>∧</span> <span class=bound>Pa</span> <span class=bound>y</span> <span class=bound>z</span> <span class=main>⟶</span> <span class=bound>Pa</span> <span class=bound>x</span> <span class=bound>z</span><span class=main>)</span> <span class=main>⟶</span> <span class=bound>Pa</span> <span class=free>x</span> <span class=free>y</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> assms<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span> assms<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span> tranclp.r_into_trancl tranclp_trans<span class=main>)</span> 
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span>TC <span class=main>(</span><span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=free>R'</span> <span class=bound>x</span> <span class=bound>y</span> <span class=main>∧</span> <span class=free>P</span> <span class=bound>x</span> <span class=bound>y</span><span class=main>)</span> <span class=free>x</span> <span class=free>y</span>"</span></span> 
      <span class=keyword1><span class=command>unfolding</span></span> TC_def
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>using</span></span> TC_equiv_tranclp
    <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=comment1>― ‹NOTE added lemma (relationScript.sml:314)›</span> 
<span class=keyword1 id=RelUtils-TC_INDUCT><span class=command>lemma</span></span> TC_INDUCT<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>R</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> <span class=main>⇒</span> <span class=tfree>'a</span> <span class=main>⇒</span> bool"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=free>P</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=free>R</span> <span class=bound>x</span> <span class=bound>y</span> <span class=main>⟶</span> <span class=free>P</span> <span class=bound>x</span> <span class=bound>y</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>x</span> <span class=bound>y</span> <span class=bound>z</span><span class=main>.</span> <span class=free>P</span> <span class=bound>x</span> <span class=bound>y</span> <span class=main>∧</span> <span class=free>P</span> <span class=bound>y</span> <span class=bound>z</span> <span class=main>⟶</span> <span class=free>P</span> <span class=bound>x</span> <span class=bound>z</span><span class=main>)</span>"</span></span> 
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>u</span> <span class=bound>v</span><span class=main>.</span> <span class=main>(</span>TC <span class=free>R</span><span class=main>)</span> <span class=bound>u</span> <span class=bound>v</span> <span class=main>⟶</span> <span class=free>P</span> <span class=bound>u</span> <span class=bound>v</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>unfolding</span></span> TC_def
  <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>

<span class=keyword1 id=RelUtils-REFL_IMP_3_CONJ_1><span class=command>lemma</span></span> REFL_IMP_3_CONJ_1<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>R</span> <span class=free>P</span> <span class=free>x</span> <span class=free>y</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>(</span><span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=free>R</span> <span class=bound>x</span> <span class=bound>y</span> <span class=main>∧</span> <span class=free>P</span> <span class=bound>x</span> <span class=bound>y</span><span class=main>)</span><span class=main><span class=hidden>⇧</span><sup>+</sup><span class=hidden>⇧</span><sup>+</sup></span> <span class=free>x</span> <span class=free>y</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=free>R</span><span class=main><span class=hidden>⇧</span><sup>+</sup><span class=hidden>⇧</span><sup>+</sup></span> <span class=free>x</span> <span class=free>y</span>"</span></span> 
  <span class=keyword1><span class=command>using</span></span> assms 
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>using</span></span> assms TC_IMP_NOT_TC_CONJ_1
    <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=RelUtils-REFL_IMP_3_CONJ><span class=command>lemma</span></span> REFL_IMP_3_CONJ<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>R'</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"reflexive <span class=free>R'</span>"</span></span> 
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>P</span> <span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> 
    <span class=main>(</span><span class=free>R'</span><span class=main><span class=hidden>⇧</span><sup>+</sup><span class=hidden>⇧</span><sup>+</sup></span> <span class=bound>x</span> <span class=bound>y</span><span class=main>)</span> <span class=main>⟶</span> <span class=main>(</span> <span class=main>(</span><span class=main>(</span><span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=free>R'</span> <span class=bound>x</span> <span class=bound>y</span> <span class=main>∧</span> <span class=bound>P</span> <span class=bound>x</span> <span class=main>∧</span> <span class=bound>P</span> <span class=bound>y</span><span class=main>)</span><span class=main><span class=hidden>⇧</span><sup>+</sup><span class=hidden>⇧</span><sup>+</sup></span> <span class=bound>x</span> <span class=bound>y</span><span class=main>)</span> <span class=main>∨</span> <span class=main>(</span><span class=main>∃</span><span class=bound>z</span><span class=main>.</span> <span class=main>¬</span><span class=bound>P</span> <span class=bound>z</span> <span class=main>∧</span> <span class=free>R'</span><span class=main><span class=hidden>⇧</span><sup>+</sup><span class=hidden>⇧</span><sup>+</sup></span> <span class=bound>x</span> <span class=bound>z</span> <span class=main>∧</span> <span class=free>R'</span><span class=main><span class=hidden>⇧</span><sup>+</sup><span class=hidden>⇧</span><sup>+</sup></span> <span class=bound>z</span> <span class=bound>y</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>P</span>
    <span class=keyword1><span class=command>{</span></span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=free>R'</span> <span class=bound>x</span> <span class=bound>y</span> <span class=main>⟶</span> <span class=main>(</span><span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=free>R'</span> <span class=bound>x</span> <span class=bound>y</span> <span class=main>∧</span> <span class=skolem>P</span> <span class=bound>x</span> <span class=main>∧</span> <span class=skolem>P</span> <span class=bound>y</span><span class=main>)</span><span class=main><span class=hidden>⇧</span><sup>+</sup><span class=hidden>⇧</span><sup>+</sup></span> <span class=bound>x</span> <span class=bound>y</span> <span class=main>∨</span> <span class=main>(</span><span class=main>∃</span><span class=bound>z</span><span class=main>.</span> <span class=main>¬</span> <span class=skolem>P</span> <span class=bound>z</span> <span class=main>∧</span> <span class=free>R'</span><span class=main><span class=hidden>⇧</span><sup>+</sup><span class=hidden>⇧</span><sup>+</sup></span> <span class=bound>x</span> <span class=bound>z</span> <span class=main>∧</span> <span class=free>R'</span><span class=main><span class=hidden>⇧</span><sup>+</sup><span class=hidden>⇧</span><sup>+</sup></span> <span class=bound>z</span> <span class=bound>y</span><span class=main>)</span>"</span></span> 
      <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>auto</span><span class=main>)</span>
        <span class=keyword3><span class=command>fix</span></span> <span class=skolem>x</span> <span class=skolem>y</span>
        <span class=keyword3><span class=command>assume</span></span> P<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>R'</span> <span class=skolem>x</span> <span class=skolem>y</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>z</span><span class=main>.</span> <span class=free>R'</span><span class=main><span class=hidden>⇧</span><sup>+</sup><span class=hidden>⇧</span><sup>+</sup></span> <span class=skolem>x</span> <span class=bound>z</span> <span class=main>⟶</span> <span class=skolem>P</span> <span class=bound>z</span> <span class=main>∨</span> <span class=main>¬</span> <span class=free>R'</span><span class=main><span class=hidden>⇧</span><sup>+</sup><span class=hidden>⇧</span><sup>+</sup></span> <span class=bound>z</span> <span class=skolem>y</span>"</span></span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=free>R'</span> <span class=bound>x</span> <span class=bound>y</span> <span class=main>∧</span> <span class=skolem>P</span> <span class=bound>x</span> <span class=main>∧</span> <span class=skolem>P</span> <span class=bound>y</span><span class=main>)</span><span class=main><span class=hidden>⇧</span><sup>+</sup><span class=hidden>⇧</span><sup>+</sup></span> <span class=skolem>x</span> <span class=skolem>y</span>"</span></span>
        <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
          <span class=keyword1><span class=command>have</span></span> a<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>a</span><span class=main>.</span> <span class=main>¬</span> <span class=free>R'</span> <span class=skolem>x</span> <span class=bound>a</span> <span class=main>∨</span> <span class=main>¬</span> <span class=free>R'</span> <span class=bound>a</span> <span class=skolem>y</span> <span class=main>∨</span> <span class=skolem>P</span> <span class=bound>a</span>"</span></span>
            <span class=keyword1><span class=command>using</span></span> P<span class=main>(</span>2<span class=main>)</span>
            <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
          <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"reflexive <span class=free>R'</span>"</span></span>
            <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>meson</span> assms<span class=main>)</span>
          <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
            <span class=keyword1><span class=command>using</span></span> a P<span class=main>(</span>1<span class=main>)</span>
            <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> reflexive_def tranclp.r_into_trancl<span class=main>)</span>
        <span class=keyword1><span class=command>qed</span></span>
      <span class=keyword1><span class=command>qed</span></span>
    <span class=keyword1><span class=command>}</span></span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>{</span></span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>x</span> <span class=bound>y</span> <span class=bound>z</span><span class=main>.</span> <span class=main>(</span><span class=main>(</span><span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=free>R'</span> <span class=bound>x</span> <span class=bound>y</span> <span class=main>∧</span> <span class=skolem>P</span> <span class=bound>x</span> <span class=main>∧</span> <span class=skolem>P</span> <span class=bound>y</span><span class=main>)</span><span class=main><span class=hidden>⇧</span><sup>+</sup><span class=hidden>⇧</span><sup>+</sup></span> <span class=bound>x</span> <span class=bound>y</span> <span class=main>∨</span> <span class=main>(</span><span class=main>∃</span><span class=bound>z</span><span class=main>.</span> <span class=main>¬</span> <span class=skolem>P</span> <span class=bound>z</span> <span class=main>∧</span> <span class=free>R'</span><span class=main><span class=hidden>⇧</span><sup>+</sup><span class=hidden>⇧</span><sup>+</sup></span> <span class=bound>x</span> <span class=bound>z</span> <span class=main>∧</span> <span class=free>R'</span><span class=main><span class=hidden>⇧</span><sup>+</sup><span class=hidden>⇧</span><sup>+</sup></span> <span class=bound>z</span> <span class=bound>y</span><span class=main>)</span><span class=main>)</span> <span class=main>∧</span>
         <span class=main>(</span><span class=main>(</span><span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=free>R'</span> <span class=bound>x</span> <span class=bound>y</span> <span class=main>∧</span> <span class=skolem>P</span> <span class=bound>x</span> <span class=main>∧</span> <span class=skolem>P</span> <span class=bound>y</span><span class=main>)</span><span class=main><span class=hidden>⇧</span><sup>+</sup><span class=hidden>⇧</span><sup>+</sup></span> <span class=bound>y</span> <span class=bound>z</span> <span class=main>∨</span> <span class=main>(</span><span class=main>∃</span><span class=bound>za</span><span class=main>.</span> <span class=main>¬</span> <span class=skolem>P</span> <span class=bound>za</span> <span class=main>∧</span> <span class=free>R'</span><span class=main><span class=hidden>⇧</span><sup>+</sup><span class=hidden>⇧</span><sup>+</sup></span> <span class=bound>y</span> <span class=bound>za</span> <span class=main>∧</span> <span class=free>R'</span><span class=main><span class=hidden>⇧</span><sup>+</sup><span class=hidden>⇧</span><sup>+</sup></span> <span class=bound>za</span> <span class=bound>z</span><span class=main>)</span><span class=main>)</span> <span class=main>⟶</span>
         <span class=main>(</span><span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=free>R'</span> <span class=bound>x</span> <span class=bound>y</span> <span class=main>∧</span> <span class=skolem>P</span> <span class=bound>x</span> <span class=main>∧</span> <span class=skolem>P</span> <span class=bound>y</span><span class=main>)</span><span class=main><span class=hidden>⇧</span><sup>+</sup><span class=hidden>⇧</span><sup>+</sup></span> <span class=bound>x</span> <span class=bound>z</span> <span class=main>∨</span> <span class=main>(</span><span class=main>∃</span><span class=bound>za</span><span class=main>.</span> <span class=main>¬</span> <span class=skolem>P</span> <span class=bound>za</span> <span class=main>∧</span> <span class=free>R'</span><span class=main><span class=hidden>⇧</span><sup>+</sup><span class=hidden>⇧</span><sup>+</sup></span> <span class=bound>x</span> <span class=bound>za</span> <span class=main>∧</span> <span class=free>R'</span><span class=main><span class=hidden>⇧</span><sup>+</sup><span class=hidden>⇧</span><sup>+</sup></span> <span class=bound>za</span> <span class=bound>z</span><span class=main>)</span>"</span></span> 
      <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>auto</span><span class=main>)</span>
        <span class=keyword3><span class=command>fix</span></span> <span class=skolem>x</span> <span class=skolem>y</span> <span class=skolem>z</span> <span class=skolem>za</span>
        <span class=keyword3><span class=command>assume</span></span> P<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>za</span><span class=main>.</span> <span class=free>R'</span><span class=main><span class=hidden>⇧</span><sup>+</sup><span class=hidden>⇧</span><sup>+</sup></span> <span class=skolem>x</span> <span class=bound>za</span> <span class=main>⟶</span> <span class=skolem>P</span> <span class=bound>za</span> <span class=main>∨</span> <span class=main>¬</span> <span class=free>R'</span><span class=main><span class=hidden>⇧</span><sup>+</sup><span class=hidden>⇧</span><sup>+</sup></span> <span class=bound>za</span> <span class=skolem>z</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=free>R'</span> <span class=bound>x</span> <span class=bound>y</span> <span class=main>∧</span> <span class=skolem>P</span> <span class=bound>x</span> <span class=main>∧</span> <span class=skolem>P</span> <span class=bound>y</span><span class=main>)</span><span class=main><span class=hidden>⇧</span><sup>+</sup><span class=hidden>⇧</span><sup>+</sup></span> <span class=skolem>x</span> <span class=skolem>y</span>"</span></span>
          <span class=quoted><span class=quoted>"<span class=main>¬</span> <span class=skolem>P</span> <span class=skolem>za</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>R'</span><span class=main><span class=hidden>⇧</span><sup>+</sup><span class=hidden>⇧</span><sup>+</sup></span> <span class=skolem>y</span> <span class=skolem>za</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>R'</span><span class=main><span class=hidden>⇧</span><sup>+</sup><span class=hidden>⇧</span><sup>+</sup></span> <span class=skolem>za</span> <span class=skolem>z</span>"</span></span> 
        <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=free>R'</span> <span class=bound>x</span> <span class=bound>y</span> <span class=main>∧</span> <span class=skolem>P</span> <span class=bound>x</span> <span class=main>∧</span> <span class=skolem>P</span> <span class=bound>y</span><span class=main>)</span><span class=main><span class=hidden>⇧</span><sup>+</sup><span class=hidden>⇧</span><sup>+</sup></span> <span class=skolem>x</span> <span class=skolem>z</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> P
          <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>meson</span> P rtranclp_tranclp_tranclp TC_IMP_NOT_TC_CONJ_1  tranclp_into_rtranclp<span class=main>)</span>
      <span class=keyword1><span class=command>next</span></span> 
        <span class=keyword3><span class=command>fix</span></span> <span class=skolem>x</span> <span class=skolem>y</span> <span class=skolem>z</span> <span class=skolem>za</span>
        <span class=keyword3><span class=command>assume</span></span> P<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>za</span><span class=main>.</span> <span class=free>R'</span><span class=main><span class=hidden>⇧</span><sup>+</sup><span class=hidden>⇧</span><sup>+</sup></span> <span class=skolem>x</span> <span class=bound>za</span> <span class=main>⟶</span> <span class=skolem>P</span> <span class=bound>za</span> <span class=main>∨</span> <span class=main>¬</span> <span class=free>R'</span><span class=main><span class=hidden>⇧</span><sup>+</sup><span class=hidden>⇧</span><sup>+</sup></span> <span class=bound>za</span> <span class=skolem>z</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span> <span class=skolem>P</span> <span class=skolem>za</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>R'</span><span class=main><span class=hidden>⇧</span><sup>+</sup><span class=hidden>⇧</span><sup>+</sup></span> <span class=skolem>x</span> <span class=skolem>za</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>R'</span><span class=main><span class=hidden>⇧</span><sup>+</sup><span class=hidden>⇧</span><sup>+</sup></span> <span class=skolem>za</span> <span class=skolem>y</span>"</span></span> 
          <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=free>R'</span> <span class=bound>x</span> <span class=bound>y</span> <span class=main>∧</span> <span class=skolem>P</span> <span class=bound>x</span> <span class=main>∧</span> <span class=skolem>P</span> <span class=bound>y</span><span class=main>)</span><span class=main><span class=hidden>⇧</span><sup>+</sup><span class=hidden>⇧</span><sup>+</sup></span> <span class=skolem>y</span> <span class=skolem>z</span>"</span></span> 
        <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=free>R'</span> <span class=bound>x</span> <span class=bound>y</span> <span class=main>∧</span> <span class=skolem>P</span> <span class=bound>x</span> <span class=main>∧</span> <span class=skolem>P</span> <span class=bound>y</span><span class=main>)</span><span class=main><span class=hidden>⇧</span><sup>+</sup><span class=hidden>⇧</span><sup>+</sup></span> <span class=skolem>x</span> <span class=skolem>z</span>"</span></span>
          <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>meson</span> P TC_IMP_NOT_TC_CONJ_1 tranclp_trans<span class=main>)</span>
      <span class=keyword1><span class=command>qed</span></span>
    <span class=keyword1><span class=command>}</span></span>
    <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>u</span> <span class=bound>v</span><span class=main>.</span> 
      TC <span class=free>R'</span> <span class=bound>u</span> <span class=bound>v</span> 
      <span class=main>⟶</span> <span class=main>(</span><span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=free>R'</span> <span class=bound>x</span> <span class=bound>y</span> <span class=main>∧</span> <span class=skolem>P</span> <span class=bound>x</span> <span class=main>∧</span> <span class=skolem>P</span> <span class=bound>y</span><span class=main>)</span><span class=main><span class=hidden>⇧</span><sup>+</sup><span class=hidden>⇧</span><sup>+</sup></span> <span class=bound>u</span> <span class=bound>v</span> <span class=main>∨</span> <span class=main>(</span><span class=main>∃</span><span class=bound>z</span><span class=main>.</span> <span class=main>¬</span> <span class=skolem>P</span> <span class=bound>z</span> <span class=main>∧</span> <span class=free>R'</span><span class=main><span class=hidden>⇧</span><sup>+</sup><span class=hidden>⇧</span><sup>+</sup></span> <span class=bound>u</span> <span class=bound>z</span> <span class=main>∧</span> <span class=free>R'</span><span class=main><span class=hidden>⇧</span><sup>+</sup><span class=hidden>⇧</span><sup>+</sup></span> <span class=bound>z</span> <span class=bound>v</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> TC_INDUCT<span class=main>[</span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> R<span class=main><span class=main>=</span></span><span class=quoted><span class=quoted>"<span class=free>R'</span>"</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>and</span></span></span>
          P<span class=main><span class=main>=</span></span><span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=main>(</span> <span class=main>(</span><span class=main>(</span><span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=free>R'</span> <span class=bound>x</span> <span class=bound>y</span> <span class=main>∧</span> <span class=skolem>P</span> <span class=bound>x</span> <span class=main>∧</span> <span class=skolem>P</span> <span class=bound>y</span><span class=main>)</span><span class=main><span class=hidden>⇧</span><sup>+</sup><span class=hidden>⇧</span><sup>+</sup></span> <span class=bound>x</span> <span class=bound>y</span><span class=main>)</span> <span class=main>∨</span> <span class=main>(</span><span class=main>∃</span><span class=bound>z</span><span class=main>.</span> <span class=main>¬</span><span class=skolem>P</span> <span class=bound>z</span> <span class=main>∧</span> <span class=free>R'</span><span class=main><span class=hidden>⇧</span><sup>+</sup><span class=hidden>⇧</span><sup>+</sup></span> <span class=bound>x</span> <span class=bound>z</span> <span class=main>∧</span> <span class=free>R'</span><span class=main><span class=hidden>⇧</span><sup>+</sup><span class=hidden>⇧</span><sup>+</sup></span> <span class=bound>z</span> <span class=bound>y</span><span class=main>)</span><span class=main>)</span>"</span></span><span class=main>]</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> 
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> TC_equiv_tranclp<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=RelUtils-REFL_TC_CONJ><span class=command>lemma</span></span> REFL_TC_CONJ<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>R</span> <span class=free>R'</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> <span class=main>⇒</span> <span class=tfree>'a</span> <span class=main>⇒</span> bool"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=free>P</span> <span class=free>x</span> <span class=free>y</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"reflexive <span class=free>R'</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=free>P</span> <span class=bound>x</span> <span class=main>∧</span> <span class=free>P</span> <span class=bound>y</span> <span class=main>⟶</span> <span class=main>(</span><span class=free>R'</span> <span class=bound>x</span> <span class=bound>y</span> <span class=main>⟶</span> <span class=free>R</span> <span class=bound>x</span> <span class=bound>y</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span><span class=main>(</span><span class=free>R</span><span class=main><span class=hidden>⇧</span><sup>+</sup><span class=hidden>⇧</span><sup>+</sup></span> <span class=free>x</span> <span class=free>y</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>¬</span><span class=main>(</span><span class=free>R'</span><span class=main><span class=hidden>⇧</span><sup>+</sup><span class=hidden>⇧</span><sup>+</sup></span> <span class=free>x</span> <span class=free>y</span><span class=main>)</span> <span class=main>∨</span> <span class=main>(</span><span class=main>∃</span><span class=bound>z</span><span class=main>.</span> <span class=main>¬</span><span class=free>P</span> <span class=bound>z</span> <span class=main>∧</span> <span class=main>(</span><span class=free>R'</span><span class=main>)</span><span class=main><span class=hidden>⇧</span><sup>+</sup><span class=hidden>⇧</span><sup>+</sup></span> <span class=free>x</span> <span class=bound>z</span> <span class=main>∧</span> <span class=main>(</span><span class=free>R'</span><span class=main>)</span><span class=main><span class=hidden>⇧</span><sup>+</sup><span class=hidden>⇧</span><sup>+</sup></span> <span class=bound>z</span> <span class=free>y</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=main>¬</span><span class=free>R'</span><span class=main><span class=hidden>⇧</span><sup>+</sup><span class=hidden>⇧</span><sup>+</sup></span> <span class=free>x</span> <span class=free>y</span>"</span></span><span class=main>)</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> False
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> assms 
      TC_IMP_NOT_TC_CONJ<span class=main>[</span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> P<span class=main><span class=main>=</span></span><span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=free>P</span> <span class=bound>x</span> <span class=main>∧</span> <span class=free>P</span> <span class=bound>y</span>"</span></span><span class=main>]</span>
      REFL_IMP_3_CONJ<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>R'</span></span><span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span> <span class=operator>blast</span>

<span class=comment1>― ‹NOTE 
  This is not a trivial translation: 'TC\_INDUCT' in relationScript.sml:314 differs significantly
from 'trancl\_induct' and 'trancl\_trans\_induct' in Transitive\_Closure:375, 391›</span>
<span class=keyword1 id=RelUtils-TC_CASES1_NEQ><span class=command>lemma</span></span> TC_CASES1_NEQ<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>R</span> <span class=free>x</span> <span class=free>z</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>R</span><span class=main><span class=hidden>⇧</span><sup>+</sup><span class=hidden>⇧</span><sup>+</sup></span> <span class=free>x</span> <span class=free>z</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=free>R</span> <span class=free>x</span> <span class=free>z</span> <span class=main>∨</span> <span class=main>(</span><span class=main>∃</span><span class=bound>y</span> <span class=main>::</span> <span class=tfree>'a</span><span class=main>.</span> <span class=main>¬</span><span class=main>(</span><span class=free>x</span> <span class=main>=</span> <span class=bound>y</span><span class=main>)</span> <span class=main>∧</span> <span class=main>¬</span><span class=main>(</span><span class=bound>y</span> <span class=main>=</span> <span class=free>z</span><span class=main>)</span> <span class=main>∧</span> <span class=free>R</span> <span class=free>x</span> <span class=bound>y</span> <span class=main>∧</span> <span class=free>R</span><span class=main><span class=hidden>⇧</span><sup>+</sup><span class=hidden>⇧</span><sup>+</sup></span> <span class=bound>y</span> <span class=free>z</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>u</span> <span class=skolem>v</span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=free>R</span> <span class=bound>x</span> <span class=bound>y</span> <span class=main>⟶</span> <span class=free>R</span> <span class=bound>x</span> <span class=bound>y</span> <span class=main>∨</span> <span class=main>(</span><span class=main>∃</span><span class=bound>ya</span><span class=main>.</span> <span class=bound>x</span> <span class=main>≠</span> <span class=bound>ya</span> <span class=main>∧</span> <span class=bound>ya</span> <span class=main>≠</span> <span class=bound>y</span> <span class=main>∧</span> <span class=free>R</span> <span class=bound>x</span> <span class=bound>ya</span> <span class=main>∧</span> <span class=free>R</span><span class=main><span class=hidden>⇧</span><sup>+</sup><span class=hidden>⇧</span><sup>+</sup></span> <span class=bound>ya</span> <span class=bound>y</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>meson</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>x</span> <span class=bound>y</span> <span class=bound>z</span><span class=main>.</span> 
      <span class=main>(</span><span class=free>R</span> <span class=bound>x</span> <span class=bound>y</span> <span class=main>∨</span> <span class=main>(</span><span class=main>∃</span><span class=bound>ya</span><span class=main>.</span> <span class=bound>x</span> <span class=main>≠</span> <span class=bound>ya</span> <span class=main>∧</span> <span class=bound>ya</span> <span class=main>≠</span> <span class=bound>y</span> <span class=main>∧</span> <span class=free>R</span> <span class=bound>x</span> <span class=bound>ya</span> <span class=main>∧</span> <span class=free>R</span><span class=main><span class=hidden>⇧</span><sup>+</sup><span class=hidden>⇧</span><sup>+</sup></span> <span class=bound>ya</span> <span class=bound>y</span><span class=main>)</span><span class=main>)</span> 
      <span class=main>∧</span> <span class=main>(</span><span class=free>R</span> <span class=bound>y</span> <span class=bound>z</span> <span class=main>∨</span> <span class=main>(</span><span class=main>∃</span><span class=bound>ya</span><span class=main>.</span> <span class=bound>y</span> <span class=main>≠</span> <span class=bound>ya</span> <span class=main>∧</span> <span class=bound>ya</span> <span class=main>≠</span> <span class=bound>z</span> <span class=main>∧</span> <span class=free>R</span> <span class=bound>y</span> <span class=bound>ya</span> <span class=main>∧</span> <span class=free>R</span><span class=main><span class=hidden>⇧</span><sup>+</sup><span class=hidden>⇧</span><sup>+</sup></span> <span class=bound>ya</span> <span class=bound>z</span><span class=main>)</span><span class=main>)</span> 
      <span class=main>⟶</span> <span class=free>R</span> <span class=bound>x</span> <span class=bound>z</span> <span class=main>∨</span> <span class=main>(</span><span class=main>∃</span><span class=bound>y</span><span class=main>.</span> <span class=bound>x</span> <span class=main>≠</span> <span class=bound>y</span> <span class=main>∧</span> <span class=bound>y</span> <span class=main>≠</span> <span class=bound>z</span> <span class=main>∧</span> <span class=free>R</span> <span class=bound>x</span> <span class=bound>y</span> <span class=main>∧</span> <span class=free>R</span><span class=main><span class=hidden>⇧</span><sup>+</sup><span class=hidden>⇧</span><sup>+</sup></span> <span class=bound>y</span> <span class=bound>z</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> tranclp.r_into_trancl tranclp_trans<span class=main>)</span>
    <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"TC <span class=free>R</span> <span class=skolem>u</span> <span class=skolem>v</span> <span class=main>⟶</span> <span class=free>R</span> <span class=skolem>u</span> <span class=skolem>v</span> <span class=main>∨</span> <span class=main>(</span><span class=main>∃</span><span class=bound>y</span><span class=main>.</span> <span class=skolem>u</span> <span class=main>≠</span> <span class=bound>y</span> <span class=main>∧</span> <span class=bound>y</span> <span class=main>≠</span> <span class=skolem>v</span> <span class=main>∧</span> <span class=free>R</span> <span class=skolem>u</span> <span class=bound>y</span> <span class=main>∧</span> <span class=free>R</span><span class=main><span class=hidden>⇧</span><sup>+</sup><span class=hidden>⇧</span><sup>+</sup></span> <span class=bound>y</span> <span class=skolem>v</span><span class=main>)</span>"</span></span> 
      <span class=keyword1><span class=command>using</span></span> TC_INDUCT<span class=main>[</span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> P<span class=main><span class=main>=</span></span><span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>x</span> <span class=bound>z</span><span class=main>.</span> <span class=free>R</span> <span class=bound>x</span> <span class=bound>z</span> <span class=main>∨</span> <span class=main>(</span><span class=main>∃</span><span class=bound>y</span> <span class=main>::</span> <span class=tfree>'a</span><span class=main>.</span> <span class=main>¬</span><span class=main>(</span><span class=bound>x</span> <span class=main>=</span> <span class=bound>y</span><span class=main>)</span> <span class=main>∧</span> <span class=main>¬</span><span class=main>(</span><span class=bound>y</span> <span class=main>=</span> <span class=bound>z</span><span class=main>)</span> <span class=main>∧</span> <span class=free>R</span> <span class=bound>x</span> <span class=bound>y</span> <span class=main>∧</span> <span class=free>R</span><span class=main><span class=hidden>⇧</span><sup>+</sup><span class=hidden>⇧</span><sup>+</sup></span> <span class=bound>y</span> <span class=bound>z</span><span class=main>)</span>"</span></span><span class=main>]</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> 
    <span class=keyword1><span class=command>using</span></span> assms TC_equiv_tranclp
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> TC_equiv_tranclp<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span>
<span class=keyword2><span class=keyword>end</span></span></pre>
</div><div id=Dependency>
<div class=head>
<h1>Theory Dependency</h1>
</div>
<pre class=source><span class=keyword1><span class=command>theory</span></span> Dependency
  <span class=keyword2><span class=keyword>imports</span></span> <a href=https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html>Main</a> <span class=quoted>"<a href=https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Finite_Map.html>HOL-Library.Finite_Map</a>"</span> <a href=#FactoredSystem>FactoredSystem</a> <a href=#ActionSeqProcess>ActionSeqProcess</a> <a href=#RelUtils>RelUtils</a>
<span class=keyword2><span class=keyword>begin</span></span> 


<span class=keyword1><span class=command>section</span></span> <span class=quoted><span class=plain_text>‹Dependency›</span></span>

<span class=keyword1><span class=command>text</span></span> <span class=quoted><span class=plain_text>‹ State variable dependency analysis may be used to find structure in a factored system and 
find useful projections, for example on variable sets which are closed under mutual dependency. 
[Abdulaziz et al., p.13]

In the following the dependency predicate (`dep`) is formalized and some dependency related 
propositions are proven. Dependency between variables `v1`, `v2` w.r.t to an action set <span class=antiquoted><span class=antiquoted><span class=antiquote><span class=antiquote>@{</span></span><span class=operator><span class=operator>term</span></span> <span class=quoted><span class=quoted>"<span class=free><span class=free>δ</span></span>"</span></span><span class=antiquote><span class=antiquote>}</span></span></span></span> is given
if one of the following holds:
  (1) `v1` and `v2` are equal
  (2) an action <span class=antiquoted><span class=antiquoted><span class=antiquote><span class=antiquote>@{</span></span><span class=operator><span class=operator>term</span></span> <span class=quoted><span class=quoted>"<span class=main><span class=main>(</span></span><span class=free><span class=free>p</span></span><span class=main><span class=main>,</span></span> <span class=free><span class=free>e</span></span><span class=main><span class=main>)</span></span> <span class=main><span class=main>∈</span></span> <span class=free><span class=free>δ</span></span>"</span></span><span class=antiquote><span class=antiquote>}</span></span></span></span> exists where <span class=antiquoted><span class=antiquoted><span class=antiquote><span class=antiquote>@{</span></span><span class=operator><span class=operator>term</span></span> <span class=quoted><span class=quoted>"<span class=free><span class=free>v1</span></span> <span class=main><span class=main>∈</span></span> <span class=free><span class=free>𝒟</span></span><span class=main><span class=main>(</span></span><span class=free><span class=free>p</span></span><span class=main><span class=main>)</span></span>"</span></span><span class=antiquote><span class=antiquote>}</span></span></span></span> and <span class=antiquoted><span class=antiquoted><span class=antiquote><span class=antiquote>@{</span></span><span class=operator><span class=operator>term</span></span> <span class=quoted><span class=quoted>"<span class=free><span class=free>v2</span></span> <span class=main><span class=main>∈</span></span> <span class=free><span class=free>𝒟</span></span><span class=main><span class=main>(</span></span><span class=free><span class=free>e</span></span><span class=main><span class=main>)</span></span>"</span></span><span class=antiquote><span class=antiquote>}</span></span></span></span> (meaning that it is a
necessary condition that `p v1` is given if the action has effect `e v2`).
  (3) or, an action <span class=antiquoted><span class=antiquoted><span class=antiquote><span class=antiquote>@{</span></span><span class=operator><span class=operator>term</span></span> <span class=quoted><span class=quoted>"<span class=main><span class=main>(</span></span><span class=free><span class=free>p</span></span><span class=main><span class=main>,</span></span> <span class=free><span class=free>e</span></span><span class=main><span class=main>)</span></span> <span class=main><span class=main>∈</span></span> <span class=free><span class=free>δ</span></span>"</span></span><span class=antiquote><span class=antiquote>}</span></span></span></span> exists s.t. <span class=antiquoted><span class=antiquoted><span class=antiquote><span class=antiquote>@{</span></span><span class=operator><span class=operator>term</span></span> <span class=quoted><span class=quoted>"<span class=free><span class=free>v1</span></span> <span class=free><span class=free>v2</span></span> <span class=main><span class=main>∈</span></span> <span class=free><span class=free>𝒟</span></span><span class=main><span class=main>(</span></span><span class=free><span class=free>e</span></span><span class=main><span class=main>)</span></span>"</span></span><span class=antiquote><span class=antiquote>}</span></span></span></span>
This notion is extended to sets of variables `vs1`, `vs2` (`dep\_var\_set`): `vs1` and `vs2` are 
dependent iff `vs1` and `vs2` are disjoint and if dependent `v1`, `v2` exist where <span class=antiquoted><span class=antiquoted><span class=antiquote><span class=antiquote>@{</span></span><span class=operator><span class=operator>term</span></span> <span class=quoted><span class=quoted>"<span class=free><span class=free>v1</span></span> <span class=main><span class=main>∈</span></span> <span class=free><span class=free>vs1</span></span>"</span></span><span class=antiquote><span class=antiquote>}</span></span></span></span>, 
<span class=antiquoted><span class=antiquoted><span class=antiquote><span class=antiquote>@{</span></span><span class=operator><span class=operator>term</span></span> <span class=quoted><span class=quoted>"<span class=free><span class=free>v2</span></span> <span class=main><span class=main>∈</span></span> <span class=free><span class=free>vs2</span></span>"</span></span><span class=antiquote><span class=antiquote>}</span></span></span></span>. [Abdulaziz et al., Definition 7, p.13][Abdulaziz et al., HOL4 Definition 5, p.14] ›</span></span>


<span class=keyword1><span class=command>subsection</span></span> <span class=quoted><span class=plain_text>‹Dependent Variables and Variable Sets›</span></span>

<span class=comment1>― ‹NOTE name shortened to 'dep'.›</span>
<span class=keyword1><span class=command>definition</span></span> <span class=entity>dep</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>dep</span> <span class=free><span class=bound><span class=entity>PROB</span></span></span> <span class=free><span class=bound><span class=entity>v1</span></span></span> <span class=free><span class=bound><span class=entity>v2</span></span></span> <span class=main>≡</span> <span class=main>(</span><span class=main>∃</span><span class=bound>a</span><span class=main>.</span> 
    <span class=bound>a</span> <span class=main>∈</span> <span class=free><span class=bound><span class=entity>PROB</span></span></span> 
    <span class=main>∧</span> <span class=main>(</span>
      <span class=main>(</span><span class=main>(</span><span class=free><span class=bound><span class=entity>v1</span></span></span> <span class=main>∈</span> fmdom' <span class=main>(</span>fst <span class=bound>a</span><span class=main>)</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>v2</span></span></span> <span class=main>∈</span> fmdom' <span class=main>(</span>snd <span class=bound>a</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> 
      <span class=main>∨</span> <span class=main>(</span><span class=main>(</span><span class=free><span class=bound><span class=entity>v1</span></span></span> <span class=main>∈</span> fmdom' <span class=main>(</span>snd <span class=bound>a</span><span class=main>)</span> <span class=main>∧</span> <span class=free><span class=bound><span class=entity>v2</span></span></span> <span class=main>∈</span> fmdom' <span class=main>(</span>snd <span class=bound>a</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>
    <span class=main>)</span>
  <span class=main>)</span> 
    <span class=main>∨</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>v1</span></span></span> <span class=main>=</span> <span class=free><span class=bound><span class=entity>v2</span></span></span><span class=main>)</span>"</span></span>

<span class=comment1>― ‹NOTE name shortened to 'dep\_var\_set'.›</span>
<span class=keyword1><span class=command>definition</span></span> <span class=entity>dep_var_set</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>dep_var_set</span> <span class=free><span class=bound><span class=entity>PROB</span></span></span> <span class=free><span class=bound><span class=entity>vs1</span></span></span> <span class=free><span class=bound><span class=entity>vs2</span></span></span> <span class=main>≡</span> <span class=main>(</span>disjnt <span class=free><span class=bound><span class=entity>vs1</span></span></span> <span class=free><span class=bound><span class=entity>vs2</span></span></span><span class=main>)</span> <span class=main>∧</span> 
                              <span class=main>(</span><span class=main>∃</span> <span class=bound>v1</span> <span class=bound>v2</span><span class=main>.</span> <span class=main>(</span><span class=bound>v1</span> <span class=main>∈</span> <span class=free><span class=bound><span class=entity>vs1</span></span></span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=bound>v2</span> <span class=main>∈</span> <span class=free><span class=bound><span class=entity>vs2</span></span></span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span>dep <span class=free><span class=bound><span class=entity>PROB</span></span></span> <span class=bound>v1</span> <span class=bound>v2</span><span class=main>)</span>
  <span class=main>)</span>"</span></span>


<span class=keyword1 id=Dependency-dep_var_set_self_empty><span class=command>lemma</span></span>  dep_var_set_self_empty<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=free>vs</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"dep_var_set <span class=free>PROB</span> <span class=free>vs</span> <span class=free>vs</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>vs</span> <span class=main>=</span> <span class=main>{}</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>unfolding</span></span> dep_var_set_def
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>v1</span></span> <span class=skolem><span class=skolem>v2</span></span> <span class=keyword2><span class=keyword>where</span></span>
    <span class=quoted><span class=quoted>"<span class=skolem>v1</span> <span class=main>∈</span> <span class=free>vs</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v2</span> <span class=main>∈</span> <span class=free>vs</span>"</span></span> <span class=quoted><span class=quoted>"disjnt <span class=free>vs</span> <span class=free>vs</span>"</span></span> <span class=quoted><span class=quoted>"dep <span class=free>PROB</span> <span class=skolem>v1</span> <span class=skolem>v2</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> assms 
    <span class=keyword1><span class=command>unfolding</span></span> dep_var_set_def
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1 id=Dependency-DEP_REFL><span class=command>lemma</span></span> DEP_REFL<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> 
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"reflexive <span class=main>(</span><span class=main>λ</span><span class=bound>v</span> <span class=bound>v'</span><span class=main>.</span> dep <span class=free>PROB</span> <span class=bound>v</span> <span class=bound>v'</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> dep_def reflexive_def
  <span class=keyword1><span class=command>by</span></span> <span class=operator>presburger</span>


<span class=comment1>― ‹NOTE added lemma.›</span> 
<span class=keyword1 id=Dependency-NEQ_DEP_IMP_IN_DOM_i><span class=command>lemma</span></span> NEQ_DEP_IMP_IN_DOM_i<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>a</span> <span class=free>v</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>a</span> <span class=main>∈</span> <span class=free>PROB</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>v</span> <span class=main>∈</span> fmdom' <span class=main>(</span>fst <span class=free>a</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=free>v</span> <span class=main>∈</span> prob_dom <span class=free>PROB</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>v</span> <span class=main>∈</span> fmdom' <span class=main>(</span>fst <span class=free>a</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>2<span class=main>)</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>fst <span class=free>a</span><span class=main>)</span> <span class=main>⊆</span> prob_dom <span class=free>PROB</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>)</span>
    <span class=keyword1><span class=command>unfolding</span></span> prob_dom_def action_dom_def
    <span class=keyword1><span class=command>using</span></span> case_prod_beta' 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=comment1>― ‹NOTE added lemma.›</span> 
<span class=keyword1 id=Dependency-NEQ_DEP_IMP_IN_DOM_ii><span class=command>lemma</span></span> NEQ_DEP_IMP_IN_DOM_ii<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>a</span> <span class=free>v</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>a</span> <span class=main>∈</span> <span class=free>PROB</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>v</span> <span class=main>∈</span> fmdom' <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=free>v</span> <span class=main>∈</span> prob_dom <span class=free>PROB</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>v</span> <span class=main>∈</span> fmdom' <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>2<span class=main>)</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span> <span class=main>⊆</span> prob_dom <span class=free>PROB</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>)</span>
    <span class=keyword1><span class=command>unfolding</span></span> prob_dom_def action_dom_def
    <span class=keyword1><span class=command>using</span></span> case_prod_beta' 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=Dependency-NEQ_DEP_IMP_IN_DOM><span class=command>lemma</span></span> NEQ_DEP_IMP_IN_DOM<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>(</span><span class=tfree>'a</span><span class=main>,</span> <span class=tfree>'b</span><span class=main>)</span> fmap <span class=main>×</span> <span class=main>(</span><span class=tfree>'a</span><span class=main>,</span> <span class=tfree>'b</span><span class=main>)</span> fmap<span class=main>)</span> set"</span></span> <span class=keyword2><span class=keyword>and</span></span>  <span class=free>v</span> <span class=free>v'</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span><span class=main>(</span><span class=free>v</span> <span class=main>=</span> <span class=free>v'</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>dep <span class=free>PROB</span> <span class=free>v</span> <span class=free>v'</span><span class=main>)</span>"</span></span> 
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>v</span> <span class=main>∈</span> <span class=main>(</span>prob_dom <span class=free>PROB</span><span class=main>)</span> <span class=main>∧</span> <span class=free>v'</span> <span class=main>∈</span> <span class=main>(</span>prob_dom <span class=free>PROB</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms 
  <span class=keyword1><span class=command>unfolding</span></span> dep_def 
  <span class=keyword1><span class=command>using</span></span> FDOM_pre_subset_prob_dom_pair FDOM_eff_subset_prob_dom_pair
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>a</span></span> <span class=keyword2><span class=keyword>where</span></span> 1<span class=main>:</span>
    <span class=quoted><span class=quoted>"<span class=skolem>a</span> <span class=main>∈</span> <span class=free>PROB</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>v</span> <span class=main>∈</span> fmdom' <span class=main>(</span>fst <span class=skolem>a</span><span class=main>)</span> <span class=main>∧</span> <span class=free>v'</span> <span class=main>∈</span> fmdom' <span class=main>(</span>snd <span class=skolem>a</span><span class=main>)</span> <span class=main>∨</span> <span class=free>v</span> <span class=main>∈</span> fmdom' <span class=main>(</span>snd <span class=skolem>a</span><span class=main>)</span> <span class=main>∧</span> <span class=free>v'</span> <span class=main>∈</span> fmdom' <span class=main>(</span>snd <span class=skolem>a</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms
    <span class=keyword1><span class=command>unfolding</span></span> dep_def
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>consider</span></span> 
    <span class=main>(</span>i<span class=main>)</span> <span class=quoted><span class=quoted>"<span class=free>v</span> <span class=main>∈</span> fmdom' <span class=main>(</span>fst <span class=skolem>a</span><span class=main>)</span> <span class=main>∧</span> <span class=free>v'</span> <span class=main>∈</span> fmdom' <span class=main>(</span>snd <span class=skolem>a</span><span class=main>)</span>"</span></span>
    <span class=main>|</span> <span class=main>(</span>ii<span class=main>)</span> <span class=quoted><span class=quoted>"<span class=free>v</span> <span class=main>∈</span> fmdom' <span class=main>(</span>snd <span class=skolem>a</span><span class=main>)</span> <span class=main>∧</span> <span class=free>v'</span> <span class=main>∈</span> fmdom' <span class=main>(</span>snd <span class=skolem>a</span><span class=main>)</span>"</span></span> 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> 
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> i
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>v</span> <span class=main>∈</span> fmdom' <span class=main>(</span>fst <span class=skolem>a</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>v'</span> <span class=main>∈</span> fmdom' <span class=main>(</span>snd <span class=skolem>a</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span><span class=main><span class=keyword3>+</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>v</span> <span class=main>∈</span> prob_dom <span class=free>PROB</span>"</span></span>  <span class=quoted><span class=quoted>"<span class=free>v'</span> <span class=main>∈</span> prob_dom <span class=free>PROB</span>"</span></span> 
      <span class=keyword1><span class=command>using</span></span> 1 NEQ_DEP_IMP_IN_DOM_i NEQ_DEP_IMP_IN_DOM_ii
      <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span><span class=main><span class=keyword3>+</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> ii
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>v</span> <span class=main>∈</span> fmdom' <span class=main>(</span>snd <span class=skolem>a</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>v'</span> <span class=main>∈</span> fmdom' <span class=main>(</span>snd <span class=skolem>a</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span><span class=main><span class=keyword3>+</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>v</span> <span class=main>∈</span> prob_dom <span class=free>PROB</span>"</span></span>  <span class=quoted><span class=quoted>"<span class=free>v'</span> <span class=main>∈</span> prob_dom <span class=free>PROB</span>"</span></span> 
      <span class=keyword1><span class=command>using</span></span> 1 NEQ_DEP_IMP_IN_DOM_ii
      <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span><span class=main><span class=keyword3>+</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1 id=Dependency-dep_sos_imp_mem_dep><span class=command>lemma</span></span> dep_sos_imp_mem_dep<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=free>S</span> <span class=free>vs</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>dep_var_set <span class=free>PROB</span> <span class=main>(</span><span class=main>⋃</span> <span class=free>S</span><span class=main>)</span> <span class=free>vs</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>vs'</span><span class=main>.</span> <span class=bound>vs'</span> <span class=main>∈</span> <span class=free>S</span> <span class=main>∧</span> dep_var_set <span class=free>PROB</span> <span class=bound>vs'</span> <span class=free>vs</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>v1</span></span> <span class=skolem><span class=skolem>v2</span></span> <span class=keyword2><span class=keyword>where</span></span> obtain_v1_v2<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>v1</span> <span class=main>∈</span> <span class=main>⋃</span><span class=free>S</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v2</span> <span class=main>∈</span> <span class=free>vs</span>"</span></span> <span class=quoted><span class=quoted>"disjnt <span class=main>(</span><span class=main>⋃</span><span class=free>S</span><span class=main>)</span> <span class=free>vs</span>"</span></span> <span class=quoted><span class=quoted>"dep <span class=free>PROB</span> <span class=skolem>v1</span> <span class=skolem>v2</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms dep_var_set_def<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>PROB</span></span> <span class=quoted><span class=quoted>"<span class=main>⋃</span> <span class=free>S</span>"</span></span> <span class=quoted><span class=free>vs</span></span><span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>vs'</span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>vs'</span> <span class=main>∈</span> <span class=free>S</span>"</span></span> 
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>vs'</span> <span class=main>⊆</span> <span class=main>(</span><span class=main>⋃</span><span class=free>S</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> calculation Union_upper
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"disjnt <span class=skolem>vs'</span> <span class=free>vs</span>"</span></span> 
      <span class=keyword1><span class=command>using</span></span> obtain_v1_v2<span class=main>(</span>3<span class=main>)</span> disjnt_subset1
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> 
    <span class=keyword1><span class=command>unfolding</span></span> dep_var_set_def
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1 id=Dependency-dep_union_imp_or_dep><span class=command>lemma</span></span> dep_union_imp_or_dep<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=free>vs</span> <span class=free>vs'</span> <span class=free>vs''</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>dep_var_set <span class=free>PROB</span> <span class=free>vs</span> <span class=main>(</span><span class=free>vs'</span> <span class=main>∪</span> <span class=free>vs''</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>dep_var_set <span class=free>PROB</span> <span class=free>vs</span> <span class=free>vs'</span> <span class=main>∨</span> dep_var_set <span class=free>PROB</span> <span class=free>vs</span> <span class=free>vs''</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>v1</span></span> <span class=skolem><span class=skolem>v2</span></span> <span class=keyword2><span class=keyword>where</span></span> 
    obtain_v1_v2<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>v1</span> <span class=main>∈</span> <span class=free>vs</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v2</span> <span class=main>∈</span> <span class=free>vs'</span> <span class=main>∪</span> <span class=free>vs''</span>"</span></span> <span class=quoted><span class=quoted>"disjnt <span class=free>vs</span> <span class=main>(</span><span class=free>vs'</span> <span class=main>∪</span> <span class=free>vs''</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"dep <span class=free>PROB</span> <span class=skolem>v1</span> <span class=skolem>v2</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms dep_var_set_def<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>PROB</span></span> <span class=quoted><span class=free>vs</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>vs'</span> <span class=main>∪</span> <span class=free>vs''</span><span class=main>)</span>"</span></span><span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=comment1>― ‹NOTE The proofs for the cases introduced here yield the goal's left and right side 
    respectively.›</span>
  <span class=keyword1><span class=command>consider</span></span> <span class=main>(</span>i<span class=main>)</span> <span class=quoted><span class=quoted>"<span class=skolem>v2</span> <span class=main>∈</span> <span class=free>vs'</span>"</span></span> <span class=main>|</span> <span class=main>(</span>ii<span class=main>)</span> <span class=quoted><span class=quoted>"<span class=skolem>v2</span> <span class=main>∈</span> <span class=free>vs''</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> obtain_v1_v2<span class=main>(</span>2<span class=main>)</span> 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> 
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> i
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>vs'</span> <span class=main>⊆</span> <span class=free>vs'</span> <span class=main>∪</span> <span class=free>vs''</span>"</span></span> 
      <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"disjnt <span class=main>(</span><span class=free>vs'</span> <span class=main>∪</span> <span class=free>vs''</span><span class=main>)</span> <span class=free>vs</span>"</span></span> 
      <span class=keyword1><span class=command>using</span></span> obtain_v1_v2<span class=main>(</span>3<span class=main>)</span> disjnt_sym
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"disjnt <span class=free>vs</span> <span class=free>vs'</span>"</span></span> 
      <span class=keyword1><span class=command>using</span></span> disjnt_subset1 disjnt_sym
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"dep_var_set <span class=free>PROB</span> <span class=free>vs</span> <span class=free>vs'</span>"</span></span> 
      <span class=keyword1><span class=command>unfolding</span></span> dep_var_set_def 
      <span class=keyword1><span class=command>using</span></span> obtain_v1_v2<span class=main>(</span>1<span class=main>,</span> 4<span class=main>)</span> i
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> 
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> ii
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>vs''</span> <span class=main>⊆</span> <span class=free>vs'</span> <span class=main>∪</span> <span class=free>vs''</span>"</span></span> 
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"disjnt <span class=main>(</span><span class=free>vs'</span> <span class=main>∪</span> <span class=free>vs''</span><span class=main>)</span> <span class=free>vs</span>"</span></span> 
      <span class=keyword1><span class=command>using</span></span> obtain_v1_v2<span class=main>(</span>3<span class=main>)</span> disjnt_sym
      <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
    <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"disjnt <span class=free>vs</span> <span class=free>vs''</span>"</span></span> 
      <span class=keyword1><span class=command>using</span></span> disjnt_subset1 disjnt_sym
      <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"dep_var_set <span class=free>PROB</span> <span class=free>vs</span> <span class=free>vs''</span>"</span></span> 
      <span class=keyword1><span class=command>unfolding</span></span> dep_var_set_def 
      <span class=keyword1><span class=command>using</span></span> obtain_v1_v2<span class=main>(</span>1<span class=main>,</span> 4<span class=main>)</span> ii 
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> 
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>qed</span></span>


<span class=comment1>― ‹NOTE This is symmetrical to `dep\_sos\_imp\_mem\_dep` w.r.t to `vs` and <span class=antiquoted><span class=antiquote>@{</span><span class=operator>term</span> <span class=quoted>"<span class=main>⋃</span> <span class=free>S</span>"</span><span class=antiquote>}</span></span>.›</span>
<span class=keyword1 id=Dependency-dep_biunion_imp_or_dep><span class=command>lemma</span></span> dep_biunion_imp_or_dep<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=free>vs</span> <span class=free>S</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>dep_var_set <span class=free>PROB</span> <span class=free>vs</span> <span class=main>(</span><span class=main>⋃</span><span class=free>S</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>vs'</span><span class=main>.</span> <span class=bound>vs'</span> <span class=main>∈</span> <span class=free>S</span> <span class=main>∧</span> dep_var_set <span class=free>PROB</span> <span class=free>vs</span> <span class=bound>vs'</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>v1</span></span> <span class=skolem><span class=skolem>v2</span></span> <span class=keyword2><span class=keyword>where</span></span> obtain_v1_v2<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>v1</span> <span class=main>∈</span> <span class=free>vs</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v2</span> <span class=main>∈</span> <span class=main>(</span><span class=main>⋃</span><span class=free>S</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"disjnt <span class=free>vs</span> <span class=main>(</span><span class=main>⋃</span><span class=free>S</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"dep <span class=free>PROB</span> <span class=skolem>v1</span> <span class=skolem>v2</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms dep_var_set_def<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>PROB</span></span> <span class=quoted><span class=free>vs</span></span> <span class=quoted><span class=quoted>"<span class=main>⋃</span> <span class=free>S</span>"</span></span><span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>vs'</span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>vs'</span> <span class=main>∈</span> <span class=free>S</span>"</span></span> 
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>vs'</span> <span class=main>⊆</span> <span class=main>(</span><span class=main>⋃</span><span class=free>S</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> calculation Union_upper
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"disjnt <span class=main>(</span><span class=main>⋃</span><span class=free>S</span><span class=main>)</span> <span class=free>vs</span>"</span></span> 
      <span class=keyword1><span class=command>using</span></span> obtain_v1_v2<span class=main>(</span>3<span class=main>)</span> disjnt_sym
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"disjnt <span class=free>vs</span> <span class=skolem>vs'</span>"</span></span> 
      <span class=keyword1><span class=command>using</span></span> obtain_v1_v2<span class=main>(</span>3<span class=main>)</span> disjnt_subset1 disjnt_sym
      <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> 
    <span class=keyword1><span class=command>unfolding</span></span> dep_var_set_def
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1><span class=command>subsection</span></span> <span class=quoted><span class=plain_text>"Transitive Closure of Dependent Variables and Variable Sets"</span></span>


<span class=keyword1><span class=command>definition</span></span> <span class=entity>dep_tc</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>dep_tc</span> <span class=free><span class=bound><span class=entity>PROB</span></span></span> <span class=main>=</span> TC <span class=main>(</span><span class=main>λ</span><span class=bound>v1'</span> <span class=bound>v2'</span><span class=main>.</span> dep <span class=free><span class=bound><span class=entity>PROB</span></span></span> <span class=bound>v1'</span> <span class=bound>v2'</span><span class=main>)</span>"</span></span>


<span class=comment1>― ‹NOTE type of `PROB` had to be fixed for MP on `NEQ\_DEP\_IMP\_IN\_DOM`.›</span>
<span class=keyword1 id=Dependency-dep_tc_imp_in_dom><span class=command>lemma</span></span> dep_tc_imp_in_dom<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>(</span><span class=tfree>'a</span><span class=main>,</span> <span class=tfree>'b</span><span class=main>)</span> fmap <span class=main>×</span> <span class=main>(</span><span class=tfree>'a</span><span class=main>,</span> <span class=tfree>'b</span><span class=main>)</span> fmap<span class=main>)</span> set"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=free>v1</span> <span class=free>v2</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span><span class=main>(</span><span class=free>v1</span> <span class=main>=</span> <span class=free>v2</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>dep_tc <span class=free>PROB</span> <span class=free>v1</span> <span class=free>v2</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>v1</span> <span class=main>∈</span> prob_dom <span class=free>PROB</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"TC <span class=main>(</span>dep <span class=free>PROB</span><span class=main>)</span> <span class=free>v1</span> <span class=free>v2</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>2<span class=main>)</span> 
    <span class=keyword1><span class=command>unfolding</span></span> dep_tc_def
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"dep <span class=free>PROB</span> <span class=free>v1</span> <span class=free>v2</span> <span class=main>∨</span> <span class=main>(</span><span class=main>∃</span><span class=bound>y</span><span class=main>.</span> <span class=free>v1</span> <span class=main>≠</span> <span class=bound>y</span> <span class=main>∧</span> <span class=bound>y</span> <span class=main>≠</span> <span class=free>v2</span> <span class=main>∧</span> dep <span class=free>PROB</span> <span class=free>v1</span> <span class=bound>y</span> <span class=main>∧</span> TC <span class=main>(</span>dep <span class=free>PROB</span><span class=main>)</span> <span class=bound>y</span> <span class=free>v2</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> TC_CASES1_NEQ<span class=main>[</span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> R <span class=main><span class=main>=</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>λ</span><span class=bound>v1'</span> <span class=bound>v2'</span><span class=main>.</span> dep <span class=free>PROB</span> <span class=bound>v1'</span> <span class=bound>v2'</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>and</span></span></span> x <span class=main><span class=main>=</span></span> <span class=quoted><span class=free>v1</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>and</span></span></span> z <span class=main><span class=main>=</span></span> <span class=quoted><span class=free>v2</span></span><span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> TC_equiv_tranclp<span class=main>)</span>
      <span class=comment1>― ‹NOTE Split on the disjunction yielded by the previous step.›</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>consider</span></span> 
    <span class=main>(</span>i<span class=main>)</span> <span class=quoted><span class=quoted>"dep <span class=free>PROB</span> <span class=free>v1</span> <span class=free>v2</span>"</span></span> 
    <span class=main>|</span> <span class=main>(</span>ii<span class=main>)</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>y</span><span class=main>.</span> <span class=free>v1</span> <span class=main>≠</span> <span class=bound>y</span> <span class=main>∧</span> <span class=bound>y</span> <span class=main>≠</span> <span class=free>v2</span> <span class=main>∧</span> dep <span class=free>PROB</span> <span class=free>v1</span> <span class=bound>y</span> <span class=main>∧</span> TC <span class=main>(</span>dep <span class=free>PROB</span><span class=main>)</span> <span class=bound>y</span> <span class=free>v2</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span> 
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> 
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> i
    <span class=keyword1><span class=command>{</span></span>
      <span class=keyword1><span class=command>consider</span></span> 
        <span class=main>(</span>II<span class=main>)</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>a</span><span class=main>.</span> 
            <span class=bound>a</span> <span class=main>∈</span> <span class=free>PROB</span> <span class=main>∧</span>
            <span class=main>(</span>
              <span class=free>v1</span> <span class=main>∈</span> fmdom' <span class=main>(</span>fst <span class=bound>a</span><span class=main>)</span> <span class=main>∧</span> <span class=free>v2</span> <span class=main>∈</span> fmdom' <span class=main>(</span>snd <span class=bound>a</span><span class=main>)</span> 
              <span class=main>∨</span> <span class=free>v1</span> <span class=main>∈</span> fmdom' <span class=main>(</span>snd <span class=bound>a</span><span class=main>)</span> <span class=main>∧</span> <span class=free>v2</span> <span class=main>∈</span> fmdom' <span class=main>(</span>snd <span class=bound>a</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
        <span class=main>|</span> <span class=main>(</span>III<span class=main>)</span> <span class=quoted><span class=quoted>"<span class=free>v1</span> <span class=main>=</span> <span class=free>v2</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> i 
        <span class=keyword1><span class=command>unfolding</span></span> dep_def 
        <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> 
      <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span><span class=main>)</span>
        <span class=keyword3><span class=command>case</span></span> II
        <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>a</span></span> <span class=keyword2><span class=keyword>where</span></span> 1<span class=main>:</span>
          <span class=quoted><span class=quoted>"<span class=skolem>a</span> <span class=main>∈</span> <span class=free>PROB</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>v1</span> <span class=main>∈</span> fmdom' <span class=main>(</span>fst <span class=skolem>a</span><span class=main>)</span> <span class=main>∧</span> <span class=free>v2</span> <span class=main>∈</span> fmdom' <span class=main>(</span>snd <span class=skolem>a</span><span class=main>)</span> 
              <span class=main>∨</span> <span class=free>v1</span> <span class=main>∈</span> fmdom' <span class=main>(</span>snd <span class=skolem>a</span><span class=main>)</span> <span class=main>∧</span> <span class=free>v2</span> <span class=main>∈</span> fmdom' <span class=main>(</span>snd <span class=skolem>a</span><span class=main>)</span><span class=main>)</span>"</span></span>
          <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>v1</span> <span class=main>∈</span> fmdom' <span class=main>(</span>fst <span class=skolem>a</span><span class=main>)</span> <span class=main>∪</span> fmdom' <span class=main>(</span>snd <span class=skolem>a</span><span class=main>)</span>"</span></span> 
          <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span> 
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> 2<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>v1</span> <span class=main>∈</span> action_dom <span class=main>(</span>fst <span class=skolem>a</span><span class=main>)</span> <span class=main>(</span>snd <span class=skolem>a</span><span class=main>)</span>"</span></span> 
          <span class=keyword1><span class=command>unfolding</span></span> action_dom_def
          <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span> 
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"action_dom <span class=main>(</span>fst <span class=skolem>a</span><span class=main>)</span> <span class=main>(</span>snd <span class=skolem>a</span><span class=main>)</span> <span class=main>⊆</span> prob_dom <span class=free>PROB</span>"</span></span> 
          <span class=keyword1><span class=command>using</span></span> 1<span class=main>(</span>1<span class=main>)</span> exec_as_proj_valid_2
          <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>v1</span> <span class=main>∈</span> prob_dom <span class=free>PROB</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> 1 2
          <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
          <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
      <span class=keyword1><span class=command>next</span></span>
        <span class=keyword3><span class=command>case</span></span> III
        <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> 
          <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>)</span>
          <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span> 
      <span class=keyword1><span class=command>qed</span></span>
    <span class=keyword1><span class=command>}</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> ii
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>y</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=free>v1</span> <span class=main>≠</span> <span class=skolem>y</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>y</span> <span class=main>≠</span> <span class=free>v2</span>"</span></span> <span class=quoted><span class=quoted>"dep <span class=free>PROB</span> <span class=free>v1</span> <span class=skolem>y</span>"</span></span> <span class=quoted><span class=quoted>"TC <span class=main>(</span>dep <span class=free>PROB</span><span class=main>)</span> <span class=skolem>y</span> <span class=free>v2</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> ii
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> 
      <span class=keyword1><span class=command>using</span></span> NEQ_DEP_IMP_IN_DOM 
      <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1 id=Dependency-not_dep_disj_imp_not_dep><span class=command>lemma</span></span> not_dep_disj_imp_not_dep<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=free>vs_1</span> <span class=free>vs_2</span> <span class=free>vs_3</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>(</span><span class=free>vs_1</span> <span class=main>∩</span> <span class=free>vs_2</span><span class=main>)</span> <span class=main>=</span> <span class=main>{}</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>vs_3</span> <span class=main>⊆</span> <span class=free>vs_2</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span><span class=main>(</span>dep_var_set <span class=free>PROB</span> <span class=free>vs_1</span> <span class=free>vs_2</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span><span class=main>(</span>dep_var_set <span class=free>PROB</span> <span class=free>vs_1</span> <span class=free>vs_3</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms subset_eq
  <span class=keyword1><span class=command>unfolding</span></span> dep_var_set_def disjnt_def
  <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>


<span class=keyword1 id=Dependency-dep_slist_imp_mem_dep><span class=command>lemma</span></span> dep_slist_imp_mem_dep<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=free>vs</span> <span class=free>lvs</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>dep_var_set <span class=free>PROB</span> <span class=main>(</span><span class=main>⋃</span> <span class=main>(</span>set <span class=free>lvs</span><span class=main>)</span><span class=main>)</span> <span class=free>vs</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>vs'</span><span class=main>.</span> ListMem <span class=bound>vs'</span> <span class=free>lvs</span> <span class=main>∧</span> dep_var_set <span class=free>PROB</span> <span class=bound>vs'</span> <span class=free>vs</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>v1</span></span> <span class=skolem><span class=skolem>v2</span></span> <span class=keyword2><span class=keyword>where</span></span> 
    obtain_v1_v2<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>v1</span> <span class=main>∈</span> <span class=main>⋃</span><span class=main>(</span>set <span class=free>lvs</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v2</span> <span class=main>∈</span> <span class=free>vs</span>"</span></span> <span class=quoted><span class=quoted>"disjnt <span class=main>(</span><span class=main>⋃</span><span class=main>(</span>set <span class=free>lvs</span><span class=main>)</span><span class=main>)</span> <span class=free>vs</span>"</span></span> <span class=quoted><span class=quoted>"dep <span class=free>PROB</span> <span class=skolem>v1</span> <span class=skolem>v2</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> assms dep_var_set_def<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>PROB</span></span> <span class=quoted><span class=quoted>"<span class=main>⋃</span> <span class=main>(</span>set <span class=free>lvs</span><span class=main>)</span>"</span></span> <span class=quoted><span class=free>vs</span></span><span class=main>]</span> 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>vs'</span></span> <span class=keyword2><span class=keyword>where</span></span> obtain_vs'<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>vs'</span> <span class=main>∈</span> set <span class=free>lvs</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v1</span> <span class=main>∈</span> <span class=skolem>vs'</span>"</span></span> 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"ListMem <span class=skolem>vs'</span> <span class=free>lvs</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> ListMem_iff
    <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>{</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"disjnt <span class=skolem>vs'</span> <span class=free>vs</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> obtain_v1_v2<span class=main>(</span>3<span class=main>)</span> obtain_vs'<span class=main>(</span>1<span class=main>)</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"dep_var_set <span class=free>PROB</span> <span class=skolem>vs'</span> <span class=free>vs</span>"</span></span> 
      <span class=keyword1><span class=command>unfolding</span></span> dep_var_set_def 
      <span class=keyword1><span class=command>using</span></span> obtain_v1_v2<span class=main>(</span>1<span class=main>,</span> 2<span class=main>,</span> 4<span class=main>)</span> obtain_vs'<span class=main>(</span>2<span class=main>)</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1 id=Dependency-n_bigunion_le_sum_3><span class=command>lemma</span></span> n_bigunion_le_sum_3<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=free>vs</span> <span class=free>svs</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span> <span class=bound>vs'</span><span class=main>.</span> <span class=bound>vs'</span> <span class=main>∈</span> <span class=free>svs</span> <span class=main>⟶</span> <span class=main>¬</span><span class=main>(</span>dep_var_set <span class=free>PROB</span> <span class=bound>vs'</span> <span class=free>vs</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span><span class=main>(</span>dep_var_set <span class=free>PROB</span> <span class=main>(</span><span class=main>⋃</span><span class=free>svs</span><span class=main>)</span> <span class=free>vs</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>dep_var_set <span class=free>PROB</span> <span class=main>(</span><span class=main>⋃</span><span class=free>svs</span><span class=main>)</span> <span class=free>vs</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>v1</span></span> <span class=skolem><span class=skolem>v2</span></span> <span class=keyword2><span class=keyword>where</span></span> obtain_vs<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>v1</span> <span class=main>∈</span> <span class=main>⋃</span><span class=free>svs</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v2</span> <span class=main>∈</span> <span class=free>vs</span>"</span></span> <span class=quoted><span class=quoted>"disjnt <span class=main>(</span><span class=main>⋃</span><span class=free>svs</span><span class=main>)</span> <span class=free>vs</span>"</span></span> <span class=quoted><span class=quoted>"dep <span class=free>PROB</span> <span class=skolem>v1</span> <span class=skolem>v2</span>"</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> dep_var_set_def
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>vs'</span></span> <span class=keyword2><span class=keyword>where</span></span> obtain_vs'<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>v1</span> <span class=main>∈</span> <span class=skolem>vs'</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>vs'</span> <span class=main>∈</span> <span class=free>svs</span>"</span></span> 
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span> 
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> a<span class=main>:</span> <span class=quoted><span class=quoted>"disjnt <span class=skolem>vs'</span> <span class=free>vs</span>"</span></span> 
      <span class=keyword1><span class=command>using</span></span> obtain_vs<span class=main>(</span>3<span class=main>)</span> obtain_vs'<span class=main>(</span>2<span class=main>)</span> disjnt_subset1 
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>v1</span> <span class=bound>v2</span><span class=main>.</span> <span class=main>¬</span><span class=main>(</span><span class=bound>v1</span> <span class=main>∈</span> <span class=skolem>vs'</span><span class=main>)</span> <span class=main>∨</span> <span class=main>¬</span><span class=main>(</span><span class=bound>v2</span> <span class=main>∈</span> <span class=free>vs</span><span class=main>)</span> <span class=main>∨</span> <span class=main>¬</span>disjnt <span class=skolem>vs'</span> <span class=free>vs</span> <span class=main>∨</span> <span class=main>¬</span>dep <span class=free>PROB</span> <span class=bound>v1</span> <span class=bound>v2</span>"</span></span> 
      <span class=keyword1><span class=command>using</span></span> assms obtain_vs'<span class=main>(</span>2<span class=main>)</span> dep_var_set_def
      <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted>False</span>
      <span class=keyword1><span class=command>using</span></span> a obtain_vs'<span class=main>(</span>1<span class=main>)</span> obtain_vs<span class=main>(</span>2<span class=main>,</span> 4<span class=main>)</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1 id=Dependency-disj_not_dep_vset_union_imp_or><span class=command>lemma</span></span> disj_not_dep_vset_union_imp_or<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=free>a</span> <span class=free>vs</span> <span class=free>vs'</span> 
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>a</span> <span class=main>∈</span> <span class=free>PROB</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>disjnt <span class=free>vs</span> <span class=free>vs'</span><span class=main>)</span>"</span></span> 
    <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>¬</span><span class=main>(</span>dep_var_set <span class=free>PROB</span> <span class=free>vs'</span> <span class=free>vs</span><span class=main>)</span> <span class=main>∨</span> <span class=main>¬</span><span class=main>(</span>dep_var_set <span class=free>PROB</span> <span class=free>vs</span> <span class=free>vs'</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span>varset_action <span class=free>a</span> <span class=main>(</span><span class=free>vs</span> <span class=main>∪</span> <span class=free>vs'</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>varset_action <span class=free>a</span> <span class=free>vs</span> <span class=main>∨</span> varset_action <span class=free>a</span> <span class=free>vs'</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>unfolding</span></span> varset_action_def dep_var_set_def dep_def
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword3><span class=command>assume</span></span> a1<span class=main>:</span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span> <span class=main>⊆</span> <span class=free>vs</span> <span class=main>∪</span> <span class=free>vs'</span>"</span></span>
  <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"disjnt <span class=free>vs</span> <span class=free>vs'</span>"</span></span>
  <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>" <span class=main>¬</span> <span class=main>(</span>disjnt <span class=free>vs'</span> <span class=free>vs</span> <span class=main>∧</span>
        <span class=main>(</span><span class=main>∃</span><span class=bound>v1</span> <span class=bound>v2</span><span class=main>.</span> <span class=bound>v1</span> <span class=main>∈</span> <span class=free>vs'</span> <span class=main>∧</span> <span class=bound>v2</span> <span class=main>∈</span> <span class=free>vs</span> <span class=main>∧</span> <span class=main>(</span><span class=main>(</span><span class=main>∃</span><span class=bound>a</span><span class=main>.</span> <span class=bound>a</span> <span class=main>∈</span> <span class=free>PROB</span> <span class=main>∧</span> <span class=main>(</span><span class=bound>v1</span> <span class=main>∈</span> fmdom' <span class=main>(</span>fst <span class=bound>a</span><span class=main>)</span> <span class=main>∧</span> <span class=bound>v2</span> <span class=main>∈</span> fmdom' <span class=main>(</span>snd <span class=bound>a</span><span class=main>)</span> <span class=main>∨</span> <span class=bound>v1</span> <span class=main>∈</span> fmdom' <span class=main>(</span>snd <span class=bound>a</span><span class=main>)</span> <span class=main>∧</span> <span class=bound>v2</span> <span class=main>∈</span> fmdom' <span class=main>(</span>snd <span class=bound>a</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>∨</span> <span class=bound>v1</span> <span class=main>=</span> <span class=bound>v2</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>∨</span>
       <span class=main>¬</span> <span class=main>(</span>disjnt <span class=free>vs</span> <span class=free>vs'</span> <span class=main>∧</span>
        <span class=main>(</span><span class=main>∃</span><span class=bound>v1</span> <span class=bound>v2</span><span class=main>.</span> <span class=bound>v1</span> <span class=main>∈</span> <span class=free>vs</span> <span class=main>∧</span> <span class=bound>v2</span> <span class=main>∈</span> <span class=free>vs'</span> <span class=main>∧</span> <span class=main>(</span><span class=main>(</span><span class=main>∃</span><span class=bound>a</span><span class=main>.</span> <span class=bound>a</span> <span class=main>∈</span> <span class=free>PROB</span> <span class=main>∧</span> <span class=main>(</span><span class=bound>v1</span> <span class=main>∈</span> fmdom' <span class=main>(</span>fst <span class=bound>a</span><span class=main>)</span> <span class=main>∧</span> <span class=bound>v2</span> <span class=main>∈</span> fmdom' <span class=main>(</span>snd <span class=bound>a</span><span class=main>)</span> <span class=main>∨</span> <span class=bound>v1</span> <span class=main>∈</span> fmdom' <span class=main>(</span>snd <span class=bound>a</span><span class=main>)</span> <span class=main>∧</span> <span class=bound>v2</span> <span class=main>∈</span> fmdom' <span class=main>(</span>snd <span class=bound>a</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>∨</span> <span class=bound>v1</span> <span class=main>=</span> <span class=bound>v2</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> "</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> f2<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>aa</span> <span class=bound>ab</span><span class=main>.</span> <span class=bound>aa</span> <span class=main>∉</span> <span class=free>vs</span> <span class=main>∨</span> <span class=bound>ab</span> <span class=main>∉</span> <span class=free>vs'</span> <span class=main>∨</span> <span class=bound>aa</span> <span class=main>∉</span> fmdom' <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span> <span class=main>∨</span> <span class=bound>ab</span> <span class=main>∉</span> fmdom' <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> <span class=quoted><span class=quoted>‹<span class=free>a</span> <span class=main>∈</span> <span class=free>PROB</span>›</span></span> <span class=quoted><span class=quoted>‹disjnt <span class=free>vs</span> <span class=free>vs'</span>›</span></span> disjnt_sym <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>aa</span></span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> set <span class=main>⇒</span> <span class=tfree>'a</span> set <span class=main>⇒</span> <span class=tfree>'a</span>"</span></span> <span class=keyword2><span class=keyword>where</span></span>
    f3<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>A</span> <span class=bound>Aa</span> <span class=bound>a</span> <span class=bound>Ab</span> <span class=bound>Ac</span><span class=main>.</span> <span class=main>(</span><span class=bound>A</span> <span class=main>⊆</span> <span class=bound>Aa</span> <span class=main>∨</span> <span class=skolem>aa</span> <span class=bound>A</span> <span class=bound>Aa</span> <span class=main>∈</span> <span class=bound>A</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=skolem>aa</span> <span class=bound>A</span> <span class=bound>Aa</span> <span class=main>∉</span> <span class=bound>Aa</span> <span class=main>∨</span> <span class=bound>A</span> <span class=main>⊆</span> <span class=bound>Aa</span><span class=main>)</span> 
      <span class=main>∧</span> <span class=main>(</span><span class=main>(</span><span class=bound>a</span><span class=main>::</span><span class=tfree>'a</span><span class=main>)</span> <span class=main>∉</span> <span class=bound>Ab</span> <span class=main>∨</span> <span class=main>¬</span> <span class=bound>Ab</span> <span class=main>⊆</span> <span class=bound>Ac</span> <span class=main>∨</span> <span class=bound>a</span> <span class=main>∈</span> <span class=bound>Ac</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>moura</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>A</span><span class=main>.</span> fmdom' <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span> <span class=main>⊆</span> <span class=bound>A</span> <span class=main>∨</span> <span class=skolem>aa</span> <span class=main>(</span>fmdom' <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span><span class=main>)</span> <span class=bound>A</span> <span class=main>∈</span> <span class=free>vs</span> <span class=main>∨</span> <span class=skolem>aa</span> <span class=main>(</span>fmdom' <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span><span class=main>)</span> <span class=bound>A</span> <span class=main>∈</span> <span class=free>vs'</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> a1 <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>meson</span> Un_iff<span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span> <span class=main>⊆</span> <span class=free>vs</span> <span class=main>∨</span> fmdom' <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span> <span class=main>⊆</span> <span class=free>vs'</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> f3 f2 <span class=keyword1><span class=command>by</span></span> <span class=operator>meson</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword2><span class=keyword>end</span></span></pre>
</div><div id=Invariants>
<div class=head>
<h1>Theory Invariants</h1>
</div>
<pre class=source><span class=keyword1><span class=command>theory</span></span> Invariants
  <span class=keyword2><span class=keyword>imports</span></span> <a href=https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html>Main</a> <span class=quoted>"<a href=#FactoredSystem>FactoredSystem</a>"</span>
<span class=keyword2><span class=keyword>begin</span></span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>fdom</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=tfree>'a</span> <span class=main>⇒</span> <span class=tfree>'b</span><span class=main>)</span> <span class=main>⇒</span> <span class=tfree>'a</span> set"</span></span> <span class=keyword2><span class=keyword>where</span></span> 
  <span class=quoted><span class=quoted>"<span class=free>fdom</span> <span class=free><span class=bound><span class=entity>f</span></span></span> <span class=main>≡</span> <span class=main>{</span><span class=bound>x</span><span class=main>.</span> <span class=main>∃</span><span class=bound>y</span><span class=main>.</span> <span class=free><span class=bound><span class=entity>f</span></span></span> <span class=bound>x</span> <span class=main>=</span> <span class=bound>y</span><span class=main>}</span>"</span></span>

<span class=comment1>― ‹TODO function domain for total function in Isabelle/HOL?›</span>
<span class=comment1>― ‹TODO why is fm total? Shouldn't it be partial and thus needing the the premise `fm x = Some True` instead of just `fm x`?›</span>
<span class=keyword1><span class=command>definition</span></span> <span class=entity>invariant</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=tfree>'a</span> <span class=main>⇒</span> bool<span class=main>)</span> <span class=main>⇒</span> bool"</span></span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>invariant</span> <span class=free><span class=bound><span class=entity>fm</span></span></span> <span class=main>≡</span> <span class=main>(</span><span class=main>∀</span><span class=bound>x</span><span class=main>.</span> <span class=main>(</span><span class=bound>x</span> <span class=main>∈</span> fdom <span class=free><span class=bound><span class=entity>fm</span></span></span> <span class=main>∧</span> <span class=free><span class=bound><span class=entity>fm</span></span></span> <span class=bound>x</span><span class=main>)</span> <span class=main>⟶</span> False<span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=main>∃</span><span class=bound>x</span><span class=main>.</span> <span class=bound>x</span> <span class=main>∈</span> fdom <span class=free><span class=bound><span class=entity>fm</span></span></span> <span class=main>∧</span> <span class=free><span class=bound><span class=entity>fm</span></span></span> <span class=bound>x</span><span class=main>)</span>"</span></span>

<span class=keyword2><span class=keyword>end</span></span></pre>
</div><div id=SetUtils>
<div class=head>
<h1>Theory SetUtils</h1>
</div>
<pre class=source><span class=keyword1><span class=command>theory</span></span> SetUtils
  <span class=keyword2><span class=keyword>imports</span></span> <a href=https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html>Main</a>
<span class=keyword2><span class=keyword>begin</span></span>

<span class=comment1>― ‹TODO use Inf instead of Min where necessary.›</span>

<span class=comment1>― ‹TODO can be replaced by <span class=antiquoted><span class=antiquote>@{</span><span class=operator>term</span> <span class=quoted>"<span class=free>card_Un_disjoint</span> <span class=main>(</span><span class=main>⟦</span>finite <span class=free>A</span><span class=main>;</span> finite <span class=free>B</span><span class=main>;</span> <span class=free>A</span> <span class=main>∩</span> <span class=free>B</span> <span class=main>=</span> <span class=main>{}</span><span class=main>⟧</span> 
  <span class=main>⟹</span> card <span class=main>(</span><span class=free>A</span> <span class=main>∪</span> <span class=free>B</span><span class=main>)</span> <span class=main>=</span> card <span class=free>A</span> <span class=main>+</span> card <span class=free>B</span><span class=main>)</span>"</span><span class=antiquote>}</span></span> ?›</span>
<span class=keyword1 id="SetUtils-card_union'"><span class=command>lemma</span></span> card_union'<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span>finite <span class=free>s</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span>finite <span class=free>t</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span>disjnt <span class=free>s</span> <span class=free>t</span><span class=main>)</span> <span class=main>⟹</span> <span class=main>(</span>card <span class=main>(</span><span class=free>s</span> <span class=main>∪</span> <span class=free>t</span><span class=main>)</span> <span class=main>=</span> card <span class=free>s</span> <span class=main>+</span> card <span class=free>t</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> card_Un_disjoint disjnt_def<span class=main>)</span>

<span class=keyword1 id=SetUtils-CARD_INJ_IMAGE_2><span class=command>lemma</span></span> CARD_INJ_IMAGE_2<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>f</span> <span class=free>s</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"finite <span class=free>s</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=main>(</span><span class=main>(</span><span class=bound>x</span> <span class=main>∈</span> <span class=free>s</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=bound>y</span> <span class=main>∈</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span> <span class=main>⟶</span> <span class=main>(</span><span class=main>(</span><span class=free>f</span> <span class=bound>x</span> <span class=main>=</span> <span class=free>f</span> <span class=bound>y</span><span class=main>)</span> <span class=main>⟷</span> <span class=main>(</span><span class=bound>x</span> <span class=main>=</span> <span class=bound>y</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>card <span class=main>(</span><span class=free>f</span> <span class=main>`</span> <span class=free>s</span><span class=main>)</span> <span class=main>=</span> card <span class=free>s</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>x</span> <span class=skolem>y</span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> <span class=free>s</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>y</span> <span class=main>∈</span> <span class=free>s</span>"</span></span> 
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>f</span> <span class=skolem>x</span> <span class=main>=</span> <span class=free>f</span> <span class=skolem>y</span> <span class=main>⟶</span> <span class=skolem>x</span> <span class=main>=</span> <span class=skolem>y</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>2<span class=main>)</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"inj_on <span class=free>f</span> <span class=free>s</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> inj_onI<span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>)</span> inj_on_iff_eq_card
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=SetUtils-scc_main_lemma_x><span class=command>lemma</span></span> scc_main_lemma_x<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>s</span> <span class=bound>t</span> <span class=bound>x</span><span class=main>.</span> <span class=main>(</span><span class=bound>x</span> <span class=main>∈</span> <span class=bound>s</span><span class=main>)</span> <span class=main>∧</span> <span class=main>¬</span><span class=main>(</span><span class=bound>x</span> <span class=main>∈</span> <span class=bound>t</span><span class=main>)</span> <span class=main>⟹</span> <span class=main>¬</span><span class=main>(</span><span class=bound>s</span> <span class=main>=</span> <span class=bound>t</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>

<span class=keyword1 id=SetUtils-neq_funs_neq_images><span class=command>lemma</span></span> neq_funs_neq_images<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>s</span> 
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>x</span><span class=main>.</span> <span class=bound>x</span> <span class=main>∈</span> <span class=free>s</span> <span class=main>⟶</span> <span class=main>(</span><span class=main>∀</span><span class=bound>y</span><span class=main>.</span> <span class=bound>y</span> <span class=main>∈</span> <span class=free>s</span> <span class=main>⟶</span> <span class=free>f1</span> <span class=bound>x</span> <span class=main>≠</span> <span class=free>f2</span> <span class=bound>y</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>x</span><span class=main>.</span> <span class=bound>x</span> <span class=main>∈</span> <span class=free>s</span>"</span></span> 
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=free>f1</span> <span class=main>`</span> <span class=free>s</span> <span class=main>≠</span> <span class=free>f2</span> <span class=main>`</span> <span class=free>s</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms 
  <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span> 

<span class=keyword1><span class=command>subsection</span></span> <span class=quoted><span class=plain_text>"Sets of Numbers"</span></span>

<span class=comment1>― ‹TODO 
  Is '&lt;=' natural number lte or overloaded? 
  If it's overloaded for reals, this might be wrong (e.g. the real set s = [0; 1] is not finite even 
though <span class=antiquoted><span class=antiquote>@{</span><span class=operator>term</span> <span class=quoted>"<span class=main>∀</span> <span class=bound>x</span> <span class=main>∈</span> <span class=free>s</span><span class=main>.</span> <span class=bound>x</span> <span class=main>≤</span> <span class=main>1</span>"</span><span class=antiquote>}</span></span> holds).›</span>
<span class=keyword1 id=SetUtils-mems_le_finite_i><span class=command>lemma</span></span> mems_le_finite_i<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>s</span> <span class=main>::</span> <span class=quoted><span class=quoted>"nat set"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=free>k</span> <span class=main>::</span> <span class=quoted>nat</span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span> <span class=bound>x</span><span class=main>.</span> <span class=bound>x</span> <span class=main>∈</span> <span class=free>s</span> <span class=main>⟶</span> <span class=bound>x</span> <span class=main>≤</span> <span class=free>k</span><span class=main>)</span> <span class=main>⟹</span> finite <span class=free>s</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword3><span class=command>assume</span></span> P<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span> <span class=bound>x</span><span class=main>.</span> <span class=bound>x</span> <span class=main>∈</span> <span class=free>s</span> <span class=main>⟶</span> <span class=bound>x</span> <span class=main>≤</span> <span class=free>k</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?f</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"id <span class=main>::</span> nat <span class=main>⇒</span> nat"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?S</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"<span class=main>{</span><span class=bound>i</span><span class=main>.</span> <span class=bound>i</span> <span class=main>≤</span> <span class=free>k</span><span class=main>}</span>"</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>s</span> <span class=main>⊆</span> <span class=var>?S</span>"</span></span> <span class=keyword1><span class=command>using</span></span> P <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?f</span> <span class=main>`</span> <span class=var>?S</span> <span class=main>=</span> <span class=var>?S</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"finite <span class=var>?S</span>"</span></span> <span class=keyword1><span class=command>using</span></span> nat_seg_image_imp_finite <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"finite <span class=free>s</span>"</span></span> <span class=keyword1><span class=command>using</span></span> calculation finite_subset <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>qed</span></span>
<span class=keyword1 id=SetUtils-mems_le_finite><span class=command>lemma</span></span> mems_le_finite<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>s</span> <span class=main>::</span> <span class=quoted><span class=quoted>"nat set"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=free>k</span> <span class=main>::</span> <span class=quoted>nat</span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=main>(</span><span class=bound>s</span> <span class=main>::</span> nat set<span class=main>)</span> <span class=bound>k</span><span class=main>.</span> <span class=main>(</span><span class=main>∀</span> <span class=bound>x</span><span class=main>.</span> <span class=bound>x</span> <span class=main>∈</span> <span class=bound>s</span> <span class=main>⟶</span> <span class=bound>x</span> <span class=main>≤</span> <span class=bound>k</span><span class=main>)</span> <span class=main>⟹</span> finite <span class=bound>s</span>"</span></span>  
  <span class=keyword1><span class=command>using</span></span> mems_le_finite_i <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=comment1>― ‹NOTE translated `s` to `nat set` (more generality wasn't required.).›</span> 
<span class=keyword1 id=SetUtils-mem_le_imp_MIN_le><span class=command>lemma</span></span> mem_le_imp_MIN_le<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>s</span> <span class=main>::</span> <span class=quoted><span class=quoted>"nat set"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=free>k</span> <span class=main>::</span> <span class=quoted>nat</span> 
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>x</span><span class=main>.</span> <span class=main>(</span><span class=bound>x</span> <span class=main>∈</span> <span class=free>s</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=bound>x</span> <span class=main>≤</span> <span class=free>k</span><span class=main>)</span>"</span></span> 
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>Inf <span class=free>s</span> <span class=main>≤</span> <span class=free>k</span><span class=main>)</span>"</span></span> 
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>from</span></span> assms <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>x</span></span> <span class=keyword2><span class=keyword>where</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> <span class=free>s</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>≤</span> <span class=free>k</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>assume</span></span> C<span class=main>:</span> <span class=quoted><span class=quoted>"Inf <span class=free>s</span> <span class=main>&gt;</span> <span class=free>k</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Inf <span class=free>s</span> <span class=main>&gt;</span> <span class=skolem>x</span>"</span></span> <span class=keyword1><span class=command>using</span></span> 1<span class=main>(</span>2<span class=main>)</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted>False</span> 
      <span class=keyword1><span class=command>using</span></span> 1<span class=main>(</span>1<span class=main>)</span> cInf_lower leD
      <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=comment1>― ‹NOTE 
  nat --&gt; bool is the type of a HOL4 set and was translated to 'nat set'.›</span>
<span class=comment1>― ‹NOTE 
  We cannot use 'Min' instead of 'Inf' because there is no indication that '{n. s n}' will be
finite. Without that <span class=antiquoted><span class=antiquote>@{</span><span class=operator>term</span> <span class=quoted>"Min <span class=main>{</span><span class=bound>n</span><span class=main>.</span> <span class=free>s</span> <span class=bound>n</span><span class=main>}</span> <span class=main>∈</span> <span class=main>{</span><span class=bound>n</span><span class=main>.</span> <span class=free>s</span> <span class=bound>n</span><span class=main>}</span>"</span><span class=antiquote>}</span></span> is not necessarily true.›</span>
<span class=keyword1 id=SetUtils-mem_lt_imp_MIN_lt><span class=command>lemma</span></span> mem_lt_imp_MIN_lt<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>s</span> <span class=main>::</span> <span class=quoted><span class=quoted>"nat set"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=free>k</span> <span class=main>::</span> <span class=quoted>nat</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>x</span><span class=main>.</span> <span class=bound>x</span> <span class=main>∈</span> <span class=free>s</span> <span class=main>∧</span> <span class=bound>x</span> <span class=main>&lt;</span> <span class=free>k</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>Inf <span class=free>s</span><span class=main>)</span> <span class=main>&lt;</span> <span class=free>k</span>"</span></span> 
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>x</span></span> <span class=keyword2><span class=keyword>where</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> <span class=free>s</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>&lt;</span> <span class=free>k</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> 2<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>s</span> <span class=main>≠</span> <span class=main>{}</span>"</span></span> 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Inf <span class=free>s</span> <span class=main>∈</span> <span class=free>s</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> Inf_nat_def LeastI
    <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>x</span><span class=main>∈</span><span class=free>s</span><span class=main>.</span> Inf <span class=free>s</span> <span class=main>≤</span> <span class=bound>x</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> cInf_lower<span class=main>)</span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>Inf <span class=free>s</span><span class=main>)</span> <span class=main>&lt;</span> <span class=free>k</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms leD 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=comment1>― ‹NOTE type for 'k' had to be fixed (type unordered error; also not true for e.g. real sets).›</span>
<span class=keyword1 id=SetUtils-bound_child_parent_neq_mems_state_set_neq_len><span class=command>lemma</span></span> bound_child_parent_neq_mems_state_set_neq_len<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>s</span> <span class=keyword2><span class=keyword>and</span></span> <span class=free>k</span> <span class=main>::</span> <span class=quoted>nat</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>x</span><span class=main>.</span> <span class=bound>x</span> <span class=main>∈</span> <span class=free>s</span> <span class=main>⟶</span> <span class=bound>x</span> <span class=main>&lt;</span> <span class=free>k</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"finite <span class=free>s</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms bounded_nat_set_is_finite 
  <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span> 

<span class=keyword1 id=SetUtils-bound_main_lemma_2><span class=command>lemma</span></span> bound_main_lemma_2<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=main>(</span><span class=bound>s</span> <span class=main>::</span> nat set<span class=main>)</span> <span class=bound>k</span><span class=main>.</span> <span class=main>(</span><span class=bound>s</span> <span class=main>≠</span> <span class=main>{}</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=main>∀</span><span class=bound>x</span><span class=main>.</span> <span class=bound>x</span> <span class=main>∈</span> <span class=bound>s</span> <span class=main>⟶</span> <span class=bound>x</span> <span class=main>≤</span> <span class=bound>k</span><span class=main>)</span> <span class=main>⟹</span> Sup <span class=bound>s</span> <span class=main>≤</span> <span class=bound>k</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword3><span class=command>fix</span></span> <span class=skolem>s</span> <span class=main>::</span> <span class=quoted><span class=quoted>"nat set"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=skolem>k</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>assume</span></span> P1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>s</span> <span class=main>≠</span> <span class=main>{}</span>"</span></span>
    <span class=keyword3><span class=command>assume</span></span> P2<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>x</span><span class=main>.</span> <span class=bound>x</span> <span class=main>∈</span> <span class=skolem>s</span> <span class=main>⟶</span> <span class=bound>x</span> <span class=main>≤</span> <span class=skolem>k</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"finite <span class=skolem>s</span>"</span></span> <span class=keyword1><span class=command>using</span></span> P2 mems_le_finite <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Max <span class=skolem>s</span> <span class=main>∈</span> <span class=skolem>s</span>"</span></span> <span class=keyword1><span class=command>using</span></span> P1 calculation Max_in <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Max <span class=skolem>s</span> <span class=main>≤</span> <span class=skolem>k</span>"</span></span> <span class=keyword1><span class=command>using</span></span> P2 calculation <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span> 
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>s</span> <span class=main>≠</span> <span class=main>{}</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=main>∀</span><span class=bound>x</span><span class=main>.</span> <span class=bound>x</span> <span class=main>∈</span> <span class=skolem>s</span> <span class=main>⟶</span> <span class=bound>x</span> <span class=main>≤</span> <span class=skolem>k</span><span class=main>)</span> <span class=main>⟹</span> Sup <span class=skolem>s</span> <span class=main>≤</span> <span class=skolem>k</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> Sup_nat_def<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=comment1>― ‹NOTE type of 'k' fixed to nat to be able to use 'bound\_child\_parent\_neq\_mems\_state\_set\_neq\_len'.›</span>
<span class=keyword1 id=SetUtils-bound_child_parent_not_eq_last_diff_paths><span class=command>lemma</span></span> bound_child_parent_not_eq_last_diff_paths<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>s</span> <span class=main>(</span><span class=bound>k</span> <span class=main>::</span> nat<span class=main>)</span><span class=main>.</span>
  <span class=main>(</span><span class=bound>s</span> <span class=main>≠</span> <span class=main>{}</span><span class=main>)</span> 
  <span class=main>⟹</span> <span class=main>(</span><span class=main>∀</span><span class=bound>x</span><span class=main>.</span> <span class=bound>x</span> <span class=main>∈</span> <span class=bound>s</span> <span class=main>⟶</span> <span class=bound>x</span> <span class=main>&lt;</span> <span class=bound>k</span><span class=main>)</span> 
  <span class=main>⟹</span> Sup <span class=bound>s</span> <span class=main>&lt;</span> <span class=bound>k</span>
"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> Sup_nat_def bound_child_parent_neq_mems_state_set_neq_len<span class=main>)</span>

<span class=keyword1 id=SetUtils-FINITE_ALL_DISTINCT_LISTS_i><span class=command>lemma</span></span> FINITE_ALL_DISTINCT_LISTS_i<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>P</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"finite <span class=free>P</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"
    <span class=main>{</span><span class=bound>p</span><span class=main>.</span> distinct <span class=bound>p</span> <span class=main>∧</span> set <span class=bound>p</span> <span class=main>⊆</span> <span class=free>P</span><span class=main>}</span> 
    <span class=main>=</span> <span class=main>{</span><span class=main>[]</span><span class=main>}</span> <span class=main>∪</span> <span class=main>(</span><span class=main>⋃</span> <span class=main>(</span><span class=main>(</span><span class=main>λ</span><span class=bound>e</span><span class=main>.</span> <span class=main>{</span><span class=bound>e</span> <span class=main>#</span> <span class=bound>p0</span> <span class=main>|</span> <span class=bound>p0</span><span class=main>.</span> distinct <span class=bound>p0</span> <span class=main>∧</span> set <span class=bound>p0</span> <span class=main>⊆</span> <span class=main>(</span><span class=free>P</span> <span class=main>-</span> <span class=main>{</span><span class=bound>e</span><span class=main>}</span><span class=main>)</span><span class=main>}</span><span class=main>)</span> <span class=main>`</span> <span class=free>P</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?A</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>{</span><span class=bound>p</span><span class=main>.</span> distinct <span class=bound>p</span> <span class=main>∧</span> set <span class=bound>p</span> <span class=main>⊆</span> <span class=free>P</span> <span class=main>}</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?B</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>{</span><span class=main>[]</span><span class=main>}</span> <span class=main>∪</span> <span class=main>(</span><span class=main>⋃</span> <span class=main>(</span><span class=main>(</span><span class=main>λ</span><span class=bound>e</span><span class=main>.</span> <span class=main>{</span><span class=bound>e</span> <span class=main>#</span> <span class=bound>p0</span> <span class=main>|</span> <span class=bound>p0</span><span class=main>.</span> distinct <span class=bound>p0</span> <span class=main>∧</span> set <span class=bound>p0</span> <span class=main>⊆</span> <span class=main>(</span><span class=free>P</span> <span class=main>-</span> <span class=main>{</span><span class=bound>e</span><span class=main>}</span><span class=main>)</span><span class=main>}</span><span class=main>)</span> <span class=main>`</span> <span class=free>P</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword1><span class=command>{</span></span>
      <span class=keyword3><span class=command>fix</span></span> <span class=skolem>a</span>
      <span class=keyword3><span class=command>assume</span></span> P<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>a</span> <span class=main>∈</span> <span class=var>?A</span>"</span></span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a</span> <span class=main>∈</span> <span class=var>?B</span>"</span></span> 
      <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=skolem>a</span></span><span class=main>)</span>
        <span class=keyword1><span class=command>text</span></span> <span class=quoted><span class=plain_text>‹ The empty list is distinct and its corresponding set is the empty set which is a 
            trivial subset of `?B`. The `Nil` case can therefore be derived by automation. ›</span></span>
        <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>h</span> <span class=skolem>list</span><span class=main>)</span>
        <span class=keyword1><span class=command>{</span></span>
          <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?b'</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=skolem>h</span>"</span></span>
          <span class=keyword1><span class=command>{</span></span>
            <span class=keyword1><span class=command>from</span></span> P <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"set <span class=skolem>a</span> <span class=main>⊆</span> <span class=free>P</span>"</span></span>
              <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
            <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"set <span class=skolem>list</span> <span class=main>⊆</span> <span class=main>(</span><span class=free>P</span> <span class=main>-</span> <span class=main>{</span><span class=skolem>h</span><span class=main>}</span><span class=main>)</span>"</span></span>
              <span class=keyword1><span class=command>using</span></span> P dual_order.trans local.Cons 
              <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
          <span class=keyword1><span class=command>}</span></span>
          <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> P Cons 
          <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"distinct <span class=skolem>list</span>"</span></span>
            <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
          <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a</span> <span class=main>∈</span> <span class=main>(</span><span class=main>(</span><span class=main>λ</span><span class=bound>e</span><span class=main>.</span> <span class=main>{</span><span class=bound>e</span> <span class=main>#</span> <span class=bound>p0</span> <span class=main>|</span> <span class=bound>p0</span><span class=main>.</span> distinct <span class=bound>p0</span> <span class=main>∧</span> set <span class=bound>p0</span> <span class=main>⊆</span> <span class=main>(</span><span class=free>P</span> <span class=main>-</span> <span class=main>{</span><span class=bound>e</span><span class=main>}</span><span class=main>)</span><span class=main>}</span><span class=main>)</span> <span class=var>?b'</span><span class=main>)</span>"</span></span>
            <span class=keyword1><span class=command>using</span></span> Cons
            <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
          <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>{</span></span>
            <span class=keyword1><span class=command>from</span></span> P Cons <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?b'</span> <span class=main>∈</span> set <span class=skolem>a</span>"</span></span>
              <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
            <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> P <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"set <span class=skolem>a</span> <span class=main>⊆</span> <span class=free>P</span>"</span></span>
              <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
            <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?b'</span> <span class=main>∈</span> <span class=free>P</span>"</span></span> 
              <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
          <span class=keyword1><span class=command>}</span></span>
          <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> 
            <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>b'</span> <span class=main>∈</span> <span class=free>P</span><span class=main>.</span> <span class=skolem>a</span> <span class=main>∈</span> <span class=main>(</span><span class=main>(</span><span class=main>λ</span><span class=bound>e</span><span class=main>.</span> <span class=main>{</span><span class=bound>e</span> <span class=main>#</span> <span class=bound>p0</span> <span class=main>|</span> <span class=bound>p0</span><span class=main>.</span> distinct <span class=bound>p0</span> <span class=main>∧</span> set <span class=bound>p0</span> <span class=main>⊆</span> <span class=main>(</span><span class=free>P</span> <span class=main>-</span> <span class=main>{</span><span class=bound>e</span><span class=main>}</span><span class=main>)</span><span class=main>}</span><span class=main>)</span> <span class=bound>b'</span><span class=main>)</span>"</span></span>
            <span class=keyword1><span class=command>by</span></span> <span class=operator>meson</span> 
        <span class=keyword1><span class=command>}</span></span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>b'</span></span> <span class=keyword2><span class=keyword>where</span></span>
          <span class=quoted><span class=quoted>"<span class=skolem>b'</span> <span class=main>∈</span> <span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a</span> <span class=main>∈</span> <span class=main>(</span><span class=main>(</span><span class=main>λ</span><span class=bound>e</span><span class=main>.</span> <span class=main>{</span><span class=bound>e</span> <span class=main>#</span> <span class=bound>p0</span> <span class=main>|</span> <span class=bound>p0</span><span class=main>.</span> distinct <span class=bound>p0</span> <span class=main>∧</span> set <span class=bound>p0</span> <span class=main>⊆</span> <span class=main>(</span><span class=free>P</span> <span class=main>-</span> <span class=main>{</span><span class=bound>e</span><span class=main>}</span><span class=main>)</span><span class=main>}</span><span class=main>)</span> <span class=skolem>b'</span><span class=main>)</span>"</span></span>
          <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> 
          <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>qed</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>}</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?A</span> <span class=main>⊆</span> <span class=var>?B</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>{</span></span>
    <span class=keyword1><span class=command>{</span></span>
      <span class=keyword3><span class=command>fix</span></span> <span class=skolem>b</span>
      <span class=keyword3><span class=command>assume</span></span> P<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>b</span> <span class=main>∈</span> <span class=var>?B</span>"</span></span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>b</span> <span class=main>∈</span> <span class=var>?A</span>"</span></span> 
        <span class=keyword1><span class=command>text</span></span> <span class=quoted><span class=plain_text>‹ The empty list is in `?B` by construction. The `Nil` case can therefore be derived  
          straightforwardly.›</span></span>
      <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=skolem>b</span></span><span class=main>)</span>
        <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>a</span> <span class=skolem>list</span><span class=main>)</span>
        <span class=keyword1><span class=command>from</span></span> P Cons <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>b'</span></span> <span class=keyword2><span class=keyword>where</span></span> a<span class=main>:</span> 
          <span class=quoted><span class=quoted>"<span class=skolem>b'</span> <span class=main>∈</span> <span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>b</span> <span class=main>∈</span> <span class=main>{</span><span class=skolem>b'</span> <span class=main>#</span> <span class=bound>p0</span> <span class=main>|</span> <span class=bound>p0</span><span class=main>.</span> distinct <span class=bound>p0</span> <span class=main>∧</span> set <span class=bound>p0</span> <span class=main>⊆</span> <span class=main>(</span><span class=free>P</span> <span class=main>-</span> <span class=main>{</span><span class=skolem>b'</span><span class=main>}</span><span class=main>)</span><span class=main>}</span>"</span></span>
          <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>p0</span></span> <span class=keyword2><span class=keyword>where</span></span> b<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>b</span> <span class=main>=</span> <span class=skolem>b'</span> <span class=main>#</span> <span class=skolem>p0</span>"</span></span> <span class=quoted><span class=quoted>"distinct <span class=skolem>p0</span>"</span></span> <span class=quoted><span class=quoted>"set <span class=skolem>p0</span> <span class=main>⊆</span> <span class=main>(</span><span class=free>P</span> <span class=main>-</span> <span class=main>{</span><span class=skolem>b'</span><span class=main>}</span><span class=main>)</span>"</span></span>
          <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"distinct <span class=main>(</span><span class=skolem>b'</span> <span class=main>#</span> <span class=skolem>p0</span><span class=main>)</span>"</span></span>
          <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> subset_Diff_insert<span class=main>)</span>
        <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"set <span class=main>(</span><span class=skolem>b'</span> <span class=main>#</span> <span class=skolem>p0</span><span class=main>)</span> <span class=main>⊆</span> <span class=free>P</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> a<span class=main>(</span>1<span class=main>)</span> b<span class=main>(</span>3<span class=main>)</span>
          <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
        <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> 
          <span class=keyword1><span class=command>using</span></span> b<span class=main>(</span>1<span class=main>)</span>
          <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
      <span class=keyword1><span class=command>qed</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>}</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?B</span> <span class=main>⊆</span> <span class=var>?A</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>using</span></span> set_eq_subset 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=SetUtils-FINITE_ALL_DISTINCT_LISTS><span class=command>lemma</span></span> FINITE_ALL_DISTINCT_LISTS<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>P</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"finite <span class=free>P</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"finite <span class=main>{</span><span class=bound>p</span><span class=main>.</span> distinct <span class=bound>p</span> <span class=main>∧</span> set <span class=bound>p</span> <span class=main>⊆</span> <span class=free>P</span><span class=main>}</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms 
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=quoted>"card <span class=free>P</span>"</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>P</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> 0
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>P</span> <span class=main>=</span> <span class=main>{}</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> 
    <span class=keyword1><span class=command>using</span></span> 0
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Suc <span class=skolem>x</span><span class=main>)</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword1><span class=command>text</span></span> <span class=quoted><span class=plain_text>‹ Proof the finiteness of the union by proving both sets of the union are finite. The 
      singleton set `{[]}` is trivially finite. ›</span></span>
    <span class=keyword1><span class=command>{</span></span>
      <span class=keyword1><span class=command>{</span></span>
        <span class=keyword3><span class=command>fix</span></span> <span class=skolem>e</span>
        <span class=keyword3><span class=command>assume</span></span> P<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>e</span> <span class=main>∈</span> <span class=skolem>P</span>"</span></span> 
        <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"
          <span class=main>{</span><span class=skolem>e</span> <span class=main>#</span> <span class=bound>p0</span> <span class=main>|</span> <span class=bound>p0</span><span class=main>.</span> distinct <span class=bound>p0</span> <span class=main>∧</span> set <span class=bound>p0</span> <span class=main>⊆</span> <span class=skolem>P</span> <span class=main>-</span> <span class=main>{</span><span class=skolem>e</span><span class=main>}</span><span class=main>}</span> 
          <span class=main>=</span> <span class=main>(</span><span class=main>λ</span><span class=bound>p</span><span class=main>.</span> <span class=skolem>e</span> <span class=main>#</span> <span class=bound>p</span><span class=main>)</span> <span class=main>`</span> <span class=main>{</span> <span class=bound>p</span><span class=main>.</span> distinct <span class=bound>p</span> <span class=main>∧</span> set <span class=bound>p</span> <span class=main>⊆</span> <span class=skolem>P</span> <span class=main>-</span> <span class=main>{</span><span class=skolem>e</span><span class=main>}</span><span class=main>}</span>"</span></span> 
          <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
        <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>{</span></span>
          <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?P'</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=skolem>P</span> <span class=main>-</span> <span class=main>{</span><span class=skolem>e</span><span class=main>}</span>"</span></span>
          <span class=keyword1><span class=command>from</span></span> Suc.prems 
          <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"finite <span class=var>?P'</span>"</span></span>
            <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
          <span class=keyword1><span class=command>text</span></span> <span class=quoted><span class=plain_text>‹ The finiteness can now be shown using the induction hypothesis. However `e` might
            already be contained in `?P`, so we have to split cases first. ›</span></span>
          <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"finite <span class=main>(</span><span class=main>(</span><span class=main>λ</span><span class=bound>p</span><span class=main>.</span> <span class=skolem>e</span> <span class=main>#</span> <span class=bound>p</span><span class=main>)</span> <span class=main>`</span> <span class=main>{</span><span class=bound>p</span><span class=main>.</span> distinct <span class=bound>p</span> <span class=main>∧</span> set <span class=bound>p</span> <span class=main>⊆</span> <span class=var>?P'</span><span class=main>}</span><span class=main>)</span>"</span></span> 
          <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=skolem>e</span> <span class=main>∈</span> <span class=skolem>P</span>"</span></span><span class=main>)</span>
            <span class=keyword3><span class=command>case</span></span> True
            <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>=</span> card <span class=var>?P'</span>"</span></span> <span class=keyword1><span class=command>using</span></span> Suc.prems Suc<span class=main>(</span>2<span class=main>)</span> 
              <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
            <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> Suc.prems 
            <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"finite <span class=var>?P'</span>"</span></span> 
              <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
            <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> 
              <span class=keyword1><span class=command>using</span></span> Suc<span class=main>(</span>1<span class=main>)</span> 
              <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
          <span class=keyword1><span class=command>next</span></span>
            <span class=keyword3><span class=command>case</span></span> False
            <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?P'</span> <span class=main>=</span> <span class=skolem>P</span>"</span></span> 
              <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
            <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"finite <span class=main>{</span><span class=bound>p</span><span class=main>.</span> distinct <span class=bound>p</span> <span class=main>∧</span> set <span class=bound>p</span> <span class=main>⊆</span> <span class=var>?P'</span><span class=main>}</span>"</span></span>
              <span class=keyword1><span class=command>using</span></span> False P <span class=keyword1><span class=command>by</span></span> <span class=operator>linarith</span> 
            <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
              <span class=keyword1><span class=command>using</span></span> finite_imageI
              <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
          <span class=keyword1><span class=command>qed</span></span>
        <span class=keyword1><span class=command>}</span></span>
        <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"finite <span class=main>{</span><span class=skolem>e</span> <span class=main>#</span> <span class=bound>p0</span> <span class=main>|</span> <span class=bound>p0</span><span class=main>.</span> distinct <span class=bound>p0</span> <span class=main>∧</span> set <span class=bound>p0</span> <span class=main>⊆</span> <span class=main>(</span><span class=skolem>P</span> <span class=main>-</span> <span class=main>{</span><span class=skolem>e</span><span class=main>}</span><span class=main>)</span><span class=main>}</span>"</span></span>
          <span class=keyword1><span class=command>by</span></span> <span class=operator>argo</span>
      <span class=keyword1><span class=command>}</span></span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"finite <span class=main>(</span><span class=main>⋃</span> <span class=main>(</span><span class=main>(</span><span class=main>λ</span><span class=bound>e</span><span class=main>.</span> <span class=main>{</span><span class=bound>e</span> <span class=main>#</span> <span class=bound>p0</span> <span class=main>|</span> <span class=bound>p0</span><span class=main>.</span> distinct <span class=bound>p0</span> <span class=main>∧</span> set <span class=bound>p0</span> <span class=main>⊆</span> <span class=main>(</span><span class=skolem>P</span> <span class=main>-</span> <span class=main>{</span><span class=bound>e</span><span class=main>}</span><span class=main>)</span><span class=main>}</span><span class=main>)</span> <span class=main>`</span> <span class=skolem>P</span><span class=main>)</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> Suc.prems
        <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>}</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> 
      <span class=quoted><span class=quoted>"finite <span class=main>(</span><span class=main>{</span><span class=main>[]</span><span class=main>}</span> <span class=main>∪</span> <span class=main>(</span><span class=main>⋃</span> <span class=main>(</span><span class=main>(</span><span class=main>λ</span><span class=bound>e</span><span class=main>.</span> <span class=main>{</span><span class=bound>e</span> <span class=main>#</span> <span class=bound>p0</span> <span class=main>|</span> <span class=bound>p0</span><span class=main>.</span> distinct <span class=bound>p0</span> <span class=main>∧</span> set <span class=bound>p0</span> <span class=main>⊆</span> <span class=main>(</span><span class=skolem>P</span> <span class=main>-</span> <span class=main>{</span><span class=bound>e</span><span class=main>}</span><span class=main>)</span><span class=main>}</span><span class=main>)</span> <span class=main>`</span> <span class=skolem>P</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span> 
      <span class=keyword1><span class=command>using</span></span> finite_Un
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>    
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> 
    <span class=keyword1><span class=command>using</span></span> FINITE_ALL_DISTINCT_LISTS_i<span class=main>[</span><span class=operator>OF</span> Suc.prems<span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=SetUtils-subset_inter_diff_empty><span class=command>lemma</span></span> subset_inter_diff_empty<span class=main>:</span> 
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>s</span> <span class=main>⊆</span> <span class=free>t</span>"</span></span> 
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>s</span> <span class=main>∩</span> <span class=main>(</span><span class=free>u</span> <span class=main>-</span> <span class=free>t</span><span class=main>)</span> <span class=main>=</span> <span class=main>{}</span><span class=main>)</span>"</span></span> 
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=keyword2><span class=keyword>end</span></span></pre>
</div><div id=TopologicalProps>
<div class=head>
<h1>Theory TopologicalProps</h1>
</div>
<pre class=source><span class=keyword1><span class=command>theory</span></span> TopologicalProps
  <span class=keyword2><span class=keyword>imports</span></span> <a href=https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html>Main</a> <a href=#FactoredSystem>FactoredSystem</a> <a href=#ActionSeqProcess>ActionSeqProcess</a> <a href=#SetUtils>SetUtils</a>
<span class=keyword2><span class=keyword>begin</span></span> 


<span class=keyword1><span class=command>section</span></span> <span class=quoted><span class=plain_text>"Topological Properties"</span></span>
<span class=keyword1><span class=command>subsection</span></span> <span class=quoted><span class=plain_text>"Basic Definitions and Properties"</span></span>

<span class=keyword1><span class=command>definition</span></span> <span class=entity>PLS_charles</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>PLS_charles</span> <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=free><span class=bound><span class=entity>as</span></span></span> <span class=free><span class=bound><span class=entity>PROB</span></span></span> <span class=main>≡</span> <span class=main>{</span>length <span class=bound>as'</span> <span class=main>|</span> <span class=bound>as'</span><span class=main>.</span> 
    <span class=main>(</span><span class=bound>as'</span> <span class=main>∈</span> valid_plans <span class=free><span class=bound><span class=entity>PROB</span></span></span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span>exec_plan <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=bound>as'</span> <span class=main>=</span> exec_plan <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=free><span class=bound><span class=entity>as</span></span></span><span class=main>)</span><span class=main>}</span>"</span></span>


<span class=keyword1><span class=command>definition</span></span> <span class=entity>MPLS_charles</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>MPLS_charles</span> <span class=free><span class=bound><span class=entity>PROB</span></span></span> <span class=main>≡</span> <span class=main>{</span>Inf <span class=main>(</span>PLS_charles <span class=main>(</span>fst <span class=bound>p</span><span class=main>)</span> <span class=main>(</span>snd <span class=bound>p</span><span class=main>)</span> <span class=free><span class=bound><span class=entity>PROB</span></span></span><span class=main>)</span> <span class=main>|</span> <span class=bound>p</span><span class=main>.</span> 
    <span class=main>(</span><span class=main>(</span>fst <span class=bound>p</span><span class=main>)</span> <span class=main>∈</span> valid_states <span class=free><span class=bound><span class=entity>PROB</span></span></span><span class=main>)</span> 
    <span class=main>∧</span> <span class=main>(</span><span class=main>(</span>snd <span class=bound>p</span><span class=main>)</span> <span class=main>∈</span> valid_plans <span class=free><span class=bound><span class=entity>PROB</span></span></span><span class=main>)</span>
  <span class=main>}</span>"</span></span>


<span class=comment1>― ‹NOTE name shortened to 'problem\_plan\_bound\_charles'.›</span>
<span class=keyword1><span class=command>definition</span></span> <span class=entity>problem_plan_bound_charles</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>problem_plan_bound_charles</span> <span class=free><span class=bound><span class=entity>PROB</span></span></span> <span class=main>≡</span> Sup <span class=main>(</span>MPLS_charles <span class=free><span class=bound><span class=entity>PROB</span></span></span><span class=main>)</span>"</span></span>


<span class=comment1>― ‹NOTE name shortened to 'PLS\_state'.›</span>  
<span class=keyword1><span class=command>definition</span></span> <span class=entity>PLS_state_1</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>PLS_state_1</span> <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=free><span class=bound><span class=entity>as</span></span></span> <span class=main>≡</span> length <span class=main>`</span> <span class=main>{</span><span class=bound>as'</span><span class=main>.</span> <span class=main>(</span>exec_plan <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=bound>as'</span> <span class=main>=</span> exec_plan <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=free><span class=bound><span class=entity>as</span></span></span><span class=main>)</span><span class=main>}</span>"</span></span>


<span class=comment1>― ‹NOTE name shortened to 'MPLS\_stage\_1'.›</span>
<span class=keyword1><span class=command>definition</span></span> <span class=entity>MPLS_stage_1</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>MPLS_stage_1</span> <span class=free><span class=bound><span class=entity>PROB</span></span></span> <span class=main>≡</span> 
    <span class=main>(</span><span class=main>λ</span> <span class=main>(</span><span class=bound>s</span><span class=main>,</span> <span class=bound>as</span><span class=main>)</span><span class=main>.</span> Inf <span class=main>(</span>PLS_state_1 <span class=bound>s</span> <span class=bound>as</span><span class=main>)</span><span class=main>)</span> 
    <span class=main>`</span> <span class=main>{</span><span class=main>(</span><span class=bound>s</span><span class=main>,</span> <span class=bound>as</span><span class=main>)</span><span class=main>.</span> <span class=main>(</span><span class=bound>s</span> <span class=main>∈</span> valid_states <span class=free><span class=bound><span class=entity>PROB</span></span></span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=bound>as</span> <span class=main>∈</span> valid_plans <span class=free><span class=bound><span class=entity>PROB</span></span></span><span class=main>)</span><span class=main>}</span>
  "</span></span>


<span class=comment1>― ‹NOTE name shortened to 'problem\_plan\_bound\_stage\_1'.›</span>
<span class=keyword1><span class=command>definition</span></span> <span class=entity>problem_plan_bound_stage_1</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>problem_plan_bound_stage_1</span> <span class=free><span class=bound><span class=entity>PROB</span></span></span> <span class=main>≡</span> Sup <span class=main>(</span>MPLS_stage_1 <span class=free><span class=bound><span class=entity>PROB</span></span></span><span class=main>)</span>"</span></span>
<span class=keyword2><span class=keyword>for</span></span> <span class=free>PROB</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> problem"</span></span>


<span class=comment1>― ‹NOTE name shortened.›</span>
<span class=keyword1><span class=command>definition</span></span> <span class=entity>PLS</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>PLS</span> <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=free><span class=bound><span class=entity>as</span></span></span> <span class=main>≡</span> length <span class=main>`</span> <span class=main>{</span><span class=bound>as'</span><span class=main>.</span> <span class=main>(</span>exec_plan <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=bound>as'</span> <span class=main>=</span> exec_plan <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=free><span class=bound><span class=entity>as</span></span></span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span>subseq <span class=bound>as'</span> <span class=free><span class=bound><span class=entity>as</span></span></span><span class=main>)</span><span class=main>}</span>"</span></span>


<span class=comment1>― ‹NOTE added lemma.›</span>
<span class=comment1>― ‹NOTE proof finite PLS for use in 'proof in\_MPLS\_leq\_2\_pow\_n\_i'›</span> 
<span class=keyword1 id=TopologicalProps-finite_PLS><span class=command>lemma</span></span> finite_PLS<span class=main>:</span> <span class=quoted><span class=quoted>"finite <span class=main>(</span>PLS <span class=free>s</span> <span class=free>as</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?S</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"<span class=main>{</span><span class=bound>as'</span><span class=main>.</span> <span class=main>(</span>exec_plan <span class=free>s</span> <span class=bound>as'</span> <span class=main>=</span> exec_plan <span class=free>s</span> <span class=free>as</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span>subseq <span class=bound>as'</span> <span class=free>as</span><span class=main>)</span><span class=main>}</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?S1</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"length <span class=main>`</span> <span class=main>{</span><span class=bound>as'</span><span class=main>.</span> <span class=main>(</span>exec_plan <span class=free>s</span> <span class=bound>as'</span> <span class=main>=</span> exec_plan <span class=free>s</span> <span class=free>as</span><span class=main>)</span> <span class=main>}</span>"</span></span> 
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?S2</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"length <span class=main>`</span> <span class=main>{</span><span class=bound>as'</span><span class=main>.</span> <span class=main>(</span>subseq <span class=bound>as'</span> <span class=free>as</span><span class=main>)</span><span class=main>}</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?n</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"length <span class=free>as</span> <span class=main>+</span> <span class=main>1</span>"</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"finite <span class=var>?S2</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> bounded_nat_set_is_finite<span class=main>[</span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> n <span class=main><span class=main>=</span></span> <span class=var><span class=quoted><span class=var>?n</span></span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>and</span></span></span> N <span class=main><span class=main>=</span></span> <span class=var><span class=quoted><span class=var>?S2</span></span></span><span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"length <span class=main>`</span> <span class=var>?S</span> <span class=main>⊆</span> <span class=main>(</span><span class=var>?S1</span> <span class=main>∩</span> <span class=var>?S2</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"finite <span class=main>(</span>length <span class=main>`</span> <span class=var>?S</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> infinite_super 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span> 
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> 
    <span class=keyword1><span class=command>unfolding</span></span> PLS_def 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=comment1>― ‹NOTE name shortened.›</span>
<span class=keyword1><span class=command>definition</span></span> <span class=entity>MPLS</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>MPLS</span> <span class=free><span class=bound><span class=entity>PROB</span></span></span> <span class=main>≡</span>
    <span class=main>(</span><span class=main>λ</span> <span class=main>(</span><span class=bound>s</span><span class=main>,</span> <span class=bound>as</span><span class=main>)</span><span class=main>.</span> Inf <span class=main>(</span>PLS <span class=bound>s</span> <span class=bound>as</span><span class=main>)</span><span class=main>)</span> 
    <span class=main>`</span> <span class=main>{</span><span class=main>(</span><span class=bound>s</span><span class=main>,</span> <span class=bound>as</span><span class=main>)</span><span class=main>.</span> <span class=main>(</span><span class=bound>s</span> <span class=main>∈</span> valid_states <span class=free><span class=bound><span class=entity>PROB</span></span></span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=bound>as</span> <span class=main>∈</span> valid_plans <span class=free><span class=bound><span class=entity>PROB</span></span></span><span class=main>)</span><span class=main>}</span>
  "</span></span>


<span class=comment1>― ‹NOTE name shortened.›</span>
<span class=keyword1><span class=command>definition</span></span> <span class=entity>problem_plan_bound</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>problem_plan_bound</span> <span class=free><span class=bound><span class=entity>PROB</span></span></span> <span class=main>≡</span> Sup <span class=main>(</span>MPLS <span class=free><span class=bound><span class=entity>PROB</span></span></span><span class=main>)</span>"</span></span>


<span class=keyword1 id=TopologicalProps-expanded_problem_plan_bound_thm_1><span class=command>lemma</span></span> expanded_problem_plan_bound_thm_1<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>" 
    <span class=main>(</span>problem_plan_bound <span class=free>PROB</span><span class=main>)</span> <span class=main>=</span> Sup <span class=main>(</span>
      <span class=main>(</span><span class=main>λ</span><span class=main>(</span><span class=bound>s</span><span class=main>,</span><span class=bound>as</span><span class=main>)</span><span class=main>.</span> Inf <span class=main>(</span>PLS <span class=bound>s</span> <span class=bound>as</span><span class=main>)</span><span class=main>)</span> <span class=main>`</span>
      <span class=main>{</span><span class=main>(</span><span class=bound>s</span><span class=main>,</span> <span class=bound>as</span><span class=main>)</span><span class=main>.</span> <span class=main>(</span><span class=bound>s</span> <span class=main>∈</span> <span class=main>(</span>valid_states <span class=free>PROB</span><span class=main>)</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=bound>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span><span class=main>)</span><span class=main>}</span>
    <span class=main>)</span>  
  "</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> problem_plan_bound_def MPLS_def 
  <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>

<span class=keyword1 id=TopologicalProps-expanded_problem_plan_bound_thm><span class=command>lemma</span></span> expanded_problem_plan_bound_thm<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>(</span><span class=tfree>'a</span><span class=main>,</span> <span class=tfree>'b</span><span class=main>)</span> fmap <span class=main>×</span> <span class=main>(</span><span class=tfree>'a</span><span class=main>,</span> <span class=tfree>'b</span><span class=main>)</span> fmap<span class=main>)</span> set"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"
    problem_plan_bound <span class=free>PROB</span> <span class=main>=</span> Sup <span class=main>(</span><span class=main>{</span>Inf <span class=main>(</span>PLS <span class=bound>s</span> <span class=bound>as</span><span class=main>)</span> <span class=main>|</span> <span class=bound>s</span> <span class=bound>as</span><span class=main>.</span> 
      <span class=main>(</span><span class=bound>s</span> <span class=main>∈</span> valid_states <span class=free>PROB</span><span class=main>)</span> 
      <span class=main>∧</span> <span class=main>(</span><span class=bound>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span><span class=main>)</span>
    <span class=main>}</span><span class=main>)</span>
  "</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>
        <span class=main>{</span>Inf <span class=main>(</span>PLS <span class=bound>s</span> <span class=bound>as</span><span class=main>)</span> <span class=main>|</span> <span class=bound>s</span> <span class=bound>as</span><span class=main>.</span> <span class=main>(</span><span class=bound>s</span> <span class=main>∈</span> valid_states <span class=free>PROB</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=bound>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span><span class=main>)</span><span class=main>}</span>
      <span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=main>(</span><span class=main>λ</span><span class=main>(</span><span class=bound>s</span><span class=main>,</span> <span class=bound>as</span><span class=main>)</span><span class=main>.</span> Inf <span class=main>(</span>PLS <span class=bound>s</span> <span class=bound>as</span><span class=main>)</span><span class=main>)</span> <span class=main>`</span> <span class=main>{</span><span class=main>(</span><span class=bound>s</span><span class=main>,</span> <span class=bound>as</span><span class=main>)</span><span class=main>.</span>
        <span class=main>(</span><span class=bound>s</span> <span class=main>∈</span> valid_states <span class=free>PROB</span><span class=main>)</span> 
        <span class=main>∧</span> <span class=main>(</span><span class=bound>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span><span class=main>)</span>
      <span class=main>}</span><span class=main>)</span>
    "</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
    <span class=keyword1><span class=command>also</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>…</span> <span class=main>=</span> 
      <span class=main>(</span><span class=main>λ</span><span class=main>(</span><span class=bound>s</span><span class=main>,</span> <span class=bound>as</span><span class=main>)</span><span class=main>.</span> Inf <span class=main>(</span>PLS <span class=bound>s</span> <span class=bound>as</span><span class=main>)</span><span class=main>)</span> <span class=main>`</span> 
      <span class=main>(</span><span class=main>{</span><span class=bound>s</span><span class=main>.</span> fmdom' <span class=bound>s</span> <span class=main>=</span> prob_dom <span class=free>PROB</span><span class=main>}</span> <span class=main>×</span> <span class=main>{</span><span class=bound>as</span><span class=main>.</span> set <span class=bound>as</span> <span class=main>⊆</span> <span class=free>PROB</span><span class=main>}</span><span class=main>)</span>
    "</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> valid_states_def valid_plans_def
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>finally</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"
      Sup <span class=main>(</span><span class=main>{</span>Inf <span class=main>(</span>PLS <span class=bound>s</span> <span class=bound>as</span><span class=main>)</span> <span class=main>|</span> <span class=bound>s</span> <span class=bound>as</span><span class=main>.</span> <span class=main>(</span><span class=bound>s</span> <span class=main>∈</span> valid_states <span class=free>PROB</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=bound>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span><span class=main>)</span><span class=main>}</span><span class=main>)</span>
      <span class=main>=</span> Sup <span class=main>(</span>
        <span class=main>(</span><span class=main>λ</span><span class=main>(</span><span class=bound>s</span><span class=main>,</span> <span class=bound>as</span><span class=main>)</span><span class=main>.</span> Inf <span class=main>(</span>PLS <span class=bound>s</span> <span class=bound>as</span><span class=main>)</span><span class=main>)</span> <span class=main>`</span> 
        <span class=main>(</span><span class=main>{</span><span class=bound>s</span><span class=main>.</span> fmdom' <span class=bound>s</span> <span class=main>=</span> prob_dom <span class=free>PROB</span><span class=main>}</span> <span class=main>×</span> <span class=main>{</span><span class=bound>as</span><span class=main>.</span> set <span class=bound>as</span> <span class=main>⊆</span> <span class=free>PROB</span><span class=main>}</span><span class=main>)</span>
      <span class=main>)</span>
    "</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>argo</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"
    problem_plan_bound <span class=free>PROB</span> 
    <span class=main>=</span> 
      Sup <span class=main>(</span><span class=main>(</span><span class=main>λ</span><span class=main>(</span><span class=bound>s</span><span class=main>,</span> <span class=bound>as</span><span class=main>)</span><span class=main>.</span> Inf <span class=main>(</span>PLS <span class=bound>s</span> <span class=bound>as</span><span class=main>)</span><span class=main>)</span> <span class=main>`</span> 
      <span class=main>(</span><span class=main>{</span><span class=bound>s</span><span class=main>.</span> fmdom' <span class=bound>s</span> <span class=main>=</span> prob_dom <span class=free>PROB</span><span class=main>}</span> <span class=main>×</span> <span class=main>{</span><span class=bound>as</span><span class=main>.</span> set <span class=bound>as</span> <span class=main>⊆</span> <span class=free>PROB</span><span class=main>}</span><span class=main>)</span><span class=main>)</span>
    "</span></span> 
    <span class=keyword1><span class=command>unfolding</span></span> problem_plan_bound_def MPLS_def valid_states_def valid_plans_def
    <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"
    problem_plan_bound <span class=free>PROB</span> 
    <span class=main>=</span> Sup <span class=main>(</span><span class=main>{</span>Inf <span class=main>(</span>PLS <span class=bound>s</span> <span class=bound>as</span><span class=main>)</span> <span class=main>|</span> <span class=bound>s</span> <span class=bound>as</span><span class=main>.</span> 
      <span class=main>(</span><span class=bound>s</span> <span class=main>∈</span> valid_states <span class=free>PROB</span><span class=main>)</span> 
      <span class=main>∧</span> <span class=main>(</span><span class=bound>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span><span class=main>)</span>
    <span class=main>}</span><span class=main>)</span>
  "</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>argo</span> 
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1><span class=command>subsection</span></span> <span class=quoted><span class=plain_text>"Recurrence Diameter"</span></span> 

<span class=keyword1><span class=command>text</span></span> <span class=quoted><span class=plain_text>‹ The recurrence diameter---defined as the longest simple path in the digraph modelling the
state space---provides a loose upper bound on the system diameter. [Abdulaziz et al., Definition 9, 
p.15] ›</span></span>

<span class=comment1>― ‹NOTE name shortened.›</span>
<span class=comment1>― ‹NOTE 'fun' because of multiple defining equations, pattern matches.›</span>
<span class=keyword1><span class=command>fun</span></span> <span class=entity>valid_path</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>valid_path</span> <span class=free><span class=bound><span class=entity>Pi</span></span></span> <span class=main>[]</span> <span class=main>=</span> True"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>valid_path</span> <span class=free><span class=bound><span class=entity>Pi</span></span></span> <span class=main>[</span><span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>]</span> <span class=main>=</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>s</span></span></span> <span class=main>∈</span> valid_states <span class=free><span class=bound><span class=entity>Pi</span></span></span><span class=main>)</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>valid_path</span> <span class=free><span class=bound><span class=entity>Pi</span></span></span> <span class=main>(</span><span class=free><span class=bound><span class=entity>s1</span></span></span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>s2</span></span></span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>rest</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span>
  <span class=main>(</span><span class=free><span class=bound><span class=entity>s1</span></span></span> <span class=main>∈</span> valid_states <span class=free><span class=bound><span class=entity>Pi</span></span></span><span class=main>)</span> 
  <span class=main>∧</span> <span class=main>(</span><span class=main>∃</span><span class=bound>a</span><span class=main>.</span> <span class=main>(</span><span class=bound>a</span> <span class=main>∈</span> <span class=free><span class=bound><span class=entity>Pi</span></span></span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span>exec_plan <span class=free><span class=bound><span class=entity>s1</span></span></span> <span class=main>[</span><span class=bound>a</span><span class=main>]</span> <span class=main>=</span> <span class=free><span class=bound><span class=entity>s2</span></span></span><span class=main>)</span><span class=main>)</span>
  <span class=main>∧</span> <span class=main>(</span><span class=free>valid_path</span> <span class=free><span class=bound><span class=entity>Pi</span></span></span> <span class=main>(</span><span class=free><span class=bound><span class=entity>s2</span></span></span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>rest</span></span></span><span class=main>)</span><span class=main>)</span>
<span class=main>)</span>"</span></span>


<span class=keyword1 id=TopologicalProps-valid_path_ITP2015><span class=command>lemma</span></span> valid_path_ITP2015<span class=main>:</span> <span class=quoted><span class=quoted>"
  <span class=main>(</span>valid_path <span class=free>Pi</span> <span class=main>[]</span> <span class=main>⟷</span> True<span class=main>)</span>
  <span class=main>∧</span> <span class=main>(</span>valid_path <span class=free>Pi</span> <span class=main>[</span><span class=free>s</span><span class=main>]</span> <span class=main>⟷</span> <span class=main>(</span><span class=free>s</span> <span class=main>∈</span> valid_states <span class=free>Pi</span><span class=main>)</span><span class=main>)</span>
  <span class=main>∧</span> <span class=main>(</span>valid_path <span class=free>Pi</span> <span class=main>(</span><span class=free>s1</span> <span class=main>#</span> <span class=free>s2</span> <span class=main>#</span> <span class=free>rest</span><span class=main>)</span> <span class=main>⟷</span>
      <span class=main>(</span><span class=free>s1</span> <span class=main>∈</span> valid_states <span class=free>Pi</span><span class=main>)</span> 
      <span class=main>∧</span> <span class=main>(</span><span class=main>∃</span><span class=bound>a</span><span class=main>.</span> 
        <span class=main>(</span><span class=bound>a</span> <span class=main>∈</span> <span class=free>Pi</span><span class=main>)</span>
        <span class=main>∧</span> <span class=main>(</span>exec_plan <span class=free>s1</span> <span class=main>[</span><span class=bound>a</span><span class=main>]</span> <span class=main>=</span> <span class=free>s2</span><span class=main>)</span>
      <span class=main>)</span> 
      <span class=main>∧</span> <span class=main>(</span>valid_path <span class=free>Pi</span> <span class=main>(</span><span class=free>s2</span> <span class=main>#</span> <span class=free>rest</span><span class=main>)</span><span class=main>)</span>
  <span class=main>)</span>
"</span></span>
  <span class=keyword1><span class=command>using</span></span> valid_states_def
  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>


<span class=comment1>― ‹NOTE name shortened.›</span>
<span class=comment1>― ‹NOTE second declaration skipped (declared twice in source).›</span>
<span class=keyword1><span class=command>definition</span></span> <span class=entity>RD</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>RD</span> <span class=free><span class=bound><span class=entity>Pi</span></span></span> <span class=main>≡</span> <span class=main>(</span>Sup <span class=main>{</span>length <span class=bound>p</span> <span class=main>-</span> <span class=main>1</span> <span class=main>|</span> <span class=bound>p</span><span class=main>.</span> valid_path <span class=free><span class=bound><span class=entity>Pi</span></span></span> <span class=bound>p</span> <span class=main>∧</span> distinct <span class=bound>p</span><span class=main>}</span><span class=main>)</span>"</span></span>
<span class=keyword2><span class=keyword>for</span></span> <span class=free>Pi</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> problem"</span></span>


<span class=keyword1 id=TopologicalProps-in_PLS_leq_2_pow_n><span class=command>lemma</span></span> in_PLS_leq_2_pow_n<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> problem"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=free>s</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> state"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=free>as</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"finite <span class=free>PROB</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>s</span> <span class=main>∈</span> valid_states <span class=free>PROB</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span><span class=main>)</span>"</span></span> 
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>x</span><span class=main>.</span> 
    <span class=main>(</span><span class=bound>x</span> <span class=main>∈</span> PLS <span class=free>s</span> <span class=free>as</span><span class=main>)</span> 
    <span class=main>∧</span> <span class=main>(</span><span class=bound>x</span> <span class=main>≤</span> <span class=main>(</span><span class=numeral>2</span> <span class=main>^</span> card <span class=main>(</span>prob_dom <span class=free>PROB</span><span class=main>)</span><span class=main>)</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span>
  <span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>as'</span></span> <span class=keyword2><span class=keyword>where</span></span> 1<span class=main>:</span>
    <span class=quoted><span class=quoted>"exec_plan <span class=free>s</span> <span class=free>as</span> <span class=main>=</span> exec_plan <span class=free>s</span> <span class=skolem>as'</span>"</span></span> <span class=quoted><span class=quoted>"subseq <span class=skolem>as'</span> <span class=free>as</span>"</span></span> <span class=quoted><span class=quoted>"length <span class=skolem>as'</span> <span class=main>≤</span> <span class=numeral>2</span> <span class=main>^</span> card <span class=main>(</span>prob_dom <span class=free>PROB</span><span class=main>)</span> <span class=main>-</span> <span class=main>1</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> assms main_lemma 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?x</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"length <span class=skolem>as'</span>"</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?x</span> <span class=main>∈</span> PLS <span class=free>s</span> <span class=free>as</span>"</span></span> 
    <span class=keyword1><span class=command>unfolding</span></span> PLS_def
    <span class=keyword1><span class=command>using</span></span> 1
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?x</span> <span class=main>≤</span> <span class=numeral>2</span> <span class=main>^</span> card <span class=main>(</span>prob_dom <span class=free>PROB</span><span class=main>)</span> <span class=main>-</span> <span class=main>1</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> 1<span class=main>(</span>3<span class=main>)</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>x</span><span class=main>.</span> 
    <span class=main>(</span><span class=bound>x</span> <span class=main>∈</span> PLS <span class=free>s</span> <span class=free>as</span><span class=main>)</span> 
    <span class=main>∧</span> <span class=main>(</span><span class=bound>x</span> <span class=main>≤</span> <span class=main>(</span><span class=numeral>2</span> <span class=main>^</span> card <span class=main>(</span>prob_dom <span class=free>PROB</span><span class=main>)</span><span class=main>)</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span>
  <span class=main>)</span>"</span></span> 
    <span class=keyword1><span class=command>unfolding</span></span> PLS_def
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1 id=TopologicalProps-in_MPLS_leq_2_pow_n><span class=command>lemma</span></span> in_MPLS_leq_2_pow_n<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> problem"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=free>x</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"finite <span class=free>PROB</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>x</span> <span class=main>∈</span> MPLS <span class=free>PROB</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>x</span> <span class=main>≤</span> <span class=numeral>2</span> <span class=main>^</span> card <span class=main>(</span>prob_dom <span class=free>PROB</span><span class=main>)</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span>"</span></span> 
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?mpls</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"MPLS <span class=free>PROB</span>"</span></span>
    <span class=comment1>― ‹NOTE obtain p = (s, as) where 'x = Inf (PLS s as)' from premise.›</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?mpls</span> <span class=main>=</span> 
    <span class=main>(</span><span class=main>λ</span> <span class=main>(</span><span class=bound>s</span><span class=main>,</span> <span class=bound>as</span><span class=main>)</span><span class=main>.</span> Inf <span class=main>(</span>PLS <span class=bound>s</span> <span class=bound>as</span><span class=main>)</span><span class=main>)</span> <span class=main>`</span> 
    <span class=main>{</span><span class=main>(</span><span class=bound>s</span><span class=main>,</span> <span class=bound>as</span><span class=main>)</span><span class=main>.</span>  <span class=main>(</span><span class=bound>s</span> <span class=main>∈</span> valid_states <span class=free>PROB</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=bound>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span><span class=main>)</span><span class=main>}</span>
  "</span></span>
    <span class=keyword1><span class=command>using</span></span> MPLS_def 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>s</span></span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=tfree>'a</span><span class=main>,</span> bool<span class=main>)</span> fmap"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=skolem><span class=skolem>as</span></span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>(</span><span class=tfree>'a</span><span class=main>,</span> bool<span class=main>)</span> fmap <span class=main>×</span> <span class=main>(</span><span class=tfree>'a</span><span class=main>,</span> bool<span class=main>)</span> fmap<span class=main>)</span> list"</span></span> 
    <span class=keyword2><span class=keyword>where</span></span> obtain_s_as<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>∈</span> 
      <span class=main>(</span><span class=main>(</span><span class=main>λ</span> <span class=main>(</span><span class=bound>s</span><span class=main>,</span> <span class=bound>as</span><span class=main>)</span><span class=main>.</span> Inf <span class=main>(</span>PLS <span class=bound>s</span> <span class=bound>as</span><span class=main>)</span><span class=main>)</span> <span class=main>`</span> 
      <span class=main>{</span><span class=main>(</span><span class=bound>s</span><span class=main>,</span> <span class=bound>as</span><span class=main>)</span><span class=main>.</span> <span class=main>(</span><span class=bound>s</span> <span class=main>∈</span> valid_states <span class=free>PROB</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=bound>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span><span class=main>)</span><span class=main>}</span><span class=main>)</span>
    "</span></span>
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>2<span class=main>)</span> 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> 
    <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>∈</span> <span class=main>{</span>Inf <span class=main>(</span>PLS <span class=main>(</span>fst <span class=bound>p</span><span class=main>)</span> <span class=main>(</span>snd <span class=bound>p</span><span class=main>)</span><span class=main>)</span> <span class=main>|</span> <span class=bound>p</span><span class=main>.</span> <span class=main>(</span>fst <span class=bound>p</span> <span class=main>∈</span> valid_states <span class=free>PROB</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span>snd <span class=bound>p</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span><span class=main>)</span><span class=main>}</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>)</span> obtain_s_as 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> 
    <span class=quoted><span class=quoted>"<span class=main>∃</span> <span class=bound>p</span><span class=main>.</span> <span class=free>x</span> <span class=main>=</span> Inf <span class=main>(</span>PLS <span class=main>(</span>fst <span class=bound>p</span><span class=main>)</span> <span class=main>(</span>snd <span class=bound>p</span><span class=main>)</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span>fst <span class=bound>p</span> <span class=main>∈</span> valid_states <span class=free>PROB</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span>snd <span class=bound>p</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span><span class=main>)</span>"</span></span> 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>p</span></span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=tfree>'a</span><span class=main>,</span> bool<span class=main>)</span> fmap <span class=main>×</span> <span class=main>(</span><span class=main>(</span><span class=tfree>'a</span><span class=main>,</span> bool<span class=main>)</span> fmap <span class=main>×</span> <span class=main>(</span><span class=tfree>'a</span><span class=main>,</span> bool<span class=main>)</span> fmap<span class=main>)</span> list"</span></span> <span class=keyword2><span class=keyword>where</span></span> obtain_p<span class=main>:</span>
    <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>=</span> Inf <span class=main>(</span>PLS <span class=main>(</span>fst <span class=skolem>p</span><span class=main>)</span> <span class=main>(</span>snd <span class=skolem>p</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>fst <span class=skolem>p</span> <span class=main>∈</span> valid_states <span class=free>PROB</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>snd <span class=skolem>p</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span><span class=main>)</span>"</span></span> 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span> 
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fst <span class=skolem>p</span> <span class=main>∈</span> valid_states <span class=free>PROB</span>"</span></span> <span class=quoted><span class=quoted>"snd <span class=skolem>p</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> obtain_p 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span><span class=main><span class=keyword3>+</span></span>    
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>x'</span></span> <span class=main>::</span> <span class=quoted>nat</span> <span class=keyword2><span class=keyword>where</span></span> obtain_x'<span class=main>:</span>
    <span class=quoted><span class=quoted>"<span class=skolem>x'</span> <span class=main>∈</span> PLS <span class=main>(</span>fst <span class=skolem>p</span><span class=main>)</span> <span class=main>(</span>snd <span class=skolem>p</span><span class=main>)</span> <span class=main>∧</span> <span class=skolem>x'</span> <span class=main>≤</span> <span class=numeral>2</span> <span class=main>^</span> card <span class=main>(</span>prob_dom <span class=free>PROB</span><span class=main>)</span> <span class=main>-</span> <span class=main>1</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>)</span> in_PLS_leq_2_pow_n<span class=main>[</span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> s <span class=main><span class=main>=</span></span> <span class=quoted><span class=quoted>"fst <span class=skolem>p</span>"</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>and</span></span></span> as <span class=main><span class=main>=</span></span> <span class=quoted><span class=quoted>"snd <span class=skolem>p</span>"</span></span><span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>x'</span> <span class=main>≤</span> <span class=numeral>2</span> <span class=main>^</span> card <span class=main>(</span>prob_dom <span class=free>PROB</span><span class=main>)</span> <span class=main>-</span> <span class=main>1</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x'</span> <span class=main>∈</span> PLS <span class=main>(</span>fst <span class=skolem>p</span><span class=main>)</span> <span class=main>(</span>snd <span class=skolem>p</span><span class=main>)</span>"</span></span> 
    <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>=</span> Inf <span class=main>(</span>PLS <span class=main>(</span>fst <span class=skolem>p</span><span class=main>)</span> <span class=main>(</span>snd <span class=skolem>p</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"finite <span class=main>(</span>PLS <span class=main>(</span>fst <span class=skolem>p</span><span class=main>)</span> <span class=main>(</span>snd <span class=skolem>p</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> obtain_x' obtain_p finite_PLS 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span><span class=main><span class=keyword3>+</span></span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>≤</span> <span class=skolem>x'</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> 1<span class=main>(</span>2<span class=main>,</span> 4<span class=main>)</span> obtain_p<span class=main>(</span>1<span class=main>)</span> cInf_le_finite
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>x</span> <span class=main>≤</span> <span class=numeral>2</span> <span class=main>^</span> card <span class=main>(</span>prob_dom <span class=free>PROB</span><span class=main>)</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>linarith</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1 id=TopologicalProps-FINITE_MPLS><span class=command>lemma</span></span> FINITE_MPLS<span class=main>:</span> 
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"finite <span class=main>(</span><span class=free>Pi</span> <span class=main>::</span> <span class=tfree>'a</span> problem<span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"finite <span class=main>(</span>MPLS <span class=free>Pi</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>x</span> <span class=main>∈</span> MPLS <span class=free>Pi</span><span class=main>.</span> <span class=bound>x</span> <span class=main>≤</span> <span class=numeral>2</span> <span class=main>^</span> card <span class=main>(</span>prob_dom <span class=free>Pi</span><span class=main>)</span> <span class=main>-</span> <span class=main>1</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms in_MPLS_leq_2_pow_n
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"finite <span class=main>(</span>MPLS <span class=free>Pi</span><span class=main>)</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> mems_le_finite<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"MPLS <span class=free>Pi</span>"</span></span> <span class=quoted><span class=quoted>"<span class=numeral>2</span> <span class=main>^</span> card <span class=main>(</span>prob_dom <span class=free>Pi</span><span class=main>)</span> <span class=main>-</span> <span class=main>1</span>"</span></span><span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=comment1>― ‹NOTE 'fun' because of multiple defining equations.›</span>
<span class=keyword1><span class=command>fun</span></span> <span class=entity>statelist'</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>statelist'</span> <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=main>[]</span> <span class=main>=</span> <span class=main>[</span><span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>]</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>statelist'</span> <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=main>(</span><span class=free><span class=bound><span class=entity>a</span></span></span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>as</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>s</span></span></span> <span class=main>#</span> <span class=free>statelist'</span> <span class=main>(</span>state_succ <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=free><span class=bound><span class=entity>a</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>as</span></span></span><span class=main>)</span>"</span></span>


<span class=keyword1 id="TopologicalProps-LENGTH_statelist'"><span class=command>lemma</span></span> LENGTH_statelist'<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>as</span> <span class=free>s</span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"length <span class=main>(</span>statelist' <span class=free>s</span> <span class=free>as</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span>length <span class=free>as</span> <span class=main>+</span> <span class=main>1</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>as</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>s</span></span><span class=main>)</span> <span class=operator>auto</span>


<span class=keyword1 id="TopologicalProps-valid_path_statelist'"><span class=command>lemma</span></span> valid_path_statelist'<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>as</span> <span class=keyword2><span class=keyword>and</span></span> <span class=free>s</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=tfree>'a</span><span class=main>,</span> <span class=tfree>'b</span><span class=main>)</span> fmap"</span></span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>as</span> <span class=main>∈</span> valid_plans <span class=free>Pi</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>s</span> <span class=main>∈</span> valid_states <span class=free>Pi</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>valid_path <span class=free>Pi</span> <span class=main>(</span>statelist' <span class=free>s</span> <span class=free>as</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms 
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>as</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>s</span></span> <span class=quoted><span class=free>Pi</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> cons<span class=main>:</span> <span class=main>(</span>Cons <span class=skolem>a</span> <span class=skolem>as</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>a</span> <span class=main>∈</span> <span class=skolem>Pi</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>as</span> <span class=main>∈</span> valid_plans <span class=skolem>Pi</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> valid_plan_valid_head valid_plan_valid_tail 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span><span class=main><span class=keyword3>+</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>     
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=skolem>as</span></span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> Nil
    <span class=keyword1><span class=command>{</span></span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"state_succ <span class=skolem>s</span> <span class=skolem>a</span> <span class=main>∈</span> valid_states <span class=skolem>Pi</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> 1 cons.prems<span class=main>(</span>2<span class=main>)</span> valid_action_valid_succ
        <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"valid_path <span class=skolem>Pi</span> <span class=main>[</span>state_succ <span class=skolem>s</span> <span class=skolem>a</span><span class=main>]</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> 1 cons.prems<span class=main>(</span>2<span class=main>)</span> cons.IH
        <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
      <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>aa</span><span class=main>.</span> <span class=bound>aa</span> <span class=main>∈</span> <span class=skolem>Pi</span> <span class=main>∧</span> exec_plan <span class=skolem>s</span> <span class=main>[</span><span class=bound>aa</span><span class=main>]</span> <span class=main>=</span> state_succ <span class=skolem>s</span> <span class=skolem>a</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> 1<span class=main>(</span>1<span class=main>)</span> 
        <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
      <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"valid_path <span class=skolem>Pi</span> <span class=main>(</span>statelist' <span class=skolem>s</span> <span class=main>[</span><span class=skolem>a</span><span class=main>]</span><span class=main>)</span>"</span></span> 
        <span class=keyword1><span class=command>using</span></span> cons.prems<span class=main>(</span>2<span class=main>)</span>
        <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>}</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> 
      <span class=keyword1><span class=command>using</span></span> Nil
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>b</span> <span class=skolem>list</span><span class=main>)</span>
    <span class=keyword1><span class=command>{</span></span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>s</span> <span class=main>∈</span> valid_states <span class=skolem>Pi</span>"</span></span> 
        <span class=keyword1><span class=command>using</span></span> cons.prems<span class=main>(</span>2<span class=main>)</span>
        <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
          <span class=comment1>― ‹TODO this step is inefficient (~5s).›</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> 
        <span class=quoted><span class=quoted>"valid_path <span class=skolem>Pi</span> <span class=main>(</span>state_succ <span class=skolem>s</span> <span class=skolem>a</span> <span class=main>#</span> statelist' <span class=main>(</span>state_succ <span class=main>(</span>state_succ <span class=skolem>s</span> <span class=skolem>a</span><span class=main>)</span> <span class=skolem>b</span><span class=main>)</span> <span class=skolem>list</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> 1 cons.IH cons.prems<span class=main>(</span>2<span class=main>)</span> Cons lemma_1_i
        <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
      <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> 
        <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>aa</span> <span class=bound>b</span><span class=main>.</span> <span class=main>(</span><span class=bound>aa</span><span class=main>,</span> <span class=bound>b</span><span class=main>)</span> <span class=main>∈</span> <span class=skolem>Pi</span> <span class=main>∧</span> state_succ <span class=skolem>s</span> <span class=main>(</span><span class=bound>aa</span><span class=main>,</span> <span class=bound>b</span><span class=main>)</span> <span class=main>=</span> state_succ <span class=skolem>s</span> <span class=skolem>a</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> 1<span class=main>(</span>1<span class=main>)</span> surjective_pairing
        <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
      <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"valid_path <span class=skolem>Pi</span> <span class=main>(</span>statelist' <span class=skolem>s</span> <span class=main>(</span><span class=skolem>a</span> <span class=main>#</span> <span class=skolem>b</span> <span class=main>#</span> <span class=skolem>list</span><span class=main>)</span><span class=main>)</span>"</span></span> 
        <span class=keyword1><span class=command>using</span></span> cons.prems<span class=main>(</span>2<span class=main>)</span>
        <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>}</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> 
      <span class=keyword1><span class=command>using</span></span> Cons
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>qed</span></span> <span class=operator>simp</span>


<span class=comment1>― ‹TODO explicit proof.›</span>
<span class=keyword1 id="TopologicalProps-statelist'_exec_plan"><span class=command>lemma</span></span> statelist'_exec_plan<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>a</span> <span class=free>s</span> <span class=free>p</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>statelist' <span class=free>s</span> <span class=free>as</span> <span class=main>=</span> <span class=free>p</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>exec_plan <span class=free>s</span> <span class=free>as</span> <span class=main>=</span> last <span class=free>p</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms 
  <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>as</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>s</span></span> <span class=quoted><span class=free>p</span></span><span class=main>)</span>
   <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>auto</span><span class=main>)</span>
  <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=free>as</span>"</span></span><span class=main>)</span>
  <span class=keyword1><span class=command>by</span></span> 
    <span class=main>(</span><span class=operator>metis</span> LENGTH_statelist' One_nat_def add_Suc_right list.size<span class=main><span class=main>(</span></span>3<span class=main><span class=main>)</span></span> nat.simps<span class=main><span class=main>(</span></span>3<span class=main><span class=main>)</span></span><span class=main>)</span>
    <span class=main>(</span><span class=operator>metis</span> <span class=main><span class=main>(</span></span>no_types<span class=main><span class=main>)</span></span> LENGTH_statelist' One_nat_def add_Suc_right list.size<span class=main><span class=main>(</span></span>3<span class=main><span class=main>)</span></span> nat.simps<span class=main><span class=main>(</span></span>3<span class=main><span class=main>)</span></span><span class=main>)</span>


<span class=keyword1 id="TopologicalProps-statelist'_EQ_NIL"><span class=command>lemma</span></span> statelist'_EQ_NIL<span class=main>:</span> <span class=quoted><span class=quoted>"statelist' <span class=free>s</span> <span class=free>as</span> <span class=main>≠</span> <span class=main>[]</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=free>as</span></span><span class=main>)</span> <span class=operator>auto</span>


<span class=comment1>― ‹NOTE added lemma.›</span>
<span class=keyword1 id="TopologicalProps-statelist'_TAKE_i"><span class=command>lemma</span></span> statelist'_TAKE_i<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"Suc <span class=free>m</span> <span class=main>≤</span> length <span class=main>(</span><span class=free>a</span> <span class=main>#</span> <span class=free>as</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=free>m</span> <span class=main>≤</span> length <span class=free>as</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms 
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>as</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>a</span></span> <span class=quoted><span class=free>m</span></span><span class=main>)</span> <span class=operator>auto</span>

<span class=keyword1 id="TopologicalProps-statelist'_TAKE"><span class=command>lemma</span></span> statelist'_TAKE<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>as</span> <span class=free>s</span> <span class=free>p</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>statelist' <span class=free>s</span> <span class=free>as</span> <span class=main>=</span> <span class=free>p</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>n</span><span class=main>.</span> <span class=bound>n</span> <span class=main>≤</span> length <span class=free>as</span> <span class=main>⟶</span> <span class=main>(</span>exec_plan <span class=free>s</span> <span class=main>(</span>take <span class=bound>n</span> <span class=free>as</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=free>p</span> <span class=main>!</span> <span class=bound>n</span><span class=main>)</span><span class=main>)</span>"</span></span> 
  <span class=keyword1><span class=command>using</span></span> assms
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>as</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>s</span></span> <span class=quoted><span class=free>p</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> Nil
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>n</span>
    <span class=keyword3><span class=command>assume</span></span> P1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>n</span> <span class=main>≤</span> length <span class=main>[]</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"exec_plan <span class=skolem>s</span> <span class=main>(</span>take <span class=skolem>n</span> <span class=main>[]</span><span class=main>)</span> <span class=main>=</span> <span class=skolem>s</span>"</span></span> 
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>p</span> <span class=main>!</span> <span class=main>0</span> <span class=main>=</span> <span class=skolem>s</span>"</span></span> 
      <span class=keyword1><span class=command>using</span></span> Nil.prems 
      <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
    <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"exec_plan <span class=skolem>s</span> <span class=main>(</span>take <span class=skolem>n</span> <span class=main>[]</span><span class=main>)</span> <span class=main>=</span> <span class=skolem>p</span> <span class=main>!</span> <span class=skolem>n</span>"</span></span> 
      <span class=keyword1><span class=command>using</span></span> P1
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>a</span> <span class=skolem>as</span><span class=main>)</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>n</span>
    <span class=keyword3><span class=command>assume</span></span> P2<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>n</span> <span class=main>≤</span> length <span class=main>(</span><span class=skolem>a</span> <span class=main>#</span> <span class=skolem>as</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"exec_plan <span class=skolem>s</span> <span class=main>(</span>take <span class=skolem>n</span> <span class=main>(</span><span class=skolem>a</span> <span class=main>#</span> <span class=skolem>as</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=skolem>p</span> <span class=main>!</span> <span class=skolem>n</span>"</span></span> 
      <span class=keyword1><span class=command>using</span></span> Cons.prems 
    <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=skolem>n</span> <span class=main>=</span> <span class=main>0</span>"</span></span><span class=main>)</span>
      <span class=keyword3><span class=command>case</span></span> False
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>m</span></span> <span class=keyword2><span class=keyword>where</span></span> a<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>n</span> <span class=main>=</span> Suc <span class=skolem>m</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> not0_implies_Suc
        <span class=keyword1><span class=command>by</span></span> <span class=operator>presburger</span>
      <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> b<span class=main>:</span> <span class=quoted><span class=quoted>"statelist' <span class=skolem>s</span> <span class=main>(</span><span class=skolem>a</span> <span class=main>#</span> <span class=skolem>as</span><span class=main>)</span> <span class=main>!</span> <span class=skolem>n</span> <span class=main>=</span> statelist' <span class=main>(</span>state_succ <span class=skolem>s</span> <span class=skolem>a</span><span class=main>)</span> <span class=skolem>as</span> <span class=main>!</span> <span class=skolem>m</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> a nth_Cons_Suc
        <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
      <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> c<span class=main>:</span> <span class=quoted><span class=quoted>"exec_plan <span class=skolem>s</span> <span class=main>(</span>take <span class=skolem>n</span> <span class=main>(</span><span class=skolem>a</span> <span class=main>#</span> <span class=skolem>as</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> exec_plan <span class=main>(</span>state_succ <span class=skolem>s</span> <span class=skolem>a</span><span class=main>)</span> <span class=main>(</span>take <span class=skolem>m</span> <span class=skolem>as</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> a
        <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
      <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>m</span> <span class=main>≤</span> length <span class=skolem>as</span>"</span></span> 
        <span class=keyword1><span class=command>using</span></span> a P2 statelist'_TAKE_i
        <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
      <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> 
        <span class=quoted><span class=quoted>"exec_plan <span class=main>(</span>state_succ <span class=skolem>s</span> <span class=skolem>a</span><span class=main>)</span> <span class=main>(</span>take <span class=skolem>m</span> <span class=skolem>as</span><span class=main>)</span> <span class=main>=</span> statelist' <span class=main>(</span>state_succ <span class=skolem>s</span> <span class=skolem>a</span><span class=main>)</span> <span class=skolem>as</span> <span class=main>!</span> <span class=skolem>m</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> calculation<span class=main>(</span>2<span class=main>,</span> 3<span class=main>,</span> 4<span class=main>)</span> Cons.IH
        <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> 
        <span class=keyword1><span class=command>using</span></span> Cons.prems
        <span class=keyword1><span class=command>by</span></span> <span class=operator>argo</span>
    <span class=keyword1><span class=command>qed</span></span> <span class=operator>fastforce</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1 id=TopologicalProps-MPLS_nempty><span class=command>lemma</span></span> MPLS_nempty<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>(</span><span class=tfree>'a</span><span class=main>,</span> <span class=tfree>'b</span><span class=main>)</span> fmap <span class=main>×</span> <span class=main>(</span><span class=tfree>'a</span><span class=main>,</span> <span class=tfree>'b</span><span class=main>)</span> fmap<span class=main>)</span> set"</span></span> 
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"finite <span class=free>PROB</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"MPLS <span class=free>PROB</span> <span class=main>≠</span> <span class=main>{}</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?S</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>{</span><span class=main>(</span><span class=bound>s</span><span class=main>,</span> <span class=bound>as</span><span class=main>)</span><span class=main>.</span> <span class=bound>s</span> <span class=main>∈</span> valid_states <span class=free>PROB</span> <span class=main>∧</span> <span class=bound>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span><span class=main>}</span>"</span></span>
    <span class=comment1>― ‹NOTE type of 's' had to be fixed for 'valid\_states\_nempty'.›</span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>s</span></span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=tfree>'a</span><span class=main>,</span> <span class=tfree>'b</span><span class=main>)</span> fmap"</span></span>  <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>s</span> <span class=main>∈</span> valid_states <span class=free>PROB</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms valid_states_nempty
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>[]</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> empty_plan_is_valid
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>s</span><span class=main>,</span> <span class=main>[]</span><span class=main>)</span> <span class=main>∈</span> <span class=var>?S</span>"</span></span> 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> 
    <span class=keyword1><span class=command>unfolding</span></span> MPLS_def
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1><span class=command>theorem</span></span> bound_main_lemma<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> problem"</span></span> 
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"finite <span class=free>PROB</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>problem_plan_bound <span class=free>PROB</span> <span class=main>≤</span> <span class=main>(</span><span class=numeral>2</span> <span class=main>^</span> <span class=main>(</span>card <span class=main>(</span>prob_dom <span class=free>PROB</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"MPLS <span class=free>PROB</span> <span class=main>≠</span> <span class=main>{}</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms MPLS_nempty
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>x</span><span class=main>.</span> <span class=bound>x</span> <span class=main>∈</span> MPLS <span class=free>PROB</span> <span class=main>⟶</span> <span class=bound>x</span> <span class=main>≤</span> <span class=numeral>2</span> <span class=main>^</span> card <span class=main>(</span>prob_dom <span class=free>PROB</span><span class=main>)</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms in_MPLS_leq_2_pow_n
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>unfolding</span></span> problem_plan_bound_def
    <span class=keyword1><span class=command>using</span></span> cSup_least 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=comment1>― ‹NOTE types in premise had to be fixed to be able to match `valid\_as\_valid\_exec`.›</span>
<span class=keyword1 id=TopologicalProps-bound_child_parent_card_state_set_cons><span class=command>lemma</span></span> bound_child_parent_card_state_set_cons<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>P</span> <span class=free>f</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=main>(</span><span class=bound>PROB</span> <span class=main>::</span> <span class=tfree>'a</span> problem<span class=main>)</span> <span class=bound>as</span> <span class=main>(</span><span class=bound>s</span> <span class=main>::</span> <span class=tfree>'a</span> state<span class=main>)</span><span class=main>.</span> 
    <span class=main>(</span><span class=free>P</span> <span class=bound>PROB</span><span class=main>)</span> 
    <span class=main>∧</span> <span class=main>(</span><span class=bound>as</span> <span class=main>∈</span> valid_plans <span class=bound>PROB</span><span class=main>)</span> 
    <span class=main>∧</span> <span class=main>(</span><span class=bound>s</span> <span class=main>∈</span> valid_states <span class=bound>PROB</span><span class=main>)</span> 
    <span class=main>⟶</span> <span class=main>(</span><span class=main>∃</span><span class=bound>as'</span><span class=main>.</span> 
      <span class=main>(</span>exec_plan <span class=bound>s</span> <span class=bound>as</span> <span class=main>=</span> exec_plan <span class=bound>s</span> <span class=bound>as'</span><span class=main>)</span> 
      <span class=main>∧</span> <span class=main>(</span>subseq <span class=bound>as'</span> <span class=bound>as</span><span class=main>)</span> 
      <span class=main>∧</span> <span class=main>(</span>length <span class=bound>as'</span> <span class=main>&lt;</span> <span class=free>f</span> <span class=bound>PROB</span><span class=main>)</span>
    <span class=main>)</span>
  <span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>PROB</span> <span class=bound>s</span> <span class=bound>as</span><span class=main>.</span> 
    <span class=main>(</span><span class=free>P</span> <span class=bound>PROB</span><span class=main>)</span>
    <span class=main>∧</span> <span class=main>(</span><span class=bound>as</span> <span class=main>∈</span> valid_plans <span class=bound>PROB</span><span class=main>)</span>
    <span class=main>∧</span> <span class=main>(</span><span class=bound>s</span> <span class=main>∈</span> <span class=main>(</span>valid_states <span class=bound>PROB</span><span class=main>)</span><span class=main>)</span>
    <span class=main>⟶</span> <span class=main>(</span><span class=main>∃</span><span class=bound>x</span><span class=main>.</span> 
      <span class=main>(</span><span class=bound>x</span> <span class=main>∈</span> PLS <span class=bound>s</span> <span class=bound>as</span><span class=main>)</span> 
      <span class=main>∧</span> <span class=main>(</span><span class=bound>x</span> <span class=main>&lt;</span> <span class=free>f</span> <span class=bound>PROB</span><span class=main>)</span>
    <span class=main>)</span>
  <span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>PROB</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> problem"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=skolem>as</span> <span class=keyword2><span class=keyword>and</span></span> <span class=skolem>s</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> state"</span></span>
    <span class=keyword3><span class=command>assume</span></span> P1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>P</span> <span class=skolem>PROB</span><span class=main>)</span>"</span></span> 
      <span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>as</span> <span class=main>∈</span> valid_plans <span class=skolem>PROB</span><span class=main>)</span>"</span></span>
      <span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>s</span> <span class=main>∈</span> valid_states <span class=skolem>PROB</span><span class=main>)</span>"</span></span> 
      <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>as'</span><span class=main>.</span> 
        <span class=main>(</span>exec_plan <span class=skolem>s</span> <span class=skolem>as</span> <span class=main>=</span> exec_plan <span class=skolem>s</span> <span class=bound>as'</span><span class=main>)</span> 
        <span class=main>∧</span> <span class=main>(</span>subseq <span class=bound>as'</span> <span class=skolem>as</span><span class=main>)</span> 
        <span class=main>∧</span> <span class=main>(</span>length <span class=bound>as'</span> <span class=main>&lt;</span> <span class=free>f</span> <span class=skolem>PROB</span><span class=main>)</span>
      <span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>exec_plan <span class=skolem>s</span> <span class=skolem>as</span> <span class=main>∈</span> valid_states <span class=skolem>PROB</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> assms P1 valid_as_valid_exec
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>P</span> <span class=skolem>PROB</span><span class=main>)</span>
      <span class=main>∧</span> <span class=main>(</span><span class=skolem>as</span> <span class=main>∈</span> valid_plans <span class=skolem>PROB</span><span class=main>)</span>
      <span class=main>∧</span> <span class=main>(</span><span class=skolem>s</span> <span class=main>∈</span> <span class=main>(</span>valid_states <span class=skolem>PROB</span><span class=main>)</span><span class=main>)</span>
      <span class=main>⟶</span> <span class=main>(</span><span class=main>∃</span><span class=bound>x</span><span class=main>.</span> 
        <span class=main>(</span><span class=bound>x</span> <span class=main>∈</span> PLS <span class=skolem>s</span> <span class=skolem>as</span><span class=main>)</span> 
        <span class=main>∧</span> <span class=main>(</span><span class=bound>x</span> <span class=main>&lt;</span> <span class=free>f</span> <span class=skolem>PROB</span><span class=main>)</span>
      <span class=main>)</span>
    "</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> PLS_def 
      <span class=keyword1><span class=command>using</span></span> P1 
      <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>PROB</span> <span class=bound>s</span> <span class=bound>as</span><span class=main>.</span> 
    <span class=main>(</span><span class=free>P</span> <span class=bound>PROB</span><span class=main>)</span>
    <span class=main>∧</span> <span class=main>(</span><span class=bound>as</span> <span class=main>∈</span> valid_plans <span class=bound>PROB</span><span class=main>)</span>
    <span class=main>∧</span> <span class=main>(</span><span class=bound>s</span> <span class=main>∈</span> <span class=main>(</span>valid_states <span class=bound>PROB</span><span class=main>)</span><span class=main>)</span>
    <span class=main>⟶</span> <span class=main>(</span><span class=main>∃</span><span class=bound>x</span><span class=main>.</span> 
      <span class=main>(</span><span class=bound>x</span> <span class=main>∈</span> PLS <span class=bound>s</span> <span class=bound>as</span><span class=main>)</span> 
      <span class=main>∧</span> <span class=main>(</span><span class=bound>x</span> <span class=main>&lt;</span> <span class=free>f</span> <span class=bound>PROB</span><span class=main>)</span>
    <span class=main>)</span>
  <span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=comment1>― ‹NOTE types of premise had to be fixed to be able to use lemma `bound\_child\_parent\_card\_state\_set\_cons`.›</span>
<span class=keyword1 id=TopologicalProps-bound_on_all_plans_bounds_MPLS><span class=command>lemma</span></span> bound_on_all_plans_bounds_MPLS<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>P</span> <span class=free>f</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=main>(</span><span class=bound>PROB</span> <span class=main>::</span> <span class=tfree>'a</span> problem<span class=main>)</span> <span class=bound>as</span> <span class=main>(</span><span class=bound>s</span> <span class=main>::</span> <span class=tfree>'a</span> state<span class=main>)</span><span class=main>.</span>
    <span class=main>(</span><span class=free>P</span> <span class=bound>PROB</span><span class=main>)</span> 
    <span class=main>∧</span> <span class=main>(</span><span class=bound>s</span> <span class=main>∈</span> valid_states <span class=bound>PROB</span><span class=main>)</span> 
    <span class=main>∧</span> <span class=main>(</span><span class=bound>as</span> <span class=main>∈</span> valid_plans <span class=bound>PROB</span><span class=main>)</span> 
    <span class=main>⟶</span> <span class=main>(</span><span class=main>∃</span><span class=bound>as'</span><span class=main>.</span> 
      <span class=main>(</span>exec_plan <span class=bound>s</span> <span class=bound>as</span> <span class=main>=</span> exec_plan <span class=bound>s</span> <span class=bound>as'</span><span class=main>)</span> 
      <span class=main>∧</span> <span class=main>(</span>subseq <span class=bound>as'</span> <span class=bound>as</span><span class=main>)</span> 
      <span class=main>∧</span> <span class=main>(</span>length <span class=bound>as'</span> <span class=main>&lt;</span> <span class=free>f</span> <span class=bound>PROB</span><span class=main>)</span>
    <span class=main>)</span>
  <span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>PROB</span> <span class=bound>x</span><span class=main>.</span> <span class=free>P</span> <span class=bound>PROB</span>
    <span class=main>⟶</span> <span class=main>(</span><span class=bound>x</span> <span class=main>∈</span> MPLS<span class=main>(</span><span class=bound>PROB</span><span class=main>)</span><span class=main>)</span> 
    <span class=main>⟶</span> <span class=main>(</span><span class=bound>x</span> <span class=main>&lt;</span> <span class=free>f</span> <span class=bound>PROB</span><span class=main>)</span>
  <span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>PROB</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> problem"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=skolem>as</span> <span class=keyword2><span class=keyword>and</span></span> <span class=skolem>s</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> state"</span></span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>P</span> <span class=skolem>PROB</span><span class=main>)</span>"</span></span>
      <span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>s</span> <span class=main>∈</span> valid_states <span class=skolem>PROB</span><span class=main>)</span>"</span></span>
      <span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>as</span> <span class=main>∈</span> valid_plans <span class=skolem>PROB</span><span class=main>)</span>"</span></span>
      <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>as'</span><span class=main>.</span> 
        <span class=main>(</span>exec_plan <span class=skolem>s</span> <span class=skolem>as</span> <span class=main>=</span> exec_plan <span class=skolem>s</span> <span class=bound>as'</span><span class=main>)</span> 
        <span class=main>∧</span> <span class=main>(</span>subseq <span class=bound>as'</span> <span class=skolem>as</span><span class=main>)</span> 
        <span class=main>∧</span> <span class=main>(</span>length <span class=bound>as'</span> <span class=main>&lt;</span> <span class=free>f</span> <span class=skolem>PROB</span><span class=main>)</span>
      <span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>x</span><span class=main>.</span> <span class=bound>x</span> <span class=main>∈</span> PLS <span class=skolem>s</span> <span class=skolem>as</span> <span class=main>∧</span> <span class=bound>x</span> <span class=main>&lt;</span> <span class=free>f</span> <span class=skolem>PROB</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>)</span> bound_child_parent_card_state_set_cons<span class=main>[</span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> P <span class=main><span class=main>=</span></span> <span class=quoted><span class=free>P</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>and</span></span></span> f <span class=main><span class=main>=</span></span> <span class=quoted><span class=free>f</span></span><span class=main>]</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>presburger</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>note</span></span> 1 <span class=main>=</span> this
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>PROB</span> <span class=skolem>x</span>
    <span class=keyword3><span class=command>assume</span></span> P1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>P</span> <span class=skolem>PROB</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> MPLS <span class=skolem>PROB</span>"</span></span>
      <span class=comment1>― ‹TODO refactor 'x\_in\_MPLS\_if' and use here.›</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>s</span></span> <span class=skolem><span class=skolem>as</span></span> <span class=keyword2><span class=keyword>where</span></span> a<span class=main>:</span>
      <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>=</span> Inf <span class=main>(</span>PLS <span class=skolem>s</span> <span class=skolem>as</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>s</span> <span class=main>∈</span> valid_states <span class=skolem>PROB</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>as</span> <span class=main>∈</span> valid_plans <span class=skolem>PROB</span>"</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> MPLS_def
      <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>as'</span><span class=main>.</span> 
      <span class=main>(</span>exec_plan <span class=skolem>s</span> <span class=skolem>as</span> <span class=main>=</span> exec_plan <span class=skolem>s</span> <span class=bound>as'</span><span class=main>)</span> 
      <span class=main>∧</span> <span class=main>(</span>subseq <span class=bound>as'</span> <span class=skolem>as</span><span class=main>)</span> 
      <span class=main>∧</span> <span class=main>(</span>length <span class=bound>as'</span> <span class=main>&lt;</span> <span class=free>f</span> <span class=skolem>PROB</span><span class=main>)</span>
    <span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> P1<span class=main>(</span>1<span class=main>)</span> assms calculation<span class=main>(</span>2<span class=main>,</span> 3<span class=main>)</span> 
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>x'</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x'</span> <span class=main>∈</span> PLS <span class=skolem>s</span> <span class=skolem>as</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x'</span> <span class=main>&lt;</span> <span class=free>f</span> <span class=skolem>PROB</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> P1 1
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>&lt;</span> <span class=free>f</span> <span class=skolem>PROB</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> a<span class=main>(</span>1<span class=main>)</span> mem_lt_imp_MIN_lt
      <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1 id=TopologicalProps-bound_child_parent_card_state_set_cons_finite><span class=command>lemma</span></span> bound_child_parent_card_state_set_cons_finite<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>P</span> <span class=free>f</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>PROB</span> <span class=bound>as</span> <span class=bound>s</span><span class=main>.</span>
    <span class=free>P</span> <span class=bound>PROB</span> <span class=main>∧</span> finite <span class=bound>PROB</span> <span class=main>∧</span> <span class=bound>as</span> <span class=main>∈</span> <span class=main>(</span>valid_plans <span class=bound>PROB</span><span class=main>)</span> <span class=main>∧</span> <span class=bound>s</span> <span class=main>∈</span> <span class=main>(</span>valid_states <span class=bound>PROB</span><span class=main>)</span> 
    <span class=main>⟶</span> <span class=main>(</span><span class=main>∃</span><span class=bound>as'</span><span class=main>.</span> 
      <span class=main>(</span>exec_plan <span class=bound>s</span> <span class=bound>as</span> <span class=main>=</span> exec_plan <span class=bound>s</span> <span class=bound>as'</span><span class=main>)</span> 
      <span class=main>∧</span> subseq <span class=bound>as'</span> <span class=bound>as</span> 
      <span class=main>∧</span> length <span class=bound>as'</span> <span class=main>&lt;</span> <span class=free>f</span><span class=main>(</span><span class=bound>PROB</span><span class=main>)</span>
    <span class=main>)</span>
  <span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>PROB</span> <span class=bound>s</span> <span class=bound>as</span><span class=main>.</span> 
    <span class=free>P</span> <span class=bound>PROB</span> <span class=main>∧</span> finite <span class=bound>PROB</span> <span class=main>∧</span> <span class=bound>as</span> <span class=main>∈</span> <span class=main>(</span>valid_plans <span class=bound>PROB</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=bound>s</span> <span class=main>∈</span> <span class=main>(</span>valid_states <span class=bound>PROB</span><span class=main>)</span><span class=main>)</span>
    <span class=main>⟶</span> <span class=main>(</span><span class=main>∃</span><span class=bound>x</span><span class=main>.</span> <span class=main>(</span><span class=bound>x</span> <span class=main>∈</span> PLS <span class=bound>s</span> <span class=bound>as</span><span class=main>)</span> <span class=main>∧</span> <span class=bound>x</span> <span class=main>&lt;</span> <span class=free>f</span> <span class=bound>PROB</span><span class=main>)</span>
  <span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>PROB</span> <span class=skolem>s</span> <span class=skolem>as</span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=free>P</span> <span class=skolem>PROB</span>"</span></span> <span class=quoted><span class=quoted>"finite <span class=skolem>PROB</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>as</span> <span class=main>∈</span> <span class=main>(</span>valid_plans <span class=skolem>PROB</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>s</span> <span class=main>∈</span> <span class=main>(</span>valid_states <span class=skolem>PROB</span><span class=main>)</span>"</span></span>
      <span class=quoted><span class=quoted>" <span class=main>(</span><span class=main>∃</span><span class=bound>as'</span><span class=main>.</span> 
        <span class=main>(</span>exec_plan <span class=skolem>s</span> <span class=skolem>as</span> <span class=main>=</span> exec_plan <span class=skolem>s</span> <span class=bound>as'</span><span class=main>)</span> 
        <span class=main>∧</span> subseq <span class=bound>as'</span> <span class=skolem>as</span> 
        <span class=main>∧</span> length <span class=bound>as'</span> <span class=main>&lt;</span> <span class=free>f</span> <span class=skolem>PROB</span>
      <span class=main>)</span>"</span></span>
      <span class=comment1>(* NOTE[1]
        moreover have "exec_plan s as ∈ valid_states PROB" 
          using calculation valid_as_valid_exec by blast
    *)</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>as'</span></span> <span class=keyword2><span class=keyword>where</span></span> 
      <span class=quoted><span class=quoted>"<span class=main>(</span>exec_plan <span class=skolem>s</span> <span class=skolem>as</span> <span class=main>=</span> exec_plan <span class=skolem>s</span> <span class=skolem>as'</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"subseq <span class=skolem>as'</span> <span class=skolem>as</span>"</span></span> <span class=quoted><span class=quoted>"length <span class=skolem>as'</span> <span class=main>&lt;</span> <span class=free>f</span> <span class=skolem>PROB</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"length <span class=skolem>as'</span> <span class=main>∈</span> PLS <span class=skolem>s</span> <span class=skolem>as</span>"</span></span> 
      <span class=keyword1><span class=command>unfolding</span></span> PLS_def
      <span class=keyword1><span class=command>using</span></span> calculation
      <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
    <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>x</span><span class=main>.</span> <span class=main>(</span><span class=bound>x</span> <span class=main>∈</span> PLS <span class=skolem>s</span> <span class=skolem>as</span><span class=main>)</span> <span class=main>∧</span> <span class=bound>x</span> <span class=main>&lt;</span> <span class=free>f</span> <span class=skolem>PROB</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>PROB</span> <span class=bound>s</span> <span class=bound>as</span><span class=main>.</span> 
    <span class=free>P</span> <span class=bound>PROB</span>  
    <span class=main>∧</span> finite <span class=bound>PROB</span>
    <span class=main>∧</span> <span class=bound>as</span> <span class=main>∈</span> <span class=main>(</span>valid_plans <span class=bound>PROB</span><span class=main>)</span>
    <span class=main>∧</span> <span class=main>(</span><span class=bound>s</span> <span class=main>∈</span> <span class=main>(</span>valid_states <span class=bound>PROB</span><span class=main>)</span><span class=main>)</span>
    <span class=main>⟶</span> <span class=main>(</span><span class=main>∃</span><span class=bound>x</span><span class=main>.</span> <span class=main>(</span><span class=bound>x</span> <span class=main>∈</span> PLS <span class=bound>s</span> <span class=bound>as</span><span class=main>)</span> <span class=main>∧</span> <span class=bound>x</span> <span class=main>&lt;</span> <span class=free>f</span> <span class=bound>PROB</span><span class=main>)</span>
  <span class=main>)</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> assms
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1 id=TopologicalProps-bound_on_all_plans_bounds_MPLS_finite><span class=command>lemma</span></span> bound_on_all_plans_bounds_MPLS_finite<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>P</span> <span class=free>f</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>PROB</span> <span class=bound>as</span> <span class=bound>s</span><span class=main>.</span> 
    <span class=free>P</span> <span class=bound>PROB</span> <span class=main>∧</span> finite <span class=bound>PROB</span> <span class=main>∧</span> <span class=bound>s</span> <span class=main>∈</span> <span class=main>(</span>valid_states <span class=bound>PROB</span><span class=main>)</span> <span class=main>∧</span> <span class=bound>as</span> <span class=main>∈</span> <span class=main>(</span>valid_plans <span class=bound>PROB</span><span class=main>)</span> 
    <span class=main>⟶</span> <span class=main>(</span><span class=main>∃</span><span class=bound>as'</span><span class=main>.</span> 
      <span class=main>(</span>exec_plan <span class=bound>s</span> <span class=bound>as</span> <span class=main>=</span> exec_plan <span class=bound>s</span> <span class=bound>as'</span><span class=main>)</span> 
      <span class=main>∧</span> subseq <span class=bound>as'</span> <span class=bound>as</span> 
      <span class=main>∧</span> length <span class=bound>as'</span> <span class=main>&lt;</span> <span class=free>f</span><span class=main>(</span><span class=bound>PROB</span><span class=main>)</span>
    <span class=main>)</span>
  <span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>PROB</span> <span class=bound>x</span><span class=main>.</span> 
    <span class=free>P</span> <span class=bound>PROB</span> <span class=main>∧</span> finite <span class=bound>PROB</span> 
    <span class=main>⟶</span> <span class=main>(</span><span class=bound>x</span> <span class=main>∈</span> MPLS <span class=bound>PROB</span><span class=main>)</span>
    <span class=main>⟶</span> <span class=bound>x</span> <span class=main>&lt;</span> <span class=free>f</span> <span class=bound>PROB</span>
  <span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>PROB</span> <span class=skolem>x</span>
    <span class=keyword3><span class=command>assume</span></span> P1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>P</span> <span class=skolem>PROB</span>"</span></span> <span class=quoted><span class=quoted>"finite <span class=skolem>PROB</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> MPLS <span class=skolem>PROB</span>"</span></span>
      <span class=comment1>― ‹TODO refactor 'x\_in\_MPLS\_if' and use here.›</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>s</span></span> <span class=skolem><span class=skolem>as</span></span> <span class=keyword2><span class=keyword>where</span></span> a<span class=main>:</span>
      <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>=</span> Inf <span class=main>(</span>PLS <span class=skolem>s</span> <span class=skolem>as</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>s</span> <span class=main>∈</span> valid_states <span class=skolem>PROB</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>as</span> <span class=main>∈</span> valid_plans <span class=skolem>PROB</span>"</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> MPLS_def
      <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>as'</span><span class=main>.</span> 
      <span class=main>(</span>exec_plan <span class=skolem>s</span> <span class=skolem>as</span> <span class=main>=</span> exec_plan <span class=skolem>s</span> <span class=bound>as'</span><span class=main>)</span> 
      <span class=main>∧</span> <span class=main>(</span>subseq <span class=bound>as'</span> <span class=skolem>as</span><span class=main>)</span> 
      <span class=main>∧</span> <span class=main>(</span>length <span class=bound>as'</span> <span class=main>&lt;</span> <span class=free>f</span> <span class=skolem>PROB</span><span class=main>)</span>
    <span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> P1<span class=main>(</span>1<span class=main>,</span> 2<span class=main>)</span> assms calculation<span class=main>(</span>2<span class=main>,</span> 3<span class=main>)</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>x'</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x'</span> <span class=main>∈</span> PLS <span class=skolem>s</span> <span class=skolem>as</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x'</span> <span class=main>&lt;</span> <span class=free>f</span> <span class=skolem>PROB</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> PLS_def calculation<span class=main>(</span>4<span class=main>)</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span> 
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>&lt;</span> <span class=free>f</span> <span class=skolem>PROB</span>"</span></span> 
      <span class=keyword1><span class=command>using</span></span> a<span class=main>(</span>1<span class=main>)</span> mem_lt_imp_MIN_lt 
      <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>using</span></span> assms
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1 id=TopologicalProps-bound_on_all_plans_bounds_problem_plan_bound><span class=command>lemma</span></span> bound_on_all_plans_bounds_problem_plan_bound<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>P</span> <span class=free>f</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>PROB</span> <span class=bound>as</span> <span class=bound>s</span><span class=main>.</span> 
    <span class=main>(</span><span class=free>P</span> <span class=bound>PROB</span><span class=main>)</span> 
    <span class=main>∧</span> finite <span class=bound>PROB</span>
    <span class=main>∧</span> <span class=main>(</span><span class=bound>s</span> <span class=main>∈</span> valid_states <span class=bound>PROB</span><span class=main>)</span> 
    <span class=main>∧</span> <span class=main>(</span><span class=bound>as</span> <span class=main>∈</span> valid_plans <span class=bound>PROB</span><span class=main>)</span> 
    <span class=main>⟶</span> <span class=main>(</span><span class=main>∃</span><span class=bound>as'</span><span class=main>.</span> 
      <span class=main>(</span>exec_plan <span class=bound>s</span> <span class=bound>as</span> <span class=main>=</span> exec_plan <span class=bound>s</span> <span class=bound>as'</span><span class=main>)</span>
      <span class=main>∧</span> <span class=main>(</span>subseq <span class=bound>as'</span> <span class=bound>as</span><span class=main>)</span>
      <span class=main>∧</span> <span class=main>(</span>length <span class=bound>as'</span> <span class=main>&lt;</span> <span class=free>f</span> <span class=bound>PROB</span><span class=main>)</span>
    <span class=main>)</span>
  <span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>PROB</span><span class=main>.</span> 
    <span class=main>(</span><span class=free>P</span> <span class=bound>PROB</span><span class=main>)</span> 
    <span class=main>∧</span> finite <span class=bound>PROB</span>
    <span class=main>⟶</span> <span class=main>(</span>problem_plan_bound <span class=bound>PROB</span> <span class=main>&lt;</span> <span class=free>f</span> <span class=bound>PROB</span><span class=main>)</span>
  <span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>PROB</span> <span class=bound>x</span><span class=main>.</span> 
    <span class=free>P</span> <span class=bound>PROB</span> 
    <span class=main>∧</span> finite <span class=bound>PROB</span> 
    <span class=main>⟶</span> <span class=bound>x</span> <span class=main>∈</span> MPLS <span class=bound>PROB</span>   
    <span class=main>⟶</span> <span class=bound>x</span> <span class=main>&lt;</span> <span class=free>f</span> <span class=bound>PROB</span>
  "</span></span>
    <span class=keyword1><span class=command>using</span></span> assms bound_on_all_plans_bounds_MPLS_finite
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>PROB</span> <span class=skolem>x</span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=free>P</span> <span class=skolem>PROB</span> <span class=main>∧</span> finite <span class=skolem>PROB</span> 
      <span class=main>⟶</span> <span class=skolem>x</span> <span class=main>∈</span> MPLS <span class=skolem>PROB</span>   
      <span class=main>⟶</span> <span class=skolem>x</span> <span class=main>&lt;</span> <span class=free>f</span> <span class=skolem>PROB</span>
    "</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>PROB</span><span class=main>.</span>
      <span class=free>P</span> <span class=bound>PROB</span> <span class=main>∧</span> finite <span class=bound>PROB</span> 
      <span class=main>⟶</span> problem_plan_bound <span class=bound>PROB</span> <span class=main>&lt;</span> <span class=free>f</span> <span class=bound>PROB</span>
    "</span></span> 
      <span class=keyword1><span class=command>unfolding</span></span> problem_plan_bound_def
      <span class=keyword1><span class=command>using</span></span> 1 bound_child_parent_not_eq_last_diff_paths 1 MPLS_nempty
      <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>PROB</span><span class=main>.</span>
      <span class=free>P</span> <span class=bound>PROB</span> <span class=main>∧</span> finite <span class=bound>PROB</span> 
      <span class=main>⟶</span> problem_plan_bound <span class=bound>PROB</span> <span class=main>&lt;</span> <span class=free>f</span> <span class=bound>PROB</span>
    "</span></span> 
      <span class=keyword1><span class=command>using</span></span> MPLS_nempty
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span> 

  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>PROB</span><span class=main>.</span> 
    <span class=main>(</span><span class=free>P</span> <span class=bound>PROB</span><span class=main>)</span> 
    <span class=main>∧</span> finite <span class=bound>PROB</span>
    <span class=main>⟶</span> <span class=main>(</span>problem_plan_bound <span class=bound>PROB</span> <span class=main>&lt;</span> <span class=free>f</span> <span class=bound>PROB</span><span class=main>)</span>
  <span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> 1
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1 id=TopologicalProps-bound_child_parent_card_state_set_cons_thesis><span class=command>lemma</span></span> bound_child_parent_card_state_set_cons_thesis<span class=main>:</span> 
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"finite <span class=free>PROB</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>as</span> <span class=bound>s</span><span class=main>.</span> 
    <span class=bound>as</span> <span class=main>∈</span> <span class=main>(</span>valid_plans <span class=free>PROB</span><span class=main>)</span> 
    <span class=main>∧</span> <span class=bound>s</span> <span class=main>∈</span> <span class=main>(</span>valid_states <span class=free>PROB</span><span class=main>)</span> 
    <span class=main>⟶</span> <span class=main>(</span><span class=main>∃</span><span class=bound>as'</span><span class=main>.</span> 
      <span class=main>(</span>exec_plan <span class=bound>s</span> <span class=bound>as</span> <span class=main>=</span> exec_plan <span class=bound>s</span> <span class=bound>as'</span><span class=main>)</span>
      <span class=main>∧</span> subseq <span class=bound>as'</span> <span class=bound>as</span> 
      <span class=main>∧</span> length <span class=bound>as'</span> <span class=main>&lt;</span> <span class=free>k</span>
    <span class=main>)</span> 
  <span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>as</span> <span class=main>∈</span> <span class=main>(</span>valid_plans <span class=free>PROB</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>s</span> <span class=main>∈</span> <span class=main>(</span>valid_states <span class=free>PROB</span><span class=main>)</span><span class=main>)</span>"</span></span> 
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>x</span><span class=main>.</span> <span class=main>(</span><span class=bound>x</span> <span class=main>∈</span> PLS <span class=free>s</span> <span class=free>as</span><span class=main>)</span> <span class=main>∧</span> <span class=bound>x</span> <span class=main>&lt;</span> <span class=free>k</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> PLS_def 
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>


<span class=comment1>― ‹NOTE added lemma.›</span>
<span class=comment1>― ‹TODO refactor/move up.›</span>
<span class=keyword1 id=TopologicalProps-x_in_MPLS_if><span class=command>lemma</span></span> x_in_MPLS_if<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>x</span> <span class=free>PROB</span> 
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>∈</span> MPLS <span class=free>PROB</span>"</span></span>  
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>s</span> <span class=bound>as</span><span class=main>.</span> <span class=bound>s</span> <span class=main>∈</span> valid_states <span class=free>PROB</span> <span class=main>∧</span> <span class=bound>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span> <span class=main>∧</span> <span class=free>x</span> <span class=main>=</span> Inf <span class=main>(</span>PLS <span class=bound>s</span> <span class=bound>as</span><span class=main>)</span>"</span></span> 
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>unfolding</span></span> MPLS_def
  <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>

<span class=keyword1 id=TopologicalProps-bound_on_all_plans_bounds_MPLS_thesis><span class=command>lemma</span></span> bound_on_all_plans_bounds_MPLS_thesis<span class=main>:</span> 
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"finite <span class=free>PROB</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>as</span> <span class=bound>s</span><span class=main>.</span> 
    <span class=main>(</span><span class=bound>s</span> <span class=main>∈</span> valid_states <span class=free>PROB</span><span class=main>)</span> 
    <span class=main>∧</span> <span class=main>(</span><span class=bound>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span><span class=main>)</span>
    <span class=main>⟶</span> <span class=main>(</span><span class=main>∃</span><span class=bound>as'</span><span class=main>.</span> 
      <span class=main>(</span>exec_plan <span class=bound>s</span> <span class=bound>as</span> <span class=main>=</span> exec_plan <span class=bound>s</span> <span class=bound>as'</span><span class=main>)</span> 
      <span class=main>∧</span> <span class=main>(</span>subseq <span class=bound>as'</span> <span class=bound>as</span><span class=main>)</span>
      <span class=main>∧</span> <span class=main>(</span>length <span class=bound>as'</span> <span class=main>&lt;</span> <span class=free>k</span><span class=main>)</span>
    <span class=main>)</span>
  <span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>x</span> <span class=main>∈</span> MPLS <span class=free>PROB</span><span class=main>)</span>"</span></span> 
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>x</span> <span class=main>&lt;</span> <span class=free>k</span><span class=main>)</span>"</span></span> 
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>s</span></span> <span class=skolem><span class=skolem>as</span></span> <span class=keyword2><span class=keyword>where</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>s</span> <span class=main>∈</span> valid_states <span class=free>PROB</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>=</span> Inf <span class=main>(</span>PLS <span class=skolem>s</span> <span class=skolem>as</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>3<span class=main>)</span> x_in_MPLS_if 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>x'</span></span> <span class=main>::</span> <span class=quoted>nat</span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x'</span> <span class=main>∈</span> PLS <span class=skolem>s</span> <span class=skolem>as</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x'</span> <span class=main>&lt;</span> <span class=free>k</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>,</span> 2<span class=main>)</span> bound_child_parent_card_state_set_cons_thesis 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Inf <span class=main>(</span>PLS <span class=skolem>s</span> <span class=skolem>as</span><span class=main>)</span> <span class=main>&lt;</span> <span class=free>k</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> mem_lt_imp_MIN_lt 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>&lt;</span> <span class=free>k</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> 1
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=comment1>― ‹NOTE added lemma.›</span>
<span class=keyword1 id=TopologicalProps-bounded_MPLS_contains_supremum><span class=command>lemma</span></span> bounded_MPLS_contains_supremum<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"finite <span class=free>PROB</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>k</span><span class=main>.</span> <span class=main>∀</span><span class=bound>x</span> <span class=main>∈</span> MPLS <span class=free>PROB</span><span class=main>.</span> <span class=bound>x</span> <span class=main>&lt;</span> <span class=bound>k</span><span class=main>)</span>"</span></span> 
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"Sup <span class=main>(</span>MPLS <span class=free>PROB</span><span class=main>)</span> <span class=main>∈</span> MPLS <span class=free>PROB</span>"</span></span> 
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>k</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>x</span> <span class=main>∈</span> MPLS <span class=free>PROB</span><span class=main>.</span> <span class=bound>x</span> <span class=main>&lt;</span> <span class=skolem>k</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>2<span class=main>)</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"finite <span class=main>(</span>MPLS <span class=free>PROB</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>2<span class=main>)</span> finite_nat_set_iff_bounded
    <span class=keyword1><span class=command>by</span></span> <span class=operator>presburger</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"MPLS <span class=free>PROB</span> <span class=main>≠</span> <span class=main>{}</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>)</span> MPLS_nempty
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"Sup <span class=main>(</span>MPLS <span class=free>PROB</span><span class=main>)</span> <span class=main>∈</span> MPLS <span class=free>PROB</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> Sup_nat_def
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id="TopologicalProps-bound_on_all_plans_bounds_problem_plan_bound_thesis'"><span class=command>lemma</span></span> bound_on_all_plans_bounds_problem_plan_bound_thesis'<span class=main>:</span> 
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"finite <span class=free>PROB</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>as</span> <span class=bound>s</span><span class=main>.</span> 
      <span class=bound>s</span> <span class=main>∈</span> <span class=main>(</span>valid_states <span class=free>PROB</span><span class=main>)</span> 
      <span class=main>∧</span> <span class=bound>as</span> <span class=main>∈</span> <span class=main>(</span>valid_plans <span class=free>PROB</span><span class=main>)</span>
      <span class=main>⟶</span> <span class=main>(</span><span class=main>∃</span><span class=bound>as'</span><span class=main>.</span> 
        <span class=main>(</span>exec_plan <span class=bound>s</span> <span class=bound>as</span> <span class=main>=</span> exec_plan <span class=bound>s</span> <span class=bound>as'</span><span class=main>)</span> 
        <span class=main>∧</span> subseq <span class=bound>as'</span> <span class=bound>as</span> 
        <span class=main>∧</span> length <span class=bound>as'</span> <span class=main>&lt;</span> <span class=free>k</span>
      <span class=main>)</span>
    <span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"problem_plan_bound <span class=free>PROB</span> <span class=main>&lt;</span> <span class=free>k</span>"</span></span> 
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>x</span> <span class=main>∈</span> MPLS <span class=free>PROB</span><span class=main>.</span> <span class=bound>x</span> <span class=main>&lt;</span> <span class=free>k</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>,</span> 2<span class=main>)</span> bound_on_all_plans_bounds_MPLS_thesis 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Sup <span class=main>(</span>MPLS <span class=free>PROB</span><span class=main>)</span> <span class=main>∈</span> MPLS <span class=free>PROB</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>)</span> bounded_MPLS_contains_supremum 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Sup <span class=main>(</span>MPLS <span class=free>PROB</span><span class=main>)</span> <span class=main>&lt;</span> <span class=free>k</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> 1
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> 
    <span class=keyword1><span class=command>unfolding</span></span> problem_plan_bound_def
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1 id=TopologicalProps-bound_on_all_plans_bounds_problem_plan_bound_thesis><span class=command>lemma</span></span> bound_on_all_plans_bounds_problem_plan_bound_thesis<span class=main>:</span> 
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"finite <span class=free>PROB</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>as</span> <span class=bound>s</span><span class=main>.</span> 
      <span class=main>(</span><span class=bound>s</span> <span class=main>∈</span> valid_states <span class=free>PROB</span><span class=main>)</span> 
      <span class=main>∧</span> <span class=main>(</span><span class=bound>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span><span class=main>)</span> 
      <span class=main>⟶</span> <span class=main>(</span><span class=main>∃</span><span class=bound>as'</span><span class=main>.</span> 
        <span class=main>(</span>exec_plan <span class=bound>s</span> <span class=bound>as</span> <span class=main>=</span> exec_plan <span class=bound>s</span> <span class=bound>as'</span><span class=main>)</span> 
        <span class=main>∧</span> <span class=main>(</span>subseq <span class=bound>as'</span> <span class=bound>as</span><span class=main>)</span>
        <span class=main>∧</span> <span class=main>(</span>length <span class=bound>as'</span> <span class=main>≤</span> <span class=free>k</span><span class=main>)</span>
      <span class=main>)</span>
    <span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>problem_plan_bound <span class=free>PROB</span> <span class=main>≤</span> <span class=free>k</span><span class=main>)</span>"</span></span> 
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>x</span><span class=main>∈</span>MPLS <span class=free>PROB</span><span class=main>.</span> <span class=bound>x</span> <span class=main>&lt;</span> <span class=free>k</span> <span class=main>+</span> <span class=main>1</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>,</span> 2<span class=main>)</span> bound_on_all_plans_bounds_MPLS_thesis<span class=main>[</span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> k <span class=main><span class=main>=</span></span> <span class=quoted><span class=quoted>"<span class=free>k</span> <span class=main>+</span> <span class=main>1</span>"</span></span><span class=main>]</span> Suc_eq_plus1 
      less_Suc_eq_le
    <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Sup <span class=main>(</span>MPLS <span class=free>PROB</span><span class=main>)</span> <span class=main>∈</span> MPLS <span class=free>PROB</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>)</span> bounded_MPLS_contains_supremum 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>problem_plan_bound <span class=free>PROB</span> <span class=main>≤</span> <span class=free>k</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> problem_plan_bound_def 
    <span class=keyword1><span class=command>using</span></span> 1
    <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1 id=TopologicalProps-bound_on_all_plans_bounds_problem_plan_bound_><span class=command>lemma</span></span>  bound_on_all_plans_bounds_problem_plan_bound_<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>P</span> <span class=free>f</span> <span class=free>PROB</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>PROB'</span> <span class=bound>as</span> <span class=bound>s</span><span class=main>.</span> 
      finite <span class=free>PROB</span> <span class=main>∧</span> <span class=main>(</span><span class=free>P</span> <span class=bound>PROB'</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=bound>s</span> <span class=main>∈</span> valid_states <span class=bound>PROB'</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=bound>as</span> <span class=main>∈</span> valid_plans <span class=bound>PROB'</span><span class=main>)</span> 
      <span class=main>⟶</span> <span class=main>(</span><span class=main>∃</span><span class=bound>as'</span><span class=main>.</span> 
        <span class=main>(</span>exec_plan <span class=bound>s</span> <span class=bound>as</span> <span class=main>=</span> exec_plan <span class=bound>s</span> <span class=bound>as'</span><span class=main>)</span> 
        <span class=main>∧</span> <span class=main>(</span>subseq <span class=bound>as'</span> <span class=bound>as</span><span class=main>)</span>
        <span class=main>∧</span> <span class=main>(</span>length <span class=bound>as'</span> <span class=main>&lt;</span> <span class=free>f</span> <span class=bound>PROB'</span><span class=main>)</span>
      <span class=main>)</span>
    <span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>P</span> <span class=free>PROB</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"finite <span class=free>PROB</span>"</span></span> 
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>problem_plan_bound <span class=free>PROB</span> <span class=main>&lt;</span> <span class=free>f</span> <span class=free>PROB</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> problem_plan_bound_def MPLS_def
  <span class=keyword1><span class=command>using</span></span> assms bound_on_all_plans_bounds_problem_plan_bound_thesis' expanded_problem_plan_bound_thm_1
  <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>


<span class=keyword1 id=TopologicalProps-S_VALID_AS_VALID_IMP_MIN_IN_PLS><span class=command>lemma</span></span> S_VALID_AS_VALID_IMP_MIN_IN_PLS<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=free>s</span> <span class=free>as</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>s</span> <span class=main>∈</span> valid_states <span class=free>PROB</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span><span class=main>)</span>"</span></span> 
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>Inf <span class=main>(</span>PLS <span class=free>s</span> <span class=free>as</span><span class=main>)</span> <span class=main>∈</span> <span class=main>(</span>MPLS <span class=free>PROB</span><span class=main>)</span><span class=main>)</span>"</span></span> 
  <span class=keyword1><span class=command>unfolding</span></span> MPLS_def
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>


<span class=comment1>― ‹NOTE type of `s` had to be fixed (type mismatch in goal).›</span>
<span class=comment1>― ‹NOTE premises rewritten to implications for proof set up.›</span>
<span class=keyword1 id=TopologicalProps-problem_plan_bound_ge_min_pls><span class=command>lemma</span></span> problem_plan_bound_ge_min_pls<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> problem"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=free>s</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> state"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=free>as</span> <span class=free>k</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"finite <span class=free>PROB</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>s</span> <span class=main>∈</span> valid_states <span class=free>PROB</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span><span class=main>)</span>"</span></span> 
    <span class=quoted><span class=quoted>"<span class=main>(</span>problem_plan_bound <span class=free>PROB</span> <span class=main>≤</span> <span class=free>k</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>Inf <span class=main>(</span>PLS <span class=free>s</span> <span class=free>as</span><span class=main>)</span> <span class=main>≤</span> problem_plan_bound <span class=free>PROB</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Inf <span class=main>(</span>PLS <span class=free>s</span> <span class=free>as</span><span class=main>)</span> <span class=main>∈</span> MPLS <span class=free>PROB</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>2<span class=main>,</span> 3<span class=main>)</span> S_VALID_AS_VALID_IMP_MIN_IN_PLS 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"finite <span class=main>(</span>MPLS <span class=free>PROB</span><span class=main>)</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>)</span> FINITE_MPLS 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Inf <span class=main>(</span>PLS <span class=free>s</span> <span class=free>as</span><span class=main>)</span> <span class=main>≤</span> Sup <span class=main>(</span>MPLS <span class=free>PROB</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> le_cSup_finite
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span> 
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> 
    <span class=keyword1><span class=command>unfolding</span></span> problem_plan_bound_def
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1 id=TopologicalProps-PLS_NEMPTY><span class=command>lemma</span></span>  PLS_NEMPTY<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>s</span> <span class=free>as</span> 
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"PLS <span class=free>s</span> <span class=free>as</span> <span class=main>≠</span> <span class=main>{}</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> PLS_def
  <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>


<span class=keyword1 id=TopologicalProps-PLS_nempty_and_has_min><span class=command>lemma</span></span>  PLS_nempty_and_has_min<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>s</span> <span class=free>as</span> 
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>x</span><span class=main>.</span> <span class=main>(</span><span class=bound>x</span> <span class=main>∈</span> PLS <span class=free>s</span> <span class=free>as</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=bound>x</span> <span class=main>=</span> Inf <span class=main>(</span>PLS <span class=free>s</span> <span class=free>as</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"PLS <span class=free>s</span> <span class=free>as</span> <span class=main>≠</span> <span class=main>{}</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> PLS_NEMPTY 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Inf <span class=main>(</span>PLS <span class=free>s</span> <span class=free>as</span><span class=main>)</span> <span class=main>∈</span> PLS <span class=free>s</span> <span class=free>as</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> Inf_nat_def
    <span class=keyword1><span class=command>using</span></span> LeastI_ex Max_in finite_PLS
    <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span> 
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1 id=TopologicalProps-PLS_works><span class=command>lemma</span></span>  PLS_works<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>x</span> <span class=free>s</span> <span class=free>as</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>x</span> <span class=main>∈</span> PLS <span class=free>s</span> <span class=free>as</span><span class=main>)</span>"</span></span> 
  <span class=keyword2><span class=keyword>shows</span></span><span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>as'</span><span class=main>.</span> 
      <span class=main>(</span>exec_plan <span class=free>s</span> <span class=free>as</span> <span class=main>=</span> exec_plan <span class=free>s</span> <span class=bound>as'</span><span class=main>)</span>
      <span class=main>∧</span> <span class=main>(</span>length <span class=bound>as'</span> <span class=main>=</span> <span class=free>x</span><span class=main>)</span> 
      <span class=main>∧</span> <span class=main>(</span>subseq <span class=bound>as'</span> <span class=free>as</span><span class=main>)</span>
    <span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>unfolding</span></span> PLS_def
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>smt</span> imageE mem_Collect_eq<span class=main>)</span>


<span class=comment1>― ‹NOTE type of `s` had to be fixed (type mismatch in goal).›</span>
<span class=keyword1 id=TopologicalProps-problem_plan_bound_works><span class=command>lemma</span></span> problem_plan_bound_works<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> problem"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=free>as</span> <span class=keyword2><span class=keyword>and</span></span> <span class=free>s</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> state"</span></span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"finite <span class=free>PROB</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>s</span> <span class=main>∈</span> valid_states <span class=free>PROB</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span><span class=main>)</span>"</span></span> 
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>as'</span><span class=main>.</span> 
      <span class=main>(</span>exec_plan <span class=free>s</span> <span class=free>as</span> <span class=main>=</span> exec_plan <span class=free>s</span> <span class=bound>as'</span><span class=main>)</span> 
      <span class=main>∧</span> <span class=main>(</span>subseq <span class=bound>as'</span> <span class=free>as</span><span class=main>)</span>
      <span class=main>∧</span> <span class=main>(</span>length <span class=bound>as'</span> <span class=main>≤</span> problem_plan_bound <span class=free>PROB</span><span class=main>)</span>
    <span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"problem_plan_bound <span class=free>PROB</span> <span class=main>≤</span> <span class=numeral>2</span> <span class=main>^</span> card <span class=main>(</span>prob_dom <span class=free>PROB</span><span class=main>)</span> <span class=main>-</span> <span class=main>1</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>)</span> bound_main_lemma 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"Inf <span class=main>(</span>PLS <span class=free>s</span> <span class=free>as</span><span class=main>)</span> <span class=main>≤</span> problem_plan_bound <span class=free>PROB</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> 
      assms<span class=main>(</span>1<span class=main>,</span> 2<span class=main>,</span> 3<span class=main>)</span>
      problem_plan_bound_ge_min_pls
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>x</span><span class=main>.</span> <span class=bound>x</span> <span class=main>∈</span> PLS <span class=free>s</span> <span class=free>as</span> <span class=main>∧</span> <span class=bound>x</span> <span class=main>=</span> Inf <span class=main>(</span>PLS <span class=free>s</span> <span class=free>as</span><span class=main>)</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> PLS_nempty_and_has_min
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span> 
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Inf <span class=main>(</span>PLS <span class=free>s</span> <span class=free>as</span><span class=main>)</span> <span class=main>∈</span> <span class=main>(</span>PLS <span class=free>s</span> <span class=free>as</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span> 
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>as'</span></span> <span class=keyword2><span class=keyword>where</span></span> 2<span class=main>:</span>
    <span class=quoted><span class=quoted>"exec_plan <span class=free>s</span> <span class=free>as</span> <span class=main>=</span> exec_plan <span class=free>s</span> <span class=skolem>as'</span>"</span></span> <span class=quoted><span class=quoted>"length <span class=skolem>as'</span> <span class=main>=</span> Inf <span class=main>(</span>PLS <span class=free>s</span> <span class=free>as</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"subseq <span class=skolem>as'</span> <span class=free>as</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> PLS_works
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"length <span class=skolem>as'</span> <span class=main>≤</span> problem_plan_bound <span class=free>PROB</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> 1
    <span class=keyword1><span class=command>by</span></span> <span class=operator>argo</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>as'</span><span class=main>.</span> 
    <span class=main>(</span>exec_plan <span class=free>s</span> <span class=free>as</span> <span class=main>=</span> exec_plan <span class=free>s</span> <span class=bound>as'</span><span class=main>)</span> 
    <span class=main>∧</span> <span class=main>(</span>subseq <span class=bound>as'</span> <span class=free>as</span><span class=main>)</span>
    <span class=main>∧</span> <span class=main>(</span>length <span class=bound>as'</span> <span class=main>≤</span> problem_plan_bound <span class=free>PROB</span><span class=main>)</span>
  <span class=main>)</span>"</span></span>  
    <span class=keyword1><span class=command>using</span></span> 2<span class=main>(</span>1<span class=main>)</span> 2<span class=main>(</span>3<span class=main>)</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=comment1>― ‹NOTE name shortened.›</span>
<span class=keyword1><span class=command>definition</span></span> <span class=entity>MPLS_s</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>MPLS_s</span> <span class=free><span class=bound><span class=entity>PROB</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=main>≡</span> <span class=main>(</span><span class=main>λ</span> <span class=main>(</span><span class=bound>s</span><span class=main>,</span> <span class=bound>as</span><span class=main>)</span><span class=main>.</span> Inf <span class=main>(</span>PLS <span class=bound>s</span> <span class=bound>as</span><span class=main>)</span><span class=main>)</span> <span class=main>`</span> <span class=main>{</span><span class=main>(</span><span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>,</span> <span class=bound>as</span><span class=main>)</span> <span class=main>|</span> <span class=bound>as</span><span class=main>.</span> <span class=bound>as</span> <span class=main>∈</span> valid_plans <span class=free><span class=bound><span class=entity>PROB</span></span></span><span class=main>}</span>"</span></span>


<span class=comment1>― ‹NOTE type of `PROB` had to be fixed (type mismatch in goal).›</span>
<span class=keyword1 id=TopologicalProps-bound_main_lemma_s_3><span class=command>lemma</span></span> bound_main_lemma_s_3<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>(</span><span class=tfree>'a</span><span class=main>,</span> <span class=tfree>'b</span><span class=main>)</span> fmap <span class=main>×</span> <span class=main>(</span><span class=tfree>'a</span><span class=main>,</span> <span class=tfree>'b</span><span class=main>)</span> fmap<span class=main>)</span> set"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=free>s</span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"MPLS_s <span class=free>PROB</span> <span class=free>s</span> <span class=main>≠</span> <span class=main>{}</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=comment1>― ‹TODO <span class=antiquoted><span class=antiquote>@{</span><span class=operator>term</span> <span class=quoted>"<span class=main>(</span><span class=free>s</span><span class=main>,</span> <span class=main>[]</span><span class=main>)</span> <span class=main>∈</span> <span class=main>{}</span>"</span><span class=antiquote>}</span></span> could be refactored (this is used in 'MPLS\_nempty' too).›</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>[]</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> empty_plan_is_valid 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>s</span><span class=main>,</span> <span class=main>[]</span><span class=main>)</span> <span class=main>∈</span> <span class=main>{</span><span class=main>(</span><span class=bound>s</span><span class=main>,</span> <span class=bound>as</span><span class=main>)</span><span class=main>.</span> <span class=bound>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span><span class=main>}</span>"</span></span> 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"MPLS_s <span class=free>PROB</span> <span class=free>s</span> <span class=main>≠</span> <span class=main>{}</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> MPLS_s_def
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=comment1>― ‹NOTE name shortened.›</span>
<span class=keyword1><span class=command>definition</span></span> <span class=entity>problem_plan_bound_s</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>problem_plan_bound_s</span> <span class=free><span class=bound><span class=entity>PROB</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=main>=</span> Sup <span class=main>(</span>MPLS_s <span class=free><span class=bound><span class=entity>PROB</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>)</span>"</span></span>


<span class=comment1>― ‹NOTE removed typing from assumption due to matching problems in later proofs.›</span>
<span class=keyword1 id=TopologicalProps-bound_on_all_plans_bounds_PLS_s><span class=command>lemma</span></span>  bound_on_all_plans_bounds_PLS_s<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>P</span> <span class=free>f</span> 
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>PROB</span> <span class=bound>as</span> <span class=bound>s</span><span class=main>.</span>  
    finite <span class=bound>PROB</span> <span class=main>∧</span> <span class=main>(</span><span class=free>P</span> <span class=bound>PROB</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=bound>as</span> <span class=main>∈</span> valid_plans <span class=bound>PROB</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=bound>s</span> <span class=main>∈</span> valid_states <span class=bound>PROB</span><span class=main>)</span> 
    <span class=main>⟶</span> <span class=main>(</span><span class=main>∃</span><span class=bound>as'</span><span class=main>.</span> 
      <span class=main>(</span>exec_plan <span class=bound>s</span> <span class=bound>as</span> <span class=main>=</span> exec_plan <span class=bound>s</span> <span class=bound>as'</span><span class=main>)</span>
      <span class=main>∧</span> <span class=main>(</span>subseq <span class=bound>as'</span> <span class=bound>as</span><span class=main>)</span>
      <span class=main>∧</span> <span class=main>(</span>length <span class=bound>as'</span> <span class=main>&lt;</span> <span class=free>f</span> <span class=bound>PROB</span> <span class=bound>s</span><span class=main>)</span>
    <span class=main>)</span>
  <span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>PROB</span> <span class=bound>s</span> <span class=bound>as</span><span class=main>.</span> 
    finite <span class=bound>PROB</span> <span class=main>∧</span> <span class=main>(</span><span class=free>P</span> <span class=bound>PROB</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=bound>as</span> <span class=main>∈</span> valid_plans <span class=bound>PROB</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=bound>s</span> <span class=main>∈</span> valid_states <span class=bound>PROB</span><span class=main>)</span>
    <span class=main>⟶</span> <span class=main>(</span><span class=main>∃</span><span class=bound>x</span><span class=main>.</span> 
      <span class=main>(</span><span class=bound>x</span> <span class=main>∈</span> PLS <span class=bound>s</span> <span class=bound>as</span><span class=main>)</span> 
      <span class=main>∧</span> <span class=main>(</span><span class=bound>x</span> <span class=main>&lt;</span> <span class=free>f</span> <span class=bound>PROB</span> <span class=bound>s</span><span class=main>)</span>
    <span class=main>)</span>
  <span class=main>)</span>"</span></span>

  <span class=keyword1><span class=command>using</span></span> assms 
  <span class=keyword1><span class=command>unfolding</span></span> PLS_def
  <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>


<span class=comment1>― ‹NOTE added lemma.›</span>
<span class=keyword1 id=TopologicalProps-bound_on_all_plans_bounds_MPLS_s_i><span class=command>lemma</span></span> bound_on_all_plans_bounds_MPLS_s_i<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=free>s</span> <span class=free>x</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>s</span> <span class=main>∈</span> valid_states <span class=free>PROB</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>∈</span> MPLS_s <span class=free>PROB</span> <span class=free>s</span>"</span></span> 
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>as</span><span class=main>.</span> <span class=free>x</span> <span class=main>=</span> Inf <span class=main>(</span>PLS <span class=free>s</span> <span class=bound>as</span><span class=main>)</span> <span class=main>∧</span> <span class=bound>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span>"</span></span> 
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?S</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>{</span><span class=main>(</span><span class=free>s</span><span class=main>,</span> <span class=bound>as</span><span class=main>)</span> <span class=main>|</span> <span class=bound>as</span><span class=main>.</span> <span class=bound>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span><span class=main>}</span>"</span></span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>x'</span></span> <span class=keyword2><span class=keyword>where</span></span> 1<span class=main>:</span> 
    <span class=quoted><span class=quoted>"<span class=skolem>x'</span> <span class=main>∈</span> <span class=var>?S</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>=</span> <span class=main>(</span><span class=main>λ</span> <span class=main>(</span><span class=bound>s</span><span class=main>,</span> <span class=bound>as</span><span class=main>)</span><span class=main>.</span> Inf <span class=main>(</span>PLS <span class=bound>s</span> <span class=bound>as</span><span class=main>)</span><span class=main>)</span> <span class=skolem>x'</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms 
    <span class=keyword1><span class=command>unfolding</span></span> MPLS_s_def
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?as</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"snd <span class=skolem>x'</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?s</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"fst <span class=skolem>x'</span>"</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> 1<span class=main>(</span>1<span class=main>)</span> 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?s</span> <span class=main>=</span> <span class=free>s</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> 1<span class=main>(</span>1<span class=main>)</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>=</span> Inf <span class=main>(</span>PLS <span class=var>?s</span> <span class=var>?as</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> 1<span class=main>(</span>2<span class=main>)</span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> case_prod_unfold<span class=main>)</span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=TopologicalProps-bound_on_all_plans_bounds_MPLS_s><span class=command>lemma</span></span> bound_on_all_plans_bounds_MPLS_s<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>P</span> <span class=free>f</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>PROB</span> <span class=bound>as</span> <span class=bound>s</span><span class=main>.</span>
    finite <span class=bound>PROB</span> <span class=main>∧</span> <span class=main>(</span><span class=free>P</span> <span class=bound>PROB</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=bound>as</span> <span class=main>∈</span> valid_plans <span class=bound>PROB</span><span class=main>)</span>  <span class=main>∧</span> <span class=main>(</span><span class=bound>s</span> <span class=main>∈</span> valid_states <span class=bound>PROB</span><span class=main>)</span>
    <span class=main>⟶</span> <span class=main>(</span><span class=main>∃</span><span class=bound>as'</span><span class=main>.</span> 
      <span class=main>(</span>exec_plan <span class=bound>s</span> <span class=bound>as</span> <span class=main>=</span> exec_plan <span class=bound>s</span> <span class=bound>as'</span><span class=main>)</span> 
      <span class=main>∧</span> <span class=main>(</span>subseq <span class=bound>as'</span> <span class=bound>as</span><span class=main>)</span>
      <span class=main>∧</span> <span class=main>(</span>length <span class=bound>as'</span> <span class=main>&lt;</span> <span class=free>f</span> <span class=bound>PROB</span> <span class=bound>s</span><span class=main>)</span>
    <span class=main>)</span>
  <span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>PROB</span> <span class=bound>x</span> <span class=bound>s</span><span class=main>.</span> 
    finite <span class=bound>PROB</span> <span class=main>∧</span> <span class=main>(</span><span class=free>P</span> <span class=bound>PROB</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=bound>s</span> <span class=main>∈</span> valid_states <span class=bound>PROB</span><span class=main>)</span> <span class=main>⟶</span> <span class=main>(</span><span class=bound>x</span> <span class=main>∈</span> MPLS_s <span class=bound>PROB</span> <span class=bound>s</span><span class=main>)</span> 
     <span class=main>⟶</span> <span class=main>(</span><span class=bound>x</span> <span class=main>&lt;</span> <span class=free>f</span> <span class=bound>PROB</span> <span class=bound>s</span><span class=main>)</span>
  <span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>unfolding</span></span> MPLS_def

<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>PROB</span> <span class=bound>s</span> <span class=bound>as</span><span class=main>.</span>
     finite <span class=bound>PROB</span> <span class=main>∧</span> <span class=free>P</span> <span class=bound>PROB</span> <span class=main>∧</span> <span class=bound>as</span> <span class=main>∈</span> valid_plans <span class=bound>PROB</span> <span class=main>∧</span> <span class=bound>s</span> <span class=main>∈</span> valid_states <span class=bound>PROB</span> <span class=main>⟶</span>
     <span class=main>(</span><span class=main>∃</span><span class=bound>x</span><span class=main>.</span> <span class=bound>x</span> <span class=main>∈</span> PLS <span class=bound>s</span> <span class=bound>as</span> <span class=main>∧</span> <span class=bound>x</span> <span class=main>&lt;</span> <span class=free>f</span> <span class=bound>PROB</span> <span class=bound>s</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> bound_on_all_plans_bounds_PLS_s<span class=main>[</span><span class=operator>OF</span> assms<span class=main>]</span> <span class=keyword1><span class=command>.</span></span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>PROB</span> <span class=skolem>x</span> <span class=keyword2><span class=keyword>and</span></span> <span class=skolem>s</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=tfree>'a</span><span class=main>,</span> <span class=tfree>'b</span><span class=main>)</span> fmap"</span></span>
    <span class=keyword3><span class=command>assume</span></span> P1<span class=main>:</span> <span class=quoted><span class=quoted>"finite <span class=skolem>PROB</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>P</span> <span class=skolem>PROB</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>s</span> <span class=main>∈</span> valid_states <span class=skolem>PROB</span><span class=main>)</span>"</span></span> 
    <span class=keyword1><span class=command>{</span></span>
      <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>x</span> <span class=main>∈</span> MPLS_s <span class=skolem>PROB</span> <span class=skolem>s</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>as</span></span> <span class=keyword2><span class=keyword>where</span></span> i<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>=</span> Inf <span class=main>(</span>PLS <span class=skolem>s</span> <span class=skolem>as</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>as</span> <span class=main>∈</span> valid_plans <span class=skolem>PROB</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> P1 bound_on_all_plans_bounds_MPLS_s_i
        <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>x'</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x'</span> <span class=main>∈</span> PLS <span class=skolem>s</span> <span class=skolem>as</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x'</span> <span class=main>&lt;</span> <span class=free>f</span> <span class=skolem>PROB</span> <span class=skolem>s</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> P1 i 1
        <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>&lt;</span> <span class=free>f</span> <span class=skolem>PROB</span> <span class=skolem>s</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> mem_lt_imp_MIN_lt i<span class=main>(</span>1<span class=main>)</span> 
        <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span> 
    <span class=keyword1><span class=command>}</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>x</span> <span class=main>∈</span> MPLS_s <span class=skolem>PROB</span> <span class=skolem>s</span><span class=main>)</span> <span class=main>⟶</span> <span class=main>(</span><span class=skolem>x</span> <span class=main>&lt;</span> <span class=free>f</span> <span class=skolem>PROB</span> <span class=skolem>s</span><span class=main>)</span>"</span></span> 
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=comment1>― ‹NOTE added lemma.›</span>
<span class=keyword1 id=TopologicalProps-Sup_MPLS_s_lt_if><span class=command>lemma</span></span> Sup_MPLS_s_lt_if<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=free>s</span> <span class=free>k</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>x</span><span class=main>∈</span>MPLS_s <span class=free>PROB</span> <span class=free>s</span><span class=main>.</span> <span class=bound>x</span> <span class=main>&lt;</span> <span class=free>k</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"Sup <span class=main>(</span>MPLS_s <span class=free>PROB</span> <span class=free>s</span><span class=main>)</span> <span class=main>&lt;</span> <span class=free>k</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"MPLS_s <span class=free>PROB</span> <span class=free>s</span> <span class=main>≠</span> <span class=main>{}</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> bound_main_lemma_s_3
    <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Sup <span class=main>(</span>MPLS_s <span class=free>PROB</span> <span class=free>s</span><span class=main>)</span> <span class=main>∈</span> MPLS_s <span class=free>PROB</span> <span class=free>s</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms Sup_nat_def bounded_nat_set_is_finite
    <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"Sup <span class=main>(</span>MPLS_s <span class=free>PROB</span> <span class=free>s</span><span class=main>)</span> <span class=main>&lt;</span> <span class=free>k</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=comment1>― ‹NOTE type of `P` had to be fixed (type mismatch in goal).›</span>
<span class=keyword1 id=TopologicalProps-bound_child_parent_lemma_s_2><span class=command>lemma</span></span> bound_child_parent_lemma_s_2<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> problem"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=free>P</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> problem <span class=main>⇒</span> bool"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=free>s</span> <span class=free>f</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=main>(</span><span class=bound>PROB</span> <span class=main>::</span> <span class=tfree>'a</span> problem<span class=main>)</span> <span class=bound>as</span> <span class=bound>s</span><span class=main>.</span> 
    finite <span class=bound>PROB</span> <span class=main>∧</span> <span class=main>(</span><span class=free>P</span> <span class=bound>PROB</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=bound>s</span> <span class=main>∈</span> valid_states <span class=bound>PROB</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=bound>as</span> <span class=main>∈</span> valid_plans <span class=bound>PROB</span><span class=main>)</span> 
    <span class=main>⟶</span> <span class=main>(</span><span class=main>∃</span><span class=bound>as'</span><span class=main>.</span> 
      <span class=main>(</span>exec_plan <span class=bound>s</span> <span class=bound>as</span> <span class=main>=</span> exec_plan <span class=bound>s</span> <span class=bound>as'</span><span class=main>)</span> 
      <span class=main>∧</span> <span class=main>(</span>subseq <span class=bound>as'</span> <span class=bound>as</span><span class=main>)</span>
      <span class=main>∧</span> <span class=main>(</span>length <span class=bound>as'</span> <span class=main>&lt;</span> <span class=free>f</span> <span class=bound>PROB</span> <span class=bound>s</span><span class=main>)</span>
    <span class=main>)</span>
  <span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>
    finite <span class=free>PROB</span> <span class=main>∧</span> <span class=main>(</span><span class=free>P</span> <span class=free>PROB</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=free>s</span> <span class=main>∈</span> valid_states <span class=free>PROB</span><span class=main>)</span>
    <span class=main>⟶</span> problem_plan_bound_s <span class=free>PROB</span> <span class=free>s</span> <span class=main>&lt;</span> <span class=free>f</span> <span class=free>PROB</span> <span class=free>s</span>
  <span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=comment1>― ‹NOTE manual instantiation is required (automation fails otherwise).›</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=main>(</span><span class=bound>PROB</span> <span class=main>::</span> <span class=tfree>'a</span> problem<span class=main>)</span> <span class=bound>x</span> <span class=bound>s</span><span class=main>.</span> 
    finite <span class=bound>PROB</span> <span class=main>∧</span> <span class=free>P</span> <span class=bound>PROB</span> <span class=main>∧</span> <span class=bound>s</span> <span class=main>∈</span> valid_states <span class=bound>PROB</span> 
    <span class=main>⟶</span> <span class=bound>x</span> <span class=main>∈</span> MPLS_s <span class=bound>PROB</span> <span class=bound>s</span> 
    <span class=main>⟶</span> <span class=bound>x</span> <span class=main>&lt;</span> <span class=free>f</span> <span class=bound>PROB</span> <span class=bound>s</span>
  "</span></span>
    <span class=keyword1><span class=command>using</span></span> assms bound_on_all_plans_bounds_MPLS_s<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>P</span></span> <span class=quoted><span class=free>f</span></span><span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span>
    <span class=quoted><span class=quoted>"finite <span class=free>PROB</span> <span class=main>∧</span> <span class=main>(</span><span class=free>P</span> <span class=free>PROB</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=free>s</span> <span class=main>∈</span> valid_states <span class=free>PROB</span><span class=main>)</span> <span class=main>⟶</span> <span class=main>(</span>problem_plan_bound_s <span class=free>PROB</span> <span class=free>s</span> <span class=main>&lt;</span> <span class=free>f</span> <span class=free>PROB</span> <span class=free>s</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> problem_plan_bound_s_def 
    <span class=keyword1><span class=command>using</span></span> Sup_MPLS_s_lt_if problem_plan_bound_s_def
    <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1><span class=command>theorem</span></span> bound_main_lemma_reachability_s<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> problem"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=free>s</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"finite <span class=free>PROB</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>s</span> <span class=main>∈</span> valid_states <span class=free>PROB</span>"</span></span> 
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>problem_plan_bound_s <span class=free>PROB</span> <span class=free>s</span> <span class=main>&lt;</span> card <span class=main>(</span>reachable_s <span class=free>PROB</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=comment1>― ‹NOTE derive premise for MP of 'bound\_child\_parent\_lemma\_s\_2'.›</span>
  <span class=comment1>― ‹NOTE type of `s` had to be fixed (warning in assumption declaration).›</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>PROB</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> problem"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=skolem>s</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> state"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=skolem>as</span>
    <span class=keyword3><span class=command>assume</span></span> P1<span class=main>:</span> <span class=quoted><span class=quoted>"finite <span class=skolem>PROB</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>s</span> <span class=main>∈</span> valid_states <span class=skolem>PROB</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>as</span> <span class=main>∈</span> valid_plans <span class=skolem>PROB</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>as'</span></span> <span class=keyword2><span class=keyword>where</span></span> a<span class=main>:</span> <span class=quoted><span class=quoted>"exec_plan <span class=skolem>s</span> <span class=skolem>as</span> <span class=main>=</span> exec_plan <span class=skolem>s</span> <span class=skolem>as'</span>"</span></span> <span class=quoted><span class=quoted>"subseq <span class=skolem>as'</span> <span class=skolem>as</span>"</span></span> 
      <span class=quoted><span class=quoted>"length <span class=skolem>as'</span> <span class=main>≤</span> card <span class=main>(</span>reachable_s <span class=skolem>PROB</span> <span class=skolem>s</span><span class=main>)</span> <span class=main>-</span> <span class=main>1</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> P1 main_lemma_reachability_s
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"length <span class=skolem>as'</span> <span class=main>&lt;</span> card <span class=main>(</span>reachable_s <span class=skolem>PROB</span> <span class=skolem>s</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> P1<span class=main>(</span>1<span class=main>,</span> 2<span class=main>)</span> card_reachable_s_non_zero
      <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>as'</span><span class=main>.</span> 
      exec_plan <span class=skolem>s</span> <span class=skolem>as</span> <span class=main>=</span> exec_plan <span class=skolem>s</span> <span class=bound>as'</span> <span class=main>∧</span> subseq <span class=bound>as'</span> <span class=skolem>as</span> <span class=main>∧</span> length <span class=bound>as'</span> <span class=main>&lt;</span> card <span class=main>(</span>reachable_s <span class=skolem>PROB</span> <span class=skolem>s</span><span class=main>)</span><span class=main>)</span>
    "</span></span>
      <span class=keyword1><span class=command>using</span></span> a 
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"
    finite <span class=free>PROB</span> <span class=main>∧</span> True <span class=main>∧</span> <span class=free>s</span> <span class=main>∈</span> valid_states <span class=free>PROB</span> 
    <span class=main>⟶</span> problem_plan_bound_s <span class=free>PROB</span> <span class=free>s</span> <span class=main>&lt;</span> card <span class=main>(</span>reachable_s <span class=free>PROB</span> <span class=free>s</span><span class=main>)</span>
  "</span></span>
    <span class=keyword1><span class=command>using</span></span> bound_child_parent_lemma_s_2<span class=main>[</span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> PROB <span class=main><span class=main>=</span></span> <span class=quoted><span class=free>PROB</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>and</span></span></span> P <span class=main><span class=main>=</span></span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=main><span class=bound>_</span></span><span class=main>.</span> True"</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>and</span></span></span> s <span class=main><span class=main>=</span></span> <span class=quoted><span class=free>s</span></span>
        <span class=keyword2><span class=keyword><span class=quasi_keyword>and</span></span></span> f <span class=main><span class=main>=</span></span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>PROB</span> <span class=bound>s</span><span class=main>.</span> card <span class=main>(</span>reachable_s <span class=bound>PROB</span> <span class=bound>s</span><span class=main>)</span>"</span></span><span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> 
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>,</span> 2<span class=main>)</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1 id=TopologicalProps-problem_plan_bound_s_LESS_EQ_problem_plan_bound_thm><span class=command>lemma</span></span>  problem_plan_bound_s_LESS_EQ_problem_plan_bound_thm<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> problem"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=free>s</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> state"</span></span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"finite <span class=free>PROB</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>s</span> <span class=main>∈</span> valid_states <span class=free>PROB</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>problem_plan_bound_s <span class=free>PROB</span> <span class=free>s</span> <span class=main>&lt;</span> problem_plan_bound <span class=free>PROB</span> <span class=main>+</span> <span class=main>1</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span> 
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>PROB</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> problem"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=skolem>s</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> state"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=skolem>as</span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"finite <span class=skolem>PROB</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>s</span> <span class=main>∈</span> valid_states <span class=skolem>PROB</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>as</span> <span class=main>∈</span> valid_plans <span class=skolem>PROB</span>"</span></span> 
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>as'</span></span> <span class=keyword2><span class=keyword>where</span></span> a<span class=main>:</span> <span class=quoted><span class=quoted>"exec_plan <span class=skolem>s</span> <span class=skolem>as</span> <span class=main>=</span> exec_plan <span class=skolem>s</span> <span class=skolem>as'</span>"</span></span> <span class=quoted><span class=quoted>"subseq <span class=skolem>as'</span> <span class=skolem>as</span>"</span></span> 
      <span class=quoted><span class=quoted>"length <span class=skolem>as'</span> <span class=main>≤</span> problem_plan_bound <span class=skolem>PROB</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> problem_plan_bound_works
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"length <span class=skolem>as'</span> <span class=main>&lt;</span> problem_plan_bound <span class=skolem>PROB</span> <span class=main>+</span> <span class=main>1</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>linarith</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>as'</span><span class=main>.</span> 
      exec_plan <span class=skolem>s</span> <span class=skolem>as</span> <span class=main>=</span> exec_plan <span class=skolem>s</span> <span class=bound>as'</span> <span class=main>∧</span> subseq <span class=bound>as'</span> <span class=skolem>as</span> <span class=main>∧</span> length <span class=bound>as'</span> <span class=main>≤</span> problem_plan_bound <span class=skolem>PROB</span> <span class=main>+</span> <span class=main>1</span>
    "</span></span>
      <span class=keyword1><span class=command>using</span></span> a 
      <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
  <span class=keyword1><span class=command>}</span></span>
    <span class=comment1>― ‹TODO unsure why a proof is needed at all here.›</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=main>(</span><span class=bound>PROB</span> <span class=main>::</span> <span class=tfree>'a</span> problem<span class=main>)</span> <span class=bound>as</span> <span class=bound>s</span><span class=main>.</span>
   finite <span class=bound>PROB</span> <span class=main>∧</span> True <span class=main>∧</span> <span class=bound>s</span> <span class=main>∈</span> valid_states <span class=bound>PROB</span> <span class=main>∧</span> <span class=bound>as</span> <span class=main>∈</span> valid_plans <span class=bound>PROB</span> 
   <span class=main>⟶</span> <span class=main>(</span><span class=main>∃</span><span class=bound>as'</span><span class=main>.</span> 
    exec_plan <span class=bound>s</span> <span class=bound>as</span> <span class=main>=</span> exec_plan <span class=bound>s</span> <span class=bound>as'</span> <span class=main>∧</span> subseq <span class=bound>as'</span> <span class=bound>as</span> <span class=main>∧</span> length <span class=bound>as'</span> <span class=main>&lt;</span> problem_plan_bound <span class=bound>PROB</span> <span class=main>+</span> <span class=main>1</span><span class=main>)</span>
  "</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> Suc_eq_plus1 problem_plan_bound_works le_imp_less_Suc<span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>problem_plan_bound_s <span class=free>PROB</span> <span class=free>s</span> <span class=main>&lt;</span> problem_plan_bound <span class=free>PROB</span> <span class=main>+</span> <span class=main>1</span><span class=main>)</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> assms bound_child_parent_lemma_s_2<span class=main>[</span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> PROB <span class=main><span class=main>=</span></span> <span class=quoted><span class=free>PROB</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>and</span></span></span> s <span class=main><span class=main>=</span></span> <span class=quoted><span class=free>s</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>and</span></span></span> P <span class=main><span class=main>=</span></span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=main><span class=bound>_</span></span><span class=main>.</span> True"</span></span> 
        <span class=keyword2><span class=keyword><span class=quasi_keyword>and</span></span></span> f <span class=main><span class=main>=</span></span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>PROB</span> <span class=bound>s</span><span class=main>.</span> problem_plan_bound <span class=bound>PROB</span> <span class=main>+</span> <span class=main>1</span>"</span></span><span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=comment1>― ‹NOTE lemma `bound\_main\_lemma\_s\_1` skipped (this is being equivalently redeclared later).›</span>


<span class=keyword1 id=TopologicalProps-AS_VALID_MPLS_VALID><span class=command>lemma</span></span> AS_VALID_MPLS_VALID<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=free>as</span> 
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span><span class=main>)</span>"</span></span> 
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>Inf <span class=main>(</span>PLS <span class=free>s</span> <span class=free>as</span><span class=main>)</span> <span class=main>∈</span> MPLS_s <span class=free>PROB</span> <span class=free>s</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>unfolding</span></span> MPLS_s_def
  <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>


<span class=comment1>― ‹NOTE moved up because it's used in the following lemma.›</span>
<span class=comment1>― ‹NOTE type of `s` had to be fixed for 'in\_PLS\_leq\_2\_pow\_n'.›</span>
<span class=keyword1 id=TopologicalProps-bound_main_lemma_s_1><span class=command>lemma</span></span> bound_main_lemma_s_1<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> problem"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=free>s</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> state"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=free>x</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"finite <span class=free>PROB</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>s</span> <span class=main>∈</span> <span class=main>(</span>valid_states <span class=free>PROB</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>∈</span> MPLS_s <span class=free>PROB</span> <span class=free>s</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>x</span> <span class=main>≤</span> <span class=main>(</span><span class=numeral>2</span> <span class=main>^</span> card <span class=main>(</span>prob_dom <span class=free>PROB</span><span class=main>)</span><span class=main>)</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>as</span></span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>(</span><span class=tfree>'a</span><span class=main>,</span> bool<span class=main>)</span> fmap <span class=main>×</span> <span class=main>(</span><span class=tfree>'a</span><span class=main>,</span> bool<span class=main>)</span> fmap<span class=main>)</span> list"</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> empty_plan_is_valid 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>x</span></span> <span class=keyword2><span class=keyword>where</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> PLS <span class=free>s</span> <span class=skolem>as</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>≤</span> <span class=numeral>2</span> <span class=main>^</span> card <span class=main>(</span>prob_dom <span class=free>PROB</span><span class=main>)</span> <span class=main>-</span> <span class=main>1</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms in_PLS_leq_2_pow_n
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Inf <span class=main>(</span>PLS <span class=free>s</span> <span class=skolem>as</span><span class=main>)</span> <span class=main>≤</span> <span class=numeral>2</span> <span class=main>^</span> card <span class=main>(</span>prob_dom <span class=free>PROB</span><span class=main>)</span> <span class=main>-</span> <span class=main>1</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> mem_le_imp_MIN_le<span class=main>[</span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> s <span class=main><span class=main>=</span></span> <span class=quoted><span class=quoted>"PLS <span class=free>s</span> <span class=skolem>as</span>"</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>and</span></span></span> k <span class=main><span class=main>=</span></span> <span class=quoted><span class=quoted>"<span class=numeral>2</span> <span class=main>^</span> card <span class=main>(</span>prob_dom <span class=free>PROB</span><span class=main>)</span> <span class=main>-</span> <span class=main>1</span>"</span></span><span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>≤</span> <span class=numeral>2</span> <span class=main>^</span> card <span class=main>(</span>prob_dom <span class=free>PROB</span><span class=main>)</span> <span class=main>-</span> <span class=main>1</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>3<span class=main>)</span> 1
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=comment1>― ‹TODO unsure why a proof is needed here (typing problem?).›</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>,</span> 2<span class=main>,</span> 3<span class=main>)</span> S_VALID_AS_VALID_IMP_MIN_IN_PLS bound_on_all_plans_bounds_MPLS_s_i 
      in_MPLS_leq_2_pow_n
    <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1 id=TopologicalProps-problem_plan_bound_s_ge_min_pls><span class=command>lemma</span></span> problem_plan_bound_s_ge_min_pls<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> problem"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=free>as</span> <span class=free>k</span> <span class=free>s</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"finite <span class=free>PROB</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>s</span> <span class=main>∈</span> <span class=main>(</span>valid_states <span class=free>PROB</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>as</span> <span class=main>∈</span> <span class=main>(</span>valid_plans <span class=free>PROB</span><span class=main>)</span>"</span></span> 
    <span class=quoted><span class=quoted>"problem_plan_bound_s <span class=free>PROB</span> <span class=free>s</span> <span class=main>≤</span> <span class=free>k</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>Inf <span class=main>(</span>PLS <span class=free>s</span> <span class=free>as</span><span class=main>)</span> <span class=main>≤</span> problem_plan_bound_s <span class=free>PROB</span> <span class=free>s</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>x</span><span class=main>∈</span>MPLS_s <span class=free>PROB</span> <span class=free>s</span><span class=main>.</span> <span class=bound>x</span> <span class=main>≤</span> <span class=numeral>2</span> <span class=main>^</span> card <span class=main>(</span>prob_dom <span class=free>PROB</span><span class=main>)</span> <span class=main>-</span> <span class=main>1</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>,</span> 2<span class=main>)</span> bound_main_lemma_s_1 <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"finite <span class=main>(</span>MPLS_s <span class=free>PROB</span> <span class=free>s</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> mems_le_finite<span class=main>[</span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> s <span class=main><span class=main>=</span></span> <span class=quoted><span class=quoted>"MPLS_s <span class=free>PROB</span> <span class=free>s</span>"</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>and</span></span></span> k <span class=main><span class=main>=</span></span> <span class=quoted><span class=quoted>"<span class=numeral>2</span> <span class=main>^</span> card <span class=main>(</span>prob_dom <span class=free>PROB</span><span class=main>)</span> <span class=main>-</span> <span class=main>1</span>"</span></span><span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"MPLS_s <span class=free>PROB</span> <span class=free>s</span> <span class=main>≠</span> <span class=main>{}</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> bound_main_lemma_s_3 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Inf <span class=main>(</span>PLS <span class=free>s</span> <span class=free>as</span><span class=main>)</span> <span class=main>∈</span> MPLS_s <span class=free>PROB</span> <span class=free>s</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> assms AS_VALID_MPLS_VALID 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span> 
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>Inf <span class=main>(</span>PLS <span class=free>s</span> <span class=free>as</span><span class=main>)</span> <span class=main>≤</span> problem_plan_bound_s <span class=free>PROB</span> <span class=free>s</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> problem_plan_bound_s_def 
    <span class=keyword1><span class=command>using</span></span> 1 le_cSup_finite 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1><span class=command>theorem</span></span> bound_main_lemma_s<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> problem"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=free>s</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"finite <span class=free>PROB</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>s</span> <span class=main>∈</span> valid_states <span class=free>PROB</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>problem_plan_bound_s <span class=free>PROB</span> <span class=free>s</span> <span class=main>≤</span> <span class=numeral>2</span> <span class=main>^</span> <span class=main>(</span>card <span class=main>(</span>prob_dom <span class=free>PROB</span><span class=main>)</span><span class=main>)</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>x</span><span class=main>∈</span>MPLS_s <span class=free>PROB</span> <span class=free>s</span><span class=main>.</span> <span class=bound>x</span> <span class=main>≤</span> <span class=numeral>2</span> <span class=main>^</span> card <span class=main>(</span>prob_dom <span class=free>PROB</span><span class=main>)</span> <span class=main>-</span> <span class=main>1</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms bound_main_lemma_s_1
    <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span> 
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"MPLS_s <span class=free>PROB</span> <span class=free>s</span> <span class=main>≠</span> <span class=main>{}</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> bound_main_lemma_s_3 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Sup <span class=main>(</span>MPLS_s <span class=free>PROB</span> <span class=free>s</span><span class=main>)</span> <span class=main>≤</span> <span class=numeral>2</span> <span class=main>^</span> card <span class=main>(</span>prob_dom <span class=free>PROB</span><span class=main>)</span> <span class=main>-</span> <span class=main>1</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> 1 bound_main_lemma_2<span class=main>[</span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> s <span class=main><span class=main>=</span></span> <span class=quoted><span class=quoted>"MPLS_s <span class=free>PROB</span> <span class=free>s</span>"</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>and</span></span></span> k <span class=main><span class=main>=</span></span> <span class=quoted><span class=quoted>"<span class=numeral>2</span> <span class=main>^</span> card <span class=main>(</span>prob_dom <span class=free>PROB</span><span class=main>)</span> <span class=main>-</span> <span class=main>1</span>"</span></span><span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"problem_plan_bound_s <span class=free>PROB</span> <span class=free>s</span> <span class=main>≤</span> <span class=numeral>2</span> <span class=main>^</span> card <span class=main>(</span>prob_dom <span class=free>PROB</span><span class=main>)</span> <span class=main>-</span> <span class=main>1</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> problem_plan_bound_s_def
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1 id=TopologicalProps-problem_plan_bound_s_works><span class=command>lemma</span></span> problem_plan_bound_s_works<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> problem"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=free>as</span> <span class=free>s</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"finite <span class=free>PROB</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>s</span> <span class=main>∈</span> valid_states <span class=free>PROB</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>as'</span><span class=main>.</span> 
    <span class=main>(</span>exec_plan <span class=free>s</span> <span class=free>as</span> <span class=main>=</span> exec_plan <span class=free>s</span> <span class=bound>as'</span><span class=main>)</span> 
    <span class=main>∧</span> <span class=main>(</span>subseq <span class=bound>as'</span> <span class=free>as</span><span class=main>)</span> 
    <span class=main>∧</span> <span class=main>(</span>length <span class=bound>as'</span> <span class=main>≤</span> problem_plan_bound_s <span class=free>PROB</span> <span class=free>s</span><span class=main>)</span>
  <span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"problem_plan_bound_s <span class=free>PROB</span> <span class=free>s</span> <span class=main>≤</span> <span class=numeral>2</span> <span class=main>^</span> card <span class=main>(</span>prob_dom <span class=free>PROB</span><span class=main>)</span> <span class=main>-</span> <span class=main>1</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>,</span> 3<span class=main>)</span> bound_main_lemma_s 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"Inf <span class=main>(</span>PLS <span class=free>s</span> <span class=free>as</span><span class=main>)</span> <span class=main>≤</span> problem_plan_bound_s <span class=free>PROB</span> <span class=free>s</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms problem_plan_bound_s_ge_min_pls<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>PROB</span></span> <span class=quoted><span class=free>s</span></span> <span class=quoted><span class=free>as</span></span> <span class=quoted><span class=quoted>" <span class=numeral>2</span> <span class=main>^</span> card <span class=main>(</span>prob_dom <span class=free>PROB</span><span class=main>)</span> <span class=main>-</span> <span class=main>1</span>"</span></span><span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>x</span></span> <span class=keyword2><span class=keyword>where</span></span> obtain_x<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> PLS <span class=free>s</span> <span class=free>as</span> <span class=main>∧</span> <span class=skolem>x</span> <span class=main>=</span> Inf <span class=main>(</span>PLS <span class=free>s</span> <span class=free>as</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> PLS_nempty_and_has_min
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>as'</span><span class=main>.</span> exec_plan <span class=free>s</span> <span class=free>as</span> <span class=main>=</span> exec_plan <span class=free>s</span> <span class=bound>as'</span> <span class=main>∧</span> length <span class=bound>as'</span> <span class=main>=</span> Inf <span class=main>(</span>PLS <span class=free>s</span> <span class=free>as</span><span class=main>)</span> <span class=main>∧</span> subseq <span class=bound>as'</span> <span class=free>as</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> PLS_works<span class=main>[</span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> s <span class=main><span class=main>=</span></span> <span class=quoted><span class=free>s</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>and</span></span></span> as <span class=main><span class=main>=</span></span> <span class=quoted><span class=free>as</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>and</span></span></span> x <span class=main><span class=main>=</span></span> <span class=quoted><span class=quoted>"Inf <span class=main>(</span>PLS <span class=free>s</span> <span class=free>as</span><span class=main>)</span>"</span></span><span class=main>]</span>
      obtain_x 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>as'</span><span class=main>.</span> 
    <span class=main>(</span>exec_plan <span class=free>s</span> <span class=free>as</span> <span class=main>=</span> exec_plan <span class=free>s</span> <span class=bound>as'</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span>subseq <span class=bound>as'</span> <span class=free>as</span><span class=main>)</span> 
    <span class=main>∧</span> <span class=main>(</span>length <span class=bound>as'</span> <span class=main>≤</span> problem_plan_bound_s <span class=free>PROB</span> <span class=free>s</span><span class=main>)</span>
  <span class=main>)</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> 1
    <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=comment1>― ‹NOTE skipped second declaration (declared twice in source).›</span>
<span class=keyword1 id=TopologicalProps-PLS_def_ITP2015><span class=command>lemma</span></span> PLS_def_ITP2015<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>s</span> <span class=free>as</span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"PLS <span class=free>s</span> <span class=free>as</span> <span class=main>=</span> <span class=main>{</span>length <span class=bound>as'</span> <span class=main>|</span> <span class=bound>as'</span><span class=main>.</span> <span class=main>(</span>exec_plan <span class=free>s</span> <span class=bound>as'</span> <span class=main>=</span> exec_plan <span class=free>s</span> <span class=free>as</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span>subseq <span class=bound>as'</span> <span class=free>as</span><span class=main>)</span><span class=main>}</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> PLS_def 
  <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>


<span class=comment1>― ‹NOTE Set comprehension had to be rewritten to image (there is no pattern matching in the part 
left of the pipe symbol).›</span>
<span class=keyword1 id=TopologicalProps-expanded_problem_plan_bound_charles_thm><span class=command>lemma</span></span> expanded_problem_plan_bound_charles_thm<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> problem"</span></span> 
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>" 
    problem_plan_bound_charles <span class=free>PROB</span> 
    <span class=main>=</span> Sup <span class=main>(</span>
      <span class=main>{</span>
        Inf <span class=main>(</span>PLS_charles <span class=main>(</span>fst <span class=bound>p</span><span class=main>)</span> <span class=main>(</span>snd <span class=bound>p</span><span class=main>)</span> <span class=free>PROB</span><span class=main>)</span> 
        <span class=main>|</span> <span class=bound>p</span><span class=main>.</span> <span class=main>(</span>fst <span class=bound>p</span> <span class=main>∈</span> valid_states <span class=free>PROB</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span>snd <span class=bound>p</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span><span class=main>)</span><span class=main>}</span><span class=main>)</span>
  "</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> problem_plan_bound_charles_def MPLS_charles_def
  <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>


<span class=keyword1 id=TopologicalProps-bound_main_lemma_charles_3><span class=command>lemma</span></span> bound_main_lemma_charles_3<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> problem"</span></span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"finite <span class=free>PROB</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"MPLS_charles <span class=free>PROB</span> <span class=main>≠</span> <span class=main>{}</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>[]</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> empty_plan_is_valid
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>s</span></span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> state"</span></span> <span class=keyword2><span class=keyword>where</span></span> obtain_s<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>s</span> <span class=main>∈</span> valid_states <span class=free>PROB</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms valid_states_nempty
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>then</span></span>  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Inf <span class=main>(</span>PLS_charles <span class=skolem>s</span> <span class=main>[]</span> <span class=free>PROB</span><span class=main>)</span> <span class=main>∈</span> MPLS_charles <span class=free>PROB</span>"</span></span> 
    <span class=keyword1><span class=command>unfolding</span></span> MPLS_charles_def
    <span class=keyword1><span class=command>using</span></span> 1
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"MPLS_charles <span class=free>PROB</span> <span class=main>≠</span> <span class=main>{}</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1 id=TopologicalProps-in_PLS_charles_leq_2_pow_n><span class=command>lemma</span></span> in_PLS_charles_leq_2_pow_n<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> problem"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=free>s</span> <span class=free>as</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"finite <span class=free>PROB</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>s</span> <span class=main>∈</span> valid_states <span class=free>PROB</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>x</span><span class=main>.</span> 
    <span class=main>(</span><span class=bound>x</span> <span class=main>∈</span> PLS_charles <span class=free>s</span> <span class=free>as</span> <span class=free>PROB</span><span class=main>)</span> 
    <span class=main>∧</span> <span class=main>(</span><span class=bound>x</span> <span class=main>≤</span> <span class=numeral>2</span> <span class=main>^</span> card <span class=main>(</span>prob_dom <span class=free>PROB</span><span class=main>)</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span><span class=main>)</span>
  "</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>as'</span></span> <span class=keyword2><span class=keyword>where</span></span> 1<span class=main>:</span>
    <span class=quoted><span class=quoted>"exec_plan <span class=free>s</span> <span class=free>as</span> <span class=main>=</span> exec_plan <span class=free>s</span> <span class=skolem>as'</span>"</span></span> <span class=quoted><span class=quoted>"subseq <span class=skolem>as'</span> <span class=free>as</span>"</span></span> <span class=quoted><span class=quoted>"length <span class=skolem>as'</span> <span class=main>≤</span> <span class=numeral>2</span> <span class=main>^</span> card <span class=main>(</span>prob_dom <span class=free>PROB</span><span class=main>)</span> <span class=main>-</span> <span class=main>1</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> assms main_lemma
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>as'</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>3<span class=main>)</span> sublist_valid_plan 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span> 
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"length <span class=skolem>as'</span> <span class=main>∈</span> PLS_charles <span class=free>s</span> <span class=free>as</span> <span class=free>PROB</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> PLS_charles_def
    <span class=keyword1><span class=command>using</span></span> 1
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> 
    <span class=keyword1><span class=command>using</span></span> 1<span class=main>(</span>3<span class=main>)</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=comment1>― ‹NOTE added lemma.›</span>
<span class=comment1>― ‹NOTE this lemma retrieves `s`, `as` for a given <span class=antiquoted><span class=antiquote>@{</span><span class=operator>term</span> <span class=quoted>"<span class=free>x</span> <span class=main>∈</span> MPLS_charles <span class=free>PROB</span>"</span><span class=antiquote>}</span></span> and characterizes it as
the minimum of 'PLS\_charles s as PROB'.›</span>
<span class=keyword1 id=TopologicalProps-x_in_MPLS_charles_then><span class=command>lemma</span></span> x_in_MPLS_charles_then<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=free>s</span> <span class=free>as</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>∈</span> MPLS_charles <span class=free>PROB</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>s</span> <span class=bound>as</span><span class=main>.</span> 
    <span class=bound>s</span> <span class=main>∈</span> valid_states <span class=free>PROB</span> <span class=main>∧</span> <span class=bound>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span> <span class=main>∧</span> <span class=free>x</span> <span class=main>=</span> Inf <span class=main>(</span>PLS_charles <span class=bound>s</span> <span class=bound>as</span> <span class=free>PROB</span><span class=main>)</span>
  "</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>p</span> <span class=main>∈</span> <span class=main>{</span><span class=bound>p</span><span class=main>.</span> <span class=main>(</span>fst <span class=bound>p</span><span class=main>)</span> <span class=main>∈</span> valid_states <span class=free>PROB</span> <span class=main>∧</span> <span class=main>(</span>snd <span class=bound>p</span><span class=main>)</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span><span class=main>}</span><span class=main>.</span> <span class=free>x</span> <span class=main>=</span> Inf <span class=main>(</span>PLS_charles <span class=main>(</span>fst <span class=bound>p</span><span class=main>)</span> <span class=main>(</span>snd <span class=bound>p</span><span class=main>)</span> <span class=free>PROB</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> MPLS_charles_def assms 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>p</span></span> <span class=keyword2><span class=keyword>where</span></span> 1<span class=main>:</span>
    <span class=quoted><span class=quoted>"<span class=skolem>p</span> <span class=main>∈</span> <span class=main>{</span><span class=bound>p</span><span class=main>.</span> <span class=main>(</span>fst <span class=bound>p</span><span class=main>)</span> <span class=main>∈</span> valid_states <span class=free>PROB</span> <span class=main>∧</span> <span class=main>(</span>snd <span class=bound>p</span><span class=main>)</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span><span class=main>}</span>"</span></span> 
    <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>=</span> Inf <span class=main>(</span>PLS_charles <span class=main>(</span>fst <span class=skolem>p</span><span class=main>)</span> <span class=main>(</span>snd <span class=skolem>p</span><span class=main>)</span> <span class=free>PROB</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fst <span class=skolem>p</span> <span class=main>∈</span> valid_states <span class=free>PROB</span>"</span></span> <span class=quoted><span class=quoted>"snd <span class=skolem>p</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span>"</span></span> 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span><span class=main><span class=keyword3>+</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> 
    <span class=keyword1><span class=command>using</span></span> 1 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=TopologicalProps-in_MPLS_charles_leq_2_pow_n><span class=command>lemma</span></span> in_MPLS_charles_leq_2_pow_n<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> problem"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=free>x</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"finite <span class=free>PROB</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>∈</span> MPLS_charles <span class=free>PROB</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>≤</span> <span class=numeral>2</span> <span class=main>^</span> card <span class=main>(</span>prob_dom <span class=free>PROB</span><span class=main>)</span> <span class=main>-</span> <span class=main>1</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>s</span></span> <span class=skolem><span class=skolem>as</span></span> <span class=keyword2><span class=keyword>where</span></span> 1<span class=main>:</span>
    <span class=quoted><span class=quoted>"<span class=skolem>s</span> <span class=main>∈</span> valid_states <span class=free>PROB</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>=</span> Inf <span class=main>(</span>PLS_charles <span class=skolem>s</span> <span class=skolem>as</span> <span class=free>PROB</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>2<span class=main>)</span> x_in_MPLS_charles_then
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>x'</span></span> <span class=keyword2><span class=keyword>where</span></span> 2<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>x'</span> <span class=main>∈</span> PLS_charles <span class=skolem>s</span> <span class=skolem>as</span> <span class=free>PROB</span>"</span></span><span class=quoted><span class=quoted>"<span class=skolem>x'</span> <span class=main>≤</span> <span class=numeral>2</span> <span class=main>^</span> card <span class=main>(</span>prob_dom <span class=free>PROB</span><span class=main>)</span> <span class=main>-</span> <span class=main>1</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>)</span> in_PLS_charles_leq_2_pow_n 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>≤</span> <span class=skolem>x'</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> 1<span class=main>(</span>3<span class=main>)</span> mem_le_imp_MIN_le
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> 
    <span class=keyword1><span class=command>using</span></span> 1 2
    <span class=keyword1><span class=command>by</span></span> <span class=operator>linarith</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1 id=TopologicalProps-bound_main_lemma_charles><span class=command>lemma</span></span> bound_main_lemma_charles<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> problem"</span></span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"finite <span class=free>PROB</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"problem_plan_bound_charles <span class=free>PROB</span> <span class=main>≤</span> <span class=numeral>2</span> <span class=main>^</span> <span class=main>(</span>card <span class=main>(</span>prob_dom <span class=free>PROB</span><span class=main>)</span><span class=main>)</span> <span class=main>-</span> <span class=main>1</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>x</span><span class=main>∈</span>MPLS_charles <span class=free>PROB</span><span class=main>.</span> <span class=bound>x</span> <span class=main>≤</span> <span class=numeral>2</span> <span class=main>^</span> <span class=main>(</span>card <span class=main>(</span>prob_dom <span class=free>PROB</span><span class=main>)</span><span class=main>)</span> <span class=main>-</span> <span class=main>1</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms in_MPLS_charles_leq_2_pow_n
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"MPLS_charles <span class=free>PROB</span> <span class=main>≠</span> <span class=main>{}</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms bound_main_lemma_charles_3
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Sup <span class=main>(</span>MPLS_charles <span class=free>PROB</span><span class=main>)</span> <span class=main>≤</span> <span class=numeral>2</span> <span class=main>^</span> <span class=main>(</span>card <span class=main>(</span>prob_dom <span class=free>PROB</span><span class=main>)</span><span class=main>)</span> <span class=main>-</span> <span class=main>1</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> 1 bound_main_lemma_2 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>meson</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> 
    <span class=keyword1><span class=command>using</span></span> problem_plan_bound_charles_def
    <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1 id=TopologicalProps-bound_on_all_plans_bounds_PLS_charles><span class=command>lemma</span></span> bound_on_all_plans_bounds_PLS_charles<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>P</span> <span class=keyword2><span class=keyword>and</span></span> <span class=free>f</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=main>(</span><span class=bound>PROB</span> <span class=main>::</span> <span class=tfree>'a</span> problem<span class=main>)</span> <span class=bound>as</span> <span class=bound>s</span><span class=main>.</span>
    <span class=main>(</span><span class=free>P</span> <span class=bound>PROB</span><span class=main>)</span> <span class=main>∧</span> finite <span class=bound>PROB</span> <span class=main>∧</span> <span class=main>(</span><span class=bound>as</span> <span class=main>∈</span> valid_plans <span class=bound>PROB</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=bound>s</span> <span class=main>∈</span> valid_states <span class=bound>PROB</span><span class=main>)</span> 
    <span class=main>⟶</span> <span class=main>(</span><span class=main>∃</span><span class=bound>as'</span><span class=main>.</span> 
      <span class=main>(</span>exec_plan <span class=bound>s</span> <span class=bound>as</span> <span class=main>=</span> exec_plan <span class=bound>s</span> <span class=bound>as'</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span>subseq <span class=bound>as'</span> <span class=bound>as</span><span class=main>)</span><span class=main>∧</span> <span class=main>(</span>length <span class=bound>as'</span> <span class=main>&lt;</span> <span class=free>f</span> <span class=bound>PROB</span><span class=main>)</span><span class=main>)</span>
  "</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>PROB</span> <span class=bound>s</span> <span class=bound>as</span><span class=main>.</span> 
    <span class=main>(</span><span class=free>P</span> <span class=bound>PROB</span><span class=main>)</span> <span class=main>∧</span> finite <span class=bound>PROB</span> <span class=main>∧</span> <span class=main>(</span><span class=bound>as</span> <span class=main>∈</span> valid_plans <span class=bound>PROB</span><span class=main>)</span>  <span class=main>∧</span> <span class=main>(</span><span class=bound>s</span> <span class=main>∈</span> valid_states <span class=bound>PROB</span><span class=main>)</span>
    <span class=main>⟶</span> <span class=main>(</span><span class=main>∃</span><span class=bound>x</span><span class=main>.</span> 
      <span class=main>(</span><span class=bound>x</span> <span class=main>∈</span> PLS_charles <span class=bound>s</span> <span class=bound>as</span> <span class=bound>PROB</span><span class=main>)</span> 
      <span class=main>∧</span> <span class=main>(</span><span class=bound>x</span> <span class=main>&lt;</span> <span class=free>f</span> <span class=bound>PROB</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>
  "</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=comment1>― ‹NOTE type for 's' had to be fixed (type mismatch in first proof step.›</span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>PROB</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> problem"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=skolem>as</span> <span class=keyword2><span class=keyword>and</span></span> <span class=skolem>s</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> state"</span></span>
    <span class=keyword3><span class=command>assume</span></span> P<span class=main>:</span> 
      <span class=quoted><span class=quoted>"<span class=free>P</span> <span class=skolem>PROB</span>"</span></span> <span class=quoted><span class=quoted>"finite <span class=skolem>PROB</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>as</span> <span class=main>∈</span> valid_plans <span class=skolem>PROB</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>s</span> <span class=main>∈</span> valid_states <span class=skolem>PROB</span>"</span></span>
      <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>as'</span><span class=main>.</span> 
        <span class=main>(</span>exec_plan <span class=skolem>s</span> <span class=skolem>as</span> <span class=main>=</span> exec_plan <span class=skolem>s</span> <span class=bound>as'</span><span class=main>)</span> 
        <span class=main>∧</span> <span class=main>(</span>subseq <span class=bound>as'</span> <span class=skolem>as</span><span class=main>)</span>
        <span class=main>∧</span> <span class=main>(</span>length <span class=bound>as'</span> <span class=main>&lt;</span> <span class=free>f</span> <span class=skolem>PROB</span><span class=main>)</span>
      <span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>as'</span></span> <span class=keyword2><span class=keyword>where</span></span> 1<span class=main>:</span>
      <span class=quoted><span class=quoted>"<span class=main>(</span>exec_plan <span class=skolem>s</span> <span class=skolem>as</span> <span class=main>=</span> exec_plan <span class=skolem>s</span> <span class=skolem>as'</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>subseq <span class=skolem>as'</span> <span class=skolem>as</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>length <span class=skolem>as'</span> <span class=main>&lt;</span> <span class=free>f</span> <span class=skolem>PROB</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> P<span class=main>(</span>5<span class=main>)</span> 
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> 2<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>as'</span> <span class=main>∈</span> valid_plans <span class=skolem>PROB</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> P<span class=main>(</span>3<span class=main>)</span> sublist_valid_plan 
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span> 
    <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?x</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"length <span class=skolem>as'</span>"</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?x</span> <span class=main>∈</span> PLS_charles <span class=skolem>s</span> <span class=skolem>as</span> <span class=skolem>PROB</span>"</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> PLS_charles_def
      <span class=keyword1><span class=command>using</span></span> 1 2
      <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>x</span><span class=main>.</span> <span class=bound>x</span> <span class=main>∈</span> PLS_charles <span class=skolem>s</span> <span class=skolem>as</span> <span class=skolem>PROB</span> <span class=main>∧</span> <span class=bound>x</span> <span class=main>&lt;</span> <span class=free>f</span> <span class=skolem>PROB</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> 1 2 
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> 
    <span class=keyword1><span class=command>using</span></span> assms 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=comment1>― ‹NOTE added lemma (refactored from `bound\_on\_all\_plans\_bounds\_MPLS\_charles`).›</span>
<span class=keyword1 id=TopologicalProps-bound_on_all_plans_bounds_MPLS_charles_i><span class=command>lemma</span></span> bound_on_all_plans_bounds_MPLS_charles_i<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=main>(</span><span class=bound>PROB</span> <span class=main>::</span> <span class=tfree>'a</span> problem<span class=main>)</span> <span class=bound>s</span> <span class=bound>as</span><span class=main>.</span>
    <span class=main>(</span><span class=free>P</span> <span class=bound>PROB</span><span class=main>)</span> <span class=main>∧</span> finite <span class=bound>PROB</span> <span class=main>∧</span> <span class=main>(</span><span class=bound>as</span> <span class=main>∈</span> valid_plans <span class=bound>PROB</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=bound>s</span> <span class=main>∈</span> valid_states <span class=bound>PROB</span><span class=main>)</span>
    <span class=main>⟶</span> <span class=main>(</span><span class=main>∃</span><span class=bound>as'</span><span class=main>.</span> 
      <span class=main>(</span>exec_plan <span class=bound>s</span> <span class=bound>as</span> <span class=main>=</span> exec_plan <span class=bound>s</span> <span class=bound>as'</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span>subseq <span class=bound>as'</span> <span class=bound>as</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span>length <span class=bound>as'</span> <span class=main>&lt;</span> <span class=free>f</span> <span class=bound>PROB</span><span class=main>)</span><span class=main>)</span>
  "</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=main>(</span><span class=bound>PROB</span> <span class=main>::</span> <span class=tfree>'a</span> problem<span class=main>)</span> <span class=bound>s</span> <span class=bound>as</span><span class=main>.</span>
    <span class=free>P</span> <span class=bound>PROB</span> <span class=main>∧</span> finite <span class=bound>PROB</span> <span class=main>∧</span> <span class=bound>as</span> <span class=main>∈</span> valid_plans <span class=bound>PROB</span> <span class=main>∧</span> <span class=bound>s</span> <span class=main>∈</span> valid_states <span class=bound>PROB</span>
    <span class=main>⟶</span> Inf <span class=main>{</span><span class=bound>n</span><span class=main>.</span> <span class=bound>n</span> <span class=main>∈</span> PLS_charles <span class=bound>s</span> <span class=bound>as</span> <span class=bound>PROB</span><span class=main>}</span> <span class=main>&lt;</span> <span class=free>f</span> <span class=bound>PROB</span>
  "</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>PROB</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> problem"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=skolem>s</span> <span class=skolem>as</span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>P</span> <span class=skolem>PROB</span> <span class=main>∧</span> finite <span class=skolem>PROB</span> <span class=main>∧</span> <span class=skolem>as</span> <span class=main>∈</span> valid_plans <span class=skolem>PROB</span> <span class=main>∧</span> <span class=skolem>s</span> <span class=main>∈</span> valid_states <span class=skolem>PROB</span>
     <span class=main>⟶</span> <span class=main>(</span><span class=main>∃</span><span class=bound>x</span><span class=main>.</span> <span class=bound>x</span> <span class=main>∈</span> PLS_charles <span class=skolem>s</span> <span class=skolem>as</span> <span class=skolem>PROB</span> <span class=main>∧</span> <span class=bound>x</span> <span class=main>&lt;</span> <span class=free>f</span> <span class=skolem>PROB</span><span class=main>)</span>
    "</span></span>
      <span class=keyword1><span class=command>using</span></span> assms bound_on_all_plans_bounds_PLS_charles<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>P</span></span> <span class=quoted><span class=free>f</span></span><span class=main>]</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"
      <span class=free>P</span> <span class=skolem>PROB</span> <span class=main>∧</span> finite <span class=skolem>PROB</span> <span class=main>∧</span> <span class=skolem>as</span> <span class=main>∈</span> valid_plans <span class=skolem>PROB</span> <span class=main>∧</span> <span class=skolem>s</span> <span class=main>∈</span> valid_states <span class=skolem>PROB</span>
      <span class=main>⟶</span> Inf <span class=main>{</span><span class=bound>n</span><span class=main>.</span> <span class=bound>n</span> <span class=main>∈</span> PLS_charles <span class=skolem>s</span> <span class=skolem>as</span> <span class=skolem>PROB</span><span class=main>}</span> <span class=main>&lt;</span> <span class=free>f</span> <span class=skolem>PROB</span>
    "</span></span>
      <span class=keyword1><span class=command>using</span></span> mem_lt_imp_MIN_lt CollectI
      <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=TopologicalProps-bound_on_all_plans_bounds_MPLS_charles><span class=command>lemma</span></span> bound_on_all_plans_bounds_MPLS_charles<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>P</span> <span class=free>f</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=main>(</span><span class=bound>PROB</span> <span class=main>::</span> <span class=tfree>'a</span> problem<span class=main>)</span> <span class=bound>as</span> <span class=bound>s</span><span class=main>.</span> 
    <span class=main>(</span><span class=free>P</span> <span class=bound>PROB</span><span class=main>)</span> <span class=main>∧</span> finite <span class=bound>PROB</span> <span class=main>∧</span> <span class=main>(</span><span class=bound>s</span> <span class=main>∈</span> valid_states <span class=bound>PROB</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=bound>as</span> <span class=main>∈</span> valid_plans <span class=bound>PROB</span><span class=main>)</span> 
    <span class=main>⟶</span> <span class=main>(</span><span class=main>∃</span><span class=bound>as'</span><span class=main>.</span> 
      <span class=main>(</span>exec_plan <span class=bound>s</span> <span class=bound>as</span> <span class=main>=</span> exec_plan <span class=bound>s</span> <span class=bound>as'</span><span class=main>)</span> 
      <span class=main>∧</span> <span class=main>(</span>subseq <span class=bound>as'</span> <span class=bound>as</span><span class=main>)</span>
      <span class=main>∧</span> <span class=main>(</span>length <span class=bound>as'</span> <span class=main>&lt;</span> <span class=free>f</span> <span class=bound>PROB</span><span class=main>)</span>
    <span class=main>)</span>
  <span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>PROB</span> <span class=bound>x</span><span class=main>.</span> 
    <span class=main>(</span><span class=free>P</span> <span class=bound>PROB</span><span class=main>)</span> <span class=main>∧</span> finite <span class=bound>PROB</span>
    <span class=main>⟶</span> <span class=main>(</span><span class=bound>x</span> <span class=main>∈</span> MPLS_charles <span class=bound>PROB</span><span class=main>)</span> 
    <span class=main>⟶</span> <span class=main>(</span><span class=bound>x</span> <span class=main>&lt;</span> <span class=free>f</span> <span class=bound>PROB</span><span class=main>)</span>
  <span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=main>(</span><span class=bound>PROB</span> <span class=main>::</span> <span class=tfree>'a</span> problem<span class=main>)</span> <span class=bound>s</span> <span class=bound>as</span><span class=main>.</span> 
    <span class=free>P</span> <span class=bound>PROB</span> <span class=main>∧</span> finite <span class=bound>PROB</span> <span class=main>∧</span> <span class=bound>as</span> <span class=main>∈</span> valid_plans <span class=bound>PROB</span> <span class=main>∧</span> <span class=bound>s</span> <span class=main>∈</span> valid_states <span class=bound>PROB</span>
    <span class=main>⟶</span> Inf <span class=main>{</span><span class=bound>n</span><span class=main>.</span> <span class=bound>n</span> <span class=main>∈</span> PLS_charles <span class=bound>s</span> <span class=bound>as</span> <span class=bound>PROB</span><span class=main>}</span> <span class=main>&lt;</span> <span class=free>f</span> <span class=bound>PROB</span>
  "</span></span> 
    <span class=keyword1><span class=command>using</span></span> assms bound_on_all_plans_bounds_MPLS_charles_i
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>PROB</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> problem"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=skolem>x</span>
    <span class=keyword3><span class=command>assume</span></span> P1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>P</span> <span class=skolem>PROB</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"finite <span class=skolem>PROB</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> MPLS_charles <span class=skolem>PROB</span>"</span></span> 
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>s</span></span> <span class=skolem><span class=skolem>as</span></span> <span class=keyword2><span class=keyword>where</span></span> a<span class=main>:</span>
      <span class=quoted><span class=quoted>"<span class=skolem>as</span> <span class=main>∈</span> valid_plans <span class=skolem>PROB</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>s</span> <span class=main>∈</span> valid_states <span class=skolem>PROB</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>=</span> Inf <span class=main>(</span>PLS_charles <span class=skolem>s</span> <span class=skolem>as</span> <span class=skolem>PROB</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> x_in_MPLS_charles_then 
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Inf <span class=main>{</span><span class=bound>n</span><span class=main>.</span> <span class=bound>n</span> <span class=main>∈</span> PLS_charles <span class=skolem>s</span> <span class=skolem>as</span> <span class=skolem>PROB</span><span class=main>}</span> <span class=main>&lt;</span> <span class=free>f</span> <span class=skolem>PROB</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> 1 P1
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>&lt;</span> <span class=free>f</span> <span class=skolem>PROB</span>"</span></span> 
      <span class=keyword1><span class=command>using</span></span> a
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=comment1>― ‹NOTE added lemma (refactored from 'bound\_on\_all\_plans\_bounds\_problem\_plan\_bound\_charles').›</span>
<span class=keyword1 id=TopologicalProps-bound_on_all_plans_bounds_problem_plan_bound_charles_i><span class=command>lemma</span></span> bound_on_all_plans_bounds_problem_plan_bound_charles_i<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> problem"</span></span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"finite <span class=free>PROB</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>x</span> <span class=main>∈</span> MPLS_charles <span class=free>PROB</span><span class=main>.</span> <span class=bound>x</span> <span class=main>&lt;</span> <span class=free>k</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"Sup <span class=main>(</span>MPLS_charles <span class=free>PROB</span><span class=main>)</span> <span class=main>∈</span> MPLS_charles <span class=free>PROB</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"MPLS_charles <span class=free>PROB</span> <span class=main>≠</span> <span class=main>{}</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>)</span> bound_main_lemma_charles_3 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"finite <span class=main>(</span>MPLS_charles <span class=free>PROB</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>2<span class=main>)</span> finite_nat_set_iff_bounded
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> 
    <span class=keyword1><span class=command>unfolding</span></span> Sup_nat_def
    <span class=keyword1><span class=command>using</span></span> 1
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=TopologicalProps-bound_on_all_plans_bounds_problem_plan_bound_charles><span class=command>lemma</span></span> bound_on_all_plans_bounds_problem_plan_bound_charles<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>P</span> <span class=free>f</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=main>(</span><span class=bound>PROB</span> <span class=main>::</span> <span class=tfree>'a</span> problem<span class=main>)</span> <span class=bound>as</span> <span class=bound>s</span><span class=main>.</span> 
    <span class=main>(</span><span class=free>P</span> <span class=bound>PROB</span><span class=main>)</span> <span class=main>∧</span> finite <span class=bound>PROB</span> <span class=main>∧</span> <span class=main>(</span><span class=bound>s</span> <span class=main>∈</span> valid_states <span class=bound>PROB</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=bound>as</span> <span class=main>∈</span> valid_plans <span class=bound>PROB</span><span class=main>)</span> 
    <span class=main>⟶</span> <span class=main>(</span><span class=main>∃</span><span class=bound>as'</span><span class=main>.</span> 
      <span class=main>(</span>exec_plan <span class=bound>s</span> <span class=bound>as</span> <span class=main>=</span> exec_plan <span class=bound>s</span> <span class=bound>as'</span><span class=main>)</span> 
      <span class=main>∧</span> <span class=main>(</span>subseq <span class=bound>as'</span> <span class=bound>as</span><span class=main>)</span>
      <span class=main>∧</span> <span class=main>(</span>length <span class=bound>as'</span> <span class=main>&lt;</span> <span class=free>f</span> <span class=bound>PROB</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>
  "</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>PROB</span><span class=main>.</span> 
    <span class=main>(</span><span class=free>P</span> <span class=bound>PROB</span><span class=main>)</span> <span class=main>∧</span> finite <span class=bound>PROB</span> <span class=main>⟶</span> <span class=main>(</span>problem_plan_bound_charles <span class=bound>PROB</span> <span class=main>&lt;</span> <span class=free>f</span> <span class=bound>PROB</span><span class=main>)</span><span class=main>)</span>
  "</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>PROB</span> <span class=bound>x</span><span class=main>.</span> <span class=free>P</span> <span class=bound>PROB</span> <span class=main>∧</span> finite <span class=bound>PROB</span> <span class=main>⟶</span> <span class=bound>x</span> <span class=main>∈</span> MPLS_charles <span class=bound>PROB</span> <span class=main>⟶</span> <span class=bound>x</span> <span class=main>&lt;</span> <span class=free>f</span> <span class=bound>PROB</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms bound_on_all_plans_bounds_MPLS_charles
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>PROB</span>
    <span class=keyword3><span class=command>assume</span></span> P<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>P</span> <span class=skolem>PROB</span>"</span></span> <span class=quoted><span class=quoted>"finite <span class=skolem>PROB</span>"</span></span> 
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> 2<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>x</span><span class=main>.</span> <span class=bound>x</span> <span class=main>∈</span> MPLS_charles <span class=skolem>PROB</span> <span class=main>⟶</span> <span class=bound>x</span> <span class=main>&lt;</span> <span class=free>f</span> <span class=skolem>PROB</span>"</span></span> 
      <span class=keyword1><span class=command>using</span></span> 1 P 
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>moreover</span></span>
    <span class=keyword1><span class=command>{</span></span>
      <span class=keyword3><span class=command>fix</span></span> <span class=skolem>x</span>
      <span class=keyword3><span class=command>assume</span></span> P1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> MPLS_charles <span class=skolem>PROB</span>"</span></span> 
      <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>&lt;</span> <span class=free>f</span> <span class=skolem>PROB</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> P<span class=main>(</span>1<span class=main>,</span> 2<span class=main>)</span> P1 1
        <span class=keyword1><span class=command>by</span></span> <span class=operator>presburger</span>
      <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"MPLS_charles <span class=skolem>PROB</span> <span class=main>≠</span> <span class=main>{}</span>"</span></span> 
        <span class=keyword1><span class=command>using</span></span> P1
        <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Sup <span class=main>(</span>MPLS_charles <span class=skolem>PROB</span><span class=main>)</span> <span class=main>&lt;</span> <span class=free>f</span> <span class=skolem>PROB</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> calculation<span class=main>(</span>3<span class=main>)</span> 2 bound_child_parent_not_eq_last_diff_paths<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"MPLS_charles <span class=skolem>PROB</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>f</span> <span class=skolem>PROB</span>"</span></span><span class=main>]</span> 
        <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>problem_plan_bound_charles <span class=skolem>PROB</span> <span class=main>&lt;</span> <span class=free>f</span> <span class=skolem>PROB</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>unfolding</span></span> problem_plan_bound_charles_def 
        <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>}</span></span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Sup <span class=main>(</span>MPLS_charles <span class=skolem>PROB</span><span class=main>)</span> <span class=main>∈</span> MPLS_charles <span class=skolem>PROB</span>"</span></span> 
      <span class=keyword1><span class=command>using</span></span> P<span class=main>(</span>2<span class=main>)</span> 2 bound_on_all_plans_bounds_problem_plan_bound_charles_i
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"problem_plan_bound_charles <span class=skolem>PROB</span> <span class=main>&lt;</span> <span class=free>f</span> <span class=skolem>PROB</span>"</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> problem_plan_bound_charles_def 
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>subsection</span></span> <span class=quoted><span class=plain_text>"The Relation between Diameter, Sublist Diameter and Recurrence Diameter Bounds."</span></span>

<span class=keyword1><span class=command>text</span></span> <span class=quoted><span class=plain_text>‹ The goal of this subsection is to verify the relation between diameter, sublist diameter
and recurrence diameter bounds given by HOL4 Theorem 1, i.e.

  <span class=antiquoted><span class=antiquoted><span class=antiquote><span class=antiquote>@{</span></span><span class=operator><span class=operator>term</span></span> <span class=quoted><span class=quoted>"<span class=free><span class=free>𝖽</span></span><span class=main><span class=main>(</span></span><span class=free><span class=free>δ</span></span><span class=main><span class=main>)</span></span> <span class=main><span class=main>≤</span></span> <span class=free><span class=free>𝗅</span></span><span class=main><span class=main>(</span></span><span class=free><span class=free>δ</span></span><span class=main><span class=main>)</span></span> <span class=main><span class=main>∧</span></span> <span class=free><span class=free>𝗅</span></span><span class=main><span class=main>(</span></span><span class=free><span class=free>δ</span></span><span class=main><span class=main>)</span></span> <span class=main><span class=main>≤</span></span> <span class=free><span class=free>𝗋𝖽</span></span><span class=main><span class=main>(</span></span><span class=free><span class=free>δ</span></span><span class=main><span class=main>)</span></span>"</span></span><span class=antiquote><span class=antiquote>}</span></span></span></span>

where <span class=antiquoted><span class=antiquoted><span class=antiquote><span class=antiquote>@{</span></span><span class=operator><span class=operator>term</span></span> <span class=quoted><span class=quoted>"<span class=free><span class=free>𝖽</span></span><span class=main><span class=main>(</span></span><span class=free><span class=free>δ</span></span><span class=main><span class=main>)</span></span>"</span></span><span class=antiquote><span class=antiquote>}</span></span></span></span>, <span class=antiquoted><span class=antiquoted><span class=antiquote><span class=antiquote>@{</span></span><span class=operator><span class=operator>term</span></span> <span class=quoted><span class=quoted>"<span class=free><span class=free>𝗅</span></span><span class=main><span class=main>(</span></span><span class=free><span class=free>δ</span></span><span class=main><span class=main>)</span></span>"</span></span><span class=antiquote><span class=antiquote>}</span></span></span></span> and <span class=antiquoted><span class=antiquoted><span class=antiquote><span class=antiquote>@{</span></span><span class=operator><span class=operator>term</span></span> <span class=quoted><span class=quoted>"<span class=free><span class=free>𝗋𝖽</span></span><span class=main><span class=main>(</span></span><span class=free><span class=free>δ</span></span><span class=main><span class=main>)</span></span>"</span></span><span class=antiquote><span class=antiquote>}</span></span></span></span> denote the diameter, sublist diameter and recurrence diameter bounds.
[Abdualaziz et al., p.20]

The relevant lemmas are `sublistD\_bounds\_D` and `RD\_bounds\_sublistD` which culminate in 
theorem `sublistD\_bounds\_D\_and\_RD\_bounds\_sublistD`. ›</span></span>

<span class=keyword1 id=TopologicalProps-sublistD_bounds_D><span class=command>lemma</span></span> sublistD_bounds_D<span class=main>:</span>  
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> problem"</span></span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"finite <span class=free>PROB</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"problem_plan_bound_charles <span class=free>PROB</span> <span class=main>≤</span> problem_plan_bound <span class=free>PROB</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=comment1>― ‹NOTE obtain the premise needed for MP of 'bound\_on\_all\_plans\_bounds\_problem\_plan\_bound\_charles'.›</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>PROB</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> problem"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=skolem>s</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> state"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=skolem>as</span>
    <span class=keyword3><span class=command>assume</span></span> P<span class=main>:</span> <span class=quoted><span class=quoted>"finite <span class=skolem>PROB</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>s</span> <span class=main>∈</span> valid_states <span class=skolem>PROB</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>as</span> <span class=main>∈</span> valid_plans <span class=skolem>PROB</span>"</span></span> 
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>as'</span><span class=main>.</span> 
      exec_plan <span class=skolem>s</span> <span class=skolem>as</span> <span class=main>=</span> exec_plan <span class=skolem>s</span> <span class=bound>as'</span> <span class=main>∧</span> subseq <span class=bound>as'</span> <span class=skolem>as</span> <span class=main>∧</span> length <span class=bound>as'</span> <span class=main>≤</span> problem_plan_bound <span class=skolem>PROB</span>
    "</span></span> 
      <span class=keyword1><span class=command>using</span></span> problem_plan_bound_works
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>as'</span><span class=main>.</span> 
      exec_plan <span class=skolem>s</span> <span class=skolem>as</span> <span class=main>=</span> exec_plan <span class=skolem>s</span> <span class=bound>as'</span> <span class=main>∧</span> subseq <span class=bound>as'</span> <span class=skolem>as</span> <span class=main>∧</span> length <span class=bound>as'</span> <span class=main>&lt;</span> problem_plan_bound <span class=skolem>PROB</span> <span class=main>+</span> <span class=main>1</span>
    "</span></span> 
      <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"problem_plan_bound_charles <span class=free>PROB</span> <span class=main>&lt;</span> problem_plan_bound <span class=free>PROB</span> <span class=main>+</span> <span class=main>1</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms bound_on_all_plans_bounds_problem_plan_bound_charles<span class=main>[</span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> f <span class=main><span class=main>=</span></span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>PROB</span><span class=main>.</span> problem_plan_bound <span class=bound>PROB</span> <span class=main>+</span> <span class=main>1</span>"</span></span>
        <span class=keyword2><span class=keyword><span class=quasi_keyword>and</span></span></span> P <span class=main><span class=main>=</span></span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=main><span class=bound>_</span></span><span class=main>.</span> True"</span></span><span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=comment1>― ‹NOTE added lemma (this was adapted from pred\_setScript.sml:4887 with exlusion of the premise for 
the empty set since `Max {}` is undefined in Isabelle/HOL.)›</span>
<span class=keyword1 id="TopologicalProps-MAX_SET_ELIM'"><span class=command>lemma</span></span> MAX_SET_ELIM'<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>P</span> <span class=free>Q</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"finite <span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>P</span> <span class=main>≠</span> <span class=main>{}</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>x</span><span class=main>.</span> <span class=main>(</span><span class=main>∀</span><span class=bound>y</span><span class=main>.</span> <span class=bound>y</span> <span class=main>∈</span> <span class=free>P</span> <span class=main>⟶</span> <span class=bound>y</span> <span class=main>≤</span> <span class=bound>x</span><span class=main>)</span> <span class=main>∧</span> <span class=bound>x</span> <span class=main>∈</span> <span class=free>P</span> <span class=main>⟶</span> <span class=free>R</span> <span class=bound>x</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=free>R</span> <span class=main>(</span>Max <span class=free>P</span><span class=main>)</span>"</span></span> 
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>

<span class=comment1>― ‹NOTE added lemma.›</span>
<span class=comment1>― ‹NOTE adapted from pred\_setScript.sml:4895 (premise `finite P` was added).›</span>
<span class=keyword1 id="TopologicalProps-MIN_SET_ELIM'"><span class=command>lemma</span></span> MIN_SET_ELIM'<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>P</span> <span class=free>Q</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"finite <span class=free>P</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>P</span> <span class=main>≠</span> <span class=main>{}</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>x</span><span class=main>.</span> <span class=main>(</span><span class=main>∀</span><span class=bound>y</span><span class=main>.</span> <span class=bound>y</span> <span class=main>∈</span> <span class=free>P</span> <span class=main>⟶</span> <span class=bound>x</span> <span class=main>≤</span> <span class=bound>y</span><span class=main>)</span> <span class=main>∧</span> <span class=bound>x</span> <span class=main>∈</span> <span class=free>P</span> <span class=main>⟶</span> <span class=free>Q</span> <span class=bound>x</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=free>Q</span> <span class=main>(</span>Min <span class=free>P</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?x</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"Min <span class=free>P</span>"</span></span> 
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Min <span class=free>P</span> <span class=main>∈</span> <span class=free>P</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> Min_in<span class=main>[</span><span class=operator>OF</span> assms<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span> assms<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span><span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>y</span>
    <span class=keyword3><span class=command>assume</span></span> P<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>y</span> <span class=main>∈</span> <span class=free>P</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?x</span> <span class=main>≤</span> <span class=skolem>y</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> Min.coboundedI<span class=main>[</span><span class=operator>OF</span> assms<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main>]</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>Q</span> <span class=var>?x</span>"</span></span> <span class=keyword1><span class=command>using</span></span> P assms
      <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=comment1>― ‹NOTE added lemma (refactored from `RD\_bounds\_sublistD`).›</span>
<span class=keyword1 id=TopologicalProps-RD_bounds_sublistD_i_a><span class=command>lemma</span></span> RD_bounds_sublistD_i_a<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>Pi</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> problem"</span></span> 
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"finite <span class=free>Pi</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"finite <span class=main>{</span>length <span class=bound>p</span> <span class=main>-</span> <span class=main>1</span> <span class=main>|</span><span class=bound>p</span><span class=main>.</span> valid_path <span class=free>Pi</span> <span class=bound>p</span> <span class=main>∧</span> distinct <span class=bound>p</span><span class=main>}</span>"</span></span> 
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?ss</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>{</span>length <span class=bound>p</span> <span class=main>-</span> <span class=main>1</span> <span class=main>|</span><span class=bound>p</span><span class=main>.</span> valid_path <span class=free>Pi</span> <span class=bound>p</span> <span class=main>∧</span> distinct <span class=bound>p</span><span class=main>}</span>"</span></span>
    <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?ss'</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>{</span><span class=bound>p</span><span class=main>.</span> valid_path <span class=free>Pi</span> <span class=bound>p</span> <span class=main>∧</span> distinct <span class=bound>p</span><span class=main>}</span>"</span></span>
    <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=var>?ss</span> <span class=main>=</span> <span class=main>(</span><span class=main>λ</span><span class=bound>x</span><span class=main>.</span> length <span class=bound>x</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span> <span class=main>`</span> <span class=var>?ss'</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>{</span></span>
      <span class=comment1>― ‹NOTE type of `valid\_states Pi` had to be asserted to match `FINITE\_valid\_states`.›</span>
      <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?S</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>{</span><span class=bound>p</span><span class=main>.</span> distinct <span class=bound>p</span> <span class=main>∧</span> set <span class=bound>p</span> <span class=main>⊆</span> <span class=main>(</span>valid_states <span class=free>Pi</span> <span class=main>::</span> <span class=tfree>'a</span> state set<span class=main>)</span><span class=main>}</span>"</span></span>
      <span class=keyword1><span class=command>{</span></span>
        <span class=keyword1><span class=command>from</span></span> assms <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"finite <span class=main>(</span>valid_states <span class=free>Pi</span> <span class=main>::</span> <span class=tfree>'a</span> state set<span class=main>)</span>"</span></span> 
          <span class=keyword1><span class=command>using</span></span> FINITE_valid_states<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>Pi</span></span><span class=main>]</span>
          <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"finite <span class=var>?S</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> FINITE_ALL_DISTINCT_LISTS
          <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>}</span></span>
      <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>{</span></span>
        <span class=keyword1><span class=command>{</span></span>
          <span class=keyword3><span class=command>fix</span></span> <span class=skolem>x</span>
          <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> <span class=var>?ss'</span>"</span></span>
          <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> <span class=var>?S</span>"</span></span> 
          <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=skolem>x</span></span><span class=main>)</span>
            <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>a</span> <span class=skolem>x</span><span class=main>)</span>
            <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> a<span class=main>:</span> <span class=quoted><span class=quoted>"valid_path <span class=free>Pi</span> <span class=main>(</span><span class=skolem>a</span> <span class=main>#</span> <span class=skolem>x</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"distinct <span class=main>(</span><span class=skolem>a</span> <span class=main>#</span> <span class=skolem>x</span><span class=main>)</span>"</span></span>
              <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span><span class=main><span class=keyword3>+</span></span>
            <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>{</span></span>
              <span class=keyword3><span class=command>fix</span></span> <span class=skolem>x'</span> 
              <span class=keyword3><span class=command>assume</span></span> P<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>x'</span> <span class=main>∈</span> set <span class=main>(</span><span class=skolem>a</span> <span class=main>#</span> <span class=skolem>x</span><span class=main>)</span>"</span></span> 
              <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x'</span> <span class=main>∈</span> valid_states <span class=free>Pi</span>"</span></span> 
              <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=skolem>x</span>"</span></span><span class=main>)</span>
                <span class=keyword3><span class=command>case</span></span> Nil
                <span class=keyword1><span class=command>from</span></span> a<span class=main>(</span>1<span class=main>)</span> Nil 
                <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a</span> <span class=main>∈</span> valid_states <span class=free>Pi</span>"</span></span>
                  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
                <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> P Nil 
                <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x'</span> <span class=main>=</span> <span class=skolem>a</span>"</span></span> 
                  <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
                <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
                  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
              <span class=keyword1><span class=command>next</span></span>
                <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>a'</span> <span class=skolem>list</span><span class=main>)</span>
                <span class=keyword1><span class=command>{</span></span>
                  <span class=keyword1><span class=command>{</span></span>
                    <span class=keyword1><span class=command>from</span></span> Cons.prems <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"valid_path <span class=free>Pi</span> <span class=main>(</span><span class=skolem>a</span> <span class=main>#</span> <span class=skolem>x</span><span class=main>)</span>"</span></span>
                      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
                    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a</span> <span class=main>∈</span> valid_states <span class=free>Pi</span>"</span></span> <span class=quoted><span class=quoted>"valid_path <span class=free>Pi</span> <span class=main>(</span><span class=skolem>a'</span> <span class=main>#</span> <span class=skolem>list</span><span class=main>)</span>"</span></span>
                      <span class=keyword1><span class=command>using</span></span> Cons 
                      <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span><span class=main><span class=keyword3>+</span></span>
                  <span class=keyword1><span class=command>}</span></span>
                  <span class=keyword1><span class=command>note</span></span> a <span class=main>=</span> this
                  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>{</span></span>
                    <span class=keyword1><span class=command>from</span></span> Cons.prems <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"distinct <span class=main>(</span><span class=skolem>a</span> <span class=main>#</span> <span class=skolem>x</span><span class=main>)</span>"</span></span>
                      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
                    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"distinct <span class=main>(</span><span class=skolem>a'</span> <span class=main>#</span> <span class=skolem>list</span><span class=main>)</span>"</span></span> 
                      <span class=keyword1><span class=command>using</span></span> Cons
                      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
                  <span class=keyword1><span class=command>}</span></span>
                  <span class=keyword1><span class=command>ultimately</span></span> 
                  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>a'</span> <span class=main>#</span> <span class=skolem>list</span><span class=main>)</span> <span class=main>∈</span> <span class=var>?ss'</span>"</span></span> 
                    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
                  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>a'</span> <span class=main>#</span> <span class=skolem>list</span><span class=main>)</span> <span class=main>∈</span> <span class=var>?S</span>"</span></span> 
                    <span class=keyword1><span class=command>using</span></span> Cons Cons.IH 
                    <span class=keyword1><span class=command>by</span></span> <span class=operator>argo</span>
                <span class=keyword1><span class=command>}</span></span>
                <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
                  <span class=keyword1><span class=command>using</span></span> P a<span class=main>(</span>1<span class=main>)</span> local.Cons set_ConsD
                  <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
              <span class=keyword1><span class=command>qed</span></span>
            <span class=keyword1><span class=command>}</span></span>
            <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
              <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
          <span class=keyword1><span class=command>qed</span></span> <span class=operator>simp</span>
        <span class=keyword1><span class=command>}</span></span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?ss'</span> <span class=main>⊆</span> <span class=var>?S</span>"</span></span>
          <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>}</span></span>
      <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"finite <span class=var>?ss'</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> rev_finite_subset 
        <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>}</span></span>
    <span class=keyword1><span class=command>note</span></span> 2 <span class=main>=</span> this
    <span class=keyword1><span class=command>from</span></span> 1 2 <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"finite <span class=var>?ss</span>"</span></span> 
      <span class=keyword1><span class=command>using</span></span> finite_imageI
      <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=comment1>― ‹NOTE added lemma (refactored from `RD\_bounds\_sublistD`).›</span>
<span class=keyword1 id=TopologicalProps-RD_bounds_sublistD_i_b><span class=command>lemma</span></span> RD_bounds_sublistD_i_b<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>Pi</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> problem"</span></span> 
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>{</span>length <span class=bound>p</span> <span class=main>-</span> <span class=main>1</span> <span class=main>|</span><span class=bound>p</span><span class=main>.</span> valid_path <span class=free>Pi</span> <span class=bound>p</span> <span class=main>∧</span> distinct <span class=bound>p</span><span class=main>}</span> <span class=main>≠</span> <span class=main>{}</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?Q</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>{</span>length <span class=bound>p</span> <span class=main>-</span> <span class=main>1</span> <span class=main>|</span><span class=bound>p</span><span class=main>.</span> valid_path <span class=free>Pi</span> <span class=bound>p</span> <span class=main>∧</span> distinct <span class=bound>p</span><span class=main>}</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?Q'</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>{</span><span class=bound>p</span><span class=main>.</span> valid_path <span class=free>Pi</span> <span class=bound>p</span> <span class=main>∧</span> distinct <span class=bound>p</span><span class=main>}</span>"</span></span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"valid_path <span class=free>Pi</span> <span class=main>[]</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"distinct <span class=main>[]</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>[]</span> <span class=main>∈</span> <span class=var>?Q'</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>note</span></span> 1 <span class=main>=</span> this
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?Q</span> <span class=main>=</span> <span class=main>(</span><span class=main>λ</span><span class=bound>p</span><span class=main>.</span> length <span class=bound>p</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span> <span class=main>`</span> <span class=var>?Q'</span>"</span></span> 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"length <span class=main>[]</span> <span class=main>-</span> <span class=main>1</span> <span class=main>∈</span> <span class=var>?Q</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> 1
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> <span class=main><span class=main>(</span></span>mono_tags<span class=main><span class=main>,</span></span> lifting<span class=main><span class=main>)</span></span> image_iff list.size<span class=main><span class=main>(</span></span>3<span class=main><span class=main>)</span></span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=comment1>― ‹NOTE added lemma (refactored from `RD\_bounds\_sublistD`).›</span>
<span class=keyword1 id=TopologicalProps-RD_bounds_sublistD_i_c><span class=command>lemma</span></span> RD_bounds_sublistD_i_c<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>Pi</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> problem"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=free>as</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>(</span><span class=tfree>'a</span><span class=main>,</span> bool<span class=main>)</span> fmap <span class=main>×</span> <span class=main>(</span><span class=tfree>'a</span><span class=main>,</span> bool<span class=main>)</span> fmap<span class=main>)</span> list"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=free>x</span> 
    <span class=keyword2><span class=keyword>and</span></span> <span class=free>s</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=tfree>'a</span><span class=main>,</span> bool<span class=main>)</span> fmap"</span></span> 
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>s</span> <span class=main>∈</span> valid_states <span class=free>Pi</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>as</span> <span class=main>∈</span> valid_plans <span class=free>Pi</span>"</span></span> 
    <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>y</span><span class=main>.</span> <span class=bound>y</span> <span class=main>∈</span> <span class=main>{</span>length <span class=bound>p</span> <span class=main>-</span> <span class=main>1</span> <span class=main>|</span><span class=bound>p</span><span class=main>.</span> valid_path <span class=free>Pi</span> <span class=bound>p</span> <span class=main>∧</span> distinct <span class=bound>p</span><span class=main>}</span> <span class=main>⟶</span> <span class=bound>y</span> <span class=main>≤</span> <span class=free>x</span><span class=main>)</span>"</span></span> 
    <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>∈</span> <span class=main>{</span>length <span class=bound>p</span> <span class=main>-</span> <span class=main>1</span> <span class=main>|</span><span class=bound>p</span><span class=main>.</span> valid_path <span class=free>Pi</span> <span class=bound>p</span> <span class=main>∧</span> distinct <span class=bound>p</span><span class=main>}</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"Min <span class=main>(</span>PLS <span class=free>s</span> <span class=free>as</span><span class=main>)</span> <span class=main>≤</span> Max <span class=main>{</span>length <span class=bound>p</span> <span class=main>-</span> <span class=main>1</span> <span class=main>|</span><span class=bound>p</span><span class=main>.</span> valid_path <span class=free>Pi</span> <span class=bound>p</span> <span class=main>∧</span> distinct <span class=bound>p</span><span class=main>}</span>"</span></span> 
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?P</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>(</span>PLS <span class=free>s</span> <span class=free>as</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?Q</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>{</span>length <span class=bound>p</span> <span class=main>-</span> <span class=main>1</span> <span class=main>|</span><span class=bound>p</span><span class=main>.</span> valid_path <span class=free>Pi</span> <span class=bound>p</span> <span class=main>∧</span> distinct <span class=bound>p</span><span class=main>}</span>"</span></span>
  <span class=keyword1><span class=command>from</span></span> assms<span class=main>(</span>4<span class=main>)</span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>p</span></span> <span class=keyword2><span class=keyword>where</span></span> 1<span class=main>:</span>
    <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>=</span> length <span class=skolem>p</span> <span class=main>-</span> <span class=main>1</span>"</span></span> <span class=quoted><span class=quoted>"valid_path <span class=free>Pi</span> <span class=skolem>p</span>"</span></span> <span class=quoted><span class=quoted>"distinct <span class=skolem>p</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>p'</span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"valid_path <span class=free>Pi</span> <span class=skolem>p'</span>"</span></span> <span class=quoted><span class=quoted>"distinct <span class=skolem>p'</span>"</span></span> 
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>y</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>y</span> <span class=main>∈</span> <span class=var>?Q</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>y</span> <span class=main>=</span> length <span class=skolem>p'</span> <span class=main>-</span> <span class=main>1</span>"</span></span> 
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
        <span class=comment1>― ‹NOTE we cannot infer <span class=antiquoted><span class=antiquote>@{</span><span class=operator>term</span> <span class=quoted>"length <span class=skolem>p'</span> <span class=main>-</span> <span class=main>1</span> <span class=main>≤</span> length <span class=skolem>p</span> <span class=main>-</span> <span class=main>1</span>"</span><span class=antiquote>}</span></span> since `length p' = 0` might be true.›</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> a<span class=main>:</span> <span class=quoted><span class=quoted>"length <span class=skolem>p'</span> <span class=main>-</span> <span class=main>1</span> <span class=main>≤</span> length <span class=skolem>p</span> <span class=main>-</span> <span class=main>1</span>"</span></span> 
      <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>3<span class=main>)</span> 1<span class=main>(</span>1<span class=main>)</span> 
      <span class=keyword1><span class=command>by</span></span> <span class=operator>meson</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>note</span></span> 2 <span class=main>=</span> this
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword1><span class=command>from</span></span> finite_PLS PLS_NEMPTY
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"finite <span class=main>(</span>PLS <span class=free>s</span> <span class=free>as</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"PLS <span class=free>s</span> <span class=free>as</span> <span class=main>≠</span> <span class=main>{}</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span><span class=main><span class=keyword3>+</span></span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>{</span></span>
      <span class=keyword3><span class=command>fix</span></span> <span class=skolem>n</span>
      <span class=keyword3><span class=command>assume</span></span> P<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>y</span><span class=main>.</span> <span class=bound>y</span> <span class=main>∈</span> PLS <span class=free>s</span> <span class=free>as</span> <span class=main>⟶</span> <span class=skolem>n</span> <span class=main>≤</span> <span class=bound>y</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>n</span> <span class=main>∈</span> PLS <span class=free>s</span> <span class=free>as</span>"</span></span>
      <span class=keyword1><span class=command>from</span></span> P<span class=main>(</span>2<span class=main>)</span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>as'</span></span> <span class=keyword2><span class=keyword>where</span></span> i<span class=main>:</span> 
        <span class=quoted><span class=quoted>"<span class=skolem>n</span> <span class=main>=</span> length <span class=skolem>as'</span>"</span></span> <span class=quoted><span class=quoted>"exec_plan <span class=free>s</span> <span class=skolem>as'</span> <span class=main>=</span> exec_plan <span class=free>s</span> <span class=free>as</span>"</span></span> <span class=quoted><span class=quoted>"subseq <span class=skolem>as'</span> <span class=free>as</span>"</span></span>
        <span class=keyword1><span class=command>unfolding</span></span> PLS_def
        <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?p'</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"statelist' <span class=free>s</span> <span class=skolem>as'</span>"</span></span>
      <span class=keyword1><span class=command>{</span></span>
        <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"length <span class=skolem>as'</span> <span class=main>=</span> length <span class=var>?p'</span> <span class=main>-</span> <span class=main>1</span>"</span></span> 
          <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> LENGTH_statelist'<span class=main>)</span>        
            <span class=comment1>― ‹MARKER (topologicalPropsScript.sml:195)›</span>
        <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>1</span> <span class=main>+</span> <span class=main>(</span>length <span class=skolem>p</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span> <span class=main>=</span> length <span class=skolem>p</span> <span class=main>-</span> <span class=main>1</span> <span class=main>+</span> <span class=main>1</span>"</span></span> 
          <span class=keyword1><span class=command>by</span></span> <span class=operator>presburger</span>
            <span class=comment1>― ‹MARKER (topologicalPropsScript.sml:200)›</span>
        <span class=keyword1><span class=command>{</span></span>
          <span class=keyword1><span class=command>from</span></span> assms<span class=main>(</span>2<span class=main>)</span> i<span class=main>(</span>3<span class=main>)</span> sublist_valid_plan
          <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>as'</span> <span class=main>∈</span> valid_plans <span class=free>Pi</span>"</span></span> 
            <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
          <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"valid_path <span class=free>Pi</span> <span class=var>?p'</span>"</span></span>
            <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>)</span> valid_path_statelist'
            <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
        <span class=keyword1><span class=command>}</span></span>
        <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>{</span></span>
          <span class=keyword1><span class=command>{</span></span>
            <span class=keyword3><span class=command>assume</span></span> C<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>¬</span>distinct <span class=var>?p'</span>"</span></span>
              <span class=comment1>― ‹NOTE renamed variable `drop` to `drop'` to avoid shadowing of the function by the 
            same name in Isabelle/HOL.›</span>
            <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>rs</span></span> <span class=skolem><span class=skolem>pfx</span></span> <span class=skolem><span class=skolem>drop'</span></span> <span class=skolem><span class=skolem>tail</span></span> <span class=keyword2><span class=keyword>where</span></span> C_1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=var>?p'</span> <span class=main>=</span> <span class=skolem>pfx</span> <span class=main>@</span> <span class=main>[</span><span class=skolem>rs</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>drop'</span> <span class=main>@</span> <span class=main>[</span><span class=skolem>rs</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>tail</span>"</span></span> 
              <span class=keyword1><span class=command>using</span></span> not_distinct_decomp<span class=main>[</span><span class=operator>OF</span> C<span class=main>]</span>
              <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
            <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?pfxn</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"length <span class=skolem>pfx</span>"</span></span>
            <span class=keyword1><span class=command>have</span></span> C_2<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=var>?p'</span> <span class=main>!</span> <span class=var>?pfxn</span> <span class=main>=</span> <span class=skolem>rs</span>"</span></span>
              <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> C_1<span class=main>)</span> 
            <span class=keyword1><span class=command>from</span></span> LENGTH_statelist'
            <span class=keyword1><span class=command>have</span></span> C_3<span class=main>:</span> <span class=quoted><span class=quoted>"length <span class=skolem>as'</span> <span class=main>+</span> <span class=main>1</span> <span class=main>=</span> length <span class=var>?p'</span>"</span></span> 
              <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
            <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?pfxn</span> <span class=main>≤</span> length <span class=skolem>as'</span>"</span></span>
              <span class=keyword1><span class=command>using</span></span> C_1
              <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
            <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> C_4<span class=main>:</span> <span class=quoted><span class=quoted>"exec_plan <span class=free>s</span> <span class=main>(</span>take <span class=var>?pfxn</span> <span class=skolem>as'</span><span class=main>)</span> <span class=main>=</span> <span class=skolem>rs</span>"</span></span> 
              <span class=keyword1><span class=command>using</span></span> C_2 statelist'_TAKE
              <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
            <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?prsd</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"length <span class=main>(</span><span class=skolem>pfx</span> <span class=main>@</span> <span class=main>[</span><span class=skolem>rs</span><span class=main>]</span> <span class=main>@</span> <span class=skolem>drop'</span><span class=main>)</span>"</span></span>
            <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?ap1</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"take <span class=var>?pfxn</span> <span class=skolem>as'</span>"</span></span> 
              <span class=comment1>― ‹MARKER (topologicalPropsScript.sml:215)›</span>
            <span class=keyword1><span class=command>from</span></span> C_1 
            <span class=keyword1><span class=command>have</span></span> C_5<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=var>?p'</span> <span class=main>!</span> <span class=var>?prsd</span> <span class=main>=</span> <span class=skolem>rs</span>"</span></span>
              <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> append_Cons length_append nth_append_length nth_append_length_plus<span class=main>)</span>
            <span class=keyword1><span class=command>from</span></span> C_1 C_3 
            <span class=keyword1><span class=command>have</span></span> C_6<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=var>?prsd</span> <span class=main>≤</span> length <span class=skolem>as'</span>"</span></span> 
              <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
            <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> C_7<span class=main>:</span> <span class=quoted><span class=quoted>"exec_plan <span class=free>s</span> <span class=main>(</span>take <span class=var>?prsd</span> <span class=skolem>as'</span><span class=main>)</span> <span class=main>=</span> <span class=skolem>rs</span>"</span></span> 
              <span class=keyword1><span class=command>using</span></span> C_5 statelist'_TAKE
              <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
            <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?ap2</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"take <span class=var>?prsd</span> <span class=skolem>as'</span>"</span></span>
            <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?asfx</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"drop <span class=var>?prsd</span> <span class=skolem>as'</span>"</span></span> 
            <span class=keyword1><span class=command>have</span></span> C_8<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>as'</span> <span class=main>=</span> <span class=var>?ap2</span> <span class=main>@</span> <span class=var>?asfx</span>"</span></span>
              <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
            <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"exec_plan <span class=free>s</span> <span class=skolem>as'</span> <span class=main>=</span> exec_plan <span class=main>(</span>exec_plan <span class=free>s</span> <span class=var>?ap2</span><span class=main>)</span> <span class=var>?asfx</span>"</span></span>
              <span class=keyword1><span class=command>using</span></span> exec_plan_Append
              <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
            <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> C_9<span class=main>:</span> <span class=quoted><span class=quoted>"exec_plan <span class=free>s</span> <span class=skolem>as'</span> <span class=main>=</span> exec_plan <span class=free>s</span> <span class=main>(</span><span class=var>?ap1</span> <span class=main>@</span> <span class=var>?asfx</span><span class=main>)</span>"</span></span>
              <span class=keyword1><span class=command>using</span></span> C_4 C_7 exec_plan_Append
              <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
            <span class=keyword1><span class=command>from</span></span> C_6 
            <span class=keyword1><span class=command>have</span></span> C_10<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span>length <span class=var>?ap1</span> <span class=main>=</span> <span class=var>?pfxn</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span>length <span class=var>?ap2</span> <span class=main>=</span> <span class=var>?prsd</span><span class=main>)</span>"</span></span> 
              <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
            <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> C_11<span class=main>:</span> <span class=quoted><span class=quoted>"length <span class=main>(</span><span class=var>?ap1</span> <span class=main>@</span> <span class=var>?asfx</span><span class=main>)</span> <span class=main>&lt;</span> length <span class=main>(</span><span class=var>?ap2</span> <span class=main>@</span> <span class=var>?asfx</span><span class=main>)</span>"</span></span>
              <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
            <span class=keyword1><span class=command>{</span></span>         
              <span class=keyword1><span class=command>from</span></span> C_10 
              <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?pfxn</span> <span class=main>+</span> length <span class=var>?asfx</span> <span class=main>=</span> length <span class=main>(</span><span class=var>?ap1</span> <span class=main>@</span> <span class=var>?asfx</span><span class=main>)</span>"</span></span>   
                <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
              <span class=keyword1><span class=command>from</span></span> C_9 i<span class=main>(</span>2<span class=main>)</span>
              <span class=keyword1><span class=command>have</span></span> C_12<span class=main>:</span> <span class=quoted><span class=quoted>"exec_plan <span class=free>s</span> <span class=main>(</span><span class=var>?ap1</span> <span class=main>@</span> <span class=var>?asfx</span><span class=main>)</span> <span class=main>=</span> exec_plan <span class=free>s</span> <span class=free>as</span>"</span></span> 
                <span class=keyword1><span class=command>by</span></span> <span class=operator>argo</span>
              <span class=keyword1><span class=command>{</span></span>
                <span class=keyword1><span class=command>{</span></span>
                  <span class=keyword1><span class=command>{</span></span>
                    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"prefix <span class=var>?ap1</span> <span class=var>?ap2</span>"</span></span>
                      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> <span class=main><span class=main>(</span></span>no_types<span class=main><span class=main>)</span></span> length_append prefix_def take_add<span class=main>)</span> 
                    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"subseq <span class=var>?ap1</span> <span class=var>?ap2</span>"</span></span>
                      <span class=keyword1><span class=command>using</span></span> isPREFIX_sublist
                      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
                  <span class=keyword1><span class=command>}</span></span>
                  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"sublist <span class=var>?asfx</span> <span class=var>?asfx</span>"</span></span>
                    <span class=keyword1><span class=command>using</span></span> sublist_refl
                    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
                  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"subseq <span class=main>(</span><span class=var>?ap1</span> <span class=main>@</span> <span class=var>?asfx</span><span class=main>)</span> <span class=skolem>as'</span>"</span></span>
                    <span class=keyword1><span class=command>using</span></span> C_8 subseq_append
                    <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
                <span class=keyword1><span class=command>}</span></span>
                <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>from</span></span> i<span class=main>(</span>3<span class=main>)</span>
                <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"subseq <span class=skolem>as'</span> <span class=free>as</span>"</span></span>
                  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
                <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"subseq <span class=main>(</span><span class=var>?ap1</span> <span class=main>@</span> <span class=var>?asfx</span><span class=main>)</span> <span class=free>as</span>"</span></span>
                  <span class=keyword1><span class=command>using</span></span> sublist_trans
                  <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
              <span class=keyword1><span class=command>}</span></span>
              <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"length <span class=main>(</span><span class=var>?ap1</span> <span class=main>@</span> <span class=var>?asfx</span><span class=main>)</span> <span class=main>∈</span> PLS <span class=free>s</span> <span class=free>as</span>"</span></span>
                <span class=keyword1><span class=command>unfolding</span></span> PLS_def 
                <span class=keyword1><span class=command>using</span></span> C_12 
                <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
            <span class=keyword1><span class=command>}</span></span>
            <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted>False</span> 
              <span class=keyword1><span class=command>using</span></span> P<span class=main>(</span>1<span class=main>)</span> i<span class=main>(</span>1<span class=main>)</span> C_10
              <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
          <span class=keyword1><span class=command>}</span></span>
          <span class=keyword1><span class=command>hence</span></span> <span class=quoted><span class=quoted>"distinct <span class=var>?p'</span>"</span></span> 
            <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
        <span class=keyword1><span class=command>}</span></span>
        <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"length <span class=var>?p'</span> <span class=main>-</span> <span class=main>1</span> <span class=main>≤</span> length <span class=skolem>p</span> <span class=main>-</span> <span class=main>1</span>"</span></span> 
          <span class=keyword1><span class=command>using</span></span> 2 
          <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>}</span></span>
      <span class=keyword1><span class=command>note</span></span> ii <span class=main>=</span> this
      <span class=keyword1><span class=command>{</span></span>
        <span class=keyword1><span class=command>from</span></span> i<span class=main>(</span>1<span class=main>)</span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>n</span> <span class=main>+</span> <span class=main>1</span> <span class=main>=</span> length <span class=var>?p'</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> LENGTH_statelist'<span class=main>[</span><span class=operator>symmetric</span><span class=main>]</span>
          <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
        <span class=keyword1><span class=command>also</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>…</span> <span class=main>≤</span> <span class=main>1</span> <span class=main>+</span> <span class=main>(</span>length <span class=skolem>p</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> ii
          <span class=keyword1><span class=command>by</span></span> <span class=operator>linarith</span>
        <span class=keyword1><span class=command>finally</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>n</span> <span class=main>≤</span> length <span class=skolem>p</span> <span class=main>-</span> <span class=main>1</span>"</span></span> 
          <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
      <span class=keyword1><span class=command>}</span></span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>n</span> <span class=main>≤</span> length <span class=skolem>p</span> <span class=main>-</span> <span class=main>1</span>"</span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>}</span></span>
    <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Min <span class=var>?P</span> <span class=main>≤</span> length <span class=skolem>p</span> <span class=main>-</span> <span class=main>1</span>"</span></span> 
      <span class=keyword1><span class=command>using</span></span> MIN_SET_ELIM'<span class=main>[</span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> P<span class=main><span class=main>=</span></span><span class=quoted><span class=quoted>"<span class=var>?P</span>"</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>and</span></span></span> Q<span class=main><span class=main>=</span></span><span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>x</span><span class=main>.</span> <span class=bound>x</span> <span class=main>≤</span> length <span class=skolem>p</span> <span class=main>-</span> <span class=main>1</span>"</span></span><span class=main>]</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>note</span></span> 3 <span class=main>=</span> this
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"length <span class=skolem>p</span> <span class=main>-</span> <span class=main>1</span> <span class=main>≤</span> Max <span class=main>{</span>length <span class=bound>p</span> <span class=main>-</span> <span class=main>1</span> <span class=main>|</span><span class=bound>p</span><span class=main>.</span> valid_path <span class=free>Pi</span> <span class=bound>p</span> <span class=main>∧</span> distinct <span class=bound>p</span><span class=main>}</span>"</span></span> 
      <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>3<span class=main>,</span> 4<span class=main>)</span> 1<span class=main>(</span>1<span class=main>)</span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>smt</span> Max.coboundedI bdd_aboveI bdd_above_nat<span class=main>)</span>
    <span class=keyword1><span class=command>moreover</span></span> 
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Min <span class=main>(</span>PLS <span class=free>s</span> <span class=free>as</span><span class=main>)</span> <span class=main>≤</span> length <span class=skolem>p</span> <span class=main>-</span> <span class=main>1</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> 3
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>ultimately</span></span> 
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Min <span class=main>(</span>PLS <span class=free>s</span> <span class=free>as</span><span class=main>)</span> <span class=main>≤</span> Max <span class=main>{</span>length <span class=bound>p</span> <span class=main>-</span> <span class=main>1</span> <span class=main>|</span><span class=bound>p</span><span class=main>.</span> valid_path <span class=free>Pi</span> <span class=bound>p</span> <span class=main>∧</span> distinct <span class=bound>p</span><span class=main>}</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>linarith</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=comment1>― ‹NOTE added lemma (refactored from `RD\_bounds\_sublistD`).›</span>
<span class=keyword1 id=TopologicalProps-RD_bounds_sublistD_i><span class=command>lemma</span></span> RD_bounds_sublistD_i<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>Pi</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> problem"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=free>x</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"finite <span class=free>Pi</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>y</span><span class=main>.</span> <span class=bound>y</span> <span class=main>∈</span> MPLS <span class=free>Pi</span> <span class=main>⟶</span> <span class=bound>y</span> <span class=main>≤</span> <span class=free>x</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>∈</span> MPLS <span class=free>Pi</span>"</span></span> 
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>≤</span> Max <span class=main>{</span>length <span class=bound>p</span> <span class=main>-</span> <span class=main>1</span> <span class=main>|</span><span class=bound>p</span><span class=main>.</span> valid_path <span class=free>Pi</span> <span class=bound>p</span> <span class=main>∧</span> distinct <span class=bound>p</span><span class=main>}</span>"</span></span> 
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?P</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"MPLS <span class=free>Pi</span>"</span></span>
    <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?Q</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>{</span>length <span class=bound>p</span> <span class=main>-</span> <span class=main>1</span> <span class=main>|</span><span class=bound>p</span><span class=main>.</span> valid_path <span class=free>Pi</span> <span class=bound>p</span> <span class=main>∧</span> distinct <span class=bound>p</span><span class=main>}</span>"</span></span>
    <span class=keyword1><span class=command>from</span></span> assms<span class=main>(</span>3<span class=main>)</span> 
    <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>s</span></span> <span class=skolem><span class=skolem>as</span></span> <span class=keyword2><span class=keyword>where</span></span> 1<span class=main>:</span>
      <span class=quoted><span class=quoted>"<span class=skolem>s</span> <span class=main>∈</span> valid_states <span class=free>Pi</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>as</span> <span class=main>∈</span> valid_plans <span class=free>Pi</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>=</span> Inf <span class=main>(</span>PLS <span class=skolem>s</span> <span class=skolem>as</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> MPLS_def
      <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>≤</span> Max <span class=var>?Q</span>"</span></span> <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
      <span class=keyword1><span class=command>text</span></span> <span class=quoted><span class=plain_text>‹ Show that `x` is not only the infimum but also the minimum of `PLS s as`.›</span></span>
      <span class=keyword1><span class=command>{</span></span>
        <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"finite <span class=main>(</span>PLS <span class=skolem>s</span> <span class=skolem>as</span><span class=main>)</span>"</span></span> 
          <span class=keyword1><span class=command>using</span></span> finite_PLS 
          <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
        <span class=keyword1><span class=command>moreover</span></span> 
        <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"PLS <span class=skolem>s</span> <span class=skolem>as</span> <span class=main>≠</span> <span class=main>{}</span>"</span></span> 
          <span class=keyword1><span class=command>using</span></span> PLS_NEMPTY
          <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
        <span class=keyword1><span class=command>ultimately</span></span> 
        <span class=keyword1><span class=command>have</span></span> a<span class=main>:</span> <span class=quoted><span class=quoted>"Inf <span class=main>(</span>PLS <span class=skolem>s</span> <span class=skolem>as</span><span class=main>)</span> <span class=main>=</span> Min <span class=main>(</span>PLS <span class=skolem>s</span> <span class=skolem>as</span><span class=main>)</span>"</span></span> 
          <span class=keyword1><span class=command>using</span></span> cInf_eq_Min<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"PLS <span class=skolem>s</span> <span class=skolem>as</span>"</span></span><span class=main>]</span>
          <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
        <span class=keyword1><span class=command>from</span></span> 1<span class=main>(</span>3<span class=main>)</span> a <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>=</span> Min <span class=main>(</span>PLS <span class=skolem>s</span> <span class=skolem>as</span><span class=main>)</span>"</span></span>
          <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>}</span></span>
      <span class=keyword1><span class=command>note</span></span> a <span class=main>=</span> this
      <span class=keyword1><span class=command>{</span></span>
        <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?limit</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"Min <span class=main>(</span>PLS <span class=skolem>s</span> <span class=skolem>as</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>from</span></span> assms<span class=main>(</span>1<span class=main>)</span> 
        <span class=keyword1><span class=command>have</span></span> a<span class=main>:</span> <span class=quoted><span class=quoted>"finite <span class=var>?Q</span>"</span></span> 
          <span class=keyword1><span class=command>using</span></span> RD_bounds_sublistD_i_a
          <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
        <span class=keyword1><span class=command>have</span></span> b<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=var>?Q</span> <span class=main>≠</span> <span class=main>{}</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> RD_bounds_sublistD_i_b 
          <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
        <span class=keyword1><span class=command>from</span></span> 1<span class=main>(</span>1<span class=main>,</span> 2<span class=main>)</span> 
        <span class=keyword1><span class=command>have</span></span> c<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>x</span><span class=main>.</span> <span class=main>(</span><span class=main>∀</span><span class=bound>y</span><span class=main>.</span> <span class=bound>y</span> <span class=main>∈</span> <span class=var>?Q</span> <span class=main>⟶</span> <span class=bound>y</span> <span class=main>≤</span> <span class=bound>x</span><span class=main>)</span> <span class=main>∧</span> <span class=bound>x</span> <span class=main>∈</span> <span class=var>?Q</span> <span class=main>⟶</span> <span class=var>?limit</span> <span class=main>≤</span> Max <span class=var>?Q</span>"</span></span> 
          <span class=keyword1><span class=command>using</span></span> RD_bounds_sublistD_i_c
          <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
        <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?limit</span> <span class=main>≤</span> Max <span class=var>?Q</span>"</span></span> 
          <span class=keyword1><span class=command>using</span></span> MAX_SET_ELIM'<span class=main>[</span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> P<span class=main><span class=main>=</span></span><span class=quoted><span class=quoted>"<span class=var>?Q</span>"</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>and</span></span></span> R<span class=main><span class=main>=</span></span><span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>x</span><span class=main>.</span> <span class=var>?limit</span> <span class=main>≤</span> Max <span class=var>?Q</span>"</span></span><span class=main>,</span> <span class=operator>OF</span> a b c<span class=main>]</span>
          <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>}</span></span>
      <span class=keyword1><span class=command>note</span></span> b <span class=main>=</span> this
      <span class=keyword1><span class=command>from</span></span> a b <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>≤</span> Max <span class=var>?Q</span>"</span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>using</span></span> assms
    <span class=keyword1><span class=command>unfolding</span></span> MPLS_def
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=comment1>― ‹NOTE type of `Pi` had to be fixed for use of `FINITE\_valid\_states`.›</span>
<span class=keyword1 id=TopologicalProps-RD_bounds_sublistD><span class=command>lemma</span></span> RD_bounds_sublistD<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>Pi</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> problem"</span></span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"finite <span class=free>Pi</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"problem_plan_bound <span class=free>Pi</span> <span class=main>≤</span> RD <span class=free>Pi</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?P</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"MPLS <span class=free>Pi</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?Q</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>{</span>length <span class=bound>p</span> <span class=main>-</span> <span class=main>1</span> <span class=main>|</span><span class=bound>p</span><span class=main>.</span> valid_path <span class=free>Pi</span> <span class=bound>p</span> <span class=main>∧</span> distinct <span class=bound>p</span><span class=main>}</span>"</span></span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword1><span class=command>from</span></span> assms 
    <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"finite <span class=var>?P</span>"</span></span> 
      <span class=keyword1><span class=command>using</span></span> FINITE_MPLS
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>from</span></span> assms 
    <span class=keyword1><span class=command>have</span></span> 2<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=var>?P</span> <span class=main>≠</span> <span class=main>{}</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> MPLS_nempty
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>from</span></span> assms 
    <span class=keyword1><span class=command>have</span></span> 3<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>x</span><span class=main>.</span> <span class=main>(</span><span class=main>∀</span><span class=bound>y</span><span class=main>.</span> <span class=bound>y</span> <span class=main>∈</span> <span class=var>?P</span> <span class=main>⟶</span> <span class=bound>y</span> <span class=main>≤</span> <span class=bound>x</span><span class=main>)</span> <span class=main>∧</span> <span class=bound>x</span> <span class=main>∈</span> <span class=var>?P</span> <span class=main>⟶</span> <span class=bound>x</span> <span class=main>≤</span> Max <span class=var>?Q</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> RD_bounds_sublistD_i 
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"Max <span class=var>?P</span> <span class=main>≤</span> Max <span class=var>?Q</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> MAX_SET_ELIM'<span class=main>[</span><span class=operator>OF</span> 1 2 3<span class=main>]</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> 
    <span class=keyword1><span class=command>unfolding</span></span> problem_plan_bound_def RD_def Sup_nat_def
    <span class=keyword1><span class=command>using</span></span> RD_bounds_sublistD_i_b <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span> 
<span class=keyword1><span class=command>qed</span></span>


<span class=comment1>― ‹NOTE type for `PROB` had to be fixed in order to be able to match `sublistD\_bounds\_D`.›</span>
<span class=keyword1><span class=command>theorem</span></span> sublistD_bounds_D_and_RD_bounds_sublistD<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> problem"</span></span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"finite <span class=free>PROB</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"
    problem_plan_bound_charles <span class=free>PROB</span> <span class=main>≤</span> problem_plan_bound <span class=free>PROB</span> 
    <span class=main>∧</span> problem_plan_bound <span class=free>PROB</span> <span class=main>≤</span> RD <span class=free>PROB</span>
  "</span></span>
  <span class=keyword1><span class=command>using</span></span> assms sublistD_bounds_D RD_bounds_sublistD 
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>


<span class=comment1>― ‹NOTE type of `PROB` had to be fixed for MP of lemmas.›</span>
<span class=keyword1 id=TopologicalProps-empty_problem_bound><span class=command>lemma</span></span> empty_problem_bound<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> problem"</span></span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>prob_dom <span class=free>PROB</span> <span class=main>=</span> <span class=main>{}</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>problem_plan_bound <span class=free>PROB</span> <span class=main>=</span> <span class=main>0</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>PROB'</span> <span class=keyword2><span class=keyword>and</span></span> <span class=skolem>as</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>(</span><span class=tfree>'a</span><span class=main>,</span> <span class=tfree>'b</span><span class=main>)</span> fmap <span class=main>×</span> <span class=main>(</span><span class=tfree>'a</span><span class=main>,</span> <span class=tfree>'b</span><span class=main>)</span> fmap<span class=main>)</span> list"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=skolem>s</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=tfree>'a</span><span class=main>,</span> <span class=tfree>'b</span><span class=main>)</span> fmap"</span></span>
    <span class=keyword3><span class=command>assume</span></span> 
      <span class=quoted><span class=quoted>"finite <span class=free>PROB</span>"</span></span> <span class=quoted><span class=quoted>"prob_dom <span class=skolem>PROB'</span> <span class=main>=</span> <span class=main>{}</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>s</span> <span class=main>∈</span> valid_states <span class=skolem>PROB'</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>as</span> <span class=main>∈</span> valid_plans <span class=skolem>PROB'</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"exec_plan <span class=skolem>s</span> <span class=main>[]</span> <span class=main>=</span> exec_plan <span class=skolem>s</span> <span class=skolem>as</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> empty_prob_dom_imp_empty_plan_always_good
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>as'</span><span class=main>.</span> exec_plan <span class=skolem>s</span> <span class=skolem>as</span> <span class=main>=</span> exec_plan <span class=skolem>s</span> <span class=bound>as'</span> <span class=main>∧</span> subseq <span class=bound>as'</span> <span class=skolem>as</span> <span class=main>∧</span> length <span class=bound>as'</span> <span class=main>&lt;</span> <span class=main>1</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> 
    <span class=keyword1><span class=command>using</span></span> bound_on_all_plans_bounds_problem_plan_bound_<span class=main>[</span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> P<span class=main><span class=main>=</span></span><span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>P</span><span class=main>.</span> prob_dom <span class=bound>P</span> <span class=main>=</span> <span class=main>{}</span>"</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>and</span></span></span> f<span class=main><span class=main>=</span></span><span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>P</span><span class=main>.</span> <span class=main>1</span>"</span></span><span class=main>,</span> <span class=operator>of</span> <span class=quoted><span class=free>PROB</span></span><span class=main>]</span>
    <span class=keyword1><span class=command>using</span></span> assms empty_prob_dom_finite 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span> 
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1 id="TopologicalProps-problem_plan_bound_works'"><span class=command>lemma</span></span> problem_plan_bound_works'<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> problem"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=free>as</span> <span class=free>s</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"finite <span class=free>PROB</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>s</span> <span class=main>∈</span> valid_states <span class=free>PROB</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>as'</span><span class=main>.</span> 
    <span class=main>(</span>exec_plan <span class=free>s</span> <span class=bound>as'</span> <span class=main>=</span> exec_plan <span class=free>s</span> <span class=free>as</span><span class=main>)</span> 
    <span class=main>∧</span> <span class=main>(</span>subseq <span class=bound>as'</span> <span class=free>as</span><span class=main>)</span>
    <span class=main>∧</span> <span class=main>(</span>length <span class=bound>as'</span> <span class=main>≤</span> problem_plan_bound <span class=free>PROB</span><span class=main>)</span> 
    <span class=main>∧</span> <span class=main>(</span>sat_precond_as <span class=free>s</span> <span class=bound>as'</span><span class=main>)</span>
  <span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>as'</span></span> <span class=keyword2><span class=keyword>where</span></span> 1<span class=main>:</span>
    <span class=quoted><span class=quoted>"exec_plan <span class=free>s</span> <span class=free>as</span> <span class=main>=</span> exec_plan <span class=free>s</span> <span class=skolem>as'</span>"</span></span> <span class=quoted><span class=quoted>"subseq <span class=skolem>as'</span> <span class=free>as</span>"</span></span> <span class=quoted><span class=quoted>"length <span class=skolem>as'</span> <span class=main>≤</span> problem_plan_bound <span class=free>PROB</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms problem_plan_bound_works 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=comment1>― ‹NOTE this step seems to be handled implicitely in original proof.›</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"rem_condless_act <span class=free>s</span> <span class=main>[]</span> <span class=skolem>as'</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>3<span class=main>)</span> 1<span class=main>(</span>2<span class=main>)</span> rem_condless_valid_10 sublist_valid_plan
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"subseq <span class=main>(</span>rem_condless_act <span class=free>s</span> <span class=main>[]</span> <span class=skolem>as'</span><span class=main>)</span> <span class=skolem>as'</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> rem_condless_valid_8 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"length <span class=main>(</span>rem_condless_act <span class=free>s</span> <span class=main>[]</span> <span class=skolem>as'</span><span class=main>)</span> <span class=main>≤</span> length <span class=skolem>as'</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> rem_condless_valid_3
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"sat_precond_as <span class=free>s</span> <span class=main>(</span>rem_condless_act <span class=free>s</span> <span class=main>[]</span> <span class=skolem>as'</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> rem_condless_valid_2
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"exec_plan <span class=free>s</span> <span class=skolem>as'</span> <span class=main>=</span> exec_plan <span class=free>s</span> <span class=main>(</span>rem_condless_act <span class=free>s</span> <span class=main>[]</span> <span class=skolem>as'</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> rem_condless_valid_1
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=comment1>― ‹TODO remove? Can be solved directly with 'TopologicalProps.bound\_on\_all\_plans\_bounds\_problem\_plan\_bound\_thesis'.›</span>
<span class=keyword1 id=TopologicalProps-problem_plan_bound_UBound><span class=command>lemma</span></span> problem_plan_bound_UBound<span class=main>:</span> 
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>as</span> <span class=bound>s</span><span class=main>.</span>
    <span class=main>(</span><span class=bound>s</span> <span class=main>∈</span> valid_states <span class=free>PROB</span><span class=main>)</span> 
    <span class=main>∧</span> <span class=main>(</span><span class=bound>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span><span class=main>)</span>
    <span class=main>⟶</span> <span class=main>(</span><span class=main>∃</span><span class=bound>as'</span><span class=main>.</span>
      <span class=main>(</span>exec_plan <span class=bound>s</span> <span class=bound>as</span> <span class=main>=</span> exec_plan <span class=bound>s</span> <span class=bound>as'</span><span class=main>)</span> 
      <span class=main>∧</span> subseq <span class=bound>as'</span> <span class=bound>as</span> 
      <span class=main>∧</span> <span class=main>(</span>length <span class=bound>as'</span> <span class=main>&lt;</span> <span class=free>f</span> <span class=free>PROB</span><span class=main>)</span>
    <span class=main>)</span>
  <span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"finite <span class=free>PROB</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>problem_plan_bound <span class=free>PROB</span> <span class=main>&lt;</span> <span class=free>f</span> <span class=free>PROB</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?P</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>Pr</span><span class=main>.</span> <span class=free>PROB</span> <span class=main>=</span> <span class=bound>Pr</span>"</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?P</span> <span class=free>PROB</span>"</span></span> <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>using</span></span> assms bound_on_all_plans_bounds_problem_plan_bound_<span class=main>[</span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> P <span class=main><span class=main>=</span></span> <span class=var><span class=quoted><span class=var>?P</span></span></span><span class=main>]</span> 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
<span class=keyword1><span class=command>qed</span></span> 

<span class=keyword1><span class=command>subsection</span></span> <span class=quoted><span class=plain_text>"Traversal Diameter"</span></span>


<span class=comment1>― ‹NOTE name shortened.›</span>
<span class=keyword1><span class=command>definition</span></span> <span class=entity>traversed_states</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>traversed_states</span> <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=free><span class=bound><span class=entity>as</span></span></span> <span class=main>≡</span> set <span class=main>(</span>state_list <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=free><span class=bound><span class=entity>as</span></span></span><span class=main>)</span>"</span></span> 


<span class=keyword1 id=TopologicalProps-finite_traversed_states><span class=command>lemma</span></span> finite_traversed_states<span class=main>:</span> <span class=quoted><span class=quoted>"finite <span class=main>(</span>traversed_states <span class=free>s</span> <span class=free>as</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> traversed_states_def
  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>


<span class=keyword1 id=TopologicalProps-traversed_states_nempty><span class=command>lemma</span></span> traversed_states_nempty<span class=main>:</span> <span class=quoted><span class=quoted>"traversed_states <span class=free>s</span> <span class=free>as</span> <span class=main>≠</span> <span class=main>{}</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> traversed_states_def 
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>as</span></span><span class=main>)</span> <span class=operator>auto</span>


<span class=keyword1 id=TopologicalProps-traversed_states_geq_1><span class=command>lemma</span></span> traversed_states_geq_1<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>s</span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>1</span> <span class=main>≤</span> card <span class=main>(</span>traversed_states <span class=free>s</span> <span class=free>as</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"card <span class=main>(</span>traversed_states <span class=free>s</span> <span class=free>as</span><span class=main>)</span> <span class=main>≠</span> <span class=main>0</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> traversed_states_nempty finite_traversed_states card_0_eq
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=main>1</span> <span class=main>≤</span> card <span class=main>(</span>traversed_states <span class=free>s</span> <span class=free>as</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>linarith</span> 
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1 id=TopologicalProps-init_is_traversed><span class=command>lemma</span></span> init_is_traversed<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>s</span> <span class=main>∈</span> traversed_states <span class=free>s</span> <span class=free>as</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> traversed_states_def
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>as</span></span><span class=main>)</span> <span class=operator>auto</span>


<span class=comment1>― ‹NOTE name shortened.›</span>
<span class=keyword1><span class=command>definition</span></span> <span class=entity>td</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>td</span> <span class=free><span class=bound><span class=entity>PROB</span></span></span> <span class=main>≡</span> Sup <span class=main>{</span>
    <span class=main>(</span>card <span class=main>(</span>traversed_states <span class=main>(</span>fst <span class=bound>p</span><span class=main>)</span> <span class=main>(</span>snd <span class=bound>p</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>-</span> <span class=main>1</span> 
    <span class=main>|</span> <span class=bound>p</span><span class=main>.</span> <span class=main>(</span>fst <span class=bound>p</span> <span class=main>∈</span> valid_states <span class=free><span class=bound><span class=entity>PROB</span></span></span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span>snd <span class=bound>p</span> <span class=main>∈</span> valid_plans <span class=free><span class=bound><span class=entity>PROB</span></span></span><span class=main>)</span><span class=main>}</span>
  "</span></span>


<span class=keyword1 id=TopologicalProps-traversed_states_rem_condless_act><span class=command>lemma</span></span> traversed_states_rem_condless_act<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>s</span><span class=main>.</span> 
  traversed_states <span class=bound>s</span> <span class=main>(</span>rem_condless_act <span class=bound>s</span> <span class=main>[]</span> <span class=free>as</span><span class=main>)</span> <span class=main>=</span> traversed_states <span class=bound>s</span> <span class=free>as</span>
"</span></span>
  <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>as</span></span><span class=main>)</span>
  <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> traversed_states_def rem_condless_act_cons<span class=main>)</span>
  <span class=keyword1><span class=command><span class=improper><span class=command>subgoal</span></span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> state_succ_pair<span class=main>)</span>
  <span class=keyword1><span class=command><span class=improper><span class=command>subgoal</span></span></span></span> <span class=keyword1><span class=command>using</span></span> init_is_traversed traversed_states_def <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command><span class=improper><span class=command>subgoal</span></span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> state_succ_pair<span class=main>)</span> 
  <span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>

<span class=comment1>― ‹NOTE added lemma.›</span>
<span class=keyword1 id=TopologicalProps-td_UBound_i><span class=command>lemma</span></span> td_UBound_i<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>(</span><span class=tfree>'a</span><span class=main>,</span> <span class=tfree>'b</span><span class=main>)</span> fmap <span class=main>×</span> <span class=main>(</span><span class=tfree>'a</span><span class=main>,</span> <span class=tfree>'b</span><span class=main>)</span> fmap<span class=main>)</span> set"</span></span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"finite <span class=free>PROB</span>"</span></span> 
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"
  <span class=main>{</span>
    <span class=main>(</span>card <span class=main>(</span>traversed_states <span class=main>(</span>fst <span class=bound>p</span><span class=main>)</span> <span class=main>(</span>snd <span class=bound>p</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>-</span> <span class=main>1</span> 
    <span class=main>|</span> <span class=bound>p</span><span class=main>.</span> <span class=main>(</span>fst <span class=bound>p</span> <span class=main>∈</span> valid_states <span class=free>PROB</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span>snd <span class=bound>p</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span><span class=main>)</span><span class=main>}</span>
  <span class=main>≠</span> <span class=main>{}</span>
  "</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?S</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>{</span><span class=bound>p</span><span class=main>.</span> <span class=main>(</span>fst <span class=bound>p</span> <span class=main>∈</span> valid_states <span class=free>PROB</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span>snd <span class=bound>p</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span><span class=main>)</span><span class=main>}</span>"</span></span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>s</span></span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> state"</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>s</span> <span class=main>∈</span> valid_states <span class=free>PROB</span>"</span></span> 
    <span class=keyword1><span class=command>using</span></span> assms valid_states_nempty
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>[]</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> empty_plan_is_valid
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?S</span> <span class=main>≠</span> <span class=main>{}</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms valid_states_nempty 
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>  
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span> 
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=TopologicalProps-td_UBound><span class=command>lemma</span></span> td_UBound<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>(</span><span class=tfree>'a</span><span class=main>,</span> <span class=tfree>'b</span><span class=main>)</span> fmap <span class=main>×</span> <span class=main>(</span><span class=tfree>'a</span><span class=main>,</span> <span class=tfree>'b</span><span class=main>)</span> fmap<span class=main>)</span> set"</span></span> 
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"finite <span class=free>PROB</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>s</span> <span class=bound>as</span><span class=main>.</span> 
    <span class=main>(</span>sat_precond_as <span class=bound>s</span> <span class=bound>as</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=bound>s</span> <span class=main>∈</span> valid_states <span class=free>PROB</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=bound>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span><span class=main>)</span> 
    <span class=main>⟶</span> <span class=main>(</span>card <span class=main>(</span>traversed_states <span class=bound>s</span> <span class=bound>as</span><span class=main>)</span> <span class=main>≤</span> <span class=free>k</span><span class=main>)</span>
  <span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>td <span class=free>PROB</span> <span class=main>≤</span> <span class=free>k</span> <span class=main>-</span> <span class=main>1</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?S</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>{</span>
    <span class=main>(</span>card <span class=main>(</span>traversed_states <span class=main>(</span>fst <span class=bound>p</span><span class=main>)</span> <span class=main>(</span>snd <span class=bound>p</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>-</span> <span class=main>1</span> 
    <span class=main>|</span> <span class=bound>p</span><span class=main>.</span> <span class=main>(</span>fst <span class=bound>p</span> <span class=main>∈</span> valid_states <span class=free>PROB</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span>snd <span class=bound>p</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span><span class=main>)</span><span class=main>}</span>
  "</span></span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>x</span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> <span class=var>?S</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>p</span></span> <span class=keyword2><span class=keyword>where</span></span> 1<span class=main>:</span>
      <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>=</span> card <span class=main>(</span>traversed_states <span class=main>(</span>fst <span class=skolem>p</span><span class=main>)</span> <span class=main>(</span>snd <span class=skolem>p</span><span class=main>)</span><span class=main>)</span> <span class=main>-</span> <span class=main>1</span>"</span></span> <span class=quoted><span class=quoted>"fst <span class=skolem>p</span> <span class=main>∈</span> valid_states <span class=free>PROB</span>"</span></span> 
      <span class=quoted><span class=quoted>"snd <span class=skolem>p</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?s</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"fst <span class=skolem>p</span>"</span></span>
    <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?as</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"snd <span class=skolem>p</span>"</span></span> 
    <span class=keyword1><span class=command>{</span></span>
      <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?as'</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>(</span>rem_condless_act <span class=var>?s</span> <span class=main>[]</span> <span class=var>?as</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>have</span></span> 2<span class=main>:</span> <span class=quoted><span class=quoted>"traversed_states <span class=var>?s</span> <span class=var>?as</span> <span class=main>=</span> traversed_states <span class=var>?s</span> <span class=var>?as'</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> traversed_states_rem_condless_act
        <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"sat_precond_as <span class=var>?s</span> <span class=var>?as'</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> rem_condless_valid_2
        <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?as'</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> 1<span class=main>(</span>3<span class=main>)</span> rem_condless_valid_10
        <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"card <span class=main>(</span>traversed_states <span class=var>?s</span> <span class=var>?as'</span><span class=main>)</span> <span class=main>≤</span> <span class=free>k</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>2<span class=main>)</span> 1<span class=main>(</span>2<span class=main>)</span>
        <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span> 
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"card <span class=main>(</span>traversed_states <span class=var>?s</span> <span class=var>?as</span><span class=main>)</span> <span class=main>≤</span> <span class=free>k</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> 2
        <span class=keyword1><span class=command>by</span></span> <span class=operator>argo</span>
    <span class=keyword1><span class=command>}</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>≤</span> <span class=free>k</span> <span class=main>-</span> <span class=main>1</span>"</span></span> 
      <span class=keyword1><span class=command>using</span></span> 1
      <span class=keyword1><span class=command>by</span></span> <span class=operator>linarith</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?S</span> <span class=main>≠</span> <span class=main>{}</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms td_UBound_i
    <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>unfolding</span></span> td_def
    <span class=keyword1><span class=command>using</span></span> td_UBound_i bound_main_lemma_2<span class=main>[</span><span class=operator>of</span> <span class=var><span class=quoted><span class=var>?S</span></span></span> <span class=quoted><span class=quoted>"<span class=free>k</span> <span class=main>-</span> <span class=main>1</span>"</span></span><span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>presburger</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword2><span class=keyword>end</span></span></pre>
</div><div id=SystemAbstraction>
<div class=head>
<h1>Theory SystemAbstraction</h1>
</div>
<pre class=source><span class=keyword1><span class=command>theory</span></span> SystemAbstraction
  <span class=keyword2><span class=keyword>imports</span></span>
    <a href=https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html>Main</a>
    <span class=quoted>"<a href=https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Sublist.html>HOL-Library.Sublist</a>"</span>
    <span class=quoted>"<a href=https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Finite_Map.html>HOL-Library.Finite_Map</a>"</span>
    <a href=#FactoredSystem>FactoredSystem</a>
    <a href=#FactoredSystemLib>FactoredSystemLib</a>
    <a href=#ActionSeqProcess>ActionSeqProcess</a>
    <a href=#Dependency>Dependency</a>
    <a href=#TopologicalProps>TopologicalProps</a>
    <a href=#FmapUtils>FmapUtils</a>
    <a href=#ListUtils>ListUtils</a>

<span class=keyword2><span class=keyword>begin</span></span>


<span class=comment1>― ‹NOTE  hide 'Map.map\_add' because of conflicting notation with 'FactoredSystemLib.map\_add\_ltr'.›</span>
<span class=keyword1><span class=command>hide_const</span></span> <span class=main>(</span><span class=keyword2><span class=keyword>open</span></span><span class=main>)</span> Map.map_add
<span class=keyword1><span class=command>no_notation</span></span> Map.map_add <span class=main>(</span><span class=keyword2><span class=keyword>infixl</span></span> <span class=quoted>"<span class=keyword1>++</span>"</span> 100<span class=main>)</span>


<span class=keyword1><span class=command>section</span></span> <span class=quoted><span class=plain_text>"System Abstraction"</span></span>

<span class=keyword1><span class=command>text</span></span> <span class=quoted><span class=plain_text>‹ Projection of an object (state, action, sequence of action or factored representation)
to a variable set `vs` restricts the domain of the object or its components---in case of composite
objects---to `vs`. [Abdulaziz et al., p.12]

This section presents the relevant definitions (`action\_proj`, `as\_proj`, `prob\_proj` and `ss\_proj`)
as well as their characterization. ›</span></span>


<span class=keyword1><span class=command>subsection</span></span> <span class=quoted><span class=plain_text>"Projection of Actions, Sequences of Actions and Factored Representations."</span></span>


<span class=keyword1><span class=command>definition</span></span> <span class=entity>action_proj</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>action_proj</span> <span class=free><span class=bound><span class=entity>a</span></span></span> <span class=free><span class=bound><span class=entity>vs</span></span></span> <span class=main>≡</span> <span class=main>(</span>fmrestrict_set <span class=free><span class=bound><span class=entity>vs</span></span></span> <span class=main>(</span>fst <span class=free><span class=bound><span class=entity>a</span></span></span><span class=main>)</span><span class=main>,</span> fmrestrict_set <span class=free><span class=bound><span class=entity>vs</span></span></span> <span class=main>(</span>snd <span class=free><span class=bound><span class=entity>a</span></span></span><span class=main>)</span><span class=main>)</span>"</span></span>


<span class=keyword1 id=SystemAbstraction-action_proj_pair><span class=command>lemma</span></span> action_proj_pair<span class=main>:</span> <span class=quoted><span class=quoted>"action_proj <span class=main>(</span><span class=free>p</span><span class=main>,</span> <span class=free>e</span><span class=main>)</span> <span class=free>vs</span> <span class=main>=</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>p</span><span class=main>,</span> fmrestrict_set <span class=free>vs</span> <span class=free>e</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> action_proj_def
  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>


<span class=keyword1><span class=command>definition</span></span> <span class=entity>prob_proj</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>prob_proj</span> <span class=free><span class=bound><span class=entity>PROB</span></span></span> <span class=free><span class=bound><span class=entity>vs</span></span></span> <span class=main>≡</span> <span class=main>(</span><span class=main>λ</span><span class=bound>a</span><span class=main>.</span> action_proj <span class=bound>a</span> <span class=free><span class=bound><span class=entity>vs</span></span></span><span class=main>)</span> <span class=main>`</span> <span class=free><span class=bound><span class=entity>PROB</span></span></span>"</span></span>


<span class=comment1>― ‹NOTE  using 'fun' due to multiple defining equations.›</span>
<span class=comment1>― ‹NOTE  name shortened.›</span>
<span class=keyword1><span class=command>fun</span></span> <span class=entity>as_proj</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>as_proj</span> <span class=main>[]</span> <span class=main><span class=bound><span class=entity>_</span></span></span> <span class=main>=</span> <span class=main>[]</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>as_proj</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>a</span></span></span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>as</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>vs</span></span></span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>if</span> fmdom' <span class=main>(</span>fmrestrict_set <span class=free><span class=bound><span class=entity>vs</span></span></span> <span class=main>(</span>snd <span class=free><span class=bound><span class=entity>a</span></span></span><span class=main>)</span><span class=main>)</span> <span class=main>≠</span> <span class=main>{}</span>
    <span class=keyword1>then</span> action_proj <span class=free><span class=bound><span class=entity>a</span></span></span> <span class=free><span class=bound><span class=entity>vs</span></span></span> <span class=main>#</span> <span class=free>as_proj</span> <span class=free><span class=bound><span class=entity>as</span></span></span> <span class=free><span class=bound><span class=entity>vs</span></span></span>
    <span class=keyword1>else</span> <span class=free>as_proj</span> <span class=free><span class=bound><span class=entity>as</span></span></span> <span class=free><span class=bound><span class=entity>vs</span></span></span>
  <span class=main>)</span>"</span></span>


<span class=comment1>― ‹TODO the lemma might be superfluous (follows directly from 'as\_proj.simps').›</span>
<span class=keyword1 id=SystemAbstraction-as_proj_pair><span class=command>lemma</span></span> as_proj_pair<span class=main>:</span>
  <span class=quoted><span class=quoted>"as_proj <span class=main>(</span><span class=main>(</span><span class=free>p</span><span class=main>,</span> <span class=free>e</span><span class=main>)</span> <span class=main>#</span> <span class=free>as</span><span class=main>)</span> <span class=free>vs</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>if</span> <span class=main>(</span>fmdom' <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>e</span><span class=main>)</span> <span class=main>≠</span> <span class=main>{}</span><span class=main>)</span>
    <span class=keyword1>then</span> action_proj <span class=main>(</span><span class=free>p</span><span class=main>,</span> <span class=free>e</span><span class=main>)</span> <span class=free>vs</span> <span class=main>#</span> as_proj <span class=free>as</span> <span class=free>vs</span>
    <span class=keyword1>else</span> as_proj <span class=free>as</span> <span class=free>vs</span>
  <span class=main>)</span>"</span></span>
  <span class=quoted><span class=quoted>"as_proj <span class=main>[]</span> <span class=free>vs</span> <span class=main>=</span> <span class=main>[]</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span><span class=main>)</span><span class=main><span class=keyword3>+</span></span>


<span class=keyword1 id=SystemAbstraction-proj_state_succ><span class=command>lemma</span></span> proj_state_succ<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>s</span> <span class=free>a</span> <span class=free>vs</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>fst <span class=free>a</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>  <span class=quoted><span class=quoted>"<span class=main>(</span>state_succ <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span> <span class=main>(</span>action_proj <span class=free>a</span> <span class=free>vs</span><span class=main>)</span> <span class=main>=</span> fmrestrict_set <span class=free>vs</span> <span class=main>(</span>state_succ <span class=free>s</span> <span class=free>a</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"
    fmrestrict_set <span class=free>vs</span> <span class=main>(</span><span class=keyword1>if</span> fst <span class=free>a</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s</span> <span class=keyword1>then</span> snd <span class=free>a</span> <span class=main>++</span> <span class=free>s</span> <span class=keyword1>else</span> <span class=free>s</span><span class=main>)</span>
    <span class=main>=</span> fmrestrict_set <span class=free>vs</span> <span class=main>(</span>snd <span class=free>a</span> <span class=main>++</span> <span class=free>s</span><span class=main>)</span>
  "</span></span>
    <span class=keyword1><span class=command>using</span></span> assms
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"fst <span class=main>(</span>action_proj <span class=free>a</span> <span class=free>vs</span><span class=main>)</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> fmrestrict_set <span class=free>vs</span> <span class=free>s</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"
      <span class=main>(</span>state_succ <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span> <span class=main>(</span>action_proj <span class=free>a</span> <span class=free>vs</span><span class=main>)</span>
       <span class=main>=</span> fmrestrict_set <span class=free>vs</span> <span class=main>(</span>snd <span class=free>a</span> <span class=main>++</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span>
    "</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> state_succ_def action_proj_def fmap_add_ltr_def
      <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span><span class=main>(</span>fst <span class=main>(</span>action_proj <span class=free>a</span> <span class=free>vs</span><span class=main>)</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"
      <span class=main>(</span>state_succ <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span> <span class=main>(</span>action_proj <span class=free>a</span> <span class=free>vs</span><span class=main>)</span>
       <span class=main>=</span> fmrestrict_set <span class=free>vs</span> <span class=main>(</span>snd <span class=free>a</span> <span class=main>++</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span>
    "</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> state_succ_def  action_proj_def
      <span class=keyword1><span class=command>using</span></span> assms fmsubset_restrict_set_mono
      <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>unfolding</span></span> state_succ_def
    <span class=keyword1><span class=command>by</span></span> <span class=operator>argo</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1 id=SystemAbstraction-graph_plan_lemma_1><span class=command>lemma</span></span> graph_plan_lemma_1<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>s</span> <span class=free>vs</span> <span class=free>as</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"sat_precond_as <span class=free>s</span> <span class=free>as</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>exec_plan <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span> <span class=main>(</span>as_proj <span class=free>as</span> <span class=free>vs</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=main>(</span>exec_plan <span class=free>s</span> <span class=free>as</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>as</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>s</span></span> <span class=quoted><span class=free>vs</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>a</span> <span class=skolem>as</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>fmrestrict_set <span class=skolem>vs</span> <span class=main>(</span>snd <span class=skolem>a</span><span class=main>)</span><span class=main>)</span> <span class=main>≠</span> <span class=main>{}</span>"</span></span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> True
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span>
      <span class=quoted><span class=quoted>"state_succ <span class=main>(</span>fmrestrict_set <span class=skolem>vs</span> <span class=skolem>s</span><span class=main>)</span> <span class=main>(</span>action_proj <span class=skolem>a</span> <span class=skolem>vs</span><span class=main>)</span> <span class=main>=</span> fmrestrict_set <span class=skolem>vs</span> <span class=main>(</span>state_succ <span class=skolem>s</span> <span class=skolem>a</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> Cons.prems proj_state_succ
      <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>unfolding</span></span> exec_plan.simps sat_precond_as.simps as_proj.simps
      <span class=keyword1><span class=command>using</span></span> Cons.IH Cons.prems True
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> False
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>fmdom' <span class=main>(</span>snd <span class=skolem>a</span><span class=main>)</span> <span class=main>∩</span> <span class=skolem>vs</span> <span class=main>=</span> <span class=main>{}</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> False fmdom'_restrict_set_precise<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=skolem>vs</span></span> <span class=quoted><span class=quoted>"snd <span class=skolem>a</span>"</span></span><span class=main>]</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>argo</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmrestrict_set <span class=skolem>vs</span> <span class=skolem>s</span> <span class=main>=</span> fmrestrict_set <span class=skolem>vs</span> <span class=main>(</span>state_succ <span class=skolem>s</span> <span class=skolem>a</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> disj_imp_eq_proj_exec
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>unfolding</span></span> exec_plan.simps sat_precond_as.simps as_proj.simps
      <span class=keyword1><span class=command>using</span></span> Cons.IH Cons.prems False
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>qed</span></span> <span class=operator>simp</span>


<span class=comment1>― ‹TODO the proofs are inefficient (detailed proofs?).›</span>
<span class=keyword1 id=SystemAbstraction-proj_action_dom_eq_inter><span class=command>lemma</span></span>  proj_action_dom_eq_inter<span class=main>:</span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"
    action_dom <span class=main>(</span>fst <span class=main>(</span>action_proj <span class=free>a</span> <span class=free>vs</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>snd <span class=main>(</span>action_proj <span class=free>a</span> <span class=free>vs</span><span class=main>)</span><span class=main>)</span>
    <span class=main>=</span> <span class=main>(</span>action_dom <span class=main>(</span>fst <span class=free>a</span><span class=main>)</span> <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span> <span class=main>∩</span> <span class=free>vs</span><span class=main>)</span>
  "</span></span>
<span class=keyword1><span class=command>unfolding</span></span> action_dom_def action_proj_def
<span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> fmdom'_restrict_set_precise<span class=main>)</span>


<span class=keyword1 id=SystemAbstraction-graph_plan_neq_mems_state_set_neq_len><span class=command>lemma</span></span> graph_plan_neq_mems_state_set_neq_len<span class=main>:</span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"prob_dom <span class=main>(</span>prob_proj <span class=free>PROB</span> <span class=free>vs</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span>prob_dom <span class=free>PROB</span> <span class=main>∩</span> <span class=free>vs</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"
      prob_dom <span class=main>(</span>prob_proj <span class=free>PROB</span> <span class=free>vs</span><span class=main>)</span>
      <span class=main>=</span> <span class=main>(</span>
        <span class=main>⋃</span><span class=main>(</span><span class=bound>s1</span><span class=main>,</span> <span class=bound>s2</span><span class=main>)</span><span class=main>∈</span><span class=main>(</span><span class=main>λ</span><span class=bound>a</span><span class=main>.</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=main>(</span>fst <span class=bound>a</span><span class=main>)</span><span class=main>,</span> fmrestrict_set <span class=free>vs</span> <span class=main>(</span>snd <span class=bound>a</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>
        <span class=main>`</span>  <span class=free>PROB</span><span class=main>.</span> action_dom <span class=bound>s1</span> <span class=bound>s2</span>
      <span class=main>)</span>
    "</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> prob_dom_def prob_proj_def action_proj_def
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"
    <span class=main>(</span>prob_dom <span class=free>PROB</span> <span class=main>∩</span> <span class=free>vs</span><span class=main>)</span>
    <span class=main>=</span> <span class=main>(</span><span class=main>⋃</span><span class=bound>a</span><span class=main>∈</span><span class=free>PROB</span><span class=main>.</span> action_dom <span class=main>(</span>fst <span class=bound>a</span><span class=main>)</span> <span class=main>(</span>snd <span class=bound>a</span><span class=main>)</span>  <span class=main>∩</span> <span class=free>vs</span><span class=main>)</span>
  "</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> prob_dom_def prob_proj_def
      <span class=keyword1><span class=command>using</span></span> SUP_cong
      <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>also</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>…</span> <span class=main>=</span> <span class=main>(</span><span class=main>⋃</span><span class=bound>a</span><span class=main>∈</span><span class=free>PROB</span><span class=main>.</span> action_dom <span class=main>(</span>fst <span class=main>(</span>action_proj <span class=bound>a</span> <span class=free>vs</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>snd <span class=main>(</span>action_proj <span class=bound>a</span> <span class=free>vs</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> proj_action_dom_eq_inter<span class=main>[</span><span class=operator>symmetric</span><span class=main>]</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
    <span class=keyword1><span class=command>finally</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"
      <span class=main>(</span>prob_dom <span class=free>PROB</span> <span class=main>∩</span> <span class=free>vs</span><span class=main>)</span>
      <span class=main>=</span> <span class=main>(</span><span class=main>⋃</span><span class=bound>a</span><span class=main>∈</span><span class=free>PROB</span><span class=main>.</span> fmdom' <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=main>(</span>fst <span class=bound>a</span><span class=main>)</span><span class=main>)</span> <span class=main>∪</span> fmdom' <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=main>(</span>snd <span class=bound>a</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>
    "</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> action_dom_def action_proj_def
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> <span class=main><span class=main>(</span></span>mono_tags<span class=main><span class=main>,</span></span> lifting<span class=main><span class=main>)</span></span> SUP_cong UN_simps<span class=main><span class=main>(</span></span>10<span class=main><span class=main>)</span></span> action_dom_def case_prod_beta' prod.sel<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span>
        snd_conv<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=comment1>― ‹TODO more detailed proof.›</span>
<span class=keyword1 id=SystemAbstraction-graph_plan_not_eq_last_diff_paths><span class=command>lemma</span></span> graph_plan_not_eq_last_diff_paths<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=free>vs</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>s</span> <span class=main>∈</span> valid_states <span class=free>PROB</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span> <span class=main>∈</span> valid_states <span class=main>(</span>prob_proj <span class=free>PROB</span> <span class=free>vs</span><span class=main>)</span><span class=main>)</span>"</span></span>

  <span class=keyword1><span class=command>unfolding</span></span> valid_states_def
  <span class=keyword1><span class=command>using</span></span> graph_plan_neq_mems_state_set_neq_len
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> <span class=main><span class=main>(</span></span>mono_tags<span class=main><span class=main>,</span></span> lifting<span class=main><span class=main>)</span></span>
      assms fmdom'.rep_eq fmlookup_fmrestrict_set_dom inf_commute mem_Collect_eq valid_states_def<span class=main>)</span>


<span class=keyword1 id=SystemAbstraction-dom_eff_subset_imp_dom_succ_eq_proj><span class=command>lemma</span></span> dom_eff_subset_imp_dom_succ_eq_proj<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>h</span> <span class=free>s</span> <span class=free>vs</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>fmdom' <span class=main>(</span>snd <span class=free>h</span><span class=main>)</span> <span class=main>⊆</span> fmdom' <span class=free>s</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>fmdom' <span class=main>(</span>state_succ <span class=free>s</span> <span class=main>(</span>action_proj <span class=free>h</span> <span class=free>vs</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> fmdom' <span class=main>(</span>state_succ <span class=free>s</span> <span class=free>h</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"fst <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=main>(</span>fst <span class=free>h</span><span class=main>)</span><span class=main>,</span> fmrestrict_set <span class=free>vs</span> <span class=main>(</span>snd <span class=free>h</span><span class=main>)</span><span class=main>)</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s</span>"</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> true<span class=main>:</span> True
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"fst <span class=free>h</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s</span>"</span></span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> True
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>unfolding</span></span> state_succ_def action_proj_def
      <span class=keyword1><span class=command>using</span></span> true True
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span> <span class=main>(</span><span class=operator>smt</span> assms fmap_add_ltr_def fmdom'.rep_eq fmdom'_add fmlookup_fmrestrict_set_dom
          inf.absorb_iff2 inf.left_commute sup.absorb_iff1<span class=main>)</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> False
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>unfolding</span></span> state_succ_def action_proj_def
      <span class=keyword1><span class=command>using</span></span> true False
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span> <span class=main>(</span><span class=operator>metis</span> <span class=main><span class=main>(</span></span>no_types<span class=main><span class=main>)</span></span> assms dual_order.trans fmap_add_ltr_def fmdom'.rep_eq fmdom'_add
          fmlookup_fmrestrict_set_dom inf_le2 sup.absorb_iff1<span class=main>)</span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> False
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=free>s</span> <span class=main>=</span> fmdom' <span class=main>(</span><span class=keyword1>if</span> fst <span class=free>h</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s</span> <span class=keyword1>then</span> snd <span class=free>h</span> <span class=main>++</span> <span class=free>s</span> <span class=keyword1>else</span> <span class=free>s</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> sat_precond_as_proj_4
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>unfolding</span></span> state_succ_def action_proj_def
    <span class=keyword1><span class=command>using</span></span> False
    <span class=keyword1><span class=command>by</span></span> <span class=operator>presburger</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1 id=SystemAbstraction-drest_proj_succ_eq_drest_succ><span class=command>lemma</span></span> drest_proj_succ_eq_drest_succ<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>h</span> <span class=free>s</span> <span class=free>vs</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"fst <span class=free>h</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>fmdom' <span class=main>(</span>snd <span class=free>h</span><span class=main>)</span> <span class=main>⊆</span> fmdom' <span class=free>s</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=main>(</span>state_succ <span class=free>s</span> <span class=main>(</span>action_proj <span class=free>h</span> <span class=free>vs</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> fmrestrict_set <span class=free>vs</span> <span class=main>(</span>state_succ <span class=free>s</span> <span class=free>h</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"fmrestrict_set <span class=free>vs</span> <span class=main>(</span>fst <span class=free>h</span><span class=main>)</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>)</span> submap_imp_state_succ_submap_a
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> sat_precond_as_proj_4<span class=main>)</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"
      fmrestrict_set <span class=free>vs</span> <span class=main>(</span>state_succ <span class=free>s</span> <span class=main>(</span>action_proj <span class=free>h</span> <span class=free>vs</span><span class=main>)</span><span class=main>)</span>
      <span class=main>=</span> fmrestrict_set <span class=free>vs</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=main>(</span>snd <span class=free>h</span><span class=main>)</span> <span class=main>++</span> <span class=free>s</span><span class=main>)</span>
    "</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> state_succ_def action_proj_def
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>also</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>…</span> <span class=main>=</span> fmrestrict_set <span class=free>vs</span> <span class=free>s</span> <span class=keyword1>++<span class=hidden>⇩</span><sub>f</sub></span> fmrestrict_set <span class=free>vs</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=main>(</span>snd <span class=free>h</span><span class=main>)</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> fmap_add_ltr_def
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
        <span class=comment1>― ‹TODO
      refactor the step 'fmrestrict\_set ?X (fmrestrict\_set ?X ?f) = fmrestrict\_set ?X ?f' into
      own lemma in 'FmapUtils.thy'.›</span>
    <span class=keyword1><span class=command>also</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>…</span> <span class=main>=</span> fmrestrict_set <span class=free>vs</span> <span class=free>s</span> <span class=keyword1>++<span class=hidden>⇩</span><sub>f</sub></span> fmrestrict_set <span class=free>vs</span> <span class=main>(</span>snd <span class=free>h</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> fmfilter_alt_defs<span class=main>(</span>4<span class=main>)</span> fmfilter_cong fmlookup_filter fmrestrict_set_dom option.simps<span class=main>(</span>3<span class=main>)</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
    <span class=keyword1><span class=command>finally</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"
      fmrestrict_set <span class=free>vs</span> <span class=main>(</span>state_succ <span class=free>s</span> <span class=main>(</span>action_proj <span class=free>h</span> <span class=free>vs</span><span class=main>)</span><span class=main>)</span>
      <span class=main>=</span> fmrestrict_set <span class=free>vs</span> <span class=main>(</span>snd <span class=free>h</span> <span class=main>++</span> <span class=free>s</span><span class=main>)</span>
    "</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> fmap_add_ltr_def
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmrestrict_set <span class=free>vs</span> <span class=main>(</span>state_succ <span class=free>s</span> <span class=free>h</span><span class=main>)</span> <span class=main>=</span> fmrestrict_set <span class=free>vs</span> <span class=main>(</span><span class=main>(</span>snd <span class=free>h</span><span class=main>)</span> <span class=main>++</span> <span class=free>s</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> state_succ_def
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>)</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=comment1>― ‹TODO remove? This is equivalent to 'proj\_state\_succ'.›</span>
<span class=keyword1 id=SystemAbstraction-drest_succ_proj_eq_drest_succ><span class=command>lemma</span></span> drest_succ_proj_eq_drest_succ<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>s</span> <span class=free>vs</span> <span class=free>as</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>fst <span class=free>a</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>state_succ <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span> <span class=main>(</span>action_proj <span class=free>a</span> <span class=free>vs</span><span class=main>)</span> <span class=main>=</span> fmrestrict_set <span class=free>vs</span> <span class=main>(</span>state_succ <span class=free>s</span> <span class=free>a</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms proj_state_succ
  <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>


<span class=keyword1 id=SystemAbstraction-exec_drest_cons_proj_eq_succ><span class=command>lemma</span></span> exec_drest_cons_proj_eq_succ<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>as</span> <span class=free>PROB</span> <span class=free>vs</span> <span class=free>a</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"fst <span class=free>a</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>
    exec_plan <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span> <span class=main>(</span>action_proj <span class=free>a</span> <span class=free>vs</span> <span class=main>#</span> <span class=free>as</span><span class=main>)</span>
    <span class=main>=</span> exec_plan <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=main>(</span>state_succ <span class=free>s</span> <span class=free>a</span><span class=main>)</span><span class=main>)</span> <span class=free>as</span>
  <span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"exec_plan <span class=main>(</span>state_succ <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span> <span class=main>(</span>action_proj <span class=free>a</span> <span class=free>vs</span><span class=main>)</span><span class=main>)</span> <span class=free>as</span> <span class=main>=</span>
  exec_plan <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=main>(</span>state_succ <span class=free>s</span> <span class=free>a</span><span class=main>)</span><span class=main>)</span> <span class=free>as</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms drest_succ_proj_eq_drest_succ
    <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>unfolding</span></span> prob_proj_def
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1 id=SystemAbstraction-exec_drest><span class=command>lemma</span></span> exec_drest<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>as</span> <span class=free>a</span> <span class=free>vs</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>fst <span class=free>a</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>
    exec_plan <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=main>(</span>state_succ <span class=free>s</span> <span class=free>a</span><span class=main>)</span><span class=main>)</span> <span class=free>as</span>
    <span class=main>=</span> exec_plan <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span> <span class=main>(</span>action_proj <span class=free>a</span> <span class=free>vs</span> <span class=main>#</span> <span class=free>as</span><span class=main>)</span>
  <span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms proj_state_succ
  <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>


<span class=keyword1 id=SystemAbstraction-not_empty_eff_in_as_proj><span class=command>lemma</span></span> not_empty_eff_in_as_proj<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>as</span> <span class=free>a</span> <span class=free>vs</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span><span class=main>)</span> <span class=main>≠</span> <span class=main>{}</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>as_proj <span class=main>(</span><span class=free>a</span> <span class=main>#</span> <span class=free>as</span><span class=main>)</span> <span class=free>vs</span> <span class=main>=</span> <span class=main>(</span>action_proj <span class=free>a</span> <span class=free>vs</span> <span class=main>#</span> as_proj <span class=free>as</span> <span class=free>vs</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> action_proj_def as_proj.simps
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>by</span></span> <span class=operator>argo</span>

<span class=keyword1 id=SystemAbstraction-empty_eff_not_in_as_proj><span class=command>lemma</span></span> empty_eff_not_in_as_proj<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>as</span> <span class=free>a</span> <span class=free>vs</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>fmdom' <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>{}</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>as_proj <span class=main>(</span><span class=free>a</span> <span class=main>#</span> <span class=free>as</span><span class=main>)</span> <span class=free>vs</span> <span class=main>=</span> as_proj <span class=free>as</span> <span class=free>vs</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> action_proj_def
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>


<span class=keyword1 id=SystemAbstraction-empty_eff_drest_no_eff><span class=command>lemma</span></span> empty_eff_drest_no_eff<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>s</span> <span class=keyword2><span class=keyword>and</span></span> <span class=free>a</span> <span class=keyword2><span class=keyword>and</span></span> <span class=free>vs</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>fmdom' <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>{}</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=main>(</span>state_succ <span class=free>s</span> <span class=main>(</span>action_proj <span class=free>a</span> <span class=free>vs</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>snd <span class=main>(</span>action_proj <span class=free>a</span> <span class=free>vs</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>{}</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> action_proj_def
    <span class=keyword1><span class=command>using</span></span> assms
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"state_succ <span class=free>s</span> <span class=main>(</span>action_proj <span class=free>a</span> <span class=free>vs</span><span class=main>)</span> <span class=main>=</span> <span class=free>s</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> empty_eff_exec_eq
    <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1 id=SystemAbstraction-sat_precond_exec_as_proj_eq_proj_exec><span class=command>lemma</span></span> sat_precond_exec_as_proj_eq_proj_exec<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>as</span> <span class=free>vs</span> <span class=free>s</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>sat_precond_as <span class=free>s</span> <span class=free>as</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>exec_plan <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span> <span class=main>(</span>as_proj <span class=free>as</span> <span class=free>vs</span><span class=main>)</span> <span class=main>=</span> fmrestrict_set <span class=free>vs</span> <span class=main>(</span>exec_plan <span class=free>s</span> <span class=free>as</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>as</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>a</span> <span class=skolem>as</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>using</span></span> Cons.prems graph_plan_lemma_1
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span> <span class=operator>auto</span>


<span class=keyword1 id=SystemAbstraction-action_proj_in_prob_proj><span class=command>lemma</span></span> action_proj_in_prob_proj<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>a</span> <span class=main>∈</span> <span class=free>PROB</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>action_proj <span class=free>a</span> <span class=free>vs</span> <span class=main>∈</span> prob_proj <span class=free>PROB</span> <span class=free>vs</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> action_proj_def prob_proj_def
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>


<span class=keyword1 id=SystemAbstraction-valid_as_valid_as_proj><span class=command>lemma</span></span> valid_as_valid_as_proj<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=free>vs</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>as_proj <span class=free>as</span> <span class=free>vs</span> <span class=main>∈</span> valid_plans <span class=main>(</span>prob_proj <span class=free>PROB</span> <span class=free>vs</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=quoted>"<span class=free>as</span>"</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>PROB</span></span> <span class=quoted><span class=free>vs</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>a</span> <span class=skolem>as</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>using</span></span> assms Cons
  <span class=keyword1><span class=command>proof</span></span><span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>fmrestrict_set <span class=skolem>vs</span> <span class=main>(</span>snd <span class=skolem>a</span><span class=main>)</span><span class=main>)</span> <span class=main>≠</span> <span class=main>{}</span>"</span></span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> True
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"as_proj <span class=main>(</span><span class=skolem>a</span> <span class=main>#</span> <span class=skolem>as</span><span class=main>)</span> <span class=skolem>vs</span> <span class=main>=</span> action_proj <span class=skolem>a</span> <span class=skolem>vs</span> <span class=main>#</span> as_proj <span class=skolem>as</span> <span class=skolem>vs</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> True
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>as</span> <span class=main>∈</span> valid_plans <span class=skolem>PROB</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> Cons.prems valid_plan_valid_tail
      <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
    <span class=keyword1><span class=command>then</span></span>  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"as_proj <span class=skolem>as</span> <span class=skolem>vs</span> <span class=main>∈</span> valid_plans <span class=main>(</span>prob_proj <span class=skolem>PROB</span> <span class=skolem>vs</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> Cons.IH 1
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"action_proj <span class=skolem>a</span> <span class=skolem>vs</span> <span class=main>#</span> as_proj <span class=skolem>as</span> <span class=skolem>vs</span> <span class=main>∈</span> valid_plans <span class=main>(</span>prob_proj <span class=skolem>PROB</span> <span class=skolem>vs</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> Cons.prems action_proj_in_prob_proj valid_head_and_tail_valid_plan valid_plan_valid_head
      <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>using</span></span> 1
      <span class=keyword1><span class=command>by</span></span> <span class=operator>argo</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> False
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"as_proj <span class=main>(</span><span class=skolem>a</span> <span class=main>#</span> <span class=skolem>as</span><span class=main>)</span> <span class=skolem>vs</span> <span class=main>=</span> as_proj <span class=skolem>as</span> <span class=skolem>vs</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> False
      <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"as_proj <span class=main>(</span><span class=skolem>a</span> <span class=main>#</span> <span class=skolem>as</span><span class=main>)</span> <span class=skolem>vs</span> <span class=main>∈</span> valid_plans <span class=main>(</span>prob_proj <span class=skolem>PROB</span> <span class=skolem>vs</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> assms Cons valid_plan_valid_tail
      <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>using</span></span> assms Cons.IH<span class=main>(</span>1<span class=main>)</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>qed</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> valid_plans_def<span class=main>)</span>


<span class=keyword1 id=SystemAbstraction-finite_imp_finite_prob_proj><span class=command>lemma</span></span> finite_imp_finite_prob_proj<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"finite <span class=free>PROB</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>finite <span class=main>(</span>prob_proj <span class=free>PROB</span> <span class=free>vs</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> prob_proj_def
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>


<span class=comment1>― ‹NOTE Base 2 in 5th assumption had to be explicitely fixed to 'nat' type to be able to use the
linearity lemma for powers of natural numbers.›</span>
<span class=keyword1><span class=command>lemma</span></span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=free>vs</span> <span class=free>as</span> <span class=keyword2><span class=keyword>and</span></span> <span class=free>s</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> state"</span></span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"finite <span class=free>PROB</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>s</span> <span class=main>∈</span> valid_states <span class=free>PROB</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>as</span> <span class=main>∈</span> <span class=main>(</span>valid_plans <span class=free>PROB</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"finite <span class=free>vs</span>"</span></span>
    <span class=quoted><span class=quoted>"length <span class=main>(</span>as_proj <span class=free>as</span> <span class=free>vs</span><span class=main>)</span> <span class=main>&gt;</span> <span class=main>(</span><span class=main>(</span><span class=numeral>2</span> <span class=main>::</span> nat<span class=main>)</span> <span class=main>^</span> card <span class=free>vs</span><span class=main>)</span> <span class=main>-</span> <span class=main>1</span>"</span></span> <span class=quoted><span class=quoted>"sat_precond_as <span class=free>s</span> <span class=free>as</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>as1</span> <span class=bound>as2</span> <span class=bound>as3</span><span class=main>.</span>
    <span class=main>(</span><span class=bound>as1</span> <span class=main>@</span> <span class=bound>as2</span> <span class=main>@</span> <span class=bound>as3</span> <span class=main>=</span> as_proj <span class=free>as</span> <span class=free>vs</span><span class=main>)</span>
    <span class=main>∧</span> <span class=main>(</span>exec_plan <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span> <span class=main>(</span><span class=bound>as1</span> <span class=main>@</span> <span class=bound>as2</span><span class=main>)</span> <span class=main>=</span> exec_plan <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span> <span class=bound>as1</span><span class=main>)</span>
    <span class=main>∧</span> <span class=main>(</span><span class=bound>as2</span> <span class=main>≠</span> <span class=main>[]</span><span class=main>)</span>
  <span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"card <span class=main>(</span>fmdom' <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span> <span class=main>≤</span> card <span class=free>vs</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>4<span class=main>)</span> graph_plan_card_state_set
      <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=numeral>2</span> <span class=main>::</span> nat<span class=main>)</span> <span class=main>^</span> <span class=main>(</span>card <span class=main>(</span>fmdom' <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>-</span> <span class=main>1</span> <span class=main>≤</span> <span class=numeral>2</span> <span class=main>^</span> <span class=main>(</span>card <span class=free>vs</span><span class=main>)</span> <span class=main>-</span> <span class=main>1</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> power_increasing diff_le_mono
      <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
    <span class=keyword1><span class=command>also</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>...</span> <span class=main>&lt;</span> length <span class=main>(</span>as_proj <span class=free>as</span> <span class=free>vs</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>5<span class=main>)</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>finally</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=numeral>2</span> <span class=main>^</span> card <span class=main>(</span>fmdom' <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span> <span class=main>-</span> <span class=main>1</span> <span class=main>&lt;</span> length <span class=main>(</span>as_proj <span class=free>as</span> <span class=free>vs</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>note</span></span> 1 <span class=main>=</span> this
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmrestrict_set <span class=free>vs</span> <span class=free>s</span> <span class=main>∈</span> valid_states <span class=main>(</span>prob_proj <span class=free>PROB</span> <span class=free>vs</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>2<span class=main>)</span> graph_plan_not_eq_last_diff_paths
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"as_proj <span class=free>as</span> <span class=free>vs</span> <span class=main>∈</span> valid_plans <span class=main>(</span>prob_proj <span class=free>PROB</span> <span class=free>vs</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>3<span class=main>)</span> valid_as_valid_as_proj
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"finite <span class=main>(</span>prob_proj <span class=free>PROB</span> <span class=free>vs</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>)</span> finite_imp_finite_prob_proj
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>using</span></span> lemma_2<span class=main>[</span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> PROB<span class=main><span class=main>=</span></span><span class=quoted><span class=quoted>"prob_proj <span class=free>PROB</span> <span class=free>vs</span>"</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>and</span></span></span> as<span class=main><span class=main>=</span></span><span class=quoted><span class=quoted>"as_proj <span class=free>as</span> <span class=free>vs</span>"</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>and</span></span></span> s<span class=main><span class=main>=</span></span><span class=quoted><span class=quoted>"fmrestrict_set <span class=free>vs</span> <span class=free>s</span>"</span></span><span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1 id=SystemAbstraction-as_proj_eq_filter_action_proj><span class=command>lemma</span></span> as_proj_eq_filter_action_proj<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>as</span> <span class=free>vs</span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"as_proj <span class=free>as</span> <span class=free>vs</span> <span class=main>=</span> filter <span class=main>(</span><span class=main>λ</span><span class=bound>a</span><span class=main>.</span> fmdom' <span class=main>(</span>snd <span class=bound>a</span><span class=main>)</span> <span class=main>≠</span> <span class=main>{}</span><span class=main>)</span> <span class=main>(</span>map <span class=main>(</span><span class=main>λ</span><span class=bound>a</span><span class=main>.</span> action_proj <span class=bound>a</span> <span class=free>vs</span><span class=main>)</span> <span class=free>as</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>as</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> action_proj_def<span class=main>)</span>


<span class=keyword1 id=SystemAbstraction-append_eq_as_proj><span class=command>lemma</span></span> append_eq_as_proj<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>as1</span> <span class=free>as2</span> <span class=free>as3</span> <span class=free>p</span> <span class=free>vs</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>as1</span> <span class=main>@</span> <span class=free>as2</span> <span class=main>@</span> <span class=free>as3</span> <span class=main>=</span> as_proj <span class=free>p</span> <span class=free>vs</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>p_1</span> <span class=bound>p_2</span> <span class=bound>p_3</span><span class=main>.</span>
    <span class=main>(</span><span class=bound>p_1</span> <span class=main>@</span> <span class=bound>p_2</span> <span class=main>@</span> <span class=bound>p_3</span> <span class=main>=</span> <span class=free>p</span><span class=main>)</span>
    <span class=main>∧</span> <span class=main>(</span><span class=free>as2</span> <span class=main>=</span> as_proj <span class=bound>p_2</span> <span class=free>vs</span><span class=main>)</span>
    <span class=main>∧</span> <span class=main>(</span><span class=free>as1</span> <span class=main>=</span> as_proj <span class=bound>p_1</span> <span class=free>vs</span><span class=main>)</span>
  <span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms append_eq_as_proj_1 as_proj_eq_filter_action_proj
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> <span class=main><span class=main>(</span></span>no_types<span class=main><span class=main>,</span></span> lifting<span class=main><span class=main>)</span></span><span class=main>)</span>


<span class=keyword1 id=SystemAbstraction-succ_drest_eq_drest_succ><span class=command>lemma</span></span> succ_drest_eq_drest_succ<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>a</span> <span class=free>s</span> <span class=free>vs</span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"
    state_succ <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span> <span class=main>(</span>action_proj <span class=free>a</span> <span class=free>vs</span><span class=main>)</span>
    <span class=main>=</span> fmrestrict_set <span class=free>vs</span> <span class=main>(</span>state_succ <span class=free>s</span> <span class=main>(</span>action_proj <span class=free>a</span> <span class=free>vs</span><span class=main>)</span><span class=main>)</span>
  "</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?lhs</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"state_succ <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span> <span class=main>(</span>action_proj <span class=free>a</span> <span class=free>vs</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?rhs</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"fmrestrict_set <span class=free>vs</span> <span class=main>(</span>state_succ <span class=free>s</span> <span class=main>(</span>action_proj <span class=free>a</span> <span class=free>vs</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=comment1>― ‹NOTE Show lhs and rhs equality by splitting on the cases introduced by the if-then branching
    of 'state\_succ'.›</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>assume</span></span> P1<span class=main>:</span> <span class=quoted><span class=quoted>"fst <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=main>(</span>fst <span class=free>a</span><span class=main>)</span><span class=main>,</span> fmrestrict_set <span class=free>vs</span> <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span><span class=main>)</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> fmrestrict_set <span class=free>vs</span> <span class=free>s</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> a<span class=main>:</span> <span class=quoted><span class=quoted>"fst <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=main>(</span>fst <span class=free>a</span><span class=main>)</span><span class=main>,</span> fmrestrict_set <span class=free>vs</span> <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span><span class=main>)</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> drest_smap_drest_smap_drest
      <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?lhs</span> <span class=main>=</span> fmrestrict_set <span class=free>vs</span> <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span> <span class=main>++</span> fmrestrict_set <span class=free>vs</span> <span class=free>s</span>"</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> state_succ_def action_proj_def
      <span class=keyword1><span class=command>using</span></span> P1
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>{</span></span>
      <span class=keyword1><span class=command>have</span></span> rhs<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=var>?rhs</span> <span class=main>=</span> fmrestrict_set <span class=free>vs</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span> <span class=main>++</span> <span class=free>s</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>unfolding</span></span> state_succ_def action_proj_def
        <span class=keyword1><span class=command>using</span></span> a
        <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword1><span class=command>also</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>…</span> <span class=main>=</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span><span class=main>)</span> <span class=main>++</span> fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>unfolding</span></span> fmap_add_ltr_def
        <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
      <span class=keyword1><span class=command>finally</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?rhs</span> <span class=main>=</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span> <span class=main>++</span> fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>unfolding</span></span> fmfilter_alt_defs<span class=main>(</span>4<span class=main>)</span>
        <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
    <span class=keyword1><span class=command>}</span></span>
    <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?lhs</span> <span class=main>=</span> <span class=var>?rhs</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>argo</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>assume</span></span> P2<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>¬</span><span class=main>(</span>fst <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=main>(</span>fst <span class=free>a</span><span class=main>)</span><span class=main>,</span> fmrestrict_set <span class=free>vs</span> <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span><span class=main>)</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> a<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>¬</span><span class=main>(</span>fst <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=main>(</span>fst <span class=free>a</span><span class=main>)</span><span class=main>,</span> fmrestrict_set <span class=free>vs</span> <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span><span class=main>)</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> drest_smap_drest_smap_drest
      <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?lhs</span> <span class=main>=</span> fmrestrict_set <span class=free>vs</span> <span class=free>s</span>"</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> state_succ_def action_proj_def
      <span class=keyword1><span class=command>using</span></span> P2
      <span class=keyword1><span class=command>by</span></span> <span class=operator>argo</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?rhs</span> <span class=main>=</span> fmrestrict_set <span class=free>vs</span> <span class=free>s</span>"</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> state_succ_def action_proj_def
      <span class=keyword1><span class=command>using</span></span> a
      <span class=keyword1><span class=command>by</span></span> <span class=operator>presburger</span>
    <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?lhs</span> <span class=main>=</span> <span class=var>?rhs</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=var>?lhs</span> <span class=main>=</span> <span class=var>?rhs</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1 id=SystemAbstraction-proj_exec_proj_eq_exec_proj><span class=command>lemma</span></span> proj_exec_proj_eq_exec_proj<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>s</span> <span class=free>as</span> <span class=free>vs</span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"
    fmrestrict_set <span class=free>vs</span> <span class=main>(</span>exec_plan <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span> <span class=main>(</span>as_proj <span class=free>as</span> <span class=free>vs</span><span class=main>)</span><span class=main>)</span>
    <span class=main>=</span> exec_plan <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span> <span class=main>(</span>as_proj <span class=free>as</span> <span class=free>vs</span><span class=main>)</span>
  "</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>as</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>s</span></span> <span class=quoted><span class=free>vs</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>a</span> <span class=skolem>as</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> succ_drest_eq_drest_succ<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> fmfilter_alt_defs<span class=main><span class=main>(</span></span>4<span class=main><span class=main>)</span></span><span class=main>)</span>


<span class=keyword1 id="SystemAbstraction-proj_exec_proj_eq_exec_proj'"><span class=command>lemma</span></span> proj_exec_proj_eq_exec_proj'<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>s</span> <span class=free>as</span> <span class=free>vs</span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"
    fmrestrict_set <span class=free>vs</span> <span class=main>(</span>exec_plan <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span> <span class=main>(</span>as_proj <span class=free>as</span> <span class=free>vs</span><span class=main>)</span><span class=main>)</span>
     <span class=main>=</span> fmrestrict_set <span class=free>vs</span> <span class=main>(</span>exec_plan <span class=free>s</span> <span class=main>(</span>as_proj <span class=free>as</span> <span class=free>vs</span><span class=main>)</span><span class=main>)</span>
  "</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>as</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>s</span></span> <span class=quoted><span class=free>vs</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>a</span> <span class=skolem>as</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> succ_drest_eq_drest_succ<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> fmfilter_alt_defs<span class=main><span class=main>(</span></span>4<span class=main><span class=main>)</span></span><span class=main>)</span>


<span class=keyword1 id=SystemAbstraction-graph_plan_lemma_9><span class=command>lemma</span></span> graph_plan_lemma_9<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>s</span> <span class=free>as</span> <span class=free>vs</span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"
    fmrestrict_set <span class=free>vs</span> <span class=main>(</span>exec_plan <span class=free>s</span> <span class=main>(</span>as_proj <span class=free>as</span> <span class=free>vs</span><span class=main>)</span><span class=main>)</span>
    <span class=main>=</span> exec_plan <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span> <span class=main>(</span>as_proj <span class=free>as</span> <span class=free>vs</span><span class=main>)</span>
  "</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> proj_exec_proj_eq_exec_proj' proj_exec_proj_eq_exec_proj<span class=main>)</span>


<span class=keyword1 id=SystemAbstraction-act_dom_proj_eff_subset_act_dom_eff><span class=command>lemma</span></span> act_dom_proj_eff_subset_act_dom_eff<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>a</span> <span class=free>vs</span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>snd <span class=main>(</span>action_proj <span class=free>a</span> <span class=free>vs</span><span class=main>)</span><span class=main>)</span> <span class=main>⊆</span> fmdom' <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"snd <span class=main>(</span>action_proj <span class=free>a</span> <span class=free>vs</span><span class=main>)</span> <span class=main>=</span> fmrestrict_set <span class=free>vs</span> <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> action_proj_def
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span><span class=main>)</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>m</sub></span> fmlookup <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> map_le_def fmdom'_restrict_set_precise<span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"dom <span class=main>(</span>fmlookup <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>⊆</span> dom <span class=main>(</span>fmlookup <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> map_le_implies_dom_le
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span><span class=main>)</span> <span class=main>⊆</span> fmdom' <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> fmdom'.rep_eq
    <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>unfolding</span></span> action_proj_def
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1 id=SystemAbstraction-exec_as_proj_valid><span class=command>lemma</span></span> exec_as_proj_valid<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>as</span> <span class=free>s</span> <span class=free>PROB</span> <span class=free>vs</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>s</span> <span class=main>∈</span> valid_states <span class=free>PROB</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>  <span class=quoted><span class=quoted>"<span class=main>(</span>exec_plan <span class=free>s</span> <span class=main>(</span>as_proj <span class=free>as</span> <span class=free>vs</span><span class=main>)</span> <span class=main>∈</span> valid_states <span class=free>PROB</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>as</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>s</span></span> <span class=quoted><span class=free>PROB</span></span> <span class=quoted><span class=free>vs</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>a</span> <span class=skolem>as</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>as</span> <span class=main>∈</span> valid_plans <span class=skolem>PROB</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>2<span class=main>)</span> valid_plan_valid_tail
    <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> 2<span class=main>:</span> <span class=quoted><span class=quoted>"exec_plan <span class=skolem>s</span> <span class=main>(</span>as_proj <span class=skolem>as</span> <span class=skolem>vs</span><span class=main>)</span> <span class=main>∈</span> valid_states <span class=skolem>PROB</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>1<span class=main>)</span> Cons.IH<span class=main>(</span>1<span class=main>)</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=comment1>― ‹NOTE split on the if-then branch introduced by 'as\_proj'.›</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>assume</span></span> P<span class=main>:</span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>fmrestrict_set <span class=skolem>vs</span> <span class=main>(</span>snd <span class=skolem>a</span><span class=main>)</span><span class=main>)</span> <span class=main>≠</span> <span class=main>{}</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"
      exec_plan <span class=skolem>s</span> <span class=main>(</span>as_proj <span class=main>(</span><span class=skolem>a</span> <span class=main>#</span> <span class=skolem>as</span><span class=main>)</span> <span class=skolem>vs</span><span class=main>)</span>
      <span class=main>=</span> exec_plan <span class=main>(</span>state_succ <span class=skolem>s</span> <span class=main>(</span>action_proj <span class=skolem>a</span> <span class=skolem>vs</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>as_proj <span class=skolem>as</span> <span class=skolem>vs</span><span class=main>)</span>
    "</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
        <span class=comment1>― ‹NOTE split on the if-then branch introduced by 'state\_succ'›</span>
    <span class=keyword1><span class=command>moreover</span></span>
    <span class=keyword1><span class=command>{</span></span>
      <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"fst <span class=main>(</span>action_proj <span class=skolem>a</span> <span class=skolem>vs</span><span class=main>)</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=skolem>s</span>"</span></span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> 3<span class=main>:</span> <span class=quoted><span class=quoted>"
        exec_plan <span class=main>(</span>state_succ <span class=skolem>s</span> <span class=main>(</span>action_proj <span class=skolem>a</span> <span class=skolem>vs</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>as_proj <span class=skolem>as</span> <span class=skolem>vs</span><span class=main>)</span>
        <span class=main>=</span> exec_plan <span class=main>(</span>snd <span class=main>(</span>action_proj <span class=skolem>a</span> <span class=skolem>vs</span><span class=main>)</span> <span class=main>++</span> <span class=skolem>s</span><span class=main>)</span> <span class=main>(</span>as_proj <span class=skolem>as</span> <span class=skolem>vs</span><span class=main>)</span>
      "</span></span>
        <span class=keyword1><span class=command>unfolding</span></span> state_succ_def
        <span class=keyword1><span class=command>using</span></span> calculation
        <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
      <span class=keyword1><span class=command>{</span></span>
        <span class=comment1>― ‹TODO Unsure why this proof step is necessary at all, but it should be refactored into a
          dedicated lemma <span class=antiquoted><span class=antiquote>@{</span><span class=operator>term</span> <span class=quoted>"<span class=skolem>s</span> <span class=main>∈</span> valid_states <span class=skolem>PROB</span> <span class=main>⟹</span> fmdom' <span class=skolem>s</span> <span class=main>=</span> prob_dom <span class=skolem>PROB</span>"</span><span class=antiquote>}</span></span>.›</span>
        <span class=keyword1><span class=command>{</span></span>
          <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>s</span> <span class=main>∈</span> valid_states <span class=skolem>PROB</span>"</span></span>
            <span class=keyword1><span class=command>using</span></span> Cons.prems
            <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
          <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>s</span> <span class=main>∈</span> <span class=main>{</span><span class=bound>s'</span><span class=main>.</span> fmdom' <span class=bound>s'</span> <span class=main>=</span> prob_dom <span class=skolem>PROB</span><span class=main>}</span>"</span></span>
            <span class=keyword1><span class=command>unfolding</span></span> valid_states_def
            <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
          <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>s'</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>s'</span> <span class=main>=</span> <span class=skolem>s</span>"</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=skolem>s'</span> <span class=main>=</span> prob_dom <span class=skolem>PROB</span>"</span></span>
            <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
          <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=skolem>s</span> <span class=main>=</span> prob_dom <span class=skolem>PROB</span>"</span></span>
            <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
        <span class=keyword1><span class=command>}</span></span>
          <span class=comment1>― ‹TODO Refactor this step ('also ...' for subset chain; replace fact
        `fmdom' s = prob\_dom PROB` in last step with MP step from lemma refactored above.›</span>
        <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>{</span></span>
          <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>snd <span class=main>(</span>action_proj <span class=skolem>a</span> <span class=skolem>vs</span><span class=main>)</span> <span class=main>++</span> <span class=skolem>s</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=skolem>s</span> <span class=keyword1>++<span class=hidden>⇩</span><sub>f</sub></span> fmrestrict_set <span class=skolem>vs</span> <span class=main>(</span>snd <span class=skolem>a</span><span class=main>)</span><span class=main>)</span>"</span></span>
            <span class=keyword1><span class=command>unfolding</span></span> action_proj_def fmap_add_ltr_def
            <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
          <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> a<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>a</span> <span class=main>∈</span> <span class=skolem>PROB</span>"</span></span>
            <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>2<span class=main>)</span> valid_plan_valid_head
            <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
          <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"action_dom <span class=main>(</span>fst <span class=skolem>a</span><span class=main>)</span> <span class=main>(</span>snd <span class=skolem>a</span><span class=main>)</span> <span class=main>⊆</span> prob_dom <span class=skolem>PROB</span>"</span></span>
            <span class=keyword1><span class=command>using</span></span> exec_as_proj_valid_2
            <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
          <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>snd <span class=skolem>a</span><span class=main>)</span> <span class=main>⊆</span> action_dom <span class=main>(</span>fst <span class=skolem>a</span><span class=main>)</span> <span class=main>(</span>snd <span class=skolem>a</span><span class=main>)</span>"</span></span>
            <span class=keyword1><span class=command>unfolding</span></span> action_dom_def
            <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
          <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>fmrestrict_set <span class=skolem>vs</span> <span class=main>(</span>snd <span class=skolem>a</span><span class=main>)</span><span class=main>)</span> <span class=main>⊆</span> fmdom' <span class=main>(</span>snd <span class=skolem>a</span><span class=main>)</span>"</span></span>
            <span class=keyword1><span class=command>using</span></span> action_proj_def act_dom_proj_eff_subset_act_dom_eff snd_conv
            <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
          <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>fmrestrict_set <span class=skolem>vs</span> <span class=main>(</span>snd <span class=skolem>a</span><span class=main>)</span><span class=main>)</span> <span class=main>⊆</span> prob_dom <span class=skolem>PROB</span>"</span></span>
            <span class=keyword1><span class=command>using</span></span> FDOM_eff_subset_prob_dom_pair a
            <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
          <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span><span class=skolem>s</span> <span class=keyword1>++<span class=hidden>⇩</span><sub>f</sub></span> fmrestrict_set <span class=skolem>vs</span> <span class=main>(</span>snd <span class=skolem>a</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> fmdom' <span class=skolem>s</span>"</span></span>
            <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> calculation sup.absorb_iff1<span class=main>)</span>
        <span class=keyword1><span class=command>}</span></span>
        <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>snd <span class=main>(</span>action_proj <span class=skolem>a</span> <span class=skolem>vs</span><span class=main>)</span> <span class=main>++</span> <span class=skolem>s</span><span class=main>)</span> <span class=main>∈</span> valid_states <span class=skolem>PROB</span>"</span></span>
          <span class=keyword1><span class=command>unfolding</span></span> action_proj_def fmap_add_ltr_def valid_states_def
          <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
      <span class=keyword1><span class=command>}</span></span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"exec_plan <span class=skolem>s</span> <span class=main>(</span>as_proj <span class=main>(</span><span class=skolem>a</span> <span class=main>#</span> <span class=skolem>as</span><span class=main>)</span> <span class=skolem>vs</span><span class=main>)</span> <span class=main>∈</span> valid_states <span class=skolem>PROB</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> 1 3 calculation<span class=main>(</span>1<span class=main>)</span> Cons.IH<span class=main>[</span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> s <span class=main><span class=main>=</span></span> <span class=quoted><span class=quoted>"snd <span class=main>(</span>action_proj <span class=skolem>a</span> <span class=skolem>vs</span><span class=main>)</span> <span class=main>++</span> <span class=skolem>s</span>"</span></span><span class=main>]</span>
        <span class=keyword1><span class=command>by</span></span> <span class=operator>presburger</span>
    <span class=keyword1><span class=command>}</span></span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>{</span></span>
      <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span><span class=main>(</span>fst <span class=main>(</span>action_proj <span class=skolem>a</span> <span class=skolem>vs</span><span class=main>)</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=skolem>s</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"
        exec_plan <span class=main>(</span>state_succ <span class=skolem>s</span> <span class=main>(</span>action_proj <span class=skolem>a</span> <span class=skolem>vs</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>as_proj <span class=skolem>as</span> <span class=skolem>vs</span><span class=main>)</span>
        <span class=main>=</span> exec_plan <span class=skolem>s</span> <span class=main>(</span>as_proj <span class=skolem>as</span> <span class=skolem>vs</span><span class=main>)</span>
      "</span></span>
        <span class=keyword1><span class=command>unfolding</span></span> state_succ_def
        <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"exec_plan <span class=skolem>s</span> <span class=main>(</span>as_proj <span class=main>(</span><span class=skolem>a</span> <span class=main>#</span> <span class=skolem>as</span><span class=main>)</span> <span class=skolem>vs</span><span class=main>)</span> <span class=main>∈</span> valid_states <span class=skolem>PROB</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> 2
        <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
    <span class=keyword1><span class=command>}</span></span>
    <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"exec_plan <span class=skolem>s</span> <span class=main>(</span>as_proj <span class=main>(</span><span class=skolem>a</span> <span class=main>#</span> <span class=skolem>as</span><span class=main>)</span> <span class=skolem>vs</span><span class=main>)</span> <span class=main>∈</span> valid_states <span class=skolem>PROB</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>fmrestrict_set <span class=skolem>vs</span> <span class=main>(</span>snd <span class=skolem>a</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>{}</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"
      exec_plan <span class=skolem>s</span> <span class=main>(</span>as_proj <span class=main>(</span><span class=skolem>a</span> <span class=main>#</span> <span class=skolem>as</span><span class=main>)</span> <span class=skolem>vs</span><span class=main>)</span> <span class=main>=</span>
      exec_plan <span class=skolem>s</span> <span class=main>(</span>as_proj <span class=skolem>as</span> <span class=skolem>vs</span><span class=main>)</span>
    "</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"exec_plan <span class=skolem>s</span> <span class=main>(</span>as_proj <span class=main>(</span><span class=skolem>a</span> <span class=main>#</span> <span class=skolem>as</span><span class=main>)</span> <span class=skolem>vs</span><span class=main>)</span> <span class=main>∈</span> valid_states <span class=skolem>PROB</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> 2
      <span class=keyword1><span class=command>by</span></span> <span class=operator>argo</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span> <span class=operator>simp</span>


<span class=keyword1 id=SystemAbstraction-drest_exec_as_proj_eq_drest_exec><span class=command>lemma</span></span> drest_exec_as_proj_eq_drest_exec<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>s</span> <span class=free>as</span> <span class=free>vs</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"sat_precond_as <span class=free>s</span> <span class=free>as</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=main>(</span>exec_plan <span class=free>s</span> <span class=main>(</span>as_proj <span class=free>as</span> <span class=free>vs</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> fmrestrict_set <span class=free>vs</span> <span class=main>(</span>exec_plan <span class=free>s</span> <span class=free>as</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"
    <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=main>(</span>exec_plan <span class=free>s</span> <span class=main>(</span>as_proj <span class=free>as</span> <span class=free>vs</span><span class=main>)</span><span class=main>)</span>
    <span class=main>=</span> exec_plan <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span> <span class=main>(</span>as_proj <span class=free>as</span> <span class=free>vs</span><span class=main>)</span><span class=main>)</span>
  "</span></span>
    <span class=keyword1><span class=command>using</span></span> graph_plan_lemma_9 <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>s'</span></span> <span class=keyword2><span class=keyword>where</span></span> 2<span class=main>:</span> <span class=quoted><span class=quoted>"exec_plan <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span> <span class=main>(</span>as_proj <span class=free>as</span> <span class=free>vs</span><span class=main>)</span> <span class=main>=</span> fmrestrict_set <span class=free>vs</span> <span class=skolem>s'</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> 1
    <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmrestrict_set <span class=free>vs</span> <span class=skolem>s'</span> <span class=main>=</span> fmrestrict_set <span class=free>vs</span> <span class=main>(</span>exec_plan <span class=free>s</span> <span class=free>as</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms sat_precond_exec_as_proj_eq_proj_exec
    <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span>
    <span class=quoted><span class=quoted>"fmrestrict_set <span class=free>vs</span> <span class=main>(</span>exec_plan <span class=free>s</span> <span class=main>(</span>as_proj <span class=free>as</span> <span class=free>vs</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> fmrestrict_set <span class=free>vs</span> <span class=main>(</span>exec_plan <span class=free>s</span> <span class=free>as</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> 1 2
    <span class=keyword1><span class=command>by</span></span> <span class=operator>argo</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1 id=SystemAbstraction-action_proj_idempot><span class=command>lemma</span></span> action_proj_idempot<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>a</span> <span class=free>vs</span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"action_proj <span class=main>(</span>action_proj <span class=free>a</span> <span class=free>vs</span><span class=main>)</span> <span class=free>vs</span> <span class=main>=</span> <span class=main>(</span>action_proj <span class=free>a</span> <span class=free>vs</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> action_proj_def
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> fmfilter_alt_defs<span class=main><span class=main>(</span></span>4<span class=main><span class=main>)</span></span><span class=main>)</span>


<span class=keyword1 id="SystemAbstraction-action_proj_idempot'"><span class=command>lemma</span></span>  action_proj_idempot'<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>a</span> <span class=free>vs</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>action_dom <span class=main>(</span>fst <span class=free>a</span><span class=main>)</span> <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span> <span class=main>⊆</span> <span class=free>vs</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>action_proj <span class=free>a</span> <span class=free>vs</span> <span class=main>=</span> <span class=free>a</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"action_proj <span class=free>a</span> <span class=free>vs</span> <span class=main>=</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=main>(</span>fst <span class=free>a</span><span class=main>)</span><span class=main>,</span> fmrestrict_set <span class=free>vs</span> <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> action_proj_def<span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> 2<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span>fmdom' <span class=main>(</span>fst <span class=free>a</span><span class=main>)</span> <span class=main>∪</span> fmdom' <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span><span class=main>)</span> <span class=main>⊆</span> <span class=free>vs</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> action_dom_def
    <span class=keyword1><span class=command>using</span></span> assms
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> action_dom_def<span class=main>)</span>
      <span class=comment1>― ‹NOTE Show that both components of 'a' remain unchanged.›</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>fst <span class=free>a</span><span class=main>)</span> <span class=main>⊆</span> <span class=free>vs</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmrestrict_set <span class=free>vs</span> <span class=main>(</span>fst <span class=free>a</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span>fst <span class=free>a</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> exec_drest_5
      <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>{</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span> <span class=main>⊆</span> <span class=free>vs</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> 2
      <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmrestrict_set <span class=free>vs</span> <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> exec_drest_5
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>using</span></span> 1
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1 id="SystemAbstraction-action_proj_idempot''"><span class=command>lemma</span></span> action_proj_idempot''<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>P</span> <span class=free>vs</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"prob_dom <span class=free>P</span> <span class=main>⊆</span> <span class=free>vs</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"prob_proj <span class=free>P</span> <span class=free>vs</span> <span class=main>=</span> <span class=free>P</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=comment1>― ‹TODO refactor.›</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>a</span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a</span> <span class=main>∈</span> <span class=free>P</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"action_dom <span class=main>(</span>fst <span class=skolem>a</span><span class=main>)</span> <span class=main>(</span>snd <span class=skolem>a</span><span class=main>)</span> <span class=main>⊆</span> <span class=free>vs</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> assms exec_as_proj_valid_2
      <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"action_proj <span class=skolem>a</span> <span class=free>vs</span> <span class=main>=</span> <span class=skolem>a</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> action_proj_idempot'
      <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"prob_proj <span class=free>P</span> <span class=free>vs</span> <span class=main>=</span> <span class=free>P</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> prob_proj_def
    <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>unfolding</span></span> prob_proj_def
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1 id=SystemAbstraction-sat_precond_as_proj><span class=command>lemma</span></span> sat_precond_as_proj<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>as</span> <span class=free>s</span> <span class=free>s'</span> <span class=free>vs</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>sat_precond_as <span class=free>s</span> <span class=free>as</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span> <span class=main>=</span> fmrestrict_set <span class=free>vs</span> <span class=free>s'</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>sat_precond_as <span class=free>s'</span> <span class=main>(</span>as_proj <span class=free>as</span> <span class=free>vs</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>as</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>s</span></span> <span class=quoted><span class=free>s'</span></span> <span class=quoted><span class=free>vs</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>a</span> <span class=skolem>as</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span>
    <span class=quoted><span class=quoted>"fst <span class=skolem>a</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=skolem>s</span>"</span></span> <span class=quoted><span class=quoted>"sat_precond_as <span class=main>(</span>state_succ <span class=skolem>s</span> <span class=skolem>a</span><span class=main>)</span> <span class=skolem>as</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>1<span class=main>)</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span><span class=main><span class=keyword3>+</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> 2<span class=main>:</span> <span class=quoted><span class=quoted>"fmrestrict_set <span class=skolem>vs</span> <span class=main>(</span>fst <span class=skolem>a</span><span class=main>)</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=skolem>s</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>)</span> sat_precond_as_proj_4
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>fmrestrict_set <span class=skolem>vs</span> <span class=main>(</span>snd <span class=skolem>a</span><span class=main>)</span><span class=main>)</span> <span class=main>≠</span> <span class=main>{}</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"
      sat_precond_as <span class=skolem>s'</span> <span class=main>(</span>as_proj <span class=main>(</span><span class=skolem>a</span> <span class=main>#</span> <span class=skolem>as</span><span class=main>)</span> <span class=skolem>vs</span><span class=main>)</span>
      <span class=main>=</span> <span class=main>(</span>
        fst <span class=main>(</span>action_proj <span class=skolem>a</span> <span class=skolem>vs</span><span class=main>)</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=skolem>s'</span>
        <span class=main>∧</span> sat_precond_as <span class=main>(</span>state_succ <span class=skolem>s'</span> <span class=main>(</span>action_proj <span class=skolem>a</span> <span class=skolem>vs</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>as_proj <span class=skolem>as</span> <span class=skolem>vs</span><span class=main>)</span>
      <span class=main>)</span>
    "</span></span>
      <span class=keyword1><span class=command>using</span></span> calculation
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>moreover</span></span>
    <span class=keyword1><span class=command>{</span></span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fst <span class=main>(</span>action_proj <span class=skolem>a</span> <span class=skolem>vs</span><span class=main>)</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=skolem>s'</span> <span class=main>=</span> <span class=main>(</span>fmrestrict_set <span class=skolem>vs</span> <span class=main>(</span>fst <span class=skolem>a</span><span class=main>)</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=skolem>s'</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>unfolding</span></span> action_proj_def
        <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
      <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>fmrestrict_set <span class=skolem>vs</span> <span class=main>(</span>fst <span class=skolem>a</span><span class=main>)</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=skolem>s</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span>fmrestrict_set <span class=skolem>vs</span> <span class=main>(</span>fst <span class=skolem>a</span><span class=main>)</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=skolem>s'</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>2<span class=main>)</span> sat_precond_as_proj_1
        <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fst <span class=main>(</span>action_proj <span class=skolem>a</span> <span class=skolem>vs</span><span class=main>)</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=skolem>s'</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> 2
        <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>}</span></span>
      <span class=comment1>― ‹TODO detailled proof for this sledgehammered step.›</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"sat_precond_as <span class=main>(</span>state_succ <span class=skolem>s'</span> <span class=main>(</span>action_proj <span class=skolem>a</span> <span class=skolem>vs</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>as_proj <span class=skolem>as</span> <span class=skolem>vs</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> 1 Cons.IH Cons.prems<span class=main>(</span>2<span class=main>)</span> drest_succ_proj_eq_drest_succ succ_drest_eq_drest_succ
      <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
    <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>sat_precond_as <span class=skolem>s'</span> <span class=main>(</span>as_proj <span class=main>(</span><span class=skolem>a</span> <span class=main>#</span> <span class=skolem>as</span><span class=main>)</span> <span class=skolem>vs</span><span class=main>)</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>assume</span></span> P1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>¬</span><span class=main>(</span>fmdom' <span class=main>(</span>fmrestrict_set <span class=skolem>vs</span> <span class=main>(</span>snd <span class=skolem>a</span><span class=main>)</span><span class=main>)</span> <span class=main>≠</span> <span class=main>{}</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"sat_precond_as <span class=skolem>s'</span> <span class=main>(</span>as_proj <span class=main>(</span><span class=skolem>a</span> <span class=main>#</span> <span class=skolem>as</span><span class=main>)</span> <span class=skolem>vs</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"as_proj <span class=main>(</span><span class=skolem>a</span> <span class=main>#</span> <span class=skolem>as</span><span class=main>)</span> <span class=skolem>vs</span>"</span></span><span class=main>)</span>
      <span class=keyword3><span class=command>case</span></span> Cons2<span class=main>:</span> <span class=main>(</span>Cons <span class=skolem>a'</span> <span class=skolem>list</span><span class=main>)</span>
        <span class=comment1>― ‹TODO unfold the sledgehammered metis steps.›</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> a<span class=main>:</span> <span class=quoted><span class=quoted>"
          sat_precond_as <span class=skolem>s'</span> <span class=main>(</span>as_proj <span class=main>(</span><span class=skolem>a</span> <span class=main>#</span> <span class=skolem>as</span><span class=main>)</span> <span class=skolem>vs</span><span class=main>)</span>
          <span class=main>=</span> <span class=main>(</span>fst <span class=skolem>a'</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=skolem>s'</span><span class=main>)</span> <span class=main>∧</span> sat_precond_as <span class=main>(</span>state_succ <span class=skolem>s'</span> <span class=skolem>a'</span><span class=main>)</span> <span class=skolem>list</span>
        "</span></span>
        <span class=keyword1><span class=command>using</span></span> P1 Cons.IH Cons.prems<span class=main>(</span>1<span class=main>,</span> 2<span class=main>)</span> Cons2
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> sat_precond_as_proj_3 empty_eff_not_in_as_proj sat_precond_as.simps<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span><span class=main>)</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> b<span class=main>:</span> <span class=quoted><span class=quoted>"fst <span class=skolem>a'</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=skolem>s'</span>"</span></span>
        <span class=keyword1><span class=command>unfolding</span></span> sat_precond_as.simps<span class=main>(</span>2<span class=main>)</span>
        <span class=keyword1><span class=command>using</span></span> P1 Cons.IH Cons.prems<span class=main>(</span>1<span class=main>,</span> 2<span class=main>)</span> sat_precond_as_proj_3 empty_eff_not_in_as_proj
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> sat_precond_as.simps<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span><span class=main>)</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"sat_precond_as <span class=main>(</span>state_succ <span class=skolem>s'</span> <span class=skolem>a'</span><span class=main>)</span> <span class=skolem>list</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> a
        <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
        <span class=keyword1><span class=command>using</span></span> a b
        <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>qed</span></span> <span class=operator>fastforce</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span> <span class=operator>simp</span>


<span class=keyword1 id=SystemAbstraction-sat_precond_drest_as_proj><span class=command>lemma</span></span> sat_precond_drest_as_proj<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>as</span> <span class=free>s</span> <span class=free>s'</span> <span class=free>vs</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>sat_precond_as <span class=free>s</span> <span class=free>as</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span> <span class=main>=</span> fmrestrict_set <span class=free>vs</span> <span class=free>s'</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>sat_precond_as <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s'</span><span class=main>)</span> <span class=main>(</span>as_proj <span class=free>as</span> <span class=free>vs</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>as</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>s</span></span> <span class=quoted><span class=free>s'</span></span> <span class=quoted><span class=free>vs</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>a</span> <span class=skolem>as</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"fst <span class=skolem>a</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=skolem>s</span>"</span></span> <span class=quoted><span class=quoted>"sat_precond_as <span class=main>(</span>state_succ <span class=skolem>s</span> <span class=skolem>a</span><span class=main>)</span> <span class=skolem>as</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Cons.prems
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span><span class=main><span class=keyword3>+</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmrestrict_set <span class=skolem>vs</span> <span class=main>(</span>fst <span class=skolem>a</span><span class=main>)</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> fmrestrict_set <span class=skolem>vs</span> <span class=skolem>s</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> fmsubset_restrict_set_mono
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fst <span class=main>(</span>action_proj <span class=skolem>a</span> <span class=skolem>vs</span><span class=main>)</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> fmrestrict_set <span class=skolem>vs</span> <span class=skolem>s'</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> action_proj_def
    <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>2<span class=main>)</span> sat_precond_as_proj_1
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmrestrict_set <span class=skolem>vs</span> <span class=main>(</span>snd <span class=skolem>a</span><span class=main>)</span> <span class=main>=</span> fmrestrict_set <span class=skolem>vs</span> <span class=main>(</span>snd <span class=main>(</span>action_proj <span class=skolem>a</span> <span class=skolem>vs</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> action_proj_def
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> fmfilter_alt_defs<span class=main><span class=main>(</span></span>4<span class=main><span class=main>)</span></span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fst <span class=main>(</span>action_proj <span class=skolem>a</span> <span class=skolem>vs</span><span class=main>)</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=skolem>s</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> action_proj_def
    <span class=keyword1><span class=command>using</span></span> 1<span class=main>(</span>1<span class=main>)</span> fst_conv sat_precond_as_proj_4
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=comment1>― ‹TODO unfold these sledgehammered steps.›</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"
    fmrestrict_set <span class=skolem>vs</span> <span class=main>(</span>state_succ <span class=skolem>s</span> <span class=skolem>a</span><span class=main>)</span>
    <span class=main>=</span> fmrestrict_set <span class=skolem>vs</span> <span class=main>(</span>state_succ <span class=main>(</span>fmrestrict_set <span class=skolem>vs</span> <span class=skolem>s'</span><span class=main>)</span> <span class=main>(</span>action_proj <span class=skolem>a</span> <span class=skolem>vs</span><span class=main>)</span><span class=main>)</span>
  "</span></span>
    <span class=keyword1><span class=command>using</span></span> 1<span class=main>(</span>1<span class=main>)</span> Cons.prems<span class=main>(</span>2<span class=main>)</span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> fmfilter_alt_defs<span class=main><span class=main>(</span></span>4<span class=main><span class=main>)</span></span> fmfilter_true fmlookup_restrict_set
        drest_succ_proj_eq_drest_succ option.simps<span class=main><span class=main>(</span></span>3<span class=main><span class=main>)</span></span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>1<span class=main>,</span> 2<span class=main>)</span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> fmfilter_alt_defs<span class=main><span class=main>(</span></span>4<span class=main><span class=main>)</span></span> fmfilter_true fmlookup_restrict_set sat_precond_as_proj
        option.simps<span class=main><span class=main>(</span></span>3<span class=main><span class=main>)</span></span><span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span> <span class=operator>simp</span>


<span class=keyword1 id=SystemAbstraction-as_proj_eq_as><span class=command>lemma</span></span> as_proj_eq_as<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>no_effectless_act <span class=free>as</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>prob_dom <span class=free>PROB</span> <span class=main>⊆</span> <span class=free>vs</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>as_proj <span class=free>as</span> <span class=free>vs</span> <span class=main>=</span> <span class=free>as</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>as</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>PROB</span></span> <span class=quoted><span class=free>vs</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>a</span> <span class=skolem>as</span><span class=main>)</span>
    <span class=comment1>― ‹NOTE We only need to look at the first branch of 'as\_proj'.›</span>
    <span class=comment1>― ‹TODO step should be refactored and proven explicitely because it's so pivotal.›</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>fmrestrict_set <span class=skolem>vs</span> <span class=main>(</span>snd <span class=skolem>a</span><span class=main>)</span><span class=main>)</span> <span class=main>≠</span> <span class=main>{}</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> fmdom'_restrict_set_precise
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span>
        FDOM_eff_subset_prob_dom_pair dual_order.trans inf.orderE
        no_effectless_act.simps<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span> valid_plan_valid_head<span class=main>)</span>
      <span class=comment1>― ‹NOTE Proof 'action\_proj a vs = a' for the first branch of 'as\_proj'.›</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>fmrestrict_set <span class=skolem>vs</span> <span class=main>(</span>snd <span class=skolem>a</span><span class=main>)</span><span class=main>)</span> <span class=main>≠</span> <span class=main>{}</span>"</span></span>
      <span class=comment1>― ‹NOTE show 'action\_proj a vs = a'.›</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>{</span></span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"as_proj <span class=main>(</span><span class=skolem>a</span> <span class=main>#</span> <span class=skolem>as</span><span class=main>)</span> <span class=skolem>vs</span> <span class=main>=</span> action_proj <span class=skolem>a</span> <span class=skolem>vs</span> <span class=main>#</span> as_proj <span class=skolem>as</span> <span class=skolem>vs</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> calculation
        <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a</span> <span class=main>∈</span> <span class=skolem>PROB</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>2<span class=main>)</span> valid_plan_valid_head
        <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"action_dom <span class=main>(</span>fst <span class=skolem>a</span><span class=main>)</span> <span class=main>(</span>snd <span class=skolem>a</span><span class=main>)</span> <span class=main>⊆</span> prob_dom <span class=skolem>PROB</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> exec_as_proj_valid_2
        <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"action_dom <span class=main>(</span>fst <span class=skolem>a</span><span class=main>)</span> <span class=main>(</span>snd <span class=skolem>a</span><span class=main>)</span> <span class=main>⊆</span> <span class=skolem>vs</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>3<span class=main>)</span>
        <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"action_proj <span class=skolem>a</span> <span class=skolem>vs</span> <span class=main>=</span> <span class=skolem>a</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> action_proj_idempot'
        <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
    <span class=keyword1><span class=command>}</span></span>
      <span class=comment1>― ‹NOTE show that 'as\_proj as vs = as'.›</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>{</span></span>
      <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"no_effectless_act <span class=skolem>as</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>1<span class=main>)</span>
        <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>as</span> <span class=main>∈</span> valid_plans <span class=skolem>PROB</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>2<span class=main>)</span> valid_plan_valid_tail
        <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"as_proj <span class=skolem>as</span> <span class=skolem>vs</span> <span class=main>=</span> <span class=skolem>as</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>3<span class=main>)</span> Cons.IH 1
        <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>}</span></span>
    <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"as_proj <span class=main>(</span><span class=skolem>a</span> <span class=main>#</span> <span class=skolem>as</span><span class=main>)</span> <span class=skolem>vs</span> <span class=main>=</span> <span class=skolem>a</span> <span class=main>#</span> <span class=skolem>as</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
<span class=keyword1><span class=command>qed</span></span> <span class=operator>simp</span>


<span class=keyword1 id=SystemAbstraction-exec_rem_effless_as_proj_eq_exec_as_proj><span class=command>lemma</span></span> exec_rem_effless_as_proj_eq_exec_as_proj<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>s</span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"exec_plan <span class=free>s</span> <span class=main>(</span>as_proj <span class=main>(</span>rem_effectless_act <span class=free>as</span><span class=main>)</span> <span class=free>vs</span><span class=main>)</span> <span class=main>=</span> exec_plan <span class=free>s</span> <span class=main>(</span>as_proj <span class=free>as</span> <span class=free>vs</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>as</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>s</span></span> <span class=quoted><span class=free>vs</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>a</span> <span class=skolem>as</span><span class=main>)</span>
    <span class=comment1>― ‹Split cases on the branching introduced by `remove\_effectless\_act` and `as\_proj`.›</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>snd <span class=skolem>a</span><span class=main>)</span> <span class=main>≠</span> <span class=main>{}</span>"</span></span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> true1<span class=main>:</span> True
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>fmrestrict_set <span class=skolem>vs</span> <span class=main>(</span>snd <span class=skolem>a</span><span class=main>)</span><span class=main>)</span> <span class=main>≠</span> <span class=main>{}</span>"</span></span><span class=main>)</span>
      <span class=keyword3><span class=command>case</span></span> False
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> Cons true1<span class=main>)</span>
    <span class=keyword1><span class=command>qed</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> Cons true1<span class=main>)</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> False
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>fmrestrict_set <span class=skolem>vs</span> <span class=main>(</span>snd <span class=skolem>a</span><span class=main>)</span><span class=main>)</span> <span class=main>≠</span> <span class=main>{}</span>"</span></span><span class=main>)</span>
      <span class=keyword3><span class=command>case</span></span> true2<span class=main>:</span> True
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>snd <span class=skolem>a</span><span class=main>)</span> <span class=main>∩</span> <span class=skolem>vs</span> <span class=main>=</span> <span class=main>{}</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> False Int_empty_left
        <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
          <span class=comment1>― ‹NOTE This step shows that the case for <span class=antiquoted><span class=antiquote>@{</span><span class=operator>term</span> <span class=quoted>"fmdom' <span class=main>(</span>fmrestrict_set <span class=skolem>vs</span> <span class=main>(</span>snd <span class=skolem>a</span><span class=main>)</span><span class=main>)</span> <span class=main>≠</span> <span class=main>{}</span>"</span><span class=antiquote>}</span></span> is
            impossible.›</span>
          <span class=comment1>― ‹TODO could be refactored into a (simp) lemma (`as\_proj\_eq\_as` also uses this?).›</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>fmrestrict_set <span class=skolem>vs</span> <span class=main>(</span>snd <span class=skolem>a</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>{}</span>"</span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> fmdom'_restrict_set_precise<span class=main>)</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
        <span class=keyword1><span class=command>using</span></span> true2
        <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>qed</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> Cons<span class=main>)</span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>qed</span></span> <span class=operator>simp</span>


<span class=keyword1 id=SystemAbstraction-exec_as_proj_eq_exec_as><span class=command>lemma</span></span> exec_as_proj_eq_exec_as<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=free>as</span> <span class=free>vs</span> <span class=free>s</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>prob_dom <span class=free>PROB</span> <span class=main>⊆</span> <span class=free>vs</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>exec_plan <span class=free>s</span> <span class=main>(</span>as_proj <span class=free>as</span> <span class=free>vs</span><span class=main>)</span> <span class=main>=</span> exec_plan <span class=free>s</span> <span class=free>as</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms as_proj_eq_as exec_rem_effless_as_proj_eq_exec_as_proj rem_effectless_works_1 rem_effectless_works_6
    rem_effectless_works_9 sublist_valid_plan
  <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>


<span class=keyword1 id=SystemAbstraction-dom_prob_proj><span class=command>lemma</span></span> dom_prob_proj<span class=main>:</span> <span class=quoted><span class=quoted>"prob_dom <span class=main>(</span>prob_proj <span class=free>PROB</span> <span class=free>vs</span><span class=main>)</span> <span class=main>⊆</span> <span class=free>vs</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> graph_plan_neq_mems_state_set_neq_len
  <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>


<span class=comment1>― ‹NOTE added lemma.›</span>
<span class=comment1>― ‹TODO refactor into `FmapUtils.thy`.›</span>
<span class=keyword1 id=SystemAbstraction-subset_proj_absorb_1_a><span class=command>lemma</span></span> subset_proj_absorb_1_a<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>f</span> <span class=free>vs1</span> <span class=free>vs2</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>vs1</span> <span class=main>⊆</span> <span class=free>vs2</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"fmrestrict_set <span class=free>vs1</span> <span class=main>(</span>fmrestrict_set <span class=free>vs2</span> <span class=free>f</span><span class=main>)</span> <span class=main>=</span> fmrestrict_set <span class=free>vs1</span> <span class=free>f</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>v</span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=main>(</span>fmrestrict_set <span class=free>vs1</span> <span class=main>(</span>fmrestrict_set <span class=free>vs2</span> <span class=free>f</span><span class=main>)</span><span class=main>)</span> <span class=skolem>v</span> <span class=main>=</span> fmlookup <span class=main>(</span>fmrestrict_set <span class=free>vs1</span> <span class=free>f</span><span class=main>)</span> <span class=skolem>v</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> assms
    <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span> <span class=free>vs1</span>"</span></span><span class=main>)</span>
      <span class=keyword3><span class=command>case</span></span> False
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span> <span class=free>vs2</span>"</span></span><span class=main>)</span>
        <span class=keyword3><span class=command>case</span></span> False
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∉</span> <span class=free>vs1</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> False assms
          <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span>
          <span class=quoted><span class=quoted>"fmlookup <span class=main>(</span>fmrestrict_set <span class=free>vs1</span> <span class=main>(</span>fmrestrict_set <span class=free>vs2</span> <span class=free>f</span><span class=main>)</span><span class=main>)</span> <span class=skolem>v</span> <span class=main>=</span> None"</span></span>
          <span class=quoted><span class=quoted>"fmlookup <span class=main>(</span>fmrestrict_set <span class=free>vs1</span> <span class=free>f</span><span class=main>)</span> <span class=skolem>v</span> <span class=main>=</span> None"</span></span>
          <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span><span class=main><span class=keyword3>+</span></span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
          <span class=keyword1><span class=command>by</span></span> <span class=operator>argo</span>
      <span class=keyword1><span class=command>qed</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>qed</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>using</span></span> fmap_ext
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=SystemAbstraction-subset_proj_absorb_1><span class=command>lemma</span></span> subset_proj_absorb_1<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>vs1</span> <span class=main>⊆</span> <span class=free>vs2</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>action_proj <span class=main>(</span>action_proj <span class=free>a</span> <span class=free>vs2</span><span class=main>)</span> <span class=free>vs1</span> <span class=main>=</span> action_proj <span class=free>a</span> <span class=free>vs1</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span>
    <span class=quoted><span class=quoted>"fmrestrict_set <span class=free>vs1</span> <span class=main>(</span>fmrestrict_set <span class=free>vs2</span> <span class=main>(</span>fst <span class=free>a</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> fmrestrict_set <span class=free>vs1</span> <span class=main>(</span>fst <span class=free>a</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"fmrestrict_set <span class=free>vs1</span> <span class=main>(</span>fmrestrict_set <span class=free>vs2</span> <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> fmrestrict_set <span class=free>vs1</span> <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms subset_proj_absorb_1_a
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span><span class=main><span class=keyword3>+</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>unfolding</span></span> action_proj_def
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1 id=SystemAbstraction-subset_proj_absorb><span class=command>lemma</span></span> subset_proj_absorb<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=free>vs1</span> <span class=free>vs2</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>vs1</span> <span class=main>⊆</span> <span class=free>vs2</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"prob_proj <span class=main>(</span>prob_proj <span class=free>PROB</span> <span class=free>vs2</span><span class=main>)</span> <span class=free>vs1</span> <span class=main>=</span> prob_proj <span class=free>PROB</span> <span class=free>vs1</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"
      prob_proj <span class=main>(</span>prob_proj <span class=free>PROB</span> <span class=free>vs2</span><span class=main>)</span> <span class=free>vs1</span>
      <span class=main>=</span> <span class=main>(</span><span class=main>(</span><span class=main>λ</span><span class=bound>a</span><span class=main>.</span> action_proj <span class=bound>a</span> <span class=free>vs1</span><span class=main>)</span> <span class=main>∘</span> <span class=main>(</span><span class=main>λ</span><span class=bound>a</span><span class=main>.</span> action_proj <span class=bound>a</span> <span class=free>vs2</span><span class=main>)</span><span class=main>)</span> <span class=main>`</span> <span class=free>PROB</span>
    "</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> prob_proj_def
      <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
    <span class=keyword1><span class=command>also</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>…</span> <span class=main>=</span> <span class=main>(</span><span class=main>λ</span><span class=bound>a</span><span class=main>.</span> action_proj <span class=main>(</span>action_proj <span class=bound>a</span> <span class=free>vs2</span><span class=main>)</span> <span class=free>vs1</span><span class=main>)</span> <span class=main>`</span> <span class=free>PROB</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
    <span class=keyword1><span class=command>also</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>…</span> <span class=main>=</span> <span class=main>(</span><span class=main>λ</span><span class=bound>a</span><span class=main>.</span> action_proj <span class=bound>a</span> <span class=free>vs1</span><span class=main>)</span> <span class=main>`</span> <span class=free>PROB</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> assms subset_proj_absorb_1
      <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
    <span class=keyword1><span class=command>also</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>…</span> <span class=main>=</span> prob_proj <span class=free>PROB</span> <span class=free>vs1</span>"</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> prob_proj_def
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>finally</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"prob_proj <span class=main>(</span>prob_proj <span class=free>PROB</span> <span class=free>vs2</span><span class=main>)</span> <span class=free>vs1</span> <span class=main>=</span> prob_proj <span class=free>PROB</span> <span class=free>vs1</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1 id=SystemAbstraction-union_proj_absorb><span class=command>lemma</span></span> union_proj_absorb<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=free>vs</span> <span class=free>vs'</span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"prob_proj <span class=main>(</span>prob_proj <span class=free>PROB</span> <span class=main>(</span><span class=free>vs</span> <span class=main>∪</span> <span class=free>vs'</span><span class=main>)</span><span class=main>)</span> <span class=free>vs</span> <span class=main>=</span> prob_proj <span class=free>PROB</span> <span class=free>vs</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> subset_proj_absorb<span class=main>)</span>


<span class=keyword1 id=SystemAbstraction-NOT_VS_IN_DOM_PROJ_PRE_EFF><span class=command>lemma</span></span> NOT_VS_IN_DOM_PROJ_PRE_EFF<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>ROB</span> <span class=free>vs</span> <span class=free>v</span> <span class=free>a</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span><span class=main>(</span><span class=free>v</span> <span class=main>∈</span> <span class=free>vs</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>a</span> <span class=main>∈</span> <span class=free>PROB</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>
    <span class=main>(</span><span class=main>(</span><span class=free>v</span> <span class=main>∈</span> fmdom' <span class=main>(</span>fst <span class=free>a</span><span class=main>)</span><span class=main>)</span> <span class=main>⟶</span> <span class=main>(</span><span class=free>v</span> <span class=main>∈</span> fmdom' <span class=main>(</span>fst <span class=main>(</span>action_proj <span class=free>a</span> <span class=main>(</span>prob_dom <span class=free>PROB</span> <span class=main>-</span> <span class=free>vs</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>
    <span class=main>∧</span> <span class=main>(</span><span class=main>(</span><span class=free>v</span> <span class=main>∈</span> fmdom' <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span><span class=main>)</span> <span class=main>⟶</span> <span class=main>(</span><span class=free>v</span> <span class=main>∈</span> fmdom' <span class=main>(</span>snd <span class=main>(</span>action_proj <span class=free>a</span> <span class=main>(</span>prob_dom <span class=free>PROB</span> <span class=main>-</span> <span class=free>vs</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>
  <span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> action_proj_def
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> IN_FDOM_DRESTRICT_DIFF FDOM_pre_subset_prob_dom_pair
      FDOM_eff_subset_prob_dom_pair<span class=main>)</span>


<span class=keyword1 id=SystemAbstraction-IN_DISJ_DEP_IMP_DEP_DIFF><span class=command>lemma</span></span> IN_DISJ_DEP_IMP_DEP_DIFF<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=free>vs</span> <span class=free>vs'</span> <span class=free>v</span> <span class=free>v'</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>v</span> <span class=main>∈</span> <span class=free>vs'</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>v'</span> <span class=main>∈</span> <span class=free>vs'</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>disjnt <span class=free>vs</span> <span class=free>vs'</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>dep <span class=free>PROB</span> <span class=free>v</span> <span class=free>v'</span> <span class=main>⟶</span> dep <span class=main>(</span>prob_proj <span class=free>PROB</span> <span class=main>(</span>prob_dom <span class=free>PROB</span> <span class=main>-</span> <span class=free>vs</span><span class=main>)</span><span class=main>)</span> <span class=free>v</span> <span class=free>v'</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=free>v</span> <span class=main>=</span> <span class=free>v'</span>"</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> False
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>assume</span></span> P<span class=main>:</span> <span class=quoted><span class=quoted>"dep <span class=free>PROB</span> <span class=free>v</span> <span class=free>v'</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>a</span></span> <span class=keyword2><span class=keyword>where</span></span> a<span class=main>:</span>
      <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>v</span> <span class=main>∈</span> fmdom' <span class=main>(</span>fst <span class=skolem>a</span><span class=main>)</span> <span class=main>∧</span> <span class=free>v'</span> <span class=main>∈</span> fmdom' <span class=main>(</span>snd <span class=skolem>a</span><span class=main>)</span> <span class=main>∨</span> <span class=free>v</span> <span class=main>∈</span> fmdom' <span class=main>(</span>snd <span class=skolem>a</span><span class=main>)</span> <span class=main>∧</span> <span class=free>v'</span> <span class=main>∈</span> fmdom' <span class=main>(</span>snd <span class=skolem>a</span><span class=main>)</span><span class=main>)</span>"</span></span>
      <span class=quoted><span class=quoted>"<span class=skolem>a</span> <span class=main>∈</span> <span class=free>PROB</span>"</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> dep_def
      <span class=keyword1><span class=command>using</span></span> False
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>{</span></span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>v</span> <span class=main>∉</span> <span class=free>vs</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>,</span> 3<span class=main>)</span>
        <span class=keyword1><span class=command>unfolding</span></span> disjnt_def
        <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>v</span> <span class=main>∈</span> fmdom' <span class=main>(</span>fst <span class=skolem>a</span><span class=main>)</span> <span class=main>⟶</span> <span class=free>v</span> <span class=main>∈</span> fmdom' <span class=main>(</span>fst <span class=main>(</span>action_proj <span class=skolem>a</span> <span class=main>(</span>prob_dom <span class=free>PROB</span> <span class=main>-</span> <span class=free>vs</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
        <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>v</span> <span class=main>∈</span> fmdom' <span class=main>(</span>snd <span class=skolem>a</span><span class=main>)</span> <span class=main>⟶</span> <span class=free>v</span> <span class=main>∈</span> fmdom' <span class=main>(</span>snd <span class=main>(</span>action_proj <span class=skolem>a</span> <span class=main>(</span>prob_dom <span class=free>PROB</span> <span class=main>-</span> <span class=free>vs</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> a NOT_VS_IN_DOM_PROJ_PRE_EFF
        <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span><span class=main><span class=keyword3>+</span></span>
    <span class=keyword1><span class=command>}</span></span>
    <span class=keyword1><span class=command>note</span></span> b <span class=main>=</span> this
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>consider</span></span> <span class=main>(</span>i<span class=main>)</span> <span class=quoted><span class=quoted>"<span class=free>v</span> <span class=main>∈</span> fmdom' <span class=main>(</span>fst <span class=skolem>a</span><span class=main>)</span> <span class=main>∧</span> <span class=free>v'</span> <span class=main>∈</span> fmdom' <span class=main>(</span>snd <span class=skolem>a</span><span class=main>)</span>"</span></span>
      <span class=main>|</span> <span class=main>(</span>ii<span class=main>)</span> <span class=quoted><span class=quoted>"<span class=free>v</span> <span class=main>∈</span> fmdom' <span class=main>(</span>snd <span class=skolem>a</span><span class=main>)</span> <span class=main>∧</span> <span class=free>v'</span> <span class=main>∈</span> fmdom' <span class=main>(</span>snd <span class=skolem>a</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> a
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"dep <span class=main>(</span>prob_proj <span class=free>PROB</span> <span class=main>(</span>prob_dom <span class=free>PROB</span> <span class=main>-</span> <span class=free>vs</span><span class=main>)</span><span class=main>)</span> <span class=free>v</span> <span class=free>v'</span>"</span></span>
    <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span><span class=main>)</span>
      <span class=keyword3><span class=command>case</span></span> i
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
        <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>2<span class=main>,</span> 3<span class=main>)</span> a<span class=main>(</span>2<span class=main>)</span> b<span class=main>(</span>1<span class=main>)</span>
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>meson</span> dep_def disjnt_iff action_proj_in_prob_proj NOT_VS_IN_DOM_PROJ_PRE_EFF<span class=main>)</span>
    <span class=keyword1><span class=command>next</span></span>
      <span class=keyword3><span class=command>case</span></span> ii
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
        <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>2<span class=main>,</span> 3<span class=main>)</span> a<span class=main>(</span>2<span class=main>)</span> b<span class=main>(</span>2<span class=main>)</span>
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>meson</span> dep_def disjnt_iff action_proj_in_prob_proj NOT_VS_IN_DOM_PROJ_PRE_EFF<span class=main>)</span>
    <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> dep_def prob_proj_def disjnt_def<span class=main>)</span>


<span class=keyword1 id=SystemAbstraction-PROB_DOM_PROJ_DIFF><span class=command>lemma</span></span>  PROB_DOM_PROJ_DIFF<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>P</span> <span class=free>vs</span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"prob_dom <span class=main>(</span>prob_proj <span class=free>PROB</span> <span class=main>(</span>prob_dom <span class=free>PROB</span> <span class=main>-</span> <span class=free>vs</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span>prob_dom <span class=free>PROB</span><span class=main>)</span> <span class=main>-</span> <span class=free>vs</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> graph_plan_neq_mems_state_set_neq_len
  <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>


<span class=keyword1 id=SystemAbstraction-two_children_parent_mems_le_finite><span class=command>lemma</span></span>  two_children_parent_mems_le_finite<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=free>vs</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>vs</span> <span class=main>⊆</span> prob_dom <span class=free>PROB</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>prob_dom <span class=main>(</span>prob_proj <span class=free>PROB</span> <span class=free>vs</span><span class=main>)</span> <span class=main>=</span> <span class=free>vs</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms graph_plan_neq_mems_state_set_neq_len
  <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>


<span class=comment1>― ‹TODO showcase (non-trivial proof).›</span>
<span class=comment1>― ‹TODO find explicit proof.›</span>
<span class=keyword1 id=SystemAbstraction-PROJ_DOM_PRE_EFF_SUBSET_DOM><span class=command>lemma</span></span> PROJ_DOM_PRE_EFF_SUBSET_DOM<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>a</span> <span class=free>vs</span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"
    <span class=main>(</span>fmdom' <span class=main>(</span>fst <span class=main>(</span>action_proj <span class=free>a</span> <span class=free>vs</span><span class=main>)</span><span class=main>)</span> <span class=main>⊆</span> fmdom' <span class=main>(</span>fst <span class=free>a</span><span class=main>)</span><span class=main>)</span>
    <span class=main>∧</span> <span class=main>(</span>fmdom' <span class=main>(</span>snd <span class=main>(</span>action_proj <span class=free>a</span> <span class=free>vs</span><span class=main>)</span><span class=main>)</span> <span class=main>⊆</span> fmdom' <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span><span class=main>)</span>
  "</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> action_proj_def
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> fmdom'_restrict_set_precise<span class=main>)</span>


<span class=keyword1 id=SystemAbstraction-NOT_IN_PRE_EFF_NOT_IN_PRE_EFF_PROJ><span class=command>lemma</span></span> NOT_IN_PRE_EFF_NOT_IN_PRE_EFF_PROJ<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>a</span> <span class=free>v</span> <span class=free>vs</span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"
    <span class=main>(</span><span class=main>¬</span><span class=main>(</span><span class=free>v</span> <span class=main>∈</span> fmdom' <span class=main>(</span>fst <span class=free>a</span><span class=main>)</span><span class=main>)</span> <span class=main>⟶</span> <span class=main>¬</span><span class=main>(</span><span class=free>v</span> <span class=main>∈</span> fmdom' <span class=main>(</span>fst <span class=main>(</span>action_proj <span class=free>a</span> <span class=free>vs</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>
    <span class=main>∧</span> <span class=main>(</span><span class=main>¬</span><span class=main>(</span><span class=free>v</span> <span class=main>∈</span> fmdom' <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span><span class=main>)</span> <span class=main>⟶</span> <span class=main>¬</span><span class=main>(</span><span class=free>v</span> <span class=main>∈</span> fmdom' <span class=main>(</span>snd <span class=main>(</span>action_proj <span class=free>a</span> <span class=free>vs</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>
  "</span></span>
  <span class=keyword1><span class=command>using</span></span> PROJ_DOM_PRE_EFF_SUBSET_DOM rev_subsetD
  <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>


<span class=keyword1 id=SystemAbstraction-dep_proj_dep><span class=command>lemma</span></span> dep_proj_dep<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"dep <span class=main>(</span>prob_proj <span class=free>PROB</span> <span class=free>vs</span><span class=main>)</span> <span class=free>v</span> <span class=free>v'</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"dep <span class=free>PROB</span> <span class=free>v</span> <span class=free>v'</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>unfolding</span></span> dep_def prob_proj_def action_proj_def image_def
  <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span><span class=main><span class=main>:</span></span> fmdom'_restrict_set_precise<span class=main>)</span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>


<span class=keyword1 id=SystemAbstraction-NDEP_PROJ_NDEP><span class=command>lemma</span></span> NDEP_PROJ_NDEP<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=free>vs</span> <span class=free>vs'</span> <span class=free>vs''</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>¬</span>dep_var_set <span class=free>PROB</span> <span class=free>vs</span> <span class=free>vs'</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>¬</span>dep_var_set <span class=main>(</span>prob_proj <span class=free>PROB</span> <span class=free>vs''</span><span class=main>)</span> <span class=free>vs</span> <span class=free>vs'</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms dep_proj_dep
  <span class=keyword1><span class=command>unfolding</span></span> dep_var_set_def
  <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>


<span class=keyword1 id=SystemAbstraction-SUBSET_PROJ_DOM_DISJ><span class=command>lemma</span></span> SUBSET_PROJ_DOM_DISJ<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=free>vs</span> <span class=free>vs'</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>vs</span> <span class=main>⊆</span> <span class=main>(</span>prob_dom <span class=main>(</span>prob_proj <span class=free>PROB</span> <span class=main>(</span>prob_dom <span class=free>PROB</span> <span class=main>-</span> <span class=free>vs'</span><span class=main>)</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"disjnt <span class=free>vs</span> <span class=free>vs'</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> PROB_DOM_PROJ_DIFF subset_iff disjnt_iff<span class=main>)</span>


<span class=comment1>― ‹TODO showcase (lemma which is solved effortlessly by automation).›</span>
<span class=keyword1 id=SystemAbstraction-NOT_VS_DEP_IMP_DEP_PROJ><span class=command>lemma</span></span> NOT_VS_DEP_IMP_DEP_PROJ<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=free>vs</span> <span class=free>v</span> <span class=free>v'</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span><span class=main>(</span><span class=free>v</span> <span class=main>∈</span> <span class=free>vs</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span><span class=main>(</span><span class=free>v'</span> <span class=main>∈</span> <span class=free>vs</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>dep <span class=free>PROB</span> <span class=free>v</span> <span class=free>v'</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>dep <span class=main>(</span>prob_proj <span class=free>PROB</span> <span class=main>(</span>prob_dom <span class=free>PROB</span> <span class=main>-</span> <span class=free>vs</span><span class=main>)</span><span class=main>)</span> <span class=free>v</span> <span class=free>v'</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> Diff_disjoint Diff_iff disjnt_def insertCI IN_DISJ_DEP_IMP_DEP_DIFF<span class=main>)</span>


<span class=keyword1 id=SystemAbstraction-DISJ_PROJ_NDEP_IMP_NDEP><span class=command>lemma</span></span> DISJ_PROJ_NDEP_IMP_NDEP<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=free>vs</span> <span class=free>vs'</span> <span class=free>vs''</span>
  <span class=keyword2><span class=keyword>assumes</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span>disjnt <span class=free>vs</span> <span class=free>vs''</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"disjnt <span class=free>vs</span> <span class=free>vs'</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>¬</span><span class=main>(</span>dep_var_set <span class=main>(</span>prob_proj <span class=free>PROB</span> <span class=main>(</span>prob_dom <span class=free>PROB</span> <span class=main>-</span> <span class=free>vs</span><span class=main>)</span><span class=main>)</span> <span class=free>vs'</span> <span class=free>vs''</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span><span class=main>(</span>dep_var_set <span class=free>PROB</span> <span class=free>vs'</span> <span class=free>vs''</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>assume</span></span> C<span class=main>:</span> <span class=quoted><span class=quoted>"dep_var_set <span class=free>PROB</span> <span class=free>vs'</span> <span class=free>vs''</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>v1</span></span> <span class=skolem><span class=skolem>v2</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v1</span> <span class=main>∈</span> <span class=free>vs'</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v2</span> <span class=main>∈</span> <span class=free>vs''</span>"</span></span> <span class=quoted><span class=quoted>"disjnt <span class=free>vs'</span> <span class=free>vs''</span>"</span></span> <span class=quoted><span class=quoted>"dep <span class=free>PROB</span> <span class=skolem>v1</span> <span class=skolem>v2</span>"</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> dep_var_set_def
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>v1</span> <span class=bound>v2</span><span class=main>.</span>
      <span class=bound>v1</span> <span class=main>∈</span> <span class=free>vs'</span> <span class=main>∧</span> <span class=bound>v2</span> <span class=main>∈</span> <span class=free>vs''</span> <span class=main>∧</span> disjnt <span class=free>vs'</span> <span class=free>vs''</span> <span class=main>∧</span> dep <span class=main>(</span>prob_proj <span class=free>PROB</span> <span class=main>(</span>prob_dom <span class=free>PROB</span> <span class=main>-</span> <span class=free>vs</span><span class=main>)</span><span class=main>)</span> <span class=bound>v1</span> <span class=bound>v2</span>
    "</span></span>
      <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>,</span> 2<span class=main>)</span> IntI disjnt_def empty_iff NOT_VS_DEP_IMP_DEP_PROJ
      <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted>False</span>
      <span class=keyword1><span class=command>using</span></span> assms
      <span class=keyword1><span class=command>unfolding</span></span> dep_var_set_def
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>using</span></span> assms
    <span class=keyword1><span class=command>unfolding</span></span> dep_var_set_def
    <span class=keyword1><span class=command>by</span></span> <span class=operator>argo</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1 id=SystemAbstraction-PROJ_DOM_IDEMPOT><span class=command>lemma</span></span> PROJ_DOM_IDEMPOT<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"prob_proj <span class=free>PROB</span> <span class=main>(</span>prob_dom <span class=free>PROB</span><span class=main>)</span> <span class=main>=</span> <span class=free>PROB</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> action_proj_idempot''
  <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>


<span class=keyword1 id=SystemAbstraction-prob_proj_idempot><span class=command>lemma</span></span> prob_proj_idempot<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>vs</span> <span class=free>vs'</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>vs</span> <span class=main>⊆</span> <span class=free>vs'</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>prob_proj <span class=free>PROB</span> <span class=free>vs</span> <span class=main>=</span> prob_proj <span class=main>(</span>prob_proj <span class=free>PROB</span> <span class=free>vs'</span><span class=main>)</span> <span class=free>vs</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms subset_proj_absorb
  <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>


<span class=keyword1 id=SystemAbstraction-prob_proj_dom_diff_eq_prob_proj_prob_proj_dom_diff><span class=command>lemma</span></span> prob_proj_dom_diff_eq_prob_proj_prob_proj_dom_diff<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>vs</span> <span class=free>vs'</span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"
    prob_proj <span class=free>PROB</span> <span class=main>(</span>prob_dom <span class=free>PROB</span> <span class=main>-</span> <span class=main>(</span><span class=free>vs</span> <span class=main>∪</span> <span class=free>vs'</span><span class=main>)</span><span class=main>)</span>
    <span class=main>=</span> prob_proj
      <span class=main>(</span>prob_proj <span class=free>PROB</span> <span class=main>(</span>prob_dom <span class=free>PROB</span> <span class=main>-</span> <span class=free>vs</span><span class=main>)</span><span class=main>)</span>
      <span class=main>(</span>prob_dom <span class=main>(</span>prob_proj <span class=free>PROB</span> <span class=main>(</span>prob_dom <span class=free>PROB</span> <span class=main>-</span> <span class=free>vs</span><span class=main>)</span><span class=main>)</span> <span class=main>-</span> <span class=free>vs'</span><span class=main>)</span>
"</span></span>
  <span class=keyword1><span class=command>using</span></span> PROB_DOM_PROJ_DIFF subset_proj_absorb
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> Compl_Diff_eq Diff_subset compl_eq_compl_iff sup_assoc<span class=main>)</span>


<span class=keyword1 id=SystemAbstraction-PROJ_DEP_IMP_DEP><span class=command>lemma</span></span> PROJ_DEP_IMP_DEP<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=free>vs</span> <span class=free>v</span> <span class=free>v'</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"dep <span class=main>(</span>prob_proj <span class=free>PROB</span> <span class=main>(</span>prob_dom <span class=free>PROB</span> <span class=main>-</span> <span class=free>vs</span><span class=main>)</span><span class=main>)</span> <span class=free>v</span> <span class=free>v'</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"dep <span class=free>PROB</span> <span class=free>v</span> <span class=free>v'</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>unfolding</span></span> dep_def prob_proj_def
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=free>v</span> <span class=main>=</span> <span class=free>v'</span>"</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> False
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>a</span><span class=main>.</span>
      <span class=bound>a</span> <span class=main>∈</span> <span class=free>PROB</span>
      <span class=main>∧</span> <span class=main>(</span><span class=free>v</span> <span class=main>∈</span> fmdom' <span class=main>(</span>fst <span class=bound>a</span><span class=main>)</span> <span class=main>∧</span> <span class=free>v'</span> <span class=main>∈</span> fmdom' <span class=main>(</span>snd <span class=bound>a</span><span class=main>)</span> <span class=main>∨</span> <span class=free>v</span> <span class=main>∈</span> fmdom' <span class=main>(</span>snd <span class=bound>a</span><span class=main>)</span> <span class=main>∧</span> <span class=free>v'</span> <span class=main>∈</span> fmdom' <span class=main>(</span>snd <span class=bound>a</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>
    <span class=main>∨</span> <span class=free>v</span> <span class=main>=</span> <span class=free>v'</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms
    <span class=keyword1><span class=command>unfolding</span></span> dep_def prob_proj_def
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>smt</span> image_iff NOT_IN_PRE_EFF_NOT_IN_PRE_EFF_PROJ<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span> <span class=operator>blast</span>


<span class=keyword1 id=SystemAbstraction-PROJ_NDEP_TC_IMP_NDEP_TC_OR><span class=command>lemma</span></span> PROJ_NDEP_TC_IMP_NDEP_TC_OR<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=free>vs</span> <span class=free>v</span> <span class=free>v'</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span><span class=main>(</span><span class=main>(</span><span class=main>λ</span><span class=bound>v1'</span> <span class=bound>v2'</span><span class=main>.</span> dep <span class=main>(</span>prob_proj <span class=free>PROB</span> <span class=main>(</span>prob_dom <span class=free>PROB</span> <span class=main>-</span> <span class=free>vs</span><span class=main>)</span><span class=main>)</span> <span class=bound>v1'</span> <span class=bound>v2'</span><span class=main>)</span><span class=main><span class=hidden>⇧</span><sup>+</sup><span class=hidden>⇧</span><sup>+</sup></span> <span class=free>v</span> <span class=free>v'</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>
    <span class=main>(</span><span class=main>¬</span><span class=main>(</span><span class=main>(</span><span class=main>λ</span><span class=bound>v1'</span> <span class=bound>v2'</span><span class=main>.</span> dep <span class=free>PROB</span> <span class=bound>v1'</span> <span class=bound>v2'</span><span class=main>)</span><span class=main><span class=hidden>⇧</span><sup>+</sup><span class=hidden>⇧</span><sup>+</sup></span> <span class=free>v</span> <span class=free>v'</span><span class=main>)</span><span class=main>)</span>
    <span class=main>∨</span> <span class=main>(</span><span class=main>∃</span><span class=bound>v''</span><span class=main>.</span>
      <span class=bound>v''</span> <span class=main>∈</span> <span class=free>vs</span>
      <span class=main>∧</span> <span class=main>(</span><span class=main>(</span><span class=main>λ</span><span class=bound>v1'</span> <span class=bound>v2'</span><span class=main>.</span> dep <span class=free>PROB</span> <span class=bound>v1'</span> <span class=bound>v2'</span><span class=main>)</span><span class=main><span class=hidden>⇧</span><sup>+</sup><span class=hidden>⇧</span><sup>+</sup></span> <span class=free>v</span> <span class=bound>v''</span><span class=main>)</span>
      <span class=main>∧</span> <span class=main>(</span><span class=main>(</span><span class=main>λ</span><span class=bound>v1'</span> <span class=bound>v2'</span><span class=main>.</span> dep <span class=free>PROB</span> <span class=bound>v1'</span> <span class=bound>v2'</span><span class=main>)</span><span class=main><span class=hidden>⇧</span><sup>+</sup><span class=hidden>⇧</span><sup>+</sup></span> <span class=bound>v''</span> <span class=free>v'</span><span class=main>)</span>
    <span class=main>)</span>
  <span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms NOT_VS_DEP_IMP_DEP_PROJ DEP_REFL REFL_TC_CONJ<span class=main>[</span><span class=operator>of</span>
      <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>v</span> <span class=bound>v'</span><span class=main>.</span> dep <span class=free>PROB</span> <span class=bound>v</span>  <span class=bound>v'</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>v</span><span class=main>.</span> <span class=main>¬</span><span class=main>(</span><span class=bound>v</span> <span class=main>∈</span> <span class=free>vs</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>v</span> <span class=bound>v'</span><span class=main>.</span> dep <span class=main>(</span>prob_proj <span class=free>PROB</span> <span class=main>(</span>prob_dom <span class=free>PROB</span><span class=main>-</span> <span class=free>vs</span><span class=main>)</span><span class=main>)</span> <span class=bound>v</span> <span class=bound>v'</span>"</span></span>
      <span class=quoted><span class=free>v</span></span> <span class=quoted><span class=free>v'</span></span><span class=main>]</span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>


<span class=keyword1 id=SystemAbstraction-every_action_proj_eq_as_proj><span class=command>lemma</span></span> every_action_proj_eq_as_proj<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>as</span> <span class=free>vs</span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"list_all <span class=main>(</span><span class=main>λ</span> <span class=bound>a</span><span class=main>.</span> action_proj <span class=bound>a</span> <span class=free>vs</span> <span class=main>=</span> <span class=bound>a</span><span class=main>)</span> <span class=main>(</span>as_proj <span class=free>as</span> <span class=free>vs</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>as</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> action_proj_idempot<span class=main>)</span>


<span class=keyword1 id=SystemAbstraction-empty_eff_not_in_as_proj_2><span class=command>lemma</span></span> empty_eff_not_in_as_proj_2<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>a</span> <span class=free>as</span> <span class=free>vs</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>snd <span class=main>(</span>action_proj <span class=free>a</span> <span class=free>vs</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>{}</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>as_proj <span class=free>as</span> <span class=free>vs</span> <span class=main>=</span> as_proj <span class=main>(</span><span class=free>a</span> <span class=main>#</span> <span class=free>as</span><span class=main>)</span> <span class=free>vs</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> action_proj_def<span class=main>)</span>

<span class=keyword1><span class=command>declare</span></span><span class=main>[</span><span class=main>[</span><span class=operator>smt_timeout</span><span class=main><span class=main>=</span></span>100<span class=main>]</span><span class=main>]</span>

<span class=keyword1 id=SystemAbstraction-sublist_as_proj_eq_as><span class=command>lemma</span></span> sublist_as_proj_eq_as<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>as'</span> <span class=free>as</span> <span class=free>vs</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"subseq <span class=free>as'</span> <span class=main>(</span>as_proj <span class=free>as</span> <span class=free>vs</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>as_proj <span class=free>as'</span> <span class=free>vs</span> <span class=main>=</span> <span class=free>as'</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>as</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>as'</span></span> <span class=quoted><span class=free>vs</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> Nil
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>as'</span> <span class=main>=</span> <span class=main>[]</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Nil.prems sublist_NIL
    <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> cons<span class=main>:</span> <span class=main>(</span>Cons <span class=skolem>a</span> <span class=skolem>as</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=skolem>as'</span>"</span></span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>aa</span> <span class=skolem>list</span><span class=main>)</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>fmrestrict_set <span class=skolem>vs</span> <span class=main>(</span>snd <span class=skolem>aa</span><span class=main>)</span><span class=main>)</span> <span class=main>≠</span> <span class=main>{}</span>"</span></span><span class=main>)</span>
      <span class=keyword3><span class=command>case</span></span> True
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"as_proj <span class=skolem>as'</span> <span class=skolem>vs</span> <span class=main>=</span> action_proj <span class=skolem>aa</span> <span class=skolem>vs</span> <span class=main>#</span> as_proj <span class=skolem>list</span> <span class=skolem>vs</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> Cons True
        <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> as_proj.simps<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span> cons.IH cons.prems action_proj_idempot local.Cons
            subseq_Cons2_iff<span class=main>)</span>
    <span class=keyword1><span class=command>next</span></span>
      <span class=keyword3><span class=command>case</span></span> False
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"as_proj <span class=skolem>as'</span> <span class=skolem>vs</span> <span class=main>=</span> as_proj <span class=skolem>list</span> <span class=skolem>vs</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> Cons False
        <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> <span class=keyword1><span class=command>using</span></span> cons False
        <span class=keyword1><span class=command>unfolding</span></span> Cons
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>smt</span> action_proj_def action_proj_idempot as_proj.simps<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span> prod.inject subseq_Cons2_neq<span class=main>)</span>
    <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>qed</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1 id=SystemAbstraction-DISJ_EFF_DISJ_PROJ_EFF><span class=command>lemma</span></span> DISJ_EFF_DISJ_PROJ_EFF<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>a</span> <span class=free>s</span> <span class=free>vs</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span> <span class=main>∩</span> <span class=free>s</span> <span class=main>=</span> <span class=main>{}</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>fmdom' <span class=main>(</span>snd <span class=main>(</span>action_proj <span class=free>a</span> <span class=free>vs</span><span class=main>)</span><span class=main>)</span> <span class=main>∩</span> <span class=free>s</span> <span class=main>=</span> <span class=main>{}</span><span class=main>)</span>
"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"snd <span class=main>(</span>action_proj <span class=free>a</span> <span class=free>vs</span><span class=main>)</span> <span class=main>=</span> fmrestrict_set <span class=free>vs</span> <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> action_proj_def
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span><span class=main>)</span> <span class=main>⊆</span> fmdom' <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> act_dom_proj_eff_subset_act_dom_eff
    <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>using</span></span> assms 1
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=comment1>― ‹NOTE showcase (the step using `graph\_plan\_lemma\_5`--- labelled by '[1]'--- is non-trivial proof
due to missing premises and the last six proof steps are redundant).›</span>
<span class=keyword1 id=SystemAbstraction-state_succ_proj_eq_state_succ><span class=command>lemma</span></span> state_succ_proj_eq_state_succ<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>a</span> <span class=free>s</span> <span class=free>vs</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>varset_action <span class=free>a</span> <span class=free>vs</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>fst <span class=free>a</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>fmdom' <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span> <span class=main>⊆</span> fmdom' <span class=free>s</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>state_succ <span class=free>s</span> <span class=main>(</span>action_proj <span class=free>a</span> <span class=free>vs</span><span class=main>)</span> <span class=main>=</span> state_succ <span class=free>s</span> <span class=free>a</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span> <span class=main>∩</span> <span class=main>(</span>fmdom' <span class=free>s</span> <span class=main>-</span> <span class=free>vs</span><span class=main>)</span> <span class=main>=</span> <span class=main>{}</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>)</span> vset_disj_eff_diff
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span>  2<span class=main>:</span>
    <span class=quoted><span class=quoted>"fmrestrict_set <span class=main>(</span>fmdom' <span class=free>s</span> <span class=main>-</span> <span class=free>vs</span><span class=main>)</span> <span class=free>s</span> <span class=main>=</span> fmrestrict_set <span class=main>(</span>fmdom' <span class=free>s</span> <span class=main>-</span> <span class=free>vs</span><span class=main>)</span> <span class=main>(</span>state_succ <span class=free>s</span> <span class=free>a</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> disj_imp_eq_proj_exec<span class=main>[</span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> vs <span class=main><span class=main>=</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=free>s</span> <span class=main>-</span> <span class=free>vs</span>"</span></span><span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>snd <span class=main>(</span>action_proj <span class=free>a</span> <span class=free>vs</span><span class=main>)</span><span class=main>)</span> <span class=main>∩</span> <span class=main>(</span>fmdom' <span class=free>s</span> <span class=main>-</span> <span class=free>vs</span><span class=main>)</span> <span class=main>=</span> <span class=main>{}</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> 1 DISJ_EFF_DISJ_PROJ_EFF<span class=main>[</span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> s <span class=main><span class=main>=</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>fmdom' <span class=free>s</span> <span class=main>-</span> <span class=free>vs</span><span class=main>)</span>"</span></span><span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"
    fmrestrict_set <span class=main>(</span>fmdom' <span class=free>s</span> <span class=main>-</span> <span class=free>vs</span><span class=main>)</span> <span class=free>s</span>
    <span class=main>=</span> fmrestrict_set <span class=main>(</span>fmdom' <span class=free>s</span> <span class=main>-</span> <span class=free>vs</span><span class=main>)</span> <span class=main>(</span>state_succ <span class=free>s</span> <span class=main>(</span>action_proj <span class=free>a</span> <span class=free>vs</span><span class=main>)</span><span class=main>)</span>
  "</span></span>
    <span class=keyword1><span class=command>using</span></span> disj_imp_eq_proj_exec<span class=main>[</span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> a <span class=main><span class=main>=</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>action_proj <span class=free>a</span> <span class=free>vs</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>and</span></span></span> vs <span class=main><span class=main>=</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=free>s</span> <span class=main>-</span> <span class=free>vs</span>"</span></span><span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>snd <span class=main>(</span>action_proj <span class=free>a</span> <span class=free>vs</span><span class=main>)</span><span class=main>)</span> <span class=main>∩</span> <span class=main>(</span>fmdom' <span class=free>s</span> <span class=main>-</span> <span class=free>vs</span><span class=main>)</span> <span class=main>=</span> <span class=main>{}</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> 1 DISJ_EFF_DISJ_PROJ_EFF<span class=main>[</span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> s <span class=main><span class=main>=</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>fmdom' <span class=free>s</span> <span class=main>-</span> <span class=free>vs</span><span class=main>)</span>"</span></span><span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"
    fmrestrict_set <span class=main>(</span>fmdom' <span class=free>s</span> <span class=main>-</span> <span class=free>vs</span><span class=main>)</span> <span class=free>s</span> <span class=main>=</span>
    fmrestrict_set <span class=main>(</span>fmdom' <span class=free>s</span> <span class=main>-</span> <span class=free>vs</span><span class=main>)</span> <span class=main>(</span>state_succ <span class=free>s</span> <span class=main>(</span>action_proj <span class=free>a</span> <span class=free>vs</span><span class=main>)</span><span class=main>)</span>
  "</span></span>
    <span class=keyword1><span class=command>using</span></span> disj_imp_eq_proj_exec<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"action_proj <span class=free>a</span> <span class=free>vs</span>"</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=free>s</span> <span class=main>-</span> <span class=free>vs</span>"</span></span><span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
      <span class=comment1>― ‹[1]›</span>
      <span class=comment1>― ‹TODO unwrap this step.›</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>using</span></span> 2 FDOM_state_succ graph_plan_lemma_5<span class=main>[</span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> s <span class=main><span class=main>=</span></span> <span class=quoted><span class=quoted>"state_succ <span class=free>s</span> <span class=main>(</span>action_proj <span class=free>a</span> <span class=free>vs</span><span class=main>)</span>"</span></span>
        <span class=keyword2><span class=keyword><span class=quasi_keyword>and</span></span></span> s' <span class=main><span class=main>=</span></span> <span class=quoted><span class=quoted>"state_succ <span class=free>s</span> <span class=free>a</span>"</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>and</span></span></span> vs <span class=main><span class=main>=</span></span> <span class=quoted><span class=free>vs</span></span><span class=main>]</span> assms<span class=main>(</span>2<span class=main>,</span> 3<span class=main>)</span> dom_eff_subset_imp_dom_succ_eq_proj
      drest_proj_succ_eq_drest_succ
    <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=comment1>― ‹NOTE duplicate declaration of lemma `state\_succ\_proj\_eq\_state\_succ` removed.›</span>


<span class=keyword1 id=SystemAbstraction-no_effectless_proj><span class=command>lemma</span></span> no_effectless_proj<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>vs</span> <span class=free>as</span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"no_effectless_act <span class=main>(</span>as_proj <span class=free>as</span> <span class=free>vs</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>as</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>vs</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> action_proj_def<span class=main>)</span>


<span class=comment1>― ‹NOTE duplicate (this is identical to `valid\_as\_valid\_as\_proj`).›</span>
<span class=keyword1 id=SystemAbstraction-as_proj_valid_in_prob_proj><span class=command>lemma</span></span> as_proj_valid_in_prob_proj<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=free>vs</span> <span class=free>as</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>as_proj <span class=free>as</span> <span class=free>vs</span> <span class=main>∈</span> valid_plans <span class=main>(</span>prob_proj <span class=free>PROB</span> <span class=free>vs</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms valid_as_valid_as_proj
  <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>


<span class=comment1>― ‹TODO Unwrap the smt proof.›</span>
<span class=keyword1 id=SystemAbstraction-prob_proj_comm><span class=command>lemma</span></span> prob_proj_comm<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=free>vs</span> <span class=free>vs'</span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"prob_proj <span class=main>(</span>prob_proj <span class=free>PROB</span> <span class=free>vs</span><span class=main>)</span> <span class=free>vs'</span> <span class=main>=</span> prob_proj <span class=main>(</span>prob_proj <span class=free>PROB</span> <span class=free>vs'</span><span class=main>)</span> <span class=free>vs</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>smt</span> graph_plan_neq_mems_state_set_neq_len inf_commute inf_le2 PROJ_DOM_IDEMPOT prob_proj_idempot<span class=main>)</span>


<span class=comment1>― ‹TODO Unwrap the metis proof.›</span>
<span class=keyword1 id=SystemAbstraction-vset_proj_imp_vset><span class=command>lemma</span></span> vset_proj_imp_vset<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>vs</span> <span class=free>vs'</span> <span class=free>a</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>varset_action <span class=free>a</span> <span class=free>vs'</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>varset_action <span class=main>(</span>action_proj <span class=free>a</span> <span class=free>vs'</span><span class=main>)</span> <span class=free>vs</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>varset_action <span class=free>a</span> <span class=free>vs</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> varset_action_def action_proj_def
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> action_proj_def exec_drest_5 snd_conv varset_action_def<span class=main>)</span>


<span class=keyword1 id=SystemAbstraction-vset_imp_vset_act_proj_diff><span class=command>lemma</span></span>  vset_imp_vset_act_proj_diff<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=free>vs</span> <span class=free>vs'</span> <span class=free>a</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>varset_action <span class=free>a</span> <span class=free>vs</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>varset_action <span class=main>(</span>action_proj <span class=free>a</span> <span class=main>(</span>prob_dom <span class=free>PROB</span> <span class=main>-</span> <span class=free>vs'</span><span class=main>)</span><span class=main>)</span> <span class=free>vs</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span>fmdom' <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span> <span class=main>⊆</span> <span class=free>vs</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms varset_action_def
    <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=comment1>― ‹TODO refactor and put into `Fmap\_Utils`.›</span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"
      fmdom' <span class=main>(</span>snd <span class=main>(</span>
        fmrestrict_set <span class=main>(</span>prob_dom <span class=free>PROB</span> <span class=main>-</span> <span class=free>vs'</span><span class=main>)</span> <span class=main>(</span>fst <span class=free>a</span><span class=main>)</span>
        <span class=main>,</span> fmrestrict_set <span class=main>(</span>prob_dom <span class=free>PROB</span> <span class=main>-</span> <span class=free>vs'</span><span class=main>)</span> <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span>
      <span class=main>)</span><span class=main>)</span>
      <span class=main>=</span> <span class=main>(</span>fmdom' <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span> <span class=main>∩</span> <span class=main>(</span>prob_dom <span class=free>PROB</span> <span class=main>-</span> <span class=free>vs'</span><span class=main>)</span><span class=main>)</span>
    "</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> Int_def Set.filter_def fmfilter_alt_defs<span class=main><span class=main>(</span></span>4<span class=main><span class=main>)</span></span><span class=main>)</span>
    <span class=keyword1><span class=command>also</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>…</span> <span class=main>⊆</span> fmdom' <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>finally</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>snd <span class=main>(</span>
        fmrestrict_set <span class=main>(</span>prob_dom <span class=free>PROB</span> <span class=main>-</span> <span class=free>vs'</span><span class=main>)</span> <span class=main>(</span>fst <span class=free>a</span><span class=main>)</span>
        <span class=main>,</span> fmrestrict_set <span class=main>(</span>prob_dom <span class=free>PROB</span> <span class=main>-</span> <span class=free>vs'</span><span class=main>)</span> <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span>
      <span class=main>)</span><span class=main>)</span>
      <span class=main>⊆</span> <span class=free>vs</span>
    "</span></span>
      <span class=keyword1><span class=command>using</span></span> 1 <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>unfolding</span></span> varset_action_def dep_var_set_def dep_def action_proj_def
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1 id=SystemAbstraction-action_proj_disj_diff><span class=command>lemma</span></span> action_proj_disj_diff<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>action_dom <span class=main>(</span>fst <span class=free>a</span><span class=main>)</span> <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span> <span class=main>⊆</span> <span class=free>vs1</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>vs2</span> <span class=main>∩</span> <span class=free>vs3</span> <span class=main>=</span> <span class=main>{}</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>action_proj <span class=main>(</span>action_proj <span class=free>a</span> <span class=main>(</span><span class=free>vs1</span> <span class=main>-</span> <span class=free>vs2</span><span class=main>)</span><span class=main>)</span> <span class=free>vs3</span> <span class=main>=</span> action_proj <span class=free>a</span> <span class=free>vs3</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>f</span> <span class=bound>fa</span> <span class=bound>fb</span> <span class=bound>p</span><span class=main>.</span>
    action_proj <span class=main>(</span>action_proj <span class=main>(</span>action_proj <span class=bound>p</span> <span class=bound>f</span><span class=main>)</span> <span class=bound>fb</span><span class=main>)</span> <span class=bound>fa</span> <span class=main>=</span> action_proj <span class=main>(</span>action_proj <span class=bound>p</span> <span class=bound>f</span><span class=main>)</span> <span class=bound>fb</span>
    <span class=main>∨</span> <span class=main>¬</span> action_dom <span class=main>(</span>fst <span class=bound>p</span><span class=main>::</span><span class=main>(</span><span class=tfree>'a</span><span class=main>,</span> <span class=tfree>'b</span><span class=main>)</span> fmap<span class=main>)</span> <span class=main>(</span>snd <span class=bound>p</span><span class=main>::</span><span class=main>(</span><span class=main>_</span><span class=main>,</span> <span class=tfree>'c</span><span class=main>)</span> fmap<span class=main>)</span> <span class=main>∩</span> <span class=main>(</span><span class=bound>f</span> <span class=main>∩</span> <span class=bound>fb</span><span class=main>)</span> <span class=main>⊆</span> <span class=bound>fa</span>
  "</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> <span class=main><span class=main>(</span></span>no_types<span class=main><span class=main>)</span></span> action_proj_idempot' proj_action_dom_eq_inter inf_assoc<span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>f</span> <span class=bound>fa</span> <span class=bound>p</span><span class=main>.</span>
    action_proj <span class=main>(</span>action_proj <span class=main>(</span><span class=bound>p</span><span class=main>::</span><span class=main>(</span><span class=tfree>'a</span><span class=main>,</span> <span class=tfree>'b</span><span class=main>)</span> fmap <span class=main>×</span> <span class=main>(</span><span class=main>_</span><span class=main>,</span> <span class=tfree>'c</span><span class=main>)</span> fmap<span class=main>)</span> <span class=bound>f</span><span class=main>)</span> <span class=bound>fa</span>
    <span class=main>=</span> action_proj <span class=bound>p</span> <span class=main>(</span><span class=bound>f</span> <span class=main>∩</span> <span class=bound>fa</span><span class=main>)</span>
  "</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> <span class=main><span class=main>(</span></span>no_types<span class=main><span class=main>)</span></span> inf.cobounded2 inf_commute subset_proj_absorb_1<span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>using</span></span> assms
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> Diff_Int_distrib2 Diff_empty action_proj_idempot'<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1 id=SystemAbstraction-disj_proj_proj_eq_proj><span class=command>lemma</span></span> disj_proj_proj_eq_proj<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=free>vs</span> <span class=free>vs'</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>vs</span> <span class=main>∩</span> <span class=free>vs'</span> <span class=main>=</span> <span class=main>{}</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"prob_proj <span class=main>(</span>prob_proj <span class=free>PROB</span> <span class=main>(</span>prob_dom <span class=free>PROB</span> <span class=main>-</span> <span class=free>vs'</span><span class=main>)</span><span class=main>)</span> <span class=free>vs</span> <span class=main>=</span> prob_proj <span class=free>PROB</span> <span class=free>vs</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>a</span>
    <span class=keyword3><span class=command>assume</span></span> P<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>a</span> <span class=main>∈</span> <span class=free>PROB</span>"</span></span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"action_dom <span class=main>(</span>fst <span class=skolem>a</span><span class=main>)</span> <span class=main>(</span>snd <span class=skolem>a</span><span class=main>)</span> <span class=main>⊆</span> prob_dom <span class=free>PROB</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> P exec_as_proj_valid_2
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"action_proj <span class=main>(</span>action_proj <span class=skolem>a</span> <span class=main>(</span>prob_dom <span class=free>PROB</span> <span class=main>-</span> <span class=free>vs'</span><span class=main>)</span><span class=main>)</span> <span class=free>vs</span> <span class=main>=</span> action_proj <span class=skolem>a</span> <span class=free>vs</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> assms action_proj_disj_diff<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=skolem>a</span></span> <span class=quoted><span class=quoted>"prob_dom <span class=free>PROB</span>"</span></span> <span class=quoted><span class=free>vs'</span></span> <span class=quoted><span class=free>vs</span></span><span class=main>]</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>unfolding</span></span> prob_proj_def
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>smt</span> image_cong image_image<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1 id=SystemAbstraction-n_replace_proj_le_n_as_2><span class=command>lemma</span></span> n_replace_proj_le_n_as_2<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>a</span> <span class=free>vs</span> <span class=free>vs'</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>vs</span> <span class=main>⊆</span> <span class=free>vs'</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>varset_action <span class=free>a</span> <span class=free>vs'</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>varset_action <span class=main>(</span>action_proj <span class=free>a</span> <span class=free>vs'</span><span class=main>)</span> <span class=free>vs</span> <span class=main>⟷</span> varset_action <span class=free>a</span> <span class=free>vs</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> varset_action_def action_proj_def
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> exec_drest_5 varset_action_def<span class=main>)</span>


<span class=comment1>― ‹NOTE type of `PROB` had to be fixed for use of `empty\_problem\_bound`.›</span>
<span class=keyword1 id=SystemAbstraction-empty_problem_proj_bound><span class=command>lemma</span></span> empty_problem_proj_bound<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> problem"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"problem_plan_bound <span class=main>(</span>prob_proj <span class=free>PROB</span> <span class=main>{}</span><span class=main>)</span> <span class=main>=</span> <span class=main>0</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=comment1>― ‹TODO refactor?›</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"prob_proj <span class=main>{}</span> <span class=main>{}</span> <span class=main>=</span> <span class=main>{}</span>"</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> prob_proj_def action_proj_def
      <span class=keyword1><span class=command>using</span></span> image_empty
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>{</span></span>
      <span class=keyword3><span class=command>assume</span></span> P<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>PROB</span> <span class=main>≠</span> <span class=main>{}</span>"</span></span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>a</span><span class=main>.</span> <span class=main>(</span>fmrestrict_set <span class=main>{}</span> <span class=main>(</span>fst <span class=bound>a</span><span class=main>)</span><span class=main>,</span> fmrestrict_set <span class=main>{}</span> <span class=main>(</span>snd <span class=bound>a</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span>fmempty<span class=main>,</span> fmempty<span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> fmrestrict_set_null
        <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"prob_proj <span class=free>PROB</span> <span class=main>{}</span> <span class=main>=</span> <span class=main>{</span><span class=main>(</span>fmempty<span class=main>,</span> fmempty<span class=main>)</span><span class=main>}</span>"</span></span>
        <span class=keyword1><span class=command>unfolding</span></span> prob_proj_def action_proj_def
        <span class=keyword1><span class=command>using</span></span> P
        <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>}</span></span>
    <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>consider</span></span>
      <span class=main>(</span>i<span class=main>)</span> <span class=quoted><span class=quoted>"prob_proj <span class=free>PROB</span> <span class=main>{}</span> <span class=main>=</span> <span class=main>{}</span>"</span></span>
      <span class=main>|</span> <span class=main>(</span>ii<span class=main>)</span> <span class=quoted><span class=quoted>"prob_proj <span class=free>PROB</span> <span class=main>{}</span> <span class=main>=</span> <span class=main>{</span><span class=main>(</span>fmempty<span class=main>,</span> fmempty<span class=main>)</span><span class=main>}</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=free>PROB</span> <span class=main>=</span> <span class=main>{}</span>"</span></span><span class=main>)</span> <span class=operator>force</span><span class=main><span class=keyword3>+</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"prob_dom <span class=main>(</span>prob_proj <span class=free>PROB</span> <span class=main>{}</span><span class=main>)</span> <span class=main>=</span> <span class=main>{}</span>"</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> prob_dom_def action_dom_def <span class=keyword1><span class=command>using</span></span> fmdom'_empty
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>cases</span><span class=main>)</span> <span class=operator>force</span><span class=main><span class=keyword3>+</span></span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>using</span></span> empty_problem_bound<span class=main>[</span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> PROB<span class=main><span class=main>=</span></span><span class=quoted><span class=quoted>"prob_proj <span class=free>PROB</span> <span class=main>{}</span>"</span></span><span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1 id=SystemAbstraction-problem_plan_bound_works_proj><span class=command>lemma</span></span> problem_plan_bound_works_proj<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> problem"</span></span> <span class=keyword2><span class=keyword>and</span></span> <span class=free>s</span> <span class=free>as</span> <span class=free>vs</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"finite <span class=free>PROB</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>s</span> <span class=main>∈</span> valid_states <span class=free>PROB</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>sat_precond_as <span class=free>s</span> <span class=free>as</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>as'</span><span class=main>.</span>
    <span class=main>(</span>exec_plan <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span> <span class=bound>as'</span> <span class=main>=</span> exec_plan <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span> <span class=main>(</span>as_proj <span class=free>as</span> <span class=free>vs</span><span class=main>)</span><span class=main>)</span>
    <span class=main>∧</span> <span class=main>(</span>length <span class=bound>as'</span> <span class=main>≤</span> problem_plan_bound <span class=main>(</span>prob_proj <span class=free>PROB</span> <span class=free>vs</span><span class=main>)</span><span class=main>)</span>
    <span class=main>∧</span> <span class=main>(</span>subseq <span class=bound>as'</span> <span class=main>(</span>as_proj <span class=free>as</span> <span class=free>vs</span><span class=main>)</span><span class=main>)</span>
    <span class=main>∧</span> <span class=main>(</span>sat_precond_as <span class=free>s</span> <span class=bound>as'</span><span class=main>)</span>
    <span class=main>∧</span> <span class=main>(</span>no_effectless_act <span class=bound>as'</span><span class=main>)</span>
  <span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"exec_plan <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span> <span class=main>(</span>as_proj <span class=free>as</span> <span class=free>vs</span><span class=main>)</span> <span class=main>=</span> fmrestrict_set <span class=free>vs</span> <span class=main>(</span>exec_plan <span class=free>s</span> <span class=free>as</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>4<span class=main>)</span> sat_precond_exec_as_proj_eq_proj_exec
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmrestrict_set <span class=free>vs</span> <span class=free>s</span> <span class=main>∈</span> valid_states <span class=main>(</span>prob_proj <span class=free>PROB</span> <span class=free>vs</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>2<span class=main>)</span> graph_plan_not_eq_last_diff_paths
      <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"as_proj <span class=free>as</span> <span class=free>vs</span> <span class=main>∈</span> valid_plans <span class=main>(</span>prob_proj <span class=free>PROB</span> <span class=free>vs</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>3<span class=main>)</span> valid_as_valid_as_proj
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"finite <span class=main>(</span>prob_proj <span class=free>PROB</span> <span class=free>vs</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> prob_proj_def
      <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>)</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>as'</span><span class=main>.</span>
      exec_plan <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span> <span class=main>(</span>as_proj <span class=free>as</span> <span class=free>vs</span><span class=main>)</span> <span class=main>=</span> exec_plan <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span> <span class=bound>as'</span>
      <span class=main>∧</span> subseq <span class=bound>as'</span> <span class=main>(</span>as_proj <span class=free>as</span> <span class=free>vs</span><span class=main>)</span> <span class=main>∧</span> length <span class=bound>as'</span> <span class=main>≤</span> problem_plan_bound <span class=main>(</span>prob_proj <span class=free>PROB</span> <span class=free>vs</span><span class=main>)</span>
    "</span></span>
      <span class=keyword1><span class=command>using</span></span> problem_plan_bound_works<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"prob_proj <span class=free>PROB</span> <span class=free>vs</span>"</span></span>
          <span class=quoted><span class=quoted>"fmrestrict_set <span class=free>vs</span> <span class=free>s</span>"</span></span> <span class=quoted><span class=quoted>"as_proj <span class=free>as</span> <span class=free>vs</span>"</span></span><span class=main>]</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>as'</span></span> <span class=keyword2><span class=keyword>where</span></span>
    <span class=quoted><span class=quoted>"exec_plan <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span> <span class=main>(</span>as_proj <span class=free>as</span> <span class=free>vs</span><span class=main>)</span> <span class=main>=</span> exec_plan <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span> <span class=skolem>as'</span>"</span></span>
    <span class=quoted><span class=quoted>"subseq <span class=skolem>as'</span> <span class=main>(</span>as_proj <span class=free>as</span> <span class=free>vs</span><span class=main>)</span> <span class=main>∧</span> length <span class=skolem>as'</span> <span class=main>≤</span> problem_plan_bound <span class=main>(</span>prob_proj <span class=free>PROB</span> <span class=free>vs</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>{</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"
      exec_plan <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span> <span class=free>as</span>
      <span class=main>=</span> exec_plan <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span> <span class=main>(</span>rem_condless_act <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span> <span class=main>[]</span> <span class=free>as</span><span class=main>)</span>
    "</span></span>
      <span class=keyword1><span class=command>using</span></span> rem_condless_valid_1<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"fmrestrict_set <span class=free>vs</span> <span class=free>s</span>"</span></span> <span class=quoted><span class=free>as</span></span><span class=main>]</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"subseq <span class=main>(</span>rem_condless_act <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span> <span class=main>[]</span> <span class=skolem>as'</span><span class=main>)</span> <span class=skolem>as'</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> rem_condless_valid_8 <span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"fmrestrict_set <span class=free>vs</span> <span class=free>s</span>"</span></span> <span class=quoted><span class=skolem>as'</span></span><span class=main>]</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"length <span class=main>(</span>rem_condless_act <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span> <span class=main>[]</span> <span class=skolem>as'</span><span class=main>)</span> <span class=main>≤</span> length <span class=skolem>as'</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> rem_condless_valid_3<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"fmrestrict_set <span class=free>vs</span> <span class=free>s</span>"</span></span><span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> 4<span class=main>:</span>
    <span class=quoted><span class=quoted>"sat_precond_as <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span> <span class=main>(</span>rem_condless_act <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span> <span class=main>[]</span> <span class=skolem>as'</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> rem_condless_valid_2<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"fmrestrict_set <span class=free>vs</span> <span class=free>s</span>"</span></span> <span class=quoted><span class=skolem>as'</span></span><span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"
    exec_plan <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span> <span class=main>(</span>rem_condless_act <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span> <span class=main>[]</span> <span class=skolem>as'</span><span class=main>)</span>
    <span class=main>=</span> exec_plan <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span>
      <span class=main>(</span>rem_effectless_act <span class=main>(</span>rem_condless_act <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span> <span class=main>[]</span> <span class=skolem>as'</span><span class=main>)</span><span class=main>)</span>
  "</span></span>
    <span class=keyword1><span class=command>using</span></span> rem_effectless_works_1<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"fmrestrict_set <span class=free>vs</span> <span class=free>s</span>"</span></span>
        <span class=quoted><span class=quoted>"rem_condless_act <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span> <span class=main>[]</span> <span class=skolem>as'</span>"</span></span><span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>{</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"
      subseq <span class=main>(</span>rem_effectless_act <span class=main>(</span>rem_condless_act <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span> <span class=main>[]</span> <span class=free>as</span><span class=main>)</span><span class=main>)</span>
     <span class=main>(</span>rem_condless_act <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span> <span class=main>[]</span> <span class=free>as</span><span class=main>)</span>
    "</span></span>
      <span class=keyword1><span class=command>using</span></span> rem_effectless_works_9<span class=main>[</span><span class=operator>of</span>
          <span class=quoted><span class=quoted>"<span class=main>(</span>rem_condless_act <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span> <span class=main>[]</span> <span class=main>(</span><span class=free>as</span> <span class=main>::</span> <span class=tfree>'a</span> action list<span class=main>)</span><span class=main>)</span>"</span></span><span class=main>]</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"
      length <span class=main>(</span>rem_effectless_act <span class=main>(</span>rem_condless_act <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span> <span class=main>[]</span> <span class=skolem>as'</span><span class=main>)</span><span class=main>)</span>
      <span class=main>≤</span> length <span class=main>(</span>rem_condless_act <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span> <span class=main>[]</span> <span class=skolem>as'</span><span class=main>)</span>
    "</span></span>
      <span class=keyword1><span class=command>using</span></span> rem_effectless_works_3<span class=main>[</span><span class=operator>of</span>
          <span class=quoted><span class=quoted>"<span class=main>(</span>rem_condless_act <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span> <span class=main>[]</span> <span class=main>(</span><span class=skolem>as'</span> <span class=main>::</span> <span class=tfree>'a</span> action list<span class=main>)</span><span class=main>)</span>"</span></span><span class=main>]</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"
      sat_precond_as <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span>
      <span class=main>(</span>rem_effectless_act <span class=main>(</span>rem_condless_act <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span> <span class=main>[]</span> <span class=skolem>as'</span><span class=main>)</span><span class=main>)</span>
    "</span></span>
      <span class=keyword1><span class=command>using</span></span> 4 rem_effectless_works_2<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"fmrestrict_set <span class=free>vs</span> <span class=free>s</span>"</span></span>
          <span class=quoted><span class=quoted>"<span class=main>(</span>rem_condless_act <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span> <span class=main>[]</span> <span class=skolem>as'</span><span class=main>)</span>"</span></span><span class=main>]</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span>
      <span class=quoted><span class=quoted>"no_effectless_act <span class=main>(</span>rem_effectless_act <span class=main>(</span>rem_condless_act <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span> <span class=main>[]</span> <span class=skolem>as'</span><span class=main>)</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> rem_effectless_works_6<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=main>(</span>rem_condless_act <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span> <span class=main>[]</span> <span class=main>(</span><span class=skolem>as'</span> <span class=main>::</span><span class=tfree>'a</span> action list<span class=main>)</span><span class=main>)</span>"</span></span><span class=main>]</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>using</span></span> rem_effectless_works_13 rem_condless_valid_1 order_trans
      no_effectless_proj sat_precond_drest_sat_precond subseq_order.order_trans
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> <span class=main><span class=main>(</span></span>no_types<span class=main><span class=main>,</span></span> lifting<span class=main><span class=main>)</span></span><span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=comment1>― ‹NOTE added lemma.›</span>
<span class=comment1>― ‹TODO refactor into `Fmap\_Utils`.›</span>
<span class=keyword1 id=SystemAbstraction-action_proj_inter_i><span class=command>lemma</span></span> action_proj_inter_i<span class=main>:</span> <span class=quoted><span class=quoted>"fmrestrict_set <span class=free>V</span> <span class=main>(</span>fmrestrict_set <span class=free>W</span> <span class=free>f</span><span class=main>)</span> <span class=main>=</span> fmrestrict_set <span class=main>(</span><span class=free>V</span> <span class=main>∩</span> <span class=free>W</span><span class=main>)</span> <span class=free>f</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> fmfilter_alt_defs<span class=main>(</span>4<span class=main>)</span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=SystemAbstraction-action_proj_inter><span class=command>lemma</span></span> action_proj_inter<span class=main>:</span> <span class=quoted><span class=quoted>"action_proj <span class=main>(</span>action_proj <span class=free>a</span> <span class=free>vs1</span><span class=main>)</span> <span class=free>vs2</span> <span class=main>=</span> action_proj <span class=free>a</span> <span class=main>(</span><span class=free>vs1</span> <span class=main>∩</span> <span class=free>vs2</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span>
    <span class=quoted><span class=quoted>"fmrestrict_set <span class=free>vs2</span> <span class=main>(</span>fmrestrict_set <span class=free>vs1</span> <span class=main>(</span>fst <span class=free>a</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> fmrestrict_set <span class=main>(</span><span class=free>vs1</span> <span class=main>∩</span> <span class=free>vs2</span><span class=main>)</span> <span class=main>(</span>fst <span class=free>a</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"fmrestrict_set <span class=free>vs2</span> <span class=main>(</span>fmrestrict_set <span class=free>vs1</span> <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> fmrestrict_set <span class=main>(</span><span class=free>vs1</span> <span class=main>∩</span> <span class=free>vs2</span><span class=main>)</span> <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> inf_commute action_proj_inter_i
    <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span><span class=main><span class=keyword3>+</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>unfolding</span></span> action_proj_def
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=SystemAbstraction-prob_proj_inter><span class=command>lemma</span></span> prob_proj_inter<span class=main>:</span> <span class=quoted><span class=quoted>"prob_proj <span class=main>(</span>prob_proj <span class=free>PROB</span> <span class=free>vs1</span><span class=main>)</span> <span class=free>vs2</span> <span class=main>=</span> prob_proj <span class=free>PROB</span> <span class=main>(</span><span class=free>vs1</span> <span class=main>∩</span> <span class=free>vs2</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> prob_proj_def
  <span class=keyword1><span class=command>using</span></span> set_eq_iff image_iff action_proj_inter
  <span class=keyword1><span class=command><span class=improper><span class=command>supply</span></span></span></span><span class=main>[</span><span class=main>[</span><span class=operator>smt_timeout</span><span class=main><span class=main>=</span></span>100<span class=main>]</span><span class=main>]</span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>smt</span> image_cong image_image<span class=main>)</span>


<span class=keyword1><span class=command>subsection</span></span> <span class=quoted><span class=plain_text>"Snapshotting"</span></span>

<span class=keyword1><span class=command>text</span></span> <span class=quoted><span class=plain_text>‹ A snapshot is an abstraction concept of the system in which the assignment of a set of
variables is fixed and actions whose preconditions or effects violate the fixed assignments are
eliminated. [Abdulaziz et al., p.28]

Formally this notion is build on the definition of agreement of states (`agree`), which
states that variables `v`, `v'`in the shared domain of two states must be assigned to the same
value. A snapshot w.r.t to a state `s` is then defined as the set of actions of a problem where the
precondition and the effect agree. [Abdulaziz et al., Definition 16, HOL4 Definition 16, p.28] ›</span></span>


<span class=comment1>― ‹NOTE  name shortened.›</span>
<span class=keyword1><span class=command>definition</span></span> <span class=entity>agree</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>agree</span> <span class=free><span class=bound><span class=entity>s1</span></span></span> <span class=free><span class=bound><span class=entity>s2</span></span></span> <span class=main>≡</span> <span class=main>(</span><span class=main>∀</span><span class=bound>v</span><span class=main>.</span> <span class=main>(</span><span class=bound>v</span> <span class=main>∈</span> fmdom' <span class=free><span class=bound><span class=entity>s1</span></span></span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=bound>v</span> <span class=main>∈</span> fmdom' <span class=free><span class=bound><span class=entity>s2</span></span></span><span class=main>)</span> <span class=main>⟶</span> <span class=main>(</span>fmlookup <span class=free><span class=bound><span class=entity>s1</span></span></span> <span class=bound>v</span> <span class=main>=</span> fmlookup <span class=free><span class=bound><span class=entity>s2</span></span></span> <span class=bound>v</span><span class=main>)</span><span class=main>)</span>"</span></span>


<span class=comment1>― ‹NOTE added lemma.›</span>
<span class=keyword1 id=SystemAbstraction-state_succ_fixpoint_if><span class=command>lemma</span></span> state_succ_fixpoint_if<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>a</span> <span class=free>s</span> <span class=free>PROB</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>a</span> <span class=main>∈</span> <span class=free>PROB</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>s</span> <span class=main>∈</span> valid_states <span class=free>PROB</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"fst <span class=free>a</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s</span>"</span></span> <span class=quoted><span class=quoted>"agree <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span> <span class=free>s</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"state_succ <span class=free>s</span> <span class=free>a</span> <span class=main>=</span> <span class=free>s</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span> <span class=main>⊆</span> fmdom' <span class=free>s</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>,</span> 2<span class=main>)</span> FDOM_eff_subset_FDOM_valid_states_pair
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>x</span><span class=main>.</span> <span class=bound>x</span> <span class=main>∈</span> fmdom' <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span> <span class=main>⟶</span> fmlookup <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span> <span class=bound>x</span> <span class=main>=</span> fmlookup <span class=free>s</span> <span class=bound>x</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>4<span class=main>)</span> calculation<span class=main>(</span>1<span class=main>)</span> agree_def subsetCE
      <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>s</span> <span class=keyword1>++<span class=hidden>⇩</span><sub>f</sub></span> snd <span class=free>a</span> <span class=main>=</span> <span class=free>s</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> calculation<span class=main>(</span>2<span class=main>)</span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> fmap_ext fmdom'_notD fmdom_notI fmlookup_add<span class=main>)</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>using</span></span> fmap_add_ltr_def state_succ_def
    <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1 id=SystemAbstraction-agree_state_succ_idempot><span class=command>lemma</span></span> agree_state_succ_idempot<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>a</span> <span class=main>∈</span> <span class=free>PROB</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>s</span> <span class=main>∈</span> valid_states <span class=free>PROB</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>agree <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span> <span class=free>s</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>state_succ <span class=free>s</span> <span class=free>a</span> <span class=main>=</span> <span class=free>s</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"fst <span class=free>a</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s</span>"</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> True
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>using</span></span> assms state_succ_fixpoint_if
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> False
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>unfolding</span></span> state_succ_def fmap_add_ltr_def
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=comment1>― ‹NOTE added lemma.›</span>
<span class=comment1>― ‹TODO refactor into `Fmap\_Utils`.›</span>
<span class=keyword1 id="SystemAbstraction-fmdom'_fmrestrict_set"><span class=command>lemma</span></span> fmdom'_fmrestrict_set<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>X</span> <span class=free>f</span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>fmrestrict_set <span class=free>X</span> <span class=free>f</span><span class=main>)</span> <span class=main>=</span> <span class=free>X</span> <span class=main>∩</span> <span class=main>(</span>fmdom' <span class=free>f</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> fmdom'_alt_def fmfilter_alt_defs<span class=main>(</span>4<span class=main>)</span>
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=comment1>― ‹NOTE added lemma.›</span>
<span class=comment1>― ‹TODO refactor into 'Fmap\_Utils'.›</span>
<span class=keyword1 id="SystemAbstraction-fmdom'_fmrestrict_set_fmadd"><span class=command>lemma</span></span> fmdom'_fmrestrict_set_fmadd<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>X</span> <span class=free>f</span> <span class=free>g</span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>fmrestrict_set <span class=free>X</span> <span class=main>(</span><span class=free>f</span> <span class=keyword1>++<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>g</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=free>X</span> <span class=main>∩</span> <span class=main>(</span>fmdom' <span class=free>f</span> <span class=main>∪</span> fmdom' <span class=free>g</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmrestrict_set <span class=free>X</span> <span class=main>(</span><span class=free>f</span> <span class=keyword1>++<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>g</span><span class=main>)</span> <span class=main>=</span> fmrestrict_set <span class=free>X</span> <span class=free>f</span> <span class=keyword1>++<span class=hidden>⇩</span><sub>f</sub></span> fmrestrict_set <span class=free>X</span> <span class=free>g</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> fmrestrict_set_add_distrib
    <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>using</span></span> fmdom'_fmrestrict_set fmdom'_add
    <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=comment1>― ‹NOTE added lemma.›</span>
<span class=comment1>― ‹TODO refactor into 'Fmap\_Utils'.›</span>
<span class=keyword1 id=SystemAbstraction-fmrestrict_agree><span class=command>lemma</span></span> fmrestrict_agree<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>X</span> <span class=free>x</span> <span class=free>f</span> <span class=free>g</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"agree <span class=main>(</span>fmrestrict_set <span class=free>X</span> <span class=free>f</span><span class=main>)</span> <span class=main>(</span>fmrestrict_set <span class=free>X</span> <span class=free>g</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>x</span> <span class=main>∈</span> <span class=free>X</span> <span class=main>∩</span> fmdom' <span class=free>f</span> <span class=main>∩</span> fmdom' <span class=free>g</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=main>(</span>fmrestrict_set <span class=free>X</span> <span class=free>f</span><span class=main>)</span> <span class=free>x</span> <span class=main>=</span> fmlookup <span class=main>(</span>fmrestrict_set <span class=free>X</span> <span class=free>g</span><span class=main>)</span> <span class=free>x</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>v</span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span> <span class=free>X</span> <span class=main>∩</span> fmdom' <span class=free>f</span> <span class=main>∩</span> fmdom' <span class=free>g</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span> fmdom' <span class=main>(</span>fmrestrict_set <span class=free>X</span> <span class=free>f</span><span class=main>)</span> <span class=main>∧</span> <span class=skolem>v</span> <span class=main>∈</span> fmdom' <span class=main>(</span>fmrestrict_set <span class=free>X</span> <span class=free>g</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> fmdom'_fmrestrict_set
      <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=main>(</span>fmrestrict_set <span class=free>X</span> <span class=free>f</span><span class=main>)</span> <span class=skolem>v</span> <span class=main>=</span> fmlookup <span class=main>(</span>fmrestrict_set <span class=free>X</span> <span class=free>g</span><span class=main>)</span> <span class=skolem>v</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>)</span>
      <span class=keyword1><span class=command>unfolding</span></span> agree_def
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>using</span></span> assms
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=SystemAbstraction-agree_restrict_state_succ_idempot><span class=command>lemma</span></span> agree_restrict_state_succ_idempot<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>a</span> <span class=main>∈</span> <span class=free>PROB</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>s</span> <span class=main>∈</span> valid_states <span class=free>PROB</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span>agree <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=main>(</span>state_succ <span class=free>s</span> <span class=free>a</span><span class=main>)</span> <span class=main>=</span> fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"fst <span class=free>a</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s</span>"</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> True
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"state_succ <span class=free>s</span> <span class=free>a</span> <span class=main>=</span> <span class=free>s</span> <span class=keyword1>++<span class=hidden>⇩</span><sub>f</sub></span> snd <span class=free>a</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> state_succ_def fmap_add_ltr_def
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>v</span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=main>(</span><span class=free>s</span> <span class=keyword1>++<span class=hidden>⇩</span><sub>f</sub></span> snd <span class=free>a</span><span class=main>)</span><span class=main>)</span> <span class=skolem>v</span> <span class=main>=</span> fmlookup <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span> <span class=skolem>v</span>"</span></span>
    <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span> fmdom' <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span>"</span></span><span class=main>)</span>
      <span class=keyword3><span class=command>case</span></span> True
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=main>(</span><span class=free>s</span> <span class=keyword1>++<span class=hidden>⇩</span><sub>f</sub></span> snd <span class=free>a</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=free>vs</span> <span class=main>∩</span> <span class=main>(</span>fmdom' <span class=free>s</span> <span class=main>∪</span> fmdom' <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>unfolding</span></span> fmap_add_ltr_def
        <span class=keyword1><span class=command>using</span></span> fmdom'_fmrestrict_set_fmadd
        <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> 2<span class=main>:</span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=free>vs</span> <span class=main>∩</span> fmdom' <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> fmdom'_fmrestrict_set
        <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
        <span class=keyword1><span class=command>using</span></span> 1 2
      <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span> <span class=free>vs</span>"</span></span><span class=main>)</span>
        <span class=keyword3><span class=command>case</span></span> true<span class=main>:</span> True
        <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
        <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span> <span class=main>(</span>fmdom' <span class=free>s</span> <span class=main>∩</span> fmdom' <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span><span class=main>)</span>"</span></span><span class=main>)</span>
          <span class=keyword3><span class=command>case</span></span> True
          <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span> <span class=free>vs</span> <span class=main>∩</span> fmdom' <span class=free>s</span> <span class=main>∩</span> fmdom' <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span>"</span></span>
            <span class=keyword1><span class=command>using</span></span> true
            <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
          <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span><span class=main>)</span> <span class=skolem>v</span> <span class=main>=</span> fmlookup <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span> <span class=skolem>v</span>"</span></span>
            <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>3<span class=main>)</span> fmrestrict_agree
            <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
          <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
            <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
        <span class=keyword1><span class=command>next</span></span>
          <span class=keyword3><span class=command>case</span></span> False
          <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span> <span class=main>⊆</span> fmdom' <span class=free>s</span>"</span></span>
            <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>,</span> 2<span class=main>)</span> FDOM_eff_subset_FDOM_valid_states_pair
            <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
          <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∉</span> fmdom' <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span>"</span></span>
            <span class=keyword1><span class=command>using</span></span> true False
            <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
          <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
            <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
        <span class=keyword1><span class=command>qed</span></span>
      <span class=keyword1><span class=command>qed</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>qed</span></span> <span class=operator>fastforce</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>unfolding</span></span> state_succ_def fmap_add_ltr_def
    <span class=keyword1><span class=command>using</span></span> fmap_ext
    <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> False
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>unfolding</span></span> state_succ_def
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1 id=SystemAbstraction-agree_exec_idempot><span class=command>lemma</span></span> agree_exec_idempot<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>s</span> <span class=main>∈</span> valid_states <span class=free>PROB</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>a</span><span class=main>.</span> ListMem <span class=bound>a</span> <span class=free>as</span> <span class=main>⟶</span> agree <span class=main>(</span>snd <span class=bound>a</span><span class=main>)</span> <span class=free>s</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>exec_plan <span class=free>s</span> <span class=free>as</span> <span class=main>=</span> <span class=free>s</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>as</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>PROB</span></span> <span class=quoted><span class=free>s</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>a</span> <span class=skolem>as</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>a</span> <span class=main>∈</span> <span class=skolem>PROB</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>1<span class=main>)</span> valid_plan_valid_head
    <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> 2<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>as</span> <span class=main>∈</span> valid_plans <span class=skolem>PROB</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>1<span class=main>)</span> valid_plan_valid_tail
    <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> 3<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>a</span><span class=main>.</span> ListMem <span class=bound>a</span> <span class=skolem>as</span> <span class=main>⟶</span> agree <span class=main>(</span>snd <span class=bound>a</span><span class=main>)</span> <span class=skolem>s</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>3<span class=main>)</span> ListMem.simps
    <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"ListMem <span class=skolem>a</span> <span class=main>(</span><span class=skolem>a</span> <span class=main>#</span> <span class=skolem>as</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> elem
    <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"agree <span class=main>(</span>snd <span class=skolem>a</span><span class=main>)</span> <span class=skolem>s</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>3<span class=main>)</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> 4<span class=main>:</span> <span class=quoted><span class=quoted>"state_succ <span class=skolem>s</span> <span class=skolem>a</span> <span class=main>=</span> <span class=skolem>s</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>1<span class=main>,</span> 2<span class=main>)</span> 1 agree_state_succ_idempot
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"exec_plan <span class=skolem>s</span> <span class=skolem>as</span> <span class=main>=</span> <span class=skolem>s</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Cons.IH Cons.prems<span class=main>(</span>2<span class=main>)</span> 2 3
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>using</span></span> 4
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span> <span class=operator>simp</span>


<span class=keyword1 id=SystemAbstraction-agree_restrict_exec_idempot><span class=command>lemma</span></span> agree_restrict_exec_idempot<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>s</span> <span class=free>s'</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>s'</span> <span class=main>∈</span> valid_states <span class=free>PROB</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>s</span> <span class=main>∈</span> valid_states <span class=free>PROB</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>a</span><span class=main>.</span> ListMem <span class=bound>a</span> <span class=free>as</span> <span class=main>⟶</span> agree <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=main>(</span>snd <span class=bound>a</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s'</span> <span class=main>=</span> fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>  <span class=quoted><span class=quoted>"<span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=main>(</span>exec_plan <span class=free>s'</span> <span class=free>as</span><span class=main>)</span> <span class=main>=</span> fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>as</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>PROB</span></span> <span class=quoted><span class=free>s</span></span> <span class=quoted><span class=free>s'</span></span> <span class=quoted><span class=free>vs</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>a</span> <span class=skolem>as</span><span class=main>)</span>
  <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>as</span> <span class=main>∈</span> valid_plans <span class=skolem>PROB</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>1<span class=main>)</span> valid_plan_valid_tail
    <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> 2<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>a</span><span class=main>.</span> ListMem <span class=bound>a</span> <span class=skolem>as</span> <span class=main>⟶</span> agree <span class=main>(</span>fmrestrict_set <span class=skolem>vs</span> <span class=main>(</span>snd <span class=bound>a</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>fmrestrict_set <span class=skolem>vs</span> <span class=skolem>s</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>4<span class=main>)</span> ListMem.simps
    <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> 3<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>a</span> <span class=main>∈</span> <span class=skolem>PROB</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>1<span class=main>)</span> valid_plan_valid_head
    <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
  <span class=keyword1><span class=command>moreover</span></span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"ListMem <span class=skolem>a</span> <span class=main>(</span><span class=skolem>a</span> <span class=main>#</span> <span class=skolem>as</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> elem
      <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"agree <span class=main>(</span>fmrestrict_set <span class=skolem>vs</span> <span class=main>(</span>snd <span class=skolem>a</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>fmrestrict_set <span class=skolem>vs</span> <span class=skolem>s</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>4<span class=main>)</span> calculation<span class=main>(</span>1<span class=main>)</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>then</span></span>  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"agree <span class=main>(</span>fmrestrict_set <span class=skolem>vs</span> <span class=main>(</span>snd <span class=skolem>a</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>fmrestrict_set <span class=skolem>vs</span> <span class=skolem>s'</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>5<span class=main>)</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"fst <span class=skolem>a</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=skolem>s'</span>"</span></span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> True
    <span class=keyword1><span class=command>{</span></span>
      <span class=keyword1><span class=command>have</span></span> a<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>s'</span> <span class=main>∈</span> valid_states <span class=skolem>PROB</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>2<span class=main>)</span>
        <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
      <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"state_succ <span class=skolem>s'</span> <span class=skolem>a</span> <span class=main>∈</span> valid_states <span class=skolem>PROB</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> 3 a lemma_1_i
        <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span>
        <span class=quoted><span class=quoted>" <span class=main>∀</span><span class=bound>a</span><span class=main>.</span> ListMem <span class=bound>a</span> <span class=skolem>as</span> <span class=main>⟶</span> agree <span class=main>(</span>fmrestrict_set <span class=skolem>vs</span> <span class=main>(</span>snd <span class=bound>a</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>fmrestrict_set <span class=skolem>vs</span> <span class=skolem>s</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> 2
        <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>{</span></span>
        <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"ListMem <span class=skolem>a</span> <span class=main>(</span><span class=skolem>a</span> <span class=main>#</span> <span class=skolem>as</span><span class=main>)</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> elem
          <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"agree <span class=main>(</span>fmrestrict_set <span class=skolem>vs</span> <span class=main>(</span>snd <span class=skolem>a</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>fmrestrict_set <span class=skolem>vs</span> <span class=skolem>s</span><span class=main>)</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>4<span class=main>)</span> calculation<span class=main>(</span>1<span class=main>)</span>
          <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmrestrict_set <span class=skolem>vs</span> <span class=main>(</span>state_succ <span class=skolem>s'</span> <span class=skolem>a</span><span class=main>)</span> <span class=main>=</span> fmrestrict_set <span class=skolem>vs</span> <span class=skolem>s</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>5<span class=main>)</span> 3 a agree_restrict_state_succ_idempot
          <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
      <span class=keyword1><span class=command>}</span></span>
      <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmrestrict_set <span class=skolem>vs</span> <span class=main>(</span>exec_plan <span class=main>(</span>state_succ <span class=skolem>s'</span> <span class=skolem>a</span><span class=main>)</span> <span class=skolem>as</span><span class=main>)</span> <span class=main>=</span> fmrestrict_set <span class=skolem>vs</span> <span class=skolem>s</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>3<span class=main>)</span> 1 Cons.IH<span class=main>[</span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> s'<span class=main><span class=main>=</span></span><span class=quoted><span class=quoted>"state_succ <span class=skolem>s'</span> <span class=skolem>a</span>"</span></span><span class=main>]</span>
        <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>}</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>next</span></span> <span class=keyword3><span class=command>case</span></span> False
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"exec_plan <span class=skolem>s'</span> <span class=main>(</span><span class=skolem>a</span> <span class=main>#</span> <span class=skolem>as</span><span class=main>)</span> <span class=main>=</span> exec_plan <span class=skolem>s'</span> <span class=skolem>as</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> False
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> state_succ_def<span class=main>)</span>
    <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>using</span></span> Cons.IH Cons.prems<span class=main>(</span>2<span class=main>,</span> 3<span class=main>,</span> 5<span class=main>)</span> 1 2
      <span class=keyword1><span class=command>by</span></span> <span class=operator>presburger</span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>qed</span></span> <span class=operator>simp</span>


<span class=keyword1 id=SystemAbstraction-agree_restrict_exec_idempot_pair><span class=command>lemma</span></span> agree_restrict_exec_idempot_pair<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>s</span> <span class=free>s'</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>s'</span> <span class=main>∈</span> valid_states <span class=free>PROB</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>s</span> <span class=main>∈</span> valid_states <span class=free>PROB</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>p</span> <span class=bound>e</span><span class=main>.</span> ListMem <span class=main>(</span><span class=bound>p</span><span class=main>,</span> <span class=bound>e</span><span class=main>)</span> <span class=free>as</span> <span class=main>⟶</span> agree <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=bound>e</span><span class=main>)</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s'</span> <span class=main>=</span> fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=main>(</span>exec_plan <span class=free>s'</span> <span class=free>as</span><span class=main>)</span> <span class=main>=</span> fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms agree_restrict_exec_idempot
  <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>


<span class=keyword1 id=SystemAbstraction-agree_comm><span class=command>lemma</span></span> agree_comm<span class=main>:</span> <span class=quoted><span class=quoted>"agree <span class=free>x</span> <span class=free>x'</span> <span class=main>=</span> agree <span class=free>x'</span> <span class=free>x</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> agree_def
  <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>


<span class=keyword1 id=SystemAbstraction-restricted_agree_imp_agree><span class=command>lemma</span></span> restricted_agree_imp_agree<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>fmdom' <span class=free>s2</span> <span class=main>⊆</span> <span class=free>vs</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>agree <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s1</span><span class=main>)</span> <span class=free>s2</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>agree <span class=free>s1</span> <span class=free>s2</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms contra_subsetD fmlookup_restrict_set Int_iff fmdom'_fmrestrict_set
  <span class=keyword1><span class=command>unfolding</span></span> agree_def
  <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>


<span class=keyword1 id=SystemAbstraction-agree_imp_submap><span class=command>lemma</span></span> agree_imp_submap<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>f1</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>f2</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"agree <span class=free>f1</span> <span class=free>f2</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>unfolding</span></span> agree_def
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> as_needed_asses_submap_exec_ii<span class=main>)</span>


<span class=keyword1 id=SystemAbstraction-agree_FUNION><span class=command>lemma</span></span> agree_FUNION<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>agree <span class=free>fm</span> <span class=free>fm1</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>agree <span class=free>fm</span> <span class=free>fm2</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>agree <span class=free>fm</span> <span class=main>(</span><span class=free>fm1</span> <span class=main>++</span> <span class=free>fm2</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> agree_def fmap_add_ltr_def
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> agree_def fmlookup_add fmlookup_dom'_iff<span class=main>)</span>


<span class=keyword1 id=SystemAbstraction-agree_fm_list_union><span class=command>lemma</span></span> agree_fm_list_union<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>fm</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>fm'</span><span class=main>.</span> ListMem <span class=bound>fm'</span> <span class=free>fmList</span> <span class=main>⟶</span> agree <span class=free>fm</span> <span class=bound>fm'</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>agree <span class=free>fm</span> <span class=main>(</span>foldr fmap_add_ltr <span class=free>fmList</span> fmempty<span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=quoted>"<span class=free>fmList</span>"</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>fm</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> Nil
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"foldr fmap_add_ltr <span class=main>[]</span> fmempty <span class=main>=</span> fmempty"</span></span>
    <span class=keyword1><span class=command>using</span></span> Nil
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>unfolding</span></span> agree_def
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>a</span> <span class=skolem>fmList</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>fm'</span><span class=main>.</span> ListMem <span class=bound>fm'</span> <span class=skolem>fmList</span> <span class=main>⟶</span> agree <span class=skolem>fm</span> <span class=bound>fm'</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Cons.prems insert
    <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"agree <span class=skolem>fm</span> <span class=main>(</span>foldr fmap_add_ltr <span class=skolem>fmList</span> fmempty<span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Cons.IH
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"agree <span class=skolem>fm</span> <span class=skolem>a</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Cons.prems elem
    <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"agree <span class=skolem>fm</span> <span class=main>(</span><span class=skolem>a</span> <span class=main>++</span> foldr fmap_add_ltr <span class=skolem>fmList</span> fmempty<span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> 1 agree_FUNION
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1 id=SystemAbstraction-DRESTRICT_EQ_AGREE><span class=command>lemma</span></span> DRESTRICT_EQ_AGREE<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>fmdom' <span class=free>s2</span> <span class=main>⊆</span> <span class=free>vs2</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>fmdom' <span class=free>s1</span> <span class=main>⊆</span> <span class=free>vs1</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>(</span>fmrestrict_set <span class=free>vs2</span> <span class=free>s1</span> <span class=main>=</span> fmrestrict_set <span class=free>vs1</span> <span class=free>s2</span><span class=main>)</span> <span class=main>⟶</span> agree <span class=free>s1</span> <span class=free>s2</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms fmdom'_restrict_set restricted_agree_imp_agree
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> agree_def<span class=main>)</span>


<span class=keyword1 id=SystemAbstraction-SUBMAPS_AGREE><span class=command>lemma</span></span>  SUBMAPS_AGREE<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>s1</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=free>s2</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s</span><span class=main>)</span> <span class=main>⟹</span> <span class=main>(</span>agree <span class=free>s1</span> <span class=free>s2</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> agree_def
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> as_needed_asses_submap_exec_ii<span class=main>)</span>


<span class=comment1>― ‹NOTE name shortened.›</span>
<span class=keyword1><span class=command>definition</span></span> <span class=entity>snapshot</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>snapshot</span> <span class=free><span class=bound><span class=entity>PROB</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=main>=</span> <span class=main>{</span><span class=bound>a</span> <span class=main>|</span> <span class=bound>a</span><span class=main>.</span> <span class=bound>a</span> <span class=main>∈</span> <span class=free><span class=bound><span class=entity>PROB</span></span></span> <span class=main>∧</span> agree <span class=main>(</span>fst <span class=bound>a</span><span class=main>)</span> <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=main>∧</span> agree <span class=main>(</span>snd <span class=bound>a</span><span class=main>)</span> <span class=free><span class=bound><span class=entity>s</span></span></span><span class=main>}</span>"</span></span>


<span class=keyword1 id=SystemAbstraction-snapshot_pair><span class=command>lemma</span></span> snapshot_pair<span class=main>:</span> <span class=quoted><span class=quoted>"snapshot <span class=free>PROB</span> <span class=free>s</span> <span class=main>=</span> <span class=main>{</span><span class=main>(</span><span class=bound>p</span><span class=main>,</span> <span class=bound>e</span><span class=main>)</span><span class=main>.</span> <span class=main>(</span><span class=bound>p</span><span class=main>,</span> <span class=bound>e</span><span class=main>)</span> <span class=main>∈</span> <span class=free>PROB</span> <span class=main>∧</span> agree <span class=bound>p</span> <span class=free>s</span> <span class=main>∧</span> agree <span class=bound>e</span> <span class=free>s</span><span class=main>}</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> snapshot_def
  <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>

<span class=keyword1 id=SystemAbstraction-action_agree_valid_in_snapshot><span class=command>lemma</span></span> action_agree_valid_in_snapshot<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>a</span> <span class=main>∈</span> <span class=free>PROB</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>agree <span class=main>(</span>fst <span class=free>a</span><span class=main>)</span> <span class=free>s</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>agree <span class=main>(</span>snd <span class=free>a</span><span class=main>)</span> <span class=free>s</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>a</span> <span class=main>∈</span> snapshot <span class=free>PROB</span> <span class=free>s</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> snapshot_def
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>

<span class=keyword1 id=SystemAbstraction-as_mem_agree_valid_in_snapshot><span class=command>lemma</span></span> as_mem_agree_valid_in_snapshot<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>a</span><span class=main>.</span> ListMem <span class=bound>a</span> <span class=free>as</span> <span class=main>⟶</span> agree <span class=main>(</span>fst <span class=bound>a</span><span class=main>)</span> <span class=free>s</span> <span class=main>∧</span> agree <span class=main>(</span>snd <span class=bound>a</span><span class=main>)</span> <span class=free>s</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>as</span> <span class=main>∈</span> valid_plans <span class=main>(</span>snapshot <span class=free>PROB</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>as</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> Nil
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>using</span></span> empty_plan_is_valid
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>a</span> <span class=skolem>as</span><span class=main>)</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>a</span><span class=main>.</span> ListMem <span class=bound>a</span> <span class=skolem>as</span> <span class=main>⟶</span> agree <span class=main>(</span>fst <span class=bound>a</span><span class=main>)</span> <span class=free>s</span> <span class=main>∧</span> agree <span class=main>(</span>snd <span class=bound>a</span><span class=main>)</span> <span class=free>s</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>1<span class=main>)</span> insert
      <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>2<span class=main>)</span> valid_plan_valid_tail
      <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
    <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"set <span class=skolem>as</span> <span class=main>⊆</span> snapshot <span class=free>PROB</span> <span class=free>s</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> Cons.IH valid_plans_def
      <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>note</span></span> 1 <span class=main>=</span> this
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword1><span class=command>have</span></span> a<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>a</span> <span class=main>∈</span> <span class=free>PROB</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>2<span class=main>)</span> valid_plan_valid_head
      <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"ListMem <span class=skolem>a</span> <span class=main>(</span><span class=skolem>a</span> <span class=main>#</span> <span class=skolem>as</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> elem
      <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"agree <span class=main>(</span>fst <span class=skolem>a</span><span class=main>)</span> <span class=free>s</span> <span class=main>∧</span> agree <span class=main>(</span>snd <span class=skolem>a</span><span class=main>)</span> <span class=free>s</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>1<span class=main>)</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a</span> <span class=main>∈</span> snapshot <span class=free>PROB</span> <span class=free>s</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> a snapshot_def
      <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"set <span class=main>(</span><span class=skolem>a</span> <span class=main>#</span> <span class=skolem>as</span><span class=main>)</span> <span class=main>⊆</span> snapshot <span class=free>PROB</span> <span class=free>s</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> 1 set_simps<span class=main>(</span>2<span class=main>)</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> <span class=keyword1><span class=command>using</span></span> valid_plans_def
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=SystemAbstraction-fmrestrict_agree_monotonous><span class=command>lemma</span></span> fmrestrict_agree_monotonous<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>f</span> <span class=free>g</span> <span class=free>X</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"agree <span class=free>f</span> <span class=free>g</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"agree <span class=main>(</span>fmrestrict_set <span class=free>X</span> <span class=free>f</span><span class=main>)</span> <span class=main>(</span>fmrestrict_set <span class=free>X</span> <span class=free>g</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?F</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>fmrestrict_set <span class=free>X</span> <span class=free>f</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?G</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>fmrestrict_set <span class=free>X</span> <span class=free>g</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=var>?F</span> <span class=main>=</span> <span class=free>X</span> <span class=main>∩</span> fmdom' <span class=free>f</span>"</span></span> <span class=quoted><span class=quoted>"<span class=var>?G</span> <span class=main>=</span> <span class=free>X</span> <span class=main>∩</span> fmdom' <span class=free>g</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> fmdom'_fmrestrict_set
    <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span><span class=main><span class=keyword3>+</span></span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>v</span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span> <span class=var>?F</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span> <span class=var>?G</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span> fmdom' <span class=free>f</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span> fmdom' <span class=free>g</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> 1
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span><span class=main><span class=keyword3>+</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=free>f</span> <span class=skolem>v</span> <span class=main>=</span> fmlookup <span class=free>g</span> <span class=skolem>v</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> assms
      <span class=keyword1><span class=command>unfolding</span></span> agree_def
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=main>(</span>fmrestrict_set <span class=free>X</span> <span class=free>f</span><span class=main>)</span> <span class=skolem>v</span> <span class=main>=</span> fmlookup <span class=main>(</span>fmrestrict_set <span class=free>X</span> <span class=free>g</span><span class=main>)</span> <span class=skolem>v</span>"</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> fmlookup_restrict_set
      <span class=keyword1><span class=command>by</span></span> <span class=operator>argo</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>using</span></span> assms
    <span class=keyword1><span class=command>unfolding</span></span> agree_def
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=comment1>― ‹TODO remove if not used.›</span>
<span class=keyword1 id=SystemAbstraction-SUBMAP_FUNION_DRESTRICT_i><span class=command>lemma</span></span> SUBMAP_FUNION_DRESTRICT_i<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>v</span> <span class=free>vsa</span> <span class=free>vsb</span> <span class=free>f</span> <span class=free>g</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=free>v</span> <span class=main>∈</span> <span class=free>vsa</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"
    fmlookup <span class=main>(</span>fmrestrict_set <span class=main>(</span><span class=main>(</span><span class=free>vsa</span> <span class=main>∪</span> <span class=free>vsb</span><span class=main>)</span> <span class=main>∩</span> <span class=free>vs</span><span class=main>)</span> <span class=free>f</span><span class=main>)</span> <span class=free>v</span>
    <span class=main>=</span> fmlookup <span class=main>(</span>fmrestrict_set <span class=main>(</span><span class=free>vsa</span> <span class=main>∩</span> <span class=free>vs</span><span class=main>)</span> <span class=free>f</span><span class=main>)</span> <span class=free>v</span>
  "</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> fmlookup_restrict_set
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>


<span class=keyword1 id="SystemAbstraction-SUBMAP_FUNION_DRESTRICT'"><span class=command>lemma</span></span> SUBMAP_FUNION_DRESTRICT'<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>agree <span class=free>fma</span> <span class=free>fmb</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>vsa</span> <span class=main>⊆</span> fmdom' <span class=free>fma</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>vsb</span> <span class=main>⊆</span> fmdom' <span class=free>fmb</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span>fmrestrict_set <span class=free>vsa</span> <span class=free>fm</span>  <span class=main>=</span> fmrestrict_set <span class=main>(</span><span class=free>vsa</span> <span class=main>∩</span> <span class=free>vs</span><span class=main>)</span> <span class=free>fma</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span>fmrestrict_set <span class=free>vsb</span> <span class=free>fm</span> <span class=main>=</span> fmrestrict_set <span class=main>(</span><span class=free>vsb</span> <span class=main>∩</span> <span class=free>vs</span><span class=main>)</span> <span class=free>fmb</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>fmrestrict_set <span class=main>(</span><span class=free>vsa</span> <span class=main>∪</span> <span class=free>vsb</span><span class=main>)</span> <span class=free>fm</span> <span class=main>=</span> fmrestrict_set <span class=main>(</span><span class=main>(</span><span class=free>vsa</span> <span class=main>∪</span> <span class=free>vsb</span><span class=main>)</span> <span class=main>∩</span> <span class=free>vs</span><span class=main>)</span> <span class=main>(</span><span class=free>fma</span> <span class=main>++</span> <span class=free>fmb</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?f</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"fmrestrict_set <span class=main>(</span><span class=free>vsa</span> <span class=main>∪</span> <span class=free>vsb</span><span class=main>)</span> <span class=free>fm</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?g</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"fmrestrict_set <span class=main>(</span><span class=main>(</span><span class=free>vsa</span> <span class=main>∪</span> <span class=free>vsb</span><span class=main>)</span> <span class=main>∩</span> <span class=free>vs</span><span class=main>)</span> <span class=main>(</span><span class=free>fma</span> <span class=main>++</span> <span class=free>fmb</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=var>?g</span> <span class=main>=</span> fmrestrict_set <span class=main>(</span><span class=main>(</span><span class=free>vsa</span> <span class=main>∪</span> <span class=free>vsb</span><span class=main>)</span> <span class=main>∩</span> <span class=free>vs</span><span class=main>)</span> <span class=free>fmb</span> <span class=keyword1>++<span class=hidden>⇩</span><sub>f</sub></span> fmrestrict_set <span class=main>(</span><span class=main>(</span><span class=free>vsa</span> <span class=main>∪</span> <span class=free>vsb</span><span class=main>)</span> <span class=main>∩</span> <span class=free>vs</span><span class=main>)</span> <span class=free>fma</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> fmap_add_ltr_def fmrestrict_set_add_distrib
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>have</span></span> 2<span class=main>:</span> <span class=quoted><span class=quoted>"agree <span class=main>(</span>fmrestrict_set <span class=main>(</span><span class=main>(</span><span class=free>vsa</span> <span class=main>∪</span> <span class=free>vsb</span><span class=main>)</span> <span class=main>∩</span> <span class=free>vs</span><span class=main>)</span> <span class=free>fma</span><span class=main>)</span> <span class=main>(</span>fmrestrict_set <span class=main>(</span><span class=main>(</span><span class=free>vsa</span> <span class=main>∪</span> <span class=free>vsb</span><span class=main>)</span> <span class=main>∩</span> <span class=free>vs</span><span class=main>)</span> <span class=free>fmb</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>)</span> fmrestrict_agree_monotonous
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>have</span></span> 3<span class=main>:</span>
    <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>fmrestrict_set <span class=main>(</span><span class=main>(</span><span class=free>vsa</span> <span class=main>∪</span> <span class=free>vsb</span><span class=main>)</span> <span class=main>∩</span> <span class=free>vs</span><span class=main>)</span> <span class=free>fma</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=main>(</span><span class=free>vsa</span> <span class=main>∪</span> <span class=free>vsb</span><span class=main>)</span> <span class=main>∩</span> <span class=free>vs</span><span class=main>)</span> <span class=main>∩</span> fmdom' <span class=free>fma</span>"</span></span>
    <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>fmrestrict_set <span class=main>(</span><span class=main>(</span><span class=free>vsa</span> <span class=main>∪</span> <span class=free>vsb</span><span class=main>)</span> <span class=main>∩</span> <span class=free>vs</span><span class=main>)</span> <span class=free>fmb</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=main>(</span><span class=free>vsa</span> <span class=main>∪</span> <span class=free>vsb</span><span class=main>)</span> <span class=main>∩</span> <span class=free>vs</span><span class=main>)</span> <span class=main>∩</span> fmdom' <span class=free>fmb</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> fmdom'_fmrestrict_set
    <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span><span class=main><span class=keyword3>+</span></span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>v</span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=var>?f</span> <span class=skolem>v</span> <span class=main>=</span> fmlookup <span class=var>?g</span> <span class=skolem>v</span>"</span></span>
    <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span> <span class=main>(</span><span class=main>(</span><span class=free>vsa</span> <span class=main>∪</span> <span class=free>vsb</span><span class=main>)</span> <span class=main>∩</span> <span class=free>vs</span><span class=main>)</span>"</span></span><span class=main>)</span>
      <span class=keyword3><span class=command>case</span></span> True
        <span class=comment1>― ‹TODO unwrap smt proof.›</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
        <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>,</span> 2<span class=main>,</span> 3<span class=main>,</span> 4<span class=main>,</span> 5<span class=main>)</span> 1
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>smt</span> IntD1 SUBMAP_FUNION_DRESTRICT_i UnE agree_def domIff fmdom'.rep_eq fmdom'_alt_def
            fmdom'_fmrestrict_set fmlookup_add fmlookup_restrict_set inf_sup_distrib2 notin_fset
            subset_iff sup_commute<span class=main>)</span>
    <span class=keyword1><span class=command>next</span></span>
      <span class=keyword3><span class=command>case</span></span> False
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
        <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∉</span> <span class=free>vsa</span> <span class=main>∪</span> <span class=free>vsb</span> <span class=main>∨</span> <span class=skolem>v</span> <span class=main>∉</span> <span class=free>vs</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> False
          <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=main>(</span>fmrestrict_set <span class=main>(</span><span class=free>vsa</span> <span class=main>∪</span> <span class=free>vsb</span><span class=main>)</span> <span class=free>fm</span><span class=main>)</span> <span class=skolem>v</span> <span class=main>=</span> None"</span></span>
          <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>4<span class=main>,</span> 5<span class=main>)</span>
          <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> Int_iff Un_iff fmlookup_restrict_set<span class=main>)</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
          <span class=keyword1><span class=command>using</span></span> False
          <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
      <span class=keyword1><span class=command>qed</span></span>
    <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>using</span></span> 1 fmap_ext
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=SystemAbstraction-UNION_FUNION_DRESTRICT_SUBMAP><span class=command>lemma</span></span> UNION_FUNION_DRESTRICT_SUBMAP<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>vs1</span> <span class=main>⊆</span> fmdom' <span class=free>fma</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>vs2</span> <span class=main>⊆</span> fmdom' <span class=free>fmb</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>agree <span class=free>fma</span> <span class=free>fmb</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span>fmrestrict_set <span class=free>vs1</span> <span class=free>fma</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>fmrestrict_set <span class=free>vs2</span> <span class=free>fmb</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>fmrestrict_set <span class=main>(</span><span class=free>vs1</span> <span class=main>∪</span> <span class=free>vs2</span><span class=main>)</span> <span class=main>(</span><span class=free>fma</span> <span class=main>++</span> <span class=free>fmb</span><span class=main>)</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?f</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"fmrestrict_set <span class=main>(</span><span class=free>vs1</span> <span class=main>∪</span> <span class=free>vs2</span><span class=main>)</span> <span class=main>(</span><span class=free>fma</span> <span class=main>++</span> <span class=free>fmb</span><span class=main>)</span>"</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>v</span>
    <span class=keyword3><span class=command>assume</span></span> P<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span> fmdom' <span class=var>?f</span>"</span></span>
    <span class=keyword1><span class=command>{</span></span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span> <span class=main>(</span><span class=free>vs1</span> <span class=main>∪</span> <span class=free>vs2</span><span class=main>)</span> <span class=main>∩</span> <span class=main>(</span>fmdom' <span class=free>fma</span> <span class=main>∪</span> fmdom' <span class=free>fmb</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> P
        <span class=keyword1><span class=command>unfolding</span></span> fmap_add_ltr_def fmdom'_fmrestrict_set fmdom'_add
        <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span> <span class=free>vs1</span> <span class=main>∪</span> <span class=free>vs2</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span> fmdom' <span class=free>fma</span> <span class=main>∪</span> fmdom' <span class=free>fmb</span>"</span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span><span class=main><span class=keyword3>+</span></span>
    <span class=keyword1><span class=command>}</span></span>
    <span class=keyword1><span class=command>note</span></span> 1 <span class=main>=</span> this
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> 2<span class=main>:</span> <span class=quoted><span class=quoted>"fmlookup <span class=var>?f</span> <span class=skolem>v</span> <span class=main>=</span> fmlookup <span class=main>(</span><span class=free>fmb</span> <span class=keyword1>++<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>fma</span><span class=main>)</span> <span class=skolem>v</span>"</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> fmlookup_restrict_set fmap_add_ltr_def
      <span class=keyword1><span class=command>by</span></span> <span class=operator>argo</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>consider</span></span>
      <span class=main>(</span>i<span class=main>)</span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span> <span class=free>vs1</span>"</span></span>
      <span class=main>|</span> <span class=main>(</span>ii<span class=main>)</span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span> <span class=free>vs2</span>"</span></span>
      <span class=main>|</span> <span class=main>(</span>iii<span class=main>)</span> <span class=quoted><span class=quoted>"<span class=main>¬</span><span class=skolem>v</span><span class=main>∈</span> <span class=free>vs1</span> <span class=main>∧</span> <span class=main>¬</span><span class=skolem>v</span><span class=main>∈</span><span class=free>vs2</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=var>?f</span> <span class=skolem>v</span> <span class=main>=</span> fmlookup <span class=free>s</span> <span class=skolem>v</span>"</span></span>
    <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span><span class=main>)</span>
      <span class=keyword3><span class=command>case</span></span> i
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>v</span> <span class=main>∈</span> fmdom' <span class=free>fma</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>)</span>
        <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=var>?f</span> <span class=skolem>v</span> <span class=main>=</span> fmlookup <span class=free>fma</span> <span class=skolem>v</span>"</span></span>
        <span class=keyword1><span class=command>unfolding</span></span> 2 fmlookup_add
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> fmdom'_alt_def notin_fset<span class=main>)</span>
      <span class=keyword1><span class=command>also</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>…</span> <span class=main>=</span> fmlookup <span class=main>(</span>fmrestrict_set <span class=free>vs1</span> <span class=free>fma</span><span class=main>)</span> <span class=skolem>v</span>"</span></span>
        <span class=keyword1><span class=command>unfolding</span></span> fmlookup_restrict_set
        <span class=keyword1><span class=command>using</span></span> i
        <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
      <span class=keyword1><span class=command>finally</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
        <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>4<span class=main>)</span>
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> <span class=main><span class=main>(</span></span>mono_tags<span class=main><span class=main>,</span></span> lifting<span class=main><span class=main>)</span></span> P domIff fmdom'_notI fmsubset.rep_eq map_le_def<span class=main>)</span>
    <span class=keyword1><span class=command>next</span></span>
      <span class=comment1>― ‹TODO unwrap smt proof.›</span>
      <span class=keyword3><span class=command>case</span></span> ii
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
        <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>2<span class=main>,</span> 3<span class=main>,</span> 5<span class=main>)</span> 2 P
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>smt</span> SUBMAP_FUNION_DRESTRICT_i agree_def
            fmdom'.rep_eq fmdom'_fmrestrict_set fmdom'_notD fmdom'_notI fmlookup_add
            fmrestrict_set_dom fmsubset.rep_eq inf.orderE map_le_def subset_Un_eq<span class=main>)</span>
    <span class=keyword1><span class=command>next</span></span>
      <span class=keyword3><span class=command>case</span></span> iii
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
        <span class=keyword1><span class=command>using</span></span> 1
        <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> as_needed_asses_submap_exec_vii<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=comment1>― ‹TODO unwrap sledgehammered metis proof.›</span>
<span class=comment1>(* TODO duplicate lemma? *)</span>
<span class=keyword1 id=SystemAbstraction-agree_DRESTRICT><span class=command>lemma</span></span> agree_DRESTRICT<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"agree <span class=free>s1</span> <span class=free>s2</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"agree <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s1</span><span class=main>)</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s2</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>fact</span> fmrestrict_agree_monotonous<span class=main>)</span>

<span class=keyword1 id=SystemAbstraction-agree_DRESTRICT_2><span class=command>lemma</span></span> agree_DRESTRICT_2<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>fmdom' <span class=free>s1</span> <span class=main>⊆</span> <span class=free>vs1</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>fmdom' <span class=free>s2</span> <span class=main>⊆</span> <span class=free>vs2</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>agree <span class=free>s1</span> <span class=free>s2</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>agree <span class=main>(</span>fmrestrict_set <span class=free>vs2</span> <span class=free>s1</span><span class=main>)</span> <span class=main>(</span>fmrestrict_set <span class=free>vs1</span> <span class=free>s2</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>unfolding</span></span> agree_def fmdom'_restrict_set_precise
  <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>

<span class=comment1>― ‹NOTE added lemma.›</span>
<span class=keyword1 id=SystemAbstraction-snapshot_eq_filter><span class=command>lemma</span></span> snapshot_eq_filter<span class=main>:</span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"snapshot <span class=free>PROB</span> <span class=free>s</span> <span class=main>=</span> Set.filter <span class=main>(</span><span class=main>λ</span><span class=bound>a</span><span class=main>.</span> agree <span class=main>(</span>fst <span class=bound>a</span><span class=main>)</span> <span class=free>s</span> <span class=main>∧</span> agree <span class=main>(</span>snd <span class=bound>a</span><span class=main>)</span> <span class=free>s</span><span class=main>)</span> <span class=free>PROB</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> snapshot_def Set.filter_def
  <span class=keyword1><span class=command>by</span></span> <span class=operator>presburger</span>

<span class=comment1>― ‹NOTE moved up.›</span>
<span class=keyword1><span class=command>corollary</span></span> snapshot_subset<span class=main>:</span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"snapshot <span class=free>PROB</span> <span class=free>s</span> <span class=main>⊆</span> <span class=free>PROB</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> snapshot_def
  <span class=keyword1><span class=command>using</span></span> snapshot_eq_filter
  <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>

<span class=keyword1 id=SystemAbstraction-FINITE_snapshot><span class=command>lemma</span></span> FINITE_snapshot<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"finite <span class=free>PROB</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"finite <span class=main>(</span>snapshot <span class=free>PROB</span> <span class=free>s</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"snapshot <span class=free>PROB</span> <span class=free>s</span> <span class=main>⊆</span> <span class=free>PROB</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> snapshot_subset
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>using</span></span> assms finite_subset<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"snapshot <span class=free>PROB</span> <span class=free>s</span>"</span></span> <span class=quoted><span class=free>PROB</span></span><span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=comment1>― ‹NOTE moved up (declared above the previous lemma).
lemma snapshot\_subset›</span>

<span class=comment1>― ‹TODO unwrap metis proof.›</span>
<span class=keyword1 id=SystemAbstraction-dom_proj_snapshot><span class=command>lemma</span></span> dom_proj_snapshot<span class=main>:</span>
  <span class=quoted><span class=quoted>"prob_dom <span class=main>(</span>prob_proj <span class=free>PROB</span> <span class=main>(</span>prob_dom <span class=main>(</span>snapshot <span class=free>PROB</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> prob_dom <span class=main>(</span>snapshot <span class=free>PROB</span> <span class=free>s</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> snapshot_subset two_children_parent_mems_le_finite prob_subset_dom_subset<span class=main>)</span>

<span class=keyword1 id=SystemAbstraction-valid_states_snapshot><span class=command>lemma</span></span> valid_states_snapshot<span class=main>:</span>
  <span class=quoted><span class=quoted>"valid_states <span class=main>(</span>prob_proj <span class=free>PROB</span> <span class=main>(</span>prob_dom <span class=main>(</span>snapshot <span class=free>PROB</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> valid_states <span class=main>(</span>snapshot <span class=free>PROB</span> <span class=free>s</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> dom_proj_snapshot valid_states_def<span class=main>)</span>

<span class=keyword1 id=SystemAbstraction-valid_proj_neq_succ_restricted_neq_succ><span class=command>lemma</span></span> valid_proj_neq_succ_restricted_neq_succ<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>x'</span> <span class=main>∈</span> prob_proj <span class=free>PROB</span> <span class=free>vs</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>state_succ <span class=free>s</span> <span class=free>x'</span> <span class=main>≠</span> <span class=free>s</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=main>(</span>state_succ <span class=free>s</span> <span class=free>x'</span><span class=main>)</span> <span class=main>≠</span> fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> state_succ_def
  <span class=keyword1><span class=command>using</span></span> FDOM_eff_subset_prob_dom_pair dom_prob_proj limited_dom_neq_restricted_neq
  <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>,</span> 2<span class=main>)</span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>smt</span> dual_order.trans state_succ_def<span class=main>)</span>

<span class=keyword1 id=SystemAbstraction-proj_successors><span class=command>lemma</span></span> proj_successors<span class=main>:</span> <span class=quoted><span class=quoted>"
  <span class=main>(</span><span class=main>(</span><span class=main>λ</span><span class=bound>s</span><span class=main>.</span> fmrestrict_set <span class=free>vs</span> <span class=bound>s</span><span class=main>)</span> <span class=main>`</span> <span class=main>(</span>state_successors <span class=main>(</span>prob_proj <span class=free>PROB</span> <span class=free>vs</span><span class=main>)</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span>
   <span class=main>⊆</span> <span class=main>(</span>state_successors <span class=main>(</span>prob_proj <span class=free>PROB</span> <span class=free>vs</span><span class=main>)</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span>
"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?A</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>(</span><span class=main>λ</span><span class=bound>s</span><span class=main>.</span> fmrestrict_set <span class=free>vs</span> <span class=bound>s</span><span class=main>)</span> <span class=main>`</span> <span class=main>(</span>state_successors <span class=main>(</span>prob_proj <span class=free>PROB</span> <span class=free>vs</span><span class=main>)</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?B</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>(</span>state_successors <span class=main>(</span>prob_proj <span class=free>PROB</span> <span class=free>vs</span><span class=main>)</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>x</span>
    <span class=keyword3><span class=command>assume</span></span> P<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> <span class=var>?A</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>x'</span></span> <span class=skolem><span class=skolem>x''</span></span> <span class=keyword2><span class=keyword>where</span></span> a<span class=main>:</span>
      <span class=quoted><span class=quoted>"<span class=skolem>x''</span> <span class=main>∈</span> prob_proj <span class=free>PROB</span> <span class=free>vs</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x'</span> <span class=main>=</span> state_succ <span class=free>s</span> <span class=skolem>x''</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x'</span> <span class=main>≠</span> <span class=free>s</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>=</span> fmrestrict_set <span class=free>vs</span> <span class=skolem>x'</span>"</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> state_successors_def subset_iff
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>{</span></span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>x''</span><span class=main>.</span>
        <span class=bound>x''</span> <span class=main>∈</span> prob_proj <span class=free>PROB</span> <span class=free>vs</span> <span class=main>∧</span> <span class=skolem>x</span> <span class=main>=</span> state_succ <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span> <span class=bound>x''</span>
        <span class=main>∧</span> <span class=skolem>x</span> <span class=main>≠</span> fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"fst <span class=skolem>x''</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=free>s</span>"</span></span><span class=main>)</span>
        <span class=keyword3><span class=command>case</span></span> true<span class=main>:</span> True
        <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
        <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"fst <span class=skolem>x''</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> fmrestrict_set <span class=free>vs</span> <span class=free>s</span>"</span></span><span class=main>)</span>
          <span class=keyword3><span class=command>case</span></span> True
          <span class=keyword1><span class=command>{</span></span>
            <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>snd <span class=skolem>x''</span><span class=main>)</span> <span class=main>⊆</span> <span class=free>vs</span>"</span></span>
              <span class=keyword1><span class=command>using</span></span> a<span class=main>(</span>1<span class=main>)</span> FDOM_eff_subset_prob_dom_pair dom_prob_proj dual_order.trans
              <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
            <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmrestrict_set <span class=free>vs</span> <span class=main>(</span>snd <span class=skolem>x''</span><span class=main>)</span> <span class=main>=</span> snd <span class=skolem>x''</span>"</span></span>
              <span class=keyword1><span class=command>using</span></span> exec_drest_5
              <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
          <span class=keyword1><span class=command>}</span></span>
          <span class=keyword1><span class=command>note</span></span> i <span class=main>=</span> this
          <span class=keyword1><span class=command>{</span></span>
            <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>=</span> fmrestrict_set <span class=free>vs</span> <span class=main>(</span>snd <span class=skolem>x''</span> <span class=main>++</span> <span class=free>s</span><span class=main>)</span>"</span></span>
              <span class=keyword1><span class=command>using</span></span> a<span class=main>(</span>2<span class=main>,</span> 4<span class=main>)</span> true
              <span class=keyword1><span class=command>unfolding</span></span> state_succ_def
              <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
            <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>=</span> fmrestrict_set <span class=free>vs</span> <span class=main>(</span>snd <span class=skolem>x''</span><span class=main>)</span> <span class=main>++</span> fmrestrict_set <span class=free>vs</span> <span class=free>s</span>"</span></span>
              <span class=keyword1><span class=command>unfolding</span></span> fmap_add_ltr_def
              <span class=keyword1><span class=command>using</span></span> fmrestrict_set_add_distrib
              <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
            <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>=</span> snd <span class=skolem>x''</span> <span class=main>++</span> fmrestrict_set <span class=free>vs</span> <span class=free>s</span>"</span></span>
              <span class=keyword1><span class=command>using</span></span> i
              <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
            <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>=</span> state_succ <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span> <span class=skolem>x''</span>"</span></span>
              <span class=keyword1><span class=command>unfolding</span></span> state_succ_def
              <span class=keyword1><span class=command>using</span></span> True
              <span class=keyword1><span class=command>by</span></span> <span class=operator>argo</span>
          <span class=keyword1><span class=command>}</span></span>
          <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span>  <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>≠</span> fmrestrict_set <span class=free>vs</span> <span class=free>s</span>"</span></span>
            <span class=keyword1><span class=command>using</span></span> a valid_proj_neq_succ_restricted_neq_succ
            <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
          <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
            <span class=keyword1><span class=command>using</span></span> a<span class=main>(</span>1<span class=main>)</span>
            <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
        <span class=keyword1><span class=command>next</span></span>
          <span class=keyword3><span class=command>case</span></span> False
          <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
          <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
            <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x''</span> <span class=main>∈</span> <span class=main>(</span><span class=main>λ</span><span class=bound>p</span><span class=main>.</span> action_proj <span class=bound>p</span> <span class=free>vs</span><span class=main>)</span> <span class=main>`</span> <span class=free>PROB</span>"</span></span>
              <span class=keyword1><span class=command>using</span></span> calculation<span class=main>(</span>1<span class=main>)</span> prob_proj_def
              <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
            <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"action_proj <span class=skolem>x''</span> <span class=free>vs</span> <span class=main>=</span> <span class=skolem>x''</span>"</span></span>
              <span class=keyword1><span class=command>using</span></span> action_proj_idempot
              <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
            <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
              <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> <span class=main><span class=main>(</span></span>no_types<span class=main><span class=main>)</span></span> False action_proj_pair fmsubset_restrict_set_mono fstI
                  surjective_pairing true<span class=main>)</span>
          <span class=keyword1><span class=command>qed</span></span>
        <span class=keyword1><span class=command>qed</span></span>
      <span class=keyword1><span class=command>next</span></span>
        <span class=keyword3><span class=command>case</span></span> False
        <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
        <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"fst <span class=skolem>x''</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> fmrestrict_set <span class=free>vs</span> <span class=free>s</span>"</span></span><span class=main>)</span>
          <span class=keyword3><span class=command>case</span></span> True
          <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>snd <span class=skolem>x''</span><span class=main>)</span> <span class=main>⊆</span> <span class=free>vs</span>"</span></span>
            <span class=keyword1><span class=command>using</span></span> FDOM_eff_subset_prob_dom_pair dom_prob_proj
            <span class=keyword1><span class=command>using</span></span> a<span class=main>(</span>1<span class=main>)</span> dual_order.trans
            <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
          <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmrestrict_set <span class=free>vs</span> <span class=main>(</span>snd <span class=skolem>x''</span><span class=main>)</span> <span class=main>=</span> snd <span class=skolem>x''</span>"</span></span>
            <span class=keyword1><span class=command>using</span></span> exec_drest_5
            <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
          <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
            <span class=keyword1><span class=command>unfolding</span></span> state_succ_def fmap_add_ltr_def
            <span class=keyword1><span class=command>using</span></span> False True sublist_as_proj_eq_as_1
            <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
        <span class=keyword1><span class=command>next</span></span>
          <span class=keyword3><span class=command>case</span></span> False
          <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>fst <span class=skolem>x''</span><span class=main>)</span> <span class=main>⊆</span> <span class=free>vs</span>"</span></span>
            <span class=keyword1><span class=command>using</span></span> FDOM_pre_subset_prob_dom_pair dom_prob_proj
            <span class=keyword1><span class=command>using</span></span> a<span class=main>(</span>1<span class=main>)</span> dual_order.trans
            <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
          <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmrestrict_set <span class=free>vs</span> <span class=main>(</span>fst <span class=skolem>x''</span><span class=main>)</span> <span class=main>=</span> fst <span class=skolem>x''</span>"</span></span>
            <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> exec_drest_5<span class=main>)</span>
          <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
            <span class=keyword1><span class=command>unfolding</span></span> state_succ_def fmap_add_ltr_def
            <span class=keyword1><span class=command>using</span></span> a False fmsubset_restrict_set_mono
            <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> state_succ_def<span class=main>)</span>
        <span class=keyword1><span class=command>qed</span></span>
      <span class=keyword1><span class=command>qed</span></span>
    <span class=keyword1><span class=command>}</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>x''</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x''</span> <span class=main>∈</span> prob_proj <span class=free>PROB</span> <span class=free>vs</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>=</span> state_succ <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span> <span class=skolem>x''</span>"</span></span>
      <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>≠</span> fmrestrict_set <span class=free>vs</span> <span class=free>s</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> <span class=var>?B</span>"</span></span> <span class=keyword1><span class=command>unfolding</span></span> state_successors_def
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=SystemAbstraction-state_in_successor_proj_in_state_in_successor><span class=command>lemma</span></span>  state_in_successor_proj_in_state_in_successor<span class=main>:</span> <span class=quoted><span class=quoted>"
  <span class=main>(</span><span class=free>s'</span> <span class=main>∈</span> state_successors <span class=main>(</span>prob_proj <span class=free>PROB</span> <span class=free>vs</span><span class=main>)</span> <span class=free>s</span><span class=main>)</span>
  <span class=main>⟹</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s'</span>  <span class=main>∈</span> state_successors <span class=main>(</span>prob_proj <span class=free>PROB</span> <span class=free>vs</span><span class=main>)</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> proj_successors
  <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>

<span class=keyword1 id=SystemAbstraction-proj_FDOM_eff_subset_FDOM_valid_states><span class=command>lemma</span></span> proj_FDOM_eff_subset_FDOM_valid_states<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>p</span> <span class=free>e</span> <span class=free>s</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>(</span><span class=free>p</span><span class=main>,</span> <span class=free>e</span><span class=main>)</span> <span class=main>∈</span> prob_proj <span class=free>PROB</span> <span class=free>vs</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>s</span> <span class=main>∈</span> valid_states <span class=free>PROB</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>fmdom' <span class=free>e</span> <span class=main>⊆</span> fmdom' <span class=free>s</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>p'</span></span> <span class=skolem><span class=skolem>e'</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=skolem>p'</span><span class=main>,</span> <span class=skolem>e'</span><span class=main>)</span> <span class=main>∈</span> <span class=free>PROB</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>p</span><span class=main>,</span> <span class=free>e</span><span class=main>)</span> <span class=main>=</span> action_proj <span class=main>(</span><span class=skolem>p'</span><span class=main>,</span> <span class=skolem>e'</span><span class=main>)</span> <span class=free>vs</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>)</span>
      <span class=keyword1><span class=command>unfolding</span></span> prob_proj_def
      <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=free>e</span> <span class=main>⊆</span> prob_dom <span class=main>(</span>prob_proj <span class=free>PROB</span> <span class=free>vs</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> assms FDOM_eff_subset_prob_dom
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>also</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>…</span> <span class=main>=</span> prob_dom <span class=free>PROB</span> <span class=main>∩</span> <span class=free>vs</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> graph_plan_neq_mems_state_set_neq_len
      <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
    <span class=keyword1><span class=command>finally</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=free>e</span> <span class=main>⊆</span> prob_dom <span class=free>PROB</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=free>s</span> <span class=main>=</span> prob_dom <span class=free>PROB</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>2<span class=main>)</span>
    <span class=keyword1><span class=command>unfolding</span></span> valid_states_def
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=SystemAbstraction-valid_proj_action_valid_succ><span class=command>lemma</span></span> valid_proj_action_valid_succ<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>h</span> <span class=main>∈</span> prob_proj <span class=free>PROB</span> <span class=free>vs</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>s</span> <span class=main>∈</span> valid_states <span class=free>PROB</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>state_succ <span class=free>s</span> <span class=free>h</span> <span class=main>∈</span> valid_states <span class=free>PROB</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>snd <span class=free>h</span><span class=main>)</span> <span class=main>⊆</span> fmdom' <span class=free>s</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms proj_FDOM_eff_subset_FDOM_valid_states surjective_pairing
    <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>state_succ <span class=free>s</span> <span class=free>h</span><span class=main>)</span> <span class=main>=</span> fmdom' <span class=free>s</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> calculation<span class=main>(</span>1<span class=main>)</span> FDOM_state_succ
    <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>2<span class=main>)</span> valid_states_def
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=SystemAbstraction-proj_successors_of_valid_are_valid><span class=command>lemma</span></span> proj_successors_of_valid_are_valid<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>s</span> <span class=main>∈</span> valid_states <span class=free>PROB</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>state_successors <span class=main>(</span>prob_proj <span class=free>PROB</span> <span class=free>vs</span><span class=main>)</span> <span class=free>s</span> <span class=main>⊆</span> <span class=main>(</span>valid_states <span class=free>PROB</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> state_successors_def
  <span class=keyword1><span class=command>using</span></span> assms valid_proj_action_valid_succ
  <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>

<span class=keyword1><span class=command>subsection</span></span> <span class=quoted><span class=plain_text>"State Space Projection"</span></span>

<span class=comment1>― ‹NOTE  name shortened.›</span>
<span class=keyword1><span class=command>definition</span></span> <span class=entity>ss_proj</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>ss_proj</span> <span class=free><span class=bound><span class=entity>ss</span></span></span> <span class=free><span class=bound><span class=entity>vs</span></span></span> <span class=main>≡</span> <span class=main>(</span><span class=main>λ</span><span class=bound>s</span><span class=main>.</span> fmrestrict_set <span class=free><span class=bound><span class=entity>vs</span></span></span> <span class=bound>s</span><span class=main>)</span> <span class=main>`</span> <span class=free><span class=bound><span class=entity>ss</span></span></span>"</span></span>

<span class=comment1>― ‹NOTE added lemma.›</span>
<span class=comment1>― ‹TODO refactor into 'Fmap\_Utils'.›</span>
<span class=keyword1 id=SystemAbstraction-fmrestrict_set_inter_img><span class=command>lemma</span></span> fmrestrict_set_inter_img<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>A</span> <span class=free>X</span> <span class=free>Y</span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"fmrestrict_set <span class=main>(</span><span class=free>X</span> <span class=main>∩</span> <span class=free>Y</span><span class=main>)</span> <span class=main>`</span> <span class=free>A</span> <span class=main>=</span> <span class=main>(</span>fmrestrict_set <span class=free>X</span> <span class=main>∘</span> fmrestrict_set <span class=free>Y</span><span class=main>)</span> <span class=main>`</span> <span class=free>A</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=comment1>― ‹NOTE Proof by mutual inclusion.›</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?lhs</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"fmrestrict_set <span class=main>(</span><span class=free>X</span> <span class=main>∩</span> <span class=free>Y</span><span class=main>)</span> <span class=main>`</span> <span class=free>A</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?rhs</span></span></span> <span class=main>=</span> <span class=quoted><span class=quoted>"<span class=main>(</span>fmrestrict_set <span class=free>X</span> <span class=main>∘</span> fmrestrict_set <span class=free>Y</span><span class=main>)</span> <span class=main>`</span> <span class=free>A</span>"</span></span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>a</span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a</span> <span class=main>∈</span> <span class=free>A</span>"</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>fmrestrict_set <span class=free>X</span> <span class=main>∘</span> fmrestrict_set <span class=free>Y</span><span class=main>)</span> <span class=skolem>a</span> <span class=main>=</span> fmrestrict_set <span class=free>X</span> <span class=main>(</span>fmrestrict_set <span class=free>Y</span> <span class=skolem>a</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>also</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>…</span> <span class=main>=</span> fmrestrict_set <span class=main>(</span><span class=free>X</span> <span class=main>∩</span> <span class=free>Y</span><span class=main>)</span> <span class=skolem>a</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> action_proj_inter_i
      <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
    <span class=keyword1><span class=command>finally</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>fmrestrict_set <span class=free>X</span> <span class=main>∘</span> fmrestrict_set <span class=free>Y</span><span class=main>)</span> <span class=skolem>a</span> <span class=main>=</span> fmrestrict_set <span class=main>(</span><span class=free>X</span> <span class=main>∩</span> <span class=free>Y</span><span class=main>)</span> <span class=skolem>a</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>note</span></span> 1 <span class=main>=</span> this
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>a</span>
    <span class=keyword3><span class=command>assume</span></span> P<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>a</span> <span class=main>∈</span> <span class=free>A</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmrestrict_set <span class=main>(</span><span class=free>X</span> <span class=main>∩</span> <span class=free>Y</span><span class=main>)</span> <span class=skolem>a</span> <span class=main>∈</span> <span class=var>?lhs</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>fmrestrict_set <span class=free>X</span> <span class=main>∘</span> fmrestrict_set <span class=free>Y</span><span class=main>)</span> <span class=skolem>a</span> <span class=main>∈</span> <span class=var>?rhs</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> P
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span>
      <span class=quoted><span class=quoted>"fmrestrict_set <span class=main>(</span><span class=free>X</span> <span class=main>∩</span> <span class=free>Y</span><span class=main>)</span> <span class=skolem>a</span> <span class=main>∈</span> <span class=var>?rhs</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>fmrestrict_set <span class=free>X</span> <span class=main>∘</span> fmrestrict_set <span class=free>Y</span><span class=main>)</span> <span class=skolem>a</span> <span class=main>∈</span> <span class=var>?lhs</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> P 1
      <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span><span class=main><span class=keyword3>+</span></span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=SystemAbstraction-invariantStateSpace_thm_9><span class=command>lemma</span></span> invariantStateSpace_thm_9<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>ss</span> <span class=free>vs1</span> <span class=free>vs2</span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"ss_proj <span class=free>ss</span> <span class=main>(</span><span class=free>vs1</span> <span class=main>∩</span> <span class=free>vs2</span><span class=main>)</span> <span class=main>=</span> ss_proj <span class=main>(</span>ss_proj <span class=free>ss</span> <span class=free>vs2</span><span class=main>)</span> <span class=free>vs1</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"
      ss_proj <span class=free>ss</span> <span class=main>(</span><span class=free>vs1</span> <span class=main>∩</span> <span class=free>vs2</span><span class=main>)</span>
      <span class=main>=</span> fmrestrict_set <span class=main>(</span><span class=free>vs1</span> <span class=main>∩</span> <span class=free>vs2</span><span class=main>)</span> <span class=main>`</span> <span class=free>ss</span>
    "</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> ss_proj_def
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>also</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>…</span> <span class=main>=</span> <span class=main>(</span>fmrestrict_set <span class=free>vs1</span> <span class=main>∘</span> fmrestrict_set <span class=free>vs2</span><span class=main>)</span> <span class=main>`</span> <span class=free>ss</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> fmrestrict_set_inter_img
      <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
    <span class=keyword1><span class=command>finally</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"ss_proj <span class=free>ss</span> <span class=main>(</span><span class=free>vs1</span> <span class=main>∩</span> <span class=free>vs2</span><span class=main>)</span> <span class=main>=</span> ss_proj <span class=main>(</span>ss_proj <span class=free>ss</span> <span class=free>vs2</span><span class=main>)</span> <span class=free>vs1</span>"</span></span>
      <span class=keyword1><span class=command>unfolding</span></span> ss_proj_def
      <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=SystemAbstraction-FINITE_ss_proj><span class=command>lemma</span></span> FINITE_ss_proj<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>ss</span> <span class=free>vs</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"finite <span class=free>ss</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"finite <span class=main>(</span>ss_proj <span class=free>ss</span> <span class=free>vs</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> ss_proj_def
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=SystemAbstraction-nempty_stateSpace_nempty_ss_proj><span class=command>lemma</span></span> nempty_stateSpace_nempty_ss_proj<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>ss</span> <span class=main>≠</span> <span class=main>{}</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>ss_proj <span class=free>ss</span> <span class=free>vs</span> <span class=main>≠</span> <span class=main>{}</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> ss_proj_def
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>

<span class=keyword1 id=SystemAbstraction-invariantStateSpace_thm_5><span class=command>lemma</span></span> invariantStateSpace_thm_5<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>ss</span> <span class=free>vs</span> <span class=free>domain</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>stateSpace <span class=free>ss</span> <span class=free>domain</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>stateSpace <span class=main>(</span>ss_proj <span class=free>ss</span> <span class=free>vs</span><span class=main>)</span> <span class=main>(</span><span class=free>domain</span> <span class=main>∩</span> <span class=free>vs</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>unfolding</span></span> stateSpace_def ss_proj_def
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> <span class=main><span class=main>(</span></span>no_types<span class=main><span class=main>,</span></span> lifting<span class=main><span class=main>)</span></span> fmdom'_fmrestrict_set imageE inf_commute<span class=main>)</span>

<span class=keyword1 id=SystemAbstraction-dom_subset_ssproj_eq_ss><span class=command>lemma</span></span> dom_subset_ssproj_eq_ss<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>ss</span> <span class=free>domain</span> <span class=free>vs</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>stateSpace <span class=free>ss</span> <span class=free>domain</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>domain</span> <span class=main>⊆</span> <span class=free>vs</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>ss_proj <span class=free>ss</span> <span class=free>vs</span> <span class=main>=</span> <span class=free>ss</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> ss_proj_def stateSpace_def
  <span class=keyword1><span class=command>using</span></span> assms exec_drest_5
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> <span class=main><span class=main>(</span></span>mono_tags<span class=main><span class=main>,</span></span> lifting<span class=main><span class=main>)</span></span> image_cong image_ident stateSpace_def<span class=main>)</span>

<span class=comment1>― ‹TODO refactor duplicate proof steps in case split.›</span>
<span class=keyword1 id=SystemAbstraction-neq_vs_neq_ss_proj><span class=command>lemma</span></span>  neq_vs_neq_ss_proj<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>vs</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>ss</span> <span class=main>≠</span> <span class=main>{}</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>stateSpace <span class=free>ss</span> <span class=free>vs</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>vs1</span> <span class=main>⊆</span> <span class=free>vs</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>vs2</span> <span class=main>⊆</span> <span class=free>vs</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>vs1</span> <span class=main>≠</span> <span class=free>vs2</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>ss_proj <span class=free>ss</span> <span class=free>vs1</span> <span class=main>≠</span> ss_proj <span class=free>ss</span> <span class=free>vs2</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>f</span><span class=main>.</span> <span class=bound>f</span> <span class=main>∈</span> <span class=free>ss</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>)</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>x</span></span> <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>" <span class=main>(</span><span class=skolem>x</span> <span class=main>∈</span> <span class=free>vs1</span> <span class=main>∧</span> <span class=skolem>x</span> <span class=main>∉</span> <span class=free>vs2</span><span class=main>)</span> <span class=main>∨</span> <span class=main>(</span><span class=skolem>x</span> <span class=main>∈</span> <span class=free>vs2</span> <span class=main>∧</span> <span class=skolem>x</span> <span class=main>∉</span> <span class=free>vs1</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>5<span class=main>)</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>consider</span></span> <span class=main>(</span>i<span class=main>)</span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> <span class=free>vs1</span> <span class=main>∧</span> <span class=skolem>x</span> <span class=main>∉</span> <span class=free>vs2</span>"</span></span> <span class=main>|</span> <span class=main>(</span>ii<span class=main>)</span> <span class=quoted><span class=quoted>"<span class=skolem>x</span> <span class=main>∈</span> <span class=free>vs2</span> <span class=main>∧</span> <span class=skolem>x</span> <span class=main>∉</span> <span class=free>vs1</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmrestrict_set <span class=free>vs1</span> <span class=main>`</span> <span class=free>ss</span> <span class=main>≠</span>  fmrestrict_set <span class=free>vs2</span> <span class=main>`</span> <span class=free>ss</span>"</span></span> <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span><span class=main>)</span>
      <span class=keyword3><span class=command>case</span></span> i
      <span class=keyword1><span class=command>{</span></span>
        <span class=keyword3><span class=command>fix</span></span> <span class=skolem>s'</span> <span class=skolem>t'</span>
        <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>s'</span> <span class=main>∈</span> fmrestrict_set <span class=free>vs1</span> <span class=main>`</span> <span class=free>ss</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>t'</span> <span class=main>∈</span> fmrestrict_set <span class=free>vs2</span> <span class=main>`</span> <span class=free>ss</span>"</span></span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>s</span></span> <span class=skolem><span class=skolem>t</span></span> <span class=keyword2><span class=keyword>where</span></span> a<span class=main>:</span>
          <span class=quoted><span class=quoted>"<span class=skolem>s</span> <span class=main>∈</span> <span class=free>ss</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>s'</span> <span class=main>=</span> fmrestrict_set <span class=free>vs1</span> <span class=skolem>s</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>t</span> <span class=main>∈</span> <span class=free>ss</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>t'</span> <span class=main>=</span> fmrestrict_set <span class=free>vs2</span> <span class=skolem>t</span>"</span></span>
          <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=skolem>s</span> <span class=main>=</span> <span class=free>vs</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>2<span class=main>)</span>
          <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> stateSpace_def<span class=main>)</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> b<span class=main>:</span> <span class=quoted><span class=quoted>"fmdom' <span class=skolem>s'</span> <span class=main>=</span> <span class=free>vs1</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>3<span class=main>)</span> a fmdom'_fmrestrict_set inf.order_iff
          <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=skolem>t</span> <span class=main>=</span> <span class=free>vs</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>2<span class=main>)</span> a<span class=main>(</span>3<span class=main>)</span>
          <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> stateSpace_def<span class=main>)</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=skolem>t'</span> <span class=main>=</span> <span class=free>vs2</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>4<span class=main>)</span> a<span class=main>(</span>4<span class=main>)</span> fmdom'_fmrestrict_set inf.order_iff
          <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=skolem>s'</span> <span class=skolem>x</span> <span class=main>≠</span> None"</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=skolem>t'</span> <span class=skolem>x</span> <span class=main>=</span> None"</span></span>
          <span class=keyword1><span class=command>using</span></span> i b domIff fmdom'_alt_def fmdom.rep_eq
          <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span><span class=main><span class=keyword3>+</span></span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>s'</span> <span class=main>≠</span> <span class=skolem>t'</span>"</span></span>
          <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>}</span></span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
        <span class=keyword1><span class=command>using</span></span> 1 neq_funs_neq_images
        <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>next</span></span>
      <span class=keyword3><span class=command>case</span></span> ii
      <span class=keyword1><span class=command>{</span></span>
        <span class=keyword3><span class=command>fix</span></span> <span class=skolem>s'</span> <span class=skolem>t'</span>
        <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>s'</span> <span class=main>∈</span> fmrestrict_set <span class=free>vs1</span> <span class=main>`</span> <span class=free>ss</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>t'</span> <span class=main>∈</span> fmrestrict_set <span class=free>vs2</span> <span class=main>`</span> <span class=free>ss</span>"</span></span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>s</span></span> <span class=skolem><span class=skolem>t</span></span> <span class=keyword2><span class=keyword>where</span></span> c<span class=main>:</span>
          <span class=quoted><span class=quoted>"<span class=skolem>s</span> <span class=main>∈</span> <span class=free>ss</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>s'</span> <span class=main>=</span> fmrestrict_set <span class=free>vs1</span> <span class=skolem>s</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>t</span> <span class=main>∈</span> <span class=free>ss</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>t'</span> <span class=main>=</span> fmrestrict_set <span class=free>vs2</span> <span class=skolem>t</span>"</span></span>
          <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=skolem>s</span> <span class=main>=</span> <span class=free>vs</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>2<span class=main>)</span>
          <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> stateSpace_def<span class=main>)</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> d<span class=main>:</span> <span class=quoted><span class=quoted>"fmdom' <span class=skolem>s'</span> <span class=main>=</span> <span class=free>vs1</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>3<span class=main>)</span> c<span class=main>(</span>2<span class=main>)</span> fmdom'_fmrestrict_set inf.order_iff
          <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span>  <span class=quoted><span class=quoted>"fmdom' <span class=skolem>t</span> <span class=main>=</span> <span class=free>vs</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>2<span class=main>)</span> c<span class=main>(</span>3<span class=main>)</span>
          <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> stateSpace_def<span class=main>)</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=skolem>t'</span> <span class=main>=</span> <span class=free>vs2</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>4<span class=main>)</span> c<span class=main>(</span>4<span class=main>)</span> fmdom'_fmrestrict_set inf.order_iff
          <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=skolem>s'</span> <span class=skolem>x</span> <span class=main>=</span> None"</span></span> <span class=quoted><span class=quoted>"fmlookup <span class=skolem>t'</span> <span class=skolem>x</span> <span class=main>≠</span> None"</span></span>
          <span class=keyword1><span class=command>using</span></span> ii d domIff fmdom'_alt_def fmdom.rep_eq
          <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span><span class=main><span class=keyword3>+</span></span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>s'</span> <span class=main>≠</span> <span class=skolem>t'</span>"</span></span>
          <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>}</span></span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
        <span class=keyword1><span class=command>using</span></span> 1 neq_funs_neq_images
        <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>unfolding</span></span> ss_proj_def
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1 id=SystemAbstraction-subset_dom_stateSpace_ss_proj><span class=command>lemma</span></span> subset_dom_stateSpace_ss_proj<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>vs1</span> <span class=free>vs2</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>vs1</span> <span class=main>⊆</span> <span class=free>vs2</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>stateSpace <span class=free>ss</span> <span class=free>vs2</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>stateSpace <span class=main>(</span>ss_proj <span class=free>ss</span> <span class=free>vs1</span><span class=main>)</span> <span class=free>vs1</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> inf.absorb_iff2 invariantStateSpace_thm_5<span class=main>)</span>

<span class=keyword1 id=SystemAbstraction-card_proj_leq><span class=command>lemma</span></span> card_proj_leq<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"finite <span class=free>PROB</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"card <span class=main>(</span>prob_proj <span class=free>PROB</span> <span class=free>vs</span><span class=main>)</span> <span class=main>≤</span> card <span class=free>PROB</span>"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> prob_proj_def
  <span class=keyword1><span class=command>using</span></span> assms card_image_le
  <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>

<span class=keyword2><span class=keyword>end</span></span></pre>
</div><div id=Acyclicity>
<div class=head>
<h1>Theory Acyclicity</h1>
</div>
<pre class=source><span class=keyword1><span class=command>theory</span></span> Acyclicity
  <span class=keyword2><span class=keyword>imports</span></span> <a href=https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html>Main</a>
<span class=keyword2><span class=keyword>begin</span></span>


<span class=keyword1><span class=command>section</span></span> <span class=quoted><span class=plain_text>‹Acyclicity›</span></span>

<span class=keyword1><span class=command>text</span></span> <span class=quoted><span class=plain_text>‹ Two of the discussed bounding algorithms ("top-down" and "bottom-up") exploit acyclicity
of the system under projection on sets of state variables closed under mutual variable dependency. 
[Abdulaziz et al., p.11] 

This specific notion of acyclicity is formalised using topologically sorted dependency graphs 
induced by the variable dependency relation. [Abdulaziz et al., p.14]›</span></span>


<span class=keyword1><span class=command>subsection</span></span> <span class=quoted><span class=plain_text>"Topological Sorting of Dependency Graphs"</span></span>

<span class=comment1>― ‹NOTE name shortened.›</span>
<span class=comment1>― ‹NOTE using 'fun' because of multiple defining equations.›</span> 
<span class=keyword1><span class=command>fun</span></span> <span class=entity>top_sorted_abs</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>top_sorted_abs</span> <span class=free><span class=bound><span class=entity>R</span></span></span> <span class=main>[]</span> <span class=main>=</span> True"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>top_sorted_abs</span> <span class=free><span class=bound><span class=entity>R</span></span></span> <span class=main>(</span><span class=free><span class=bound><span class=entity>h</span></span></span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>l</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span>list_all <span class=main>(</span><span class=main>λ</span><span class=bound>x</span><span class=main>.</span> <span class=main>¬</span><span class=free><span class=bound><span class=entity>R</span></span></span> <span class=bound>x</span> <span class=free><span class=bound><span class=entity>h</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>l</span></span></span> <span class=main>∧</span> <span class=free>top_sorted_abs</span> <span class=free><span class=bound><span class=entity>R</span></span></span> <span class=free><span class=bound><span class=entity>l</span></span></span><span class=main>)</span>"</span></span>


<span class=keyword1 id=Acyclicity-top_sorted_abs_mem><span class=command>lemma</span></span> top_sorted_abs_mem<span class=main>:</span> 
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>top_sorted_abs <span class=free>R</span> <span class=main>(</span><span class=free>h</span> <span class=main>#</span> <span class=free>l</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>ListMem <span class=free>x</span> <span class=free>l</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>¬</span> <span class=free>R</span> <span class=free>x</span> <span class=free>h</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> ListMem_iff list.pred_set<span class=main>)</span>


<span class=keyword1 id=Acyclicity-top_sorted_cons><span class=command>lemma</span></span> top_sorted_cons<span class=main>:</span> 
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"top_sorted_abs <span class=free>R</span> <span class=main>(</span><span class=free>h</span> <span class=main>#</span> <span class=free>l</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>top_sorted_abs <span class=free>R</span> <span class=free>l</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>


<span class=keyword1><span class=command>subsection</span></span> <span class=quoted><span class=plain_text>‹The Weightiest Path Function (wlp)›</span></span>

<span class=keyword1><span class=command>text</span></span> <span class=quoted><span class=plain_text>‹ The weightiest path function is a generalization of an algorithm which computes the
longest path in a DAG starting at a given vertex `v`. Its arguments are the relation `R` which
induces the graph, a weighing function `w` assigning weights to vertices, an accumulating functions
`f` and `g` which aggregate vertex weights into a path weight and the weights of different paths
respectively, the considered vertex and the graph represented as a topological sorted list. 
[Abdulaziz et al., p.18] 

Typical weight combining functions have the properties defined by `geq\_arg` and `increasing`. 
[Abdulaziz et al., p.18] ›</span></span>

<span class=comment1>― ‹NOTE name shortened.›</span>
<span class=keyword1><span class=command>fun</span></span> <span class=entity>wlp</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>wlp</span> <span class=free><span class=bound><span class=entity>R</span></span></span> <span class=free><span class=bound><span class=entity>w</span></span></span> <span class=free><span class=bound><span class=entity>g</span></span></span> <span class=free><span class=bound><span class=entity>f</span></span></span> <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>[]</span> <span class=main>=</span> <span class=free><span class=bound><span class=entity>w</span></span></span> <span class=free><span class=bound><span class=entity>x</span></span></span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>wlp</span> <span class=free><span class=bound><span class=entity>R</span></span></span> <span class=free><span class=bound><span class=entity>w</span></span></span> <span class=free><span class=bound><span class=entity>g</span></span></span> <span class=free><span class=bound><span class=entity>f</span></span></span> <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=main>(</span><span class=free><span class=bound><span class=entity>h</span></span></span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>l</span></span></span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>if</span> <span class=free><span class=bound><span class=entity>R</span></span></span> <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=free><span class=bound><span class=entity>h</span></span></span>
    <span class=keyword1>then</span> <span class=free><span class=bound><span class=entity>g</span></span></span> <span class=main>(</span><span class=free><span class=bound><span class=entity>f</span></span></span> <span class=main>(</span><span class=free><span class=bound><span class=entity>w</span></span></span> <span class=free><span class=bound><span class=entity>x</span></span></span><span class=main>)</span> <span class=main>(</span><span class=free>wlp</span> <span class=free><span class=bound><span class=entity>R</span></span></span> <span class=free><span class=bound><span class=entity>w</span></span></span> <span class=free><span class=bound><span class=entity>g</span></span></span> <span class=free><span class=bound><span class=entity>f</span></span></span> <span class=free><span class=bound><span class=entity>h</span></span></span> <span class=free><span class=bound><span class=entity>l</span></span></span><span class=main>)</span><span class=main>)</span> <span class=main>(</span><span class=free>wlp</span> <span class=free><span class=bound><span class=entity>R</span></span></span> <span class=free><span class=bound><span class=entity>w</span></span></span> <span class=free><span class=bound><span class=entity>g</span></span></span> <span class=free><span class=bound><span class=entity>f</span></span></span> <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=free><span class=bound><span class=entity>l</span></span></span><span class=main>)</span>
    <span class=keyword1>else</span> <span class=free>wlp</span> <span class=free><span class=bound><span class=entity>R</span></span></span> <span class=free><span class=bound><span class=entity>w</span></span></span> <span class=free><span class=bound><span class=entity>g</span></span></span> <span class=free><span class=bound><span class=entity>f</span></span></span> <span class=free><span class=bound><span class=entity>x</span></span></span> <span class=free><span class=bound><span class=entity>l</span></span></span>
  <span class=main>)</span>"</span></span>


<span class=comment1>― ‹NOTE name shortened.›</span>
<span class=keyword1><span class=command>definition</span></span> <span class=entity>geq_arg</span> <span class=keyword2><span class=keyword>where</span></span> 
  <span class=quoted><span class=quoted>"<span class=free>geq_arg</span> <span class=free><span class=bound><span class=entity>f</span></span></span> <span class=main>≡</span> <span class=main>(</span><span class=main>∀</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=main>(</span><span class=bound>x</span> <span class=main>≤</span> <span class=free><span class=bound><span class=entity>f</span></span></span> <span class=bound>x</span> <span class=bound>y</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=bound>y</span> <span class=main>≤</span> <span class=free><span class=bound><span class=entity>f</span></span></span> <span class=bound>x</span> <span class=bound>y</span><span class=main>)</span><span class=main>)</span>"</span></span>


<span class=keyword1 id=Acyclicity-individual_weight_less_eq_lp><span class=command>lemma</span></span> individual_weight_less_eq_lp<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>w</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> <span class=main>⇒</span> nat"</span></span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"geq_arg <span class=free>g</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>w</span> <span class=free>x</span> <span class=main>≤</span> wlp <span class=free>R</span> <span class=free>w</span> <span class=free>g</span> <span class=free>f</span> <span class=free>x</span> <span class=free>l</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>unfolding</span></span> geq_arg_def
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>l</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>R</span></span> <span class=quoted><span class=free>w</span></span> <span class=quoted><span class=free>g</span></span> <span class=quoted><span class=free>f</span></span> <span class=quoted><span class=free>x</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>a</span> <span class=skolem>l</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>using</span></span> Cons.IH Cons.prems
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"<span class=skolem>R</span> <span class=skolem>x</span> <span class=skolem>a</span>"</span></span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> True
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> 
      <span class=keyword1><span class=command>using</span></span> Cons le_trans wlp.simps<span class=main>(</span>2<span class=main>)</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>smt</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> False
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span> 
      <span class=keyword1><span class=command>using</span></span> Cons
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>qed</span></span> <span class=operator>simp</span>


<span class=comment1>― ‹NOTE Types of 'f' and 'g' had to be fixed to be able to use transitivity rule of the less-equal
relation.›</span>
<span class=keyword1 id=Acyclicity-lp_geq_lp_from_successor><span class=command>lemma</span></span> lp_geq_lp_from_successor<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>vtx1</span> <span class=keyword2><span class=keyword>and</span></span> <span class=free>f</span> <span class=free>g</span> <span class=main>::</span> <span class=quoted><span class=quoted>"nat <span class=main>⇒</span> nat <span class=main>⇒</span> nat"</span></span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"geq_arg <span class=free>f</span>"</span></span> <span class=quoted><span class=quoted>"geq_arg <span class=free>g</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>vtx</span><span class=main>.</span> ListMem <span class=bound>vtx</span> <span class=free>G</span> <span class=main>⟶</span> <span class=main>¬</span><span class=free>R</span> <span class=bound>vtx</span> <span class=bound>vtx</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>R</span> <span class=free>vtx2</span> <span class=free>vtx1</span>"</span></span> 
    <span class=quoted><span class=quoted>"ListMem <span class=free>vtx1</span> <span class=free>G</span>"</span></span> <span class=quoted><span class=quoted>"top_sorted_abs <span class=free>R</span> <span class=free>G</span>"</span></span> 
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>f</span> <span class=main>(</span><span class=free>w</span> <span class=free>vtx2</span><span class=main>)</span> <span class=main>(</span>wlp <span class=free>R</span> <span class=free>w</span> <span class=free>g</span> <span class=free>f</span> <span class=free>vtx1</span> <span class=free>G</span><span class=main>)</span> <span class=main>≤</span> <span class=main>(</span>wlp <span class=free>R</span> <span class=free>w</span> <span class=free>g</span> <span class=free>f</span> <span class=free>vtx2</span> <span class=free>G</span><span class=main>)</span><span class=main>)</span>"</span></span> 
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command>unfolding</span></span> geq_arg_def
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>G</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>vtx1</span></span> <span class=quoted><span class=free>f</span></span> <span class=quoted><span class=free>g</span></span> <span class=quoted><span class=free>R</span></span> <span class=quoted><span class=free>vtx2</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> Nil
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> 
    <span class=keyword1><span class=command>using</span></span> ListMem_iff
    <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>a</span> <span class=skolem>G</span><span class=main>)</span>
  <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span> 
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>auto</span><span class=main>)</span>
    <span class=keyword3><span class=command>assume</span></span> P1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>R</span> <span class=skolem>vtx1</span> <span class=skolem>a</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>R</span> <span class=skolem>vtx2</span> <span class=skolem>a</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"
        <span class=skolem>f</span> <span class=main>(</span><span class=free>w</span> <span class=skolem>vtx2</span><span class=main>)</span> <span class=main>(</span><span class=skolem>g</span> <span class=main>(</span><span class=skolem>f</span> <span class=main>(</span><span class=free>w</span> <span class=skolem>vtx1</span><span class=main>)</span> <span class=main>(</span>wlp <span class=skolem>R</span> <span class=free>w</span> <span class=skolem>g</span> <span class=skolem>f</span> <span class=skolem>a</span> <span class=skolem>G</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>wlp <span class=skolem>R</span> <span class=free>w</span> <span class=skolem>g</span> <span class=skolem>f</span> <span class=skolem>vtx1</span> <span class=skolem>G</span><span class=main>)</span><span class=main>)</span>
        <span class=main>≤</span> <span class=skolem>g</span> <span class=main>(</span><span class=skolem>f</span> <span class=main>(</span><span class=free>w</span> <span class=skolem>vtx2</span><span class=main>)</span> <span class=main>(</span>wlp <span class=skolem>R</span> <span class=free>w</span> <span class=skolem>g</span> <span class=skolem>f</span> <span class=skolem>a</span> <span class=skolem>G</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>wlp <span class=skolem>R</span> <span class=free>w</span> <span class=skolem>g</span> <span class=skolem>f</span> <span class=skolem>vtx2</span> <span class=skolem>G</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>3<span class=main>,</span> 5<span class=main>,</span> 6<span class=main>)</span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> ListMem_iff set_ConsD top_sorted_abs_mem<span class=main>)</span>
  <span class=keyword1><span class=command>next</span></span> 
    <span class=keyword3><span class=command>assume</span></span> P2<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>R</span> <span class=skolem>vtx1</span> <span class=skolem>a</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span> <span class=skolem>R</span> <span class=skolem>vtx2</span> <span class=skolem>a</span>"</span></span> 
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"
        <span class=skolem>f</span> <span class=main>(</span><span class=free>w</span> <span class=skolem>vtx2</span><span class=main>)</span> <span class=main>(</span><span class=skolem>g</span> <span class=main>(</span><span class=skolem>f</span> <span class=main>(</span><span class=free>w</span> <span class=skolem>vtx1</span><span class=main>)</span> <span class=main>(</span>wlp <span class=skolem>R</span> <span class=free>w</span> <span class=skolem>g</span> <span class=skolem>f</span> <span class=skolem>a</span> <span class=skolem>G</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>wlp <span class=skolem>R</span> <span class=free>w</span> <span class=skolem>g</span> <span class=skolem>f</span> <span class=skolem>vtx1</span> <span class=skolem>G</span><span class=main>)</span><span class=main>)</span> 
        <span class=main>≤</span> wlp <span class=skolem>R</span> <span class=free>w</span> <span class=skolem>g</span> <span class=skolem>f</span> <span class=skolem>vtx2</span> <span class=skolem>G</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>4<span class=main>,</span> 5<span class=main>,</span> 6<span class=main>)</span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> ListMem_iff set_ConsD top_sorted_abs_mem<span class=main>)</span> 
  <span class=keyword1><span class=command>next</span></span> 
    <span class=keyword3><span class=command>assume</span></span> P3<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>¬</span> <span class=skolem>R</span> <span class=skolem>vtx1</span> <span class=skolem>a</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>R</span> <span class=skolem>vtx2</span> <span class=skolem>a</span>"</span></span> 
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"
        <span class=skolem>f</span> <span class=main>(</span><span class=free>w</span> <span class=skolem>vtx2</span><span class=main>)</span> <span class=main>(</span>wlp <span class=skolem>R</span> <span class=free>w</span> <span class=skolem>g</span> <span class=skolem>f</span> <span class=skolem>vtx1</span> <span class=skolem>G</span><span class=main>)</span> 
        <span class=main>≤</span> <span class=skolem>g</span> <span class=main>(</span><span class=skolem>f</span> <span class=main>(</span><span class=free>w</span> <span class=skolem>vtx2</span><span class=main>)</span> <span class=main>(</span>wlp <span class=skolem>R</span> <span class=free>w</span> <span class=skolem>g</span> <span class=skolem>f</span> <span class=skolem>a</span> <span class=skolem>G</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>wlp <span class=skolem>R</span> <span class=free>w</span> <span class=skolem>g</span> <span class=skolem>f</span> <span class=skolem>vtx2</span> <span class=skolem>G</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
      <span class=keyword1><span class=command>have</span></span> f1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>n</span> <span class=bound>na</span><span class=main>.</span> <span class=bound>n</span> <span class=main>≤</span> <span class=skolem>g</span> <span class=bound>n</span> <span class=bound>na</span> <span class=main>∧</span> <span class=bound>na</span> <span class=main>≤</span> <span class=skolem>g</span> <span class=bound>n</span> <span class=bound>na</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>2<span class=main>)</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>have</span></span> f2<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=skolem>vtx1</span> <span class=main>=</span> <span class=skolem>a</span> <span class=main>∨</span> <span class=skolem>vtx1</span> <span class=main>∈</span> set <span class=skolem>G</span>"</span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>meson</span> Cons.prems<span class=main><span class=main>(</span></span>5<span class=main><span class=main>)</span></span> ListMem_iff set_ConsD<span class=main>)</span>
      <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>aa</span></span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=tfree>'a</span> <span class=main>⇒</span> <span class=tfree>'a</span> <span class=main>⇒</span> bool<span class=main>)</span> <span class=main>⇒</span> <span class=tfree>'a</span>"</span></span> <span class=keyword2><span class=keyword>where</span></span>
        <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>x2</span><span class=main>.</span> <span class=main>(</span><span class=main>∃</span><span class=bound>v5</span><span class=main>.</span> ListMem <span class=bound>v5</span> <span class=skolem>G</span> <span class=main>∧</span> <span class=bound>x2</span> <span class=bound>v5</span> <span class=bound>v5</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span>ListMem <span class=main>(</span><span class=skolem>aa</span> <span class=bound>x2</span><span class=main>)</span> <span class=skolem>G</span> <span class=main>∧</span> <span class=bound>x2</span> <span class=main>(</span><span class=skolem>aa</span> <span class=bound>x2</span><span class=main>)</span> <span class=main>(</span><span class=skolem>aa</span> <span class=bound>x2</span><span class=main>)</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=operator>moura</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"
          ListMem <span class=main>(</span><span class=skolem>aa</span> <span class=skolem>R</span><span class=main>)</span> <span class=skolem>G</span> <span class=main>∧</span> <span class=skolem>R</span> <span class=main>(</span><span class=skolem>aa</span> <span class=skolem>R</span><span class=main>)</span> <span class=main>(</span><span class=skolem>aa</span> <span class=skolem>R</span><span class=main>)</span> 
          <span class=main>∨</span> <span class=main>¬</span> ListMem <span class=skolem>vtx1</span> <span class=skolem>G</span> <span class=main>∨</span> <span class=skolem>f</span> <span class=main>(</span><span class=free>w</span> <span class=skolem>vtx2</span><span class=main>)</span> <span class=main>(</span>wlp <span class=skolem>R</span> <span class=free>w</span> <span class=skolem>g</span> <span class=skolem>f</span> <span class=skolem>vtx1</span> <span class=skolem>G</span><span class=main>)</span> <span class=main>≤</span> wlp <span class=skolem>R</span> <span class=free>w</span> <span class=skolem>g</span> <span class=skolem>f</span> <span class=skolem>vtx2</span> <span class=skolem>G</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> f1 <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> <span class=main><span class=main>(</span></span>no_types<span class=main><span class=main>)</span></span> Cons.IH Cons.prems<span class=main><span class=main>(</span></span>1<span class=main><span class=main>,</span></span> 4<span class=main><span class=main>,</span></span> 6<span class=main><span class=main>)</span></span> top_sorted_cons<span class=main>)</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
        <span class=keyword1><span class=command>using</span></span> f2 f1 <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>meson</span> Cons.prems<span class=main><span class=main>(</span></span>3<span class=main><span class=main>)</span></span> ListMem_iff insert le_trans<span class=main>)</span>
    <span class=keyword1><span class=command>qed</span></span>
  <span class=keyword1><span class=command>next</span></span> 
    <span class=keyword3><span class=command>assume</span></span> P4<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>¬</span> <span class=skolem>R</span> <span class=skolem>vtx1</span> <span class=skolem>a</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>¬</span> <span class=skolem>R</span> <span class=skolem>vtx2</span> <span class=skolem>a</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=skolem>f</span> <span class=main>(</span><span class=free>w</span> <span class=skolem>vtx2</span><span class=main>)</span> <span class=main>(</span>wlp <span class=skolem>R</span> <span class=free>w</span> <span class=skolem>g</span> <span class=skolem>f</span> <span class=skolem>vtx1</span> <span class=skolem>G</span><span class=main>)</span> <span class=main>≤</span> wlp <span class=skolem>R</span> <span class=free>w</span> <span class=skolem>g</span> <span class=skolem>f</span> <span class=skolem>vtx2</span> <span class=skolem>G</span>"</span></span>
    <span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
      <span class=keyword1><span class=command>have</span></span> f1<span class=main>:</span> <span class=quoted><span class=quoted>"top_sorted_abs <span class=skolem>R</span> <span class=skolem>G</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>6<span class=main>)</span> <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"ListMem <span class=skolem>vtx1</span> <span class=skolem>G</span>"</span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> Cons.prems<span class=main><span class=main>(</span></span>4<span class=main><span class=main>)</span></span> Cons.prems<span class=main><span class=main>(</span></span>5<span class=main><span class=main>)</span></span> ListMem_iff P4<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span> set_ConsD<span class=main>)</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
        <span class=keyword1><span class=command>using</span></span> f1 <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> Cons.IH Cons.prems<span class=main><span class=main>(</span></span>1<span class=main><span class=main>,</span></span> 2<span class=main><span class=main>,</span></span> 3<span class=main><span class=main>,</span></span> 4<span class=main><span class=main>)</span></span> insert<span class=main>)</span>
    <span class=keyword1><span class=command>qed</span></span> 
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1><span class=command>definition</span></span> <span class=entity>increasing</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>increasing</span> <span class=free><span class=bound><span class=entity>f</span></span></span> <span class=main>≡</span> <span class=main>(</span><span class=main>∀</span><span class=bound>e</span> <span class=bound>b</span> <span class=bound>c</span> <span class=bound>d</span><span class=main>.</span> <span class=main>(</span><span class=bound>e</span> <span class=main>≤</span> <span class=bound>c</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=bound>b</span> <span class=main>≤</span> <span class=bound>d</span><span class=main>)</span> <span class=main>⟶</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>f</span></span></span> <span class=bound>e</span> <span class=bound>b</span> <span class=main>≤</span> <span class=free><span class=bound><span class=entity>f</span></span></span> <span class=bound>c</span> <span class=bound>d</span><span class=main>)</span><span class=main>)</span>"</span></span>


<span class=keyword1 id=Acyclicity-weight_fun_leq_imp_lp_leq><span class=command>lemma</span></span> weight_fun_leq_imp_lp_leq<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>x</span><span class=main>.</span>
  <span class=main>(</span>increasing <span class=free>f</span><span class=main>)</span>
  <span class=main>⟹</span> <span class=main>(</span>increasing <span class=free>g</span><span class=main>)</span>
  <span class=main>⟹</span> <span class=main>(</span><span class=main>∀</span><span class=bound>y</span><span class=main>.</span> ListMem <span class=bound>y</span> <span class=free>l</span> <span class=main>⟶</span> <span class=free>w1</span> <span class=bound>y</span> <span class=main>≤</span> <span class=free>w2</span> <span class=bound>y</span><span class=main>)</span> 
  <span class=main>⟹</span> <span class=main>(</span><span class=free>w1</span> <span class=bound>x</span> <span class=main>≤</span> <span class=free>w2</span> <span class=bound>x</span><span class=main>)</span>
  <span class=main>⟹</span> <span class=main>(</span>wlp <span class=free>R</span> <span class=free>w1</span> <span class=free>g</span> <span class=free>f</span> <span class=bound>x</span> <span class=free>l</span> <span class=main>≤</span> wlp <span class=free>R</span> <span class=free>w2</span> <span class=free>g</span> <span class=free>f</span> <span class=bound>x</span> <span class=free>l</span><span class=main>)</span>
"</span></span>
  <span class=keyword1><span class=command>unfolding</span></span> increasing_def
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>l</span></span><span class=main>)</span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> elem insert<span class=main>)</span>


<span class=comment1>― ‹NOTE generalizing `f2`, `x1`, `x2` seems to break the prover.›</span>
<span class=keyword1 id=Acyclicity-wlp_congruence_rule><span class=command>lemma</span></span> wlp_congruence_rule<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>l1</span> <span class=free>l2</span> <span class=free>R1</span> <span class=free>R2</span> <span class=free>w1</span> <span class=free>w2</span> <span class=free>g1</span> <span class=free>g2</span> <span class=free>f1</span> <span class=free>f2</span> <span class=free>x1</span> <span class=free>x2</span> 
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>l1</span> <span class=main>=</span> <span class=free>l2</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>y</span><span class=main>.</span> ListMem <span class=bound>y</span> <span class=free>l2</span> <span class=main>⟶</span> <span class=main>(</span><span class=free>R1</span> <span class=free>x1</span> <span class=bound>y</span> <span class=main>=</span> <span class=free>R2</span> <span class=free>x2</span> <span class=bound>y</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>y</span><span class=main>.</span> ListMem <span class=bound>y</span> <span class=free>l2</span> <span class=main>⟶</span> <span class=main>(</span><span class=free>R1</span> <span class=bound>y</span> <span class=free>x1</span> <span class=main>=</span> <span class=free>R2</span> <span class=bound>y</span> <span class=free>x2</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>w1</span> <span class=free>x1</span> <span class=main>=</span> <span class=free>w2</span> <span class=free>x2</span><span class=main>)</span>"</span></span> 
    <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>y1</span> <span class=bound>y2</span><span class=main>.</span> <span class=main>(</span><span class=bound>y1</span> <span class=main>=</span> <span class=bound>y2</span><span class=main>)</span> <span class=main>⟶</span> <span class=main>(</span><span class=free>f1</span> <span class=main>(</span><span class=free>w1</span> <span class=free>x1</span><span class=main>)</span> <span class=bound>y1</span> <span class=main>=</span> <span class=free>f2</span> <span class=main>(</span><span class=free>w2</span> <span class=free>x2</span><span class=main>)</span> <span class=bound>y2</span><span class=main>)</span><span class=main>)</span>"</span></span> 
    <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>y1</span> <span class=bound>y2</span> <span class=bound>z1</span> <span class=bound>z2</span><span class=main>.</span> <span class=main>(</span><span class=bound>y1</span> <span class=main>=</span> <span class=bound>y2</span><span class=main>)</span> <span class=main>∧</span> <span class=main>(</span><span class=bound>z1</span> <span class=main>=</span> <span class=bound>z2</span><span class=main>)</span> <span class=main>⟶</span> <span class=main>(</span><span class=main>(</span><span class=free>g1</span> <span class=main>(</span><span class=free>f1</span> <span class=main>(</span><span class=free>w1</span> <span class=free>x1</span><span class=main>)</span> <span class=bound>y1</span><span class=main>)</span> <span class=bound>z1</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span><span class=free>g2</span> <span class=main>(</span><span class=free>f2</span> <span class=main>(</span><span class=free>w2</span> <span class=free>x2</span><span class=main>)</span> <span class=bound>y2</span><span class=main>)</span> <span class=bound>z2</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> ListMem <span class=bound>x</span> <span class=free>l2</span> <span class=main>∧</span> ListMem <span class=bound>y</span> <span class=free>l2</span> <span class=main>⟶</span> <span class=main>(</span><span class=free>R1</span> <span class=bound>x</span> <span class=bound>y</span> <span class=main>=</span> <span class=free>R2</span> <span class=bound>x</span> <span class=bound>y</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>x</span><span class=main>.</span> ListMem <span class=bound>x</span> <span class=free>l2</span> <span class=main>⟶</span> <span class=main>(</span><span class=free>w1</span> <span class=bound>x</span> <span class=main>=</span> <span class=free>w2</span> <span class=bound>x</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>x</span> <span class=bound>y</span> <span class=bound>z</span><span class=main>.</span> ListMem <span class=bound>x</span> <span class=free>l2</span> <span class=main>⟶</span> <span class=main>(</span><span class=free>g1</span> <span class=main>(</span><span class=free>f1</span> <span class=main>(</span><span class=free>w1</span> <span class=bound>x</span><span class=main>)</span> <span class=bound>y</span><span class=main>)</span> <span class=bound>z</span> <span class=main>=</span> <span class=free>g2</span> <span class=main>(</span><span class=free>f2</span> <span class=main>(</span><span class=free>w2</span> <span class=bound>x</span><span class=main>)</span> <span class=bound>y</span><span class=main>)</span> <span class=bound>z</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∀</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> ListMem <span class=bound>x</span> <span class=free>l2</span> <span class=main>⟶</span> <span class=main>(</span><span class=free>f1</span> <span class=main>(</span><span class=free>w1</span> <span class=bound>x</span><span class=main>)</span> <span class=bound>y</span> <span class=main>=</span> <span class=free>f2</span> <span class=main>(</span><span class=free>w1</span> <span class=bound>x</span><span class=main>)</span> <span class=bound>y</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>(</span>wlp <span class=free>R1</span> <span class=free>w1</span> <span class=free>g1</span> <span class=free>f1</span> <span class=free>x1</span> <span class=free>l1</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span>wlp <span class=free>R2</span> <span class=free>w2</span> <span class=free>g2</span> <span class=free>f2</span> <span class=free>x2</span> <span class=free>l2</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>l2</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>l1</span></span> <span class=quoted><span class=free>x1</span></span> <span class=quoted><span class=free>x2</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>a</span> <span class=skolem>l2</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>wlp <span class=free>R1</span> <span class=free>w1</span> <span class=free>g1</span> <span class=free>f1</span> <span class=skolem>x1</span> <span class=skolem>l2</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span>wlp <span class=free>R2</span> <span class=free>w2</span> <span class=free>g2</span> <span class=free>f2</span> <span class=skolem>x2</span> <span class=skolem>l2</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Cons
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> insert<span class=main>)</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>wlp <span class=free>R1</span> <span class=free>w1</span> <span class=free>g1</span> <span class=free>f1</span> <span class=skolem>a</span> <span class=skolem>l2</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span>wlp <span class=free>R2</span> <span class=free>w2</span> <span class=free>g2</span> <span class=free>f2</span> <span class=skolem>a</span> <span class=skolem>l2</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Cons
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> elem insert<span class=main>)</span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> Cons.prems<span class=main><span class=main>(</span></span>1<span class=main><span class=main>,</span></span>2<span class=main><span class=main>,</span></span> 6<span class=main><span class=main>)</span></span> elem<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span> <span class=operator>auto</span>


<span class=keyword1 id=Acyclicity-wlp_ite_weights><span class=command>lemma</span></span> wlp_ite_weights<span class=main>:</span> 
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>x</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>y</span><span class=main>.</span> ListMem <span class=bound>y</span> <span class=free>l1</span> <span class=main>⟶</span> <span class=free>P</span> <span class=bound>y</span>"</span></span> <span class=quoted><span class=quoted>"<span class=free>P</span> <span class=free>x</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>(</span>wlp <span class=free>R</span> <span class=main>(</span><span class=main>λ</span><span class=bound>y</span><span class=main>.</span> <span class=keyword1>if</span> <span class=free>P</span> <span class=bound>y</span> <span class=keyword1>then</span> <span class=free>w1</span> <span class=bound>y</span> <span class=keyword1>else</span> <span class=free>w2</span> <span class=bound>y</span><span class=main>)</span> <span class=free>g</span> <span class=free>f</span> <span class=free>x</span> <span class=free>l1</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span>wlp <span class=free>R</span> <span class=free>w1</span> <span class=free>g</span> <span class=free>f</span> <span class=free>x</span> <span class=free>l1</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms 

<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>l1</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>R</span></span> <span class=quoted><span class=free>P</span></span> <span class=quoted><span class=free>w1</span></span> <span class=quoted><span class=free>w2</span></span> <span class=quoted><span class=free>f</span></span> <span class=quoted><span class=free>g</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>a</span> <span class=skolem>l1</span><span class=main>)</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?w1</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>λ</span><span class=bound>y</span><span class=main>.</span> <span class=keyword1>if</span> <span class=skolem>P</span> <span class=bound>y</span> <span class=keyword1>then</span> <span class=skolem>w1</span> <span class=bound>y</span> <span class=keyword1>else</span> <span class=skolem>w2</span> <span class=bound>y</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?w2</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=skolem>w1</span>"</span></span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>y</span><span class=main>.</span> ListMem <span class=bound>y</span> <span class=skolem>l1</span> <span class=main>⟶</span> <span class=skolem>P</span> <span class=bound>y</span>"</span></span> 
      <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>1<span class=main>)</span> insert
      <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>(</span>wlp <span class=skolem>R</span> <span class=main>(</span><span class=main>λ</span><span class=bound>y</span><span class=main>.</span> <span class=keyword1>if</span> <span class=skolem>P</span> <span class=bound>y</span> <span class=keyword1>then</span> <span class=skolem>w1</span> <span class=bound>y</span> <span class=keyword1>else</span> <span class=skolem>w2</span> <span class=bound>y</span><span class=main>)</span> <span class=skolem>g</span> <span class=skolem>f</span> <span class=free>x</span> <span class=skolem>l1</span><span class=main>)</span> <span class=main>=</span> <span class=main>(</span>wlp <span class=skolem>R</span> <span class=skolem>w1</span> <span class=skolem>g</span> <span class=skolem>f</span> <span class=free>x</span> <span class=skolem>l1</span><span class=main>)</span><span class=main>)</span>"</span></span> 
      <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>2<span class=main>)</span> Cons.IH
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>note</span></span> 1 <span class=main>=</span> this
  <span class=keyword1><span class=command>{</span></span> 
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=keyword1>if</span> <span class=skolem>P</span> <span class=free>x</span> <span class=keyword1>then</span> <span class=skolem>w1</span> <span class=free>x</span> <span class=keyword1>else</span> <span class=skolem>w2</span> <span class=free>x</span><span class=main>)</span> <span class=main>=</span> <span class=skolem>w1</span> <span class=free>x</span>"</span></span> 
      <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>y1</span> <span class=bound>y2</span><span class=main>.</span> <span class=bound>y1</span> <span class=main>=</span> <span class=bound>y2</span> <span class=main>⟶</span> <span class=skolem>f</span> <span class=main>(</span><span class=keyword1>if</span> <span class=skolem>P</span> <span class=free>x</span> <span class=keyword1>then</span> <span class=skolem>w1</span> <span class=free>x</span> <span class=keyword1>else</span> <span class=skolem>w2</span> <span class=free>x</span><span class=main>)</span> <span class=bound>y1</span> <span class=main>=</span> <span class=skolem>f</span> <span class=main>(</span><span class=skolem>w1</span> <span class=free>x</span><span class=main>)</span> <span class=bound>y2</span>"</span></span>
      <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>y1</span> <span class=bound>y2</span> <span class=bound>z1</span> <span class=bound>z2</span><span class=main>.</span> 
        <span class=bound>y1</span> <span class=main>=</span> <span class=bound>y2</span> <span class=main>∧</span> <span class=bound>z1</span> <span class=main>=</span> <span class=bound>z2</span> 
        <span class=main>⟶</span> <span class=skolem>g</span> <span class=main>(</span><span class=skolem>f</span> <span class=main>(</span><span class=keyword1>if</span> <span class=skolem>P</span> <span class=free>x</span> <span class=keyword1>then</span> <span class=skolem>w1</span> <span class=free>x</span> <span class=keyword1>else</span> <span class=skolem>w2</span> <span class=free>x</span><span class=main>)</span> <span class=bound>y1</span><span class=main>)</span> <span class=bound>z1</span> <span class=main>=</span> <span class=skolem>g</span> <span class=main>(</span><span class=skolem>f</span> <span class=main>(</span><span class=skolem>w1</span> <span class=free>x</span><span class=main>)</span> <span class=bound>y2</span><span class=main>)</span> <span class=bound>z2</span>"</span></span>
      <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>x</span><span class=main>.</span> ListMem <span class=bound>x</span> <span class=main>(</span><span class=skolem>a</span> <span class=main>#</span> <span class=skolem>l1</span><span class=main>)</span> <span class=main>⟶</span> <span class=main>(</span><span class=keyword1>if</span> <span class=skolem>P</span> <span class=bound>x</span> <span class=keyword1>then</span> <span class=skolem>w1</span> <span class=bound>x</span> <span class=keyword1>else</span> <span class=skolem>w2</span> <span class=bound>x</span><span class=main>)</span> <span class=main>=</span> <span class=skolem>w1</span> <span class=bound>x</span>"</span></span>
      <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>x</span> <span class=bound>y</span> <span class=bound>z</span><span class=main>.</span> 
        ListMem <span class=bound>x</span> <span class=main>(</span><span class=skolem>a</span> <span class=main>#</span> <span class=skolem>l1</span><span class=main>)</span> 
        <span class=main>⟶</span> <span class=skolem>g</span> <span class=main>(</span><span class=skolem>f</span> <span class=main>(</span><span class=keyword1>if</span> <span class=skolem>P</span> <span class=bound>x</span> <span class=keyword1>then</span> <span class=skolem>w1</span> <span class=bound>x</span> <span class=keyword1>else</span> <span class=skolem>w2</span> <span class=bound>x</span><span class=main>)</span> <span class=bound>y</span><span class=main>)</span> <span class=bound>z</span> <span class=main>=</span> <span class=skolem>g</span> <span class=main>(</span><span class=skolem>f</span> <span class=main>(</span><span class=skolem>w1</span> <span class=bound>x</span><span class=main>)</span> <span class=bound>y</span><span class=main>)</span> <span class=bound>z</span>"</span></span>
      <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span>
        ListMem <span class=bound>x</span> <span class=main>(</span><span class=skolem>a</span> <span class=main>#</span> <span class=skolem>l1</span><span class=main>)</span> <span class=main>⟶</span> <span class=skolem>f</span> <span class=main>(</span><span class=keyword1>if</span> <span class=skolem>P</span> <span class=bound>x</span> <span class=keyword1>then</span> <span class=skolem>w1</span> <span class=bound>x</span> <span class=keyword1>else</span> <span class=skolem>w2</span> <span class=bound>x</span><span class=main>)</span> <span class=bound>y</span> <span class=main>=</span> <span class=skolem>f</span> <span class=main>(</span><span class=keyword1>if</span> <span class=skolem>P</span> <span class=bound>x</span> <span class=keyword1>then</span> <span class=skolem>w1</span> <span class=bound>x</span> <span class=keyword1>else</span> <span class=skolem>w2</span> <span class=bound>x</span><span class=main>)</span> <span class=bound>y</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>1<span class=main>,</span> 2<span class=main>)</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span><span class=main><span class=keyword3>+</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"wlp <span class=skolem>R</span> <span class=main>(</span><span class=main>λ</span><span class=bound>y</span><span class=main>.</span> <span class=keyword1>if</span> <span class=skolem>P</span> <span class=bound>y</span> <span class=keyword1>then</span> <span class=skolem>w1</span> <span class=bound>y</span> <span class=keyword1>else</span> <span class=skolem>w2</span> <span class=bound>y</span><span class=main>)</span> <span class=skolem>g</span> <span class=skolem>f</span> <span class=free>x</span> <span class=main>(</span><span class=skolem>a</span> <span class=main>#</span> <span class=skolem>l1</span><span class=main>)</span> <span class=main>=</span> wlp <span class=skolem>R</span> <span class=skolem>w1</span> <span class=skolem>g</span> <span class=skolem>f</span> <span class=free>x</span> <span class=main>(</span><span class=skolem>a</span> <span class=main>#</span> <span class=skolem>l1</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> Cons wlp_congruence_rule<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"<span class=skolem>a</span> <span class=main>#</span> <span class=skolem>l1</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a</span> <span class=main>#</span> <span class=skolem>l1</span>"</span></span> <span class=quoted><span class=skolem>R</span></span> <span class=quoted><span class=free>x</span></span> <span class=quoted><span class=skolem>R</span></span> <span class=quoted><span class=free>x</span></span> <span class=quoted><span class=quoted>"<span class=var>?w1</span>"</span></span> <span class=quoted><span class=quoted>"<span class=var>?w2</span>"</span></span> <span class=quoted><span class=skolem>f</span></span> <span class=quoted><span class=skolem>f</span></span> <span class=quoted><span class=skolem>g</span></span> <span class=quoted><span class=skolem>g</span></span><span class=main>]</span> 
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span> <span class=operator>auto</span>


<span class=keyword1 id=Acyclicity-map_wlp_ite_weights><span class=command>lemma</span></span> map_wlp_ite_weights<span class=main>:</span> <span class=quoted><span class=quoted>"
  <span class=main>(</span><span class=main>∀</span><span class=bound>x</span><span class=main>.</span> ListMem <span class=bound>x</span> <span class=free>l1</span> <span class=main>⟶</span> <span class=free>P</span> <span class=bound>x</span><span class=main>)</span> 
  <span class=main>⟹</span> <span class=main>(</span><span class=main>∀</span><span class=bound>x</span><span class=main>.</span> ListMem <span class=bound>x</span> <span class=free>l2</span> <span class=main>⟶</span> <span class=free>P</span> <span class=bound>x</span><span class=main>)</span> 
  <span class=main>⟹</span> <span class=main>(</span>
    map <span class=main>(</span><span class=main>λ</span><span class=bound>x</span><span class=main>.</span> wlp <span class=free>R</span> <span class=main>(</span><span class=main>λ</span><span class=bound>y</span><span class=main>.</span> <span class=keyword1>if</span> <span class=free>P</span> <span class=bound>y</span> <span class=keyword1>then</span> <span class=free>w1</span> <span class=bound>y</span> <span class=keyword1>else</span> <span class=free>w2</span> <span class=bound>y</span><span class=main>)</span> <span class=free>g</span> <span class=free>f</span> <span class=bound>x</span> <span class=free>l1</span><span class=main>)</span> <span class=free>l2</span> 
    <span class=main>=</span> map <span class=main>(</span><span class=main>λ</span><span class=bound>x</span><span class=main>.</span> wlp <span class=free>R</span> <span class=free>w1</span> <span class=free>g</span> <span class=free>f</span> <span class=bound>x</span> <span class=free>l1</span><span class=main>)</span> <span class=free>l2</span>
  <span class=main>)</span>
"</span></span>
  <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>l2</span></span><span class=main>)</span>
   <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>auto</span><span class=main>)</span>
  <span class=keyword1><span class=command><span class=improper><span class=command>subgoal</span></span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> elem wlp_congruence_rule<span class=main>)</span>
  <span class=keyword1><span class=command><span class=improper><span class=command>subgoal</span></span></span></span> <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> insert<span class=main>)</span>
  <span class=keyword1><span class=command><span class=improper><span class=command>done</span></span></span></span>


<span class=keyword1 id=Acyclicity-wlp_weight_lamda_exp><span class=command>lemma</span></span> wlp_weight_lamda_exp<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>⋀</span><span class=bound>x</span><span class=main>.</span> wlp <span class=free>R</span> <span class=free>w</span> <span class=free>g</span> <span class=free>f</span> <span class=bound>x</span> <span class=free>l</span> <span class=main>=</span> wlp <span class=free>R</span> <span class=main>(</span><span class=main>λ</span><span class=bound>y</span><span class=main>.</span> <span class=free>w</span> <span class=bound>y</span><span class=main>)</span> <span class=free>g</span> <span class=free>f</span> <span class=bound>x</span> <span class=free>l</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword3><span class=command>fix</span></span> <span class=skolem>x</span>
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"wlp <span class=free>R</span> <span class=free>w</span> <span class=free>g</span> <span class=free>f</span> <span class=skolem>x</span> <span class=free>l</span> <span class=main>=</span> wlp <span class=free>R</span> <span class=main>(</span><span class=main>λ</span><span class=bound>y</span><span class=main>.</span> <span class=free>w</span> <span class=bound>y</span><span class=main>)</span> <span class=free>g</span> <span class=free>f</span> <span class=skolem>x</span> <span class=free>l</span>"</span></span> 
    <span class=keyword1><span class=command>by</span></span><span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>l</span></span><span class=main>)</span> <span class=operator>auto</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1 id=Acyclicity-img_wlp_ite_weights><span class=command>lemma</span></span> img_wlp_ite_weights<span class=main>:</span> <span class=quoted><span class=quoted>"
  <span class=main>(</span><span class=main>∀</span><span class=bound>x</span><span class=main>.</span> ListMem <span class=bound>x</span> <span class=free>l</span> <span class=main>⟶</span> <span class=free>P</span> <span class=bound>x</span><span class=main>)</span> 
  <span class=main>⟹</span> <span class=main>(</span><span class=main>∀</span><span class=bound>x</span><span class=main>.</span> <span class=bound>x</span> <span class=main>∈</span> <span class=free>s</span> <span class=main>⟶</span> <span class=free>P</span> <span class=bound>x</span><span class=main>)</span> 
  <span class=main>⟹</span> <span class=main>(</span>
    <span class=main>(</span><span class=main>λ</span><span class=bound>x</span><span class=main>.</span> wlp <span class=free>R</span> <span class=main>(</span><span class=main>λ</span><span class=bound>y</span><span class=main>.</span> <span class=keyword1>if</span> <span class=free>P</span> <span class=bound>y</span> <span class=keyword1>then</span> <span class=free>w1</span> <span class=bound>y</span> <span class=keyword1>else</span> <span class=free>w2</span> <span class=bound>y</span><span class=main>)</span> <span class=free>g</span> <span class=free>f</span> <span class=bound>x</span> <span class=free>l</span><span class=main>)</span> <span class=main>`</span> <span class=free>s</span> 
    <span class=main>=</span> <span class=main>(</span><span class=main>λ</span><span class=bound>x</span><span class=main>.</span> wlp <span class=free>R</span> <span class=free>w1</span> <span class=free>g</span> <span class=free>f</span> <span class=bound>x</span> <span class=free>l</span><span class=main>)</span> <span class=main>`</span> <span class=free>s</span>
  <span class=main>)</span>
"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword3><span class=command>assume</span></span> P1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>x</span><span class=main>.</span> ListMem <span class=bound>x</span> <span class=free>l</span> <span class=main>⟶</span> <span class=free>P</span> <span class=bound>x</span>"</span></span>
  <span class=keyword3><span class=command>assume</span></span> P2<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>x</span><span class=main>.</span> <span class=bound>x</span> <span class=main>∈</span> <span class=free>s</span> <span class=main>⟶</span> <span class=free>P</span> <span class=bound>x</span>"</span></span>
  <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>
    <span class=main>(</span><span class=main>λ</span><span class=bound>x</span><span class=main>.</span> wlp <span class=free>R</span> <span class=main>(</span><span class=main>λ</span><span class=bound>y</span><span class=main>.</span> <span class=keyword1>if</span> <span class=free>P</span> <span class=bound>y</span> <span class=keyword1>then</span> <span class=free>w1</span> <span class=bound>y</span> <span class=keyword1>else</span> <span class=free>w2</span> <span class=bound>y</span><span class=main>)</span> <span class=free>g</span> <span class=free>f</span> <span class=bound>x</span> <span class=free>l</span><span class=main>)</span> <span class=main>`</span> <span class=free>s</span> 
    <span class=main>=</span> <span class=main>(</span><span class=main>λ</span><span class=bound>x</span><span class=main>.</span> wlp <span class=free>R</span> <span class=free>w1</span> <span class=free>g</span> <span class=free>f</span> <span class=bound>x</span> <span class=free>l</span><span class=main>)</span> <span class=main>`</span> <span class=free>s</span>
  <span class=main>)</span>"</span></span> 
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>auto</span> <span class=quasi_keyword>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span>  P1 P2 image_iff wlp_ite_weights<span class=main>)</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword2><span class=keyword>end</span></span></pre>
</div><div id=AcycSspace>
<div class=head>
<h1>Theory AcycSspace</h1>
</div>
<pre class=source><span class=keyword1><span class=command>theory</span></span> AcycSspace
  <span class=keyword2><span class=keyword>imports</span></span>
    <a href=#FactoredSystem>FactoredSystem</a>
    <a href=#ActionSeqProcess>ActionSeqProcess</a>
    <a href=#SystemAbstraction>SystemAbstraction</a>
    <a href=#Acyclicity>Acyclicity</a>
    <a href=#FmapUtils>FmapUtils</a>
<span class=keyword2><span class=keyword>begin</span></span>


<span class=keyword1><span class=command>section</span></span> <span class=quoted><span class=plain_text>"Acyclic State Spaces"</span></span>


<span class=comment1>― ‹NOTE name shortened.›</span>
<span class=comment1>― ‹NOTE type for `max` had to be fixed to natural number maximum (due to problem with loose
typing).›</span>
<span class=keyword1><span class=command>value</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>state_successors <span class=main>(</span>prob_proj <span class=free>PROB</span> <span class=free>vs</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>definition</span></span> <span class=entity>S</span>
  <span class=keyword2><span class=keyword>where</span></span> <span class=quoted><span class=quoted>"<span class=free>S</span> <span class=free><span class=bound><span class=entity>vs</span></span></span> <span class=free><span class=bound><span class=entity>lss</span></span></span> <span class=free><span class=bound><span class=entity>PROB</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=main>≡</span> wlp
    <span class=main>(</span><span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=bound>y</span> <span class=main>∈</span> <span class=main>(</span>state_successors <span class=main>(</span>prob_proj <span class=free><span class=bound><span class=entity>PROB</span></span></span> <span class=free><span class=bound><span class=entity>vs</span></span></span><span class=main>)</span> <span class=bound>x</span><span class=main>)</span><span class=main>)</span>
    <span class=main>(</span><span class=main>λ</span><span class=bound>s</span><span class=main>.</span> problem_plan_bound <span class=main>(</span>snapshot <span class=free><span class=bound><span class=entity>PROB</span></span></span> <span class=bound>s</span><span class=main>)</span><span class=main>)</span>
    <span class=main>(</span>max <span class=main>::</span> nat <span class=main>⇒</span> nat <span class=main>⇒</span> nat<span class=main>)</span> <span class=main>(</span><span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=bound>x</span> <span class=main>+</span> <span class=bound>y</span> <span class=main>+</span> <span class=main>1</span><span class=main>)</span> <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=free><span class=bound><span class=entity>lss</span></span></span>
  "</span></span>

<span class=comment1>― ‹NOTE name shortened.›</span>
<span class=comment1>― ‹NOTE using `fun` because of multiple defining equations.›</span>
<span class=keyword1><span class=command>fun</span></span> <span class=entity>vars_change</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>vars_change</span> <span class=main>[]</span> <span class=free><span class=bound><span class=entity>vs</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=main>=</span> <span class=main>[]</span>"</span></span>
<span class=main>|</span> <span class=quoted><span class=quoted>"<span class=free>vars_change</span> <span class=main>(</span><span class=free><span class=bound><span class=entity>a</span></span></span> <span class=main>#</span> <span class=free><span class=bound><span class=entity>as</span></span></span><span class=main>)</span> <span class=free><span class=bound><span class=entity>vs</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=main>=</span> <span class=main>(</span><span class=keyword1>if</span> fmrestrict_set <span class=free><span class=bound><span class=entity>vs</span></span></span> <span class=main>(</span>state_succ <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=free><span class=bound><span class=entity>a</span></span></span><span class=main>)</span> <span class=main>≠</span> fmrestrict_set <span class=free><span class=bound><span class=entity>vs</span></span></span> <span class=free><span class=bound><span class=entity>s</span></span></span>
    <span class=keyword1>then</span> state_succ <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=free><span class=bound><span class=entity>a</span></span></span> <span class=main>#</span> <span class=free>vars_change</span> <span class=free><span class=bound><span class=entity>as</span></span></span> <span class=free><span class=bound><span class=entity>vs</span></span></span> <span class=main>(</span>state_succ <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=free><span class=bound><span class=entity>a</span></span></span><span class=main>)</span>
    <span class=keyword1>else</span> <span class=free>vars_change</span> <span class=free><span class=bound><span class=entity>as</span></span></span> <span class=free><span class=bound><span class=entity>vs</span></span></span> <span class=main>(</span>state_succ <span class=free><span class=bound><span class=entity>s</span></span></span> <span class=free><span class=bound><span class=entity>a</span></span></span><span class=main>)</span>
  <span class=main>)</span>"</span></span>


<span class=keyword1 id=AcycSspace-vars_change_cat><span class=command>lemma</span></span> vars_change_cat<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>s</span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"
    vars_change <span class=main>(</span><span class=free>as1</span> <span class=main>@</span> <span class=free>as2</span><span class=main>)</span> <span class=free>vs</span> <span class=free>s</span>
    <span class=main>=</span> <span class=main>(</span>vars_change <span class=free>as1</span> <span class=free>vs</span> <span class=free>s</span> <span class=main>@</span> vars_change <span class=free>as2</span> <span class=free>vs</span> <span class=main>(</span>exec_plan <span class=free>s</span> <span class=free>as1</span><span class=main>)</span><span class=main>)</span>
  "</span></span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>as1</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>s</span></span> <span class=quoted><span class=free>as2</span></span> <span class=quoted><span class=free>vs</span></span><span class=main>)</span> <span class=operator>auto</span>


<span class=keyword1 id=AcycSspace-empty_change_no_change><span class=command>lemma</span></span> empty_change_no_change<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>s</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>vars_change <span class=free>as</span> <span class=free>vs</span> <span class=free>s</span> <span class=main>=</span> <span class=main>[]</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=main>(</span>exec_plan <span class=free>s</span> <span class=free>as</span><span class=main>)</span> <span class=main>=</span> fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>as</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>s</span></span> <span class=quoted><span class=free>vs</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>a</span> <span class=skolem>as</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"fmrestrict_set <span class=skolem>vs</span> <span class=main>(</span>state_succ <span class=skolem>s</span> <span class=skolem>a</span><span class=main>)</span> <span class=main>≠</span> fmrestrict_set <span class=skolem>vs</span> <span class=skolem>s</span>"</span></span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> True
      <span class=comment1>― ‹NOTE This case violates the induction premise <span class=antiquoted><span class=antiquote>@{</span><span class=operator>term</span> <span class=quoted>"vars_change <span class=main>(</span><span class=skolem>a</span> <span class=main>#</span> <span class=skolem>as</span><span class=main>)</span> <span class=skolem>vs</span> <span class=skolem>s</span> <span class=main>=</span> <span class=main>[]</span>"</span><span class=antiquote>}</span></span> since the
        empty list is impossible.›</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"state_succ <span class=skolem>s</span> <span class=skolem>a</span> <span class=main>#</span> vars_change <span class=skolem>as</span> <span class=skolem>vs</span> <span class=main>(</span>state_succ <span class=skolem>s</span> <span class=skolem>a</span><span class=main>)</span> <span class=main>=</span> <span class=main>[]</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> Cons.prems True
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"fmrestrict_set <span class=skolem>vs</span> <span class=main>(</span>exec_plan <span class=skolem>s</span> <span class=main>(</span><span class=skolem>a</span> <span class=main>#</span> <span class=skolem>as</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> fmrestrict_set <span class=skolem>vs</span> <span class=skolem>s</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> False
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"vars_change <span class=skolem>as</span> <span class=skolem>vs</span> <span class=main>(</span>state_succ <span class=skolem>s</span> <span class=skolem>a</span><span class=main>)</span> <span class=main>=</span> <span class=main>[]</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> Cons.prems False
      <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span>
      <span class=quoted><span class=quoted>"fmrestrict_set <span class=skolem>vs</span> <span class=main>(</span>exec_plan <span class=main>(</span>state_succ <span class=skolem>s</span> <span class=skolem>a</span><span class=main>)</span> <span class=skolem>as</span><span class=main>)</span> <span class=main>=</span> fmrestrict_set <span class=skolem>vs</span> <span class=main>(</span>state_succ <span class=skolem>s</span> <span class=skolem>a</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> Cons.IH<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=skolem>vs</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>state_succ <span class=skolem>s</span> <span class=skolem>a</span><span class=main>)</span>"</span></span><span class=main>]</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"fmrestrict_set <span class=skolem>vs</span> <span class=main>(</span>exec_plan <span class=skolem>s</span> <span class=main>(</span><span class=skolem>a</span> <span class=main>#</span> <span class=skolem>as</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> fmrestrict_set <span class=skolem>vs</span> <span class=skolem>s</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> False
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>qed</span></span> <span class=operator>auto</span>


<span class=comment1>― ‹NOTE renamed variable `a` to `b` to not conflict with naming for list head in induction step.›</span>
<span class=keyword1 id=AcycSspace-zero_change_imp_all_effects_submap><span class=command>lemma</span></span> zero_change_imp_all_effects_submap<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>s</span> <span class=free>s'</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>vars_change <span class=free>as</span> <span class=free>vs</span> <span class=free>s</span> <span class=main>=</span> <span class=main>[]</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>sat_precond_as <span class=free>s</span> <span class=free>as</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>ListMem <span class=free>b</span> <span class=free>as</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span> <span class=main>=</span> fmrestrict_set <span class=free>vs</span> <span class=free>s'</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=main>(</span>snd <span class=free>b</span><span class=main>)</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> fmrestrict_set <span class=free>vs</span> <span class=free>s'</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>as</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>s</span></span> <span class=quoted><span class=free>s'</span></span> <span class=quoted><span class=free>vs</span></span> <span class=quoted><span class=free>b</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>a</span> <span class=skolem>as</span><span class=main>)</span>
    <span class=comment1>― ‹NOTE Having either <span class=antiquoted><span class=antiquote>@{</span><span class=operator>term</span> <span class=quoted>"fmrestrict_set <span class=skolem>vs</span> <span class=main>(</span>state_succ <span class=skolem>s</span> <span class=skolem>a</span><span class=main>)</span> <span class=main>≠</span> fmrestrict_set <span class=skolem>vs</span> <span class=skolem>s</span>"</span><span class=antiquote>}</span></span> or
    <span class=antiquoted><span class=antiquote>@{</span><span class=operator>term</span> <span class=quoted>"<span class=main>¬</span>ListMem <span class=skolem>b</span> <span class=skolem>as</span>"</span><span class=antiquote>}</span></span> leads to simpler propositions so we split here.›</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>fmrestrict_set <span class=skolem>vs</span> <span class=main>(</span>snd <span class=skolem>b</span><span class=main>)</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> fmrestrict_set <span class=skolem>vs</span> <span class=skolem>s'</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>1<span class=main>)</span>
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"fmrestrict_set <span class=skolem>vs</span> <span class=main>(</span>state_succ <span class=skolem>s</span> <span class=skolem>a</span><span class=main>)</span> <span class=main>=</span> fmrestrict_set <span class=skolem>vs</span> <span class=skolem>s</span> <span class=main>∧</span> ListMem <span class=skolem>b</span> <span class=skolem>as</span>"</span></span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> True
    <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?s</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"state_succ <span class=skolem>s</span> <span class=skolem>a</span>"</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"vars_change <span class=skolem>as</span> <span class=skolem>vs</span> <span class=var>?s</span> <span class=main>=</span> <span class=main>[]</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> True Cons.prems<span class=main>(</span>1<span class=main>)</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"sat_precond_as <span class=var>?s</span> <span class=skolem>as</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>2<span class=main>)</span> sat_precond_as.simps<span class=main>(</span>2<span class=main>)</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>using</span></span> True Cons.prems<span class=main>(</span>4<span class=main>)</span> Cons.IH
      <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> False
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>consider</span></span>
      <span class=main>(</span>i<span class=main>)</span> <span class=quoted><span class=quoted>"fmrestrict_set <span class=skolem>vs</span> <span class=main>(</span>state_succ <span class=skolem>s</span> <span class=skolem>a</span><span class=main>)</span> <span class=main>≠</span> fmrestrict_set <span class=skolem>vs</span> <span class=skolem>s</span>"</span></span>
      <span class=main>|</span> <span class=main>(</span>ii<span class=main>)</span> <span class=quoted><span class=quoted>"<span class=main>¬</span>ListMem <span class=skolem>b</span> <span class=skolem>as</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>1<span class=main>)</span>
    <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span><span class=main>)</span>
      <span class=keyword3><span class=command>case</span></span> ii
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a</span> <span class=main>=</span> <span class=skolem>b</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>3<span class=main>)</span> ListMem_iff set_ConsD
        <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
          <span class=comment1>― ‹NOTE Mysteriously sledgehammer finds a proof here while the premises of
            `no\_change\_vs\_eff\_submap` cannot be proven individually.›</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
        <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>1<span class=main>,</span> 2<span class=main>,</span> 4<span class=main>)</span> no_change_vs_eff_submap
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> list.distinct<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span> sat_precond_as.simps<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span> vars_change.simps<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span><span class=main>)</span>
    <span class=keyword1><span class=command>qed</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>qed</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> ListMem_iff<span class=main>)</span>


<span class=keyword1 id=AcycSspace-zero_change_imp_all_preconds_submap><span class=command>lemma</span></span> zero_change_imp_all_preconds_submap<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>s</span> <span class=free>s'</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>vars_change <span class=free>as</span> <span class=free>vs</span> <span class=free>s</span> <span class=main>=</span> <span class=main>[]</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>sat_precond_as <span class=free>s</span> <span class=free>as</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>ListMem <span class=free>b</span> <span class=free>as</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span> <span class=main>=</span> fmrestrict_set <span class=free>vs</span> <span class=free>s'</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=main>(</span>fst <span class=free>b</span><span class=main>)</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> fmrestrict_set <span class=free>vs</span> <span class=free>s'</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>as</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>vs</span></span> <span class=quoted><span class=free>s</span></span> <span class=quoted><span class=free>s'</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>a</span> <span class=skolem>as</span><span class=main>)</span>
    <span class=comment1>― ‹NOTE Having either <span class=antiquoted><span class=antiquote>@{</span><span class=operator>term</span> <span class=quoted>"fmrestrict_set <span class=skolem>vs</span> <span class=main>(</span>state_succ <span class=skolem>s</span> <span class=skolem>a</span><span class=main>)</span> <span class=main>≠</span> fmrestrict_set <span class=skolem>vs</span> <span class=skolem>s</span>"</span><span class=antiquote>}</span></span> or
    <span class=antiquoted><span class=antiquote>@{</span><span class=operator>term</span> <span class=quoted>"<span class=main>¬</span>ListMem <span class=free>b</span> <span class=skolem>as</span>"</span><span class=antiquote>}</span></span> leads to simpler propositions so we split here.›</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>fmrestrict_set <span class=skolem>vs</span> <span class=main>(</span>fst <span class=free>b</span><span class=main>)</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> fmrestrict_set <span class=skolem>vs</span> <span class=skolem>s'</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>1<span class=main>)</span>
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"fmrestrict_set <span class=skolem>vs</span> <span class=main>(</span>state_succ <span class=skolem>s</span> <span class=skolem>a</span><span class=main>)</span> <span class=main>=</span> fmrestrict_set <span class=skolem>vs</span> <span class=skolem>s</span> <span class=main>∧</span> ListMem <span class=free>b</span> <span class=skolem>as</span>"</span></span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> True
    <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?s</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"state_succ <span class=skolem>s</span> <span class=skolem>a</span>"</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"vars_change <span class=skolem>as</span> <span class=skolem>vs</span> <span class=var>?s</span> <span class=main>=</span> <span class=main>[]</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> True Cons.prems<span class=main>(</span>1<span class=main>)</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"sat_precond_as <span class=var>?s</span> <span class=skolem>as</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>2<span class=main>)</span> sat_precond_as.simps<span class=main>(</span>2<span class=main>)</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>using</span></span> True Cons.prems<span class=main>(</span>4<span class=main>)</span> Cons.IH
      <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> False
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>consider</span></span>
      <span class=main>(</span>i<span class=main>)</span> <span class=quoted><span class=quoted>"fmrestrict_set <span class=skolem>vs</span> <span class=main>(</span>state_succ <span class=skolem>s</span> <span class=skolem>a</span><span class=main>)</span> <span class=main>≠</span> fmrestrict_set <span class=skolem>vs</span> <span class=skolem>s</span>"</span></span>
      <span class=main>|</span> <span class=main>(</span>ii<span class=main>)</span> <span class=quoted><span class=quoted>"<span class=main>¬</span>ListMem <span class=free>b</span> <span class=skolem>as</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>1<span class=main>)</span>
    <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span><span class=main>)</span>
      <span class=keyword3><span class=command>case</span></span> ii
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a</span> <span class=main>=</span> <span class=free>b</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>3<span class=main>)</span> ListMem_iff set_ConsD
        <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
        <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>2<span class=main>,</span> 4<span class=main>)</span> fmsubset_restrict_set_mono
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> sat_precond_as.simps<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span><span class=main>)</span>
    <span class=keyword1><span class=command>qed</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>qed</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> ListMem_iff<span class=main>)</span>


<span class=keyword1 id=AcycSspace-no_vs_change_valid_in_snapshot><span class=command>lemma</span></span> no_vs_change_valid_in_snapshot<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>sat_precond_as <span class=free>s</span> <span class=free>as</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>vars_change <span class=free>as</span> <span class=free>vs</span> <span class=free>s</span> <span class=main>=</span> <span class=main>[]</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>as</span> <span class=main>∈</span> valid_plans <span class=main>(</span>snapshot <span class=free>PROB</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>a</span>
    <span class=keyword3><span class=command>assume</span></span> P<span class=main>:</span> <span class=quoted><span class=quoted>"ListMem <span class=skolem>a</span> <span class=free>as</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"agree <span class=main>(</span>fst <span class=skolem>a</span><span class=main>)</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> agree_imp_submap assms<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span> assms<span class=main><span class=main>(</span></span>3<span class=main><span class=main>)</span></span> fmdom'_restrict_set
          restricted_agree_imp_agree zero_change_imp_all_preconds_submap<span class=main>)</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"agree <span class=main>(</span>snd <span class=skolem>a</span><span class=main>)</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> <span class=main><span class=main>(</span></span>no_types<span class=main><span class=main>)</span></span> P agree_imp_submap assms<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span> assms<span class=main><span class=main>(</span></span>3<span class=main><span class=main>)</span></span> fmdom'_restrict_set
          restricted_agree_imp_agree zero_change_imp_all_effects_submap<span class=main>)</span>
    <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"agree <span class=main>(</span>fst <span class=skolem>a</span><span class=main>)</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"agree <span class=main>(</span>snd <span class=skolem>a</span><span class=main>)</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span><span class=main><span class=keyword3>+</span></span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>)</span> as_mem_agree_valid_in_snapshot
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=comment1>― ‹NOTE type of `PROB` had to be fixed for `problem\_plan\_bound\_works`.›</span>
<span class=keyword1 id=AcycSspace-no_vs_change_obtain_snapshot_bound_1st_step><span class=command>lemma</span></span> no_vs_change_obtain_snapshot_bound_1st_step<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> problem"</span></span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"finite <span class=free>PROB</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>vars_change <span class=free>as</span> <span class=free>vs</span> <span class=free>s</span> <span class=main>=</span> <span class=main>[]</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>sat_precond_as <span class=free>s</span> <span class=free>as</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>s</span> <span class=main>∈</span> valid_states <span class=free>PROB</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>as'</span><span class=main>.</span>
    <span class=main>(</span>
      exec_plan <span class=main>(</span>fmrestrict_set <span class=main>(</span>prob_dom <span class=main>(</span>snapshot <span class=free>PROB</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=free>s</span><span class=main>)</span> <span class=free>as</span>
      <span class=main>=</span> exec_plan <span class=main>(</span>fmrestrict_set <span class=main>(</span>prob_dom <span class=main>(</span>snapshot <span class=free>PROB</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=free>s</span><span class=main>)</span> <span class=bound>as'</span>
    <span class=main>)</span>
    <span class=main>∧</span> <span class=main>(</span>subseq <span class=bound>as'</span> <span class=free>as</span><span class=main>)</span>
    <span class=main>∧</span> <span class=main>(</span>length <span class=bound>as'</span> <span class=main>≤</span> problem_plan_bound <span class=main>(</span>snapshot <span class=free>PROB</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>
  <span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?s</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>(</span>fmrestrict_set <span class=main>(</span>prob_dom <span class=main>(</span>snapshot <span class=free>PROB</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=free>s</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?PROB</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>(</span>snapshot <span class=free>PROB</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"finite <span class=main>(</span>snapshot <span class=free>PROB</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>)</span> FINITE_snapshot
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>{</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"
      fmrestrict_set <span class=main>(</span>prob_dom <span class=main>(</span>snapshot <span class=free>PROB</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=free>s</span>
      <span class=main>∈</span> valid_states <span class=main>(</span>snapshot <span class=free>PROB</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>4<span class=main>)</span> graph_plan_not_eq_last_diff_paths valid_states_snapshot
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>{</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=free>as</span> <span class=main>∈</span> valid_plans <span class=main>(</span>snapshot <span class=free>PROB</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>2<span class=main>,</span> 3<span class=main>,</span> 5<span class=main>)</span> no_vs_change_valid_in_snapshot
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>using</span></span> problem_plan_bound_works<span class=main>[</span><span class=operator>of</span> <span class=var><span class=quoted><span class=var>?PROB</span></span></span> <span class=var><span class=quoted><span class=var>?s</span></span></span> <span class=quoted><span class=free>as</span></span><span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=comment1>― ‹NOTE type of `PROB` had to be fixed for `no\_vs\_change\_obtain\_snapshot\_bound\_1st\_step`.›</span>
<span class=keyword1 id=AcycSspace-no_vs_change_obtain_snapshot_bound_2nd_step><span class=command>lemma</span></span> no_vs_change_obtain_snapshot_bound_2nd_step<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> problem"</span></span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"finite <span class=free>PROB</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>vars_change <span class=free>as</span> <span class=free>vs</span> <span class=free>s</span> <span class=main>=</span> <span class=main>[]</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>sat_precond_as <span class=free>s</span> <span class=free>as</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>s</span> <span class=main>∈</span> valid_states <span class=free>PROB</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>as'</span><span class=main>.</span>
    <span class=main>(</span>
      exec_plan <span class=main>(</span>fmrestrict_set <span class=main>(</span>prob_dom <span class=main>(</span>snapshot <span class=free>PROB</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>  <span class=free>s</span><span class=main>)</span> <span class=free>as</span>
      <span class=main>=</span> exec_plan <span class=main>(</span>fmrestrict_set <span class=main>(</span>prob_dom <span class=main>(</span>snapshot <span class=free>PROB</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=free>s</span><span class=main>)</span> <span class=bound>as'</span>
    <span class=main>)</span>
    <span class=main>∧</span> <span class=main>(</span>subseq <span class=bound>as'</span> <span class=free>as</span><span class=main>)</span>
    <span class=main>∧</span> <span class=main>(</span>sat_precond_as <span class=free>s</span> <span class=bound>as'</span><span class=main>)</span>
    <span class=main>∧</span> <span class=main>(</span>length <span class=bound>as'</span> <span class=main>≤</span> problem_plan_bound <span class=main>(</span>snapshot <span class=free>PROB</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>
  <span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>as''</span></span> <span class=keyword2><span class=keyword>where</span></span> 1<span class=main>:</span>
    <span class=quoted><span class=quoted>"
      exec_plan <span class=main>(</span>fmrestrict_set <span class=main>(</span>prob_dom <span class=main>(</span>snapshot <span class=free>PROB</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=free>s</span><span class=main>)</span> <span class=free>as</span>
      <span class=main>=</span> exec_plan <span class=main>(</span>fmrestrict_set <span class=main>(</span>prob_dom <span class=main>(</span>snapshot <span class=free>PROB</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=free>s</span><span class=main>)</span> <span class=skolem>as''</span>"</span></span>
    <span class=quoted><span class=quoted>"subseq <span class=skolem>as''</span> <span class=free>as</span>"</span></span> <span class=quoted><span class=quoted>"length <span class=skolem>as''</span> <span class=main>≤</span> problem_plan_bound <span class=main>(</span>snapshot <span class=free>PROB</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms no_vs_change_obtain_snapshot_bound_1st_step
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?s'</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>(</span>fmrestrict_set <span class=main>(</span>prob_dom <span class=main>(</span>snapshot <span class=free>PROB</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=free>s</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?as'</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"rem_condless_act <span class=var>?s'</span> <span class=main>[]</span> <span class=skolem>as''</span>"</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"exec_plan <span class=var>?s'</span> <span class=free>as</span> <span class=main>=</span> exec_plan <span class=var>?s'</span> <span class=skolem>as''</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> 1<span class=main>(</span>1<span class=main>)</span> rem_condless_valid_1
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"subseq <span class=var>?as'</span> <span class=free>as</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> 1<span class=main>(</span>2<span class=main>)</span> rem_condless_valid_8 sublist_trans
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"sat_precond_as <span class=free>s</span> <span class=var>?as'</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> sat_precond_drest_sat_precond rem_condless_valid_2
    <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>length <span class=var>?as'</span> <span class=main>≤</span> problem_plan_bound <span class=main>(</span>snapshot <span class=free>PROB</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> 1 rem_condless_valid_3 le_trans
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>using</span></span> 1 rem_condless_valid_1
    <span class=keyword1><span class=command>by</span></span> <span class=operator>auto</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1 id=AcycSspace-no_vs_change_obtain_snapshot_bound_3rd_step><span class=command>lemma</span></span> no_vs_change_obtain_snapshot_bound_3rd_step<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"finite <span class=main>(</span><span class=free>PROB</span> <span class=main>::</span> <span class=tfree>'a</span> problem<span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>vars_change <span class=free>as</span> <span class=free>vs</span> <span class=free>s</span> <span class=main>=</span> <span class=main>[]</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>no_effectless_act <span class=free>as</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span>sat_precond_as <span class=free>s</span> <span class=free>as</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>s</span> <span class=main>∈</span> valid_states <span class=free>PROB</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>as'</span><span class=main>.</span>
    <span class=main>(</span>
      fmrestrict_set <span class=main>(</span>prob_dom <span class=main>(</span>snapshot <span class=free>PROB</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>exec_plan <span class=free>s</span> <span class=free>as</span><span class=main>)</span>
      <span class=main>=</span> fmrestrict_set <span class=main>(</span>prob_dom <span class=main>(</span>snapshot <span class=free>PROB</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>exec_plan <span class=free>s</span> <span class=bound>as'</span><span class=main>)</span>
    <span class=main>)</span>
    <span class=main>∧</span> <span class=main>(</span>subseq <span class=bound>as'</span> <span class=free>as</span><span class=main>)</span>
    <span class=main>∧</span> <span class=main>(</span>length <span class=bound>as'</span> <span class=main>≤</span> problem_plan_bound <span class=main>(</span>snapshot <span class=free>PROB</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>
  <span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>as'</span></span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>(</span><span class=tfree>'a</span><span class=main>,</span> bool<span class=main>)</span> fmap <span class=main>×</span> <span class=main>(</span><span class=tfree>'a</span><span class=main>,</span> bool<span class=main>)</span> fmap<span class=main>)</span> list"</span></span> <span class=keyword2><span class=keyword>where</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span>
      exec_plan <span class=main>(</span>fmrestrict_set <span class=main>(</span>prob_dom <span class=main>(</span>snapshot <span class=free>PROB</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=free>s</span><span class=main>)</span> <span class=free>as</span>
      <span class=main>=</span> exec_plan <span class=main>(</span>fmrestrict_set <span class=main>(</span>prob_dom <span class=main>(</span>snapshot <span class=free>PROB</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=free>s</span><span class=main>)</span> <span class=skolem>as'</span>
    <span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"subseq <span class=skolem>as'</span> <span class=free>as</span>"</span></span> <span class=quoted><span class=quoted>"sat_precond_as <span class=free>s</span> <span class=skolem>as'</span>"</span></span>
    <span class=quoted><span class=quoted>"length <span class=skolem>as'</span> <span class=main>≤</span> problem_plan_bound <span class=main>(</span>snapshot <span class=free>PROB</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>,</span> 2<span class=main>,</span> 4<span class=main>,</span> 5<span class=main>,</span> 6<span class=main>)</span> no_vs_change_obtain_snapshot_bound_2nd_step
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span>
    <span class=quoted><span class=quoted>"exec_plan <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span> <span class=main>(</span>as_proj <span class=free>as</span> <span class=free>vs</span><span class=main>)</span> <span class=main>=</span> fmrestrict_set <span class=free>vs</span> <span class=main>(</span>exec_plan <span class=free>s</span> <span class=free>as</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>4<span class=main>)</span> sat_precond_exec_as_proj_eq_proj_exec
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"as_proj <span class=free>as</span> <span class=main>(</span>prob_dom <span class=main>(</span>snapshot <span class=free>PROB</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>=</span> <span class=free>as</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>2<span class=main>,</span> 3<span class=main>,</span> 4<span class=main>,</span> 6<span class=main>)</span> as_proj_eq_as no_vs_change_valid_in_snapshot
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>using</span></span> sublist_as_proj_eq_as proj_exec_proj_eq_exec_proj'
    <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=comment1>― ‹NOTE added lemma.›</span>
<span class=comment1>― ‹TODO remove unused assumptions.›</span>
<span class=keyword1 id=AcycSspace-no_vs_change_snapshot_s_vs_is_valid_bound_i><span class=command>lemma</span></span> no_vs_change_snapshot_s_vs_is_valid_bound_i<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> problem"</span></span>
  <span class=keyword2><span class=keyword>assumes</span></span>  <span class=quoted><span class=quoted>"finite <span class=free>PROB</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>vars_change <span class=free>as</span> <span class=free>vs</span> <span class=free>s</span> <span class=main>=</span> <span class=main>[]</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>no_effectless_act <span class=free>as</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span>sat_precond_as <span class=free>s</span> <span class=free>as</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>s</span> <span class=main>∈</span> valid_states <span class=free>PROB</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"fmrestrict_set <span class=main>(</span>prob_dom <span class=main>(</span>snapshot <span class=free>PROB</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>exec_plan <span class=free>s</span> <span class=free>as</span><span class=main>)</span> <span class=main>=</span>
        fmrestrict_set <span class=main>(</span>prob_dom <span class=main>(</span>snapshot <span class=free>PROB</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>exec_plan <span class=free>s</span> <span class=free>as'</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"subseq <span class=free>as'</span> <span class=free>as</span>"</span></span> <span class=quoted><span class=quoted>"length <span class=free>as'</span> <span class=main>≤</span> problem_plan_bound <span class=main>(</span>snapshot <span class=free>PROB</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span>
    <span class=quoted><span class=quoted>"fmrestrict_set <span class=main>(</span>fmdom' <span class=main>(</span>exec_plan <span class=free>s</span> <span class=free>as</span><span class=main>)</span> <span class=main>-</span> prob_dom <span class=main>(</span>snapshot <span class=free>PROB</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>
        <span class=main>(</span>exec_plan <span class=free>s</span> <span class=free>as</span><span class=main>)</span>
      <span class=main>=</span> fmrestrict_set <span class=main>(</span>fmdom' <span class=main>(</span>exec_plan <span class=free>s</span> <span class=free>as</span><span class=main>)</span> <span class=main>-</span> prob_dom <span class=main>(</span>snapshot <span class=free>PROB</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>
        <span class=free>s</span>
    <span class=main>∧</span> fmrestrict_set <span class=main>(</span>fmdom' <span class=main>(</span>exec_plan <span class=free>s</span> <span class=free>as'</span><span class=main>)</span> <span class=main>-</span> prob_dom <span class=main>(</span>snapshot <span class=free>PROB</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>
        <span class=main>(</span>exec_plan <span class=free>s</span> <span class=free>as'</span><span class=main>)</span>
      <span class=main>=</span> fmrestrict_set <span class=main>(</span>fmdom' <span class=main>(</span>exec_plan <span class=free>s</span> <span class=free>as'</span><span class=main>)</span> <span class=main>-</span> prob_dom <span class=main>(</span>snapshot <span class=free>PROB</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>
        <span class=free>s</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?vs</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>(</span>prob_dom <span class=main>(</span>snapshot <span class=free>PROB</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?vs'</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>(</span>fmdom' <span class=main>(</span>exec_plan <span class=free>s</span> <span class=free>as</span><span class=main>)</span> <span class=main>-</span> prob_dom <span class=main>(</span>snapshot <span class=free>PROB</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?vs''</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>(</span>fmdom' <span class=main>(</span>exec_plan <span class=free>s</span> <span class=free>as'</span><span class=main>)</span> <span class=main>-</span> prob_dom <span class=main>(</span>snapshot <span class=free>PROB</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?s</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>(</span>exec_plan <span class=free>s</span> <span class=free>as</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?s'</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>(</span>exec_plan <span class=free>s</span> <span class=free>as'</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>have</span></span> 1<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>as</span> <span class=main>∈</span> valid_plans <span class=main>(</span>snapshot <span class=free>PROB</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>2<span class=main>,</span> 4<span class=main>,</span> 6<span class=main>)</span> no_vs_change_valid_in_snapshot
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword1><span class=command>{</span></span>
      <span class=keyword3><span class=command>fix</span></span> <span class=skolem>a</span>
      <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"ListMem <span class=skolem>a</span> <span class=free>as</span>"</span></span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>snd <span class=skolem>a</span><span class=main>)</span> <span class=main>⊆</span> prob_dom <span class=main>(</span>snapshot <span class=free>PROB</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> 1 FDOM_eff_subset_prob_dom_pair valid_plan_mems
        <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>fmrestrict_set <span class=main>(</span>fmdom' <span class=main>(</span>exec_plan <span class=free>s</span> <span class=free>as</span><span class=main>)</span>
          <span class=main>-</span> prob_dom <span class=main>(</span>snapshot <span class=free>PROB</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>snd <span class=skolem>a</span><span class=main>)</span><span class=main>)</span>
        <span class=main>=</span> <span class=main>{}</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> subset_inter_diff_empty<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>snd <span class=skolem>a</span><span class=main>)</span>"</span></span>
            <span class=quoted><span class=quoted>"prob_dom <span class=main>(</span>snapshot <span class=free>PROB</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span>"</span></span><span class=main>]</span> fmdom'_restrict_set_precise
        <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
    <span class=keyword1><span class=command>}</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span>
      <span class=quoted><span class=quoted>"fmrestrict_set <span class=var>?vs'</span> <span class=main>(</span>exec_plan <span class=free>s</span> <span class=free>as</span><span class=main>)</span> <span class=main>=</span> fmrestrict_set <span class=var>?vs'</span> <span class=free>s</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> disjoint_effects_no_effects<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>as</span></span> <span class=var><span class=quoted><span class=var>?vs'</span></span></span> <span class=quoted><span class=free>s</span></span><span class=main>]</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>{</span></span>
    <span class=keyword1><span class=command>{</span></span>
      <span class=keyword3><span class=command>fix</span></span> <span class=skolem>a</span>
      <span class=keyword3><span class=command>assume</span></span> P<span class=main>:</span> <span class=quoted><span class=quoted>"ListMem <span class=skolem>a</span> <span class=free>as'</span>"</span></span>
      <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> α<span class=main>:</span> <span class=quoted><span class=quoted>"<span class=free>as'</span> <span class=main>∈</span> valid_plans <span class=main>(</span>snapshot <span class=free>PROB</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>8<span class=main>)</span> 1 sublist_valid_plan
        <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>a</span> <span class=main>∈</span> <span class=free>PROB</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> P α snapshot_subset subsetCE valid_plan_mems
        <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
      <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>snd <span class=skolem>a</span><span class=main>)</span> <span class=main>⊆</span> prob_dom <span class=main>(</span>snapshot <span class=free>PROB</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> FDOM_eff_subset_prob_dom_pair valid_plan_mems
        <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>fmrestrict_set <span class=main>(</span>fmdom' <span class=main>(</span>exec_plan <span class=free>s</span> <span class=free>as'</span><span class=main>)</span>
          <span class=main>-</span> prob_dom <span class=main>(</span>snapshot <span class=free>PROB</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>snd <span class=skolem>a</span><span class=main>)</span><span class=main>)</span>
        <span class=main>=</span> <span class=main>{}</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> subset_inter_diff_empty<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=quoted>"fmdom' <span class=main>(</span>snd <span class=skolem>a</span><span class=main>)</span>"</span></span>
            <span class=quoted><span class=quoted>"prob_dom <span class=main>(</span>snapshot <span class=free>PROB</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span>"</span></span><span class=main>]</span> fmdom'_restrict_set_precise
        <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
    <span class=keyword1><span class=command>}</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span>
      <span class=quoted><span class=quoted>"fmrestrict_set <span class=var>?vs''</span> <span class=main>(</span>exec_plan <span class=free>s</span> <span class=free>as'</span><span class=main>)</span> <span class=main>=</span> fmrestrict_set <span class=var>?vs''</span> <span class=free>s</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> disjoint_effects_no_effects<span class=main>[</span><span class=operator>of</span> <span class=quoted><span class=free>as'</span></span> <span class=var><span class=quoted><span class=var>?vs''</span></span></span> <span class=quoted><span class=free>s</span></span><span class=main>]</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=comment1>― ‹NOTE type for `PROB` had to be fixed.›</span>
<span class=keyword1 id=AcycSspace-no_vs_change_snapshot_s_vs_is_valid_bound><span class=command>lemma</span></span> no_vs_change_snapshot_s_vs_is_valid_bound<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> problem"</span></span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"finite <span class=free>PROB</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>vars_change <span class=free>as</span> <span class=free>vs</span> <span class=free>s</span> <span class=main>=</span> <span class=main>[]</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>no_effectless_act <span class=free>as</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span>sat_precond_as <span class=free>s</span> <span class=free>as</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>s</span> <span class=main>∈</span> valid_states <span class=free>PROB</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>as'</span><span class=main>.</span>
    <span class=main>(</span>exec_plan <span class=free>s</span> <span class=free>as</span> <span class=main>=</span> exec_plan <span class=free>s</span> <span class=bound>as'</span><span class=main>)</span>
    <span class=main>∧</span> <span class=main>(</span>subseq <span class=bound>as'</span> <span class=free>as</span><span class=main>)</span>
    <span class=main>∧</span> <span class=main>(</span>length <span class=bound>as'</span> <span class=main>&lt;=</span> problem_plan_bound <span class=main>(</span>snapshot <span class=free>PROB</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>
  <span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>as'</span></span> <span class=keyword2><span class=keyword>where</span></span> 1<span class=main>:</span>
    <span class=quoted><span class=quoted>"fmrestrict_set <span class=main>(</span>prob_dom <span class=main>(</span>snapshot <span class=free>PROB</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>exec_plan <span class=free>s</span> <span class=free>as</span><span class=main>)</span> <span class=main>=</span>
      fmrestrict_set <span class=main>(</span>prob_dom <span class=main>(</span>snapshot <span class=free>PROB</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>exec_plan <span class=free>s</span> <span class=skolem>as'</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"subseq <span class=skolem>as'</span> <span class=free>as</span>"</span></span> <span class=quoted><span class=quoted>"length <span class=skolem>as'</span> <span class=main>≤</span> problem_plan_bound <span class=main>(</span>snapshot <span class=free>PROB</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms no_vs_change_obtain_snapshot_bound_3rd_step
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>{</span></span>

    <span class=keyword1><span class=command>have</span></span> a<span class=main>:</span> <span class=quoted><span class=quoted>"fmrestrict_set <span class=main>(</span>fmdom' <span class=main>(</span>exec_plan <span class=free>s</span> <span class=free>as</span><span class=main>)</span> <span class=main>-</span> prob_dom <span class=main>(</span>snapshot <span class=free>PROB</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>
        <span class=main>(</span>exec_plan <span class=free>s</span> <span class=free>as</span><span class=main>)</span>
      <span class=main>=</span> fmrestrict_set <span class=main>(</span>fmdom' <span class=main>(</span>exec_plan <span class=free>s</span> <span class=free>as</span><span class=main>)</span> <span class=main>-</span> prob_dom <span class=main>(</span>snapshot <span class=free>PROB</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>
        <span class=free>s</span> "</span></span>
      <span class=quoted><span class=quoted>"fmrestrict_set <span class=main>(</span>fmdom' <span class=main>(</span>exec_plan <span class=free>s</span> <span class=skolem>as'</span><span class=main>)</span> <span class=main>-</span> prob_dom <span class=main>(</span>snapshot <span class=free>PROB</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>
        <span class=main>(</span>exec_plan <span class=free>s</span> <span class=skolem>as'</span><span class=main>)</span>
      <span class=main>=</span> fmrestrict_set <span class=main>(</span>fmdom' <span class=main>(</span>exec_plan <span class=free>s</span> <span class=skolem>as'</span><span class=main>)</span> <span class=main>-</span> prob_dom <span class=main>(</span>snapshot <span class=free>PROB</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>
        <span class=free>s</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> assms 1 no_vs_change_snapshot_s_vs_is_valid_bound_i
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span><span class=main><span class=keyword3>+</span></span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>as'</span> <span class=main>∈</span> valid_plans <span class=main>(</span>snapshot <span class=free>PROB</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> <span class=quoted>"1"</span><span class=main>(</span>2<span class=main>)</span> assms<span class=main>(</span>2<span class=main>)</span> assms<span class=main>(</span>4<span class=main>)</span> assms<span class=main>(</span>6<span class=main>)</span> no_vs_change_valid_in_snapshot sublist_valid_plan
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>exec_plan <span class=free>s</span> <span class=free>as</span><span class=main>)</span> <span class=main>∈</span> valid_states <span class=free>PROB</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>5<span class=main>,</span> 6<span class=main>)</span> valid_as_valid_exec
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>exec_plan <span class=free>s</span> <span class=skolem>as'</span><span class=main>)</span> <span class=main>∈</span> valid_states <span class=free>PROB</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>5<span class=main>,</span> 6<span class=main>)</span> 1 valid_as_valid_exec sublist_valid_plan
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"exec_plan <span class=free>s</span> <span class=free>as</span> <span class=main>=</span> exec_plan <span class=free>s</span> <span class=skolem>as'</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> assms
      <span class=keyword1><span class=command>unfolding</span></span> valid_states_def
      <span class=keyword1><span class=command>using</span></span> graph_plan_lemma_5<span class=main>[</span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> vs<span class=main><span class=main>=</span></span><span class=quoted><span class=quoted>"prob_dom <span class=main>(</span>snapshot <span class=free>PROB</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span>"</span></span><span class=main>,</span> <span class=operator>OF</span> _ 1<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span><span class=main>]</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>force</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>using</span></span> 1
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=comment1>― ‹TODO showcase (problems with stronger typing: Isabelle requires strict typing for `max`; whereas
in HOL4 this is not required, possible because 'MAX' is natural number specific.›</span>
<span class=keyword1 id=AcycSspace-snapshot_bound_leq_S><span class=command>lemma</span></span> snapshot_bound_leq_S<span class=main>:</span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"
    problem_plan_bound <span class=main>(</span>snapshot <span class=free>PROB</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span>
    <span class=main>≤</span> S <span class=free>vs</span> <span class=free>lss</span> <span class=free>PROB</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span>
  "</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"geq_arg <span class=main>(</span>max <span class=main>::</span> nat <span class=main>⇒</span> nat <span class=main>⇒</span> nat<span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> geq_arg_def
    <span class=keyword1><span class=command>using</span></span> max.cobounded1
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>unfolding</span></span> S_def
    <span class=keyword1><span class=command>using</span></span> individual_weight_less_eq_lp<span class=main>[</span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span>
        g<span class=main><span class=main>=</span></span><span class=quoted><span class=quoted>"max <span class=main>::</span> nat <span class=main>⇒</span> nat <span class=main>⇒</span> nat"</span></span>
        <span class=keyword2><span class=keyword><span class=quasi_keyword>and</span></span></span> x<span class=main><span class=main>=</span></span><span class=quoted><span class=quoted>"<span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>and</span></span></span> R<span class=main><span class=main>=</span></span><span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=bound>y</span> <span class=main>∈</span> state_successors <span class=main>(</span>prob_proj <span class=free>PROB</span> <span class=free>vs</span><span class=main>)</span> <span class=bound>x</span><span class=main>)</span>"</span></span>
        <span class=keyword2><span class=keyword><span class=quasi_keyword>and</span></span></span> w<span class=main><span class=main>=</span></span><span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>λ</span><span class=bound>s</span><span class=main>.</span> problem_plan_bound <span class=main>(</span>snapshot <span class=free>PROB</span> <span class=bound>s</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>and</span></span></span> f<span class=main><span class=main>=</span></span><span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=bound>x</span> <span class=main>+</span> <span class=bound>y</span> <span class=main>+</span> <span class=main>1</span><span class=main>)</span>"</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>and</span></span></span> l<span class=main><span class=main>=</span></span><span class=quoted><span class=free>lss</span></span><span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=comment1>― ‹NOTE first argument of `top\_sorted\_abs` had to be wrapped into lambda.›</span>
<span class=comment1>― ‹NOTE the type of `1` had to be restricted to `nat` to ensure the proofs for `geq\_arg` work.›</span>
<span class=keyword1 id=AcycSspace-S_geq_S_succ_plus_ell><span class=command>lemma</span></span> S_geq_S_succ_plus_ell<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>s</span> <span class=main>∈</span> valid_states <span class=free>PROB</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span>top_sorted_abs <span class=main>(</span><span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=bound>y</span> <span class=main>∈</span> state_successors <span class=main>(</span>prob_proj <span class=free>PROB</span> <span class=free>vs</span><span class=main>)</span> <span class=bound>x</span><span class=main>)</span> <span class=free>lss</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>s'</span> <span class=main>∈</span> state_successors <span class=main>(</span>prob_proj <span class=free>PROB</span> <span class=free>vs</span><span class=main>)</span> <span class=free>s</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>set <span class=free>lss</span> <span class=main>=</span> valid_states <span class=main>(</span>prob_proj <span class=free>PROB</span> <span class=free>vs</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>
    problem_plan_bound <span class=main>(</span>snapshot <span class=free>PROB</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span>
      <span class=main>+</span> S <span class=free>vs</span> <span class=free>lss</span> <span class=free>PROB</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s'</span><span class=main>)</span>
      <span class=main>+</span> <span class=main>(</span><span class=main>1</span> <span class=main>::</span> nat<span class=main>)</span>
    <span class=main>≤</span> S <span class=free>vs</span> <span class=free>lss</span> <span class=free>PROB</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span>
  <span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?f</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=bound>x</span> <span class=main>+</span> <span class=bound>y</span> <span class=main>+</span> <span class=main>(</span><span class=main>1</span> <span class=main>::</span> nat<span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?R</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=bound>y</span> <span class=main>∈</span> state_successors <span class=main>(</span>prob_proj <span class=free>PROB</span> <span class=free>vs</span><span class=main>)</span> <span class=bound>x</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?w</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>λ</span><span class=bound>s</span><span class=main>.</span> problem_plan_bound <span class=main>(</span>snapshot <span class=free>PROB</span> <span class=bound>s</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?g</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"max <span class=main>::</span> nat <span class=main>⇒</span> nat <span class=main>⇒</span> nat"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?vtx1</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s'</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?G</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=free>lss</span>"</span></span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?vtx2</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"geq_arg <span class=var>?f</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> geq_arg_def
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"geq_arg <span class=var>?g</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> geq_arg_def
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∀</span><span class=bound>x</span><span class=main>.</span> ListMem <span class=bound>x</span> <span class=free>lss</span> <span class=main>⟶</span> <span class=main>¬</span><span class=var>?R</span> <span class=bound>x</span> <span class=bound>x</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> state_successors_def
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=var>?R</span> <span class=var>?vtx2</span> <span class=var>?vtx1</span>"</span></span>
    <span class=keyword1><span class=command>unfolding</span></span> state_successors_def
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>3<span class=main>)</span> state_in_successor_proj_in_state_in_successor state_successors_def
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span>
    <span class=quoted><span class=quoted>"ListMem <span class=var>?vtx1</span> <span class=var>?G</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>,</span> 3<span class=main>,</span> 4<span class=main>)</span>
    <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> ListMem_iff contra_subsetD graph_plan_not_eq_last_diff_paths proj_successors_of_valid_are_valid<span class=main>)</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"top_sorted_abs <span class=var>?R</span> <span class=var>?G</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>2<span class=main>)</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>unfolding</span></span> S_def
    <span class=keyword1><span class=command>using</span></span> lp_geq_lp_from_successor<span class=main>[</span><span class=operator>of</span> <span class=var><span class=quoted><span class=var>?f</span></span></span> <span class=var><span class=quoted><span class=var>?g</span></span></span> <span class=var><span class=quoted><span class=var>?G</span></span></span> <span class=var><span class=quoted><span class=var>?R</span></span></span> <span class=var><span class=quoted><span class=var>?vtx2</span></span></span> <span class=var><span class=quoted><span class=var>?vtx1</span></span></span> <span class=var><span class=quoted><span class=var>?w</span></span></span><span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=keyword1 id=AcycSspace-vars_change_cons><span class=command>lemma</span></span> vars_change_cons<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>s</span> <span class=free>s'</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>vars_change <span class=free>as</span> <span class=free>vs</span> <span class=free>s</span> <span class=main>=</span> <span class=main>(</span><span class=free>s'</span> <span class=main>#</span> <span class=free>ss</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>as1</span> <span class=bound>act</span> <span class=bound>as2</span><span class=main>.</span>
    <span class=main>(</span><span class=free>as</span> <span class=main>=</span> <span class=bound>as1</span> <span class=main>@</span> <span class=main>(</span><span class=bound>act</span> <span class=main>#</span> <span class=bound>as2</span><span class=main>)</span><span class=main>)</span>
    <span class=main>∧</span> <span class=main>(</span>vars_change <span class=bound>as1</span> <span class=free>vs</span> <span class=free>s</span> <span class=main>=</span> <span class=main>[]</span><span class=main>)</span>
    <span class=main>∧</span> <span class=main>(</span>state_succ <span class=main>(</span>exec_plan <span class=free>s</span> <span class=bound>as1</span><span class=main>)</span> <span class=bound>act</span> <span class=main>=</span> <span class=free>s'</span><span class=main>)</span>
    <span class=main>∧</span> <span class=main>(</span>vars_change <span class=bound>as2</span> <span class=free>vs</span> <span class=main>(</span>state_succ <span class=main>(</span>exec_plan <span class=free>s</span> <span class=bound>as1</span><span class=main>)</span> <span class=bound>act</span><span class=main>)</span> <span class=main>=</span> <span class=free>ss</span><span class=main>)</span>
  <span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>as</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>s</span></span> <span class=quoted><span class=free>s'</span></span> <span class=quoted><span class=free>vs</span></span> <span class=quoted><span class=free>ss</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>a</span> <span class=skolem>as</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
  <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"fmrestrict_set <span class=skolem>vs</span> <span class=main>(</span>state_succ <span class=skolem>s</span> <span class=skolem>a</span><span class=main>)</span> <span class=main>≠</span> fmrestrict_set <span class=skolem>vs</span> <span class=skolem>s</span>"</span></span><span class=main>)</span>
    <span class=keyword3><span class=command>case</span></span> True
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"state_succ <span class=skolem>s</span> <span class=skolem>a</span> <span class=main>=</span> <span class=skolem>s'</span>"</span></span> <span class=quoted><span class=quoted>"vars_change <span class=skolem>as</span> <span class=skolem>vs</span> <span class=main>(</span>state_succ <span class=skolem>s</span> <span class=skolem>a</span><span class=main>)</span> <span class=main>=</span> <span class=skolem>ss</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> Cons.prems
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span><span class=main><span class=keyword3>+</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
  <span class=keyword1><span class=command>next</span></span>
    <span class=keyword3><span class=command>case</span></span> False
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"vars_change <span class=skolem>as</span> <span class=skolem>vs</span> <span class=main>(</span>state_succ <span class=skolem>s</span> <span class=skolem>a</span><span class=main>)</span> <span class=main>=</span> <span class=skolem>s'</span> <span class=main>#</span> <span class=skolem>ss</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> Cons.prems
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>as1</span></span> <span class=skolem><span class=skolem>act</span></span> <span class=skolem><span class=skolem>as2</span></span> <span class=keyword2><span class=keyword>where</span></span>
      <span class=quoted><span class=quoted>"<span class=skolem>as</span> <span class=main>=</span> <span class=skolem>as1</span> <span class=main>@</span> <span class=skolem>act</span> <span class=main>#</span> <span class=skolem>as2</span>"</span></span> <span class=quoted><span class=quoted>"vars_change <span class=skolem>as1</span> <span class=skolem>vs</span> <span class=main>(</span>state_succ <span class=skolem>s</span> <span class=skolem>a</span><span class=main>)</span> <span class=main>=</span> <span class=main>[]</span>"</span></span>
      <span class=quoted><span class=quoted>"state_succ <span class=main>(</span>exec_plan <span class=main>(</span>state_succ <span class=skolem>s</span> <span class=skolem>a</span><span class=main>)</span> <span class=skolem>as1</span><span class=main>)</span> <span class=skolem>act</span> <span class=main>=</span> <span class=skolem>s'</span>"</span></span>
      <span class=quoted><span class=quoted>"vars_change <span class=skolem>as2</span> <span class=skolem>vs</span> <span class=main>(</span>state_succ <span class=main>(</span>exec_plan <span class=main>(</span>state_succ <span class=skolem>s</span> <span class=skolem>a</span><span class=main>)</span> <span class=skolem>as1</span><span class=main>)</span> <span class=skolem>act</span><span class=main>)</span> <span class=main>=</span> <span class=skolem>ss</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> Cons.IH
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> False append_Cons exec_plan.simps<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span> vars_change.simps<span class=main><span class=main>(</span></span>2<span class=main><span class=main>)</span></span><span class=main>)</span>
  <span class=keyword1><span class=command>qed</span></span>
<span class=keyword1><span class=command>qed</span></span> <span class=operator>simp</span>


<span class=keyword1 id=AcycSspace-vars_change_cons_2><span class=command>lemma</span></span> vars_change_cons_2<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>s</span> <span class=free>s'</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>vars_change <span class=free>as</span> <span class=free>vs</span> <span class=free>s</span> <span class=main>=</span> <span class=main>(</span><span class=free>s'</span> <span class=main>#</span> <span class=free>ss</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s'</span> <span class=main>≠</span> fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
  <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=free>as</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>s</span></span> <span class=quoted><span class=free>s'</span></span> <span class=quoted><span class=free>vs</span></span> <span class=quoted><span class=free>ss</span></span><span class=main>)</span>
  <span class=keyword1><span class=command><span class=improper><span class=command>apply</span></span></span></span><span class=main>(</span><span class=operator>auto</span><span class=main>)</span>
  <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> list.inject<span class=main>)</span>


<span class=comment1>― ‹NOTE first argument of `top\_sorted\_abs had to be wrapped into lambda.›</span>
<span class=keyword1 id=AcycSspace-problem_plan_bound_S_bound_1st_step><span class=command>lemma</span></span> problem_plan_bound_S_bound_1st_step<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> problem"</span></span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"finite <span class=free>PROB</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>top_sorted_abs <span class=main>(</span><span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=bound>y</span> <span class=main>∈</span> state_successors <span class=main>(</span>prob_proj <span class=free>PROB</span> <span class=free>vs</span><span class=main>)</span> <span class=bound>x</span><span class=main>)</span> <span class=free>lss</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span>set <span class=free>lss</span> <span class=main>=</span> valid_states <span class=main>(</span>prob_proj <span class=free>PROB</span> <span class=free>vs</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>s</span> <span class=main>∈</span> valid_states <span class=free>PROB</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>no_effectless_act <span class=free>as</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>sat_precond_as <span class=free>s</span> <span class=free>as</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>as'</span><span class=main>.</span>
      <span class=main>(</span>exec_plan <span class=free>s</span> <span class=bound>as'</span> <span class=main>=</span> exec_plan <span class=free>s</span> <span class=free>as</span><span class=main>)</span>
      <span class=main>∧</span> <span class=main>(</span>subseq <span class=bound>as'</span> <span class=free>as</span><span class=main>)</span>
      <span class=main>∧</span> <span class=main>(</span>length <span class=bound>as'</span> <span class=main>&lt;=</span> S <span class=free>vs</span> <span class=free>lss</span> <span class=free>PROB</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span>
    <span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms
<span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>induction</span> <span class=quoted><span class=quoted>"vars_change <span class=free>as</span> <span class=free>vs</span> <span class=free>s</span>"</span></span> <span class=quasi_keyword>arbitrary</span><span class=main><span class=main>:</span></span> <span class=quoted><span class=free>PROB</span></span> <span class=quoted><span class=free>as</span></span> <span class=quoted><span class=free>vs</span></span> <span class=quoted><span class=free>s</span></span> <span class=quoted><span class=free>lss</span></span><span class=main>)</span>
  <span class=keyword3><span class=command>case</span></span> Nil
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>as'</span></span> <span class=keyword2><span class=keyword>where</span></span>
    <span class=quoted><span class=quoted>"exec_plan <span class=skolem>s</span> <span class=skolem>as</span> <span class=main>=</span> exec_plan <span class=skolem>s</span> <span class=skolem>as'</span>"</span></span> <span class=quoted><span class=quoted>"subseq <span class=skolem>as'</span> <span class=skolem>as</span>"</span></span>
    <span class=quoted><span class=quoted>"length <span class=skolem>as'</span> <span class=main>≤</span> problem_plan_bound <span class=main>(</span>snapshot <span class=skolem>PROB</span> <span class=main>(</span>fmrestrict_set <span class=skolem>vs</span> <span class=skolem>s</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> Nil<span class=main>(</span>1<span class=main>)</span> Nil.prems<span class=main>(</span>1<span class=main>,</span>4<span class=main>,</span>5<span class=main>,</span>6<span class=main>,</span>7<span class=main>)</span> no_vs_change_snapshot_s_vs_is_valid_bound
    <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"
      problem_plan_bound <span class=main>(</span>snapshot <span class=skolem>PROB</span> <span class=main>(</span>fmrestrict_set <span class=skolem>vs</span> <span class=skolem>s</span><span class=main>)</span><span class=main>)</span>
      <span class=main>≤</span> S <span class=skolem>vs</span> <span class=skolem>lss</span> <span class=skolem>PROB</span> <span class=main>(</span>fmrestrict_set <span class=skolem>vs</span> <span class=skolem>s</span><span class=main>)</span>
    "</span></span>
    <span class=keyword1><span class=command>using</span></span> snapshot_bound_leq_S le_trans
    <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>using</span></span> le_trans
    <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
<span class=keyword1><span class=command>next</span></span>
  <span class=keyword3><span class=command>case</span></span> <span class=main>(</span>Cons <span class=skolem>s'</span> <span class=skolem>ss</span><span class=main>)</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>as1</span></span> <span class=skolem><span class=skolem>act</span></span> <span class=skolem><span class=skolem>as2</span></span> <span class=keyword2><span class=keyword>where</span></span> 1<span class=main>:</span>
    <span class=quoted><span class=quoted>"<span class=skolem>as</span> <span class=main>=</span> <span class=skolem>as1</span> <span class=main>@</span> <span class=skolem>act</span> <span class=main>#</span> <span class=skolem>as2</span>"</span></span> <span class=quoted><span class=quoted>"vars_change <span class=skolem>as1</span> <span class=skolem>vs</span> <span class=skolem>s</span> <span class=main>=</span> <span class=main>[]</span>"</span></span> <span class=quoted><span class=quoted>"state_succ <span class=main>(</span>exec_plan <span class=skolem>s</span> <span class=skolem>as1</span><span class=main>)</span> <span class=skolem>act</span> <span class=main>=</span> <span class=skolem>s'</span>"</span></span>
    <span class=quoted><span class=quoted>"vars_change <span class=skolem>as2</span> <span class=skolem>vs</span> <span class=main>(</span>state_succ <span class=main>(</span>exec_plan <span class=skolem>s</span> <span class=skolem>as1</span><span class=main>)</span> <span class=skolem>act</span><span class=main>)</span> <span class=main>=</span> <span class=skolem>ss</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> vars_change_cons
    <span class=keyword1><span class=command>by</span></span> <span class=operator>smt</span>
  <span class=keyword1><span class=command>text</span></span><span class=quoted><span class=plain_text>‹ Obtain conclusion of induction hypothesis for 'as2' and
      '(state\_succ (exec\_plan s as1) act)'. ›</span></span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword1><span class=command>{</span></span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>as1</span> <span class=main>∈</span> valid_plans <span class=skolem>PROB</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>5<span class=main>)</span> 1<span class=main>(</span>1<span class=main>)</span> valid_append_valid_pref
        <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>act</span> <span class=main>∈</span> <span class=skolem>PROB</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>5<span class=main>)</span> 1 valid_append_valid_suff valid_plan_valid_head
        <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
      <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"state_succ <span class=main>(</span>exec_plan <span class=skolem>s</span> <span class=skolem>as1</span><span class=main>)</span> <span class=skolem>act</span> <span class=main>∈</span> valid_states <span class=skolem>PROB</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>4<span class=main>)</span> valid_as_valid_exec lemma_1_i
        <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>}</span></span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>as2</span> <span class=main>∈</span> valid_plans <span class=skolem>PROB</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>5<span class=main>)</span> 1<span class=main>(</span>1<span class=main>)</span> valid_append_valid_suff valid_plan_valid_tail
      <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"no_effectless_act <span class=skolem>as2</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>6<span class=main>)</span> 1<span class=main>(</span>1<span class=main>)</span> rem_effectless_works_13 sublist_append_back
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"sat_precond_as <span class=main>(</span>state_succ <span class=main>(</span>exec_plan <span class=skolem>s</span> <span class=skolem>as1</span><span class=main>)</span> <span class=skolem>act</span><span class=main>)</span> <span class=skolem>as2</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>7<span class=main>)</span> 1<span class=main>(</span>1<span class=main>)</span> graph_plan_lemma_17 sat_precond_as.simps<span class=main>(</span>2<span class=main>)</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>as'</span><span class=main>.</span>
          exec_plan <span class=main>(</span>state_succ <span class=main>(</span>exec_plan <span class=skolem>s</span> <span class=skolem>as1</span><span class=main>)</span> <span class=skolem>act</span><span class=main>)</span> <span class=bound>as'</span>
          <span class=main>=</span> exec_plan <span class=main>(</span>state_succ <span class=main>(</span>exec_plan <span class=skolem>s</span> <span class=skolem>as1</span><span class=main>)</span> <span class=skolem>act</span><span class=main>)</span> <span class=skolem>as2</span>
        <span class=main>∧</span> subseq <span class=bound>as'</span> <span class=skolem>as2</span>
        <span class=main>∧</span> length <span class=bound>as'</span> <span class=main>≤</span> S <span class=skolem>vs</span> <span class=skolem>lss</span> <span class=skolem>PROB</span> <span class=main>(</span>fmrestrict_set <span class=skolem>vs</span> <span class=main>(</span>state_succ <span class=main>(</span>exec_plan <span class=skolem>s</span> <span class=skolem>as1</span><span class=main>)</span> <span class=skolem>act</span><span class=main>)</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>1<span class=main>,</span> 2<span class=main>,</span> 3<span class=main>)</span> 1<span class=main>(</span>4<span class=main>)</span>
        Cons<span class=main>(</span>1<span class=main>)</span><span class=main>[</span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> as<span class=main><span class=main>=</span></span><span class=quoted><span class=quoted>"<span class=skolem>as2</span>"</span></span> <span class=keyword2><span class=keyword><span class=quasi_keyword>and</span></span></span> s<span class=main><span class=main>=</span></span><span class=quoted><span class=quoted>"<span class=main>(</span>state_succ <span class=main>(</span>exec_plan <span class=skolem>s</span> <span class=skolem>as1</span><span class=main>)</span> <span class=skolem>act</span><span class=main>)</span>"</span></span><span class=main>]</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>note</span></span> a<span class=main>=</span>this
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"no_effectless_act <span class=skolem>as1</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>6<span class=main>)</span> 1<span class=main>(</span>1<span class=main>)</span> rem_effectless_works_12
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"sat_precond_as <span class=skolem>s</span> <span class=skolem>as1</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>7<span class=main>)</span> 1<span class=main>(</span>1<span class=main>)</span> sat_precond_as_pfx
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>as1</span> <span class=main>∈</span> valid_plans <span class=skolem>PROB</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>5<span class=main>)</span> 1<span class=main>(</span>1<span class=main>)</span> valid_append_valid_pref
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>as'</span><span class=main>.</span> exec_plan <span class=skolem>s</span> <span class=skolem>as1</span> <span class=main>=</span> exec_plan <span class=skolem>s</span> <span class=bound>as'</span> <span class=main>∧</span>
        subseq <span class=bound>as'</span> <span class=skolem>as1</span> <span class=main>∧</span> length <span class=bound>as'</span> <span class=main>≤</span> problem_plan_bound <span class=main>(</span>snapshot <span class=skolem>PROB</span> <span class=main>(</span>fmrestrict_set <span class=skolem>vs</span> <span class=skolem>s</span><span class=main>)</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> no_vs_change_snapshot_s_vs_is_valid_bound<span class=main>[</span><span class=operator>of</span> <span class=main>_</span> <span class=quoted><span class=skolem>as1</span></span><span class=main>]</span>
      <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>1<span class=main>,</span> 4<span class=main>)</span> 1<span class=main>(</span>2<span class=main>)</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>as''</span></span> <span class=keyword2><span class=keyword>where</span></span> b<span class=main>:</span>
    <span class=quoted><span class=quoted>"exec_plan <span class=skolem>s</span> <span class=skolem>as1</span> <span class=main>=</span> exec_plan <span class=skolem>s</span> <span class=skolem>as''</span>"</span></span> <span class=quoted><span class=quoted>"subseq <span class=skolem>as''</span> <span class=skolem>as1</span>"</span></span>
    <span class=quoted><span class=quoted>"length <span class=skolem>as''</span> <span class=main>≤</span> problem_plan_bound <span class=main>(</span>snapshot <span class=skolem>PROB</span> <span class=main>(</span>fmrestrict_set <span class=skolem>vs</span> <span class=skolem>s</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>as'</span></span> <span class=keyword2><span class=keyword>where</span></span> i<span class=main>:</span>
      <span class=quoted><span class=quoted>"exec_plan <span class=main>(</span>state_succ <span class=main>(</span>exec_plan <span class=skolem>s</span> <span class=skolem>as1</span><span class=main>)</span> <span class=skolem>act</span><span class=main>)</span> <span class=skolem>as'</span>
          <span class=main>=</span> exec_plan <span class=main>(</span>state_succ <span class=main>(</span>exec_plan <span class=skolem>s</span> <span class=skolem>as1</span><span class=main>)</span> <span class=skolem>act</span><span class=main>)</span> <span class=skolem>as2</span>"</span></span>
      <span class=quoted><span class=quoted>"subseq <span class=skolem>as'</span> <span class=skolem>as2</span>"</span></span>
      <span class=quoted><span class=quoted>"length <span class=skolem>as'</span> <span class=main>≤</span> S <span class=skolem>vs</span> <span class=skolem>lss</span> <span class=skolem>PROB</span> <span class=main>(</span>fmrestrict_set <span class=skolem>vs</span> <span class=main>(</span>state_succ <span class=main>(</span>exec_plan <span class=skolem>s</span> <span class=skolem>as1</span><span class=main>)</span> <span class=skolem>act</span><span class=main>)</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> a
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?as'</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=skolem>as''</span> <span class=main>@</span> <span class=skolem>act</span> <span class=main>#</span> <span class=skolem>as'</span>"</span></span>
    <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"exec_plan <span class=skolem>s</span> <span class=var>?as'</span> <span class=main>=</span> exec_plan <span class=skolem>s</span> <span class=skolem>as</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> 1<span class=main>(</span>1<span class=main>)</span> b<span class=main>(</span>1<span class=main>)</span> i<span class=main>(</span>1<span class=main>)</span> exec_plan_Append exec_plan.simps<span class=main>(</span>2<span class=main>)</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"subseq <span class=var>?as'</span> <span class=skolem>as</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> 1<span class=main>(</span>1<span class=main>)</span> b<span class=main>(</span>2<span class=main>)</span> i<span class=main>(</span>2<span class=main>)</span> subseq_append_iff
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>moreover</span></span>
    <span class=keyword1><span class=command>{</span></span>
      <span class=keyword1><span class=command>{</span></span>
        <span class=comment1>― ‹NOTE this is proved earlier in the original proof script. Moved here to improve
            transparency.›</span>
        <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"sat_precond_as <span class=main>(</span>exec_plan <span class=skolem>s</span> <span class=skolem>as1</span><span class=main>)</span> <span class=main>(</span><span class=skolem>act</span> <span class=main>#</span> <span class=skolem>as2</span><span class=main>)</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> empty_replace_proj_dual7
          <span class=keyword1><span class=command>using</span></span> 1<span class=main>(</span>1<span class=main>)</span> Cons.prems<span class=main>(</span>7<span class=main>)</span>
          <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fst <span class=skolem>act</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=main>(</span>exec_plan <span class=skolem>s</span> <span class=skolem>as1</span><span class=main>)</span>"</span></span>
          <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
      <span class=keyword1><span class=command>}</span></span>
      <span class=keyword1><span class=command>note</span></span> A <span class=main>=</span> this
      <span class=keyword1><span class=command>{</span></span>
        <span class=keyword1><span class=command>have</span></span>
          <span class=quoted><span class=quoted>"fmrestrict_set <span class=skolem>vs</span> <span class=main>(</span>state_succ <span class=main>(</span>exec_plan <span class=skolem>s</span> <span class=skolem>as1</span><span class=main>)</span> <span class=skolem>act</span><span class=main>)</span>
              <span class=main>=</span> <span class=main>(</span>state_succ <span class=main>(</span>fmrestrict_set <span class=skolem>vs</span> <span class=main>(</span>exec_plan <span class=skolem>s</span> <span class=skolem>as''</span><span class=main>)</span><span class=main>)</span> <span class=main>(</span>action_proj <span class=skolem>act</span> <span class=skolem>vs</span><span class=main>)</span><span class=main>)</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> b<span class=main>(</span>1<span class=main>)</span> A drest_succ_proj_eq_drest_succ<span class=main>[</span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> s<span class=main><span class=main>=</span></span><span class=quoted><span class=quoted>"exec_plan <span class=skolem>s</span> <span class=skolem>as1</span>"</span></span><span class=main>,</span> <span class=operator>symmetric</span><span class=main>]</span>
          <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
        <span class=keyword1><span class=command>also</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>…</span> <span class=main>=</span> <span class=main>(</span>state_succ <span class=main>(</span>fmrestrict_set <span class=skolem>vs</span> <span class=skolem>s</span><span class=main>)</span> <span class=main>(</span>action_proj <span class=skolem>act</span> <span class=skolem>vs</span><span class=main>)</span><span class=main>)</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> 1<span class=main>(</span>2<span class=main>)</span> b<span class=main>(</span>1<span class=main>)</span> empty_change_no_change
          <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
        <span class=keyword1><span class=command>finally</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>…</span> <span class=main>=</span> fmrestrict_set  <span class=skolem>vs</span> <span class=main>(</span>state_succ <span class=skolem>s</span> <span class=main>(</span>action_proj <span class=skolem>act</span> <span class=skolem>vs</span><span class=main>)</span><span class=main>)</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span>  succ_drest_eq_drest_succ
          <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>}</span></span>
      <span class=keyword1><span class=command>note</span></span> B <span class=main>=</span> this
      <span class=keyword1><span class=command>have</span></span> C<span class=main>:</span> <span class=quoted><span class=quoted>"fmrestrict_set <span class=skolem>vs</span> <span class=main>(</span>exec_plan <span class=skolem>s</span> <span class=skolem>as''</span><span class=main>)</span> <span class=main>=</span> fmrestrict_set <span class=skolem>vs</span> <span class=skolem>s</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> 1<span class=main>(</span>2<span class=main>)</span> b<span class=main>(</span>1<span class=main>)</span> empty_change_no_change
        <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
      <span class=keyword1><span class=command>{</span></span>
        <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=skolem>act</span> <span class=main>∈</span> <span class=skolem>PROB</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>5<span class=main>)</span> 1 valid_append_valid_suff valid_plan_valid_head
          <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> ℵ<span class=main>:</span> <span class=quoted><span class=quoted>"action_proj <span class=skolem>act</span> <span class=skolem>vs</span> <span class=main>∈</span> prob_proj <span class=skolem>PROB</span> <span class=skolem>vs</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> action_proj_in_prob_proj
          <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>state_succ <span class=skolem>s</span> <span class=main>(</span>action_proj <span class=skolem>act</span> <span class=skolem>vs</span><span class=main>)</span><span class=main>)</span> <span class=main>∈</span> <span class=main>(</span>state_successors <span class=main>(</span>prob_proj <span class=skolem>PROB</span> <span class=skolem>vs</span><span class=main>)</span> <span class=skolem>s</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>proof</span></span> <span class=main>(</span><span class=operator>cases</span> <span class=quoted><span class=quoted>"fst <span class=main>(</span>action_proj <span class=skolem>act</span> <span class=skolem>vs</span><span class=main>)</span> <span class=keyword1>⊆<span class=hidden>⇩</span><sub>f</sub></span> <span class=skolem>s</span>"</span></span><span class=main>)</span>
          <span class=keyword3><span class=command>case</span></span> True
          <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
            <span class=keyword1><span class=command>unfolding</span></span> state_successors_def
            <span class=keyword1><span class=command>using</span></span> Cons.hyps<span class=main>(</span>2<span class=main>)</span> 1<span class=main>(</span>3<span class=main>)</span> b<span class=main>(</span>1<span class=main>)</span> A B C ℵ DiffI imageI singletonD vars_change_cons_2
              drest_succ_proj_eq_drest_succ
            <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
        <span class=keyword1><span class=command>next</span></span>
          <span class=keyword3><span class=command>case</span></span> False
          <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
            <span class=keyword1><span class=command>unfolding</span></span> state_successors_def
            <span class=keyword1><span class=command>using</span></span> Cons.hyps<span class=main>(</span>2<span class=main>)</span> 1<span class=main>(</span>3<span class=main>)</span> b<span class=main>(</span>1<span class=main>)</span> A B C ℵ DiffI imageI singletonD
              drest_succ_proj_eq_drest_succ vars_change_cons_2
            <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
        <span class=keyword1><span class=command>qed</span></span>
      <span class=keyword1><span class=command>}</span></span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> D<span class=main>:</span>
        <span class=quoted><span class=quoted>"problem_plan_bound <span class=main>(</span>snapshot <span class=skolem>PROB</span> <span class=main>(</span>fmrestrict_set <span class=skolem>vs</span> <span class=skolem>s</span><span class=main>)</span><span class=main>)</span>
                <span class=main>+</span> S <span class=skolem>vs</span> <span class=skolem>lss</span> <span class=skolem>PROB</span> <span class=main>(</span>fmrestrict_set <span class=skolem>vs</span> <span class=main>(</span>state_succ <span class=skolem>s</span> <span class=main>(</span>action_proj <span class=skolem>act</span> <span class=skolem>vs</span><span class=main>)</span><span class=main>)</span><span class=main>)</span>
                <span class=main>+</span> <span class=main>1</span>
              <span class=main>≤</span> S <span class=skolem>vs</span> <span class=skolem>lss</span> <span class=skolem>PROB</span> <span class=main>(</span>fmrestrict_set <span class=skolem>vs</span> <span class=skolem>s</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> Cons.prems<span class=main>(</span>2<span class=main>,</span> 3<span class=main>,</span> 4<span class=main>)</span> S_geq_S_succ_plus_ell<span class=main>[</span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> s'<span class=main><span class=main>=</span></span><span class=quoted><span class=quoted>"state_succ <span class=skolem>s</span> <span class=main>(</span>action_proj <span class=skolem>act</span> <span class=skolem>vs</span><span class=main>)</span>"</span></span><span class=main>]</span>
        <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>{</span></span>
        <span class=keyword1><span class=command>have</span></span>
          <span class=quoted><span class=quoted>"length <span class=var>?as'</span> <span class=main>≤</span> problem_plan_bound <span class=main>(</span>snapshot <span class=skolem>PROB</span> <span class=main>(</span>fmrestrict_set <span class=skolem>vs</span> <span class=skolem>s</span><span class=main>)</span><span class=main>)</span>
                <span class=main>+</span> <span class=main>1</span> <span class=main>+</span> S <span class=skolem>vs</span> <span class=skolem>lss</span> <span class=skolem>PROB</span> <span class=main>(</span>fmrestrict_set <span class=skolem>vs</span> <span class=main>(</span>state_succ <span class=main>(</span>exec_plan <span class=skolem>s</span> <span class=skolem>as1</span><span class=main>)</span> <span class=skolem>act</span><span class=main>)</span><span class=main>)</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> b i
          <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
        <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"length <span class=var>?as'</span> <span class=main>≤</span> S <span class=skolem>vs</span> <span class=skolem>lss</span> <span class=skolem>PROB</span> <span class=main>(</span>fmrestrict_set <span class=skolem>vs</span> <span class=skolem>s</span><span class=main>)</span>"</span></span>
          <span class=keyword1><span class=command>using</span></span> b<span class=main>(</span>1<span class=main>)</span> A B C D drest_succ_proj_eq_drest_succ
          <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>smt</span> Suc_eq_plus1 add_Suc dual_order.trans<span class=main>)</span>
      <span class=keyword1><span class=command>}</span></span>
    <span class=keyword1><span class=command>}</span></span>
    <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?case</span></span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=comment1>― ‹NOTE first argument of `top\_sorted\_abs` had to be wrapped into lambda.›</span>
<span class=keyword1 id=AcycSspace-problem_plan_bound_S_bound_2nd_step><span class=command>lemma</span></span> problem_plan_bound_S_bound_2nd_step<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"finite <span class=main>(</span><span class=free>PROB</span> <span class=main>::</span> <span class=tfree>'a</span> problem<span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span>top_sorted_abs <span class=main>(</span><span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=bound>y</span> <span class=main>∈</span> state_successors <span class=main>(</span>prob_proj <span class=free>PROB</span> <span class=free>vs</span><span class=main>)</span> <span class=bound>x</span><span class=main>)</span> <span class=free>lss</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span>set <span class=free>lss</span> <span class=main>=</span> valid_states <span class=main>(</span>prob_proj <span class=free>PROB</span> <span class=free>vs</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>s</span> <span class=main>∈</span> valid_states <span class=free>PROB</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>as'</span><span class=main>.</span>
    <span class=main>(</span>exec_plan <span class=free>s</span> <span class=bound>as'</span> <span class=main>=</span> exec_plan <span class=free>s</span> <span class=free>as</span><span class=main>)</span>
    <span class=main>∧</span> <span class=main>(</span>subseq <span class=bound>as'</span> <span class=free>as</span><span class=main>)</span>
    <span class=main>∧</span> <span class=main>(</span>length <span class=bound>as'</span> <span class=main>≤</span> S <span class=free>vs</span> <span class=free>lss</span> <span class=free>PROB</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span>
  <span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=comment1>― ‹NOTE Proof premises and obtain conclusion of `problem\_plan\_bound\_S\_bound\_1st\_step`.›</span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword1><span class=command>have</span></span> a<span class=main>:</span> <span class=quoted><span class=quoted>"rem_condless_act <span class=free>s</span> <span class=main>[]</span> <span class=main>(</span>rem_effectless_act <span class=free>as</span><span class=main>)</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>5<span class=main>)</span> rem_effectless_works_4' rem_condless_valid_10
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> b<span class=main>:</span> <span class=quoted><span class=quoted>"no_effectless_act <span class=main>(</span>rem_condless_act <span class=free>s</span> <span class=main>[]</span> <span class=main>(</span>rem_effectless_act <span class=free>as</span><span class=main>)</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> assms rem_effectless_works_6 rem_condless_valid_9
      <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"sat_precond_as <span class=free>s</span> <span class=main>(</span>rem_condless_act <span class=free>s</span> <span class=main>[]</span> <span class=main>(</span>rem_effectless_act <span class=free>as</span><span class=main>)</span><span class=main>)</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> assms rem_condless_valid_2
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>as'</span><span class=main>.</span>
      exec_plan <span class=free>s</span> <span class=bound>as'</span> <span class=main>=</span> exec_plan <span class=free>s</span> <span class=main>(</span>rem_condless_act <span class=free>s</span> <span class=main>[]</span> <span class=main>(</span>rem_effectless_act <span class=free>as</span><span class=main>)</span><span class=main>)</span>
      <span class=main>∧</span> subseq <span class=bound>as'</span> <span class=main>(</span>rem_condless_act <span class=free>s</span> <span class=main>[]</span> <span class=main>(</span>rem_effectless_act <span class=free>as</span><span class=main>)</span><span class=main>)</span>
      <span class=main>∧</span> length <span class=bound>as'</span> <span class=main>≤</span> S <span class=free>vs</span> <span class=free>lss</span> <span class=free>PROB</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span>
    "</span></span>
      <span class=keyword1><span class=command>using</span></span> assms a b problem_plan_bound_S_bound_1st_step
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>as'</span></span> <span class=keyword2><span class=keyword>where</span></span> 1<span class=main>:</span>
    <span class=quoted><span class=quoted>"exec_plan <span class=free>s</span> <span class=skolem>as'</span> <span class=main>=</span> exec_plan <span class=free>s</span> <span class=main>(</span>rem_condless_act <span class=free>s</span> <span class=main>[]</span> <span class=main>(</span>rem_effectless_act <span class=free>as</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"subseq <span class=skolem>as'</span> <span class=main>(</span>rem_condless_act <span class=free>s</span> <span class=main>[]</span> <span class=main>(</span>rem_effectless_act <span class=free>as</span><span class=main>)</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"length <span class=skolem>as'</span> <span class=main>≤</span> S <span class=free>vs</span> <span class=free>lss</span> <span class=free>PROB</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> 2<span class=main>:</span> <span class=quoted><span class=quoted>"exec_plan <span class=free>s</span> <span class=skolem>as'</span> <span class=main>=</span> exec_plan <span class=free>s</span> <span class=free>as</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> rem_condless_valid_1 rem_effectless_works_14
    <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"subseq <span class=skolem>as'</span> <span class=free>as</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> 1<span class=main>(</span>2<span class=main>)</span> rem_condless_valid_8 rem_effectless_works_9 sublist_trans
    <span class=keyword1><span class=command>by</span></span> <span class=operator>metis</span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>using</span></span> 1<span class=main>(</span>3<span class=main>)</span> 2
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=comment1>― ‹NOTE first argument of `top\_sorted\_abs` had to be wrapped into lambda.›</span>
<span class=keyword1 id=AcycSspace-S_in_MPLS_leq_2_pow_n><span class=command>lemma</span></span> S_in_MPLS_leq_2_pow_n<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"finite <span class=main>(</span><span class=free>PROB</span> <span class=main>::</span> <span class=tfree>'a</span> problem<span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span>top_sorted_abs <span class=main>(</span><span class=main>λ</span> <span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=bound>y</span> <span class=main>∈</span> state_successors <span class=main>(</span>prob_proj <span class=free>PROB</span> <span class=free>vs</span><span class=main>)</span> <span class=bound>x</span><span class=main>)</span> <span class=free>lss</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span>set <span class=free>lss</span> <span class=main>=</span> valid_states <span class=main>(</span>prob_proj <span class=free>PROB</span> <span class=free>vs</span><span class=main>)</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>s</span> <span class=main>∈</span> valid_states <span class=free>PROB</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>as'</span><span class=main>.</span>
      <span class=main>(</span>exec_plan <span class=free>s</span> <span class=bound>as'</span> <span class=main>=</span> exec_plan <span class=free>s</span> <span class=free>as</span><span class=main>)</span>
      <span class=main>∧</span> <span class=main>(</span>subseq <span class=bound>as'</span> <span class=free>as</span><span class=main>)</span>
      <span class=main>∧</span> <span class=main>(</span>length <span class=bound>as'</span> <span class=main>≤</span> Sup <span class=main>{</span>S <span class=free>vs</span> <span class=free>lss</span> <span class=free>PROB</span> <span class=bound>s'</span> <span class=main>|</span> <span class=bound>s'</span><span class=main>.</span> <span class=bound>s'</span> <span class=main>∈</span> valid_states <span class=main>(</span>prob_proj <span class=free>PROB</span>  <span class=free>vs</span><span class=main>)</span><span class=main>}</span><span class=main>)</span>
    <span class=main>)</span>"</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>as'</span></span> <span class=keyword2><span class=keyword>where</span></span>
    <span class=quoted><span class=quoted>"exec_plan <span class=free>s</span> <span class=skolem>as'</span> <span class=main>=</span> exec_plan <span class=free>s</span> <span class=free>as</span>"</span></span> <span class=quoted><span class=quoted>"subseq <span class=skolem>as'</span> <span class=free>as</span>"</span></span>
    <span class=quoted><span class=quoted>"length <span class=skolem>as'</span> <span class=main>≤</span> S <span class=free>vs</span> <span class=free>lss</span> <span class=free>PROB</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span>"</span></span>
    <span class=keyword1><span class=command>using</span></span> assms problem_plan_bound_S_bound_2nd_step
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>{</span></span>
    <span class=comment1>― ‹NOTE Derive sufficient conditions for inferring that `S vs lss PROB` is smaller or equal to
    the supremum of the set <span class=antiquoted><span class=antiquote>@{</span><span class=operator>term</span> <span class=quoted>"<span class=main>{</span>S <span class=free>vs</span> <span class=free>lss</span> <span class=free>PROB</span> <span class=bound>s'</span> <span class=main>|</span> <span class=bound>s'</span><span class=main>.</span> <span class=bound>s'</span> <span class=main>∈</span> valid_states <span class=main>(</span>prob_proj <span class=free>PROB</span> <span class=free>vs</span><span class=main>)</span><span class=main>}</span>"</span><span class=antiquote>}</span></span>: i.e.
    being contained and that the supremum is contained as well.›</span>
    <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?S</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>{</span>S <span class=free>vs</span> <span class=free>lss</span> <span class=free>PROB</span> <span class=bound>s'</span> <span class=main>|</span> <span class=bound>s'</span><span class=main>.</span> <span class=bound>s'</span> <span class=main>∈</span> valid_states <span class=main>(</span>prob_proj <span class=free>PROB</span> <span class=free>vs</span><span class=main>)</span><span class=main>}</span>"</span></span>
    <span class=keyword1><span class=command>{</span></span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"fmrestrict_set <span class=free>vs</span> <span class=free>s</span> <span class=main>∈</span> valid_states <span class=main>(</span>prob_proj <span class=free>PROB</span> <span class=free>vs</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>4<span class=main>)</span> graph_plan_not_eq_last_diff_paths
        <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"S <span class=free>vs</span> <span class=free>lss</span> <span class=free>PROB</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span> <span class=main>∈</span> <span class=var>?S</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> calculation<span class=main>(</span>1<span class=main>)</span>
        <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>}</span></span>
    <span class=keyword1><span class=command>moreover</span></span>
    <span class=keyword1><span class=command>{</span></span>
      <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"finite <span class=main>(</span>prob_proj <span class=free>PROB</span> <span class=free>vs</span><span class=main>)</span>"</span></span>
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>simp</span> <span class=quasi_keyword>add</span><span class=main><span class=main>:</span></span> assms<span class=main><span class=main>(</span></span>1<span class=main><span class=main>)</span></span> prob_proj_def<span class=main>)</span>
      <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"finite <span class=var>?S</span>"</span></span>
        <span class=keyword1><span class=command>using</span></span> Setcompr_eq_image assms<span class=main>(</span>3<span class=main>)</span>
        <span class=keyword1><span class=command>by</span></span> <span class=main>(</span><span class=operator>metis</span> List.finite_set finite_imageI<span class=main>)</span>
    <span class=keyword1><span class=command>}</span></span>
    <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"S <span class=free>vs</span> <span class=free>lss</span> <span class=free>PROB</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span> <span class=main>≤</span> Sup <span class=var>?S</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> le_cSup_finite <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>using</span></span> le_trans
    <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
<span class=keyword1><span class=command>qed</span></span>


<span class=comment1>― ‹NOTE first argument of `top\_sorted\_abs` had to be wrapped into lambda.›</span>
<span class=keyword1 id=AcycSspace-problem_plan_bound_S_bound><span class=command>lemma</span></span> problem_plan_bound_S_bound<span class=main>:</span>
  <span class=keyword2><span class=keyword>fixes</span></span> <span class=free>PROB</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> problem"</span></span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"finite <span class=free>PROB</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>top_sorted_abs <span class=main>(</span><span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=bound>y</span> <span class=main>∈</span> state_successors <span class=main>(</span>prob_proj <span class=free>PROB</span> <span class=free>vs</span><span class=main>)</span> <span class=bound>x</span><span class=main>)</span> <span class=free>lss</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span>set <span class=free>lss</span> <span class=main>=</span> valid_states <span class=main>(</span>prob_proj <span class=free>PROB</span> <span class=free>vs</span><span class=main>)</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"
    problem_plan_bound <span class=free>PROB</span>
    <span class=main>≤</span> Sup <span class=main>{</span>S <span class=free>vs</span> <span class=free>lss</span> <span class=free>PROB</span> <span class=main>(</span><span class=bound>s'</span> <span class=main>::</span> <span class=tfree>'a</span> state<span class=main>)</span> <span class=main>|</span> <span class=bound>s'</span><span class=main>.</span> <span class=bound>s'</span> <span class=main>∈</span> valid_states <span class=main>(</span>prob_proj <span class=free>PROB</span> <span class=free>vs</span><span class=main>)</span><span class=main>}</span>
  "</span></span>
<span class=keyword1><span class=command>proof</span></span> <span class=operator>-</span>
  <span class=keyword1><span class=command>let</span></span> <span class=var><span class=quoted><span class=var>?f</span></span></span><span class=main>=</span><span class=quoted><span class=quoted>"<span class=main>λ</span><span class=bound>PROB</span><span class=main>.</span>
    Sup <span class=main>{</span>S <span class=free>vs</span> <span class=free>lss</span> <span class=bound>PROB</span> <span class=main>(</span><span class=bound>s'</span> <span class=main>::</span> <span class=tfree>'a</span> state<span class=main>)</span> <span class=main>|</span> <span class=bound>s'</span><span class=main>.</span> <span class=bound>s'</span> <span class=main>∈</span> valid_states <span class=main>(</span>prob_proj <span class=bound>PROB</span> <span class=free>vs</span><span class=main>)</span><span class=main>}</span> <span class=main>+</span> <span class=main>1</span>"</span></span>
  <span class=keyword1><span class=command>{</span></span>
    <span class=keyword3><span class=command>fix</span></span> <span class=skolem>as</span> <span class=keyword2><span class=keyword>and</span></span> <span class=skolem>s</span> <span class=main>::</span> <span class=quoted><span class=quoted>"<span class=tfree>'a</span> state"</span></span>
    <span class=keyword3><span class=command>assume</span></span> <span class=quoted><span class=quoted>"<span class=skolem>s</span> <span class=main>∈</span> valid_states <span class=free>PROB</span>"</span></span> <span class=quoted><span class=quoted>"<span class=skolem>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span>"</span></span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>obtain</span></span> <span class=skolem><span class=skolem>as'</span></span> <span class=keyword2><span class=keyword>where</span></span> a<span class=main>:</span>
      <span class=quoted><span class=quoted>"exec_plan <span class=skolem>s</span> <span class=skolem>as'</span> <span class=main>=</span> exec_plan <span class=skolem>s</span> <span class=skolem>as</span>"</span></span> <span class=quoted><span class=quoted>"subseq <span class=skolem>as'</span> <span class=skolem>as</span>"</span></span>
      <span class=quoted><span class=quoted>"length <span class=skolem>as'</span> <span class=main>≤</span> Sup <span class=main>{</span>S <span class=free>vs</span> <span class=free>lss</span> <span class=free>PROB</span> <span class=bound>s'</span> <span class=main>|</span><span class=bound>s'</span><span class=main>.</span> <span class=bound>s'</span> <span class=main>∈</span> valid_states <span class=main>(</span>prob_proj <span class=free>PROB</span> <span class=free>vs</span><span class=main>)</span><span class=main>}</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> assms S_in_MPLS_leq_2_pow_n
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
    <span class=keyword1><span class=command>then</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"length <span class=skolem>as'</span> <span class=main>&lt;</span> <span class=var>?f</span> <span class=free>PROB</span>"</span></span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>linarith</span>
    <span class=keyword1><span class=command>moreover</span></span> <span class=keyword1><span class=command>have</span></span> <span class=quoted><span class=quoted>"exec_plan <span class=skolem>s</span> <span class=skolem>as</span> <span class=main>=</span> exec_plan <span class=skolem>s</span> <span class=skolem>as'</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> a<span class=main>(</span>1<span class=main>)</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>simp</span>
    <span class=keyword1><span class=command>ultimately</span></span> <span class=keyword1><span class=command>have</span></span>
      <span class=quoted><span class=quoted>"<span class=main>∃</span><span class=bound>as'</span><span class=main>.</span> exec_plan <span class=skolem>s</span> <span class=skolem>as</span> <span class=main>=</span> exec_plan <span class=skolem>s</span> <span class=bound>as'</span> <span class=main>∧</span> subseq <span class=bound>as'</span> <span class=skolem>as</span> <span class=main>∧</span> length <span class=bound>as'</span> <span class=main>&lt;</span> <span class=var>?f</span> <span class=free>PROB</span>"</span></span>
      <span class=keyword1><span class=command>using</span></span> a<span class=main>(</span>2<span class=main>)</span>
      <span class=keyword1><span class=command>by</span></span> <span class=operator>blast</span>
  <span class=keyword1><span class=command>}</span></span>
  <span class=keyword1><span class=command>then</span></span> <span class=keyword3><span class=command>show</span></span> <span class=var><span class=quoted><span class=var>?thesis</span></span></span>
    <span class=keyword1><span class=command>using</span></span> assms<span class=main>(</span>1<span class=main>)</span> problem_plan_bound_UBound<span class=main>[</span><span class=keyword2><span class=keyword><span class=operator>where</span></span></span> f<span class=main><span class=main>=</span></span><span class=quoted><span class=quoted>"<span class=var>?f</span>"</span></span><span class=main>]</span>
    <span class=keyword1><span class=command>by</span></span> <span class=operator>fastforce</span>
<span class=keyword1><span class=command>qed</span></span>

<span class=keyword1><span class=command>subsection</span></span> <span class=quoted><span class=plain_text>"State Space Acyclicity"</span></span>

<span class=keyword1><span class=command>text</span></span> <span class=quoted><span class=plain_text>‹ State space acyclicity is again formalized using graphs to model the state space. However
the relation inducing the graph is the successor relation on states. [Abdulaziz et al.,
Definition 15, HOL4 Definition 15, p.27]

With this, the acyclic system compositional bound `S` can be shown to be an upper bound on the
sublist diameter (lemma `problem\_plan\_bound\_S\_bound\_thesis`). [Abdulaziz et al., p.29] ›</span></span>

<span class=comment1>― ‹NOTE name shortened.›</span>
<span class=comment1>― ‹NOTE first argument of 'top\_sorted\_abs' had to be wrapped into lambda.›</span>
<span class=keyword1><span class=command>definition</span></span> <span class=entity>sspace_DAG</span> <span class=keyword2><span class=keyword>where</span></span>
  <span class=quoted><span class=quoted>"<span class=free>sspace_DAG</span> <span class=free><span class=bound><span class=entity>PROB</span></span></span> <span class=free><span class=bound><span class=entity>lss</span></span></span> <span class=main>≡</span> <span class=main>(</span>
    <span class=main>(</span>set <span class=free><span class=bound><span class=entity>lss</span></span></span> <span class=main>=</span> valid_states <span class=free><span class=bound><span class=entity>PROB</span></span></span><span class=main>)</span>
    <span class=main>∧</span> <span class=main>(</span>top_sorted_abs <span class=main>(</span><span class=main>λ</span><span class=bound>x</span> <span class=bound>y</span><span class=main>.</span> <span class=bound>y</span> <span class=main>∈</span> state_successors <span class=free><span class=bound><span class=entity>PROB</span></span></span> <span class=bound>x</span><span class=main>)</span> <span class=free><span class=bound><span class=entity>lss</span></span></span><span class=main>)</span>
  <span class=main>)</span>"</span></span>


<span class=keyword1 id=AcycSspace-problem_plan_bound_S_bound_2nd_step_thesis><span class=command>lemma</span></span> problem_plan_bound_S_bound_2nd_step_thesis<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"finite <span class=main>(</span><span class=free>PROB</span> <span class=main>::</span> <span class=tfree>'a</span> problem<span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>sspace_DAG <span class=main>(</span>prob_proj <span class=free>PROB</span> <span class=free>vs</span><span class=main>)</span> <span class=free>lss</span><span class=main>)</span>"</span></span>
    <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>s</span> <span class=main>∈</span> valid_states <span class=free>PROB</span><span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=free>as</span> <span class=main>∈</span> valid_plans <span class=free>PROB</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span><span class=main>∃</span><span class=bound>as'</span><span class=main>.</span>   <span class=main>(</span>exec_plan <span class=free>s</span> <span class=bound>as'</span> <span class=main>=</span> exec_plan <span class=free>s</span> <span class=free>as</span><span class=main>)</span>
    <span class=main>∧</span> <span class=main>(</span>subseq <span class=bound>as'</span> <span class=free>as</span><span class=main>)</span>
    <span class=main>∧</span> <span class=main>(</span>length <span class=bound>as'</span> <span class=main>≤</span> S <span class=free>vs</span> <span class=free>lss</span> <span class=free>PROB</span> <span class=main>(</span>fmrestrict_set <span class=free>vs</span> <span class=free>s</span><span class=main>)</span><span class=main>)</span>
  <span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms problem_plan_bound_S_bound_2nd_step sspace_DAG_def
  <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>


<span class=keyword1><span class=command>text</span></span> <span class=quoted><span class=plain_text>‹And finally, this is the main lemma about the upper bounding algorithm.›</span></span>

<span class=keyword1><span class=command>theorem</span></span> problem_plan_bound_S_bound_thesis<span class=main>:</span>
  <span class=keyword2><span class=keyword>assumes</span></span> <span class=quoted><span class=quoted>"finite <span class=main>(</span><span class=free>PROB</span> <span class=main>::</span> <span class=tfree>'a</span> problem<span class=main>)</span>"</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>sspace_DAG <span class=main>(</span>prob_proj <span class=free>PROB</span> <span class=free>vs</span><span class=main>)</span> <span class=free>lss</span><span class=main>)</span>"</span></span>
  <span class=keyword2><span class=keyword>shows</span></span> <span class=quoted><span class=quoted>"<span class=main>(</span>
    problem_plan_bound <span class=free>PROB</span>
    <span class=main>≤</span> Sup <span class=main>{</span>S <span class=free>vs</span> <span class=free>lss</span> <span class=free>PROB</span> <span class=bound>s'</span> <span class=main>|</span> <span class=bound>s'</span><span class=main>.</span> <span class=bound>s'</span> <span class=main>∈</span> valid_states <span class=main>(</span>prob_proj <span class=free>PROB</span> <span class=free>vs</span><span class=main>)</span><span class=main>}</span>
  <span class=main>)</span>"</span></span>
  <span class=keyword1><span class=command>using</span></span> assms problem_plan_bound_S_bound sspace_DAG_def
  <span class=keyword1><span class=command>by</span></span> <span class=operator>fast</span>


<span class=keyword2><span class=keyword>end</span></span></pre>
</div>
</main>
</div>
</div>
</body>
</html>